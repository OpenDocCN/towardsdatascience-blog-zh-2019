<html>
<head>
<title>How to Install Python Packages for AWS Lambda Layers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为 AWS Lambda 层安装 Python 包</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-install-python-packages-for-aws-lambda-layer-74e193c76a91?source=collection_archive---------1-----------------------#2019-11-08">https://towardsdatascience.com/how-to-install-python-packages-for-aws-lambda-layer-74e193c76a91?source=collection_archive---------1-----------------------#2019-11-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f2ef" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于如何使用 Docker 容器为 AWS Lambda 层构建 Python 包的指南。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0287862c178a2b8b9669393f2847d0f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O5rojHYK7AGYFMiGQxiX_w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Image Source: bvoyles4 from Pixabay (Modified by Author)</figcaption></figure><h1 id="c58d" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">Lambda 及其层</h1><p id="fe34" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">当我第一次听说<strong class="ls iu"> AWS Lambda </strong>时，我对它是什么感到非常困惑，并试图用它来训练一个简单的 ML 模型，但遇到了 5 分钟的执行限制。快进几年，我相信 Lambda 已经发展了很多，人们对<strong class="ls iu">事件驱动系统</strong>和<strong class="ls iu">无服务器计算</strong>的理解也是如此。它已经成为许多现代应用程序和数据架构师的一部分。</p><p id="1d4e" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在<strong class="ls iu"> re:Invent 2018 </strong>上，Lambda 进行了大量的定制运行时改进，并将执行运行时限制增加到 15 分钟。<strong class="ls iu"> Lambda Layers </strong>也发布了，它允许你共享公共依赖项，以简化 Lambda 部署规模和更新。然而，AWS 仍然没有解决友好步骤的<strong class="ls iu">需求，以引入<strong class="ls iu">非原生 python 包</strong>，例如熊猫。</strong></p><h1 id="55d8" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">引入外部包的麻烦方法…</h1><p id="2d6c" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">目前，你要么压缩你的 Lambda 函数和 Linux 兼容的依赖项，要么上传你的依赖项作为 Lambda 层。如果你以前玩过 Google Cloud Functions 和 Azure Function，你会知道这就像在<code class="fe mr ms mt mu b">requirements.txt</code>中写一个愿望清单一样简单。</p><p id="8a41" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">为了增加额外的复杂性，一些 Python 包需要编译<strong class="ls iu"> C </strong>或<strong class="ls iu"> C++ </strong>扩展(包如 Numpy 和 Pandas)。如果你想用你的<strong class="ls iu"> macOS </strong>或<strong class="ls iu"> Windows </strong>机器来<code class="fe mr ms mt mu b">pip install -t . pandas</code>然后为 Lambda 层压缩它们，这是一个亚马逊 Linux 环境，这可能有点麻烦。</p><p id="5145" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">有几种方法可以引入 Linux 兼容的依赖项，无论是通过无服务器还是使用 EC2 实例。现在，如果你以前读过我的一些博客，我真的很喜欢在黑客马拉松中使用 Lambdas，因为时间是关键，我想向你展示如何使用<strong class="ls iu"> Docker </strong>将 Python 依赖作为 Lambda 层的最简单<strong class="ls iu">和最快</strong>的方式。</p><h1 id="c3ba" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">5 个简单的步骤:</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/abb940539b916c863379d8c00c310411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PMZ1AaCKhXR-DfLbYhINcg.png"/></div></div></figure><h2 id="5b4c" class="mw kz it bd la mx my dn le mz na dp li lz nb nc lk md nd ne lm mh nf ng lo nh bi translated">1.建设</h2><p id="c773" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">希望你已经设置了 Docker，但是如果你没有，那么一定要先设置。你要做的第一件事是使用一个 Amazon Linux 作为基本映像，并用几个<strong class="ls iu">实用程序</strong>、<strong class="ls iu"> python3.7 </strong>和<strong class="ls iu"> Virtualenv </strong>创建一个 Dockerfile。</p><pre class="kj kk kl km gt ni mu nj nk aw nl bi"><span id="2597" class="mw kz it mu b gy nm nn l no np"><strong class="mu iu">FROM</strong> <strong class="mu iu">amazonlinux:2.0.20191016.0</strong></span><span id="5a0f" class="mw kz it mu b gy nq nn l no np"><strong class="mu iu">RUN</strong> yum install -y <strong class="mu iu">python37</strong> &amp;&amp; \<br/>    yum install -y <strong class="mu iu">python3-pip</strong> &amp;&amp; \<br/>    yum install -y <strong class="mu iu">zip</strong> &amp;&amp; \<br/>    yum clean all</span><span id="610e" class="mw kz it mu b gy nq nn l no np"><strong class="mu iu">RUN</strong> python3.7 -m pip install --upgrade pip &amp;&amp; \<br/>    python3.7 -m pip install <strong class="mu iu">virtualenv</strong></span></pre><p id="a1c1" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">运行下面的命令来创建带有标签的 docker 文件。</p><pre class="kj kk kl km gt ni mu nj nk aw nl bi"><span id="3cf7" class="mw kz it mu b gy nm nn l no np">usr&gt;<strong class="mu iu"> docker build </strong>-f <strong class="mu iu">"&lt;filename&gt;.Dockerfile"</strong> -t<strong class="mu iu"> lambdalayer:latest .</strong></span></pre><h2 id="2bc6" class="mw kz it bd la mx my dn le mz na dp li lz nb nc lk md nd ne lm mh nf ng lo nh bi translated">2.奔跑</h2><p id="e910" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">你应该可以通过做<code class="fe mr ms mt mu b">docker images</code>看到图像。在那之后，你想要撞击你的容器。</p><pre class="kj kk kl km gt ni mu nj nk aw nl bi"><span id="0a81" class="mw kz it mu b gy nm nn l no np">usr&gt;<strong class="mu iu"> docker run</strong> -it --name lambdalayer <strong class="mu iu">lambdalayer:latest</strong> <strong class="mu iu">bash</strong></span></pre><h2 id="89df" class="mw kz it bd la mx my dn le mz na dp li lz nb nc lk md nd ne lm mh nf ng lo nh bi translated">3.安装</h2><p id="18cb" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在您的容器中创建一个新的虚拟环境来隔离您的 python 环境，并重用同一个容器，而不用担心全局安装破坏东西。您可以为每个依赖项创建一个容器，但是时间是关键…</p><pre class="kj kk kl km gt ni mu nj nk aw nl bi"><span id="458a" class="mw kz it mu b gy nm nn l no np">bash&gt; <strong class="mu iu">python3.7</strong> -m venv <strong class="mu iu">pandas</strong></span></pre><p id="83c8" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我把它命名为熊猫，你可以叫它任何你想要的名字，但是一定要激活它，把你的包安装到一个特定的文件夹中，然后再去激活它。</p><pre class="kj kk kl km gt ni mu nj nk aw nl bi"><span id="c289" class="mw kz it mu b gy nm nn l no np">bash&gt; <strong class="mu iu">source pandas/bin/activate<br/></strong>(pandas) bash&gt; pip install <strong class="mu iu">pandas</strong> -t <strong class="mu iu">./python<br/></strong>(pandas) bash&gt; deactivate</span></pre><h2 id="655a" class="mw kz it bd la mx my dn le mz na dp li lz nb nc lk md nd ne lm mh nf ng lo nh bi translated">4.包裹</h2><p id="2e53" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">这些包及其依赖项应该已经安装在 python 文件夹(或您的特定文件夹)中。现在您可以将该文件夹压缩为<code class="fe mr ms mt mu b">python.zip</code>并退出容器。您需要将压缩文件夹复制到本地环境中，以便将其上传到 Lambda 图层或 S3。</p><pre class="kj kk kl km gt ni mu nj nk aw nl bi"><span id="9973" class="mw kz it mu b gy nm nn l no np">bash&gt; <strong class="mu iu">zip</strong> -r <strong class="mu iu">python.zip</strong> ./python/</span><span id="3247" class="mw kz it mu b gy nq nn l no np">usr&gt; <strong class="mu iu">docker cp</strong> lambdalayer:python.zip ./Desktop/</span></pre><h2 id="a77f" class="mw kz it bd la mx my dn le mz na dp li lz nb nc lk md nd ne lm mh nf ng lo nh bi translated">5.上传</h2><p id="8fa5" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">如果你的压缩文件大于 50mb，那么你需要把它上传到 S3，而不是直接上传到 Lambda 层。一定要记录下<strong class="ls iu"> S3 对象的网址</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/86efc723e5e758618d5aeb3d547b0c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7M3c1Z-kPmRjbfQNj2tRTQ.png"/></div></div></figure><p id="bc4c" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">就这样，现在你有 Pandas(和 Numpy)作为你的 Python Lambda 的一部分作为一个层使用，如果你想创建一个部署包，那么一定要把你的 Lambda 函数代码作为一个<code class="fe mr ms mt mu b">.py</code>文件添加到压缩文件夹中。</p><h1 id="3f7d" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">λ层的限制</h1><p id="6bcd" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">您需要了解一些限制，包括:</p><ol class=""><li id="e00b" class="ns nt it ls b lt mm lw mn lz nu md nv mh nw ml nx ny nz oa bi translated">每个 Lambda 最多只能使用 5 层。</li><li id="9822" class="ns nt it ls b lt ob lw oc lz od md oe mh of ml nx ny nz oa bi translated">解压缩后的所有图层的大小不能超过 250mb。</li><li id="9dda" class="ns nt it ls b lt ob lw oc lz od md oe mh of ml nx ny nz oa bi translated">层安装在函数执行环境中的/opt 目录中，因此如果您要有多个函数，请确保正确地对函数进行分层。</li></ol><h1 id="3c54" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">部署 Lambda</h1><p id="f0ac" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">请随意查看我的文章<a class="ae og" rel="noopener" target="_blank" href="/using-serverless-and-sam-to-deploy-a-scheduled-lambda-with-packages-ed7efdc73070">关于如何使用无服务器或 AWS SAM 将 Lambda(和 Pandas)部署到 AWS。</a></p></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><h1 id="9382" class="ky kz it bd la lb oo ld le lf op lh li jz oq ka lk kc or kd lm kf os kg lo lp bi translated">关于我</h1><blockquote class="ot ou ov"><p id="62a3" class="lq lr ow ls b lt mm ju lv lw mn jx ly ox mo mb mc oy mp mf mg oz mq mj mk ml im bi translated">我喜欢写媒体文章，并为知识共享社区做贡献。除了尝试新的食物配方，我还帮助企业构建云和数据解决方案。请随时与我联系并向我问好！</p><p id="4259" class="lq lr ow ls b lt mm ju lv lw mn jx ly ox mo mb mc oy mp mf mg oz mq mj mk ml im bi translated">——<a class="ae og" href="https://www.linkedin.com/in/cyamma/" rel="noopener ugc nofollow" target="_blank">李帝努·雅玛</a></p></blockquote></div></div>    
</body>
</html>