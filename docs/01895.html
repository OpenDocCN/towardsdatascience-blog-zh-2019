<html>
<head>
<title>Deploying Your Data Science Projects in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 JavaScript 部署您的数据科学项目</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-your-data-science-projects-in-javascript-b873df6c2450?source=collection_archive---------22-----------------------#2019-03-28">https://towardsdatascience.com/deploying-your-data-science-projects-in-javascript-b873df6c2450?source=collection_archive---------22-----------------------#2019-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="86ba" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一小时内将 React 客户端、Python JSON API 和 SSL 证书从 Let's Encrypt 推送到 DigitalOcean</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6336c3b49f0540832ffc436b2f8e0c70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KD8PiX1IGO2_vMBkAMv7BQ.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/photos/ai6IRDJQMKw?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Daniel Mayovskiy</a> on <a class="ae kv" href="https://unsplash.com/search/photos/rocket?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3700" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于我最新的项目，我决定使用 React 进行大部分探索性数据分析(EDA ),并需要一个非常简单的 JSON API 来提供必要的数据，以避免加载+70 MB 的页面。在本教程中，我将带你在 DigitalOcean 上使用<a class="ae kv" href="https://facebook.github.io/create-react-app/" rel="noopener ugc nofollow" target="_blank"> create-react-app </a>、<a class="ae kv" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> fastapi </a>和<a class="ae kv" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>部署一个示例应用的过程。您可以探索真正的应用程序，因为它目前位于<a class="ae kv" href="https://ecce.rcd.ai/" rel="noopener ugc nofollow" target="_blank"> https://ecce.rcd.ai </a>。这种产品部署过程有点手动，但是如果需要的话，当然可以自动化。</p><p id="9b5e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是实现这一目标的顶级步骤:</p><ol class=""><li id="8c9f" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">用 fastapi 创建 Python API</li><li id="25d4" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用 create-react-app 创建客户端应用程序(并将请求传递给 API)</li><li id="118a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建 DigitalOcean droplet 并安装依赖项</li><li id="ac93" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">配置 Nginx(将 React 和 Python 统一为一个 web 服务)</li><li id="13b9" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">构建客户端应用程序并拷贝到 droplet</li><li id="d9fc" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">克隆客户端 API 并作为 cronjob 安装</li><li id="8db9" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">设置域并从 Let's Encrypt 获取 SSL 证书</li><li id="403e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">为出色完成的工作拿一杯咖啡☕！🎉</li></ol><h1 id="70b5" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">Python API 和 fastapi</h1><p id="f2dc" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">据我所知，<a class="ae kv" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> fastapi </a>是创建 Python API 最简单、最快的方法。这是一个单一文件服务器，可以根据需要轻松扩展和配置。对于这个例子，我们将提供来自 ESV 的诗句(法律允许，因为这是一个非商业项目)。我们将使用这些命令从头开始项目:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="6fc9" class="ni mh iq ne b gy nj nk l nl nm"><em class="nn"># Create directory and jump into it<br/></em>mkdir -p fastapi-react-demo/app cd fastapi-react-demo </span><span id="e1d7" class="ni mh iq ne b gy no nk l nl nm"><em class="nn"># Download data source<br/></em>curl -LO <a class="ae kv" href="https://github.com/honza/bibles/raw/master/ESV/ESV.json" rel="noopener ugc nofollow" target="_blank">https://github.com/honza/bibles/raw/master/ESV/ESV.json</a><br/>mv ESV.json app/esv.json </span><span id="2c83" class="ni mh iq ne b gy no nk l nl nm"><em class="nn"># Install dependencies<br/></em>pip install fastapi uvicorn toolz </span><span id="1b7b" class="ni mh iq ne b gy no nk l nl nm"><em class="nn"># Save dependencies for later use<br/></em>pip freeze | grep "fastapi\|uvicorn\|toolz" &gt; requirements.txt</span><span id="71af" class="ni mh iq ne b gy no nk l nl nm"><em class="nn"># Create server file<br/></em>touch app/server.py</span></pre><p id="ba35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe np nq nr ne b">app/server.py</code>中:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="da93" class="ni mh iq ne b gy nj nk l nl nm">from fastapi import FastAPI<br/>from starlette.middleware.cors import CORSMiddleware<br/>import json<br/>import os<br/>from toolz import memoize</span><span id="8bbf" class="ni mh iq ne b gy no nk l nl nm">app = FastAPI() </span><span id="4831" class="ni mh iq ne b gy no nk l nl nm"><em class="nn"># TODO: Change origin to real domain to reject Ajax requests from elsewhere<br/></em>app.add_middleware(CORSMiddleware, allow_origins=['*'])</span><span id="9814" class="ni mh iq ne b gy no nk l nl nm">@memoize<br/>def data():<br/>    with open(os.path.join(os.path.dirname(__file__), 'esv.json')) as f:<br/>         return json.load(f)   </span><span id="0787" class="ni mh iq ne b gy no nk l nl nm">@app.get('/api/verse/{book}/{chapter}/{verse}')<br/>def load_text(book: str, chapter: int, verse: int):<br/>     try:<br/>         return {'text': data()[book][str(chapter)][str(verse)]}<br/>     except KeyError as e:<br/>         return {'error': str(e), 'type': 'KeyError'}</span></pre><p id="f880" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从这个简单的文件中，我们有了 JSON API、CORS、参数验证等等。让我们继续在开发模式下运行它来检查一下:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="c4bf" class="ni mh iq ne b gy nj nk l nl nm"># Start app<br/>uvicorn app.server:app --reload</span><span id="be13" class="ni mh iq ne b gy no nk l nl nm"># Send API request (in separate window)<br/>curl <a class="ae kv" href="http://localhost:8000/api/verse/Genesis/1/1" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/api/verse/Genesis/1/1</a><br/># =&gt; {"text":"In the beginning, God created the heavens and the earth."}</span></pre><p id="10f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着服务器的运行，我们不仅在开发中拥有完全可操作的 JSON API，而且如果我们改变了文件中的任何内容，它甚至会实时重新加载。让我们谈谈客户。</p><h1 id="4251" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">具有创建-反应-应用的客户端应用</h1><p id="ea84" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">API 在开发模式下运行，让我们继续创建一个客户端应用程序。如果你在 React 中做数据科学可视化，我假设你熟悉 JavaScript 生态系统。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="1774" class="ni mh iq ne b gy nj nk l nl nm">npx create-react-app client</span></pre><p id="db51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在添加我们的 ajax 代码之前，我们需要为<code class="fe np nq nr ne b">create-react-app</code>配置代理，以将它不能处理的请求转发给运行在端口 8000 上的 API 服务器。</p><p id="cd67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe np nq nr ne b">client/package.json</code></p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="6949" class="ni mh iq ne b gy nj nk l nl nm">  ...<br/>},<br/>"proxy": "http://localhost:8000",<br/>"scripts": ...</span></pre><p id="cd47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将继续从客户端进行一个简单的 API 调用:</p><p id="7a13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe np nq nr ne b">client/src/App.js</code></p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0e6c" class="ni mh iq ne b gy nj nk l nl nm">import React, { Component } from 'react';</span><span id="88ae" class="ni mh iq ne b gy no nk l nl nm">class App extends Component {<br/>  constructor(props) {<br/>    super(props);<br/>    this.state = { verse: 'Loading...' };<br/>  }</span><span id="56db" class="ni mh iq ne b gy no nk l nl nm">  componentDidMount() {<br/>    fetch('/api/verse/Genesis/1/1')<br/>      .then(r =&gt; r.json())<br/>      .then(data =&gt; this.setState({ text: data.text }));<br/>  }</span><span id="1f4a" class="ni mh iq ne b gy no nk l nl nm">  render() {<br/>    return (<br/>      &lt;div&gt;<br/>        &lt;h1&gt;fastapi-react-demo&lt;/h1&gt;<br/>        &lt;p&gt;Result of API call: {this.state.text}&lt;/p&gt;<br/>      &lt;/div&gt;<br/>    );<br/>  }<br/>}</span><span id="be59" class="ni mh iq ne b gy no nk l nl nm">export default App;</span></pre><p id="60ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了更新的文件，我们就可以开始启动服务器了。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="7f63" class="ni mh iq ne b gy nj nk l nl nm">cd client &amp;&amp; yarn start</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/0d66d162f69c116abdb433fb89c4dac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/0*b0N7FDTdpMEyUweo.png"/></div></figure><p id="4930" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">万岁！它肯定不会赢得任何设计奖项，但我们现在有两个应用程序互相交谈。我们来谈谈如何实际部署这些应用程序。</p><p id="fb76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请确保您已经将它上传到一个 Git 存储库，以便我们稍后可以轻松地克隆它。(如果没有，不要担心——你可以只使用 https://github.com/rcdilorenzo/fastapi-react-demo 的样本库)。</p><p id="702b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着应用程序的启动和运行，我们现在必须为世界部署我们的代码！我们将从创建一个<a class="ae kv" href="https://www.digitalocean.com/" rel="noopener ugc nofollow" target="_blank">数字海洋</a>水滴开始。在这种情况下，我将选择 Ubuntu 18 的最小磁盘大小来为应用程序服务。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/2df9a507730b906b19d4127136b614d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1F6YsJ-HCc1fUgTD.png"/></div></div></figure><p id="f054" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了 SSH 键，我们就可以进入设置中描述的 droplet 了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/66f4c02ce98488db0031f0abb005689c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*teN_U7z7Ks87zLRP.png"/></div></div></figure><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="760f" class="ni mh iq ne b gy nj nk l nl nm">ssh root@&lt;DROPLET_IP xxx.xxx.xxx.128&gt;</span><span id="9105" class="ni mh iq ne b gy no nk l nl nm"># (on server)<br/>apt-get update apt-get install -y nginx-full</span></pre><h1 id="78d1" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">配置 Nginx</h1><p id="36ca" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们现在需要设置 Nginx 来完成三项任务。</p><ol class=""><li id="39ea" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">每当路线以<code class="fe np nq nr ne b">/api</code>开始时提供 Python 应用</li><li id="f5af" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">对于任何特定资产或未找到路线，可退回到 React 应用程序</li><li id="4fdd" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">强制 SSL 并使用来自“让我们加密”的证书</li></ol><p id="c362" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会跳过此配置的所有细节，但它应该可以实现我们的目标，稍后您将了解更多细节。对于编辑，继续使用您最喜欢的命令行编辑器。(我的是 vim，用于快速编辑；最简单的是纳米。)确保用您的自定义域替换<code class="fe np nq nr ne b">demo.rcd.ai</code>。</p><p id="d88d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe np nq nr ne b">/etc/nginx/sites-available/demo.rcd.ai.conf</code></p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="7e55" class="ni mh iq ne b gy nj nk l nl nm">server {<br/>    listen [::]:80;<br/>    listen 80;<br/>    server_name demo.rcd.ai;<br/>    location / {<br/>        return 301 <a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/$host$request_uri">https://$host$request_uri</a>;<br/>    }<br/>}</span><span id="3141" class="ni mh iq ne b gy no nk l nl nm">server {<br/>    listen [::]:443 ssl http2;<br/>    listen 443 ssl http2;<br/>    server_name demo.rcd.ai;<br/>    access_log /var/log/nginx/access.log;<br/>    error_log /var/log/nginx/error.log;</span><span id="69bc" class="ni mh iq ne b gy no nk l nl nm">    ssl_certificate /etc/letsencrypt/live/demo.rcd.ai/fullchain.pem;<br/>    ssl_certificate_key /etc/letsencrypt/live/demo.rcd.ai/privkey.pem;</span><span id="93ce" class="ni mh iq ne b gy no nk l nl nm">    root /var/www/demo/;</span><span id="8a8d" class="ni mh iq ne b gy no nk l nl nm">    index index.html;</span><span id="15c8" class="ni mh iq ne b gy no nk l nl nm">    location / {<br/>      try_files $uri $uri/ /index.html;<br/>    }</span><span id="c158" class="ni mh iq ne b gy no nk l nl nm">    location /api {<br/>      proxy_pass <a class="ae kv" href="http://localhost:1234" rel="noopener ugc nofollow" target="_blank">http://localhost:1234</a>; # Port of Python server<br/>    }</span><span id="0ba4" class="ni mh iq ne b gy no nk l nl nm">    # JavaScript/CSS<br/>    location ~* \.(?:css|js)$ {<br/>        try_files $uri =404;<br/>        expires 1y;<br/>        access_log off;<br/>        add_header Cache-Control "public";<br/>    }</span><span id="2315" class="ni mh iq ne b gy no nk l nl nm">    # Any file route<br/>    location ~ ^.+\..+$ {<br/>        try_files $uri =404;<br/>    }<br/>}</span></pre><p id="cbbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们将这个文件符号链接到<code class="fe np nq nr ne b">sites-enabled</code>文件夹中，这样 Nginx 在收到来自域<code class="fe np nq nr ne b">demo.rcd.ai</code>的请求时就会知道要服务它。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0217" class="ni mh iq ne b gy nj nk l nl nm">ln -s /etc/nginx/sites-available/demo.rcd.ai.conf /etc/nginx/sites-enabled/demo.rcd.ai</span></pre><p id="fb26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然我们可以让 Nginx 重新加载，但是在它正常工作之前，我们还有一些事情要做。</p><ol class=""><li id="109a" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">用我们的域名注册商添加<code class="fe np nq nr ne b">demo.rcd.ai</code>来指向这个 IP 地址</li><li id="077d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将客户端的生产版本复制到<code class="fe np nq nr ne b">/var/www/demo</code></li><li id="5b90" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">克隆 Python 服务器，并在端口 1234 上启动它</li><li id="4715" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">请求让我们加密证书</li></ol><p id="33fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会过多讨论设置子域记录的细节，因为这取决于你的提供商。这是我添加到 NameCheap 的内容，因为那是我的注册商。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/13a7ac60bfb1f31b0b87ab4c54c5cd88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pMfYFrDetE9Buh6P.png"/></div></div></figure><p id="4a02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，这可能需要一段时间才能将变化反映到“互联网”上您总是可以通过简单的 ping 命令来检查它:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="b2c4" class="ni mh iq ne b gy nj nk l nl nm">❯ ping demo.rcd.ai<br/># PING demo.rcd.ai (159.89.130.128) 56(84) bytes of data.<br/># 64 bytes from 159.89.130.128 (159.89.130.128): icmp_seq=1 ttl=48 time=88.4 ms<br/># 64 bytes from 159.89.130.128 (159.89.130.128): icmp_seq=2 ttl=48 time=85.4 ms<br/># ^C<br/># --- demo.rcd.ai ping statistics ---<br/># 2 packets transmitted, 2 received, 0% packet loss, time 1000ms<br/># rtt min/avg/max/mdev = 85.411/86.921/88.432/1.539 ms</span></pre><h1 id="6850" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">构建和部署客户端</h1><p id="58da" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">回到开发机器上的<code class="fe np nq nr ne b">client/</code>文件夹，创建一个产品版本就像发出一个命令一样简单。然后我们将它打包并发送到<code class="fe np nq nr ne b">/var/www/demo</code>目录中的 DigitalOcean droplet。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="d54e" class="ni mh iq ne b gy nj nk l nl nm"># Build production-optimized assets<br/>yarn build</span><span id="4e80" class="ni mh iq ne b gy no nk l nl nm"># Zip contents<br/>zip -r build.zip build/</span><span id="2cba" class="ni mh iq ne b gy no nk l nl nm"># Upload with scp<br/>scp build.zip root@&lt;DROPLET_IP&gt;:/var/www/</span></pre><p id="ebc2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后在水滴上:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="86a3" class="ni mh iq ne b gy nj nk l nl nm"># Unzip and rename folder<br/>apt-get install -y unzip<br/>cd /var/www &amp;&amp; unzip build.zip<br/>mv build demo</span></pre><p id="3fb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，Nginx 应该适当地服务于资产。然而，因为证书还没有到位，它甚至不允许我们加载配置。</p><h1 id="b8c4" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">来自“让我们加密”的 SSL 证书</h1><p id="7d25" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">虽然我们可以设置 Python 服务器，但最好能得到一些反馈，以确保至少我们的客户端得到了正确的服务。本着快速迭代的精神，让我们首先设置证书。从 https://certbot.eff.org<a class="ae kv" href="https://certbot.eff.org/" rel="noopener ugc nofollow" target="_blank">很容易获得说明。在 droplet 上，继续安装 certbot。</a></p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="9ec5" class="ni mh iq ne b gy nj nk l nl nm">apt-get update<br/>apt-get install software-properties-common<br/>add-apt-repository universe<br/>add-apt-repository ppa:certbot/certbot<br/>apt-get update apt-get install certbot python-certbot-nginx</span></pre><p id="eb40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，可以通过一个命令获得证书。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="a242" class="ni mh iq ne b gy nj nk l nl nm">certbot certonly --standalone \<br/>  --pre-hook "service nginx stop" \<br/>  --post-hook "service nginx start" \<br/>  --preferred-challenges http -d demo.rcd.ai<br/># ...<br/># Running pre-hook command: service nginx stop<br/># Obtaining a new certificate<br/># Performing the following challenges:<br/># http-01 challenge for demo.rcd.ai<br/># Waiting for verification...<br/># Cleaning up challenges<br/># Running post-hook command: service nginx start<br/># # IMPORTANT NOTES:<br/># - Congratulations! Your certificate and chain have been saved at:<br/># /etc/letsencrypt/live/demo.rcd.ai/fullchain.pem<br/># Your key file has been saved at:<br/># /etc/letsencrypt/live/demo.rcd.ai/privkey.pem<br/># Your cert will expire on 2019-06-26. To obtain a new or tweaked<br/># version of this certificate in the future, simply run certbot<br/># again. To non-interactively renew *all* of your certificates, run<br/># "certbot renew"<br/># - Your account credentials have been saved in your Certbot<br/># configuration directory at /etc/letsencrypt. You should make a<br/># secure backup of this folder now. This configuration directory will<br/># also contain certificates and private keys obtained by Certbot so<br/># making regular backups of this folder is ideal.<br/># ...</span></pre><p id="91fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为这个命令停止并重启 Nginx，所以我们应该可以直接进入应用程序，看到一些东西(<a class="ae kv" href="https://demo.rcd.ai/" rel="noopener ugc nofollow" target="_blank"> https://demo.rcd.ai </a>)。我们还可以特别请求 Nginx 重新加载配置。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="ba45" class="ni mh iq ne b gy nj nk l nl nm">nginx -s reload</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/a2fef1df7b33c42a3441b1be78f0f404.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/0*aVyAJKWoa6pyQrqT.png"/></div></figure><h1 id="b8cf" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">部署 API</h1><p id="2ca1" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">Nginx 配置需要一个内部服务器监听端口 1234，剩下的就是在 droplet 上运行 Python 服务器。因为我们将代码推送到 GitHub，所以剩余的命令可以从 droplet 运行。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="c04f" class="ni mh iq ne b gy nj nk l nl nm"># Clone code to folder<br/>cd /var/www<br/>git clone https://github.com/rcdilorenzo/fastapi-react-demo.git demo-server</span><span id="02f3" class="ni mh iq ne b gy no nk l nl nm"># Install Python-3.6 based virtualenv (to avoid version conflicts)<br/>apt-get install -y python3.6-venv python3-venv python3.6-dev</span><span id="f5ff" class="ni mh iq ne b gy no nk l nl nm"># Jump into server folder<br/>cd demo-server</span><span id="a760" class="ni mh iq ne b gy no nk l nl nm"># Create virtual environment in /var/www/demo-server/demo_3.6<br/>python3.6 -m venv demo_3.6</span><span id="d6a6" class="ni mh iq ne b gy no nk l nl nm"># Install a couple of prerequisites for compiling some dependencies<br/>./demo_3.6/bin/pip install wheel<br/>apt-get install -y gcc</span><span id="6c8d" class="ni mh iq ne b gy no nk l nl nm"># Install dependencies<br/>./demo_3.6/bin/pip install -r requirements.txt</span></pre><p id="38cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装完依赖项后，可以内联启动服务器进行测试。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="81b8" class="ni mh iq ne b gy nj nk l nl nm">./demo_3.6/bin/uvicorn app.server:app --port 1234<br/>INFO:uvicorn:Started server process [9357]<br/>INFO:uvicorn:Waiting for application startup.<br/>INFO:uvicorn:Uvicorn running on http://127.0.0.1:1234 (Press CTRL+C to quit)</span></pre><p id="e112" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新访问页面，我们可以看到诗句现在正确加载。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/9246f186c3796de99734b9d6b87ea267.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/0*M1uVPlRamIboiedg.png"/></div></figure><p id="af4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，只有当我们打开 SSH 会话时，这个 Python 服务器才会运行。为了让它在重启后仍然存在，我们可以添加到<code class="fe np nq nr ne b">crontab</code>中。我们必须运行的唯一命令是切换到服务器根目录并运行<code class="fe np nq nr ne b">uvicorn</code>。用<code class="fe np nq nr ne b">CTRL-c</code>杀死服务器，用<code class="fe np nq nr ne b">crontab -e</code>打开 crontab。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="e980" class="ni mh iq ne b gy nj nk l nl nm">@reboot cd /var/www/demo-server &amp;&amp; ./demo_3.6/bin/uvicorn app.server:app --port 1234</span></pre><p id="b901" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">保存并关闭该文件。用<code class="fe np nq nr ne b">reboot</code>重启服务器。一旦 droplet 重新启动，应用程序应该会自动启动。</p><p id="ec85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你已经走到这一步，那么恭喜你。🎉去喝杯咖啡吧！这个过程可能看起来有点乏味，但它表明，只需每月<a class="ae kv" href="https://www.digitalocean.com/pricing/" rel="noopener ugc nofollow" target="_blank">$ 5</a>美元，您就可以拥有一个生产级的、交互式的数据项目 web 应用程序，而无需通过一组更狭窄的可视化工具来强制数据科学过程。这种程度的灵活性在很多情况下肯定是不必要的，但是现在你知道如何为自己设置一切了。</p><p id="8241" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于这些步骤中的每一步，还有很多可以说的，但是我想把重点放在主要的工作流程上。当然，更新客户机或服务器需要几个命令，但这很容易实现自动化。如果你真的想要一个长期的、生产就绪的系统，和一个团队一起部署一个<a class="ae kv" href="https://codefresh.io/continuous-integration/continuous-integration-delivery-pipeline-important/" rel="noopener ugc nofollow" target="_blank"> CI/CD </a>过程当然是值得花时间投资的。</p></div></div>    
</body>
</html>