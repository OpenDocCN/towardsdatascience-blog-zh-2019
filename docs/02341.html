<html>
<head>
<title>Spark JOIN using REGEX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用正则表达式的火花连接</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/spark-join-using-regex-40a8589c0354?source=collection_archive---------11-----------------------#2019-04-17">https://towardsdatascience.com/spark-join-using-regex-40a8589c0354?source=collection_archive---------11-----------------------#2019-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/440a96d24c5ac477c94309e3da0d5625.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5G91IaQZFbReDgjuXE-rhg.jpeg"/></div></div></figure><p id="3579" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一篇关于我如何在 SPARK 中使用自定义 UDF 将 2 个数据集与正则表达式有效连接的技术性更强的文章</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="fe82" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">语境</h1><p id="9af9" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在过去的几个月里，我一直在努力解决这个小问题。我有一个正则表达式模式的列表，我想知道哪篇维基百科文章包含它们。</p><p id="3f83" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想以一个包含以下各列的表格作为结束:</p><ul class=""><li id="95c5" class="mg mh iq ka b kb kc kf kg kj mi kn mj kr mk kv ml mm mn mo bi translated">维基百科文章 ID</li><li id="119d" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">维基百科文章文本</li><li id="23bd" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">匹配模式(如果没有触发模式，则为空)</li></ul><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/e83088bb9de2ea8e71f8c61710d89c1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zumeUslVgQTbp9cK8YnLvA.png"/></div></div></figure><p id="6e64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我正则表达式列表大约有 500 个模式长。有些是简单的单词搜索，但有些是更复杂的正则表达式。我需要一种好的方法来搜索这些模式，并找到一种方法将它们转换成上述格式。某种类型的<strong class="ka ir">左外连接。</strong></p><h1 id="37d1" class="ld le iq bd lf lg mz li lj lk na lm ln lo nb lq lr ls nc lu lv lw nd ly lz ma bi translated">设置</h1><p id="1cdb" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">因为维基上有很多文章。很显然，<a class="ae ne" href="https://en.wikipedia.org/wiki/Wikipedia:Size_of_Wikipedia" rel="noopener ugc nofollow" target="_blank">580 万其中</a>。我决定使用一个能够并行研究的工具，我已经决定使用来自阿帕奇基金会的<a class="ae ne" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank"> Spark </a>。现在，你可以选择你最喜欢的云提供商，很有可能你只需点击一下就能得到一个集群，我就是这样做的。</p><p id="4fd8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我有了自己的工作设置，我开始在网上寻找如何做到这一点。</p><p id="f3d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在网上发现的第一件事是用<strong class="ka ir"> rlike </strong>做一个左外连接。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="34fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这看起来很有希望，在一个小场景中，它做的正是我想要的。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/461025d2c3673da5c11018f6ea3f05f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*c_UdkghSVl9-yZ30"/></div></figure><p id="71ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我天真地启动了所有数据集的连接之后…我等了很长时间。实际上，只要我意识到我的集群内存不足。从那时起，我在网上找了好几个小时，尝试了很多解决方案，但我找不到任何关于如何解决这个问题的相关信息。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/7c95d4c9f62235e102cdcf12cd18319e.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*oNvtxk3O3k4VqqdS"/></div></figure><p id="2fb2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于这不是什么真正重要的事情，我有几个月没有碰它，有一天在工作中，我和我的一个同事谈论它，他发现了这个问题。</p><h1 id="3059" class="ld le iq bd lf lg mz li lj lk na lm ln lo nb lq lr ls nc lu lv lw nd ly lz ma bi translated">问题</h1><p id="295b" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">他是这样说的:</p><blockquote class="ni nj nk"><p id="18b4" class="jy jz nl ka b kb kc kd ke kf kg kh ki nm kk kl km nn ko kp kq no ks kt ku kv ij bi translated">“首先，也是最重要的，非等价连接在 Spark 中性能很差，因为它们只能使用<strong class="ka ir">广播嵌套循环连接</strong>或<strong class="ka ir">交叉连接</strong>进行评估。</p><p id="f52e" class="jy jz nl ka b kb kc kd ke kf kg kh ki nm kk kl km nn ko kp kq no ks kt ku kv ij bi translated">让我们假设<strong class="ka ir">文章</strong>包含 1，000，000 行，而<strong class="ka ir">模式</strong>包含 500 行。较小的数据集(本例中为<strong class="ka ir">粒子</strong>)将被广播。为了评估这个连接，<strong class="ka ir">粒子</strong>将被有效地扫描 1，000，000 次，连接谓词将被评估 500，000，000 次。更糟糕的是，该模式将被编译 5 亿次。</p><p id="5c6e" class="jy jz nl ka b kb kc kd ke kf kg kh ki nm kk kl km nn ko kp kq no ks kt ku kv ij bi translated">这基本上意味着灾难。”—迈克尔</p></blockquote><h1 id="300f" class="ld le iq bd lf lg mz li lj lk na lm ln lo nb lq lr ls nc lu lv lw nd ly lz ma bi translated">解决方案</h1><p id="45dc" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">然后，在发现问题后，几天后他带着一件定制的 UDF 回来找我</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="408f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要使用它，只需像这样查询它:</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="c5b4" class="ld le iq bd lf lg mz li lj lk na lm ln lo nb lq lr ls nc lu lv lw nd ly lz ma bi translated">结果</h1><p id="20df" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">我试了一下，几个小时后我就有了我想要的东西。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/f35b4a0421313374ff4360e1555c57d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/0*5HX3ZqpCdBYy-0XX"/></div></figure><p id="6f32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我决定做一个小的基准。在 Spark 中加载和缓存了这两个数据集之后，我只选择了 20 000 篇文章来尝试这两种方法。通过使用完全相同的样本，结果如下:</p><ul class=""><li id="57c9" class="mg mh iq ka b kb kc kf kg kj mi kn mj kr mk kv ml mm mn mo bi translated">第一种技术，<em class="nl"> rlike </em>:每秒 3 篇文章</li><li id="f0c6" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">第二种技术，<em class="nl"> UDF </em>:每秒大约 5 000 篇文章</li></ul><p id="8e57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我知道这种延迟主要是由于缓存、读取和其他内存管理造成的，但这仍然是一个很大的区别。</p><h1 id="ca9c" class="ld le iq bd lf lg mz li lj lk na lm ln lo nb lq lr ls nc lu lv lw nd ly lz ma bi translated">结论</h1><p id="5a6a" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">我通常不写这种类型的博客帖子，但因为我寻找解决方案，但找不到任何东西，我认为它值得分享回来。</p><p id="1801" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我要感谢<a class="ae ne" href="https://www.linkedin.com/in/mstyles/" rel="noopener ugc nofollow" target="_blank">迈克尔·斯泰尔斯</a>对这个项目的帮助。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="9745" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇博客是我自己的博客<a class="ae ne" href="http://coffeeanddata.ca/spark-join-using-regex/" rel="noopener ugc nofollow" target="_blank">咖啡和数据</a>的转贴</p></div></div>    
</body>
</html>