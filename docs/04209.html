<html>
<head>
<title>How to do hyperparameter tuning of a BigQuery ML model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何对 BigQuery ML 模型进行超参数调优</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-hyperparameter-tuning-of-a-bigquery-ml-model-29ba273a6563?source=collection_archive---------28-----------------------#2019-07-01">https://towardsdatascience.com/how-to-do-hyperparameter-tuning-of-a-bigquery-ml-model-29ba273a6563?source=collection_archive---------28-----------------------#2019-07-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f0f8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用云 AI 平台的贝叶斯优化或使用脚本的网格搜索</h2></div><p id="ddb8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">注意:超参数调优</em> <a class="ae lc" href="https://medium.com/google-cloud/hyperparameter-tuning-directly-within-bigquery-ml-a0affb0991ae" rel="noopener"> <em class="lb">现在已经内置到 BigQuery ML </em> </a> <em class="lb">中，对于简单的调优需求，您可以简单地指定一个 hparam_range。使用本文中的方法进行更复杂的超参数调优。</em></p><p id="660b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在进行机器学习时，有许多参数我们选择得相当随意。这些包括诸如学习速率、L2 正则化的水平、神经网络中的层数和节点数、提升树的最大深度、矩阵分解模型的因子数等因素。通常情况下，为这些值选择不同的值可能会产生更好的模型(通过保留的评估数据集上的误差来衡量)。为这些参数选择一个好的值称为超参数调整。</p><p id="7051" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是 GitHub 中示例的<a class="ae lc" href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/hyperparam.ipynb" rel="noopener ugc nofollow" target="_blank">完整代码。它来自我们即将出版的关于 BigQuery 的书。</a></p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi ld"><img src="../Images/5865fb7cea3ec55be2a67112769eb562.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/1*pY5eytKNMGcjpF_qbaoKEA.jpeg"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">The code here is from Chapter 9 of our new book on BigQuery. You can read it in early access on Safari.</figcaption></figure><h1 id="a809" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">使用脚本调整超参数</h1><p id="847d" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">以 K 均值聚类模型为例。BigQuery 云控制台中的 evaluation 选项卡(以及 SELECT * from ML。EVALUATE)显示了 Davies-Bouldin 指数，该指数有助于确定数据支持的最佳分类数(数字越小，分类越好)。</p><p id="3f15" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，下面是一个尝试改变聚类数量的脚本:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="ad62" class="mr lq iq mn b gy ms mt l mu mv">DECLARE NUM_CLUSTERS INT64 DEFAULT 3;<br/>DECLARE MIN_ERROR FLOAT64 DEFAULT 1000.0;<br/>DECLARE BEST_NUM_CLUSTERS INT64 DEFAULT -1;<br/>DECLARE MODEL_NAME STRING;<br/>DECLARE error FLOAT64 DEFAULT 0;</span><span id="e5e4" class="mr lq iq mn b gy mw mt l mu mv">WHILE NUM_CLUSTERS &lt; 8 DO</span><span id="3631" class="mr lq iq mn b gy mw mt l mu mv">SET MODEL_NAME = CONCAT('ch09eu.london_station_clusters_', <br/>                            CAST(NUM_CLUSTERS AS STRING));</span><span id="b035" class="mr lq iq mn b gy mw mt l mu mv">EXECUTE IMMEDIATE format("""<br/>  CREATE OR REPLACE MODEL %s<br/>    OPTIONS(model_type='kmeans', <br/>            num_clusters=%d, <br/>            standardize_features = true) AS<br/>    SELECT * except(station_name)<br/>    from ch09eu.stationstats;<br/>  """, MODEL_NAME, NUM_CLUSTERS);<br/>    <br/>  EXECUTE IMMEDIATE format("""<br/>    SELECT davies_bouldin_index FROM ML.EVALUATE(MODEL %s);<br/>  """, MODEL_NAME) INTO error;<br/>  <br/>    IF error &lt; MIN_ERROR THEN<br/>       SET MIN_ERROR = error;<br/>       SET BEST_NUM_CLUSTERS = NUM_CLUSTERS;<br/>    END IF;<br/>  SET NUM_CLUSTERS = NUM_CLUSTERS + 1;</span><span id="cfaa" class="mr lq iq mn b gy mw mt l mu mv">END WHILE</span></pre><p id="754d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它使用动态 SQL(立即执行)为每个尝试的 num_clusters 创建单独的模型名称。</p><h1 id="da9b" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">Python 中超参数调优</h1><p id="3ab8" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">或者，我们可以使用 Python 及其多线程功能来限制并发查询的数量:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="ca81" class="mr lq iq mn b gy ms mt l mu mv">def train_and_evaluate(num_clusters: Range, max_concurrent=3):<br/>    # grid search means to try all possible values in range<br/>    params = []<br/>    for k in num_clusters.values():<br/>        params.append(Params(k))<br/>    <br/>    # run all the jobs<br/>    print('Grid search of {} possible parameters'.format(len(params)))<br/>    pool = ThreadPool(max_concurrent)<br/>    results = pool.map(lambda p: p.run(), params)<br/>    <br/>    # sort in ascending order<br/>    return sorted(results, key=lambda p: p._error)</span></pre><p id="9d36" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中 Params 类的 run()方法调用适当的训练和评估查询:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="44eb" class="mr lq iq mn b gy ms mt l mu mv">class Params:<br/>    def __init__(self, num_clusters):<br/>        self._num_clusters = num_clusters<br/>        self._model_name = 'ch09eu.london_station_clusters_{}'.format(num_clusters)<br/>        self._train_query = """<br/>          CREATE OR REPLACE MODEL {}<br/>          OPTIONS(model_type='kmeans', <br/>                  num_clusters={}, <br/>                  standardize_features = true) AS<br/>          SELECT * except(station_name)<br/>          from ch09eu.stationstats<br/>        """.format(self._model_name, self._num_clusters)<br/>        self._eval_query = """<br/>          SELECT davies_bouldin_index AS error<br/>          FROM ML.EVALUATE(MODEL {});<br/>        """.format(self._model_name)<br/>        self._error = None<br/>        <br/>    def run(self):<br/>        bq = bigquery.Client(project=PROJECT)<br/>        job = bq.query(self._train_query, location='EU')<br/>        job.result() # wait for job to finish<br/>        evaldf = bq.query(self._eval_query, location='EU').to_dataframe()<br/>        self._error = evaldf['error'][0]<br/>        return self</span></pre><p id="6587" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当在范围[3，9]中搜索时，我们发现误差最小的聚类数是 7。</p><h1 id="3239" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">使用人工智能平台的超参数调谐</h1><p id="e8b4" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">在迄今为止考虑的两种超参数调优方法中，我们尝试了一个范围内参数的每个可能值。随着可能参数数量的增加，网格搜索变得越来越浪费。最好使用更有效的搜索算法，这就是云人工智能平台的超参数调整可以发挥作用的地方。超参数调优服务可以用于任何模型(不仅仅是 TensorFlow)。让我们应用于调整 DNN 模型的特征工程和节点数量。</p><p id="97d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们创建一个配置文件，指定每个参数的范围、并发查询的数量以及试验的总数:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="134b" class="mr lq iq mn b gy ms mt l mu mv">trainingInput:<br/>  scaleTier: CUSTOM<br/>  masterType: standard   # See: <a class="ae lc" href="https://cloud.google.com/ml-engine/docs/tensorflow/machine-types" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/ml-engine/docs/tensorflow/machine-types</a><br/>  hyperparameters:<br/>    goal: MINIMIZE<br/>   <strong class="mn ir"> maxTrials: 50</strong><br/>    maxParallelTrials: 2<br/>    hyperparameterMetricTag: mean_absolute_error<br/>    params:<br/>    - parameterName: afternoon_start<br/>      type: INTEGER<br/>      minValue: 9<br/>      maxValue: 12<br/>      scaleType: UNIT_LINEAR_SCALE<br/>    - parameterName: afternoon_end<br/>      type: INTEGER<br/>      minValue: 15<br/>      maxValue: 19<br/>      scaleType: UNIT_LINEAR_SCALE<br/>    - parameterName: num_nodes_0<br/>      type: INTEGER<br/>      minValue: 10<br/>      maxValue: 100<br/>      scaleType: UNIT_LOG_SCALE<br/>    - parameterName: num_nodes_1<br/>      type: INTEGER<br/>      minValue: 3<br/>      maxValue: 10<br/>      scaleType: UNIT_LINEAR_SCALE</span></pre><p id="c200" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，我们已经为每个参数和要最小化的度量(平均绝对误差)指定了最小值和最大值。我们要求优化只需要 50 次尝试，而网格搜索需要尝试 4x4x90x7 或超过 10，000 个选项！因此，使用 AI 平台超参数调整服务可以节省 200 倍的成本！</p><p id="7e1d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们创建一个 Python 程序，该程序调用 BigQuery 来训练和评估给定一组参数的模型:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="c2a6" class="mr lq iq mn b gy ms mt l mu mv">def train_and_evaluate(args):        <br/>    model_name = "ch09eu.bicycle_model_dnn_{}_{}_{}_{}".format(<br/>        args.afternoon_start, args.afternoon_end, args.num_nodes_0, args.num_nodes_1<br/>    )<br/>    train_query = """<br/>        CREATE OR REPLACE MODEL {}<br/>        TRANSFORM(* EXCEPT(start_date)<br/>                  , IF(EXTRACT(dayofweek FROM start_date) BETWEEN 2 and 6, 'weekday', 'weekend') as dayofweek<br/>                  , ML.BUCKETIZE(EXTRACT(HOUR FROM start_date), [5, {}, {}]) AS hourofday<br/>        )<br/>        OPTIONS(input_label_cols=['duration'], <br/>                model_type='dnn_regressor',<br/>                hidden_units=[{}, {}])<br/>        AS</span><span id="f1b7" class="mr lq iq mn b gy mw mt l mu mv">SELECT <br/>          duration<br/>          , start_station_name<br/>          , start_date<br/>        FROM `bigquery-public-data`.london_bicycles.cycle_hire<br/>    """.format(model_name, <br/>               args.afternoon_start, <br/>               args.afternoon_end,<br/>               args.num_nodes_0,<br/>               args.num_nodes_1)<br/>    logging.info(train_query)<br/>    bq = bigquery.Client(project=args.project, <br/>                         location=args.location, <br/>                         credentials=get_credentials())<br/>    job = bq.query(train_query)<br/>    job.result() # wait for job to finish<br/>    <br/>    eval_query = """<br/>        SELECT mean_absolute_error <br/>        FROM ML.EVALUATE(MODEL {})<br/>    """.format(model_name)<br/>    logging.info(eval_info)<br/>    evaldf = bq.query(eval_query).to_dataframe()<br/>    return evaldf['mean_absolute_error'][0]</span></pre><p id="9a3e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，上面的代码为每个可调参数使用了一个特定的值，并返回平均绝对误差，这是被最小化的度量。</p><p id="a2a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后写出该错误值:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="c934" class="mr lq iq mn b gy ms mt l mu mv">hpt.report_hyperparameter_tuning_metric(<br/>       hyperparameter_metric_tag='mean_absolute_error',<br/>       metric_value=error,<br/>       global_step=1)</span></pre><p id="65d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">培训计划提交给 AI 平台培训服务:</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="6ce5" class="mr lq iq mn b gy ms mt l mu mv">gcloud ai-platform jobs submit training $JOBNAME \<br/>  --runtime-version=1.13 \<br/>  --python-version=3.5 \<br/>  --region=$REGION \<br/>  --module-name=trainer.train_and_eval \<br/>  --package-path=$(pwd)/trainer \<br/>  --job-dir=gs://$BUCKET/hparam/ \<br/>  --config=hyperparam.yaml \<br/>  -- \<br/>  --project=$PROJECT --location=EU</span></pre><p id="e886" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 AI 平台控制台中显示的结果输出包含最佳参数。</p><p id="8e8e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>