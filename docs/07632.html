<html>
<head>
<title>Troubleshooting GC Notebooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GC 笔记本故障排除</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/troubleshooting-gc-notebooks-f3531a4478e1?source=collection_archive---------26-----------------------#2019-10-23">https://towardsdatascience.com/troubleshooting-gc-notebooks-f3531a4478e1?source=collection_archive---------26-----------------------#2019-10-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="06ac" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我最近花了相当多的时间搞清楚谷歌云提供的 Jupyter 笔记本服务。这是一个解决我在设置服务时不得不处理的一些烦人问题的指南。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/60c8c4208a2540a0cc4a2e9f94fae2c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UV3NgSsqL_7r541Fg9-jVQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">I have no infra guys, I have none.</figcaption></figure><p id="6df4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果一切顺利，创建笔记本应该是一项简单的任务。然而，我无法只使用谷歌云控制台来启动和运行它。笔记本实例一直在初始化，显然在<code class="fe lu lv lw lx b">setting up of proxy.</code>失败了</p><p id="93e3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果这个简单的过程(New Instance——Open Jupyter)适合您，那么就没有必要阅读指南。然而，如果你在这里，你可能会寻找更多。</p><h2 id="4f9d" class="ly lz it bd ma mb mc dn md me mf dp mg lh mh mi mj ll mk ml mm lp mn mo mp mq bi translated">解决设置代理错误</h2><p id="b7c3" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">一本正经的指南:</p><ul class=""><li id="f029" class="mw mx it la b lb lc le lf lh my ll mz lp na lt nb nc nd ne bi translated">创建一个具有所需配置的新笔记本。</li><li id="35a2" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">在完成之前，点击<code class="fe lu lv lw lx b">Customise</code>并向下滚动到<code class="fe lu lv lw lx b">Networking</code>并禁用<code class="fe lu lv lw lx b">Allow proxy access when it's available</code>。</li><li id="bd41" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">许可下，默认<code class="fe lu lv lw lx b">Compute Engine default service account</code>有效。如果您稍后遇到权限错误，也可以考虑其他两个选项(<code class="fe lu lv lw lx b">Other service account</code>、<code class="fe lu lv lw lx b">Single user only</code>)。</li><li id="03fb" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">创建笔记本实例。</li><li id="81a9" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">单击实例的名称将打开配置编辑器页面。在进行以下任何配置更改之前，您需要停止该实例。</li><li id="1c7a" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">故障排除文档提到正确设置<code class="fe lu lv lw lx b">Custom metadata</code>到<code class="fe lu lv lw lx b">product_owners</code>下的<code class="fe lu lv lw lx b">proxy-mode</code>。文档可以在这里<a class="ae nk" href="https://cloud.google.com/ai-platform/notebooks/docs/ssh-access#your_jupyterlab_instances_proxy-mode_metadata_setting_is_incorrect" rel="noopener ugc nofollow" target="_blank">找到。然而，对我来说，工作配置是 <code class="fe lu lv lw lx b"><strong class="la iu">proxy_mode</strong></code> <strong class="la iu">设置为</strong> <code class="fe lu lv lw lx b"><strong class="la iu">none</strong></code>。当您执行步骤 2 时，这是默认模式。</a></li><li id="18d9" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">在<code class="fe lu lv lw lx b">Network Interfaces</code>下，确保<code class="fe lu lv lw lx b">External IP</code>不是<code class="fe lu lv lw lx b">None</code>。</li><li id="38bf" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">在<code class="fe lu lv lw lx b">IAM and Admin</code>中，确保当前用户拥有计算访问所需的相关权限。(E.x. compute.instances.get)</li><li id="c3d1" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">接下来，打开<code class="fe lu lv lw lx b">jupyter-lab</code>的选项将被替换为 SSH 到实例。点击<code class="fe lu lv lw lx b">connect</code>获取需要在本地机器上执行的预编写的 shell 命令。</li><li id="b208" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">当尝试使用 SSH 连接时，您的实例需要正在运行。</li><li id="f1e5" class="mw mx it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">如果您在尝试 SSH 时得到一个<code class="fe lu lv lw lx b">Permission denied (publickey)</code>，或者类似这样的消息:</li></ul><pre class="kj kk kl km gt nl lx nm nn aw no bi"><span id="7869" class="ly lz it lx b gy np nq l nr ns">ssh: connect to host IP port 22: Connection refused</span><span id="e400" class="ly lz it lx b gy nt nq l nr ns">ERROR: (gcloud.compute.ssh) [/usr/bin/ssh] exited with return code [255].</span></pre><p id="6ca3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">启动文本编辑器，用超级用户权限编辑这个文件。(以下位置适用于 MacOS)</p><pre class="kj kk kl km gt nl lx nm nn aw no bi"><span id="22e6" class="ly lz it lx b gy np nq l nr ns">sudo nano /private/etc/ssh/sshd_config</span></pre><p id="f085" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将现有的两行更新为:</p><pre class="kj kk kl km gt nl lx nm nn aw no bi"><span id="3d0f" class="ly lz it lx b gy np nq l nr ns">Port 22<br/>PermitRootLogin yes</span></pre><p id="09e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请再次尝试关闭该实例。您现在应该能够成功地做到这一点。您可以使用下面的命令来验证<code class="fe lu lv lw lx b">jupyter-lab</code>是否真的作为服务在实例<code class="fe lu lv lw lx b">ps -ef | grep jupyter</code>上运行</p><p id="04af" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您仍然得到相同的错误，运行<code class="fe lu lv lw lx b">gcloud auth login</code>并基于网络完成认证过程。您也可以设置默认的项目详细信息。</p><p id="638e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">前往<code class="fe lu lv lw lx b"><a class="ae nk" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></code>访问笔记本！</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><h2 id="e5d5" class="ly lz it bd ma mb mc dn md me mf dp mg lh mh mi mj ll mk ml mm lp mn mo mp mq bi translated">附加注释</h2><p id="57a2" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">如果您使用 GPU，请确保在配置笔记本实例时选中自动安装必要的驱动程序。</p><p id="8da1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个新启动的实例需要一些时间来安装驱动程序，所以请耐心等待。使用下面的代码片段来验证是否一切顺利，以及是否列出了 GPU。(<a class="ae nk" href="https://www.tensorflow.org/guide/gpu#setup" rel="noopener ugc nofollow" target="_blank">来源</a>)</p><pre class="kj kk kl km gt nl lx nm nn aw no bi"><span id="64bf" class="ly lz it lx b gy np nq l nr ns">from __future__ import absolute_import, division, print_function, unicode_literals</span><span id="0b28" class="ly lz it lx b gy nt nq l nr ns">import tensorflow as tf<br/>print("Num GPUs Available: ", len(tf.config.experimental.list_physical_devices('GPU')))</span></pre><p id="2cf9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您已经打开了日志记录(<code class="fe lu lv lw lx b">tf.debugging.set_log_device_placement(True)</code>)，那么您可以在 SSHed 实例中使用下面的命令来查看日志:<code class="fe lu lv lw lx b">journalctl -f -u jupyter</code>。这些日志将有助于在出现 GPU 相关问题时进行额外的故障排除。这些日志也可在控制台上的监控-串行端口#1(控制台)中找到。</p><p id="4cfe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">再见。</p></div></div>    
</body>
</html>