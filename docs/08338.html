<html>
<head>
<title>Walkthrough: Mapping Basics with bokeh and GeoPandas in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">演练:使用 Python 中的 bokeh 和 GeoPandas 进行基本映射</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/walkthrough-mapping-basics-with-bokeh-and-geopandas-in-python-43f40aa5b7e9?source=collection_archive---------3-----------------------#2019-11-13">https://towardsdatascience.com/walkthrough-mapping-basics-with-bokeh-and-geopandas-in-python-43f40aa5b7e9?source=collection_archive---------3-----------------------#2019-11-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bb00" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从数据和文件到静态地图再到交互式地图</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2ba76bfeac675335309e7424358963ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKBPpqIU0VZpxA5DetO73A.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Final static plot. Keep reading for the interactivity!</figcaption></figure><p id="4ff9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我本周的目标是学习如何制作一个交互式地图，然后创建一个关于如何制作该地图的教程。地图在可视化地理数据和随时间变化方面非常有用。它们可以提供一种很好的方式来缩小视图，查看宏观层面的变化。首先，我将概述所使用的两个主要包:GeoPandas 和 bokeh。然后，我将介绍如何从一个特定的数据集到一个特定的交互式地图。创建的地图决不是完整或完美的。总之，我将回顾一些潜在的改进，并提供一个我在哪里找到我的信息的资源列表和一些起点，如果你对散景、GeoPandas 或交互式制图感兴趣的话。</p><h1 id="e2d4" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">目标</h1><ul class=""><li id="0ce5" class="mm mn it la b lb mo le mp lh mq ll mr lp ms lt mt mu mv mw bi translated">了解如何使用散景和 GeoPandas 创建交互式地图的基础知识</li><li id="f4a7" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">了解软件包的应用，以便绘制 2018 年在整个美国邻近地区采集的水样中的铅含量</li><li id="f6eb" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">如果你有关于散景和地质公园的问题，知道去哪里</li></ul><p id="54b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这篇博文的灵感来自于各种关于制图和可视化的帖子。所有的灵感来源和其他有用的链接都发布在下面的参考资料部分。</p><p id="236a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">代码可以在</strong> <a class="ae nc" href="https://github.com/rweng18/bokeh_map" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">我的 GitHub 回购</strong> </a> <strong class="la iu">上找到。</strong></p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="bd75" class="lu lv it bd lw lx nk lz ma mb nl md me jz nm ka mg kc nn kd mi kf no kg mk ml bi translated">包 1: GeoPandas</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/77513776a1dfa368c429e2e886a2ee91.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*syl9ER2I5XhpoGVcn0sQWg.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Examples from GeoPandas Gallery</figcaption></figure><p id="b171" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">GeoPandas 是一个帮助用户处理地理空间数据的开源包。GeoPandas 有许多依赖项。我们将关注的是包 shapely，GeoPandas 依赖它来执行几何运算。在我们的例子中，美国各州的形状将通过 shapely 包编码为多边形或多多边形。然后通过 GeoPandas 来理解地理空间数据。</p><p id="b1e2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">安装</strong></p><p id="108b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了让 GeoPandas 运行，需要安装一些软件包。很难确保这一点。但是如果你确定的话，可以用 pip 安装。否则，使用 Anaconda 安装 GeoPandas 将会为您处理依赖关系。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="14ee" class="nv lv it nr b gy nw nx l ny nz">conda install geopandas</span></pre><p id="b948" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在这里阅读更多关于安装 GeoPandas <a class="ae nc" href="http://geopandas.org/install.html" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="d30c" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">包装 2:散景</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/ccf7803787571db432d6b2d20ef23e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kZCRcRvRKcd_RhgXO8bAZg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Gallery of plots you can make in Bokeh</figcaption></figure><p id="f746" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">虽然 GeoPandas 允许绘图，但散景允许我们创建更复杂的绘图。bokeh 是一个多功能的开源软件包，旨在帮助用户创建漂亮的交互式可视化效果。2013 年 4 月首次发布 Bokeh，最近一次发布是在 2019 年 10 月。在此最新版本之后，将不再支持 Python 2.7、Python 3.5 或更早版本。你可以在这里找到你可以在散景中制作的完整图库。</p><p id="4b7a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">安装</strong></p><p id="8ef6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">散景依赖于几个软件包。您仍然可以使用 pip 来安装 Bokeh，但是您可能会遇到依赖性方面的问题。在我的例子中，我使用 Anaconda 来安装 bokeh，因为它负责确保依赖关系是有序的。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="82fe" class="nv lv it nr b gy nw nx l ny nz">conda install bokeh</span></pre><p id="5ffe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">安装的更多细节可以在<a class="ae nc" href="https://docs.bokeh.org/en/latest/docs/user_guide/quickstart.html#userguide-quickstart" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae nc" href="https://docs.bokeh.org/en/latest/docs/installation.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="3dbc" class="lu lv it bd lw lx nk lz ma mb nl md me jz nm ka mg kc nn kd mi kf no kg mk ml bi translated">例如:观察水中的铅含量</h1><h2 id="43ec" class="nv lv it bd lw ob oc dn ma od oe dp me lh of og mg ll oh oi mi lp oj ok mk ol bi translated">目标</h2><p id="4bb9" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh om lj lk ll on ln lo lp oo lr ls lt im bi translated">创建一个显示美国各州人口的地图。在每个州内，显示 2018 年在哪里发现了铅。</p><h2 id="4c2f" class="nv lv it bd lw ob oc dn ma od oe dp me lh of og mg ll oh oi mi lp oj ok mk ol bi translated">创造连续的美国</h2><p id="0b75" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh om lj lk ll on ln lo lp oo lr ls lt im bi translated">为了创建一个地图，你需要一个形状文件。shp)。在这种情况下，我从美国人口普查局<a class="ae nc" href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" rel="noopener ugc nofollow" target="_blank">这里</a>下载了一个 shapefile。该文件告诉 Geopandas 我们正在绘制什么形状。在我们的例子中，我们需要一个文件来概述美国相邻的每个州。我们使用一个 geometry 列，以便 Geopandas 包知道在哪里寻找每个州的形状信息。在这种情况下，形状是形状良好的多边形对象。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="91df" class="nv lv it nr b gy nw nx l ny nz"># Import geopandas package<br/>import geopandas as gpd</span><span id="e785" class="nv lv it nr b gy op nx l ny nz"># Read in shapefile and examine data<br/>contiguous_usa = gpd.read_file('data/cb_2018_us_state_20m.shp')<br/>contiguous_usa.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/2c2e1a5919748fe711b3f19ccabcbf56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PEGrZh7p-ilMLbw9qLurOA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">First 5 rows of contiguous USA shapefile</figcaption></figure><p id="b058" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在 Jupyter 笔记本中运行以下代码行将返回马里兰州的图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/e9cb0a08b8a0ac03c2615ed6c8a27a45.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*-Q1dSlZ2ZojNtD0ME589_Q.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Running just the first entry in the geometry column, which represents the shapely geometry needed to create an image of Maryland</figcaption></figure><p id="2937" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是我们可以将 geometry 元素转换为字符串，以查看 shapely geometry 对象是如何表示的:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="b286" class="nv lv it nr b gy nw nx l ny nz">str(contiguous_usa.iloc[0]['geometry'])</span></pre><p id="8a9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">返回一个长字符串，该字符串代表构成马里兰州的许多多边形:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="410e" class="nv lv it nr b gy nw nx l ny nz">'MULTIPOLYGON (((-76.04621299999999 38.025533, -76.00733699999999 38.036706, -75.98008899999999 38.004891, -75.98464799999999 37.938121, -76.04652999999999 37.953586, -76.04621299999999 38.025533))...</span></pre><h2 id="9c8c" class="nv lv it bd lw ob oc dn ma od oe dp me lh of og mg ll oh oi mi lp oj ok mk ol bi translated">数据:国家人口</h2><p id="b5c0" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh om lj lk ll on ln lo lp oo lr ls lt im bi translated">现在我们已经有了如何绘制美国地图的想法，我们需要将每个州的几何图形与我们想要绘制的数据结合起来。在这种情况下，我们需要将每个州与其 2018 年的人口联系起来。你可以通过美国人口普查局在这里找到美国各州和年份的人口估计。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="6956" class="nv lv it nr b gy nw nx l ny nz">import pandas as pd</span><span id="04bf" class="nv lv it nr b gy op nx l ny nz"># Read in state population data and examine<br/>state_pop = pd.read_csv('data/state_pop_2018.csv')<br/>state_pop.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/9f1d49ddb80e77abba16e78c3ae232e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*0Lhi1aJ_j6s4oXs9cmWmKA.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">First 5 rows of state_pop dataframe</figcaption></figure><p id="3b2b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们知道 shapefile 和 state population csv 都有一个名为“NAME”的列，我们可以将它们匹配在一起。所以现在我们可以使用 pandas 合并文件。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="2740" class="nv lv it nr b gy nw nx l ny nz"># Merge shapefile with population data<br/>pop_states = contiguous_usa.merge(state_pop, left_on = ‘NAME’, right_on = ‘NAME’)</span><span id="e3e0" class="nv lv it nr b gy op nx l ny nz"># Drop Alaska and Hawaii<br/>pop_states = pop_states.loc[~pop_states['NAME'].isin(['Alaska', 'Hawaii'])]</span></pre><p id="495e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们已经合并了数据并将其限制在相邻的美国，我们可以将数据转换为有利于制图的格式:</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="a366" class="nv lv it nr b gy nw nx l ny nz">import json<br/>from bokeh.io import show<br/>from bokeh.models import (CDSView, ColorBar, ColumnDataSource,<br/>                          CustomJS, CustomJSFilter, <br/>                          GeoJSONDataSource, HoverTool,<br/>                          LinearColorMapper, Slider)<br/>from bokeh.layouts import column, row, widgetbox<br/>from bokeh.palettes import brewer<br/>from bokeh.plotting import figure</span><span id="b702" class="nv lv it nr b gy op nx l ny nz"># Input GeoJSON source that contains features for plotting<br/>geosource = GeoJSONDataSource(geojson = pop_states.to_json())</span></pre><p id="7dc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，数据已经转换为适当的格式，我们可以使用以下步骤绘制州人口地图:</p><ol class=""><li id="e613" class="mm mn it la b lb lc le lf lh ot ll ou lp ov lt ow mu mv mw bi translated">创建图形对象</li><li id="9c1d" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">将面片渲染器添加到图形中</li><li id="6f1e" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">创建悬停工具</li><li id="25fd" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">展示图</li></ol><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="c2b2" class="nv lv it nr b gy nw nx l ny nz"># Create figure object.<br/>p = figure(title = 'Lead Levels in Water Samples, 2018', <br/>           plot_height = 600 ,<br/>           plot_width = 950, <br/>           toolbar_location = 'below',<br/>           tools = “pan, wheel_zoom, box_zoom, reset”)<br/>p.xgrid.grid_line_color = None<br/>p.ygrid.grid_line_color = None</span><span id="5445" class="nv lv it nr b gy op nx l ny nz"># Add patch renderer to figure.<br/>states = p.patches('xs','ys', source = geosource,<br/>                   fill_color = None,<br/>                   line_color = ‘gray’, <br/>                   line_width = 0.25, <br/>                   fill_alpha = 1)</span><span id="9a60" class="nv lv it nr b gy op nx l ny nz"># Create hover tool<br/>p.add_tools(HoverTool(renderers = [states],<br/>                      tooltips = [('State','@NAME'),<br/>                                ('Population','@POPESTIMATE2018')]))</span><span id="9ca6" class="nv lv it nr b gy op nx l ny nz">show(p)</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Basic map showing some tools available in bokeh package</figcaption></figure><p id="96a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们已经创建了地图，我们可以添加一个颜色条来指示州人口。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="5840" class="nv lv it nr b gy nw nx l ny nz"># Define color palettes<br/>palette = brewer['BuGn'][8]<br/>palette = palette[::-1] # reverse order of colors so higher values have darker colors</span><span id="ba84" class="nv lv it nr b gy op nx l ny nz"># Instantiate LinearColorMapper that linearly maps numbers in a range, into a sequence of colors.<br/>color_mapper = LinearColorMapper(palette = palette, low = 0, high = 40000000)</span><span id="5fc0" class="nv lv it nr b gy op nx l ny nz"># Define custom tick labels for color bar.<br/>tick_labels = {‘0’: ‘0’, ‘5000000’: ‘5,000,000’,<br/> ‘10000000’:’10,000,000', ‘15000000’:’15,000,000',<br/> ‘20000000’:’20,000,000', ‘25000000’:’25,000,000',<br/> ‘30000000’:’30,000,000', ‘35000000’:’35,000,000',<br/> ‘40000000’:’40,000,000+’}</span><span id="a91c" class="nv lv it nr b gy op nx l ny nz"># Create color bar.<br/>color_bar = ColorBar(color_mapper = color_mapper, <br/>                     label_standoff = 8,<br/>                     width = 500, height = 20,<br/>                     border_line_color = None,<br/>                     location = (0,0), <br/>                     orientation = ‘horizontal’,<br/>                     major_label_overrides = tick_labels)</span><span id="2c8a" class="nv lv it nr b gy op nx l ny nz"># Create figure object.<br/>p = figure(title = ‘Lead Levels in Water Samples, 2018’, <br/>           plot_height = 600, plot_width = 950, <br/>           toolbar_location = ‘below’,<br/>           tools = “pan, wheel_zoom, box_zoom, reset”)<br/>p.xgrid.grid_line_color = None<br/>p.ygrid.grid_line_color = None</span><span id="638f" class="nv lv it nr b gy op nx l ny nz"># Add patch renderer to figure.<br/>states = p.patches(‘xs’,’ys’, source = geosource,<br/>                   fill_color = {‘field’ :'POPESTIMATE2018',<br/>                                 ‘transform’ : color_mapper},<br/>                   line_color = ‘gray’, <br/>                   line_width = 0.25, <br/>                   fill_alpha = 1)</span><span id="52a4" class="nv lv it nr b gy op nx l ny nz"># Create hover tool<br/>p.add_tools(HoverTool(renderers = [states],<br/>                      tooltips = [(‘State’,’@NAME’),<br/>                               (‘Population’, ‘@POPESTIMATE2018’)]))</span><span id="7a9c" class="nv lv it nr b gy op nx l ny nz"># Specify layout<br/># p.add_layout(color_bar, ‘below’)</span><span id="dec6" class="nv lv it nr b gy op nx l ny nz">show(p)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/39dee38b937433c0d0f43974d06b85d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UXhKrA2-0OkdsbqPvxnkjg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Map with coloring based on state population</figcaption></figure><h2 id="d450" class="nv lv it bd lw ob oc dn ma od oe dp me lh of og mg ll oh oi mi lp oj ok mk ol bi translated">数据:销售线索级别</h2><p id="e904" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh om lj lk ll on ln lo lp oo lr ls lt im bi translated">现在我们已经有了基本的地图，我们可以添加关于发现铅的水域的信息。我用的数据来自<a class="ae nc" href="https://www.waterqualitydata.us/" rel="noopener ugc nofollow" target="_blank">水质数据</a>。根据现有的数据，我下载了两个数据集:</p><ol class=""><li id="de08" class="mm mn it la b lb lc le lf lh ot ll ou lp ov lt ow mu mv mw bi translated">2018 年美国所有的水站点</li><li id="9169" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">2018 年美国每一份检测铅含量的水样的结果</li></ol><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="dc41" class="nv lv it nr b gy nw nx l ny nz">sites_df = pd.read_csv('data/sites_2018.csv')<br/>lead_samples = pd.read_csv('data/lead_samples_2018.csv')</span></pre><p id="e963" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们加载数据之后，我们需要检查和清理数据。在这种情况下，去除没有铅结果或 0 微克/升铅的点。在这种情况下，我们只想绘制以微克/升或毫克/升为单位进行测试的位置。我们将毫克/升转换为微克/升，以获得一致的单位。</p><p id="61f6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">清理完数据后，我们可以将水源与铅样本合并。然后，我们对网站进行排序，删除任何重复的网站，在网站和日期上进行匹配。然后，我们可以根据纬度和经度对美国境内的水源进行分类。然后我们创建一个月列用于绘图目的。最后，我们通过创建有形状的几何点对象来创建一个几何行</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="6642" class="nv lv it nr b gy nw nx l ny nz">lead_sites = lead_per_l.merge(sites_no_dup,<br/>                          left_on = ‘MonitoringLocationIdentifier’,<br/>                          right_on = ‘MonitoringLocationIdentifier’)</span><span id="7044" class="nv lv it nr b gy op nx l ny nz">lead_sites_sorted = lead_sites.sort_values(by = ‘ActivityStartDate’)</span><span id="579d" class="nv lv it nr b gy op nx l ny nz"># After dropping duplicates by date, 12,249 data points<br/>lead_sites_dropdup = lead_sites_sorted.drop_duplicates(subset = [‘MonitoringLocationIdentifier’, ‘ActivityStartDate’], keep = ‘last’).reset_index(drop = True)</span><span id="678e" class="nv lv it nr b gy op nx l ny nz"># Drop data points not in the contiguous USA, 10,341 data points<br/>lead_sites_dropdup = lead_sites_dropdup[(lead_sites_dropdup[‘LongitudeMeasure’] &lt;= -60) <br/>                 &amp; (lead_sites_dropdup[‘LongitudeMeasure’] &gt;= -130)<br/>                 &amp; (lead_sites_dropdup[‘LatitudeMeasure’] &lt;= 50) <br/>                 &amp; (lead_sites_dropdup[‘LatitudeMeasure’] &gt;= 20)]</span><span id="c179" class="nv lv it nr b gy op nx l ny nz"># Create Month column for plotting Slider<br/>lead_sites_dropdup[‘Month’] = [int(x.split(‘-’)[1]) for x in lead_sites_dropdup[‘ActivityStartDate’]]</span><span id="25af" class="nv lv it nr b gy op nx l ny nz"># Create shapely.Point objects based on longitude and latitude<br/>geometry = []</span><span id="531b" class="nv lv it nr b gy op nx l ny nz">for index, row in lead_sites_dropdup.iterrows():<br/>    geometry.append(Point(row[‘LongitudeMeasure’], <br/>                          row[‘LatitudeMeasure’]))</span><span id="a6b8" class="nv lv it nr b gy op nx l ny nz">lead_sites_contig = lead_sites_dropdup.copy()<br/>lead_sites_contig[‘geometry’] = geometry</span></pre><p id="f1ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">既然我们已经创建了合适的几何列，我们可以指定坐标参考系统(crs)并将数据转换为地理数据框架。然后我们提取 x 和 y 坐标用于绘图，并转换为 columndatasource。更多关于散景数据源的信息可以在<a class="ae nc" href="https://docs.bokeh.org/en/latest/docs/reference/models/sources.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="a1e4" class="nv lv it nr b gy nw nx l ny nz"># Read dataframe to geodataframe<br/>lead_sites_crs = {‘init’: ‘epsg:4326’}<br/>lead_sites_geo = gpd.GeoDataFrame(lead_sites_contig,<br/>                                  crs = lead_sites_crs,<br/>                             geometry = lead_sites_contig.geometry)</span><span id="6f10" class="nv lv it nr b gy op nx l ny nz"># Get x and y coordinates<br/>lead_sites_geo[‘x’] = [geometry.x for geometry in lead_sites_geo[‘geometry’]]<br/>lead_sites_geo[‘y’] = [geometry.y for geometry in lead_sites_geo[‘geometry’]]<br/>p_df = lead_sites_geo.drop(‘geometry’, axis = 1).copy()</span><span id="7052" class="nv lv it nr b gy op nx l ny nz">sitesource = ColumnDataSource(p_df)</span></pre><h2 id="1932" class="nv lv it bd lw ob oc dn ma od oe dp me lh of og mg ll oh oi mi lp oj ok mk ol bi translated">滑块工具</h2><p id="4dc4" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh om lj lk ll on ln lo lp oo lr ls lt im bi translated">有许多数据点(10，000 多个)，按时间段查看数据可能更有意义。因此，对于这个例子，我按月划分数据，并创建了一个滑块工具，以便您可以查看 2018 年任何月份的每个水站点。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="97c0" class="nv lv it nr b gy nw nx l ny nz"># Make a slider object to toggle the month shown<br/>slider = Slider(title = ‘Month’, <br/>                start = 1, end = 12, <br/>                step = 1, value = 1)</span></pre><p id="ff82" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们已经创建了 slider 对象，我们需要根据用户输入更新它。我们通过编写一个回调函数和一个 CustomJSFilter 来实现这一点。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="7e2f" class="nv lv it nr b gy nw nx l ny nz"># This callback triggers the filter when the slider changes<br/>callback = CustomJS(args = dict(source=sitesource), <br/>                    code = """source.change.emit();""")<br/>slider.js_on_change('value', callback)</span><span id="1ade" class="nv lv it nr b gy op nx l ny nz"># Creates custom filter that selects the rows of the month based on the value in the slider<br/>custom_filter = CustomJSFilter(args = dict(slider = slider, <br/>                                           source = sitesource), <br/>                               code = """<br/>var indices = [];<br/>// iterate through rows of data source and see if each satisfies some constraint<br/>for (var i = 0; i &lt; source.get_length(); i++){<br/> if (source.data[‘Month’][i] == slider.value){<br/> indices.push(true);<br/> } else {<br/> indices.push(false);<br/> }<br/>}<br/>return indices;<br/>""")</span><span id="324d" class="nv lv it nr b gy op nx l ny nz"># Uses custom_filter to determine which set of sites are visible<br/>view = CDSView(source = sitesource, filters = [custom_filter])</span></pre><p id="b243" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们已经写好了函数，我们可以绘制水样采集站点，站点的悬停工具，以及滑块。</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="ee74" class="nv lv it nr b gy nw nx l ny nz"># Plots the water sampling sites based on month in slider<br/>sites = p.circle('x', 'y', source = sitesource, color = 'red', <br/>                 size = 5, alpha = 0.3, view = view)</span><span id="fe0c" class="nv lv it nr b gy op nx l ny nz"># Add hover tool<br/>p.add_tools(HoverTool(renderers = [sites],<br/>                      tooltips = [('Organization', '@OrganizationFormalName'),<br/>                                  ('Location Type', '@MonitoringLocationTypeName'),<br/>                                  ('Date', '@ActivityStartDate'),<br/>                                  ('Lead (ug/l)', '@LeadValue_ug_l')]))</span><span id="65f4" class="nv lv it nr b gy op nx l ny nz"># Make a column layout of widgetbox(slider) and plot, and add it to the current document<br/>layout = column(p, widgetbox(slider))</span><span id="6139" class="nv lv it nr b gy op nx l ny nz">show(layout)</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Finished bokeh plot!</figcaption></figure><h2 id="a733" class="nv lv it bd lw ob oc dn ma od oe dp me lh of og mg ll oh oi mi lp oj ok mk ol bi translated">改善可视化的方法</h2><ol class=""><li id="0006" class="mm mn it la b lb mo le mp lh mq ll mr lp ms lt ow mu mv mw bi translated">目前，该地图仅显示了州一级的人口，但由于水样/站点可能无法覆盖整个州，因此更详细的人口细分(例如按县)可能会提供更多信息。</li><li id="fb65" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">为了与 1 保持一致，显示哪个区域从这些水源获得水可能是有趣的。</li><li id="0688" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">目前，该地图没有提供关于铅含量的统计数据的快速概览(例如:检测到的最少/最多铅、方差、多次记录的地点变化等。)</li><li id="c148" class="mm mn it la b lb mx le my lh mz ll na lp nb lt ow mu mv mw bi translated">从视觉上来看，可以在标记或改变悬停工具的样式方面进行改进。</li></ol></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="1dad" class="lu lv it bd lw lx nk lz ma mb nl md me jz nm ka mg kc nn kd mi kf no kg mk ml bi translated">资源</h1><ul class=""><li id="6041" class="mm mn it la b lb mo le mp lh mq ll mr lp ms lt mt mu mv mw bi translated">使用 Python 制作交互式地理地图的完整指南<em class="pa">走向数据科学</em> (Shivangi Patel，2019 年 2 月 5 日)</li><li id="d5bc" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="https://docs.bokeh.org/en/latest/docs/user_guide/interaction/widgets.html" rel="noopener ugc nofollow" target="_blank">“添加小部件”<em class="pa">散景文档。</em> </a></li><li id="d28b" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="https://docs.bokeh.org/en/latest/docs/reference/models/filters.html#bokeh.models.filters.CustomJSFilter" rel="noopener ugc nofollow" target="_blank">“散景.模型.滤镜”<em class="pa">散景文档。</em>T11】</a></li><li id="a917" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="https://docs.bokeh.org/en/latest/docs/reference/models/sources.html" rel="noopener ugc nofollow" target="_blank">“散景.模型.来源”。<em class="pa">散景文档。</em>T15】</a></li><li id="e7ca" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="http://geopandas.org/index.html" rel="noopener ugc nofollow" target="_blank"> GeoPandas 文档</a></li><li id="8e65" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">GeoPandas 101:在地图上绘制任何带有经度和纬度的数据。(瑞安·斯图尔特，2018 年 10 月 31 日)</li><li id="f7e2" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="https://stackoverflow.com/questions/46420266/how-to-use-a-slider-callback-to-filter-a-columndatasource-in-bokeh-using-python" rel="noopener ugc nofollow" target="_blank">如何使用 Python 3 在 Bokeh 中使用 slider 回调过滤 ColumnDataSource？<em class="pa">栈溢出。</em> </a></li><li id="d325" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="https://automating-gis-processes.github.io/2016/Lesson5-interactive-map-bokeh.html" rel="noopener ugc nofollow" target="_blank">“带散景的交互式地图”赫尔辛基大学。</a></li><li id="51a3" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated">“Javascript 回调”<em class="pa">散景文档</em>T29】</li><li id="2036" class="mm mn it la b lb mx le my lh mz ll na lp nb lt mt mu mv mw bi translated"><a class="ae nc" href="https://shapely.readthedocs.io/en/stable/manual.html#" rel="noopener ugc nofollow" target="_blank">风韵犹存的用户手册</a></li></ul></div></div>    
</body>
</html>