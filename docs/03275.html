<html>
<head>
<title>Complementing A B Testing with Machine Learning and Feature Importance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用机器学习和特征重要性来补充 A B 测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/complementing-a-b-testing-with-machine-learning-6c5c92baa162?source=collection_archive---------7-----------------------#2019-05-25">https://towardsdatascience.com/complementing-a-b-testing-with-machine-learning-6c5c92baa162?source=collection_archive---------7-----------------------#2019-05-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e330" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">特性重要性如何帮助我从 A B 测试中得出正确的结论</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7e26add8e7b3edec1cb6d28042eaf81e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gkVPPy-Y92oYWYcM"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@evertonvila?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Everton Vila</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8fe9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我想重点关注使用机器学习来补充其他数据科学任务，特别是 A/B 测试。这应该是一个实用的帖子，而不是理论上的讨论，我假设你至少对<strong class="lb iu"> A/B 测试</strong>和<strong class="lb iu">随机森林</strong>和<strong class="lb iu">特征重要性</strong>有些熟悉。</p><p id="043c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近遇到了一个有趣的挑战，要求我运行一个 A/B 测试，以测试一种拍卖类型是否比另一种拍卖类型卖得快。简单地运行 A/B 测试会得出这样的结论:一种拍卖类型确实比另一种类型卖得快，但事实证明，拍卖类型不是更快销售时间背后的主要驱动因素。这是一种拍卖类型的较低的相关价格。如果销售这些汽车的公司决定通过这种拍卖方式来销售，而不是首先关注定价，这可能会产生可怕的后果。</p><p id="e345" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我发现这一点的方法是在数据集上运行随机森林，然后获取要素重要性，这有助于我发现这一点。事实上，我通常认为机器学习是探索性数据分析(EDA)以及 A/B 测试的一个很好的补充工具。</p><h1 id="1182" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据</h1><p id="6e5d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们先来快速看一下数据。对于 A/B 测试，感兴趣的是销售渠道，即两种不同的拍卖类型和销售时间，这是销售日期和购买日期之间的差异。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/3ea56e437b159b362c3e480163113378.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Os908fDwget8PxmwnLfIbQ.png"/></div></div></figure><h1 id="1eae" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">挑战</h1><p id="229e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">挑战在于运行 A/B 测试来判断拍卖类型 1 或 2 是否卖得更快——例如，如果我们可以得出一种类型比另一种类型卖得更快的结论，公司可以专注于通过一次拍卖卖出更多。</p><h1 id="3bba" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">A/B 测试</h1><p id="ad3d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">事实证明，两种拍卖类型的销售时间分布都不是“正态”或 t 分布。两者都有一条长长的尾巴。然而，由于有了<strong class="lb iu">中心极限定理</strong>，我们可以通过从这些分布中随机取样并每次取其平均销售时间，将这些分布转换成更正态的分布。例如，如果我们这样做 1000 次，那么我们从图 1(显示每种拍卖类型的销售时间)到图 2(显示每种拍卖类型的平均销售时间)。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6078" class="my lw it mu b gy mz na l nb nc"># Do the sampling</span><span id="382a" class="my lw it mu b gy nd na l nb nc">results = [] # create an empty list into which I insert the sampled means<br/>random_state = np.arange(0,1000) # random seeds for reproducibility</span><span id="b5aa" class="my lw it mu b gy nd na l nb nc"># sample with replacement using 50% of the data; do this 1000 times<br/># and append the mean seeling time to the list ‘results’<br/>for i in range(1000):<br/> sample = df.sample(frac=0.5, replace=True, <br/> random_state=random_state[i]).groupby(by=’sales_channel’)[‘selling_time’].mean()<br/> results.append(sample)<br/>results = pd.DataFrame(results)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/48a22e6d5e393e21c0fbebea03361af0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cj56TaPYGdjkDh6bTdbNIQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Graph1 — Distribution of Selling Time in Days</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/f622864f5a88ba922e5896245570a05c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ennH2ZqlReHirXnTPW_Lzg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Graph 2 — Average Selling Time in Days</figcaption></figure><p id="b052" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图 1 中不太明显的情况在图 2 中变得非常明显:拍卖类型 1 的平均销售时间比拍卖类型 2 短得多。运行 A/B 测试证实了这一点，p 值为 0.00。在这里运行 A/B 测试似乎是多余的，因为分布甚至没有重叠。</p><p id="9087" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们现在得出结论，该公司应该只通过拍卖类型 1 销售，因为汽车销售更快，那么我们可能会犯一个错误。</p><p id="6adc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果除了销售时间之外，还有其他特性/特征使这两种拍卖类型截然不同呢？这个数据集只有很少的特征，所以我们可以绘制更多相似的分布，计算可能的相关性等等。一种更简单、更有效的方法是使用机器学习来帮助我们——当我们有更多功能时，这变得特别有用——如果不是必要的话。</p><h1 id="10f1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">对救援的重要性</h1><p id="984d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">大多数机器学习算法都有一种计算其特征重要性的方法，即每个特征在预测目标/依赖特征时发挥了多大的作用。这里的目标是销售时间。</p><p id="d2e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在数据集上运行了随机森林，并计算了特征重要性。我还使用了 CatBoost，一种梯度提升树方法，但得出了相同的结论。这就是我坚持使用随机森林的原因，因为这是一种更容易让你理解的算法。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="eed4" class="my lw it mu b gy mz na l nb nc"># Set up the model and define its parameters — let’s keep it simple<br/>rf = RandomForestRegressor(n_estimators=100, max_depth=5)</span><span id="9267" class="my lw it mu b gy nd na l nb nc"># Fit the model<br/>rf.fit(X_train, y_train)</span><span id="b524" class="my lw it mu b gy nd na l nb nc"># Calculate the mean feature importance<br/>importances = rf.feature_importances_</span><span id="2c92" class="my lw it mu b gy nd na l nb nc"># Calculate the standard deviation of the feature importance<br/>std = np.std([tree.feature_importances_ for tree in rf.estimators_],<br/> axis=0)</span><span id="dcb2" class="my lw it mu b gy nd na l nb nc"># Sort the features by their importance<br/>indices = np.argsort(-importances)[::-1]</span><span id="4b83" class="my lw it mu b gy nd na l nb nc"># Plot the feature importances <br/>plt.figure(figsize=(12,8))<br/>plt.title(“Feature importances”)<br/>plt.barh(range(X.shape[1]), importances[indices], <br/> color=”r”, yerr=std[indices], align=”center”)<br/>plt.yticks(range(X.shape[1]),X.columns[indices], rotation=0)<br/>plt.ylim([len(importances)-6, len(importances)])<br/>plt.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/acbc367481fa5e2bcf9ca9619dc5c035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c29ONCf2qqwW1sKaYyxvGg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Random Forest Feature Importance</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/e50bd2e91d0a56df5f227f5bd5395f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*sKEOHK0NUD_KTLx6Sax5BQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">SHAP Values</figcaption></figure><p id="217d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在左侧，您可以看到每个特性对预测销售时间的重要性，柱越长，特性越重要。购买价格是最重要的特征，而销售渠道(拍卖类型)几乎无关紧要。</p><p id="02a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我计算了另一种叫做 SHAP 的特征重要性。阅读图表的方法如下:每个点是数据集中的一行/一个观察值。负 SHAP 值意味着特征值降低了目标预测值(销售时间)。蓝色表示特征值低，红色表示特征值高。当查看买入价格时，我们看到所有负 SHAP 值都是蓝色的，即低买入价格导致低卖出时间的预测。但是请注意，也有一些蓝点具有正 SHAP 值。在这种情况下，低买价导致相反的预测，即较长的销售时间。当要素相互交互时，可能会发生这种情况。有趣的是，销售渠道(拍卖类型)被很好地划分为红色的拍卖类型 1 和蓝色的拍卖类型 2。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="91d2" class="my lw it mu b gy mz na l nb nc"># Plot the overall Feature Importance using SHAP<br/>shap.initjs()<br/>explainer = shap.TreeExplainer(cat)<br/>shap_values = explainer.shap_values(pool_val)<br/>shap.summary_plot(shap_values, X_val)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/6b3c149d008c86f4be9c743fae731279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HvONIORHodpMCVfxiw0H4A.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Average selling price distributions per auction type</figcaption></figure><p id="8f6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们结束之前，让我们简要地看一下拍卖类型的购买价格。我们已经从特性的重要性中怀疑过这一点。两种拍卖类型的价格分布非常不同。拍卖类型 1 (ca。$6k)的价格比拍卖类型 2(大约 24k 美元)。</p><h1 id="ff37" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="a63a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">简单地进行 A/B 测试，看一种拍卖类型是否比另一种卖得快，可能会导致错误的结论。运行随机森林或任何其他机器学习算法，然后计算特征重要性，可以让您更好地了解哪些特征会影响您感兴趣的目标。我发现使用机器学习来补充 A/B 测试有助于我做出更好的决策。希望对你也有帮助。</p></div></div>    
</body>
</html>