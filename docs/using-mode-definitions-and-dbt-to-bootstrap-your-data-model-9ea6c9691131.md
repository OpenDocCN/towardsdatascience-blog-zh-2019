# 使用模式定义(和 dbt)来引导您的数据模型

> 原文：<https://towardsdatascience.com/using-mode-definitions-and-dbt-to-bootstrap-your-data-model-9ea6c9691131?source=collection_archive---------14----------------------->

![](img/7a5d10fb6f4a14c2baf88680f0d68aa5.png)

Penny model. Oh, if our network graphs were so simple.

在 Landed，我们跟踪各种产品在不同生命周期阶段的各种客户旅程。为了探索所有这些多样性，我们的团队依靠一系列分析仪表板来帮助他们预测我们的客户和合作伙伴的需求。我们的团队提出的问题会随着时间的推移而变化，这就需要一种灵活的、响应性强的实践来构建和更新数据模型。我们最近经历了一个升级数据基础设施的过程，并问自己“我们如何定义一个敏捷 sprint，让我们在几周内从原始数据到 BI 平台 MVP？”

我们知道我们正在寻找一个数据建模解决方案，它将提供版本控制、一个能够定义测试的阶段环境，以及一个良好的实践社区来支持和学习。货比三家之后，我们选定了两个可以很好地配合工作的工具，[模式分析](https://modeanalytics.com/)和鱼镇分析的数据构建工具( [dbt](https://www.getdbt.com/) )。Mode 是一个 SQL 驱动的 BI 平台，支持 R 和 Python，这意味着您可以用所有您喜欢的库(seaborn、matplotlib 等)来扩充它们的内部图表。).Dbt 是一种工具(或许也是一种心态？)允许您清理、反规范化、测试和预聚合您的数据。

这篇文章的目的是分享我们如何在 4 周的冲刺中，一起使用这两个工具来让我们的 BI 平台站稳脚跟。

下面是我们采取的一般方法:

*   步骤 1:确认定义和计算(准备)
*   步骤 2:创建基表(开发)
*   步骤 3:在 dbt 中记录和定义测试。yaml 文件(暂存)
*   步骤 4:使用 dbt 云(产品)调度构建
*   第五步:回馈开源社区(😄)
*   冲洗重复！(迭代)

## 步骤 1:确认定义和计算

遵循我的数据库前辈的明智建议，我创建了我们所有属性的目录，以及驱动我们现有报告和当前 OKR 指标的查询列表。在构建过程中，这个文档成了我的真实来源。一个简单的共享文档，团队可以在其中实时跟踪进度。

经过一段时间严格的财产定义和数据清理后，我很幸运地加入了 Landed，因此我们这个过程的起点是一个清晰和一致的地方。如果你正在构建一个不太清晰的模型，我鼓励你缩小项目规模，直到你得到少数几个每个人都同意的属性和计算(即使，起初，那只是`first_name`和`last_name`)。当您构建您的系统并在早期制图项目中取得一些成功时(“看，我们所有客户的名称列表！”)，这样会激励别人稳定逻辑，清理数据，这样才能在游戏中跳跃。

## 步骤 2:用模式定义创建基表

从我们的查询列表开始，我为每个团队创建了基础表。这些表格仅包括驱动报告所需的属性；精选的贵宾特写。我使用模式定义定义了这些基表，这些模式定义是可以在其他查询中引用的 select 语句(最多 10 层嵌套！).这些基表是迭代定义的——当我在 Mode 中编写每个查询时，我从我们的红移集群中添加了我需要的必要属性。

这些基表确保我们的用户永远不会直接查询我们的原始数据。即使我可以完全确保我们的用户没有能力改变原始数据(凭借我们与 Mode 的只读集成)，我们仍然希望为我们的分析服务的数据类型和计算有一个清晰的记录，这些基本表提供了这些记录。它们也是我们为每一列定义别名的地方，因为我们从 HubSpot 到 Redshift 的 ETL(我们使用 Stitch 来协调)拉入了我们的数据属性的内部名称，这些名称不同于我们的团队使用的字段名称。虽然我们的大多数团队成员不会直接探索我们的 SQL 查询，但规范术语总是一个好主意。

## 步骤 3:在 dbt 中记录表格。yaml 文件

这是我们旅程中 dbt 发挥作用的部分。老实说，一开始我并不完全清楚我们应该从在模式定义中定义模型切换到在 dbt 中设置测试并构建我们的物化视图。这部分是因为在你的模式报告中使用模式定义非常容易，而且我注意到当遇到将事情转移到 dbt 的困难时，会有一点惰性。当我想起 dbt 的测试覆盖工具时，我振作起来！

我们达成了一个内部的经验法则，那就是一旦我们在最初的计划中覆盖了 90%的查询，我们就开始从模式中转移东西，这是我们在大约三周内完成的。这个过程的这一部分包括为每个基表定义一个. yaml 文件，该文件包括对所有属性的简洁描述，以及测试定义，在 dbt 中有四种风格:`not_null`、`unique`、`relationships`和`accepted_values`。

这里有一个例子:

```
version: 2

models:
  - name: customer_id
    description: Unique customer identifier 
    columns:
      - name: uid
        tests:
          - not_null
          - unique

      - name: best_friend
        description: Customer's BFF
        tests:
          - relationships:
              to: ref('friends')
              field: uid

      - name: favorite_ice_cream_flavors
        description: Customer's favorite ice cream flavors
        tests:
          - not_null
          - accepted_values:
              values: ['cherry', 'chocolate']
```

值得注意的是，Mode 支持持久派生表(pdt ),它复制了 dbt 提供的物化视图功能。我被 dbt 活跃的开源社区和测试方法所吸引，但是如果您已经在为您的 BI 使用模式分析，您可能需要研究一下 pdt。

## 步骤 4:使用 dbt 云调度构建

这是我们现在所处的阶段。在我们的 ETL 集成之后安排我们的夜间 dbt 构建。因为我们每天晚上都从 CRM 中集成数据，所以我们安排 dbt 云作业在之后立即实现我们的基表视图。这一部分非常简单，因为至此所有构建和测试模型的艰苦工作都已完成。

有一点需要注意，如果你使用红移，你可能会想使用[后期绑定视图](https://aws.amazon.com/about-aws/whats-new/2017/09/amazon-redshift-now-supports-late-binding-views-referencing-amazon-redshift-and-redshift-spectrum-external-tables/)，这样你就不会在每夜构建中遇到任何阻碍。后期绑定视图在运行时绑定表，因此您可以删除一个绑定到另一个表的构建视图，而不会引发任何错误。当我们用 Stitch 设置 ETL 时，我遇到了这个问题，并切换到后期绑定，现在一切运行良好。

## 第五步:回馈开源社区

无论是为 [dbt](https://github.com/fishtown-analytics/dbt/issues) 挑选一期，还是写一篇关于你所构建的东西的博文，通过回馈社区来完成一个构建周期总是好的。与他人一起学习是工程的最大乐趣之一，支持推进该领域最佳实践的项目也是如此。找一张票，通过回购交几个朋友，提交一份 PR！

## 冲洗重复！

就是这样！现在是无尽的循环迭代:)

Siobhán 是[登陆](http://www.landed.com)的数据工程负责人。Landed 的使命是帮助重要的专业人士在他们服务的社区附近建立金融安全，当他们准备在昂贵的市场购买房屋时，我们会与教育工作者一起投资。听起来很棒？[加入我们](https://landed.com/jobs)！