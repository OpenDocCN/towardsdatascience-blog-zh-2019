<html>
<head>
<title>Can we stop with the SQL JOINs venn diagrams insanity?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们能不能不要再说 SQL JOINs venn diagrams 了？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/can-we-stop-with-the-sql-joins-venn-diagrams-insanity-16791d9250c3?source=collection_archive---------8-----------------------#2019-02-28">https://towardsdatascience.com/can-we-stop-with-the-sql-joins-venn-diagrams-insanity-16791d9250c3?source=collection_archive---------8-----------------------#2019-02-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="d613" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">真的，求求你，OMG，停</em></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi kp"><img src="../Images/632afdf9de42c60a33833aab773b6de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*V9VTdxrZtr3qaXKaf71smg.png"/></div></figure><p id="70ad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">烦躁时间。这些年来，我不得不多次向非技术人员教授 SQL，每个试图学习 SQL 但失败的人都谈到“连接是多么困难和可怕”。如果你在网上搜索 SQL 连接的解释，是的，它看起来很疯狂。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi kx"><img src="../Images/09d0f2a21f458e205f4b8f4fc2a0bfa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nxQzU8b3qlgQCcUU5USTpw.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Look at this, just LOOK at it!</figcaption></figure><p id="8cb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">真正让我困惑的是，连接和集合论的整个混合甚至没有意义。一旦你的解释必须在看似任意的地方包含“其中 A 为空”,人们会认为你必须记住任意的咒语才能让事情正常进行——这听起来确实很难！</p><p id="833f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">啊，谁来让这停下来！</p><h2 id="69be" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">旁注:关系代数</h2><p id="3574" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">是的，我知道 SQL 源于关系代数，而不是集合论。实际上，我向人们解释事情的方式产生了类似的结果，但显然是从笛卡尔开始并向下过滤的正式方式向后倒退了一些。</p><p id="d999" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我没有正式的关系代数背景，所以不要让我无药可救，欢迎你查看关于这个话题的<a class="ae me" href="https://en.wikipedia.org/wiki/Relational_algebra#Joins_and_join-like_operators" rel="noopener ugc nofollow" target="_blank"/><a class="ae me" href="http://www.databasteknik.se/webbkursen/relalg-lecture/index.html" rel="noopener ugc nofollow" target="_blank">其他</a> <a class="ae me" href="http://www.cs.cornell.edu/projects/btr/bioinformaticsschool/slides/gehrke.pdf" rel="noopener ugc nofollow" target="_blank">来源</a>。</p><h2 id="daa4" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">我是如何向人们传授联结的</h2><p id="ea21" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">我用一步一步的伪算法来解释 SQL 引擎如何产生连接的数据集，因为我觉得它可以让你掌握一些用连接可以做的更疯狂的事情。</p><p id="eaee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用于生成和测试这些查询的 PostgreSQL 兼容 SQL 位于末尾</p><p id="41ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设我们有两张表，A 和 B:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/375ef3c04fb7c5e794d4ca4944ad1adb.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*B6MTLxoEzvv0aq98LRI-yw.png"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Data about <a class="ae me" href="https://www.inverse.com/article/30488-godzilla-every-city-kaiju-attack-tokyo-new-york-ghidora-king-kong" rel="noopener ugc nofollow" target="_blank">cities godzilla attacks adapted from here</a></figcaption></figure><p id="4c35" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">假设我们想任意连接 A 和 B 以得到“表 A 中的城市名称和 B 中的哥斯拉攻击”。(是的，这些表格有很多数据问题。为了简单起见，我没有考虑 id 和规范化，所以我必须使用 City_name 作为连接键。但所有这些在教授联接如何工作时都无关紧要，所以我忽略了它。)</p><p id="f50b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在这里的目标是教那些只看了 15 分钟 SQL 语法的人如何准确地预测一个连接将产生一致的结果。</p><h2 id="49f8" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">概念连接算法</h2><p id="79b7" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">对于一般查询:</p><pre class="kq kr ks kt gt mg mh mi mj aw mk bi"><span id="f81f" class="lg lh it mh b gy ml mm l mn mo">Select _<em class="ko">fields_</em><br/>FROM A<br/>JOIN B ON on_<em class="ko">conditions<br/></em>WHERE <em class="ko">where_conditions</em></span></pre><p id="a19d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我使用了“<em class="ko">工作集</em>的概念，符合连接条件的行被名义上存储起来，以便以后根据 where 条件进行检查。</p><ol class=""><li id="b73d" class="mp mq it js b jt ju jx jy kb mr kf ms kj mt kn mu mv mw mx bi translated">对于 A 中的每一行，逐一与 B 中的每一行进行比较</li><li id="a535" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">检查<em class="ko"> on_conditions <br/> — </em>如果<em class="ko"> on_conditions </em>为真，则将 A 中的行连接到 B 中的行，并将连接的 A+B 行放入<em class="ko">工作集<br/> — </em>如果<em class="ko"> on_conditions </em>为假，则继续比较下一对行</li><li id="5b81" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">对于左/右/外连接<br/> —对于左连接:如果对于 A 中的一行，没有条目被放置在<em class="ko">工作集</em>中，尽管检查了 B 中的每一行，然后将 A 中的该行放置在<em class="ko">工作集</em>中，在应该具有来自 B 的数据的字段中使用空值<br/> —对于右连接:类似于左连接，但是对于 B， 如果在与 A 的所有行进行比较后，B 中的某一行在<em class="ko">工作集</em>中没有条目，则将 B 中的行插入到<em class="ko">工作集</em>中，在应该有来自 A 的数据的地方使用空值</li><li id="4997" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">检查完所有行组合后，从<em class="ko">工作集</em>中取出任何内容，并使用<em class="ko"> where_conditions </em>对其进行过滤</li><li id="05aa" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">根据需要应用任何 GROUP BY、ORDER BY、HAVING 子句</li><li id="95dc" class="mp mq it js b jt my jx mz kb na kf nb kj nc kn mu mv mw mx bi translated">获得结果集，就大功告成了</li></ol><h2 id="fe1d" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">这听起来仍然很难！</h2><p id="b1cc" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">言语艰难。</p><p id="770c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">动画更容易，所以我用 Excel 和 Photoshop 给你们做了一些。如果你想借，请随意。</p><h2 id="1c65" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">警告:这不是 SQL 引擎的实际工作方式！</h2><p id="b364" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">我在这里掩盖了一大堆东西，索引，NoSQL 的怪癖(比如如果你在 Hive 上，只能进行等价连接)，为了不浪费内存和时间而进行的许多优化。</p><p id="0fac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">没关系，一个初学者不应该关心这些东西，最终结果匹配。</p><h2 id="f167" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">内部连接</h2><pre class="kq kr ks kt gt mg mh mi mj aw mk bi"><span id="9c65" class="lg lh it mh b gy ml mm l mn mo">SELECT A.City_name, Godzilla_attacks<br/>from A<br/>JOIN B on A.City_name = B.City_name</span></pre><p id="5249" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个很简单——遍历两个表，当名称匹配时，插入到工作集。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nd"><img src="../Images/7e362f9307b4ad73c6c6c848dabef441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*RB2srXMCJCycs2DFjpf4KA.gif"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">A simple INNER JOIN</figcaption></figure><h2 id="8cb0" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">左连接</h2><pre class="kq kr ks kt gt mg mh mi mj aw mk bi"><span id="148f" class="lg lh it mh b gy ml mm l mn mo">SELECT A.City_name, Godzilla_attacks <br/>from A LEFT <br/>JOIN B on A.City_name = B.City_name</span></pre><p id="fb54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">也很简单，遍历所有的行，发现末尾的上海在 B 中没有可连接的条目，用一个空值添加它。然后，您可以在 WHERE 子句中过滤掉工作集<em class="ko">中的空值。</em></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ne"><img src="../Images/c5b94bd31eb4f6ab0397b68da47aed59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4mSEMkEfkHGDwD-1mvQzeg.gif"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">A simple LEFT JOIN</figcaption></figure><h2 id="eca0" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">疯狂加入</h2><pre class="kq kr ks kt gt mg mh mi mj aw mk bi"><span id="3f14" class="lg lh it mh b gy ml mm l mn mo">SELECT A.City_name, B.City_name, Godzilla_attacks <br/>from A <br/>LEFT JOIN B <br/>  on (A.Country = ‘USA’ and B.Godzilla_attacks = 2) <br/>  OR B.Godzilla_attacks = 13</span></pre><p id="bc93" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">这个查询毫无意义。故意的</strong>。如果你能在脑子里想象这个东西的行为，你就基本上掌握了连接的概念。</p><p id="964b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只要 ON 条件的值为 true，连接就是有效的，这完全是滥用了这一事实。您可以以极其强大的方式滥用这一点，使用诸如<em class="ko"> case </em>语句、算术和其他复杂的逻辑。这就是为什么自连接是完全自然的，以及如何可以轻松地构建直方图。左连接并不重要，因为 A 中的所有行都可以找到一些连接对象。</p><p id="763f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">引擎不关心，它只看到逻辑符号，如果为真则加入。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi nf"><img src="../Images/ae115e5b8eca9b340ef4c4926c7b5d66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*EyWuctYrFCEAyabvqzoNow.gif"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">A “Go home you’re drunk” JOIN</figcaption></figure><h2 id="7f22" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">最后</h2><p id="c522" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">希望有人，在某个地方，用这个从维恩图中被拯救出来。如果只有一个人得救，并学会了如何更好地加入，我很高兴。</p><p id="cfd6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">前进，写一些疯狂的条款。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h2 id="6a38" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">谢谢</h2><p id="1cf3" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">这篇文章的灵感来自于某个人提醒我我有多讨厌这个:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nn no l"/></div></figure><h2 id="478b" class="lg lh it bd li lj lk dn ll lm ln dp lo kb lp lq lr kf ls lt lu kj lv lw lx ly bi translated">密码</h2><p id="b7bb" class="pw-post-body-paragraph jq jr it js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn im bi translated">示例 DDL 和<a class="ae me" href="https://www.db-fiddle.com/f/kwBLvL8WUSbxvjSprJg5ce/0" rel="noopener ugc nofollow" target="_blank"> DB-fiddle </a>中的“疯狂”查询。</p><pre class="kq kr ks kt gt mg mh mi mj aw mk bi"><span id="42ec" class="lg lh it mh b gy ml mm l mn mo">create table A (City_name varchar, Country varchar);<br/>insert into A (City_name, Country) values<br/>(‘Tokyo’,’Japan’),<br/>(‘New York’,’USA’),<br/>(‘Fukuoka’,’Japan’),<br/>(‘Shanghai’,’China’)<br/>;<br/>create table B (City_name varchar, Godzilla_attacks int);<br/>insert into B (City_name, Godzilla_attacks)<br/>values<br/>(‘Fukuoka’,3),<br/>(‘Nagoya’,2),<br/>(‘New York’,3),<br/>(‘Tokai’,3),<br/>(‘Tokyo’,13),<br/>(‘Yokohama’,2)<br/>;</span></pre></div></div>    
</body>
</html>