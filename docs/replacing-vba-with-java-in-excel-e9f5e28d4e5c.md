# 在 Excel 中用 Java 替换 VBA

> 原文：<https://towardsdatascience.com/replacing-vba-with-java-in-excel-e9f5e28d4e5c?source=collection_archive---------2----------------------->

![](img/88de043c00a19acf644f5f277b7d32ed.png)

几乎每个工作场所都有 Excel。从顶级投资公司和大规模工程公司到个体商人，人们都使用 Excel 完成工作。

本文将探讨使用 Excel 的一些问题*和*优势，以及如何使用嵌入 Excel 的[Java](https://exceljava.com?utm_source=medium.com)来克服这些问题。

你不用找很远就能找到对 Excel 的批评和它的错误使用导致公司重大损失的案例。在过去的几年里，有许多案例表明，Excel 电子表格中的错误至少是令人尴尬且代价高昂的错误的部分原因。

[](https://www.theregister.co.uk/2003/06/19/excel_snafu_costs_firm_24m/) [## Excel 混乱让公司损失了 2400 万美元

### 一个简单的电子表格错误让一家公司损失了 2400 万美元。这个错误导致了加拿大大型电力公司 TransAlta

www.theregister.co.uk](https://www.theregister.co.uk/2003/06/19/excel_snafu_costs_firm_24m/) [](https://www.businessinsider.com/excel-partly-to-blame-for-trading-loss-2013-2?r=US&IR=T) [## 伦敦鲸的崩溃部分是由于使用 Excel 时的一个错误

### 这是人们开始在博客圈谈论的事情，应该让整个华尔街暂停下来。结束…

www.businessinsider.com](https://www.businessinsider.com/excel-partly-to-blame-for-trading-loss-2013-2?r=US&IR=T) 

有这样的风险，为什么公司还在用 Excel，有什么办法可以防止类似的情况发生？

Excel 被如此大量使用的主要原因是 ***工人生产率*** 。使用 Excel 的人可以比使用任何其他工具更有效地完成大量复杂的工作。

软件开发人员经常争辩说，用他们最喜欢的编程语言也能达到同样的效果。从技术上讲，他们可能是正确的，但这是假设每个人都有时间和兴趣学习成为一名开发人员(这需要我们大多数人很多很多年)。

大多数公司没有资源让开发人员专门为每个业务用户服务，即使他们有，那么沟通需要什么和迭代以获得期望的结果将很难与个人“拼凑”Excel 电子表格相竞争。

## Excel 的问题

Excel 有什么地方容易出错？这本身没有什么，但是开发人员已经习惯了各种事情来减少非 Excel 解决方案中的风险。下面列出了 Excel 电子表格开发中的一些缺点。

*   **太复杂**。一个电子表格可能开始时相当简单，只有几个单元格和公式。然后它一点一点地成长。范围被复制以处理越来越多的情况或多组数据，直到很难理解发生了什么。这项任务可能仍然相当简单，但是由于需要复制，而且每个单元格只能容纳一个数据单元，电子表格可能会变得过于复杂。
*   **最少或无测试**。Excel 电子表格很少受到测试。通常没有为 VBA 代码编写的单元测试，唯一的功能测试通常由电子表格的作者在有限的输入集上进行。当另一个用户不得不使用同一个电子表格时，很有可能因为他们不熟悉其工作原理的细微差别，他们会偶然发现一些从未测试过的错误。
*   **陈旧或过时的数据**。将 Excel 连接到外部数据源可能很棘手。它可以直接连接到数据库，但是如果您需要的数据是由另一个系统产生的，或者您没有直接访问所需数据的数据库，该怎么办？数据经常从其他系统的报告中复制并粘贴到 Excel 中，通常无法知道数据上次是何时复制的，甚至无法知道数据是否完整。
*   **虫子失控蔓延**。即使您知道一个电子表格中有错误，并且您已经知道如何修复它，您如何找到复制并粘贴了相同 VBA 代码的其他电子表格的所有实例，或者甚至是完全相同的电子表格的副本？很可能你不能。电子表格被复制并通过电子邮件发送，电子表格、数据和代码之间没有分离。
*   **版本控制地狱**。当你正在处理一个大的电子表格，并且它已经稳定运行了，你会怎么做？最有可能的答案是你保存一份拷贝——也许在文件名上加上日期。这就是 Excel 中的版本控制。如果一个变化有意想不到的后果呢？你怎么知道这个变化是什么时候引入的？几乎不可能！

## 我们如何解决这些问题？

这些问题都源于采用表面上很简单的东西(相关数字的网格)，并将其推到极难推理其行为和正确性的程度。

本质上，Excel 是一种表达事物之间关系的方式。 *A1* 是 *B1* 和 *C1 之和，例如**。当这些关系变得越来越复杂时，问题就开始出现了。*

如果你想计算“ *A1* 是时间序列的每日收益的方差 *X* ”，在 Excel 中会是什么样子？如果您是一位经验丰富的 Excel 用户，您可能会想象一个表示时间序列 B 的表，其中包含用于计算回报的额外列和用于计算方差的公式。但是，如果现在我们想计算另一个 *N* 时间序列的回报呢？复制并粘贴每个新时间序列的公式？这就是错误开始蔓延的原因！

更好的方法是将计算时间序列日收益方差的算法封装到一个函数中。然后我们可以重复调用这个函数，次数不限，不会有中间单元格被编辑或复制错误的风险。

现在，设想用 Excel 中的单个单元格来表示时间序列，而不是数据表。如果这可以实现，那么我们又回到了两个单元之间的简单关系—“*A1 = daily _ returns _ variance _ of(B1)*”。突然间，我们的电子表格开始看起来不那么复杂了！

我们仍然有时间序列数据必须来自某处的问题。与其从另一个系统或数据库复制粘贴，不如我们有一个函数直接从那个系统或数据库加载时间序列？这样，每次我们计算电子表格时，我们都知道数据是最新的和完整的！继续前面的例子，我们可能有“ *B1 =负载时间系列(股票，开始日期，结束日期)*”。稍后，我们将讨论如何在单个单元格中存储整个数据集。

通常不仅仅是使用 Excel 的人编写他们使用的函数。通过为最终用户提供一组可靠的 Excel 函数，技术团队可以比仅仅编写仅具有浅层 Excel 集成的应用程序(如导出报告)更有效地支持业务。

## Java 对我们有什么帮助？

通过思考我们的电子表格，将算法放入函数中，并通过直接获取数据而不是复制和粘贴，我们已经解决了 Excel 电子表格的几个大问题。我们还没有触及如何编写这些函数，以及围绕测试、错误修复和版本控制的问题。

如果我们决定在 VBA 编写我们所有的函数(相信我，很多人都这么做！)那么我们就不能利用过去 20 年中软件开发的任何进步！

Java 与现代软件开发并驾齐驱，在 VBA 上有很大贡献。

*   **测试**。Java 有许多不同的测试框架，都有不同的优点和缺点。无论您选择哪一种，能够在您的代码库上运行自动化测试套件都会让您确信它在做正确的事情。这在 VBA 是不可能的。
*   **广泛的库支持。编写 VBA 代码通常是编写网上找到的相当标准的算法，并把它们转换成 VBA。想做一些琐碎的事情，比如对一组数据进行排序？在 Java 中这不成问题，但在 VBA，你要负责确保你的排序算法有效，并且不需要任何测试。现在想象一下写一个复杂的衍生品定价模型！**
*   将代码放在 Excel 之外。 VBA 代码通常保存在工作簿中，这就是为什么在共享工作簿时，错误变得如此难以追踪。如果您的电子表格引用了一个编译过的 Java 库(JAR ),那么它就在所有引用它的电子表格之外，可以很容易地更新。
*   **版本控制。** Java 源代码只是文本，因此很容易被签入版本控制系统。大多数 Java IDEs 对此有很好的支持，因为这是现代软件开发的标准部分。
*   **发展环境。**VBA 编辑器(VBE)已经很多年没变了。它只提供了一个非常基本的文本编辑器，具有基本的调试功能。另一方面，Java 有一系列优秀的 ide 可供选择。

## 但是 Java 不是 Excel 的一部分！

的确如此，但是 Excel 有一个“加载项”的概念，允许开发人员扩展 Excel 的功能。一个这样的插件是 [Jinx，Excel Java 插件](https://exceljava.com?utm_source=medium.com)。

使用 [Jinx](https://exceljava.com?utm_source=medium.com) ，你可以完全抛弃 VBA，完全用 Java 编写工作表函数、宏和菜单。

用 Java 编写工作表函数就像在 Java 方法中添加 Jinx 的@ExcelFunction 注释一样简单:

```
**package** **com.mycompany.xladdin**;

**import** **com.exceljava.jinx.ExcelFunction**;

*/***
 ** A simple Excel function.*
 **/*
**public** **class** **ExcelFunctions** {
    */****
 ** Multiply two numbers and return the result.*
 **/*
    **@ExcelFunction**
    **public** **static** double multiply(double x, double y) {
        **return** x * y;
    }
}
```

您可以返回您期望的所有基本类型，以及 1d 和 2d 数组。对于更复杂的类型，您可以编写自己的类型转换器，或者您可以将 Java 对象作为对象句柄直接返回给 Excel，以便传递给另一个 Java 方法。

jinx[免费下载](https://exceljava.com/download.html)。参见 [Jinx 用户指南](https://exceljava.com/docs/)了解更多关于如何用 Java 替代 VBA 的信息。

## 将时间序列作为单个单元格返回是怎么回事？

Jinx 函数可以返回所有你期望的标准类型(整型、双精度型、数组等。)，但是也可以返回 Java 对象！当一个复杂的 Java 对象(比如一个表示从数据库加载的时间序列的类)被返回时，它将作为一个对象句柄返回到 Excel。然后，可以将该对象句柄传递给其他 Jinx 函数，并将从第一个函数返回的原始 Java 对象传递给 Java 方法。

对于简化电子表格来说，这是一种非常有用的技术，可以避免电子表格中涉及到复杂的数据。需要时，可以使用 Jinx 数组函数将对象扩展为 Excel 数组。

您可以在用户指南的 [Jinx 对象缓存](https://exceljava.com/docs/udfs.html#cached-objects)部分了解更多关于这些对象句柄的信息。

## 其他语言

这些技术不是 Java 独有的。

其他 JVM 语言也是如此，比如 Scala T1 或 T2 kot Lin T3。Jinx 适用于所有 JVM 语言，不仅仅是 Java。

另一种编写 Excel 插件的流行语言是 Python。这可以通过使用 Excel 的 [PyXLL 插件来实现。](https://www.pyxll.com?utm_source=medium.com)