<html>
<head>
<title>Setup MLflow in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在生产中设置 MLflow</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/setup-mlflow-in-production-d72aecde7fef?source=collection_archive---------3-----------------------#2019-11-04">https://towardsdatascience.com/setup-mlflow-in-production-d72aecde7fef?source=collection_archive---------3-----------------------#2019-11-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1d5a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Postgres DB 存储元数据和 systemd 单元保持 MLflow 运行的分步指南。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b3b4593ca9a7ec19626adced49c04532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xq385dWU0Nd305g6MOKwDQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Source: <a class="ae ky" href="https://mlflow.org" rel="noopener ugc nofollow" target="_blank">https://mlflow.org</a></figcaption></figure><p id="f564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我的 MLflow 教程系列的第一篇文章:</p><ol class=""><li id="7123" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@gyani91/setup-mlflow-in-production-d72aecde7fef" rel="noopener">在生产中设置 ml flow</a>(你在这里！)</li><li id="1cc6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@gyani91/mlflow-basic-logging-functions-e16cdea047b" rel="noopener"> MLflow:基本测井功能</a></li><li id="85ef" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@gyani91/mlflow-logging-for-tensorflow-37b6a6a53e3c" rel="noopener">张量流的 MLflow 测井</a></li><li id="5f54" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@gyani91/mlflow-projects-24c41b00854" rel="noopener"> MLflow 项目</a></li><li id="c9a7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@gyani91/retrieving-the-best-model-using-python-api-for-mlflow-7f76bf503692" rel="noopener">使用 Python API 为 MLflow 检索最佳模型</a></li><li id="c192" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/@gyani91/serving-a-model-using-mlflow-8ba5db0a26c0" rel="noopener">使用 MLflow 服务模型</a></li></ol><p id="db79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">MLflow 是一个用于机器学习生命周期管理的开源平台。最近，我在产品中设置了 MLflow，使用 Postgres 数据库作为跟踪服务器，使用 SFTP 通过网络传输工件。我花了大约 2 周的时间才把所有的组件都弄好，但是这篇文章可以帮助你在 10 分钟内把 MLflow 安装到生产环境中。</p><h1 id="0d27" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">要求</h1><ul class=""><li id="5d74" class="lv lw it lb b lc nb lf nc li nd lm ne lq nf lu ng mb mc md bi translated"><a class="ae ky" href="https://www.anaconda.com/distribution/" rel="noopener ugc nofollow" target="_blank">蟒蛇</a></li></ul><h1 id="a53f" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">跟踪服务器设置(远程服务器)</h1><p id="adc3" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">跟踪服务器存储您在 MLflow 用户界面中看到的元数据。首先，让我们创建一个新的 Conda 环境:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="184b" class="np mk it nl b gy nq nr l ns nt">conda create -n mlflow_env<br/>conda activate mlflow_env</span></pre><p id="32b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装 MLflow 和 PySFTP 库:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="4cb9" class="np mk it nl b gy nq nr l ns nt">conda install python<br/>pip install mlflow<br/>pip install pysftp</span></pre><p id="7c00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的跟踪服务器使用 Postgres 数据库作为存储元数据的后端。所以让我们安装 PostgreSQL:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="9863" class="np mk it nl b gy nq nr l ns nt">apt-get install postgresql postgresql-contrib postgresql-server-dev-all</span></pre><p id="5097" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将为跟踪服务器创建管理员用户和数据库</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="1317" class="np mk it nl b gy nq nr l ns nt">sudo -u postgres psql</span></pre><p id="ca60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 psql 控制台中:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="7bb0" class="np mk it nl b gy nq nr l ns nt">CREATE DATABASE mlflow_db;<br/>CREATE USER mlflow_user WITH ENCRYPTED PASSWORD 'mlflow';<br/>GRANT ALL PRIVILEGES ON DATABASE mlflow_db TO mlflow_user;</span></pre><p id="0c0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们需要与 Python 中的 Postgres 进行交互，所以需要安装 psycopg2 库。但是，为了确保成功安装，我们需要在以下操作之前安装 GCC Linux 软件包:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="6bbc" class="np mk it nl b gy nq nr l ns nt">sudo apt install gcc<br/>pip install psycopg2-binary</span></pre><p id="e72e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望远程连接到 PostgreSQL 服务器，或者希望将其访问权授予用户。你可以</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="7883" class="np mk it nl b gy nq nr l ns nt">cd /var/lib/pgsql/data</span></pre><p id="942a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在<strong class="lb iu"> postgresql.conf </strong>文件的末尾添加下面一行。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="4c81" class="np mk it nl b gy nq nr l ns nt">listen_addresses = '*'</span></pre><p id="0720" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以通过在<strong class="lb iu"> pg_hba.conf </strong>文件的末尾添加以下行来指定您希望允许连接到 PostgreSQL 服务器的远程 IP</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="e749" class="np mk it nl b gy nq nr l ns nt">host    all    all    10.10.10.187/32    trust</span></pre><p id="713b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其中<strong class="lb iu"> 10.10.10.187/32 </strong>为远程 IP。要允许来自任何 IP 的连接，请使用<strong class="lb iu"> 0.0.0.0/0 </strong>来代替。然后重新启动 PostgreSQL 服务器以应用更改。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="0c3f" class="np mk it nl b gy nq nr l ns nt">service postgresql restart</span></pre><p id="7aa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是为我们的跟踪服务器创建一个目录，以记录机器学习模型和其他工件。请记住，Postgres 数据库仅用于存储关于这些模型的元数据。这个目录叫做神器 URI。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="5c0c" class="np mk it nl b gy nq nr l ns nt">mkdir ~/mlflow/mlruns</span></pre><p id="4862" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建日志目录。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="427f" class="np mk it nl b gy nq nr l ns nt">mkdir ~/mlflow/mllogs</span></pre><p id="ec4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用以下命令运行跟踪服务器。但是一旦你按 Ctrl-C 或者退出终端，服务器就会停止。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="3b0b" class="np mk it nl b gy nq nr l ns nt">mlflow server --backend-store-uri postgresql://mlflow_user:mlflow@localhost/mlflow_db --default-artifact-root sftp://mlflow_user@<strong class="nl iu">&lt;hostname_of_server&gt;</strong>:~/mlflow/mlruns -h 0.0.0.0 -p 8000</span></pre><p id="c48d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望跟踪服务器在重新启动后启动并运行，并且对故障具有弹性，那么将它作为 systemd 服务运行是非常有用的。</p><p id="276e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要进入<strong class="lb iu"> /etc/systemd/system </strong>目录，创建一个名为<strong class="lb iu"> mlflow-tracking.service </strong>的新文件，内容如下:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="2a7f" class="np mk it nl b gy nq nr l ns nt">[Unit]<br/>Description=MLflow Tracking Server<br/>After=network.target</span><span id="3245" class="np mk it nl b gy nu nr l ns nt">[Service]<br/>Restart=on-failure<br/>RestartSec=30<br/>StandardOutput=file:/path_to_your_logging_folder/stdout.log<br/>StandardError=file:/path_to_your_logging_folder/stderr.log<br/>User=root<br/>ExecStart=/bin/bash -c 'PATH=/path_to_your_conda_installation/envs/mlflow_env/bin/:$PATH exec mlflow server --backend-store-uri postgresql://mlflow_user:mlflow@localhost/mlflow_db --default-artifact-root sftp://mlflow_user@<strong class="nl iu">&lt;hostname_of_server&gt;</strong>:~/mlflow/mlruns -h 0.0.0.0 -p 8000'</span><span id="0e14" class="np mk it nl b gy nu nr l ns nt">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="1a7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令激活并启用上述服务:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="e241" class="np mk it nl b gy nq nr l ns nt">sudo systemctl daemon-reload<br/>sudo systemctl enable mlflow-tracking<br/>sudo systemctl start mlflow-tracking</span></pre><p id="af2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令检查是否一切正常:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="60cf" class="np mk it nl b gy nq nr l ns nt">sudo systemctl status mlflow-tracking</span></pre><p id="0e66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会看到类似如下的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/65d7f82b02378fa49eb8d848d6997633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uIoxkhtVhfVPBH2imPzDcg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Systemd unit running</figcaption></figure><p id="29a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为名为<em class="nw"> mlflow_user </em>的服务器创建用户，并将 mlflow 目录作为该用户的工作目录。然后在<strong class="lb iu">中创建一个 ssh-key 对。<em class="nw">ml flow _ user</em>(<strong class="lb iu">/ml flow/)的 ssh </strong>目录。在我们的例子中是 ssh </strong>)。将公钥放在<strong class="lb iu"> authorized_keys </strong>文件中，与用户共享私钥。</p><p id="0ef9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，为了让 MLflow UI 能够读取工件，将私钥复制到<strong class="lb iu"> /root/。宋承宪/ </strong>也是。</p><p id="aa69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要使用以下命令为服务器手动创建主机密钥:</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="11e7" class="np mk it nl b gy nq nr l ns nt">cd /root/.ssh<br/>ssh-keyscan -H <strong class="nl iu">&lt;hostname_of_server&gt;</strong> &gt;&gt; known_hosts</span></pre><p id="619d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以重新启动计算机，MLflow Tracking Server 将在重新启动后启动并运行。</p><h1 id="06d3" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">在客户端机器上(本地)</h1><p id="146e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">为了开始跟踪生产跟踪服务器下的一切，有必要在您的<strong class="lb iu">中设置以下环境变量。bashrc </strong>。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="7260" class="np mk it nl b gy nq nr l ns nt">export MLFLOW_TRACKING_URI='http://<strong class="nl iu">&lt;hostname_of_server&gt;</strong>:8000'</span></pre><p id="9206" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要忘记为您的<strong class="lb iu">寻找来源。bashrc </strong>文件！</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="da50" class="np mk it nl b gy nq nr l ns nt">. ~/.bashrc</span></pre><p id="c8ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保在您的环境中为<strong class="lb iu"> mlflow </strong>和<strong class="lb iu"> pysftp </strong>安装 pip 包(需要<strong class="lb iu"> pysftp </strong>来促进工件到生产服务器的传输)。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="59d7" class="np mk it nl b gy nq nr l ns nt">pip install mlflow<br/>pip install pysftp</span></pre><p id="ec33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了能够认证<strong class="lb iu"> pysftp </strong>传输，将生产服务器上生成的私钥放在<strong class="lb iu">中。本地机器的 ssh </strong>目录。那就做吧</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="f3bd" class="np mk it nl b gy nq nr l ns nt">ssh <strong class="nl iu">&lt;hostname_of_server&gt;</strong></span></pre><p id="6bda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当提示将<strong class="lb iu">&lt;hostname _ of _ server&gt;</strong>保存为已知主机时，回答<strong class="lb iu"> yes </strong>。</p><p id="7286" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在<a class="ae ky" href="http://nmkzh-testing-001.nomoko.lan:7000" rel="noopener ugc nofollow" target="_blank">http://<strong class="lb iu">&lt;hostname _ of _ server&gt;</strong>:8000</a>访问<strong class="lb iu"> MLflow UI </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/b7a4009760978ad7e0b7259d3d07baa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NLTQMuK-zyGP2t_najh9lQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The Mlflow UI</figcaption></figure><p id="1b19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从互联网上运行一个样本机器学习模型，以检查 MLflow 是否可以跟踪运行。</p><pre class="kj kk kl km gt nk nl nm nn aw no bi"><span id="8fbc" class="np mk it nl b gy nq nr l ns nt">mlflow run git@github.com:databricks/mlflow-example.git -P alpha=0.5</span></pre><p id="1086" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一篇文章中，我将讲述基本的 MLflow 日志记录功能</p><h1 id="b673" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">参考资料:</h1><p id="b613" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">[1]物流，<a class="ae ky" href="https://www.mlflow.org/docs/latest/quickstart.html#installing-mlflow" rel="noopener ugc nofollow" target="_blank">安装物流</a> (2019)，物流文件</p></div></div>    
</body>
</html>