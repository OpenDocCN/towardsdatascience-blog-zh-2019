<html>
<head>
<title>Hosting a Scikit-Learn Nearest Neighbors model in AWS SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 AWS SageMaker 中托管 Scikit-Learn 最近邻模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hosting-an-scikit-learn-nearest-neighbors-model-in-aws-sagemaker-40be982da703?source=collection_archive---------12-----------------------#2019-07-06">https://towardsdatascience.com/hosting-an-scikit-learn-nearest-neighbors-model-in-aws-sagemaker-40be982da703?source=collection_archive---------12-----------------------#2019-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="3b24" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了一系列内置算法，AWS SageMaker 还提供了训练和托管 Scikit-Learn 模型的能力。在本帖中，我们将展示如何在 SageMaker 中训练和托管 Scikit-Learn 最近邻模型。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/1aed18e22b81b05fa17d6ce027da6ff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i4nDKoxkDx0B4bfJb2PVAg.png"/></div></div></figure><p id="098d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的用例将是本文中<a class="ae la" rel="noopener" target="_blank" href="/robosomm-chapter-3-wine-embeddings-and-a-wine-recommender-9fc678f1041e">描述的葡萄酒推荐模型。在本练习中，我们将假设葡萄酒推荐器的输入数据已经准备就绪:一组 180，000 个 300 维向量，每个向量描述一种特定葡萄酒的风味特征。根据前面提到的文章，我们将这些向量称为 wine 嵌入。我们的目标是有一个模型，可以返回与给定输入向量最相似的葡萄酒嵌入。</a></p><p id="7d4f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如官方<a class="ae la" href="https://sagemaker.readthedocs.io/en/stable/using_sklearn.html" rel="noopener ugc nofollow" target="_blank">文件</a>所述，我们将在整个过程中处理两个主要步骤:</p><ol class=""><li id="b3f6" class="lb lc it js b jt ju jx jy kb ld kf le kj lf kn lg lh li lj bi translated">准备一个 Scikit-Learn 脚本在 SageMaker 上运行</li><li id="693c" class="lb lc it js b jt lk jx ll kb lm kf ln kj lo kn lg lh li lj bi translated">通过 Scikit-Learn 估算器在 SageMaker 上运行这个脚本</li></ol><p id="b0c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">准备在 SageMaker 上运行的 Scikit-Learn 脚本</strong></p><p id="ba3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们的 Scikit-Learn 脚本中，我们将从我们的输入通道(S3 桶和我们完全准备好的葡萄酒嵌入集)加载数据，并配置我们将如何训练我们的模型。模型的输出位置也在这里指定。这一功能已被置于主要保护之下。</p><p id="54a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还将安装 s3fs，这是一个允许我们与 S3 交互的包。这个包使我们能够识别特定的 S3 目录(输入数据、输出数据、模型),以便脚本与之交互。另一种方法是使用特定于 SageMaker 的环境变量，这些变量指定要与之交互的标准 S3 目录。为了说明这两个选项，我们将使用环境变量 SM_MODEL_DIR 来存储模型，以及输入和输出数据的特定目录地址。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="cee3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到目前为止一切顺利！通常，我们可以在 SageMaker 上运行这个脚本，首先训练模型，然后通过调用“predict”方法返回预测。然而，我们的 Scikit-Learn 最近邻模型没有“预测”方法。实际上，我们的模型正在计算各种葡萄酒嵌入之间的余弦距离。对于任何给定的输入向量，它将返回最接近该点的葡萄酒嵌入。这与其说是一种预测，不如说是一种计算哪些点彼此距离最近的方法。</p><p id="6063" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">幸运的是,“模型服务”功能允许我们配置 Scikit-Learn 脚本来实现这种类型的定制。模型服务由三个功能组成:</p><p id="3d4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">i) <strong class="js iu"> input_fn </strong>:这个函数将输入数据反序列化为一个对象，该对象被传递给 prediction_fn 函数</p><p id="3066" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ii) <strong class="js iu"> predict_fn </strong>:该函数获取 input_fn 函数的输出，并将其传递给加载的模型</p><p id="8028" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">iii) <strong class="js iu"> output_fn </strong>:该函数获取 predict_fn 的结果并将其序列化</p><p id="8b35" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些函数中的每一个都有一个运行的<a class="ae la" href="https://github.com/aws/sagemaker-scikit-learn-container/blob/master/src/sagemaker_sklearn_container/serving.py" rel="noopener ugc nofollow" target="_blank">默认实现</a>，除非在 Scikit-Learn 脚本中另有说明。在我们的例子中，我们可以依赖 input_fn 的默认实现。我们传递到最近邻模型中进行预测的 wine 嵌入是一个 Numpy 数组，这是默认 input_fn 可接受的内容类型之一。</p><p id="65c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于 predict_fn，我们会做一些定制。我们不是在模型对象上运行“预测”方法，而是返回前 10 个最近邻居的索引列表，以及输入数据和每个相应建议之间的余弦距离。我们将让函数返回一个 Numpy 数组，该数组由一个包含这些信息的列表组成。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="43db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">函数 output_fn 也需要一些小的定制。我们希望这个函数返回一个序列化的 Numpy 数组。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="4111" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Scikit-Learn 脚本还有一个组件:加载模型的函数。必须指定函数 model_fn，因为这里没有提供默认值。该函数从保存模型的目录中加载模型，以便 predict_fn 可以访问它。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="581b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">具有上述所有功能的脚本应该保存在一个源文件中，该文件独立于您用来向 SageMaker 提交脚本的笔记本。在我们的例子中，我们将这个脚本保存为 sklearn_nearest_neighbors.py。</p><p id="f5bb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">通过 Scikit-Learn 评估器在 SageMaker 上运行这个脚本</strong></p><p id="dfae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从这里开始就一帆风顺了:我们需要做的就是运行 Scikit-Learn 脚本来适应我们的模型，将它部署到一个端点，然后我们就可以开始使用它来返回最近邻葡萄酒嵌入。</p><p id="f390" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在 SageMaker 笔记本中，我们运行以下代码:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="09cb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们的近邻模型已经准备好行动了！现在，我们可以使用。predict 方法，返回样本输入向量的葡萄酒推荐列表。正如预期的那样，这将返回一个嵌套的 Numpy 数组，该数组由输入向量与其最近邻居之间的余弦距离以及这些最近邻居的索引组成。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="lp lq l"/></div></figure><pre class="kp kq kr ks gt lr ls lt lu aw lv bi"><span id="acb9" class="lw lx it ls b gy ly lz l ma mb">[[1.37459606e-01 1.42040288e-01 1.46988100e-01 1.54312524e-01<br/>  1.56549391e-01 1.62581288e-01 1.62581288e-01 1.62931791e-01<br/>  1.63314825e-01 1.65550581e-01]<br/> [91913 24923 74096 26492 77196 96871 113695 874654<br/>  100823 14478]]</span></pre><p id="a850" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们走吧！我们在 AWS SageMaker 中培训并主持了一个 Scikit-Learn 最近邻模型。</p></div></div>    
</body>
</html>