<html>
<head>
<title>Bag recognition with Android and TensorFlow using Image classification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于 Android 和 TensorFlow 的图像分类箱包识别</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/custom-object-detection-with-android-and-tensorflow-c412b1387352?source=collection_archive---------14-----------------------#2019-09-08">https://towardsdatascience.com/custom-object-detection-with-android-and-tensorflow-c412b1387352?source=collection_archive---------14-----------------------#2019-09-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/ee1249946c5d35ead2d6c596d76f2075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5a57WhYKrS2LPOJum1DXHA.jpeg"/></div></div></figure><h2 id="ad2a" class="kg kh iq bd ki kj kk dn kl km kn dp ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">问题是:</h2><p id="4acc" class="pw-post-body-paragraph lc ld iq le b lf lg lh li lj lk ll lm kp ln lo lp kt lq lr ls kx lt lu lv lw ij bi translated">最近，当我在印度东北部旅行时，我不得不等了很长时间，我的包才出现在机场的行李传送带上。旋转木马周围挤满了通勤者。很难把我的包和其他包区分开来，因为大约有一半的包看起来很相似。我不得不亲自检查六个包，以确保没有一个是我的。</p><p id="9458" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">我想有人会建立一些东西来解决这个问题。我开始寻找现有的解决方案，但是什么也找不到。我偶然发现了一些使用 TensorFlow 演示自定义对象检测的博客。后来我发现了<a class="ae mc" href="https://codelabs.developers.google.com/codelabs/tensorflow-for-poets-2/#0" rel="noopener ugc nofollow" target="_blank">这个非常有用的资源</a>，并以此为基础开始着手解决问题。</p><h2 id="fa61" class="kg kh iq bd ki kj kk dn kl km kn dp ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">数据:</h2><p id="0a50" class="pw-post-body-paragraph lc ld iq le b lf lg lh li lj lk ll lm kp ln lo lp kt lq lr ls kx lt lu lv lw ij bi translated">我首先需要的是数据。我本可以点击我的包的一些图片，但是我决定捕捉对象的所有侧面和边缘的视频。我从视频中提取单独的帧，并手工挑选视觉上不连续的帧。我将选定的帧转换为灰度图像。我用的是 ffmpeg。在命令行或终端上，键入，</p><pre class="jv jw jx jy gt md me mf mg aw mh bi"><span id="3142" class="kg kh iq me b gy mi mj l mk ml">ffmpeg -i video.mp4 -qscale:v 2 image_%03d.jpg</span></pre><p id="377c" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">video.mp4 是我的包的视频，输出图像以 image_ 为前缀。然后我需要不属于我包的照片。我发现了一个有用的谷歌<br/> Chrome 扩展，名为<a class="ae mc" href="https://chrome.google.com/webstore/detail/fatkun-batch-download-ima/nnjjahlikiabnchcpehcpkdeckfgnohf?hl=en" rel="noopener ugc nofollow" target="_blank"> Fatkun </a>。该扩展使我能够下载大量图像。我在谷歌图片上搜索包包，下载了一堆这样的图片。就像我包包的照片一样，我把后来下载的图片转换成了灰度。</p><p id="7072" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">我执行了一个 Python 脚本来将图像转换成灰度。下面的 Python 脚本有一个函数 rescale，它获取一个目录并将该目录中的所有图像转换为灰度。该脚本有一个依赖，PIL。</p><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Python script to convert images inside a folder to grayscale</figcaption></figure><p id="61e6" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">当我编排我的数据时，没有不平衡数据集的风险。我的包和我的包有相同数量的图像。</p><h2 id="81b6" class="kg kh iq bd ki kj kk dn kl km kn dp ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">食谱:</h2><p id="1cec" class="pw-post-body-paragraph lc ld iq le b lf lg lh li lj lk ll lm kp ln lo lp kt lq lr ls kx lt lu lv lw ij bi translated">一旦我有了图像，我就从这里下载<a class="ae mc" href="https://github.com/googlecodelabs/tensorflow-for-poets-2" rel="noopener ugc nofollow" target="_blank">tensor flow-for-Poets</a>。您需要在计算机上安装 TensorFlow。此外，你需要下载枕头。您可以通过键入以下命令来完成这两项工作。</p><pre class="jv jw jx jy gt md me mf mg aw mh bi"><span id="2e01" class="kg kh iq me b gy mi mj l mk ml">pip install --upgrade  "tensorflow==1.7.*"<br/><br/>pip install PILLOW</span></pre><p id="7ea1" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">在 Tensorflow-for-poets 的根目录中，我执行了，</p><pre class="jv jw jx jy gt md me mf mg aw mh bi"><span id="0981" class="kg kh iq me b gy mi mj l mk ml">python3 -m scripts.retrain --bottleneck_dir=tf_files/bottlenecks --how_many_training_steps=500 --model_dir=tf_files/models/ --summaries_dir=tf_files/training_summaries/mobilenet_v2_1.4_224 --output_graph=tf_files/retrained_graph_bags.pb --output_labels=tf_files/retrained_labels.txt --architecture="mobilenet_0.50_224" --image_dir=/Users/sumit/Desktop/carousel/Baggage-Carousel/Labs/data/</span></pre><p id="4677" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">scripts.retrain 将一个目录作为输入。对我来说，这是命令的最后一部分。</p><pre class="jv jw jx jy gt md me mf mg aw mh bi"><span id="2ef2" class="kg kh iq me b gy mi mj l mk ml">image_dir=/Users/sumit/Desktop/carousel/Baggage-Carousel/Labs/data/</span></pre><p id="10fa" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">该文件夹如下所示:</p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ms"><img src="../Images/0d348664c4a7dec36085cc3d27dfea23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZA9maQTd_f22YQSoyqjAQ.png"/></div></div></figure><p id="f228" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">名为 bag 的文件夹保存了我的包的灰度图像。另一个文件夹里有我能拿到的所有其他包的灰度照片。<em class="mt">‘架构’</em>论点是我想要重新训练的模型。我鼓励每个人都和模特一起玩耍。型号列表可以在<a class="ae mc" href="https://github.com/tensorflow/models/tree/master/research/slim#pre-trained-models" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="e85e" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated"><em class="mt">‘重新训练 _ 标签’</em>是一个生成的文本文件，带有两个文件夹的名称。这两个文件夹的行为就像两个类。同样，<em class="mt">' rettrained _ graph _ bags . Pb '</em>是该过程的结果。这两个文件都可以在以下位置找到:</p><pre class="jv jw jx jy gt md me mf mg aw mh bi"><span id="280a" class="kg kh iq me b gy mi mj l mk ml">tensorflow-for-poets-2/tf_files</span></pre><p id="3e60" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">该命令应该从 tensorflow-for-poets 的根目录执行。当命令被执行时，它将启动学习过程。</p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi mu"><img src="../Images/8d4fa6d3bdd9e7a1cfb568dc06959c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1zRMK4sIt4lgyEd_x5HKkg.png"/></div></div></figure><p id="ca99" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">接下来，我必须将生成的图形转换成 tflite。Tflite 或 TensorFlowLite 用于将机器学习模型部署到移动设备上。转换是通过执行以下命令完成的</p><pre class="jv jw jx jy gt md me mf mg aw mh bi"><span id="2b5d" class="kg kh iq me b gy mi mj l mk ml">toco — graph_def_file=tf_files/retrained_graph_bags.pb — output_file=tf_files/bagdroid_graph.tflite — output_format=TFLITE — input_shape=1,224,224,3 — input_array=input — output_array=final_result — inference_type=FLOAT — input_data_type=FLOAT</span></pre><p id="feef" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">上面的命令将<em class="mt">' rettrained _ graph _ bags . Pb '</em>作为输入，生成一个移动友好的 tflite 文件，命名为<em class="mt"> 'bagdroid_graph.tflite '。</em></p><h2 id="e767" class="kg kh iq bd ki kj kk dn kl km kn dp ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">Android 应用程序:</h2><p id="572f" class="pw-post-body-paragraph lc ld iq le b lf lg lh li lj lk ll lm kp ln lo lp kt lq lr ls kx lt lu lv lw ij bi translated">Android 应用程序只需要一些改动。除了外观上的变化，</p><ol class=""><li id="2946" class="mv mw iq le b lf lx lj ly kp mx kt my kx mz lw na nb nc nd bi translated">我必须将<em class="mt">' rettrained _ labels . txt '</em>和<em class="mt">' bag droid _ graph . TF lite '</em>复制到应用程序的 assets 文件夹中。</li><li id="08d9" class="mv mw iq le b lf ne lj nf kp ng kt nh kx ni lw na nb nc nd bi translated">在 ImageClassifier.java，我必须将<strong class="le ir">模型路径</strong>和<strong class="le ir">标签路径</strong>指向正确的值。</li><li id="ad66" class="mv mw iq le b lf ne lj nf kp ng kt nh kx ni lw na nb nc nd bi translated">我不得不在检测上添加音频和触觉反馈。</li></ol><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi nj"><img src="../Images/1cebb40e19d4e84264f2b59e1e75ce5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VBh5_-brx-Zr2iv18jeFEQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Changes made in ImageClassifer.java</figcaption></figure><h2 id="a034" class="kg kh iq bd ki kj kk dn kl km kn dp ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">结果是:</h2><p id="0ae1" class="pw-post-body-paragraph lc ld iq le b lf lg lh li lj lk ll lm kp ln lo lp kt lq lr ls kx lt lu lv lw ij bi translated">完成后的应用程序应该看起来更好，并且能够检测它被训练检测的包。</p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/445127559c96f252c3a57a931b793686.png" data-original-src="https://miro.medium.com/v2/resize:fit:390/format:webp/1*x7Y0uh6999gNDQLbSkWqxA.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">The final application</figcaption></figure><p id="25ee" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">最后，应用程序能够检测到我的包，给我声音和触觉反馈。</p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/b020b3d4f2becb814b031888a8c6aabb.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*IWIuFv9uqu-6yEOplpa_bg.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Detecting bag.</figcaption></figure><h2 id="aae8" class="kg kh iq bd ki kj kk dn kl km kn dp ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">问题是:</h2><p id="049a" class="pw-post-body-paragraph lc ld iq le b lf lg lh li lj lk ll lm kp ln lo lp kt lq lr ls kx lt lu lv lw ij bi translated">一个非常明显的问题是，如果两个包是相同的，应用程序将识别这两个包。这个问题可以通过使用 NFC 芯片来缓解。</p><p id="ca80" class="pw-post-body-paragraph lc ld iq le b lf lx lh li lj ly ll lm kp lz lo lp kt ma lr ls kx mb lu lv lw ij bi translated">但是，实际问题是应用程序经常将随机的东西标记为我的包。我很想知道我能做些什么来减少误报。</p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/6f95c5cb368a221d093a128d59eb1fdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*hmlOHxbUBTcMWGEa6IyPlQ.png"/></div></figure></div></div>    
</body>
</html>