<html>
<head>
<title>How to create better, interactive forecast plots using R and dygraph</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 R 和 dygraph 创建更好的交互式预测图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-create-better-interactive-forecast-plots-using-r-and-dygraph-29bdd7146066?source=collection_archive---------19-----------------------#2019-08-06">https://towardsdatascience.com/how-to-create-better-interactive-forecast-plots-using-r-and-dygraph-29bdd7146066?source=collection_archive---------19-----------------------#2019-08-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/36836b5ba440e13aba104aec40b5d346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zawp2zms3JHqzqs8plviGg.jpeg"/></div></div></figure><p id="9540" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你对 R 和时间序列感兴趣，你一定会偶然发现罗伯·海曼的伟大的<a class="ae kw" href="http://pkg.robjhyndman.com/forecast/" rel="noopener ugc nofollow" target="_blank">预测包</a>。除了用于分析时间序列的各种工具和方法之外，它还扩展了 ggplot 以使用 autoplot 可视化预测对象。虽然这几乎不用代码就能产生很好的结果，但它不提供交互功能。在本文中，您将了解到…</p><ul class=""><li id="323a" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">如何使用交互式功能(如缩放、平移和鼠标悬停信息)绘制预测</li><li id="1657" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">如何在绘图中包含 80%和 95%的区间预测</li><li id="f219" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">如何编写 JavaScript 格式化程序来调整图例</li></ul><p id="de37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是结果的样子…</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ll"><img src="../Images/e9ac3dc13a2b5feef968f8360606c112.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/1*k9RJotGa4lebjBx7r_dnsQ.gif"/></div></div></figure><h1 id="2651" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">对预测对象使用自动批次</h1><p id="41c4" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">让我们先看看预测对象的基本自动绘图功能的结果。在经典的<a class="ae kw" href="https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/AirPassengers.html" rel="noopener ugc nofollow" target="_blank">航空公司数据集</a>上创建一个 3 年预测，并绘制出结果，只需要三行代码。</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">code that forecasts and plots the air passenger time series</figcaption></figure><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/e55cffa580f34f0a1707aed48d7c7e22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MeWzLN0TbYSieTBx27QSmw.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">autoplot of a forecast object</figcaption></figure><p id="d23a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以看到黑色的实际时间序列和蓝色的预测。预测区间(80%和 95%)也显示为蓝色区域。虽然这对于三行代码来说无疑是一个好结果，但是可以通过交互特性来改善这个结果。</p><h1 id="1010" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">将 dygraph 用于预测对象</h1><p id="8792" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">JavaScript 库<a class="ae kw" href="http://dygraphs.com/" rel="noopener ugc nofollow" target="_blank"> dygraph </a>可以创建交互式绘图，R 的这个库的接口也可以通过<a class="ae kw" href="https://rstudio.github.io/dygraphs/" rel="noopener ugc nofollow" target="_blank">dy graph 包</a>获得。</p><p id="43a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将上面的例子转换成使用 dygraph 只是增加了一行来绑定来自 forecast 对象的时间序列。</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">simple dygraph for a forecast object</figcaption></figure><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/426a3f849b7fac687edbdd13b85a3ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQu6XwbdHthrKSbq6-GeHA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">basic dygraph showing actuals and point forecast</figcaption></figure><p id="7fac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，虽然我们获得了 dygraph 的交互特性，但突然之间预测区间丢失了。在 dygraph 中，可以用所谓的误差线来绘制时间序列，以解决这个问题。由于 dygraph 只支持每个时间序列一个误差线，我们只是简单地为每个时间间隔添加一个时间序列。</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk"><em class="nb">adding error bars for the interval forecasts</em></figcaption></figure><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/e95ce0766ced111720060f52d82c005b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xf-65f6fwJv7_A4fQnYc3A.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">dygraph showing actuals, point and interval forecasts</figcaption></figure><p id="90ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那看起来相当好，但是有一点东西不见了。如果将鼠标悬停在图表上，您将只能看到图例中的点预测值(上图中的 569.93)，而看不到相应的区间。</p><h1 id="c1d9" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">为预测间隔编写自定义格式化程序</h1><p id="a483" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">使用<code class="fe nd ne nf ng b">dyAxis</code>函数的<code class="fe nd ne nf ng b">valueFormatter</code>参数，自定义 JavaScript 函数可以覆盖 dygraph 图例中值的格式。对于每个时间序列，将在鼠标悬停时调用 JavaScript 函数，该函数将接受六个参数:</p><ul class=""><li id="832e" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">num</code>:当前时间序列鼠标悬停位置的值</li><li id="305e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">opts</code>:当前动态图的选项值</li><li id="52fa" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">seriesName</code>:当前时间序列的名称</li><li id="7e96" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">g</code>:实际的 dygraph 对象</li><li id="2735" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">row</code>:鼠标当前所在位置的原始数据的行索引</li><li id="c9f0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">col</code>:当前时间序列的原始数据列索引</li></ul><p id="3741" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将传递给函数的值<code class="fe nd ne nf ng b">num</code>不包括间隔值。但是，给定行和列索引的值可以从 dygraph 对象(函数<code class="fe nd ne nf ng b">getValue</code>)中获得，并且将包含这个预测间隔。然后，我们可以根据自己的喜好对其进行格式化。重用内置的<code class="fe nd ne nf ng b">Dygraph.numberValueFormatter</code>函数来格式化和传递选项值将保持对选项的支持，例如控制要显示的位数(参见<code class="fe nd ne nf ng b">dyOptions</code>中的选项<code class="fe nd ne nf ng b">digitsAfterDecimal</code>)。</p><p id="ace8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，dygraph 返回的值将是一个长度为 3 的向量，即使对于像实际时间序列这样只有一个值的时间序列也是如此。因此，在格式化为一个区间之前，我添加了检查上限值和下限值是否实际不同。</p><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk"><em class="nb">custom JavaScript for formatting values in the legend</em></figcaption></figure><p id="e21a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我对图表进行了一些额外的调整:</p><ul class=""><li id="718a" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">点预测的专用时间序列，用于将间隔预测与图例中的点预测分开</li><li id="0ab5" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">使用<code class="fe nd ne nf ng b">dyLegend</code>函数中的选项<code class="fe nd ne nf ng b">labelsSeparateLines</code>将每个标签放在一个单独的行上，这使得结果更具可读性</li><li id="5685" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe nd ne nf ng b">dyRangeSelector</code>函数在图的底部放置了一个漂亮的选择器</li><li id="95b8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">使用选项<code class="fe nd ne nf ng b">digitsAfterDecimal</code>将位数减少到一位</li><li id="7402" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">一个小的 CSS 保持图例半透明，以避免覆盖图形</li></ul><figure class="lm ln lo lp gt jr"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk"><em class="nb">final code using dygraph for plotting forecast objects</em> plot</figcaption></figure><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/190123655dc2df4411fc53c25860b584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N3rDEJAvV_wolqXFl8HtEw.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">dygraph showing actuals, point and interval forecasts and custom legend</figcaption></figure><p id="78f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>