<html>
<head>
<title>Elasticsearch meets BERT: Building Search Engine with Elasticsearch and BERT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch 遇见 BERT:用 Elasticsearch 和 BERT 构建搜索引擎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/elasticsearch-meets-bert-building-search-engine-with-elasticsearch-and-bert-9e74bf5b4cf2?source=collection_archive---------7-----------------------#2019-09-30">https://towardsdatascience.com/elasticsearch-meets-bert-building-search-engine-with-elasticsearch-and-bert-9e74bf5b4cf2?source=collection_archive---------7-----------------------#2019-09-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c35b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我们使用一个预先训练好的 BERT 模型和 Elasticsearch 来构建一个搜索引擎。Elasticsearch 最近发布了<a class="ae ko" href="https://www.elastic.co/jp/blog/text-similarity-search-with-vectors-in-elasticsearch" rel="noopener ugc nofollow" target="_blank">带矢量场的文本相似度搜索</a>。另一方面，您可以使用 BERT 将文本转换成固定长度的向量。所以一旦我们用 BERT 把文档转换成向量，存入 Elasticsearch，就可以用 Elasticsearch 和 BERT 搜索相似的文档。</p><p id="e476" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本文通过以下架构实现了一个包含 Elasticsearch 和 BERT 的搜索引擎。这里我们用 Docker 把整个系统分为三个部分:应用、BERT、Elasticsearch。目的是使每项服务更容易扩展。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/0b22a1475644866bcb6dae41b8edfd9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gHUTTEZ56fxZHDvI.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk">System Architecture</figcaption></figure><p id="2ad5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在这篇文章中只展示了重要的部分，但是整个系统都是在下面的 GitHub 库中用<code class="fe lf lg lh li b">docker-compose.yaml</code>编写的。请查看存储库:</p><ul class=""><li id="4aca" class="lj lk it js b jt ju jx jy kb ll kf lm kj ln kn lo lp lq lr bi translated"><a class="ae ko" href="https://github.com/Hironsan/bertsearch" rel="noopener ugc nofollow" target="_blank">https://github.com/Hironsan/bertsearch</a></li></ul><p id="d189" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个职位的计划是:</p><ol class=""><li id="5340" class="lj lk it js b jt ju jx jy kb ll kf lm kj ln kn ls lp lq lr bi translated">下载预先训练好的 BERT 模型</li><li id="4f0f" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn ls lp lq lr bi translated">设置环境变量</li><li id="cba1" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn ls lp lq lr bi translated">下水码头集装箱</li><li id="a5bd" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn ls lp lq lr bi translated">创建弹性搜索索引</li><li id="f44b" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn ls lp lq lr bi translated">创建文档</li><li id="6bbe" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn ls lp lq lr bi translated">索引文件</li></ol><h1 id="c720" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">1.下载预先训练好的 BERT 模型</h1><p id="120c" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">首先，下载一个预先训练好的 BERT 模型。以下命令是下载英语模型的示例:</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="fb4d" class="nf lz it li b gy ng nh l ni nj">$ wget <a class="ae ko" href="https://storage.googleapis.com/bert_models/2018_10_18/cased_L-12_H-768_A-12.zip" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/bert_models/2018_10_18/cased_L-12_H-768_A-12.zip</a><br/>$ unzip cased_L-12_H-768_A-12.zip</span></pre><h1 id="d94c" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">2.设置环境变量</h1><p id="93fd" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">你需要设置一个预先训练好的 BERT 模型和 Elasticsearch 的索引名作为环境变量。这些变量在 Docker 容器中使用。下面是一个将<em class="nk"> jobsearch </em>指定为索引名和<em class="nk">的示例。/cased_L-12_H-768_A-12 </em>作为模型的路径:</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="7f7d" class="nf lz it li b gy ng nh l ni nj">$ export PATH_MODEL=./cased_L-12_H-768_A-12<br/>$ export INDEX_NAME=jobsearch</span></pre><h1 id="0868" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">3.启动码头集装箱</h1><p id="20a1" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">现在，让我们使用 Docker compose 启动 Docker 容器。这里要启动三个容器:应用程序容器、BERT 容器和 Elasticsearch 容器。查看<a class="ae ko" href="https://github.com/Hironsan/bertsearch/blob/master/docker-compose.yaml" rel="noopener ugc nofollow" target="_blank"> docker-compose.yaml </a>了解更多详情。</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="ea7d" class="nf lz it li b gy ng nh l ni nj">$ docker-compose up</span></pre><p id="20bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意，我建议你应该给 Docker 分配更多的内存(8GB 以上)。因为 BERT 容器需要大内存。</p><h1 id="31f7" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">4.创建弹性搜索索引</h1><p id="6c35" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">您可以使用 create index API 向 Elasticsearch 集群添加新的索引。创建索引时，可以指定以下内容:</p><ul class=""><li id="39b6" class="lj lk it js b jt ju jx jy kb ll kf lm kj ln kn lo lp lq lr bi translated">索引的设置</li><li id="e25a" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn lo lp lq lr bi translated">索引中字段的映射</li><li id="8a2b" class="lj lk it js b jt lt jx lu kb lv kf lw kj lx kn lo lp lq lr bi translated">索引别名</li></ul><p id="dc04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，如果您想要创建带有<code class="fe lf lg lh li b">title</code>、<code class="fe lf lg lh li b">text</code>和<code class="fe lf lg lh li b">text_vector</code>字段的<code class="fe lf lg lh li b">jobsearch</code>索引，您可以通过以下命令创建该索引:</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="b0ff" class="nf lz it li b gy ng nh l ni nj">$ python example/create_index.py --index_file=example/index.json --index_name=jobsearch<br/># index.json<br/>{<br/>  "settings": {<br/>    "number_of_shards": 2,<br/>    "number_of_replicas": 1<br/>  },<br/>  "mappings": {<br/>    "dynamic": "true",<br/>    "_source": {<br/>      "enabled": "true"<br/>    },<br/>    "properties": {<br/>      "title": {<br/>        "type": "text"<br/>      },<br/>      "text": {<br/>        "type": "text"<br/>      },<br/>      "text_vector": {<br/>        "type": "dense_vector",<br/>        "dims": 768<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="1a3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意:<code class="fe lf lg lh li b">text_vector</code>的<code class="fe lf lg lh li b">dims</code>值必须与预训练的 BERT 模型的 dims 相匹配。</p><h1 id="6259" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">5.创建文档</h1><p id="5332" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">一旦创建了索引，就可以为一些文档编制索引了。这里的要点是使用 BERT 将文档转换成矢量。产生的矢量存储在<code class="fe lf lg lh li b">text_vector</code>字段中。让我们将您的数据转换成一个 JSON 文档:</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="a8c0" class="nf lz it li b gy ng nh l ni nj">$ python example/create_documents.py --data=example/example.csv --index_name=jobsearch<br/># example/example.csv<br/>"Title","Description"<br/>"Saleswoman","lorem ipsum"<br/>"Software Developer","lorem ipsum"<br/>"Chief Financial Officer","lorem ipsum"<br/>"General Manager","lorem ipsum"<br/>"Network Administrator","lorem ipsum"</span></pre><p id="f67d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成脚本后，您可以获得如下所示的 JSON 文档:</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="b4ad" class="nf lz it li b gy ng nh l ni nj"># documents.jsonl<br/>{"_op_type": "index", "_index": "jobsearch", "text": "lorem ipsum", "title": "Saleswoman", "text_vector": [...]}<br/>{"_op_type": "index", "_index": "jobsearch", "text": "lorem ipsum", "title": "Software Developer", "text_vector": [...]}<br/>{"_op_type": "index", "_index": "jobsearch", "text": "lorem ipsum", "title": "Chief Financial Officer", "text_vector": [...]}<br/>...</span></pre><h1 id="a3c0" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">6.索引文档</h1><p id="597a" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">将数据转换成 JSON 后，可以将 JSON 文档添加到指定的索引中，并使其可搜索。</p><pre class="kq kr ks kt gt nb li nc nd aw ne bi"><span id="005c" class="nf lz it li b gy ng nh l ni nj">$ python example/index_documents.py</span></pre><h1 id="9cb7" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">7.打开浏览器</h1><p id="f128" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">去<a class="ae ko" href="http://127.0.0.1:5000/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:5000 </a>。下面是一个求职的例子。你可以看到“我在找律师”查询返回类似“法律助理”和“律师”的工作。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nl"><img src="../Images/2024a18f33b958fe99fef51bc8cd3f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*poE4OaxfFt172t6f.png"/></div></div></figure><h1 id="9364" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">结论</h1><p id="c43a" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">在这篇文章中，我们用 Elasticsearch 和 BERT 实现了搜索引擎。虽然 BERT 的执行速度有问题，但是像这种架构一样把 BERT 当成一个独立的容器，很容易伸缩，所以我认为问题是可以解决的。希望这篇文章对你有用。</p><ul class=""><li id="9e0b" class="lj lk it js b jt ju jx jy kb ll kf lm kj ln kn lo lp lq lr bi translated"><a class="ae ko" href="https://github.com/Hironsan/bertsearch" rel="noopener ugc nofollow" target="_blank">https://github.com/Hironsan/bertsearch</a></li></ul></div></div>    
</body>
</html>