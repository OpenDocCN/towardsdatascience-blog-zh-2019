# SQL 中的复杂查询

> 原文：<https://towardsdatascience.com/complex-queries-in-sql-c95e4a84d42a?source=collection_archive---------7----------------------->

![](img/d34214b54a2a8769546eb5045e68665c.png)

Hopefully your SQL queries aren’t tangled like this. (Photo:Author)

SQL 教科书擅长提供 SQL 语法的基本模板，但有时这些书中的查询与现实生活相比有点理想化，只有不超过两三个要连接的表和少量要处理的字段。因此，查询本身通常不超过十几行。

在野外经常会发生这样的情况，你最终会在很多表格中加入冗长的“WHERE”子句，这些子句很容易被遗忘。当你第一次使用它们的时候，它们很难使用，但是如果你需要重用它们，调试和理解它们是不可能的。怎样做才能使又长又复杂的查询更容易编写和阅读？

但是，首先，问问自己是否需要一个长而复杂的查询。您的单个查询完成所有工作是否至关重要？如果你还认为是，至少多问自己两遍。在优秀的 [*SQL 反模式*](https://www.bookdepository.com/SQL-Antipatterns-Bill-Karwin/9781934356555?ref=grid-view&qid=1565053667697&sr=1-1) 中，使用单个查询来解决一个复杂任务或多个任务被认为是一个关键的查询反模式，强调了它的地位是需要警惕的。这本书指出的一个特别的危险是，随着查询变得更加难以理解，意外进行笛卡尔连接(一种返回的行数是连接中涉及的表中行数的乘积的连接)的风险。相比之下，内连接或外连接中的最大行数将是最大表中的行数)，返回许多不需要的行需要很长时间，这将大大增加。

因此，关键的建议是检查大型查询是否可以用多个更容易理解的小型查询来执行。

如果您认为您正在编写的复杂查询是完全不可避免的，有几种方法可以使它变得不那么痛苦。

1.  指定查询中的列名；不要落入“选择*”陷阱。没有指定要返回哪些列的复杂查询很可能会返回不需要的列，从而使查找所需信息变得更加困难。此外，返回冗余列的可能性很大。
2.  请仔细格式化您的查询，使其尽可能易于他人阅读。将每个要选择的字段放在自己的行上，将每个新连接的表放在自己的行上，并将“WHERE”子句的每个元素放在自己的行上。
3.  为表格使用有意义的别名，以进一步提高可读性。您可能需要在查询中多次引用您的表，如果您在其他人的数据库中使用他们的命名约定，表名可能包含关于他们引用的冗余信息，例如“MyDBTable1”，因此您将这样的表称为“T1”，因为您已经知道您正在“MyDB”中工作
4.  创建一个冗余的“WHERE”子句，例如“WHERE 0=0 ”,以便轻松测试 Where 子句的不同部分(h/t 前同事 Mark Watson)。也就是说，因为“WHERE 0=0”自动位于“WHERE”子句的开头，所以您可以打开和关闭它的其余部分(例如将其注释掉)，而不会出现语法错误来检查效果。
5.  计划您的查询，可能在纸上画一个草图，以便您在开始将数据转换为代码之前，知道您试图在数据的位置以及查询中的表如何相互关联方面实现什么。

采取这些步骤的最终结果是您的代码看起来有点像这样:

```
SELECT
        Var1
      , Var2
      ...
      , VarNFROM  
          Table1  T1
     JOIN Table2  T2  on  T1.Var1=T2.Var1
     JOIN Table3  T3  on  T1.Var1=T3.Var1
     WHERE  0=0

AND    T1.Var1 > 0
```

总的来说，最好有更多的小查询，而不是更少的大查询。然而，一些数据库结构使这变得困难，例如，如果您需要联接以获得从表 b 中找到您真正需要的内容的辅键，在这些情况下，计划和仔细的格式化可以帮助避免您的代码变成意大利面条。

*罗伯特·德格拉夫已经为数据科学家写了许多关于 SQL 的文章，包括最近的，*[*【SQL For Missing Values】*](/using-sql-to-improve-missing-values-d1d14cf69797?source=your_stories_page---------------------------)*。*

罗伯特·德格拉夫的书《管理你的数据科学项目》已经通过出版社出版。

[*在 Twitter 上关注罗伯特*](https://twitter.com/RobertdeGraaf2?source=post_page---------------------------)