<html>
<head>
<title>Uber datasets in BigQuery: Driving times around SF (and your city too)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery 中的优步数据集:旧金山周围的行驶时间(以及您所在的城市)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/uber-datasets-in-bigquery-driving-times-around-sf-and-your-city-too-9ad95baa6bfe?source=collection_archive---------15-----------------------#2019-05-15">https://towardsdatascience.com/uber-datasets-in-bigquery-driving-times-around-sf-and-your-city-too-9ad95baa6bfe?source=collection_archive---------15-----------------------#2019-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/cf334ea4aed25d7d50cd81d297acde28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WolAHK7NkgvTdz3I1ox5Mg.gif"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Interactive travel times dashboard around the SF Bay Area. Powered by BigQuery, Data Studio, and Uber’s worldwide movement data.</figcaption></figure><div class=""/><div class=""><h2 id="8905" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">优步一直在向他们的公共数据程序添加新的城市——让我们把它们载入 BigQuery。我们将利用最新的新功能:原生 GIS 功能、分区、集群和带有 BI 引擎的快速仪表板。</h2></div><p id="b951" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">首先让我们来玩一下交互式仪表板，我们将在下面研究加载步骤和故障排除。注意，您可以使用这些步骤将任何其他城市加载到 BigQuery 中！<a class="ae lq" href="https://datastudio.google.com/open/1rGk5wVZHgNZEv7XRhN18zM2tWbUDrQDL" rel="noopener ugc nofollow" target="_blank">互动数据工作室仪表盘</a>:</p><figure class="lr ls lt lu gt is"><div class="bz fp l di"><div class="lv lw l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Play with the <a class="ae lq" href="https://datastudio.google.com/open/1rGk5wVZHgNZEv7XRhN18zM2tWbUDrQDL" rel="noopener ugc nofollow" target="_blank">interactive Data Studio dashboard</a>.</figcaption></figure><h1 id="8eeb" class="lx ly jf bd lz ma mb mc md me mf mg mh kl mi km mj ko mk kp ml kr mm ks mn mo bi translated">第一步:从优步获取数据</h1><p id="8101" class="pw-post-body-paragraph ku kv jf kw b kx mp kg kz la mq kj lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">我们可以在<a class="ae lq" href="https://movement.uber.com/explore/san_francisco/travel-times/" rel="noopener ugc nofollow" target="_blank">优步运动的公共数据网站</a>找到几个城市的数据。在这里，我将下载一些旧金山旅行时间数据集:</p><div class="lr ls lt lu gt ab cb"><figure class="mu is mv mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/8b5a1fcba19f197d5c112f1d9ca59f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*t1tCMno192iUDdI3hkibKQ.png"/></div></figure><figure class="mu is na mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/7bc4cfa03fba63e1912fdfc9a5afa323.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/format:webp/1*x1oVeU8o1ITReljO2rqcVw.png"/></div></figure><figure class="mu is nb mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/f8f02b693eab83b06f53b95f58302bf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*2IViWEipy2XP8xXD4w2RgQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk nc di nd ne">Downloading Uber’s public data for <a class="ae lq" href="https://movement.uber.com/explore/san_francisco/travel-times" rel="noopener ugc nofollow" target="_blank">San Francisco travel times</a></figcaption></figure></div><h1 id="d79e" class="lx ly jf bd lz ma mb mc md me mf mg mh kl mi km mj ko mk kp ml kr mm ks mn mo bi translated">步骤 2:加载到 BigQuery 中</h1><p id="46d6" class="pw-post-body-paragraph ku kv jf kw b kx mp kg kz la mq kj lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">一旦我们有了文件，加载数据 CSV 就很简单了:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="a0e1" class="nk ly jf ng b gy nl nm l nn no">bq load --autodetect \<br/>  fh-bigquery:deleting.uber_sf_censustracts_201803_all_hourly \<br/>  san_francisco-censustracts-2018-3-All-HourlyAggregate.csv</span><span id="f0a0" class="nk ly jf ng b gy np nm l nn no">bq load --autodetect \<br/>  fh-bigquery:deleting.uber_sf_censustracts_201803_weekdays_hourly \<br/>  san_francisco-censustracts-2018-3-OnlyWeekdays-HourlyAggregate.csv</span><span id="08f7" class="nk ly jf ng b gy np nm l nn no">bq load --autodetect \<br/>  fh-bigquery:deleting.uber_sf_censustracts_201803_weekends_hourly \<br/>  san_francisco-censustracts-2018-3-OnlyWeekends-HourlyAggregate.csv</span></pre><p id="e37a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然而，地理边界文件将带来一些挑战。它们是标准的 GeoJSON 文件，但是我们必须在加载到 BigQuery 之前对它们进行处理:</p><ol class=""><li id="e477" class="nq nr jf kw b kx ky la lb ld ns lh nt ll nu lp nv nw nx ny bi translated">使用<code class="fe nz oa ob ng b">jq</code>将 GeoJSON 文件转换为新的行分隔的 JSON 文件。</li><li id="db74" class="nq nr jf kw b kx oc la od ld oe lh of ll og lp nv nw nx ny bi translated">加载新的。json 文件作为 CSV 文件导入 BigQuery。</li><li id="85b4" class="nq nr jf kw b kx oc la od ld oe lh of ll og lp nv nw nx ny bi translated">解析 BigQuery 中的 JSON 行以生成原生 GIS 几何。</li></ol><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="18b6" class="nk ly jf ng b gy nl nm l nn no">jq -c .features[] \<br/>  san_francisco_censustracts.json &gt; sf_censustracts_201905.json</span><span id="24b4" class="nk ly jf ng b gy np nm l nn no">bq load --source_format=CSV \<br/>  --quote='' --field_delimiter='|' \<br/>  fh-bigquery:deleting.sf_censustracts_201905 \<br/>  sf_censustracts_201905.json row</span></pre><p id="82bc" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于步骤 3，我们可以解析 BigQuery 中加载的行:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="656d" class="nk ly jf ng b gy nl nm l nn no">CREATE OR REPLACE TABLE `fh-bigquery.uber_201905.sf_censustracts`<br/>AS</span><span id="6b15" class="nk ly jf ng b gy np nm l nn no">SELECT FORMAT('%f,%f', ST_Y(centroid), ST_X(centroid)) lat_lon, *<br/>FROM (<br/>  SELECT *, ST_CENTROID(geometry) centroid<br/>  FROM (<br/>    SELECT <br/>      CAST(JSON_EXTRACT_SCALAR(row, '$.properties.MOVEMENT_ID') AS INT64) movement_id<br/>      , JSON_EXTRACT_SCALAR(row, '$.properties.DISPLAY_NAME') display_name<br/>      , ST_GeogFromGeoJson(JSON_EXTRACT(row, '$.geometry')) geometry<br/>    FROM `fh-bigquery.deleting.sf_censustracts_201905` <br/>  )<br/>)</span></pre><p id="e5c1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">从<a class="oh oi ep" href="https://medium.com/u/247b0630b5d6?source=post_page-----9ad95baa6bfe--------------------------------" rel="noopener" target="_blank"> Lak Lakshmanan </a>和<a class="oh oi ep" href="https://medium.com/u/d6fd5605cebd?source=post_page-----9ad95baa6bfe--------------------------------" rel="noopener" target="_blank"> Michael Entin </a>中找一些替代品(JavaScript，ogr2ogr)加载这个<a class="ae lq" href="https://stackoverflow.com/a/24253853/132438" rel="noopener ugc nofollow" target="_blank">栈溢出回复</a>中的 GeoJSON 数据。</p><h1 id="9dd4" class="lx ly jf bd lz ma mb mc md me mf mg mh kl mi km mj ko mk kp ml kr mm ks mn mo bi translated">步骤 3:为性能和效率按摩数据</h1><p id="9ee0" class="pw-post-body-paragraph ku kv jf kw b kx mp kg kz la mq kj lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">现在我们在 BigQuery 中有了两个表，让我们处理数据以划分主表，创建本地 BQ GIS 几何列，并将所有内容连接在一起:</p><p id="5c72" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">让我们创建我们的主表。该表将包含工作日、周末和总体统计数据，并且我们将添加一些人口普查区域数据以使其更易于可视化和理解。为了提高效率，我们将按季度对其进行分区，并按 stat 和旅行起始地的类型进行聚类。</p><p id="6de8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我还会计算一些额外的数据:区域间的平均距离和给定距离的速度。请注意，拥有这些统计信息会使查询运行速度比我们跳过它们时慢得多:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="0a45" class="nk ly jf ng b gy nl nm l nn no">CREATE OR REPLACE TABLE `fh-bigquery.uber_201905.sf_hourly`<br/>PARTITION BY quarter <br/>CLUSTER BY table_source, source, destination<br/>-- don't partition/cluster if using BQ w/o credit card</span><span id="0e21" class="nk ly jf ng b gy np nm l nn no">AS</span><span id="3b15" class="nk ly jf ng b gy np nm l nn no">SELECT *, distance * 0.000621371192 / geometric_mean_travel_time * 3600 speed_mph<br/>FROM (<br/>  SELECT * EXCEPT(geo_b, geo_c),  (ST_DISTANCE(geo_b, geo_c)+ST_MAXDISTANCE(geo_b, geo_c))/2 distance<br/>  FROM (<br/>    SELECT a.*,  SPLIT(_TABLE_SUFFIX, '_')[OFFSET(0)] table_source<br/>      , b.display_name source  <br/>      , c.display_name destination<br/>      , b.lat_lon sourceid_lat_lon  <br/>      , CAST(SPLIT(b.lat_lon, ',')[OFFSET(0)] AS FLOAT64) sourceid_lat  <br/>      , CAST(SPLIT(b.lat_lon, ',')[OFFSET(1)] AS FLOAT64) sourceid_lon  <br/>      , c.lat_lon dstid_lat_lon<br/>      , CAST(SPLIT(c.lat_lon, ',')[OFFSET(0)] AS FLOAT64) dstid_lat<br/>      , CAST(SPLIT(c.lat_lon, ',')[OFFSET(1)] AS FLOAT64) dstid_lon  <br/>      , DATE('2018-07-01') quarter<br/>      , COUNT(*) OVER(PARTITION BY sourceid, dstid) source_dst_popularity<br/>      , COUNT(*) OVER(PARTITION BY dstid) dst_popularity<br/>      , b.geometry geo_b, c.geometry geo_c<br/>    FROM `fh-bigquery.deleting.uber_sf_censustracts_201803_*` a<br/>    JOIN `fh-bigquery.uber_201905.sf_censustracts` b<br/>    ON a.sourceid=b.movement_id<br/>    JOIN `fh-bigquery.uber_201905.sf_censustracts` c<br/>    ON a.dstid=c.movement_id<br/>  )<br/>)</span></pre><figure class="lr ls lt lu gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oj"><img src="../Images/a5faeed819ac04a0073361962e2e0df7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FLC9WVBgR_L_VNjULF2Blw.png"/></div></div></figure><h1 id="8559" class="lx ly jf bd lz ma mb mc md me mf mg mh kl mi km mj ko mk kp ml kr mm ks mn mo bi translated">步骤 4:查询和可视化</h1><p id="1cbd" class="pw-post-body-paragraph ku kv jf kw b kx mp kg kz la mq kj lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">我用 Data Studio 创建了一个交互式仪表板。请注意，由于我们新的<a class="ae lq" href="https://cloud.google.com/bi-engine/docs/overview" rel="noopener ugc nofollow" target="_blank"> BigQuery BI 引擎，它的运行速度非常快。</a>但是你也可以运行你自己的查询！</p><p id="1826" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">例如，旧金山最糟糕的目的地和到达旧金山机场的时间:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="9800" class="nk ly jf ng b gy nl nm l nn no">SELECT ROUND(geometric_mean_travel_time/60) minutes<br/>  , hod hour, ROUND(distance*0.000621371192,2) miles<br/>  , destination <br/>FROM `fh-bigquery.uber_201905.sf_hourly`<br/>WHERE table_source='weekdays'<br/>AND quarter='2018-07-01'<br/>AND source LIKE '100 Domestic Terminals Departures Level%' <br/>AND destination LIKE '%San Francisco%'<br/>AND (distance*0.000621371192)&gt;10<br/>ORDER BY 1 DESC<br/>LIMIT 20</span></pre><div class="lr ls lt lu gt ab cb"><figure class="mu is ok mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/0e3db6db107a2bb0a73d7f53b7f996a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*2PDCd-BsSF-9vb382QK5FQ.png"/></div></figure><figure class="mu is ol mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/f5b8e85ea4cc6af8424409e30ae368f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*GZR28slKCtV8LfYeFd9FbA.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk om di on ne">The worst destinations in San Francisco by time to travel starting at the SFO airport. Avoid going to the Marina at 5pm — it will take you 45 minutes on a weekday.</figcaption></figure></div><p id="fb9b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">从旧金山到旧金山的最佳旅行地点和时间:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="7a2b" class="nk ly jf ng b gy nl nm l nn no">SELECT ROUND(geometric_mean_travel_time/60) minutes<br/>  , hod hour, ROUND(distance*0.000621371192,2) miles<br/>  , destination <br/>FROM `fh-bigquery.uber_201905.sf_hourly`<br/>WHERE table_source='weekdays'<br/>AND quarter='2018-07-01'<br/>AND source LIKE '100 Domestic Terminals Departures Level%' <br/>AND destination LIKE '%San Francisco%'<br/>AND (distance*0.000621371192)&gt;10<br/>ORDER BY 1 <br/>LIMIT 20</span></pre><div class="lr ls lt lu gt ab cb"><figure class="mu is oo mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/4b13f547b5e07f67f751cfc9b778d67d.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*lHtaWEmgZyzXF8IuWlHtpw.png"/></div></figure><figure class="mu is op mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/087229c9eede8101122af1013694bdbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*w93Niy8iNGhPmOhhZiID3A.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk oq di or ne">You can get from SFO to Potrero Hills in 10 minutes… at 5am.</figcaption></figure></div><p id="f444" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">从旧金山到奥克兰时，平均时间的最大变化(截至<code class="fe nz oa ob ng b">stddev</code>)为:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="8c26" class="nk ly jf ng b gy nl nm l nn no">SELECT destination <br/>  , STDDEV(geometric_mean_travel_time) stddev<br/>  , COUNT(*) c<br/>FROM `fh-bigquery.uber_201905.sf_hourly`<br/>WHERE table_source='weekdays'<br/>AND quarter='2018-07-01'<br/>AND source LIKE '100 Domestic Terminals Departures Level%' <br/>AND destination LIKE '%Oakland%'<br/>AND (distance*0.000621371192)&gt;10<br/>GROUP BY destination<br/>HAVING c=24<br/>ORDER BY stddev DESC<br/>LIMIT 20</span></pre><div class="lr ls lt lu gt ab cb"><figure class="mu is os mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/6a1be3f62295f0e4b6beda7033a4ce3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*5R9h3EYpZblCA0rv5KgnVw.png"/></div></figure><figure class="mu is ot mw mx my mz paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/610574029af3a94edde5f51db859a29b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*dXjANa0LJzVEzX7L1Kh8rQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk om di on ne">Going from SFO to Gwin Road in Oakland might take you 30 minutes, or double that at peak time.</figcaption></figure></div><h1 id="6e91" class="lx ly jf bd lz ma mb mc md me mf mg mh kl mi km mj ko mk kp ml kr mm ks mn mo bi translated">轮到你玩了</h1><p id="cebc" class="pw-post-body-paragraph ku kv jf kw b kx mp kg kz la mq kj lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">在 BigQuery 中找到<a class="ae lq" href="https://bigquery.cloud.google.com/table/fh-bigquery:uber_201905.sf_hourly" rel="noopener ugc nofollow" target="_blank">共享数据集。</a></p><p id="28da" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">加载<a class="ae lq" href="https://movement.uber.com/cities?lang=en-US" rel="noopener ugc nofollow" target="_blank">更多城市</a>——优步不断向他们的共享集合添加更多数据！</p><figure class="lr ls lt lu gt is gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/a02d388310089e70f43c4d2c5fbd6526.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*ZR3Z2IH1iau1s6Xj_1l-zQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Some of the cities Uber is sharing data for.</figcaption></figure><h1 id="1a66" class="lx ly jf bd lz ma mb mc md me mf mg mh kl mi km mj ko mk kp ml kr mm ks mn mo bi translated">后续步骤</h1><p id="eb07" class="pw-post-body-paragraph ku kv jf kw b kx mp kg kz la mq kj lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">想要更多的故事？查看我的<a class="ae lq" href="http://medium.com/@hoffa/" rel="noopener">媒体</a>，<a class="ae lq" href="http://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank">关注我的推特</a>，订阅<a class="ae lq" href="https://reddit.com/r/bigquery" rel="noopener ugc nofollow" target="_blank">reddit.com/r/bigquery</a>。试试 big query——每个月你都可以免费获得一个完整的 TB 级分析。</p><blockquote class="ov ow ox"><p id="9ba1" class="ku kv oy kw b kx ky kg kz la lb kj lc oz le lf lg pa li lj lk pb lm ln lo lp ij bi translated">优步的数据许可:数据是在知识共享，署名非商业许可下提供的。<a class="ae lq" href="https://movement.uber.com/attribution?lang=en-US" rel="noopener ugc nofollow" target="_blank">数据属性</a></p><p id="235d" class="ku kv oy kw b kx ky kg kz la lb kj lc oz le lf lg pa li lj lk pb lm ln lo lp ij bi translated">背景图:<a class="ae lq" href="http://extras.sfgate.com/img/pages/travel/maps/sfbay_std.gif" rel="noopener ugc nofollow" target="_blank">http://extras . SF gate . com/img/pages/travel/maps/SF bay _ STD . gif</a></p></blockquote><div class="ip iq gp gr ir pc"><a rel="noopener follow" target="_blank" href="/when-will-stack-overflow-reply-how-to-predict-with-bigquery-553c24b546a3"><div class="pd ab fo"><div class="pe ab pf cl cj pg"><h2 class="bd jg gy z fp ph fr fs pi fu fw je bi translated">堆栈溢出何时回复:如何用 BigQuery 预测</h2><div class="pj l"><h3 class="bd b gy z fp ph fr fs pi fu fw dk translated">当你最后发布一个关于栈溢出的问题时，一个漫长的等待就开始了。有人会回答你的问题吗？会不会…</h3></div><div class="pk l"><p class="bd b dl z fp ph fr fs pi fu fw dk translated">towardsdatascience.com</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq ix pc"/></div></div></a></div></div></div>    
</body>
</html>