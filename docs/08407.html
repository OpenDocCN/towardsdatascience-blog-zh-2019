<html>
<head>
<title>Coding in R: Nest and map your way to efficient code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R 中的编码:嵌套并映射到高效的代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/coding-in-r-nest-and-map-your-way-to-efficient-code-4e44ba58ee4a?source=collection_archive---------10-----------------------#2019-11-15">https://towardsdatascience.com/coding-in-r-nest-and-map-your-way-to-efficient-code-4e44ba58ee4a?source=collection_archive---------10-----------------------#2019-11-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f707a9d269f6a56a4e6a591608784317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5BP9kNp-6Zfk7MNa"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@oliviac_design?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Olivia Colacicco</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2dff" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">嵌套并映射到高效代码</h1><p id="a6cf" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我在 2019 年 3 月写了我的第一行 R 代码，但是最近才发现<code class="fe mc md me mf b">nest</code>和<code class="fe mc md me mf b">map</code>的威力。在此之前，我写了很多效率低下的代码(C &amp; P，C &amp; P，C&amp;P……)。</p><p id="de1f" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">这是如何使用<code class="fe mc md me mf b">nest</code>和<code class="fe mc md me mf b">map</code>找到 184 个国家在 1960 年到 2016 年间使用<code class="fe mc md me mf b">gapminder</code>数据集(内置于<code class="fe mc md me mf b">dslabs</code>)的平均人口的简短演示。<code class="fe mc md me mf b">gapminder</code>拥有 184 个国家从 1960 年到 2016 年每年的健康和收入数据。数据以整齐的格式呈现，这意味着每个国家有 57 行数据(每年一行)。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="dc86" class="mt kh it mf b gy mu mv l mw mx">library(dslab<br/>glimpse(gapminder)</span></pre><p id="1b58" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated"><code class="fe mc md me mf b">## Observations: 10,545<br/>## Variables: 9<br/>## $ country &lt;fct&gt; Albania, Algeria, Angola, Antigua and Barbuda, …<br/>## $ year &lt;int&gt; 1960, 1960, 1960, 1960, 1960, 1960, 1960, 1960,…<br/>## $ infant_mortality &lt;dbl&gt; 115.40, 148.20, 208.00, NA, 59.87, NA, NA, 20.3…<br/>## $ life_expectancy &lt;dbl&gt; 62.87, 47.50, 35.98, 62.97, 65.39, 66.86, 65.66…<br/>## $ fertility &lt;dbl&gt; 6.19, 7.65, 7.32, 4.43, 3.11, 4.55, 4.82, 3.45,…<br/>## $ population &lt;dbl&gt; 1636054, 11124892, 5270844, 54681, 20619075, 18…<br/>## $ gdp &lt;dbl&gt; NA, 13828152297, NA, NA, 108322326649, NA, NA, …<br/>## $ continent &lt;fct&gt; Europe, Africa, Africa, Americas, Americas, Asi…<br/>## $ region &lt;fct&gt; Southern Europe, Northern Africa, Middle Africa…</code></p><h1 id="f6f8" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">嵌套并不可怕，你的数据也没有消失</h1><p id="cdfa" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><code class="fe mc md me mf b">nest</code>仅在通过<code class="fe mc md me mf b">group_by</code>进行操作时有效。在嵌套数据之前，必须对数据进行分组。通过<code class="fe mc md me mf b">country</code>对<code class="fe mc md me mf b">gapminder</code>进行分组，然后调用<code class="fe mc md me mf b">nest</code>，结果如下:</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="5724" class="mt kh it mf b gy mu mv l mw mx">gapminder_nest &lt;- gapminder %&gt;% <br/>  group_by(country) %&gt;% <br/>  nest()</span><span id="c557" class="mt kh it mf b gy my mv l mw mx">head(gapminder_nest)</span><span id="fe2a" class="mt kh it mf b gy my mv l mw mx">## # A tibble: 6 x 2<br/>## # Groups:   country [185]<br/>##   country                       data<br/>##   &lt;fct&gt;               &lt;list&lt;df[,8]&gt;&gt;<br/>## 1 Albania                   [57 × 8]<br/>## 2 Algeria                   [57 × 8]<br/>## 3 Angola                    [57 × 8]<br/>## 4 Antigua and Barbuda       [57 × 8]<br/>## 5 Argentina                 [57 × 8]<br/>## 6 Armenia                   [57 × 8]</span></pre><p id="754b" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">我第一次用<code class="fe mc md me mf b">nest</code>的时候，就被这个吓坏了。我不是来自编码或 IT 背景，看到<code class="fe mc md me mf b">&lt;list&lt;df[,8]&gt;&gt;</code>足以让我删除代码，并恢复到剪切和粘贴来完成工作。</p><p id="88c7" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">但实际上并不可怕。在这个新创建的名为<code class="fe mc md me mf b">data</code>的列中，你看到的是每个国家整齐排列的健康和收入数据。可以通过调用<code class="fe mc md me mf b">gapminder_nest$data[[x]]</code>来访问它，其中<code class="fe mc md me mf b">x</code>是行。所以要打电话给澳大利亚(我来自的地方)，代码是<code class="fe mc md me mf b">gapminder_nest$data[[8]]</code>。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="a9aa" class="mt kh it mf b gy mu mv l mw mx">gapminder_nest$data[[8]]</span><span id="99d1" class="mt kh it mf b gy my mv l mw mx">## # A tibble: 57 x 8<br/>##     year infant_mortality life_expectancy fertility population     gdp<br/>##    &lt;int&gt;            &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;<br/>##  1  1960             20.3            70.9      3.45   10292328 9.67e10<br/>##  2  1961             20              71.1      3.55   10494911 9.90e10<br/>##  3  1962             19.5            70.9      3.43   10691220 1.00e11<br/>##  4  1963             19.2            71.0      3.34   10892700 1.07e11<br/>##  5  1964             18.8            70.6      3.15   11114995 1.14e11<br/>##  6  1965             18.6            71.0      2.97   11368011 1.21e11<br/>##  7  1966             18.3            70.8      2.89   11657281 1.24e11<br/>##  8  1967             18.3            71.1      2.85   11975795 1.31e11<br/>##  9  1968             18.2            70.7      2.89   12305530 1.38e11<br/>## 10  1969             18.1            71.1      2.89   12621240 1.48e11<br/>## # … with 47 more rows, and 2 more variables: continent &lt;fct&gt;, region &lt;fct&gt;</span></pre><h1 id="723e" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">绘制你的巢穴地图</h1><p id="5fe7" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><code class="fe mc md me mf b">map</code>允许您对数据框中的所有列迭代函数。语法是:<code class="fe mc md me mf b">map(.x, .f)</code>，其中<code class="fe mc md me mf b">.x</code>是要迭代的数据帧，<code class="fe mc md me mf b">.f</code>是函数。嵌套数据的一个小问题是在数据框中有数据框<strong class="lg iu">。在<code class="fe mc md me mf b">gapminder_nest$data</code>列中还有<strong class="lg iu">列数据。</strong></strong></p><p id="f9ae" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">因此，我们需要将<code class="fe mc md me mf b">gapminder_nest$data</code>用作<code class="fe mc md me mf b">.x</code>，而不是在<code class="fe mc md me mf b">map</code>调用中使用<code class="fe mc md me mf b">gapminder_nest</code>作为<code class="fe mc md me mf b">.x</code>。这意味着<code class="fe mc md me mf b">map</code>将迭代每个国家的<strong class="lg iu">嵌套数据框</strong>。</p><p id="dfb4" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">让我们使用嵌套数据和<code class="fe mc md me mf b">map</code>找出 1960 年至 2016 年间每个国家的平均人口。将<code class="fe mc md me mf b">.x</code>设置为<code class="fe mc md me mf b">gapminder_nest$data</code>。这个功能不是简单的<code class="fe mc md me mf b">mean</code>。如果你只是写代码，你的代码会抛出一个错误。记住，列中还有更多列<strong class="lg iu"><code class="fe mc md me mf b">data</code>。我们想要平均人口，所以<code class="fe mc md me mf b">.f</code>的代码是<code class="fe mc md me mf b">~mean(.x$population)</code>。简单地说，这段代码表示迭代所有嵌套的国家数据集，计算每个国家人口列的平均值。不要忘记<code class="fe mc md me mf b">.f</code>代码中的波浪号<code class="fe mc md me mf b">~</code>！</strong></p><p id="ab7e" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">(在下面的代码中，我设置了<code class="fe mc md me mf b">na.rm = T</code>以避免数据缺失的国家/年份出现任何错误)</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="68de" class="mt kh it mf b gy mu mv l mw mx">pop_mean &lt;- map(.x = gapminder_nest$data, .f = ~mean(.x$population, na.rm = T))<br/>head(pop_mean)</span><span id="a539" class="mt kh it mf b gy my mv l mw mx">## [[1]]<br/>## [1] 2708629<br/>## <br/>## [[2]]<br/>## [1] 24231378<br/>## <br/>## [[3]]<br/>## [1] 11909433<br/>## <br/>## [[4]]<br/>## [1] 71053.36<br/>## <br/>## [[5]]<br/>## [1] 31638376<br/>## <br/>## [[6]]<br/>## [1] 2925011</span></pre><h1 id="cd37" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">Mutate 是 nest 和 map 的秘方</h1><p id="9d6b" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">然而，这个输出是非常无用的，因为我们不知道国家名称是什么。一个更简洁的解决方案是<code class="fe mc md me mf b">mutate</code>现有的<code class="fe mc md me mf b">gapminder_nest</code>并添加一个名为<code class="fe mc md me mf b">pop_mean</code>的列。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="12e7" class="mt kh it mf b gy mu mv l mw mx">gapminder_nest &lt;- gapminder_nest %&gt;%<br/>  mutate(pop_mean = map(.x = data, .f = ~mean(.x$population, na.rm = T)))</span><span id="4283" class="mt kh it mf b gy my mv l mw mx">head(gapminder_nest)</span><span id="146a" class="mt kh it mf b gy my mv l mw mx">## # A tibble: 6 x 3<br/>## # Groups:   country [185]<br/>##   country                       data pop_mean <br/>##   &lt;fct&gt;               &lt;list&lt;df[,8]&gt;&gt; &lt;list&gt;   <br/>## 1 Albania                   [57 × 8] &lt;dbl [1]&gt;<br/>## 2 Algeria                   [57 × 8] &lt;dbl [1]&gt;<br/>## 3 Angola                    [57 × 8] &lt;dbl [1]&gt;<br/>## 4 Antigua and Barbuda       [57 × 8] &lt;dbl [1]&gt;<br/>## 5 Argentina                 [57 × 8] &lt;dbl [1]&gt;<br/>## 6 Armenia                   [57 × 8] &lt;dbl [1]&gt;</span></pre><p id="3a2b" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">但这还是不对。我们可以看到国名，但看不到平均人口。这是因为<code class="fe mc md me mf b">map</code>总是返回一个列表，所以平均人口在<code class="fe mc md me mf b">gapminder_nest</code>的嵌套列表中。</p><h1 id="1466" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">渴望成功</h1><p id="3895" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要查看平均人口，只需在您希望可见的列上调用<code class="fe mc md me mf b">unnest</code>，在本例中为<code class="fe mc md me mf b">pop_mean</code>。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="7306" class="mt kh it mf b gy mu mv l mw mx">gapminder_nest %&gt;% <br/>  unnest(pop_mean)</span><span id="a74c" class="mt kh it mf b gy my mv l mw mx">## # A tibble: 185 x 3<br/>## # Groups:   country [185]<br/>##    country                       data  pop_mean<br/>##    &lt;fct&gt;               &lt;list&lt;df[,8]&gt;&gt;     &lt;dbl&gt;<br/>##  1 Albania                   [57 × 8]  2708629.<br/>##  2 Algeria                   [57 × 8] 24231378.<br/>##  3 Angola                    [57 × 8] 11909433.<br/>##  4 Antigua and Barbuda       [57 × 8]    71053.<br/>##  5 Argentina                 [57 × 8] 31638376.<br/>##  6 Armenia                   [57 × 8]  2925011.<br/>##  7 Aruba                     [57 × 8]    74148.<br/>##  8 Australia                 [57 × 8] 16601155.<br/>##  9 Austria                   [57 × 8]  7800180.<br/>## 10 Azerbaijan                [57 × 8]  6897604.<br/>## # … with 175 more rows</span></pre><p id="d9f6" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">瞧啊。为了好玩，这里有一张平均人口最小的 10 个国家的图表。(滚动到代码末尾)</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/66edaa7a6d4ef5ff7fcb680bdd7b60c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fDZUOzyVEnCPMMAlz40Zg.png"/></div></div></figure><h1 id="22ad" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">TLDR；</h1><p id="f6a7" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">结合<code class="fe mc md me mf b">nest</code>和<code class="fe mc md me mf b">map</code>创建高效的代码。然而，对于新手来说，有一些陷阱需要避免:</p><ol class=""><li id="ad53" class="na nb it lg b lh mg ll mh lp nc lt nd lx ne mb nf ng nh ni bi translated">你不能不先打电话给<code class="fe mc md me mf b">group_by</code>就打<code class="fe mc md me mf b">nest</code>。如果不这样做，代码就不知道嵌套基于哪个变量。</li><li id="e0a5" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">你的数据没有消失！要访问嵌套数据框中的任何内容，请调用<code class="fe mc md me mf b">nested_df$data[[x]]</code>，其中<code class="fe mc md me mf b">x</code>是您想要查看的行。</li><li id="d363" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">嵌套数据框中的列有自己的列。是俄罗斯娃娃。</li><li id="dd74" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated"><code class="fe mc md me mf b">map</code>允许您使用函数迭代数据框的列。对于嵌套数据框，列中有列，因此可以编写<code class="fe mc md me mf b">.x = nested_df$data</code>和<code class="fe mc md me mf b">.f = ~some_function(.x$nested_column_inside_data_column)</code>。</li><li id="3faa" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">不要忘记你的地图函数中的波浪符号<code class="fe mc md me mf b">~</code>！不要担心为什么(那是另一个帖子的内容)，去做就是了。</li></ol><h1 id="fea8" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">绘图代码</h1><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="927b" class="mt kh it mf b gy mu mv l mw mx">gapminder_plot &lt;- gapminder_nest %&gt;% <br/>  unnest(pop_mean) %&gt;% <br/>  select(country, pop_mean) %&gt;% <br/>  ungroup() %&gt;% <br/>  top_n(pop_mean, n = -10) %&gt;% <br/>  mutate(pop_mean = pop_mean/10^3)</span><span id="e868" class="mt kh it mf b gy my mv l mw mx">gapminder_plot %&gt;% <br/>  ggplot(aes(x = reorder(country, pop_mean), y = pop_mean)) +<br/>  geom_point(colour = "#FF6699", size = 5) +<br/>  geom_segment(aes(xend = country, yend = 0), colour = "#FF6699") +<br/>  geom_text(aes(label = round(pop_mean, 0)), hjust = -1) +<br/>  theme_minimal() +<br/>  labs(title = "Countries with smallest mean population from 1960 to 2016",<br/>       subtitle = "(thousands)",<br/>       x = "",<br/>       y = "") +<br/>  theme(legend.position = "none",<br/>        axis.text.x = element_blank(),<br/>        plot.title = element_text(size = 14, face = "bold"),<br/>        panel.grid.major.y = element_blank()) +<br/>  coord_flip() +<br/>  scale_y_continuous(limits = c(0, 150))</span></pre></div></div>    
</body>
</html>