<html>
<head>
<title>Query data from S3 files using Amazon Athena</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Amazon Athena 从 S3 文件中查询数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-data-from-s3-files-using-aws-athena-686a5b28e943?source=collection_archive---------3-----------------------#2019-09-24">https://towardsdatascience.com/query-data-from-s3-files-using-aws-athena-686a5b28e943?source=collection_archive---------3-----------------------#2019-09-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2a27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">亚马逊雅典娜被定义为“一种交互式查询服务，它使得使用标准 SQL 直接在亚马逊简单存储服务(亚马逊 S3)中分析数据变得容易。”因此，这是另一个用于存储在 S3 的大型数据集的 SQL 查询引擎。这与其他 SQL 查询引擎非常相似，比如 Apache Drill。但与 Apache Drill 不同，Athena 只能从亚马逊自己的 S3 存储服务中获取数据。然而，Athena 能够查询各种文件格式，包括但不限于 CSV、Parquet、JSON 等。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/9e817de23cbef3b3faa8f944f268b675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*l3DUScBKumyAE1e8dt95vQ.png"/></div></figure></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><p id="a371" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本帖中，我们将看到如何使用存储在 S3 的样本数据集作为<em class="la">在 Athena 中设置一个表。csv </em>文件。但是为此，我们首先需要示例 CSV 文件。你可以在这里下载<a class="ae lb" href="https://blog.contactsunny.com/wp-content/uploads/2020/03/sampleData.csv" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="928d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载完文件后，在 AWS S3 中创建一个新的 bucket。我建议创建一个新的桶，这样你就可以专门使用这个桶来尝试雅典娜。但是您也可以使用任何现有的存储桶。</p><p id="ffd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载完文件后，在 AWS S3 中创建一个新的 bucket。我建议创建一个新的桶，这样你就可以专门使用这个桶来尝试雅典娜。但是您也可以使用任何现有的存储桶。</p><p id="f235" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，现在你已经有了 S3 的文件，打开 Amazon Athena。您可以选择在 Athena 主页上创建一个表。我的看起来有点像下面的截图，因为我已经有几个表了。从截图中可以看出，创建表格有多种选择。在这篇文章中，我们将坚持基本原则，选择“从 S3 桶数据创建表”选项。所以，现在你已经有了 S3 的文件，打开 Amazon Athena。您可以选择在 Athena 主页上创建一个表。我的看起来有点像下面的截图，因为我已经有几个表了。从截图中可以看出，创建表格有多种选择。在这篇文章中，我们将坚持基本原则，选择“从 S3 桶数据创建表”选项。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/8c4eae666fcad45eeb9a54a1047f8262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*JtwoxmLgRQvctzCxGWXqBQ.png"/></div></figure><p id="a0af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择该选项后，您将被重定向到创建表的四步过程。让我们简单地看一下这些步骤。</p><h1 id="a4f0" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">第一步:姓名和地点</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/193022b23bf1d3af10ba9abc3c01c057.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PenjtrHCyYni7RZKBobkqQ.png"/></div></div></figure><p id="9774" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您在上面的屏幕中看到的，在这一步中，我们定义了数据库、表名和 S3 文件夹，该表的数据将来源于该文件夹。如果您已经有一个数据库，您可以从下拉列表中选择它，就像我所做的那样。如果没有，您可以选择从这个屏幕创建一个数据库。</p><p id="5c08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，为表提供一个名称。对于这个例子，我将表格命名为<em class="la"> sampleData </em>，只是为了保持它与我使用的 CSV 文件相同。</p><p id="cb11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，您必须提供存储文件的 S3 文件夹的路径。注意不能提供文件路径，只能提供文件夹路径。因此，该文件夹中具有匹配文件格式的所有文件都将被用作数据源。由于我们只有一个文件，我们的数据将仅限于此。在这篇文章中，我们将忽略加密选项。</p><p id="5fca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还要注意，Athena 不会将这些源文件中的任何数据复制到另一个位置、内存或存储中。每个查询都是针对原始数据集运行的。</p><h1 id="5069" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">第二步:数据格式</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/06909847609b94b640bf39688b144246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*WHMbnrCwVh8FdCHsiXUZEA.png"/></div></figure><p id="6fde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是非常直接的一步。您只需选择数据源的文件格式。因为我们使用的是 CSV 文件，所以我们将选择 CSV 作为数据格式。</p><h1 id="bda0" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">第三步:列</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mh"><img src="../Images/9337ff6eb0e2301d917f8dd4279b7a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fwhcdsvtZAbaGCzxFds8vA.png"/></div></div></figure><p id="f7e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第三步中，我们定义数据集中每个文档/记录的“列”或字段。这是必需的，以便 Athena 知道我们正在处理的数据的模式。此处未定义的任何字段或列，或者名称中有拼写错误(即配置错误)的字段或列，将被忽略并替换为空值。因此，请确保正确配置列。</p><p id="2387" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的数据集有太多的列，并且单独配置它们变得很繁琐，您也可以批量添加列。你会在页面底部找到选项。例如，我们示例中的批量配置如下所示:</p><pre class="km kn ko kp gt mi mj mk ml aw mm bi"><span id="f6c1" class="mn le iq mj b gy mo mp l mq mr">_id string, string1 string, string2 string, double1 double, double2 double</span></pre><p id="ce1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，格式非常简单。您可以指定列名，后跟一个空格，再后跟该列中的数据类型。列定义用逗号分隔。</p><h1 id="a91c" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">第四步:分区</h1><p id="b7cf" class="pw-post-body-paragraph jn jo iq jp b jq ms js jt ju mt jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">这一步有点高级，处理分区。因为我们的数据很小，也因为这超出了这篇文章的范围，我们现在跳过这一步。所以忽略这一步，确认剩下的配置。</p><p id="16e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您的 Athena 查询设置现在已经完成。您将被带到查询页面。这里，您将获得<em class="la"> CREATE TABLE </em>查询，该查询用于创建我们刚刚配置的表。您不必运行这个查询，因为表已经创建并在左窗格中列出。此处显示的查询仅供您参考。也许下次您可以手动创建这个查询，而不是在控制台中经历三到四个步骤。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/a11213213df80215ab726fa294964ec8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*-IovO-jM9zx9ypOSKopv7g.png"/></div></figure><p id="df44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在剩下的就是查询表，看看我们的配置是否合适。为了测试这一点，我们将运行这个简单的 SQL 查询:</p><pre class="km kn ko kp gt mi mj mk ml aw mm bi"><span id="59fe" class="mn le iq mj b gy mo mp l mq mr">select * from sampledata limit 10;</span></pre><p id="ef38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行该查询后，您的输出应该类似于下面的屏幕截图。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi my"><img src="../Images/643534a05fe673a5799f5b8064532a62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N25sCo97Bz_ix8whW4nd9g.png"/></div></div></figure><p id="f1a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们甚至可以在这个数据集上运行聚合查询。这里有几个例子:</p><pre class="km kn ko kp gt mi mj mk ml aw mm bi"><span id="72a7" class="mn le iq mj b gy mo mp l mq mr">select avg(double1) from sampledata;</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/485a5161f7ca9c0ffc2cdf997411e076.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*GnjVp9t1buuk7YqJvy4hyw.png"/></div></figure><pre class="km kn ko kp gt mi mj mk ml aw mm bi"><span id="1005" class="mn le iq mj b gy mo mp l mq mr">select sum(double2) from sampledata limit 20;</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi na"><img src="../Images/79c86a59bbe3226ca14185e45b8653b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*Ojgg9NxlQDeZdiHpfxi0Gw.png"/></div></figure><p id="9377" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">差不多就是这样。现在，您可以在 Athena 的 S3 中对基于文件的数据源运行 SQL 查询。当你必须分析在 S3 以多个文件形式存储的大量数据集时，这非常方便。根据数据在文件中的分布方式和文件格式，您的查询将非常高效。你可以在 S3 查询数百 GB 的数据，并在几秒钟内返回结果。甚至包含多个连接的复杂查询也能很快返回。或许我们改天会更详细地讨论这个问题。</p></div><div class="ab cl kt ku hu kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ij ik il im in"><blockquote class="nb nc nd"><p id="0873" class="jn jo la jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">3 在<a class="ae lb" href="https://twitter.com/contactsunny" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，了解更多<a class="ae lb" href="https://blog.contactsunny.com/tag/data-science" rel="noopener ugc nofollow" target="_blank">数据科学</a>、<a class="ae lb" href="https://blog.contactsunny.com/tag/machine-learning" rel="noopener ugc nofollow" target="_blank">机器学习</a>，以及通用<a class="ae lb" href="https://blog.contactsunny.com/category/tech" rel="noopener ugc nofollow" target="_blank">技术更新</a>。此外，你可以<a class="ae lb" href="https://blog.contactsunny.com/" rel="noopener ugc nofollow" target="_blank">关注我的个人博客</a>，因为我在 Medium 之前发布了许多我的教程、操作方法帖子和机器学习的优点。</p></blockquote><p id="dca3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢我在 Medium 或我的个人博客上的帖子，并希望我继续做这项工作，请考虑在 Patreon 上支持我。</p></div></div>    
</body>
</html>