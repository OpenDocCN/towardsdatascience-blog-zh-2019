<html>
<head>
<title>Understanding FAISS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解失败</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understanding-faiss-619bb6db2d1a?source=collection_archive---------4-----------------------#2019-05-19">https://towardsdatascience.com/understanding-faiss-619bb6db2d1a?source=collection_archive---------4-----------------------#2019-05-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5a9a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak"> …。相似性搜索的世界</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/63c577efab7f210edcbed3a71f2a1588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eiXyXG9e9xMJZG14nAGQjw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">FAISS: Facebook AI Similarity Search</figcaption></figure><p id="a584" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">几周前，我偶然发现了 FAISS——脸书的图书馆，用于对非常大的数据集进行相似性搜索。我的兴趣被激起了，几个小时的网上搜索让我找到了一个知识宝库。在这篇文章中，我希望写下(或者更确切地说，写下)一些与这个库相关的基本概念。在我的<a class="ae lu" href="https://medium.com/dotstar/understanding-faiss-part-2-79d90b1e5388" rel="noopener">后续文章</a>中，我将深入挖掘并探索一些更高级的概念。</p><h1 id="30a3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">相似性搜索和机器学习</h1><p id="01c7" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">通常在相似性搜索中，经常会有一个查询记录与存储的记录数据库(文档或图像等)进行比较。主要目的是检索一组与查询记录相似的数据库记录。所以，如果你有一张狗的图片，相似性搜索应该会给你一个有狗的图片列表(不是彩虹！)在他们身上。</p><p id="6282" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当机器学习出现时，数据库对应于向量的集合。向量可以被视为由机器学习算法生成的输入数据的高维表示。这个上下文中的相似性搜索意味着基于某种相似性或距离度量来搜索给定查询向量的相似向量。</p><p id="652c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">基于相似性进行搜索的一种简单方法是将查询向量与数据库中的所有其他向量进行比较。但是如果数据库有超过一百万个向量呢？输入 FAISS…</p><h1 id="204b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">FAISS 的故事及其倒排索引</h1><p id="bed4" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">FAISS 是一个 C++库(当然有 python 绑定！)当向量的数量可能达到数百万或数十亿时，这确保了更快的相似性搜索。</p><p id="5ab5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它的核心是索引。请注意，索引无处不在！(尽管形式和名称不同)。在这篇文章中，我将详细阐述一个:“倒排文件索引”或“试管婴儿”</p><p id="67c8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我告诉你一个小故事(请在这里耐心听我说，我保证它很重要……)</p><p id="db15" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Someland 的女王刚刚征服了一片新的领土，发现这片土地上的土著被隔离在三个不同的部落中，他们根本无法相互容忍。因此，为了避免争斗，她决定为每个部落建立三个独立的城市。有趣的是，每个部落都有一套独特的技能。这有助于女王识别一个人属于哪个部落。格林一家似乎生来就擅长园艺，大部分时间都在照料植物。廷克一家是聪明、善于分析的一群人，主要由建筑师、建筑商和科学家组成。最后，还有创意奇思妙想，他们以精通美术而闻名。他们大多是诗人、舞蹈家或艺术家。</p><p id="c74f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">城市建成了，部落首领被任命为各自部落的代表。出于行政管理的目的，女王的大臣们保留了一本“总名册”，记录了部落首领的名字以及每个城市的市民的名字。</p><p id="6a43" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一天，一群旅行者来到这个王国，请求避难。女王现在遇到了一个问题。她必须找到合适的志愿者，他们会同意让旅行者住在他们家里。(显然王国里没有客栈)。她知道市民们相当谨慎，只对与他们志趣相投的人感兴趣。</p><p id="30fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">终于找到了解决办法。对于每个旅行者，酋长根据旅行者的特征与部落特征的匹配程度来决定他或她属于哪个部落。当旅行者到达他们各自的城市时，一些市民走出来，自愿为其中一位旅行者提供住宿，因为他们觉得这位旅行者的特点与他们的相符。嗯…问题解决了！(女王现在可以安心睡觉了)。</p><p id="344c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">维奥拉。我刚刚给了你一个倒排索引如何工作的鸟瞰图。</p><h1 id="63d0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">技术细节…</h1><p id="e635" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我们用上面的故事打个比方。</p><p id="3eb2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">王国的所有公民都是数据库中的向量，三个部落对应于三个独立的“集群”或“细胞”。然后，根据某种相似性度量，将向量分配给这三个聚类之一。(还记得不同的部落使用不同的技能使他们彼此区分开来吗？).通常，L2 距离测量以及类似 K-means 的聚类算法被用于此。</p><p id="6a5d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就像我们故事中的部落酋长一样，每个集群都由一个集群质心或“代码”来表示。就像部长们的“主书”一样，维护着一个单独的“码本”,它记录着每个簇的代码(或簇形心)及其相应的向量。这实质上是“倒排文件”或索引。</p><p id="29fb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">量化器用于决定向量属于哪个簇(我猜这主要是女王的工作)。因此，当一个查询向量进来时(就像我们故事中的旅行者)，会根据它与聚类中心的相似性为查询向量找到一个合适的聚类(就像部落酋长根据他们的特征选择旅行者一样)。最后，在所选聚类中选择数量的相似向量作为查询结果返回(如自愿为旅行者提供住宿的城市居民)。这可以看作是倒排索引的一个非常基本的工作。</p><h1 id="c4f0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">和一些代码…</h1><p id="9d53" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">首先，用 python 绑定安装 FAISS 库。请按照以下网址给出的说明操作:<a class="ae lu" href="https://github.com/facebookresearch/faiss/blob/master/INSTALL.md" rel="noopener ugc nofollow" target="_blank">https://github . com/Facebook research/faiss/blob/master/install . MD</a></p><p id="29b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，使用以下命令导入 python 中的库和其他依赖项:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="a8ea" class="mx lw it mt b gy my mz l na nb">import numpy as np </span><span id="5d1b" class="mx lw it mt b gy nc mz l na nb">import faiss  # this will import the faiss library</span></pre><p id="ec64" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们为数据库创建一些向量。FAISS 要求预先定义数据库向量的维度。我们创建了大约 200 个维数为 128 的向量。这将创建一个(200 * 128)矢量矩阵。请注意，所有向量值都存储在 float 32 类型中。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="567d" class="mx lw it mt b gy my mz l na nb">dimension = 128    # dimensions of each vector                         </span><span id="bc0c" class="mx lw it mt b gy nc mz l na nb">n = 200    # number of vectors                   </span><span id="abdb" class="mx lw it mt b gy nc mz l na nb">np.random.seed(1)             </span><span id="a16e" class="mx lw it mt b gy nc mz l na nb">db_vectors = np.random.random((n, dimension)).astype('float32')</span></pre><p id="a031" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们对向量使用“IndexIVFFlat”索引类型。这里的“平坦”表示矢量被原样存储，没有任何压缩或量化(稍后将详细介绍)。试管婴儿指数有两个参数:</p><ul class=""><li id="0a06" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated">nlist:指定要形成的簇的数量</li><li id="d976" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">量化器:将向量分配给特定的簇。这通常是另一个使用 L2 距离度量的指数(我们使用 FlatL2 指数)</li></ul><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="409d" class="mx lw it mt b gy my mz l na nb">nlist = 5  # number of clusters</span><span id="62c7" class="mx lw it mt b gy nc mz l na nb">quantiser = faiss.IndexFlatL2(dimension)  </span><span id="4181" class="mx lw it mt b gy nc mz l na nb">index = faiss.IndexIVFFlat(quantiser, dimension, nlist,   faiss.METRIC_L2)</span></pre><p id="b595" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">必须首先训练索引以创建“nlist”个聚类，然后将向量添加到这些聚类中。“is_trained”标志表示索引是否被训练,“ntotal”属性显示添加到索引的向量的总数。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="2b40" class="mx lw it mt b gy my mz l na nb">print(index.is_trained)   # False</span><span id="60b5" class="mx lw it mt b gy nc mz l na nb">index.train(db_vectors)  # train on the database vectors</span><span id="5ac2" class="mx lw it mt b gy nc mz l na nb">print(index.ntotal)   # 0</span><span id="7e46" class="mx lw it mt b gy nc mz l na nb">index.add(db_vectors)   # add the vectors and update the index</span><span id="5726" class="mx lw it mt b gy nc mz l na nb">print(index.is_trained)  # True</span><span id="1d92" class="mx lw it mt b gy nc mz l na nb">print(index.ntotal)   # 200</span></pre><p id="57a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们在索引上搜索 10 个查询向量。“nprobe”参数指定在搜索操作期间要访问的集群数。这可以被视为超参数，可以对其进行调整以获得不同的结果。请注意，“nprobe”不能超过“nlist”。</p><p id="4abe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">“k”指定了从被访问的聚类中返回的相似向量的数量。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c172" class="mx lw it mt b gy my mz l na nb">nprobe = 2  # find 2 most similar clusters</span><span id="be5c" class="mx lw it mt b gy nc mz l na nb">n_query = 10  </span><span id="c85f" class="mx lw it mt b gy nc mz l na nb">k = 3  # return 3 nearest neighbours</span><span id="4629" class="mx lw it mt b gy nc mz l na nb">np.random.seed(0)   </span><span id="b78a" class="mx lw it mt b gy nc mz l na nb">query_vectors = np.random.random((n_query, dimension)).astype('float32')</span><span id="4ecb" class="mx lw it mt b gy nc mz l na nb">distances, indices = index.search(query_vectors, k)</span></pre><p id="9311" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">搜索操作将返回每个查询向量的 k 个最相似向量的 id(向量存储中的行号或索引)以及它们各自的距离。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ef2d" class="mx lw it mt b gy my mz l na nb">distances:</span><span id="b20f" class="mx lw it mt b gy nc mz l na nb"> [[15.770459 16.773014 17.17131  17.439615 17.443993]</span><span id="5c9a" class="mx lw it mt b gy nc mz l na nb"> [16.476107 18.52229  18.811913 18.974785 19.02668 ]</span><span id="fbd4" class="mx lw it mt b gy nc mz l na nb"> [15.520995 16.500256 17.069542 17.483345 17.742079]</span><span id="393d" class="mx lw it mt b gy nc mz l na nb"> [16.842718 17.712341 17.828487 18.699772 19.345257]</span><span id="4742" class="mx lw it mt b gy nc mz l na nb"> [18.325392 18.495464 18.684456 18.70239  18.904179]</span><span id="ed5d" class="mx lw it mt b gy nc mz l na nb"> [17.531885 18.18179  18.331263 19.429993 19.700233]</span><span id="27cf" class="mx lw it mt b gy nc mz l na nb"> [16.840158 17.03664  17.091755 17.34306  17.487806]</span><span id="04a4" class="mx lw it mt b gy nc mz l na nb"> [15.984037 16.380917 17.270592 17.620832 17.663855]</span><span id="2f91" class="mx lw it mt b gy nc mz l na nb"> [18.018503 18.0761   18.766172 18.956903 18.985767]</span><span id="7b0c" class="mx lw it mt b gy nc mz l na nb"> [17.113918 17.385284 17.65757  18.122086 18.170212]]</span><span id="5aae" class="mx lw it mt b gy nc mz l na nb">indices:</span><span id="b908" class="mx lw it mt b gy nc mz l na nb"> [[185  35  96  80  75]</span><span id="5596" class="mx lw it mt b gy nc mz l na nb"> [118  51 122 108  31]</span><span id="f81b" class="mx lw it mt b gy nc mz l na nb"> [148 149 173  27  84]</span><span id="1d43" class="mx lw it mt b gy nc mz l na nb"> [175 177  50  38  81]</span><span id="5573" class="mx lw it mt b gy nc mz l na nb"> [ 44 144 174 105  70]</span><span id="ffc1" class="mx lw it mt b gy nc mz l na nb"> [156  74 151 167 182]</span><span id="cc7e" class="mx lw it mt b gy nc mz l na nb"> [ 57 144  18 174  74]</span><span id="4655" class="mx lw it mt b gy nc mz l na nb"> [ 82  12  46  64 127]</span><span id="6d0c" class="mx lw it mt b gy nc mz l na nb"> [ 52  73  59 138 131]</span><span id="f11c" class="mx lw it mt b gy nc mz l na nb"> [ 82  46  90  37 179]]</span></pre><p id="ee06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以使用 write_index()函数将索引保存在磁盘上，以后可以使用 read_index()函数加载索引</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="3f5a" class="mx lw it mt b gy my mz l na nb">faiss.write_index(index,"vector.index")  # save the index to disk</span><span id="c37f" class="mx lw it mt b gy nc mz l na nb">index = faiss.read_index("vector.index")  # load the index</span></pre><p id="f485" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">那里！理解 faiss 索引的基本代码！</p><h1 id="301b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">FAISS 还提供什么？</h1><p id="9cf8" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">FAISS 有一些功能，包括:</p><ul class=""><li id="7d5c" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated">GPU 和多线程对索引操作的支持</li><li id="7490" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">降维:使用主成分分析可以将维数较大的向量降维</li><li id="0977" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">量化:FAISS 强调压缩和存储大规模向量的产品量化</li><li id="9b8d" class="nd ne it la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated">批处理，即一次搜索多个查询</li></ul><h1 id="f400" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">这个可以用在哪里？</h1><p id="a413" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">相似性搜索和信息检索是老朋友了！图像检索或文档检索甚至推荐系统都使用相似性搜索。比方说，你在网上购买某个品牌的手表时，在你的推荐列表中看到各种性质相似的手表。</p><p id="336f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另一个探索的途径是分类。例如，如果我们以陈词滥调的“猫和狗”图像识别为例，我们实际上可以预测给定的查询图像是猫还是狗，这取决于从猫和狗图像的数据库返回的最相似的图像(嗯…这绝对是另一个帖子！)</p><h1 id="bc64" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">最后的想法</h1><p id="49e3" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我觉得我几乎没有触及表面！FAISS 是一个有趣的图书馆，肯定还有很多值得探索的地方。将所有内容都压缩在一篇文章中可能会让你滚动很长时间！因此，我的<a class="ae lu" href="https://medium.com/dotstar/understanding-faiss-part-2-79d90b1e5388" rel="noopener">下一篇文章</a>将进一步深入这个库，并解释一个叫做产品量化的高级概念。</p><h1 id="d7d1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考资料:</h1><div class="nr ns gp gr nt nu"><a href="https://github.com/facebookresearch/faiss/wiki" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">facebookresearch/faiss</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">一个用于高效相似性搜索和密集向量聚类的库。- facebookresearch/faiss</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">github.com</p></div></div><div class="od l"><div class="oe l of og oh od oi ks nu"/></div></div></a></div></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><p id="44af" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！！！</p></div></div>    
</body>
</html>