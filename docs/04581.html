<html>
<head>
<title>Forecast Model Tuning with Additional Regressors in Prophet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">先知中使用附加回归器的预测模型调整</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/forecast-model-tuning-with-additional-regressors-in-prophet-ffcbf1777dda?source=collection_archive---------3-----------------------#2019-07-14">https://towardsdatascience.com/forecast-model-tuning-with-additional-regressors-in-prophet-ffcbf1777dda?source=collection_archive---------3-----------------------#2019-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5d27" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何在先知模型中添加回归因子以提高预测精度的说明</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0a7252ad06a587fd0268a4754187824a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*430pxh1pvfrMhC7GAORSDw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Use case — bike rental (picture source: Pixabay)</figcaption></figure><p id="0f4c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我将把我的实验结果分享给<a class="ae lr" href="https://facebook.github.io/prophet/docs/seasonality,_holiday_effects,_and_regressors.html#additional-regressors" rel="noopener ugc nofollow" target="_blank">预言家附加回归器</a>。我的目标是检查额外的回归将如何影响先知计算的预测。</p><p id="dc89" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用来自 Kaggle 的数据集— <a class="ae lr" href="https://www.kaggle.com/marklvl/bike-sharing-dataset" rel="noopener ugc nofollow" target="_blank">华盛顿州的自行车共享数据集</a>。数据附带了每天自行车租金和天气情况的数字。我创建并比较了三个模型:</p><ol class=""><li id="50b2" class="ls lt iq kx b ky kz lb lc le lu li lv lm lw lq lx ly lz ma bi translated">带有自行车租赁日期和数量的时间序列先知模型</li><li id="c1d9" class="ls lt iq kx b ky mb lb mc le md li me lm mf lq lx ly lz ma bi translated">带有附加回归器的模型——天气温度</li><li id="c765" class="ls lt iq kx b ky mb lb mc le md li me lm mf lq lx ly lz ma bi translated">带有附加回归器 s 的模型——天气温度和状态(下雨、晴天等)。)</li></ol><p id="05bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们应该看到回归的效果，并比较这三个模型。</p><p id="519f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">预测是为未来 10 天计算的。数据集中的最后一天是 2012 年 12 月 31 日，这意味着预测从 2013 年 1 月 1 日开始。</p><p id="3c4b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> A .无附加回归器的模型</strong></p><p id="7b03" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从 2013 年 1 月 1 日开始的自行车租赁预测值:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/b3b46b66ab9bf6e88a835d709a1bab27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TBcYdmFCvRy0bd-BdSI2Hw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Bike rentals forecast for the next ten days</figcaption></figure><p id="06cd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> B .带附加回归器的模型-天气温度</strong></p><p id="b55c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">回归器的值必须在过去和将来都是已知的，这是它如何帮助先知调整预测的。未来值必须是预定义的和已知的(例如，在特定日期发生的特定事件)，或者应该在其他地方预测。就我们的情况而言，我们使用的是天气温度预报，可以从天气频道获得。</p><p id="baf3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">回归器的值必须与时间序列数据位于同一数据框中。我复制了一个要定义为索引列的日期列:</p><pre class="kg kh ki kj gt mh mi mj mk aw ml bi"><span id="d28b" class="mm mn iq mi b gy mo mp l mq mr">df = pd.read_csv('weather_day.csv')<br/>df = df[['dteday', 'cnt', 'temp']].dropna()</span><span id="852f" class="mm mn iq mi b gy ms mp l mq mr">d_df['date_index'] = d_df['dteday']<br/>d_df['date_index'] = pd.to_datetime(d_df['date_index'])<br/>d_df = d_df.set_index('date_index')</span></pre><p id="198b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要构建未来十天的数据框架——从 2013 年 1 月 1 日到 2001 年 10 天创建熊猫数据框架，并使用温度预测(标准化值)初始化每个元素:</p><pre class="kg kh ki kj gt mh mi mj mk aw ml bi"><span id="8ee9" class="mm mn iq mi b gy mo mp l mq mr">t = 13<br/>min_t = -8<br/>max_t = 39<br/>n_t = (t - min_t)/(max_t - min_t)<br/>print(n_t)</span><span id="655f" class="mm mn iq mi b gy ms mp l mq mr">future_range = pd.date_range('2013-01-01', periods=10, freq='D')<br/>future_temp_df = pd.DataFrame({ 'future_date': future_range, 'future_temp' : 0})</span><span id="bc76" class="mm mn iq mi b gy ms mp l mq mr">future_temp_df['future_date'] = pd.to_datetime(future_temp_df['future_date'])<br/>future_temp_df = future_temp_df.set_index('future_date')</span><span id="f282" class="mm mn iq mi b gy ms mp l mq mr">future_temp_df.at['2013-01-01', 'future_temp'] = 0.319148<br/>future_temp_df.at['2013-01-02', 'future_temp'] = 0.255319<br/>future_temp_df.at['2013-01-03', 'future_temp'] = 0.234042<br/>future_temp_df.at['2013-01-04', 'future_temp'] = 0.319148<br/>future_temp_df.at['2013-01-05', 'future_temp'] = 0.340425<br/>future_temp_df.at['2013-01-06', 'future_temp'] = 0.404255<br/>future_temp_df.at['2013-01-07', 'future_temp'] = 0.361702<br/>future_temp_df.at['2013-01-08', 'future_temp'] = 0.404255<br/>future_temp_df.at['2013-01-09', 'future_temp'] = 0.425531<br/>future_temp_df.at['2013-01-10', 'future_temp'] = 0.446808</span><span id="9cde" class="mm mn iq mi b gy ms mp l mq mr">future_temp_df.tail(10)</span></pre><p id="8ad0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在下面的代码中，我添加了天气温度的回归器。如果日期属于训练集，则从训练集返回温度，否则从未来预测数据框(上面构建的数据框)返回温度。未来十天的期限已经设定。先知模型是用<em class="mt">拟合</em>函数构建的，调用预测函数来计算预测:</p><pre class="kg kh ki kj gt mh mi mj mk aw ml bi"><span id="56bb" class="mm mn iq mi b gy mo mp l mq mr">def weather_temp(ds):<br/>    date = (pd.to_datetime(ds)).date()<br/>    <br/>    if d_df[date:].empty:<br/>        return future_temp_df[date:]['future_temp'].values[0]<br/>    else:<br/>        return (d_df[date:]['temp']).values[0]<br/>    <br/>    return 0</span><span id="a6c3" class="mm mn iq mi b gy ms mp l mq mr">m = Prophet()<br/>m.add_regressor('temp')<br/>m.fit(d_df)</span><span id="3af9" class="mm mn iq mi b gy ms mp l mq mr">future = m.make_future_dataframe(periods=10)<br/>future['temp'] = future['ds'].apply(weather_temp)</span><span id="867b" class="mm mn iq mi b gy ms mp l mq mr">forecast = m.predict(future)<br/>forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail(15)</span></pre><p id="5a2e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从 2013 年 1 月 1 日开始，自行车租赁的预测值，以及附加的温度回归器。天气预报显示气温良好，预计 1 月份天气温暖，这有助于将自行车租赁数量调整到更高水平(如果天气温度良好，自然会有更多的租赁):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/511ba0e82b71eede289749f270825d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pvg2_mpRCDY6VN7DvshAsg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Bike rentals forecast for the next ten days, with temperature regressor</figcaption></figure><p id="f417" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> C .具有两个附加回归因子的模型-天气温度和条件</strong></p><p id="76e8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">数据集包含相当多的描述天气的属性，使用更多的这些属性将有助于计算更准确的自行车租赁预测。我将展示增加一个回归变量如何改变预测。</p><pre class="kg kh ki kj gt mh mi mj mk aw ml bi"><span id="c28e" class="mm mn iq mi b gy mo mp l mq mr">def weather_temp(ds):<br/>    date = (pd.to_datetime(ds)).date()<br/>    <br/>    if d_df[date:].empty:<br/>        return future_temp_df[date:]['future_temp'].values[0]<br/>    else:<br/>        return (d_df[date:]['temp']).values[0]<br/>    <br/>    return 0</span><span id="dd2f" class="mm mn iq mi b gy ms mp l mq mr">def weather_condition(ds):<br/>    date = (pd.to_datetime(ds)).date()<br/>    <br/>    if d_df[date:].empty:<br/>        return future_temp_df[date:]['future_weathersit'].values[0]<br/>    else:<br/>        return (d_df[date:]['weathersit']).values[0]<br/>    <br/>    return 0</span><span id="ad0c" class="mm mn iq mi b gy ms mp l mq mr">m = Prophet()<br/>m.add_regressor('temp')<br/>m.add_regressor('weathersit')<br/>m.fit(d_df)</span><span id="6e55" class="mm mn iq mi b gy ms mp l mq mr">future = m.make_future_dataframe(periods=10)<br/>future['temp'] = future['ds'].apply(weather_temp)<br/>future['weathersit'] = future['ds'].apply(weather_condition)</span><span id="27d1" class="mm mn iq mi b gy ms mp l mq mr">forecast = m.predict(future)<br/>forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail(15)</span></pre><p id="5103" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用上述代码添加了额外的回归变量—天气条件(数据集中的 check <em class="mt"> weathersit </em>属性)以及天气温度回归变量。出于测试的目的，我将未来十天的天气条件设置为 4(这意味着天气不好)。即使一月份的天气温度在上升(这对自行车租赁来说是好事)，整体天气还是很糟糕(这应该会减少自行车租赁的数量)。</p><p id="bfe9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用第二个回归变量(指向预期的坏天气)，Prophet 返回较小的预期自行车租赁数量:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/f80492eb62dc7b90320a80aae0a4dce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F_6xyDE8eI3daqJlWT7ToQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Bike rentals forecast for the next ten days, with temperature regressor and weather condition</figcaption></figure><p id="bdbf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">总结</strong>:在 Prophet 中，附加回归量功能对于精确预测计算非常重要。它有助于调整预测的构建方式，并使预测过程更加透明。回归量必须是过去已知的变量，并且是已知的(或对未来单独预测的)。</p><p id="737c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">资源:</p><ul class=""><li id="94c1" class="ls lt iq kx b ky kz lb lc le lu li lv lm lw lq mw ly lz ma bi translated">GitHub <a class="ae lr" href="https://github.com/abaranovskis-redsamurai/automation-repo/tree/master/forecast" rel="noopener ugc nofollow" target="_blank">回购</a>与源代码</li><li id="bfa1" class="ls lt iq kx b ky mb lb mc le md li me lm mf lq mw ly lz ma bi translated">我以前的一篇关于同一主题的文章— <a class="ae lr" rel="noopener" target="_blank" href="/serving-prophet-model-with-flask-predicting-future-1896986da05f">用烧瓶为先知模型服务—预测未来</a></li></ul></div></div>    
</body>
</html>