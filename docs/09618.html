<html>
<head>
<title>Predicting MLB Pitch Probability Based on the Game Situation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于比赛情况预测 MLB 投球概率</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-mlb-pitch-probability-based-on-the-game-situation-1afc5a01cf3?source=collection_archive---------34-----------------------#2019-12-17">https://towardsdatascience.com/predicting-mlb-pitch-probability-based-on-the-game-situation-1afc5a01cf3?source=collection_archive---------34-----------------------#2019-12-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/9ad890604deed6f3cc2b3e9e036acb4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kmZupHAm_2UssLRheR3yVA.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Can we determine what this pitch will be before it is thrown?</figcaption></figure><div class=""/><p id="3237" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">对许多人来说，棒球是一项很棒的运动。这是第一个想到利用数据在各个层面做出决策的运动之一。经理使用数据做出游戏决策，总经理使用数据决定合同支出。</p><p id="f4c7" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">棒球也是最早将统计数据纳入电视转播内容的运动之一。实时投球速度，投球位置，得分概率和偷垒概率。这些只是观众在观看这项全国性娱乐节目时可以吸收的一些东西。随着最近人工智能的加入，更多的预测和实时内容可用。</p><figure class="le lf lg lh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ld"><img src="../Images/d5afffdc29338be4b389d530108ed00d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5n7pAgEABh0fJBYvAfZ76g.jpeg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Pitch location is just one of the many AI uses of real-time mediated content</figcaption></figure><p id="cbf2" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">作为一个游戏爱好者，我想深入到一个目前还不属于本内容的领域，但在未来将会是:根据游戏情况预测接下来会有什么样的投球。我对最初的结果感到非常兴奋。</p><p id="06fd" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">第一，数据。Kaggle 提供了一个数据集，其中包含 2015-2018 赛季在<a class="ae li" href="https://www.kaggle.com/pschale/mlb-pitch-data-20152018" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/pschale/mlb-pitch-data-20152018</a>的所有球场数据。数据来自几个方面。csv 文件包括投球，击球，比赛，弹射和球员姓名。为了达到我们的目标，只使用了击球和投球数据集。</p><p id="f7af" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">以下是加载到笔记本中的包</p><pre class="le lf lg lh gt lj lk ll lm aw ln bi"><span id="6f2e" class="lo lp ji lk b gy lq lr l ls lt">import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import seaborn as sns<br/>from sklearn.preprocessing import RobustScaler, LabelEncoder<br/>from sklearn.model_selection import train_test_split, cross_val_score<br/>from sklearn.metrics import accuracy_score, f1_score, confusion_matrix, classification_report, precision_score<br/>import xgboost as xgb<br/>from keras.utils.np_utils import to_categorical<br/>import random<br/>from keras import models, layers, optimizers, regularizers<br/>from keras.layers import Embedding, GRU, Dropout, GlobalMaxPool1D, Dense<br/>from sklearn.model_selection import GridSearchCV</span></pre><p id="2eef" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">读入数据并将两个数据集合并在一起(在 ab_id 上)后，第一个障碍是要处理的数据量。从 2015 年到 2018 年，记录了超过 280 万次投球。出于计算费用和最相关数据的目的，数据集被缩减为仅反映 2018 赛季。</p><pre class="le lf lg lh gt lj lk ll lm aw ln bi"><span id="5572" class="lo lp ji lk b gy lq lr l ls lt">#isolating the data that only contains the 2018 season<br/>data18 = data[data['year'] == '2018']</span></pre><p id="22c5" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这仍然提供了超过 70 万次的观测。现在，有超过 40 列，其中许多包含俯仰速度，轨迹和位置信息。这些对我们预测下一次投球没有任何好处，因为在那个时候，投球已经投出了。我们关心的是所有可能有助于投球的信息，所以我们将只保留我们需要的信息:</p><ul class=""><li id="8fad" class="lu lv ji kh b ki kj km kn kq lw ku lx ky ly lc lz ma mb mc bi translated">pitch_type —音高的类型。这是我们的目标</li><li id="eb5d" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">b_score —击球手所在队的得分</li><li id="6d74" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">b_count —当前计数中的球</li><li id="3039" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">s_count —当前计数中的打击数</li><li id="66bb" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">出局数——出局数(投球前)</li><li id="0443" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">投球数——击球时的投球数</li><li id="fc7b" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">on_1b —如果第一个上有跑步者，则为 True，如果为空，则为 False</li><li id="206f" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">on_2b —如果二垒上有跑垒者，则为真；如果二垒上没有跑垒者，则为假</li><li id="1686" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">on_3b —如果三垒上有跑垒员，则为真，如果为空，则为假</li><li id="59dc" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">击球手 id —击球手的球员 id。由 MLB 提供，在 player_names.csv 中找到的球员姓名</li><li id="016c" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">第一局——第几局</li><li id="df38" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">p_score —投手队的得分</li><li id="3894" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">p _ throws——投手用哪只手投球。单个字符，R 或 L</li><li id="6fc7" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">pitcher_id —投手的玩家 id。</li><li id="6767" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">站立——击球手击中哪一方。单个字符，R 或 L</li><li id="3b0d" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">topTrue 如果是一局的开始，如果是结束，则为 False</li></ul><pre class="le lf lg lh gt lj lk ll lm aw ln bi"><span id="f1cb" class="lo lp ji lk b gy lq lr l ls lt">#new dataframe with what is initially determined as situational + the target (pitch_type)</span><span id="3c1d" class="lo lp ji lk b gy mi lr l ls lt">pXs = pd.DataFrame(data18[['pitch_type', 'b_score', 's_count', 'outs', 'pitch_num', 'on_1b', 'on_2b', 'on_3b', 'batter_id', 'inning', 'p_score', 'p_throws','pitcher_id', 'stand', 'top', 'b_count']])</span></pre><p id="48df" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这些是我们将瞄准的推销类型:</p><ul class=""><li id="b263" class="lu lv ji kh b ki kj km kn kq lw ku lx ky ly lc lz ma mb mc bi translated">CH —变速</li><li id="5862" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">CU —弧线球</li><li id="4ec2" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">FC —刀具</li><li id="7318" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">FF——四缝线快速球</li><li id="b4a7" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">FS —拆分器</li><li id="7f93" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">双缝线快速球</li><li id="2104" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">KC —关节曲线</li><li id="7c7f" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">KN——球</li><li id="2e79" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">SI —沉降片</li><li id="0b0d" class="lu lv ji kh b ki md km me kq mf ku mg ky mh lc lz ma mb mc bi translated">SL —滑块</li></ul><p id="34f2" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">数据集中还有其他类型的音高，但只占总观测值的不到 0.1%(投球、螺旋球或罕见的以弗所音高)。这些都从数据集中删除，布尔和二进制对象转换为整数和空删除(代表不到 1%的总数据)。</p><p id="440b" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">看一下数据本身，数据中的异常值代表了局数和得分。这是典型的加时赛，但不像高分比赛那样频繁。得分和局数确实与投球有关，所以删除它们可能会对结果产生负面影响，所以那些异常值被保留了下来。</p><figure class="le lf lg lh gt iv gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/1176e33645508cb62202e3429270063a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*Ot1PkM2Qxxe3vM8XC_CHPA.png"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Outliers for batters score, pitch number and on second base</figcaption></figure><figure class="le lf lg lh gt iv gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/3cdd22057d6e111856f617590f0af1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*IEaKSEokWWNFdt3whT9SRg.png"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">outliers for inning and pitchers score</figcaption></figure><p id="2852" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">检查多重共线性，发现球场数与球数和击球数高度正相关。，因此将其从数据集中移除。</p><figure class="le lf lg lh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mk"><img src="../Images/1c426ebbcc2610e762e72492485c5c22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qOEYWVl0tJ_g-yhQlWtpHQ.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Multicollinearity of pitch_num</figcaption></figure><p id="8407" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在这一点上，执行了几个测试模型和试验，但是在这一点上，超调 XGBoostClassifier 为我们的数据提供了最好的结果。</p><pre class="le lf lg lh gt lj lk ll lm aw ln bi"><span id="ac89" class="lo lp ji lk b gy lq lr l ls lt">X_train, X_test, y_train, y_test = train_test_split(features2, target2, test_size=0.30)</span><span id="4886" class="lo lp ji lk b gy mi lr l ls lt">#create xgb instance with parameters<br/>clf = xgb.XGBClassifier(learning_rate=0.1,max_depth=10,min_child_weight=15,n_estimators=250)</span><span id="efb1" class="lo lp ji lk b gy mi lr l ls lt">#fit data<br/>clf.fit(X_train, y_train)</span><span id="acee" class="lo lp ji lk b gy mi lr l ls lt">#make predictions<br/>training_preds = clf.predict(X_train)<br/>val_preds = clf.predict(X_test)</span><span id="debc" class="lo lp ji lk b gy mi lr l ls lt">#run classification report and confusion matrix<br/>gbt_confusion_matrix = confusion_matrix(y_test, val_preds)<br/>print(gbt_confusion_matrix)<br/>gbt_classification_report = classification_report(y_test, val_preds)<br/>print(gbt_classification_report)</span></pre><figure class="le lf lg lh gt iv gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/cd82a96edb7f8cca6fe099118a3dbbf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*tDYV-08HWCoTjJc19csS8g.png"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Classification Report for hypertuned XGBoostClassifier</figcaption></figure><p id="b4d9" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这是一个彻底的分类，因此在 11 种音高类型上获得 51%的总体准确率是很好的。然而，将这一点转化为实际的游戏，只在一半的时间里获得正确的音高对于现场消费来说并不是最佳的。在这一点上决定，也许预测每个投球的概率会更有益。幸运的是，XGBoost 的包中有一个概率选项，只需将目标切换到 multi:softprob。</p><pre class="le lf lg lh gt lj lk ll lm aw ln bi"><span id="ef32" class="lo lp ji lk b gy lq lr l ls lt">le = LabelEncoder()<br/>le.fit(target3)<br/>target_num = le.transform(target3)</span><span id="47ec" class="lo lp ji lk b gy mi lr l ls lt"># list(le.inverse_transform(target_num)) #If you wish to retrieve the original descriptive labels post production</span><span id="597e" class="lo lp ji lk b gy mi lr l ls lt">X_train, X_test, y_train, y_test = train_test_split(features3, target_num, test_size=0.3, random_state=42)</span><span id="92d0" class="lo lp ji lk b gy mi lr l ls lt"># use DMatrix for xgboost<br/>dtrain = xgb.DMatrix(X_train, label=y_train)<br/>dtest = xgb.DMatrix(X_test, label=y_test)<br/>fit = xgb.XGBClassifier(objective = 'multi:softprob')<br/>fit.fit(X_train,y_train)</span><span id="7610" class="lo lp ji lk b gy mi lr l ls lt"># set xgboost params<br/>param = {<br/>'max_depth': 10,  # the maximum depth of each tree<br/>'learning_rate': 0.1,  # the training step for each iteration<br/>'min_child_weight': 20,<br/>'n_estimators': 300,<br/>'objective': 'multi:softprob',  # error evaluation for multiclass training<br/>'num_class': 10}  # the number of classes that exist in this datset<br/>num_rounds=30</span><span id="6997" class="lo lp ji lk b gy mi lr l ls lt">#------------- numpy array ------------------</span><span id="624b" class="lo lp ji lk b gy mi lr l ls lt">#training and testing - numpy matrices<br/>bst = xgb.train(param, dtrain,num_rounds)<br/>preds = bst.predict(dtest)</span><span id="3761" class="lo lp ji lk b gy mi lr l ls lt">#extracting most confident predictions<br/>best_preds = np.asarray([np.argmax(line) for line in preds])print ("Numpy array test precision:", precision_score(y_test, best_preds, average='macro'))</span></pre><figure class="le lf lg lh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mm"><img src="../Images/a3110a90a2a4a4369978b1e33762da5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HvvWEmF4ZXdOUAt0YrlwSg.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Probability predictions for each observation (example)</figcaption></figure><p id="58fb" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们将 dataframe 转换为 numpy 数组进行计算，因此为了可视化结果，有必要将数据转换回 dataframe，并使用 matplotlib 重新标记列以创建一个视图。</p><pre class="le lf lg lh gt lj lk ll lm aw ln bi"><span id="08ac" class="lo lp ji lk b gy lq lr l ls lt">#creating a dataframe for plotting purposes<br/>plot = pd.DataFrame(data=preds[:,:], columns=['Changeup', 'Curveball', 'Cutter', 'Fastball_4S', 'Splitter', 'Fastball_2S', 'Knucklecurve', 'Knuckleball', 'Sinker', 'Slider'])</span><span id="9e03" class="lo lp ji lk b gy mi lr l ls lt">#visualization function<br/>    def pitch_pred(data):<br/>    print(X_test.iloc[data])<br/>    ax = plot.iloc[data].plot(kind='barh',title ="Pitch Prediction",     figsize=(15, 10), fontsize=20)<br/>    ax.set_xlabel("Percent Chance", fontsize=24)<br/>    ax.set_ylabel("Pitchtype", fontsize=24)<br/>    plt.show()</span><span id="4b3d" class="lo lp ji lk b gy mi lr l ls lt">#visualize observation 6754<br/>pitch_pred(6754)</span></pre><figure class="le lf lg lh gt iv gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/846176b892a3309cb99a80e432d53f33.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*Bhtip5OqVl0Cyyh3fXW-Mg.png"/></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Parameters for observation 6754</figcaption></figure><figure class="le lf lg lh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mo"><img src="../Images/5ff8585e1ffb177cc4d9929947d6ce64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TdRx7SljHIQy0LFTbcKbTw.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Visual for observation 6754</figcaption></figure><p id="9ab7" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">正如你所看到的，在彻底分类的基础上，展示下一个音高的可能性更有意义。未来的工作包括部署模型后的实时测试。也可能找到一些有用的附加数据，如体育场和天气。由于数据量巨大，笔记本可以在 Google Colab 和 Github 上找到，但我无法将数据文件保存在云中。数据集可以从 Kaggle 下载。</p><div class="is it gp gr iu mp"><a href="https://colab.research.google.com/drive/1VaHWXq2yYuH-S-6WL_WD8VFSugcgoiUz#scrollTo=eNI5nrnYrxPV" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd jj gy z fp mu fr fs mv fu fw jh bi translated">谷歌联合实验室</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">棒球 _ 投球 _ 预测</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">colab.research.google.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd ja mp"/></div></div></a></div><div class="is it gp gr iu mp"><a href="https://github.com/Jason-M-Richards/Baseball-Pitch-Prediction" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd jj gy z fp mu fr fs mv fu fw jh bi translated">杰森·M·理查兹/棒球投球预测</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">作为职业棒球的狂热观众，越来越明显的是，统计数据不仅有助于经理们…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">github.com</p></div></div><div class="my l"><div class="ne l na nb nc my nd ja mp"/></div></div></a></div></div></div>    
</body>
</html>