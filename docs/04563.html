<html>
<head>
<title>RFM Segmentation using Quartiles and Jenks Natural Breaks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用四分位数和 Jenks 自然间断的 RFM 分割</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/rfm-segmentation-using-quartiles-and-jenks-natural-breaks-924f4d8baee1?source=collection_archive---------8-----------------------#2019-07-13">https://towardsdatascience.com/rfm-segmentation-using-quartiles-and-jenks-natural-breaks-924f4d8baee1?source=collection_archive---------8-----------------------#2019-07-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2c7aa89b54d6551b55c8d01b448bc8f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RJe0QvtpkQAMuBH9tQY9Jg.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by Heidi Sandstrom. on Unsplash</figcaption></figure><div class="kf kg gp gr kh ki"><a href="https://github.com/gianfelton/RFM-Segmentation-with-Quartiles-Jenks-Natural-Breaks-and-HDBSCAN/blob/master/RFM%20Segmentation.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="kj ab fo"><div class="kk ab kl cl cj km"><h2 class="bd iu gy z fp kn fr fs ko fu fw is bi translated">吉安费尔顿/RFM-带四分位数的分段-詹克斯-自然分段-HDBSCAN</h2><div class="kp l"><h3 class="bd b gy z fp kn fr fs ko fu fw dk translated">通过创建一个……为吉安费尔顿/RFM-四分点分割-詹克斯-自然断裂-和组屋开发做出贡献</h3></div><div class="kq l"><p class="bd b dl z fp kn fr fs ko fu fw dk translated">github.com</p></div></div><div class="kr l"><div class="ks l kt ku kv kr kw jz ki"/></div></div></a></div><p id="5164" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章的笔记本可以在上面的链接中找到。</p><p id="8036" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章的目的是分享我最近使用 RFM 模型进行客户细分的一些经验。对于那些刚接触 RFM 模型的人，这里有一个分类:</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/f00e4303baf8cb8910ea697ded57f060.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*bSyal9aCbUqe54qzokQ2sg.png"/></div></figure><p id="e8c7" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在实践中，它将生成如下所示的表格:</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/31d4a12219ab22bfcc4fc33493bd7e2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*wnn99YCJJsJijIGdBiPtPQ.png"/></div></figure><p id="b906" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终，我们将得到这些数字的百分位数(我们将在下面讨论)，然后是四分位数。四分位数将给出从 1 到 4 的分数，我们将组合这些分数得到 RFM 分数。该过程将如下所示:</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mb"><img src="../Images/3b2ffc91b2764d3cb8b04909d88028ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xqOWC_pNEM2d0dhEtt_bZw.png"/></div></div></figure><p id="454c" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从笔记本开始吧。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="91ab" class="mh mi it md b gy mj mk l ml mm"><strong class="md iu">import</strong> <strong class="md iu">numpy</strong> <strong class="md iu">as</strong> <strong class="md iu">np</strong><br/><strong class="md iu">import</strong> <strong class="md iu">pandas</strong> <strong class="md iu">as</strong> <strong class="md iu">pd</strong><br/><strong class="md iu">import</strong> <strong class="md iu">matplotlib.pyplot</strong> <strong class="md iu">as</strong> <strong class="md iu">plt</strong><br/>%matplotlib inline<br/><strong class="md iu">import</strong> <strong class="md iu">datetime</strong> <strong class="md iu">as</strong> <strong class="md iu">dt</strong><br/><strong class="md iu">from</strong> <strong class="md iu">scipy</strong> <strong class="md iu">import</strong> stats<br/><strong class="md iu">import</strong> <strong class="md iu">jenkspy</strong><br/><strong class="md iu">import</strong> <strong class="md iu">seaborn</strong> <strong class="md iu">as</strong> <strong class="md iu">sns</strong><br/><strong class="md iu">import</strong> <strong class="md iu">warnings</strong><br/>warnings.filterwarnings("ignore")</span><span id="dd6d" class="mh mi it md b gy mn mk l ml mm">df = pd.read_csv(‘Superstore.csv’)</span></pre><p id="1921" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快速浏览前三行可以了解数据的概念:</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mo"><img src="../Images/cb3b70dba6b5f1e8fa373c0e8140ae1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4szVl-TgNu6U1W5XTlktjQ.png"/></div></div></figure><p id="a9fe" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以将订单日期、订单 ID 和销售额用于 RFM。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="88b2" class="mh mi it md b gy mj mk l ml mm">df['Order Date'] = pd.to_datetime(df['Order Date'])</span><span id="bcd2" class="mh mi it md b gy mn mk l ml mm">anchorDate = dt.datetime(2015,1,1)</span><span id="f23b" class="mh mi it md b gy mn mk l ml mm">rfm = df.groupby('Customer ID').agg({'Order Date': lambda x: (anchorDate - x.max()).days,<br/>                                     'Order ID': lambda x: len(x),<br/>                                     'Sales': lambda x: x.sum()})</span></pre><p id="88ad" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第一行中，我们将订单日期设置为日期时间格式。第二行仅在该数据集中是必要的，因为它在 2014 年 12 月 31 日结束。在现实世界的设置中，这只是设置为当前日期。第三部分按客户 ID 汇总了最近、频率和货币。</p><p id="64ca" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们最终得到了这样一张表:</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mp"><img src="../Images/5705adb5a5937967acea82e52fcb4429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2a5vCm1Ub8tk4sAacc2WA.png"/></div></div></figure><p id="d6ad" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们只需要更改列名。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="f207" class="mh mi it md b gy mj mk l ml mm">rfm.columns = ['Recency', 'Frequency', 'Monetary']</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/56826ca75181d9482e856712181052dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-MWHWaTTbTL0OoOPUmNt9g.png"/></div></div></figure><p id="b217" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从这里，我们可以很容易地得到百分位数和四分位数。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="841f" class="mh mi it md b gy mj mk l ml mm">rfm['r_percentile'] = rfm['Recency'].rank(pct=True,ascending=False)<br/>rfm['r_score'] = pd.qcut(rfm['r_percentile'], 4, labels=range(4,0,-1))</span><span id="ac7d" class="mh mi it md b gy mn mk l ml mm">rfm['f_percentile'] = rfm['Frequency'].rank(pct=True,ascending=True)<br/>rfm['f_score'] = pd.qcut(rfm['f_percentile'], 4, labels=range(4,0,-1))</span><span id="95cf" class="mh mi it md b gy mn mk l ml mm">rfm['m_percentile'] = rfm['Monetary'].rank(pct=True,ascending=True)<br/>rfm['m_score'] = pd.qcut(rfm['m_percentile'], 4, labels=range(4,0,-1))</span></pre><p id="0a1d" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果表有我们的最近、频率和货币列，以及每个值的百分位数和四分位数。</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/0eabd1b12cab010ec44b0eacd242d845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pIpGVAGoXZ7dMpl6Cu7H2A.png"/></div></div></figure><p id="aa07" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们只需要连接三个分数列。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="4971" class="mh mi it md b gy mj mk l ml mm">rfm['rfm_score'] = rfm['r_score'].astype(str) + rfm['f_score'].astype(str) + rfm['m_score'].astype(str)</span></pre><p id="47d2" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们完成的桌子。</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/93283ab3fdbc3b6f36569754b0051695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1KDpitQISk9xFFsWA8CcGw.png"/></div></div></figure><p id="f067" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以就此打住，但是让我们做一些探索和比较。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="bb0c" class="mh mi it md b gy mj mk l ml mm">ax = rfm['rfm_score'].value_counts().plot(kind='bar', figsize=(15, 5), fontsize=12)<br/>ax.set_xlabel("RFM Score", fontsize=12)<br/>ax.set_ylabel("Count", fontsize=12)<br/>plt.show()</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/940c390c8e365caffa4aec5239ca559d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qt8ZGv-FjUEeM4zH65R-cQ.png"/></div></div></figure><p id="3539" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，我们最大的细分市场是由最没有价值的客户组成的。然而，我们下一个最大的细分市场是由我们最有价值的客户组成的。这似乎很奇怪。让我们看看我们的数据是根据哪些值进行分区的。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="c036" class="mh mi it md b gy mj mk l ml mm">r_quarters = rfm['Recency'].quantile(q=[0.0, 0.25,0.5,0.75, 1]).to_list()<br/>f_quarters = rfm['Frequency'].quantile(q=[0.0, 0.25,0.5,0.75, 1]).to_list()<br/>m_quarters = rfm['Monetary'].quantile(q=[0.0, 0.25,0.5,0.75, 1]).to_list()<br/>quartile_spread = pd.DataFrame(list(zip(r_quarters, f_quarters, m_quarters)), <br/>                      columns=['Q_Recency','Q_Frequency', 'Q_Monetary'],<br/>                     index = ['min', 'first_part','second_part','third_part', 'max'])<br/>quartile_spread</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/99459aac4cfb98abeb9f53775db30c51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1uNyi3m9jRZXS4ACDO2YQ.png"/></div></div></figure><p id="3893" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管这让我们了解了分区之间的范围，但我们还需要其他东西来查看密度。让我们看一个直方图，我们的分区沿着 x 轴放置。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="8730" class="mh mi it md b gy mj mk l ml mm">plt.figure(figsize = (16,6))<br/>hist = plt.hist(rfm['Frequency'], bins=100, align='left', color='cornflowerblue')<br/>for q in f_quarters:<br/>    plt.vlines(q, ymin=0, ymax = max(hist[0]))</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/5da6e633e46179b8e3b7313999e3edb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gelnFWrjPK186HS9m_8Ew.png"/></div></div></figure><p id="d60f" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了这个视图，我们可以看到分区并不十分适合我们的数据。15 处的分区将看起来像一个组的东西一分为二。让我们试着用 Jenks 的自然间断来划分我们的数据，而不是四分位数。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="ea10" class="mh mi it md b gy mj mk l ml mm">plt.figure(figsize = (16,6))<br/>hist = plt.hist(rfm['Frequency'], bins=100, align='left', color='cornflowerblue')<br/>for b in f_breaks:<br/>    plt.vlines(b, ymin=0, ymax = max(hist[0]))</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/d983134a56f80ad66dd83f628abdf3be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MnypXo50d7Jst0X-yRFRoQ.png"/></div></div></figure><p id="83de" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这使得这个数据更有意义。让我们用 Jenks 来看一个分区表。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="8a44" class="mh mi it md b gy mj mk l ml mm">r_breaks = jenkspy.jenks_breaks(rfm['Recency'], nb_class=4)<br/>f_breaks = jenkspy.jenks_breaks(rfm['Frequency'], nb_class=4)<br/>m_breaks = jenkspy.jenks_breaks(rfm['Monetary'], nb_class=4)<br/>jenks_spread = pd.DataFrame(list(zip(r_breaks, f_breaks, m_breaks)), <br/>                      columns=['J_Recency','J_Frequency', 'J_Monetary'],<br/>                     index = ['min', 'first_part','second_part','third_part', 'max'])<br/>jenks_spread</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/11a5ed7b1c5c6e4490d57ce09c5027f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDcpG7BLkA3d9f4r7YxmmQ.png"/></div></div></figure><p id="713c" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一点上，这是否更好取决于业务。让我们并排比较两个分区表。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="984f" class="mh mi it md b gy mj mk l ml mm">df = pd.concat([quartile_spread, jenks_spread], axis=1)<br/>cols = ['Q_Recency', 'J_Recency','Q_Frequency', 'J_Frequency','Q_Monetary', 'J_Monetary']<br/>df[cols]</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/e5cf995b30b17dbe48d5325342e99344.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qio69BuN5IbAzJN4PX1sTw.png"/></div></div></figure><p id="34dd" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个表应该有助于决定使用四分位数还是 Jenks。不过，还有一件事。我们用 Jenks(用 nb_class=4 参数)指定了分区的数量，但是我们是如何得到这个数字的呢？我绘制了方差拟合优度与班级数量的关系图。它看起来有点像 K-Means 的肘方法。</p><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/e8cfd237fb8a23b3929d1575ea7dbd71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZT8B7mjEG__WVrUR7APSdQ.png"/></div></div></figure><p id="31f5" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本上，我在寻找类的数量和方差拟合优度之间的平衡。</p><p id="8f91" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实现这一点的代码有点长。以下是计算方差拟合优度的函数:</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="d0ac" class="mh mi it md b gy mj mk l ml mm"># Crediting camdenl with this function<br/># <a class="ae mz" href="https://stats.stackexchange.com/users/27263/camdenl?tab=profile" rel="noopener ugc nofollow" target="_blank">https://stats.stackexchange.com/users/27263/camdenl?tab=profile</a></span><span id="27dd" class="mh mi it md b gy mn mk l ml mm">def goodness_of_variance_fit(array, classes):<br/>    # get the break points<br/>    classes = jenkspy.jenks_breaks(array, nb_class=classes)</span><span id="3873" class="mh mi it md b gy mn mk l ml mm"># do the actual classification<br/>    classified = np.array([classify(i, classes) for i in array])</span><span id="70b5" class="mh mi it md b gy mn mk l ml mm"># max value of zones<br/>    maxz = max(classified)</span><span id="fdd2" class="mh mi it md b gy mn mk l ml mm"># nested list of zone indices<br/>    zone_indices = [[idx for idx, val in enumerate(classified) if zone + 1 == val] for zone in range(maxz)]</span><span id="5f81" class="mh mi it md b gy mn mk l ml mm"># sum of squared deviations from array mean<br/>    sdam = np.sum((array - array.mean()) ** 2)</span><span id="41e9" class="mh mi it md b gy mn mk l ml mm"># sorted polygon stats<br/>    array_sort = [np.array([array[index] for index in zone]) for zone in zone_indices]</span><span id="894a" class="mh mi it md b gy mn mk l ml mm"># sum of squared deviations of class means<br/>    sdcm = sum([np.sum((classified - classified.mean()) ** 2) for classified in array_sort])</span><span id="e4ad" class="mh mi it md b gy mn mk l ml mm"># goodness of variance fit<br/>    gvf = (sdam - sdcm) / sdam</span><span id="2a46" class="mh mi it md b gy mn mk l ml mm">return gvf</span><span id="7fc9" class="mh mi it md b gy mn mk l ml mm">def classify(value, breaks):<br/>    for i in range(1, len(breaks)):<br/>        if value &lt; breaks[i]:<br/>            return i<br/>    return len(breaks) - 1</span></pre><p id="8db2" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是绘制方差拟合优度与类数量关系的代码:</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="fca7" class="mh mi it md b gy mj mk l ml mm">my_dict = {}<br/>for col in rfm.columns[:3]:<br/>    results = []<br/>    for i in range(2, 10):<br/>        results.append(goodness_of_variance_fit(rfm[col], i))<br/>    my_dict[col] = results  <br/>plt.plot(range(2, 10), my_dict['Recency'], label='Recency')<br/>plt.plot(range(2, 10), my_dict['Frequency'], label='Frequency')<br/>plt.plot(range(2, 10), my_dict['Monetary'], label='Monetary')<br/>plt.xlabel('Number of classes')<br/>plt.ylabel('Goodness of Variance Fit')<br/>plt.legend(loc='best')<br/>plt.show()</span></pre><p id="a52e" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经使用四分位数和 Jenks 自然间断点进行了调查，让我们添加基于 Jenks 自然间断点的 rfm 分数，并查看两个分数如何比较。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="51c9" class="mh mi it md b gy mj mk l ml mm">breaks_list = [r_breaks, f_breaks, m_breaks]</span><span id="56de" class="mh mi it md b gy mn mk l ml mm">rfm['r_j_score'] = pd.cut(rfm['Recency'], bins=r_breaks, labels=[1, 2, 3, 4], include_lowest=True)<br/>rfm['f_j_score'] = pd.cut(rfm['Frequency'], bins=f_breaks, labels=[4, 3, 2, 1], include_lowest=True)<br/>rfm['m_j_score'] = pd.cut(rfm['Monetary'], bins=m_breaks, labels=[4, 3, 2, 1], include_lowest=True)</span><span id="ba57" class="mh mi it md b gy mn mk l ml mm">rfm.drop(['r_percentile', 'f_percentile', 'm_percentile'], axis=1, inplace=True)</span><span id="d10e" class="mh mi it md b gy mn mk l ml mm">rfm['rfm_j_score'] = rfm['r_j_score'].astype(str) + rfm['f_j_score'].astype(str) + rfm['m_j_score'].astype(str)</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/1bcd238892141ad97b56a99b366d8962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OWLDGUF1XmOIwU3wuBP0nA.png"/></div></div></figure><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="ea1c" class="mh mi it md b gy mj mk l ml mm">df = rfm['rfm_j_score'].value_counts().to_frame().join(rfm['rfm_score'].value_counts())<br/>ax = df.plot(kind='bar', title ="Jenks vs Quartiles", figsize=(15, 5), legend=True, fontsize=12)<br/>ax.set_xlabel("RFM Score", fontsize=12)<br/>ax.set_ylabel("Count", fontsize=12)<br/>plt.show()</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/80a63080fc78c6412ebafe7280f35674.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C4f1YAuITT7GJUoQWKSPdA.png"/></div></div></figure><p id="21ef" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到结果非常不同。使用 Jenks 自然中断，最近但不频繁的购买者(总消费金额低)构成了最大的细分市场。</p><p id="ecbd" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">RFM 到此为止。基于我们到目前为止所看到的，一个人应该知道这些细分方法中的哪一种(如果有的话)更适合他们的情况。</p><p id="5b74" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下部分独立于 RFM 分段。在完成自己的细分工作后，我花了相当多的时间在我的客户中寻找聚类。这是相关的，因为我使用了最近，频率和货币价值的聚类。</p><p id="40d8" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然我尝试了一些聚类方法，但下面是 HDBSCAN 的一个示例(在同一数据集上):</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="32d4" class="mh mi it md b gy mj mk l ml mm">import hdbscan</span><span id="a30f" class="mh mi it md b gy mn mk l ml mm">clusterer = hdbscan.HDBSCAN(min_cluster_size=30,min_samples=12, metric='euclidean')</span><span id="1a7c" class="mh mi it md b gy mn mk l ml mm">clusterer.fit(rfm[['Recency', 'Frequency', 'Monetary']])</span><span id="ee87" class="mh mi it md b gy mn mk l ml mm">rfm['Cluster'] = pd.Series(clusterer.labels_, index=rfm.index)</span><span id="9854" class="mh mi it md b gy mn mk l ml mm">rfm.head(3)</span></pre><p id="4138" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我选择 HDBSCAN 的原因是因为它能够在不引入噪声的情况下进行聚类。第一类是噪音。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="ce88" class="mh mi it md b gy mj mk l ml mm">from mpl_toolkits.mplot3d import Axes3D<br/>import matplotlib.colors as mcolors</span><span id="b27b" class="mh mi it md b gy mn mk l ml mm">fig = plt.figure(figsize=(18,12))<br/>dx = fig.add_subplot(111, projection='3d')<br/>colors = ['green', 'blue', 'red', 'yellow', 'black']<br/>#colors = [ k for k in mcolors.CSS4_COLORS ]</span><span id="8e34" class="mh mi it md b gy mn mk l ml mm">for i in range(-1,len(rfm['Cluster'].unique())-1):<br/>    dx.scatter(rfm[rfm.Cluster == i].Recency, <br/>               rfm[rfm.Cluster == i].Frequency, <br/>               rfm[rfm.Cluster == i].Monetary, <br/>               c = colors[i], <br/>               label = 'Cluster ' + str(i), <br/>               s=10, alpha=1.0)</span><span id="0816" class="mh mi it md b gy mn mk l ml mm">dx.set_xlabel('Recency', fontsize=14)<br/>dx.set_ylabel('Frequency', fontsize=14)<br/>dx.set_zlabel('Monetary', fontsize=14)<br/>dx.legend(fontsize=12)</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/da3403a4164c626e4c7240b6b802fefd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3X58oqztNrs9Gec4dc2AOQ.png"/></div></div></figure><p id="92f4" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我注意到的第一件事是绿色和红色集群的小尺寸。让我们看看集群之间的计数。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="c23b" class="mh mi it md b gy mj mk l ml mm">pd.Series(clusterer.labels_).value_counts()</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/0dbc5f50e93be0c37c41b990edc0f5a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*byiOhbmHwyJATfHzYCN-BA.png"/></div></div></figure><p id="6bfb" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们再看远一点的集群。簇 1 被排除，因为它是噪声。</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="9042" class="mh mi it md b gy mj mk l ml mm">myDict = {}<br/>for i in range(0, len(rfm['Cluster'].unique())-1):<br/>    clust = rfm[rfm['Cluster'] == i]<br/>    myDict['Cluster ' + str(i)] = [int(round(clust['Recency'].mean(),0)),<br/>                            int(round(clust['Frequency'].mean(),0)),<br/>                            int(round(clust['Monetary'].mean(),0)),<br/>                            int(round(clust['Recency'].median(),0)),<br/>                            int(round(clust['Frequency'].median(),0)),<br/>                            int(round(clust['Monetary'].median(),0))]<br/>    <br/>df = pd.DataFrame.from_dict(myDict, orient='index',<br/>                            columns=['mean_Recency','mean_Frequency', 'mean_Monetary',<br/>                                    'median_Recency','median_Frequency', 'median_Monetary'])<br/>df</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/1d1bcb9cba22170cadc6c9c4e3f2a980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4QSDRlXBXc1RnKecqWypQ.png"/></div></div></figure><p id="9ca7" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们来看看这些集群是如何按照 RFM 分数排列的:</p><pre class="lw lx ly lz gt mc md me mf aw mg bi"><span id="e746" class="mh mi it md b gy mj mk l ml mm">myDict = {}<br/>for i in range(-1, len(rfm['Cluster'].unique())-1):<br/>    clust = rfm[rfm['Cluster'] == i]<br/>    myDict["Cluster " + str(i)] = clust['rfm_j_score'].value_counts()<br/>df = pd.DataFrame.from_dict(myDict)</span><span id="bdf2" class="mh mi it md b gy mn mk l ml mm">colors = ['black', 'green', 'blue', 'red', 'yellow']<br/>ax = df.plot(kind='bar', figsize=(15, 5), legend=True, fontsize=12, color=colors)<br/>ax.set_xlabel("RFM Score", fontsize=12)<br/>ax.set_ylabel("Count", fontsize=12)<br/>plt.show()</span></pre><figure class="lw lx ly lz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/deeb80162cacfb8e9f99067add8acae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_MrVJyAV72mNxegUD2Onmw.png"/></div></div></figure><p id="f0bf" class="pw-post-body-paragraph kx ky it kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的集群有非常相似的 RFM 分数，这在用 RFM 模型术语描述我们集群的构成时是令人鼓舞的。帖子的聚类部分到此为止。谢谢大家！</p></div></div>    
</body>
</html>