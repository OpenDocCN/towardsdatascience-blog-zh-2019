<html>
<head>
<title>Build an Interactive Choropleth Map with Plotly and Dash</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Plotly 和 Dash 创建交互式 Choropleth 地图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-an-interactive-choropleth-map-with-plotly-and-dash-1de0de00dce0?source=collection_archive---------8-----------------------#2019-12-22">https://towardsdatascience.com/build-an-interactive-choropleth-map-with-plotly-and-dash-1de0de00dce0?source=collection_archive---------8-----------------------#2019-12-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><figure class="it iu gq gs iv iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj is"><img src="../Images/fd9231a3bb9e33b86f53f3492c186bde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*tvaMjlqu2_-7EJlPCNoIgw.gif"/></div></div></figure><div class=""/><div class=""><h2 id="80d8" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">悉尼郊区房价中位数的可视化</h2></div><p id="1563" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi lq translated"><span class="l lr ls lt bm lu lv lw lx ly di"> L </span>上周，我完成了 IBM 数据科学课程的期末作业，就是根据位置数据，寻找一个理想的郊区，开一家意大利餐厅。在这个过程中，我在网上收集了悉尼每个郊区的房产中值价格(即房屋购买/租赁和单位购买/租赁),并分别绘制在 Choropleth 地图上。</p><figure class="ma mb mc md gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj lz"><img src="../Images/f43804d07fc522e13276945fdd275b6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aG-YAqePygViBlo8_JGVWA.jpeg"/></div></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Choropleth maps for different parameters</figcaption></figure><p id="342c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">然而，我想知道是否有可能将所有这些地图组合在一起，并通过点击下拉菜单中的名称来选择其中之一。此外，我想在地图旁边再添加一个地块，以相应地显示中位数价格最高的前 10 个郊区。这些附件将使地图更加丰富和用户友好。在这篇文章中，我将分享我关于如何使用 Plotly 和 Dash 创建一个带有 choropleth 地图和条形图的交互式仪表板的笔记。此外，我假设你以前有与 Plotly 的经验。</p><h2 id="c990" class="mi mj jf bd mk ml mm dn mn mo mp dp mq ld mr ms mt lh mu mv mw ll mx my mz na bi translated">先决条件</h2><p id="5d8d" class="pw-post-body-paragraph ku kv jf kw b kx nb kg kz la nc kj lc ld nd lf lg lh ne lj lk ll nf ln lo lp in bi translated">在系统上安装<code class="fe ng nh ni nj b">plotly,</code> <code class="fe ng nh ni nj b">dash</code>和<code class="fe ng nh ni nj b">pandas</code>。我使用<code class="fe ng nh ni nj b">conda</code>创建了一个虚拟环境，以保持系统有序，避免与系统中的其他包混淆。如果你想了解更多关于<code class="fe ng nh ni nj b">conda env</code>的信息，我已经在<a class="ae nk" href="https://medium.com/swlh/running-python-and-r-within-jupyter-lab-from-remote-server-d9dfbc4f9a85" rel="noopener">上一篇文章</a>中介绍了康达虚拟环境。以下代码将创建一个虚拟环境，其中包含<code class="fe ng nh ni nj b">plotly</code>和<code class="fe ng nh ni nj b">dash</code>所需的所有包。</p><pre class="ma mb mc md gu nl nj nm nn aw no bi"><span id="9b81" class="mi mj jf nj b gz np nq l nr ns">conda create -n &lt;whatever name you want for this env&gt; -c plotly plotly=4.4.1 -c conda-forge dash pandas</span></pre><p id="5716" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">为了能够在<code class="fe ng nh ni nj b">plotly</code>中绘制地图，我们还需要一个来自<a class="ae nk" href="https://www.mapbox.com/gallery/" rel="noopener ugc nofollow" target="_blank"> Mapbox </a>的令牌，它提供了各种漂亮的地图样式，最重要的是免费的。此外，在这个仪表板中使用了两个数据集，它们可以从我的<a class="ae nk" href="https://github.com/Perishleaf/data-visualisation-scripts/tree/master/dash_project_medium" rel="noopener ugc nofollow" target="_blank"> github </a>下载(你也可以在这里找到 dash 应用程序代码)。</p><h2 id="5e5c" class="mi mj jf bd mk ml mm dn mn mo mp dp mq ld mr ms mt lh mu mv mw ll mx my mz na bi translated">子弹头列车路线</h2><p id="f4db" class="pw-post-body-paragraph ku kv jf kw b kx nb kg kz la nc kj lc ld nd lf lg lh ne lj lk ll nf ln lo lp in bi translated">如果您现在想探索 dash 应用程序，在完成上述步骤后，您需要在这个<a class="ae nk" href="https://github.com/Perishleaf/data-visualisation-scripts/blob/master/dash_project_medium/dash_project_medium.py" rel="noopener ugc nofollow" target="_blank">脚本</a>中将您的 Mapbox 令牌分配给<code class="fe ng nh ni nj b">mapbox_accesstoken</code>，并在两个数据集所在的同一目录下运行它。一旦弹出以下消息，只需在您首选的浏览器中打开这个地址<code class="fe ng nh ni nj b"><a class="ae nk" href="http://127.0.0.1:8050/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8050/</a></code>，dash 就会加载到那里。</p><pre class="ma mb mc md gu nl nj nm nn aw no bi"><span id="5095" class="mi mj jf nj b gz np nq l nr ns">$ python dash_project_medium.py<br/>  Running on <a class="ae nk" href="http://127.0.0.1:8050/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8050/</a><br/>  Debugger PIN: 880-084-162<br/>  * Serving Flask app "dash_project" (lazy loading)<br/>  * Environment: production<br/>    WARNING: This is a development server. Do not use it in a    production deployment.<br/>  Use a production WSGI server instead.<br/>  * Debug mode: on</span></pre><h2 id="1d98" class="mi mj jf bd mk ml mm dn mn mo mp dp mq ld mr ms mt lh mu mv mw ll mx my mz na bi translated">蒸汽火车道</h2><p id="0d5c" class="pw-post-body-paragraph ku kv jf kw b kx nb kg kz la nc kj lc ld nd lf lg lh ne lj lk ll nf ln lo lp in bi translated">如下图所示，我已经标记了脚本中用于在仪表板中创建相应元素的关键函数。</p><figure class="ma mb mc md gu iw gi gj paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="gi gj nt"><img src="../Images/3e81031eb56f4fa4d7e5a031f5d3ce76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IpTvJXzEEakqFCGhR9BejQ.jpeg"/></div></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Dissecting the dashboard</figcaption></figure><p id="a603" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">通过<code class="fe ng nh ni nj b">plotly</code>和<code class="fe ng nh ni nj b">dash</code>构建这个仪表板的一般原则是 1)在一个定义好的画布上安排和组合不同的元素；2)将所有元素编译到一个容器中:<code class="fe ng nh ni nj b">fig=go.Figure(data=trace2 + trace1, layout=layout)</code>；3)将这个容器传递给<code class="fe ng nh ni nj b">dcc.Graph</code>，其中<code class="fe ng nh ni nj b">dcc</code>是 dash 核心组件，<code class="fe ng nh ni nj b">dash</code>将为仪表盘创建一个基于 html 的 web 应用。</p><p id="0e52" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">该仪表板的一个关键功能是通过下拉菜单在两个轨迹(choropleth 图和条形图)中显示特定参数(即<code class="fe ng nh ni nj b">House_buy</code>、<code class="fe ng nh ni nj b">House_rent</code>、<code class="fe ng nh ni nj b">Unit_buy</code>和<code class="fe ng nh ni nj b">Unit_rent</code>)。我的方法是创建四个层，每个层有一个参数<code class="fe ng nh ni nj b">visible=False</code>。然后使用<code class="fe ng nh ni nj b">updatemenus</code>的<code class="fe ng nh ni nj b">buttons</code>功能转动<code class="fe ng nh ni nj b">visible=True</code>至给定参数。</p><figure class="ma mb mc md gu iw"><div class="bz fq l di"><div class="nu nv l"/></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Bar plot code</figcaption></figure><p id="f29f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">因此，每个轨迹中有四个图形层，只有一个是可见的，这取决于在给定的时间点点击了哪个按钮。</p><figure class="ma mb mc md gu iw"><div class="bz fq l di"><div class="nu nv l"/></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Drop down menu bar code</figcaption></figure><p id="cc6e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">由于地图不是在笛卡尔坐标系(x/y)上绘制的，而笛卡尔坐标系是条形图中使用的坐标系，因此我在仪表板中为地图和条形图分别设置了两个坐标系。对于条形图(<code class="fe ng nh ni nj b">trace2</code>)，其坐标轴被分配到<code class="fe ng nh ni nj b"><strong class="kw jg">xaxis='x2'</strong></code>、<code class="fe ng nh ni nj b"><strong class="kw jg">yaxis='y2'</strong></code>。相反，地图(<code class="fe ng nh ni nj b">trace1</code>)在<code class="fe ng nh ni nj b">Layout</code>中有自己的特征，它被赋给变量<code class="fe ng nh ni nj b">mapbox1</code>，<code class="fe ng nh ni nj b">mapbox</code>和<code class="fe ng nh ni nj b">x/y</code>后面的数字是任意的。话虽如此，你可以指定任意多的坐标系，只要确保你在<code class="fe ng nh ni nj b">Layout</code>中将正确的系统锚定到它的轨迹上。</p><figure class="ma mb mc md gu iw"><div class="bz fq l di"><div class="nu nv l"/></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Choropleth map code</figcaption></figure><p id="7b00" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">然后在<code class="fe ng nh ni nj b">Layout</code>设置中，我们分别对这两个坐标系进行调整。如通过<code class="fe ng nh ni nj b">domain</code>显示轨迹在仪表盘中的位置，通过<code class="fe ng nh ni nj b">showticklabels</code>显示每个轴上的刻度，通过<code class="fe ng nh ni nj b">autorange</code>显示条的升序。</p><figure class="ma mb mc md gu iw"><div class="bz fq l di"><div class="nu nv l"/></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Layout code</figcaption></figure><p id="f4c8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">在连接了<code class="fe ng nh ni nj b">fig=go.Figure</code>中的所有元素之后，我将<code class="fe ng nh ni nj b">fig</code>分配给<code class="fe ng nh ni nj b">dcc.Graph</code>，将所有代码打包成一个<code class="fe ng nh ni nj b">py</code>文件，并运行它。嘣，我的第一个交互式仪表盘来了。</p><figure class="ma mb mc md gu iw"><div class="bz fq l di"><div class="nu nv l"/></div><figcaption class="me mf gk gi gj mg mh bd b be z dk">Dash app implementation</figcaption></figure><p id="38c6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">我应该指出，我在这里只使用了非常基本的破折号结构，大部分代码仍然是用 Plotly 编写的。我的方法的一个缺点是，将所有四层堆叠到同一轨迹上可能会降低应用程序的速度，这是因为所有数据都需要在 dash 应用程序初始化时加载。当点击下拉菜单事件发生时，进行实时更新会更有效。希望通过进一步学习高级 Dash 代码，我能找到一个解决方案。</p><p id="8227" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">以下是一些学习 Dash 的资源:</p><ul class=""><li id="5891" class="nw nx jf kw b kx ky la lb ld ny lh nz ll oa lp ob oc od oe bi translated"><a class="ae nk" href="https://dash.plot.ly/" rel="noopener ugc nofollow" target="_blank"> Dash 用户指南</a></li><li id="f6ed" class="nw nx jf kw b kx of la og ld oh lh oi ll oj lp ob oc od oe bi translated">来自数据营的初学者 Dash</li><li id="d74a" class="nw nx jf kw b kx of la og ld oh lh oi ll oj lp ob oc od oe bi translated"><a class="ae nk" href="https://community.plot.ly/c/dash" rel="noopener ugc nofollow" target="_blank"> Dash 社区论坛</a></li><li id="d365" class="nw nx jf kw b kx of la og ld oh lh oi ll oj lp ob oc od oe bi translated"><a class="ae nk" href="https://github.com/ucg8j/awesome-dash" rel="noopener ugc nofollow" target="_blank">Github 上的牛逼 Dash 资源指南</a></li><li id="4bdd" class="nw nx jf kw b kx of la og ld oh lh oi ll oj lp ob oc od oe bi translated"><a class="ae nk" rel="noopener" target="_blank" href="/how-to-build-a-complex-reporting-dashboard-using-dash-and-plotl-4f4257c18a7f">一张详细的仪表盘构建贴</a></li></ul><p id="2f8a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp in bi translated">和往常一样，我欢迎反馈、建设性的批评和倾听您的数据科学项目。你可以在 Linkedin 上找到我。</p></div></div>    
</body>
</html>