<html>
<head>
<title>Cleaning and Transforming Data with SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 SQL 清理和转换数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/cleaning-and-transforming-data-with-sql-f93c4de0d2fc?source=collection_archive---------5-----------------------#2019-12-10">https://towardsdatascience.com/cleaning-and-transforming-data-with-sql-f93c4de0d2fc?source=collection_archive---------5-----------------------#2019-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/1e4888be8bf2fbf32d9ad13024ba4674.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kxCao4v89siPVk80zd3T0w.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="b496" class="pw-subtitle-paragraph kb jd je bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks dk translated">了解如何使用 SQL 查询来准备、清理和转换用于分析的数据！</h2></div><p id="6024" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">进行数据分析时，首先要执行的任务之一是创建干净的数据集。您从数据中获得的洞察力仅与数据本身一样好，因此毫不奇怪，分析专业人员大约 80%的时间都花在准备供分析使用的数据上。</p><p id="2a83" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">SQL 可以帮助加速这项重要的任务。在本教程中，我们将讨论常用于从查询输出中清理、转换和删除重复数据的不同函数，这些数据可能不是我们想要的形式。这意味着您将了解:</p><ul class=""><li id="eddb" class="lp lq je kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated"><code class="fe ly lz ma mb b">CASE WHEN</code></li><li id="ed24" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated"><code class="fe ly lz ma mb b">COALESCE</code></li><li id="8503" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated"><code class="fe ly lz ma mb b">NULLIF</code></li><li id="05cd" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated"><code class="fe ly lz ma mb b">LEAST</code> / <code class="fe ly lz ma mb b">GREATEST</code></li><li id="8e28" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated">铸造</li><li id="db00" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated"><code class="fe ly lz ma mb b">DISTINCT</code></li></ul><p id="a438" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">在本教程中，我们将使用下面的示例表<code class="fe ly lz ma mb b">employees</code>来说明我们的函数是如何工作的:</p><figure class="mi mj mk ml gt iv gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/a6f77285f91ce8abc1bc8f05f3cd2f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*rX8qvj0CtX8V3aDO3cRo3Q.png"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Our sample table, `employees`</figcaption></figure><p id="25fc" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这些数据被预加载到下一个技术沙箱中，供您试验和测试以下查询。在这里免费连接数据库<a class="ae mq" href="https://nt.dev/s/13bc3fa3dda1" rel="noopener ugc nofollow" target="_blank">！</a></p><p id="145c" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">我们开始吧！</p><blockquote class="mr ms mt"><p id="cb46" class="kt ku mu kv b kw kx kf ky kz la ki lb mv ld le lf mw lh li lj mx ll lm ln lo im bi translated">本教程改编自 Next Tech 的完整<strong class="kv jf"> SQL for Data Analysis </strong>课程，其中包括浏览器内沙盒环境以及使用真实数据集的互动活动和挑战。你可以在这里开始学习这门课程<a class="ae mq" href="https://c.next.tech/2YDy9JV" rel="noopener ugc nofollow" target="_blank">！</a></p></blockquote></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="90a6" class="nf ng je bd nh ni nj nk nl nm nn no np kk nq kl nr kn ns ko nt kq nu kr nv nw bi translated"><code class="fe ly lz ma mb b">CASE WHEN</code></h1><p id="c167" class="pw-post-body-paragraph kt ku je kv b kw nx kf ky kz ny ki lb lc nz le lf lg oa li lj lk ob lm ln lo im bi translated"><code class="fe ly lz ma mb b">CASE WHEN</code>是一个允许查询将列中的各种值映射到其他值的函数。<code class="fe ly lz ma mb b">CASE WHEN</code>语句的一般格式是:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="e754" class="og ng je mb b gy oh oi l oj ok">CASE<br/>    WHEN condition1 THEN value1<br/>    WHEN condition2 THEN value2<br/>    ...<br/>    WHEN conditionX THEN valueX<br/>    ELSE else_value<br/>END</span></pre><p id="6f9b" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这里，<code class="fe ly lz ma mb b">condition1</code>、<code class="fe ly lz ma mb b">condition2</code>、<code class="fe ly lz ma mb b">conditionX</code>为布尔条件；<code class="fe ly lz ma mb b">value1</code>和<code class="fe ly lz ma mb b">value2</code>到<code class="fe ly lz ma mb b">valueX</code>是映射布尔条件的值；并且<code class="fe ly lz ma mb b">else_value</code>是如果布尔条件都不满足时映射的值。</p><p id="bd31" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">对于每一行，程序从<code class="fe ly lz ma mb b">CASE WHEN</code>语句的顶部开始，并评估第一个布尔条件。然后程序从第一个布尔条件开始运行每个布尔条件。对于从语句开始算起的第一个评估为 true 的条件，该语句将返回与该条件关联的值。如果没有一个语句评估为真，那么将返回与<code class="fe ly lz ma mb b">ELSE</code>语句相关联的值。</p><p id="1612" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">例如，假设您想从<code class="fe ly lz ma mb b">employees</code>表中返回雇员的所有行。此外，如果员工是在 2019-01-01 之后被雇用的，您可能希望添加一个列，将他们标记为<code class="fe ly lz ma mb b">New</code>员工。否则，它会将该员工标记为<code class="fe ly lz ma mb b">Standard</code>员工。该列将被称为<code class="fe ly lz ma mb b">employee_type</code>。我们可以使用如下的<code class="fe ly lz ma mb b">CASE WHEN</code>语句创建这个表:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="4833" class="og ng je mb b gy oh oi l oj ok">SELECT<br/>    *,<br/>    CASE<br/>        WHEN hire_date &gt;= '2019-01-01' THEN 'New'<br/>        ELSE 'Standard'<br/>    END AS employee_type<br/>FROM<br/>    employees;</span></pre><p id="cff3" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">该查询将给出以下输出:</p><figure class="mi mj mk ml gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ol"><img src="../Images/59f3b7101240ff4b4dbab5d08657d6a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMoclPDtdqDE5fT0KGQaJg.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Output from query using `CASE WHEN`</figcaption></figure><p id="242b" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><code class="fe ly lz ma mb b">CASE WHEN</code>语句有效地将雇用日期映射到描述雇员类型的字符串。使用<code class="fe ly lz ma mb b">CASE WHEN</code>语句，您可以随意地映射值。</p><h1 id="39a7" class="nf ng je bd nh ni om nk nl nm on no np kk oo kl nr kn op ko nt kq oq kr nv nw bi translated">联合</h1><p id="293e" class="pw-post-body-paragraph kt ku je kv b kw nx kf ky kz ny ki lb lc nz le lf lg oa li lj lk ob lm ln lo im bi translated">另一个有用的技术是用标准值替换<code class="fe ly lz ma mb b">NULL</code>值。这可以通过<code class="fe ly lz ma mb b">COALESCE</code>功能轻松实现。<code class="fe ly lz ma mb b">COALESCE</code>允许您列出任意数量的列和标量值，如果列表中的第一个值是<code class="fe ly lz ma mb b">NULL</code>，它将尝试用第二个值填充它。<code class="fe ly lz ma mb b">COALESCE</code>函数将继续在值列表中向下搜索，直到找到一个<code class="fe ly lz ma mb b">non-NULL</code>值。如果<code class="fe ly lz ma mb b">COALESCE</code>函数中的所有值都是<code class="fe ly lz ma mb b">NULL</code>，则该函数返回<code class="fe ly lz ma mb b">NULL</code>。</p><p id="dcc1" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">为了说明<code class="fe ly lz ma mb b">COALESCE</code>函数的简单用法，假设我们想要一个雇员姓名和职务的列表。然而，对于那些没有标题的，我们想改为写值<code class="fe ly lz ma mb b">'NO TITLE'</code>。我们可以用<code class="fe ly lz ma mb b">COALESCE</code>来完成这个要求:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="9ede" class="og ng je mb b gy oh oi l oj ok">SELECT<br/>    first_name,<br/>    last_name,<br/>    COALESCE(title, 'NO TITLE') AS title<br/>FROM<br/>    employees;</span></pre><p id="a823" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">该查询产生以下结果:</p><figure class="mi mj mk ml gt iv gh gi paragraph-image"><div class="gh gi or"><img src="../Images/49dcbe353be25d37cc8fb7b833a52789.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*VsB_mcqKUH_7BbNjMHOUiw.png"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Output from query using `COALESCE`</figcaption></figure><p id="9f01" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">在处理创建默认值和避免<code class="fe ly lz ma mb b">NULL</code>时，<code class="fe ly lz ma mb b">COALESCE</code>总是有用的。</p><h1 id="d7eb" class="nf ng je bd nh ni om nk nl nm on no np kk oo kl nr kn op ko nt kq oq kr nv nw bi translated">努里夫</h1><p id="d4b8" class="pw-post-body-paragraph kt ku je kv b kw nx kf ky kz ny ki lb lc nz le lf lg oa li lj lk ob lm ln lo im bi translated"><code class="fe ly lz ma mb b">NULLIF</code>在某种意义上是<code class="fe ly lz ma mb b">COALESCE</code>的反义词。<code class="fe ly lz ma mb b">NULLIF</code>是一个双值函数，如果第一个值等于第二个值，将返回<code class="fe ly lz ma mb b">NULL</code>。</p><p id="a12d" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">例如，假设我们想要一份雇员姓名和职务的列表。不过，这一次，我们想把标题<code class="fe ly lz ma mb b">'Honorable'</code>换成<code class="fe ly lz ma mb b">NULL</code>。这可以通过以下查询来完成:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="2315" class="og ng je mb b gy oh oi l oj ok">SELECT<br/>    first_name,<br/>    last_name,<br/>    NULLIF(title, 'Honorable') AS title<br/>FROM<br/>    employees;</span></pre><p id="1df2" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这将从<code class="fe ly lz ma mb b">title</code>列中删除所有提到的<code class="fe ly lz ma mb b">'Honorable'</code>，并给出以下输出:</p><figure class="mi mj mk ml gt iv gh gi paragraph-image"><div class="gh gi os"><img src="../Images/ee3e35b66bc4ba1da820a11da2f15bc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*3ePmgMsKZMpg0Lq1D_HDzg.png"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Output from query using `NULLIF`</figcaption></figure><h1 id="022e" class="nf ng je bd nh ni om nk nl nm on no np kk oo kl nr kn op ko nt kq oq kr nv nw bi translated">最小/最大</h1><p id="9d31" class="pw-post-body-paragraph kt ku je kv b kw nx kf ky kz ny ki lb lc nz le lf lg oa li lj lk ob lm ln lo im bi translated">对于数据准备来说，两个常用的函数是<code class="fe ly lz ma mb b">LEAST</code>和<code class="fe ly lz ma mb b">GREATEST</code>函数。每个函数接受任意数量的值，并分别返回最小或最大的值。</p><p id="4559" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这个变量的一个简单用法是替换过高或过低的值。例如，假设最低工资增加到 15 美元/小时，我们需要更改任何收入低于该水平的员工的工资。我们可以使用以下查询来创建它:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="18f7" class="og ng je mb b gy oh oi l oj ok">SELECT<br/>    id,<br/>    first_name,<br/>    last_name,<br/>    title,<br/>    age,<br/>    GREATEST(15, wage) as wage,<br/>    hire_date<br/>FROM<br/>    employees;</span></pre><p id="b610" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">该查询将给出以下输出:</p><figure class="mi mj mk ml gt iv gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/6053d8a82d3701acb55ff00478fcc135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*q00fSV9e-CB9cVV7eIp7mQ.png"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Output from query using `GREATEST`</figcaption></figure><p id="7348" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">如你所见，比尔·萨达特的工资从 12 美元涨到了 15 美元。</p><h1 id="7619" class="nf ng je bd nh ni om nk nl nm on no np kk oo kl nr kn op ko nt kq oq kr nv nw bi translated">铸造</h1><p id="042c" class="pw-post-body-paragraph kt ku je kv b kw nx kf ky kz ny ki lb lc nz le lf lg oa li lj lk ob lm ln lo im bi translated">另一个有用的数据转换是在查询中更改列的数据类型。这通常是为了使用只适用于一种数据类型(如文本)的函数，同时处理不同数据类型(如数值)的列。</p><p id="2143" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">要更改列的数据类型，只需使用<code class="fe ly lz ma mb b">column::datatype</code>格式，其中<code class="fe ly lz ma mb b">column</code>是列名，而<code class="fe ly lz ma mb b">datatype</code>是要将列更改为的数据类型。例如，要在查询中将<code class="fe ly lz ma mb b">employees</code>表中的年龄更改为文本列，请使用以下查询:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="1044" class="og ng je mb b gy oh oi l oj ok">SELECT<br/>    first_name,<br/>    last_name,<br/>    age::TEXT<br/>FROM<br/>    employees;</span></pre><p id="8a1c" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这将把<code class="fe ly lz ma mb b">age</code>列从整数转换成文本。现在，您可以将文本函数应用于这个转换后的列。还有最后一个条件:并非每种数据类型都可以转换为特定的数据类型。例如，<code class="fe ly lz ma mb b">datetime</code>不能转换为浮点类型。如果您进行了意外的奇怪转换，您的 SQL 客户端将会抛出一个错误。</p><h1 id="75da" class="nf ng je bd nh ni om nk nl nm on no np kk oo kl nr kn op ko nt kq oq kr nv nw bi translated">明显的</h1><p id="29a4" class="pw-post-body-paragraph kt ku je kv b kw nx kf ky kz ny ki lb lc nz le lf lg oa li lj lk ob lm ln lo im bi translated">通常，在浏览数据集时，您可能会对确定一列或一组列中的唯一值感兴趣。这是关键字<code class="fe ly lz ma mb b">DISTINCT</code>的主要用例。例如，如果您想知道<code class="fe ly lz ma mb b">employees</code>表中所有唯一的名字，您可以使用以下查询:</p><pre class="mi mj mk ml gt oc mb od oe aw of bi"><span id="7059" class="og ng je mb b gy oh oi l oj ok">SELECT<br/>    DISTINCT first_name<br/>FROM<br/>    employees;</span></pre><p id="ea28" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这将产生以下结果:</p><figure class="mi mj mk ml gt iv gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/41a6a4661c60f374466594fd8302b496.png" data-original-src="https://miro.medium.com/v2/resize:fit:230/format:webp/1*ISOkXFzLdN2yZPxYtYaYUQ.png"/></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Output from query using `DISTINCT`</figcaption></figure><p id="f3fa" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">您还可以对多个列使用<code class="fe ly lz ma mb b">DISTINCT</code>来显示所有不同的列组合。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><p id="f572" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">我希望你喜欢这篇关于 SQL 数据清理和转换的教程。这只是在数据分析中使用 SQL 的开始。如果你想了解更多，Next Tech 的<strong class="kv jf"> SQL for Data Analysis </strong>课程包括:</p><ul class=""><li id="71ae" class="lp lq je kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">用于数据准备和清理的更多功能</li><li id="0d17" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated">聚合函数和窗口函数</li><li id="cabb" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated">导入和导出数据</li><li id="1bbc" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated">使用复杂数据类型的分析</li><li id="4e33" class="lp lq je kv b kw mc kz md lc me lg mf lk mg lo lu lv lw lx bi translated">编写性能查询</li></ul><p id="c343" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这里可以免费<a class="ae mq" href="https://c.next.tech/2YDy9JV" rel="noopener ugc nofollow" target="_blank">上手！</a></p></div></div>    
</body>
</html>