<html>
<head>
<title>Reasoning With Probability and Pyro — Is My Model Good Enough?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用概率和火焰推理——我的模型够好吗？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/reasoning-with-probability-is-my-model-good-enough-1cfd27d5aed9?source=collection_archive---------28-----------------------#2019-12-30">https://towardsdatascience.com/reasoning-with-probability-is-my-model-good-enough-1cfd27d5aed9?source=collection_archive---------28-----------------------#2019-12-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ed5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在其核心，概率编程是为了回答关于不确定性的问题。一些非常受欢迎的在线例子讨论了使用概率编程来帮助神经网络，并使它们更有能力处理他们没有训练过的新例子。然而，在本教程中，我将介绍概率编程可以帮助的最基本的功能。</p><p id="1830" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里的例子在很大程度上摘自扎克·安临来的演讲，他在演讲中介绍了使用 PyMC3 的概率编程。我将使用<a class="ae ko" href="http://docs.pyro.ai/en/1.1.0/index.html" rel="noopener ugc nofollow" target="_blank"> Pyro </a>，因为我看到这个库在未来会起飞，我想探索它更多一点。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="2e9a" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">示例场景</strong></h1><p id="6701" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">让我们考虑以下简单的工作流程:</p><ul class=""><li id="4cd6" class="lz ma it js b jt ju jx jy kb mb kf mc kj md kn me mf mg mh bi translated">获取数据(在这种情况下是一个样本数据集)</li><li id="a583" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">执行训练/测试分割</li><li id="cc2e" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">根据训练数据训练模型</li><li id="3a27" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">测试模型的性能，决定性能好不好</li></ul><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">Import required packages</figcaption></figure><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">Obtain our data</figcaption></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="f560" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; (70000, 784)<br/>&gt;&gt;&gt; (70000,)</span></pre></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">Split the data into train and test</figcaption></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="918f" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; (56000, 784) (14000, 784)<br/>&gt;&gt;&gt; (56000,) (14000,)</span></pre></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">Train a decision tree on our train data, and test its performance on the test data</figcaption></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="1471" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; Accuracy is 87.06%</span></pre><h1 id="8447" class="kw kx it bd ky kz ni lb lc ld nj lf lg lh nk lj lk ll nl ln lo lp nm lr ls lt bi translated"><strong class="ak">分析</strong></h1><p id="4645" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">我们可以尝试提高模型的准确性，使其达到 87%以上，甚至采用更强的模型，如 CNN，但有一个稍微不太明显的问题。想想我们如何知道我们有 87%的准确率。</p><p id="3eaf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的测试集是 14000 个带标签的例子。这是一种真正的奢侈，因为对于一些数据科学问题，我们可能不会遇到这么多标记良好的例子。如果我们只有 100 个例子，而不是 14000 个，会怎么样？</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="f27e" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; (100, 784) (100,)</span></pre></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">Check accuracy again, but only on 100 test observations</figcaption></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="7ae9" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; Accuracy is 86.00%</span></pre><p id="2cfb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们得到了一个稍低的数字，但仍然是可比的。</p><p id="6e67" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">也就是说，虽然数字很接近，但相信基于 100 个例子的模型要比相信基于 14000 个例子的模型更难。</p><p id="93b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">直觉上，随着测试集大小的增加，我们对测试集分数的信心也增加了。Pyro 允许我们从数字上估计我们的信心以及我们有多少出错的空间。</p><h1 id="2bda" class="kw kx it bd ky kz ni lb lc ld nj lf lg lh nk lj lk ll nl ln lo lp nm lr ls lt bi translated"><strong class="ak">烟火模型</strong></h1><p id="2076" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">Pyro 工作流程非常独特，需要三个组件</p><ol class=""><li id="4365" class="lz ma it js b jt ju jx jy kb mb kf mc kj md kn nn mf mg mh bi translated">模拟我们底层模型的模型函数(不是决策树，而是给我们正确或不正确标签的过程)。该功能从<strong class="js iu">先验分布</strong>开始</li><li id="66ce" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn nn mf mg mh bi translated">当观察到的例子由模型函数产生时，测量它们的似然性的核</li><li id="a1dd" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn nn mf mg mh bi translated">构建<strong class="js iu">后验分布</strong>的采样器</li></ol><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="1b0a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先我们需要定义我们对 Pyro 的观察。在我们的例子中，我们的观察是我们看到正确和不正确分类的情况。让我们同时考虑小测试集(100 个观测值)和大测试集(14，000 个观测值)。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="0260" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们必须定义模型函数。该函数接受我们的观察值，并尝试从先验分布中取样，并根据我们的观察值计算先验的可能性。然后，内核会将先验更新为更可能的后验分布。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="30fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它看起来不太像，但是在这个模型中发生了两个重要的事件。</p><ul class=""><li id="f77a" class="lz ma it js b jt ju jx jy kb mb kf mc kj md kn me mf mg mh bi translated">首先，我们使用“pyro.sample”函数注册一个名为“p”的参数，作为 pyro 的可学习值。使用“pyro.sample”或“pyro.param”将结果值作为可学习值记录在 pyro 的内部存储器(一个特殊的类似字典的对象)中。在我们的例子中，我们已经说过“p”是一个可学习的分布。</li><li id="ae8c" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">我们还将每个观察记录为一个可学习的值，它应该符合我们提供给它的观察。</li></ul><p id="3aff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将注册该模型的内核(哈密顿蒙特卡罗内核)将查看该模型中定义的所有可学习值，并将尝试调整可学习分布，以便它们增加所提供的观测值的可能性。</p><p id="0002" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将使用的采样器(马尔可夫链蒙特卡罗)将运行 HMC 核来寻找后验分布。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="85ad" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; Sample: 100%|█████████████████████████████████████████| 200/200 [03:46,  1.13s/it, step size=1.51e+00, acc. prob=0.916]</span></pre><p id="fd3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们已经运行了我们的采样器，我们可以用我们得到的后验概率做几件事。首先，我们可能想把我们定义的概率“p”形象化。我们可以通过从我们的取样器取样来做到这一点。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/6f3f53e90027af4a0fa110aa697bfc36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*dhI5OHdtxd0CIX1HFjyH3g.png"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">The posterior distribution for our accuracy score given 100 examples</figcaption></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="711f" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt;     mean    std    median    2.5%    97.5%     n_eff     r_hat<br/>&gt;&gt;&gt; p   0.86   0.04      0.86    0.79     0.93    185.83      1.00<br/>    <br/>&gt;&gt;&gt; Number of divergences: 0</span></pre><p id="1e74" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不是一个很好的结果… 100 次观察并不足以确定一个好的结果。该分布似乎并不集中在一个特定的值上，当我们要求 95%的可信区间时，我们的真实值可以在 79%和 93%之间。对于我们的目的来说，这可能足够准确，也可能不够准确。</p><p id="6756" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们看看当我们使用全部 14，000 个观察值时，我们对我们的模型有多大的信心</p><h1 id="26b2" class="kw kx it bd ky kz ni lb lc ld nj lf lg lh nk lj lk ll nl ln lo lp nm lr ls lt bi translated"><strong class="ak">修改我们的模型</strong></h1><p id="0864" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">如果我们通过同一个模型运行所有 14，000 个观察值，那么运行时间将会非常长。<br/>这是因为我们在代码中循环遍历每个观察。</p><p id="f16b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Pyro 包含一个更方便的、矢量化的方法来处理我们的模型。</p><p id="6cb9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们重新定义了模型函数，使其不接受任何观察值，而是返回自己的观察值</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="c4e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们定义了第二个函数，它将模型函数和观察值作为输入，并利用“pyro.poutine”在条件环境中运行模型函数。重要的是，我们在这里的观察值与它们在模型函数中的名称相同(“obs”)。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="3851" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我们重新运行 MCMC 采样器，但是现在使用我们的条件模型，我们发送我们的模型函数，以及我们的观察，作为参数</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="4b24" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt; Sample: 100%|█████████████████████████████████████████| 200/200 [01:47,  1.86it/s, step size=7.87e-01, acc. prob=0.984]</span></pre><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/34f58dded5ae7180411490bf08e00e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*WU2uH-Trdo5kaUkODolx8w.png"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">The posterior distribution for our accuracy score given 14,000 examples</figcaption></figure><pre class="mn mo mp mq gt my mz na nb aw nc bi"><span id="cd9e" class="nd kx it mz b gy ne nf l ng nh">&gt;&gt;&gt;    mean    std    median      2.5%     97.5%     n_eff     r_hat<br/>&gt;&gt;&gt; p2 0.87   0.00      0.87      0.87      0.87      9.88      1.07<br/>    <br/>&gt;&gt;&gt; Number of divergences: 0</span></pre><p id="0eee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以在 87%左右得到更紧密的配合。为了比较这两个分布，我们可以把它们画在一起。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="nt nu di nv bf nw"><div class="gh gi ns"><img src="../Images/63a69a0b4d5fc5df983d1cf3d6555b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZEdc-S27leJkHzATTxVjpA.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">The two posterior distributions for our accuracy based on the number of support examples</figcaption></figure><p id="59d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望你们都喜欢阅读这篇关于 Pyro 及其功能的简介。我当然期待尝试新的东西，更多地使用概率编程！</p></div></div>    
</body>
</html>