<html>
<head>
<title>Simple Soybean Price Regression with Fast.ai Random Forests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于 Fast.ai 随机森林的简单大豆价格回归</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/simple-soybean-price-regression-with-fast-ai-random-forests-44ab46bf384e?source=collection_archive---------10-----------------------#2019-01-23">https://towardsdatascience.com/simple-soybean-price-regression-with-fast-ai-random-forests-44ab46bf384e?source=collection_archive---------10-----------------------#2019-01-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/c0752e519694f5c7c03001680ecbd33c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HN7E9uHCGppbbVwrdlVJZQ.jpeg"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk">image credit: Pexels.com</figcaption></figure><p id="7c43" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">将前沿机器学习应用于商品价格。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="e44c" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">作为一名对农业感兴趣的 fast.ai 机器学习 for Coders MOOC 的学生，想到的 fast.ai 随机森林回归库的第一个应用是根据历史数据预测大豆价格。大豆是一种全球大宗商品，在过去十年里，其每蒲式耳的价格每天都在大幅波动。</p><p id="37b0" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">个别商品的价格历史可以作为简单的结构化表格数据在网上免费获得，这使得这成为一个直截了当的开头话题。下面是代码——注意我们使用的是 Python 3 和 fast.ai 0.7，所以请遵循安装说明。</p><p id="3d39" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">首先，我们需要在开始之前导入我们的包:fast.ai、quandl、pandas、sk learn——常见的数据科学库。</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="bd3e" class="ln lo iq lj b gy lp lq l lr ls">%load_ext autoreload<br/>%autoreload 2<br/>%matplotlib inline</span><span id="da0e" class="ln lo iq lj b gy lt lq l lr ls">import quandl</span><span id="5dc8" class="ln lo iq lj b gy lt lq l lr ls">from fastai.imports import *<br/>from fastai.structured import *</span><span id="d2ed" class="ln lo iq lj b gy lt lq l lr ls">from pandas_summary import DataFrameSummary<br/>from sklearn.ensemble import RandomForestRegressor, RandomForestClassifier<br/>from IPython.display import display</span><span id="4eef" class="ln lo iq lj b gy lt lq l lr ls">from sklearn import metrics</span></pre><p id="2687" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">数据来自免费的 Quandl TF grain/大豆数据集。Quandl 为他们的 API 提供了一个简单的 Python SDK，即入门指南。下拉整个数据集只有一行(很短):</p><p id="c7a0" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated"><code class="fe lu lv lw lj b">data = quandl.get("TFGRAIN/SOYBEANS", authtoken="&lt;your token")</code></p><p id="21d8" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">这将返回一个 Pandas 数据帧(我们称之为“数据”)，并且<code class="fe lu lv lw lj b">data.info()</code>显示有 4535 行数据被事件日期时间索引。我们可以用<code class="fe lu lv lw lj b">data.tail()</code>来表示格式:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="1a22" class="ln lo iq lj b gy lp lq l lr ls">&lt;class 'pandas.core.frame.DataFrame'&gt;<br/>DatetimeIndex: 4535 entries, 2000-12-01 to 2019-01-14<br/>Data columns (total 4 columns):<br/>Cash Price    4535 non-null float64<br/>Basis         4535 non-null float64<br/>Fall Price    4516 non-null float64<br/>Fall Basis    4516 non-null float64<br/>dtypes: float64(4)<br/>memory usage: 177.1 KB</span></pre><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/62b058d03455eab1334699d5bf8dea05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*3kK-ppwQDDIpNUp4z69xrQ.png"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk">data.head()</figcaption></figure><p id="29fc" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">由于我们有日期时间，这是一个很好的机会来利用 fast.ai 库的日期处理功能工程能力。我将索引重命名为“data ”,并创建了一个新列，其中包含可以由<code class="fe lu lv lw lj b">add_datepart()</code>函数处理的相同值:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="9775" class="ln lo iq lj b gy lp lq l lr ls">data.rename_axis('Date')<br/>data['Date'] = data.index<br/>add_datepart(data, 'Date')<br/>data.info()</span></pre><p id="452f" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">新列如下。杰瑞米·霍华德在 ML1 第一课中深入解释了这些新列是如何创建的，以及为什么创建。</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="ca09" class="ln lo iq lj b gy lp lq l lr ls">&lt;class 'pandas.core.frame.DataFrame'&gt;<br/>DatetimeIndex: 4535 entries, 2000-12-01 to 2019-01-14<br/>Data columns (total 18 columns):<br/>id                  4535 non-null int64<br/>Cash Price          4535 non-null float64<br/>Basis               4535 non-null float64<br/>Fall Price          4516 non-null float64<br/>Fall Basis          4516 non-null float64<br/>Year                4535 non-null int64<br/>Month               4535 non-null int64<br/>Week                4535 non-null int64<br/>Day                 4535 non-null int64<br/>Dayofweek           4535 non-null int64<br/>Dayofyear           4535 non-null int64<br/>Is_month_end        4535 non-null bool<br/>Is_month_start      4535 non-null bool<br/>Is_quarter_end      4535 non-null bool<br/>Is_quarter_start    4535 non-null bool<br/>Is_year_end         4535 non-null bool<br/>Is_year_start       4535 non-null bool<br/>Elapsed             4535 non-null int64<br/>dtypes: bool(6), float64(4), int64(8)</span></pre><p id="825f" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">为了简单起见，我在大豆价格回归中第一次删除了一些列。我只保留 col_list 变量中列出的列。</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="0621" class="ln lo iq lj b gy lp lq l lr ls">col_list = ['Cash Price', 'Basis', 'Year', 'Month', 'Week', 'Day', 'Dayofweek', 'Dayofyear']</span><span id="0c11" class="ln lo iq lj b gy lt lq l lr ls">dfdata = dfdata[col_list]</span></pre><p id="05e3" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">为了清理格式，我从 Pandas 数据帧中提取值并重新导入:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="3983" class="ln lo iq lj b gy lp lq l lr ls">df = dfdata.values<br/>df = pd.DataFrame.from_records(df)<br/>df.columns = col_list</span></pre><p id="29b8" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">现在我们又有了一个 Pandas dataframe，我使用了另一个方便的 fast.ai 函数，它(如文档所解释的那样)<strong class="km ir">将字符串列转换为分类值列，并就地完成。</strong>为什么？允许随机森林回归器理解表格数据。同样，这将在本课程中更深入地讨论。</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="5a7e" class="ln lo iq lj b gy lp lq l lr ls">train_cats(df)</span></pre><p id="560b" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">另一个 fast.ai 预处理器(如文档所述)<strong class="km ir">获取数据帧，分离响应变量，并将测向转换为全数字数据帧。</strong>我们的因变量(‘y’)是这个谷物升降机的大豆每日现金价格，其他一切都是自变量。</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="1336" class="ln lo iq lj b gy lp lq l lr ls">df, y, nas = proc_df(df, 'Cash Price')</span></pre><p id="9d44" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">现在我们已经准备好适应我们的数据了！这很简单，因为:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="5ca7" class="ln lo iq lj b gy lp lq l lr ls">m = RandomForestRegressor(n_jobs=-1)<br/>m.fit(df, y)<br/>m.score(df,y)</span><span id="c556" class="ln lo iq lj b gy lt lq l lr ls">Score: 0.9991621993655437</span></pre><p id="e978" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">相当不错！Fast.ai 对此的准确率为 99.91%，因此现在我们可以向回归器投掷一个测试数据帧(具有相同的格式)，并获得实际的预测。这是我们的单行测试数据框架:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="57eb" class="ln lo iq lj b gy lp lq l lr ls">df1 = pd.DataFrame({'Basis':[-.85],<br/>                    'Year':[2019],<br/>                    'Month':[1],<br/>                    'Week':[4],<br/>                    'Day':[25],<br/>                    'Dayofweek':[6],<br/>                    'Dayofyear':[25],})</span></pre><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ly"><img src="../Images/e372877372dc291017f641b89a10b61a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9lBtzMDh6fI9FrF88UDgg.png"/></div></div></figure><p id="d408" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">并获得对 2019 年 1 月 25 日的价格的单一预测，给定 85 美分的基数:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="e221" class="ln lo iq lj b gy lp lq l lr ls">train_cats(df1)<br/>m.predict(df1) </span><span id="f1ba" class="ln lo iq lj b gy lt lq l lr ls">Return: array([8.465])</span></pre><p id="fbbb" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">一蒲式耳大豆估计售价为 8.465 美元。</p><p id="1a45" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">为了好玩，我画了一张图，显示基差的变化如何影响一天(2019 年 1 月 25 日)的回归。代码:</p><pre class="jv jw jx jy gt li lj lk ll aw lm bi"><span id="c276" class="ln lo iq lj b gy lp lq l lr ls">df1.iloc[0:, 0] = -.95<br/>iterpreds = list()<br/>a = list()<br/>for x in range(0,10):<br/>    df1.iloc[0, 0] += .1<br/>    b = df1.at[0, 'Basis']<br/>    iterpreds.append(m.predict(df1).astype(float).item(0))<br/>    a.append(b)</span><span id="f123" class="ln lo iq lj b gy lt lq l lr ls">plt.plot(a, iterpreds)</span></pre><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi lz"><img src="../Images/9e703762dfc80d12240cc74aefc21f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*K-2whzzeaE_A-INb8bjUmg.png"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk">basis on x axis, price on y</figcaption></figure><p id="9125" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">可以做得更多！我们应该扩展我们的模型，以包括所有可用的列，看看是否有第二种商品可以添加到模型中，以探索其他作物价格是否同步移动，并绘制随着时间的推移其他变量的变化的影响。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="08fd" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">参考资料:</p><p id="0ba0" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">[1]<a class="ae ma" href="https://course.fast.ai/ml.html" rel="noopener ugc nofollow" target="_blank">https://course.fast.ai/ml.html</a></p><p id="ee20" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">[2]<a class="ae ma" href="https://forums.fast.ai/t/fastai-v0-7-install-issues-thread/24652" rel="noopener ugc nofollow" target="_blank">https://forums . fast . ai/t/fastai-v 0-7-install-issues-thread/24652</a></p><p id="0fe3" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">[3]https://docs.quandl.com/docs/getting-started<a class="ae ma" href="https://docs.quandl.com/docs/getting-started" rel="noopener ugc nofollow" target="_blank"/></p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="f040" class="pw-post-body-paragraph kk kl iq km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ij bi translated">附加代码在我的 github 上:<a class="ae ma" href="http://www.github.com/matthewarthur" rel="noopener ugc nofollow" target="_blank">www.github.com/matthewarthur</a>，我的 LinkedIn 是<a class="ae ma" href="https://www.linkedin.com/in/matt-a-8208aaa/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/matt-a-8208aaa/</a>。</p></div></div>    
</body>
</html>