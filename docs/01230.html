<html>
<head>
<title>Deploy ML/DL Models to Production via Panini</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过 Panini 将 ML/DL 模型部署到生产中</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-ml-dl-models-to-production-via-panini-3e0a6e9ef14?source=collection_archive---------14-----------------------#2019-02-25">https://towardsdatascience.com/deploy-ml-dl-models-to-production-via-panini-3e0a6e9ef14?source=collection_archive---------14-----------------------#2019-02-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/2b635d7e9e712ab117f3be9c1643e05d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6E1rRsoBEvBJ7WJ0IbkMtw.png"/></div></div></figure><div class=""/><p id="e5a0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://paniniai.com" rel="noopener ugc nofollow" target="_blank">https://paniniai.com</a>是一个以低延迟为 ML/DL 模型提供服务的平台，可以将 ML 模型部署到生产环境的时间从几天缩短到几分钟。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="022c" class="le lf jb bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">帕尼尼是什么？</h1><p id="0ff2" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">Panini 是一个以低延迟为 ML/DL 模型提供服务的平台，使 ML 模型从几天到几分钟内部署到生产环境。一旦部署在 Panini 的服务器中，它将为您提供一个 API 密钥来推断模型。Panini 查询引擎是用 C++开发的，它在模型推理过程中提供了非常低的延迟，Kubernetes 集群用于存储模型，因此它可扩展到多个节点。Panini 还负责在模型推断期间缓存和批处理输入。</p><p id="1284" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们目前支持 Python 中的框架，但是我们计划将来扩展到其他语言。我来演示一下上传经典迁移学习 Pytorch CNN 模型对狗和猫进行分类。源代码可从 https://github.com/avinregmi/Panini_Tutorial 的<a class="ae kw" href="https://github.com/avinregmi/Panini_Tutorial" rel="noopener ugc nofollow" target="_blank">获得。确保您安装了 Pytorch 1.0 和 Python 3.6。</a></p><h1 id="50ff" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">传统方法</h1><p id="957f" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">传统的方法是将 Flask 和 Gunicorn 与 Nginx 一起使用，这需要大量的设置时间。此外，用 Flask 推断模型很慢，并且需要定制代码来进行缓存和批处理。使用烧瓶在多台机器中结垢也会导致许多复杂情况。<br/>大多数人都在使用 Flask 向互联网公开 ML 模型并进行 API 调用。因为 Flask 不是服务于 ML 模型的合适平台。使用烧瓶的一些显著缺点包括:</p><ol class=""><li id="06eb" class="mm mn jb ka b kb kc kf kg kj mo kn mp kr mq kv mr ms mt mu bi translated">它不支持缓存和批处理。</li><li id="69e5" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">高延迟。有时需要预先计算预测。</li><li id="2ea6" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">维护。</li><li id="f5e6" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">难以在多个集群中扩展。</li></ol><p id="c97a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了解决这些问题，我们开发了帕尼尼。</p><h1 id="6177" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated"><strong class="ak">安装所需的包</strong></h1><p id="32dc" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">Panini 需要<strong class="ka jc"> python 3.6 </strong>所以确保安装了 3.6 的环境。另外，如果你使用 Pytorch，确保你已经安装了<strong class="ka jc"> Pytorch 1.0 </strong>。</p><h1 id="aa8e" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">部署经典的狗与猫</h1><p id="bb76" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">完整的源代码可以从</p><p id="7435" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/avinregmi/Panini_Tutorial/blob/master/PyTorch_CNN_Production/Panini_Transfer_Learning_Demo_YouTube.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/avinregmi/Panini _ Tutorial/blob/master/py torch _ CNN _ Production/Panini _ Transfer _ Learning _ Demo _ YouTube . ipynb</a></p><p id="66cd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将使用迁移学习来修改 DenseNet 的最后一层。</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="2fad" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存模型时，确保只保存权重，而不是整个模型架构。推荐的方法是通过调用 state_dict()来保存权重。训练模型的代码非常简单，可以通过打开上面的链接来检索。我已经包括了 Jupyter 笔记本和一个 YouTube 教程。我已经预先训练了 DenseNet 模型来对狗和猫进行分类。我将权重保存为“last_layers.pth”</p><h1 id="2639" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">为帕尼尼准备文件</h1><p id="e468" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">你需要上传至少三个文件到帕尼尼</p><ul class=""><li id="4840" class="mm mn jb ka b kb kc kf kg kj mo kn mp kr mq kv ng ms mt mu bi translated"><strong class="ka jc"> predict.py </strong></li><li id="a589" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated"><strong class="ka jc"> requirements.txt </strong></li><li id="a8d4" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated"><strong class="ka jc">我们保存的模型权重(last_layers.pth) </strong></li></ul><p id="29e3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最重要的文件是 predict.py，这个文件告诉 Panini 加载您的模型并进行预测。如果您有额外的软件包，如 numpy 和 pandas，它可以通过在 requirements.txt 文件中指定 pip 软件包来安装。我们需要的最后一个文件是保存的权重模型。该文件可以命名为任何名称，但扩展名必须是. pth。</p><p id="bbe6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> <em class="nh"> Predict.py </em>脚本里面需要有两个方法。它们是 load()和 predict() </strong></p><ul class=""><li id="2107" class="mm mn jb ka b kb kc kf kg kj mo kn mp kr mq kv ng ms mt mu bi translated"><strong class="ka jc"> load(path): </strong>当您的模型被加载到 Panini 的 Kubernetes 集群中时，第一次执行 load。它必须接受一个名为 path 的参数，并返回一个对模型的引用。您需要在这里指定您的模型架构，并将 weights.pth 文件加载回您的模型。在您的模型加载了预先训练的权重之后，它需要返回对您的模型的引用。</li><li id="d994" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated"><strong class="ka jc"> predict(model，input_from_client): </strong>每次向 API 链接发送 POST 请求时，都会执行 predict。它需要模型和 input_from_client 的参数。第一个参数是由 load 函数返回的对模型的引用。下一个参数是客户端通过 POST 请求发送的数据。另外，input_from_client 是一个数组，所以我们必须使用 for 循环来访问每个图像。一旦我们有了每个图像，我们可以应用一些预处理，并将我们的图像转换成张量。一旦我们的图像被转换成张量，我们就可以输入到我们的模型中。我们的模型将返回一个对数概率，这也是一个列表，我们可以将它返回给我们的客户端。确保值 predict()返回一个数组。此外，数组的长度必须等于模型中最后一层的长度。我们用神经网络修改了上面模型的最后一层。线性(256，2)。因此，predict()需要返回一个长度为 2 的数组。</li></ul><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="ecba" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">部署时间到了</h1><p id="8b5d" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">登录<a class="ae kw" href="http://paniniai.com" rel="noopener ugc nofollow" target="_blank">https://paniniai.com</a>并创建一个账户。您可以使用 Google 帐户或 GitHub 登录。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/446cdc0538fc515a67545b1254f1dc27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dFV7RJII4y_uEaONwI1NeQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">Panini Dashboard</figcaption></figure><p id="5d5a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录后，您将看到一个仪表板，并被要求填写一些信息。首先，给你的模型起个名字。名称必须少于或等于 10 个字符，并且只能是(a-z/0–9)。对于框架选择，PyTorch。目前，您有三种不同的选择。</p><ul class=""><li id="404c" class="mm mn jb ka b kb kc kf kg kj mo kn mp kr mq kv ng ms mt mu bi translated"><strong class="ka jc"> PyTorch </strong>:如果需要使用深度学习。目前，我们支持 Pytorch 1.0</li><li id="951e" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated"><strong class="ka jc"> Python 函数</strong>:任意自定义 Python 函数。这包括 SciKit-Learn 和传统的机器学习，如 SVM 和回归。</li><li id="2c28" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated"><strong class="ka jc">快速 AI </strong>:如果你用的是快速 AI 库。</li></ul><p id="7e83" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还需要指定模型期望的输入类型。因为我们将发送一张狗/猫的图片，并且将被编码为 base64 字节，所以让我们选择字节作为输入类型。点击浏览并选择你的三个文件。</p><ul class=""><li id="6b12" class="mm mn jb ka b kb kc kf kg kj mo kn mp kr mq kv ng ms mt mu bi translated"><strong class="ka jc"> predict.py </strong></li><li id="6eb3" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated">r <strong class="ka jc"> equirements.txt </strong></li><li id="eb45" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv ng ms mt mu bi translated"><strong class="ka jc"> last_layers.pth </strong></li></ul><p id="b6b7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">额外的文件是可选的，不是必需的。有些型号需要额外的文件，如用于 RNNs 的 vocab 到整数映射 pickle 文件。在我们的例子中，我们没有额外的文件，所以我们可以把它留为空白。</p><p id="e9be" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择三个文件后，单击“部署！”并等待文件上传达到 100%。目前，模型大小限制为 2GB。如果您的型号超过 2GB，请给我们发电子邮件。</p><h1 id="9f87" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">日志输出</h1><p id="6261" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">一旦页面显示 100%,您可以刷新页面以查看最新的日志输出。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/5458df41561a547ec43ac695e1d72d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ThRBSXWGFjkO8VYYOOAckA.png"/></div></div></figure><p id="90be" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后的日志输出应该是“完成部署您的模型！你可以走了！”出现此消息后，您应该会在控制台上方看到一个 API 链接。</p><h1 id="98e4" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">如何使用我们的 API 进行推断？</h1><p id="afa2" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我们将对一只可爱的猫的图片进行 base64 编码，并发送给帕尼尼进行预测。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div class="gh gi no"><img src="../Images/6f3aa902abcf9695711c19b849da44a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*-zmMNneS7C6GICq1AQQswA.png"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">Let’s send this cute picture to Panini for Prediction.</figcaption></figure><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="e8f2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要做的就是向我们的 API URL 发送一个 POST 请求。要发送图像，我们需要用 base64 编码，并用 JSON 格式包装。此外，关键标签应该是“输入”，值将是我们的图像的 base64 编码字节格式。</p><figure class="na nb nc nd gt is gh gi paragraph-image"><div class="gh gi np"><img src="../Images/2a11b965bfb5edd348c35a23432907a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*0uPB2CEpq5V7CoxHExaQlw.png"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">Prediction result from Panini</figcaption></figure><p id="6ad4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">我们也可以使用邮递员</strong></p><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/c977e7cc5d2ea3925bbe0278b0e85b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O3Cow8p8yidaVSTut2Q0lQ.png"/></div></div></figure><h1 id="c3d0" class="le lf jb bd lg lh mh lj lk ll mi ln lo lp mj lr ls lt mk lv lw lx ml lz ma mb bi translated">最后</h1><p id="de63" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">我们已经使用 Panini 成功地将 DL 模型部署到生产中。随着我们模型的流量增加，panini 会自动将其复制到几个节点中。如果我们想将它合并到 web 应用程序中，我们可以从 javascript/NodeJs 发出 POST 请求。我们可以专注于开发我们的模型，而不用担心 DevOps。如果您在上传模型时遇到问题，请发送电子邮件给我们！</p><p id="b83e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh"> YouTube 教程:</em><a class="ae kw" href="https://www.youtube.com/watch?v=tCz-fi_NheE&amp;t=" rel="noopener ugc nofollow" target="_blank">T17】https://www.youtube.com/watch?v=tCz-fi_NheE&amp;t =</a></p><p id="11b5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nh">源代码:【https://github.com/avinregmi/Panini_Tutorial】<a class="ae kw" href="https://github.com/avinregmi/Panini_Tutorial" rel="noopener ugc nofollow" target="_blank"><em class="nh"/></a></em></p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="nr nf l"/></div></figure></div></div>    
</body>
</html>