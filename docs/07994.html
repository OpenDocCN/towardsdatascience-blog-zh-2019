<html>
<head>
<title>How To Plot Time Series</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何绘制时间序列</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-plot-time-series-86b5358197d6?source=collection_archive---------4-----------------------#2019-11-04">https://towardsdatascience.com/how-to-plot-time-series-86b5358197d6?source=collection_archive---------4-----------------------#2019-11-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/58d77271559c116cf122f562da1e87da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UxoCWvHWty1QdD8a"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@chrislawton?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Chris Lawton</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="dd98" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果处理得当，处理时间序列可能是<a class="ae kf" href="https://en.wikipedia.org/wiki/Exploratory_data_analysis" rel="noopener ugc nofollow" target="_blank">探索性数据分析</a>中最有洞察力的部分之一。在这篇文章中，我们将使用来自<a class="ae kf" href="https://www.yelp.com/dataset" rel="noopener ugc nofollow" target="_blank"> Yelp 数据集</a>的签到日志，使用<a class="ae kf" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Pandas </a>和<a class="ae kf" href="https://matplotlib.org/api/pyplot_api.html" rel="noopener ugc nofollow" target="_blank"> Matplotlib </a>来探索不同时间段的趋势。</p><h1 id="58ec" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">数据采集</h1><p id="5fc0" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">下载完数据后，我们需要知道使用什么。下面的块显示了基于<a class="ae kf" href="https://www.yelp.com/dataset/documentation/main" rel="noopener ugc nofollow" target="_blank"> Yelp 文档</a>的<code class="fe mh mi mj mk b">checkin.json</code>文件中的一个示例条目:</p><pre class="ml mm mn mo gt mp mk mq mr aw ms bi"><span id="2936" class="mt lf it mk b gy mu mv l mw mx">{<br/>    // string, 22 character business id, maps to business in business.json<br/>    <strong class="mk iu">"business_id": "tnhfDv5Il8EaGSXZGiuQGg"</strong><br/><br/>    // string which is a comma-separated list of timestamps for each checkin, each with format YYYY-MM-DD HH:MM:SS<br/>    <strong class="mk iu">"date": "2016-04-26 19:49:16, 2016-08-30 18:36:57, 2016-10-15 02:45:18, 2016-11-18 01:54:50, 2017-04-20 18:39:06, 2017-05-03 17:58:02"</strong><br/>}</span></pre><p id="df3a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以用带参数<code class="fe mh mi mj mk b">orient=columns</code>和<code class="fe mh mi mj mk b">Lines=True</code>的熊猫<a class="ae kf" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_json.html" rel="noopener ugc nofollow" target="_blank"> read_json </a>方法读取输入文件。</p><p id="64e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在读取数据时，我们的数据帧看起来像这样:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/642e140747bdfe23ba4c36d33b6555ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ghAow2lZDxq2lIchtDJDEg.png"/></div></div></figure><p id="35af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mh mi mj mk b">date</code>列条目是字符串，每个日期由逗号分隔。通过查看它们，我们可以知道格式确实是<code class="fe mh mi mj mk b">YYYY-MM-DD HH:MM:SS</code>。</p><h1 id="15f7" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">数据争论</h1><p id="25a4" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了可读性，我们希望我们的数据帧看起来更像这样:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/9456a8e040742b08cd75758ff8429cd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*RDM2ndPsw0XoZki2YZ6Ghg.png"/></div></figure><p id="18b2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从 EDA 的角度来看，展开的事件日志更有意义，而 JSON 格式对于内存存储更有意义。</p><p id="ca57" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以通过创建一个字典来获得这个结果，其中的键对应于日期，值对应于 business_id。在这里，我们假设日期足够细，因此没有两个日期是相同的。记住<a class="ae kf" href="https://docs.python.org/3/tutorial/datastructures.html#dictionaries" rel="noopener ugc nofollow" target="_blank"> python 文档</a>不允许在一个字典中有重复的键。</p><p id="0ddc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">实现可以如下进行:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="d3df" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">季节性</h1><p id="34d1" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">假设我们想知道所有可用年份的入住总数。我们将以此为契机，通过方法引入可以在<a class="ae kf" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.groupby.html" rel="noopener ugc nofollow" target="_blank">群内使用的</a><a class="ae kf" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Grouper.html" rel="noopener ugc nofollow" target="_blank">熊猫群</a>。有关频率别名的更多信息，请参考<a class="ae kf" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases" rel="noopener ugc nofollow" target="_blank"> pandas 文档</a>。</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="0ac5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">代码返回了这个简洁的图形:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/a8e203b5486ed4d792ffbebc5fbdc883.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*Jzb4vtsRiDPrz0mcp_259g.png"/></div></figure><p id="17eb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个好的开始，但是如果我们想潜得更深呢？我们将放大到 2014 年，尽管任何其他年份都可以。选择日期范围很简单:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="c621" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">季节性的第一个指标是看周末，因为数据来自美国和加拿大，周末是周六和周日。请记住，周末因国家而异，例如迪拜的周末是周五和周六。</p><p id="8cdb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们希望检测哪些天是周末，并为其编写一个可定制的函数:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="7e7c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的函数返回周末的指数。接下来，为了绘图，我们定义了另一个辅助函数，以在<a class="ae kf" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.axvspan.html" rel="noopener ugc nofollow" target="_blank"> pyplot axvspan </a>的帮助下突出显示与这些指数相对应的绘图范围:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="5510" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们可以在一个接收数据帧的更大的函数中使用这两个函数:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="7212" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果是这个简洁的情节:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/fcd221a746b5788e4eb74b54cd649b02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XK4yDRdZZxLS-sbK1ipzgQ.png"/></div></div></figure><p id="3d82" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的情节符合人们周末出门比工作日多的直觉。为了更好地了解这种累积，我们可以使用相同的函数更仔细地查看 2014 年 4 月。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/797a062f4eda1277ac43ca5a2aa446ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8J2arvOVc2mbMNuaVWYYjw.png"/></div></div></figure><p id="1af9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们想要显示一个更细粒度的四月视图呢？由于原始数据帧中的每个条目都是一次签入，因此我们可以按 30 分钟的频率分组，并按如下方式计数:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="1e43" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果就是下图:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/4b274e65d6ed368834f8d2dfee3c27a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKOPukokq6ZZVrsygomObQ.png"/></div></div></figure><h1 id="d847" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">绘制置信区间</h1><p id="79b6" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们看到了如何放大时间段来获得季节性的感觉。然而，企业也想知道给定一天的预期签到数量，以及它可能如何变化。例如，我们可能正在求解一个回归方程。</p><p id="e400" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们需要构建图表来显示一周中某一天的平均签入量和某种置信区间。</p><p id="ad2b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用上一节中定义的<code class="fe mh mi mj mk b">checkin_halfhour</code>来提取星期几:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="3115" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的数据帧现在看起来如下:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ne"><img src="../Images/7959cc1f3ff9ca448c5c6e058e76e768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-iqTwghTmUhAhj8Zk4_uFA.png"/></div></div></figure><p id="e0f8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们使用<a class="ae kf" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.agg.html" rel="noopener ugc nofollow" target="_blank"> pandas aggregate </a>方法构建<code class="fe mh mi mj mk b">day_avg</code>数据框架。出于我们的目的，我们将汇总:</p><ul class=""><li id="d1ad" class="nf ng it ki b kj kk kn ko kr nh kv ni kz nj ld nk nl nm nn bi translated">总和</li><li id="95b7" class="nf ng it ki b kj no kn np kr nq kv nr kz ns ld nk nl nm nn bi translated">平均</li><li id="602c" class="nf ng it ki b kj no kn np kr nq kv nr kz ns ld nk nl nm nn bi translated">标准偏差</li></ul><p id="b5d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面的代码块为我们做到了这一点:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="5755" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在有了一个可以用来绘制区间的数据框架:</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/6765c4ad202ed93bace2e0397224d650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ra5BXHNe3LGzBS68mzSOig.png"/></div></div></figure><p id="4211" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们如何定义间隔取决于数据的分布以及窄/大间隔的商业价值。在我们的例子中，我们希望为一周中的每一天生成预期的签入，并获取两个标准偏差内的所有信息。</p><p id="134e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样做是为了注意如下所示的<code class="fe mh mi mj mk b">day_avg</code>索引中的级别:</p><figure class="ml mm mn mo gt ju"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="e256" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">结果图揭示了很多签入行为，举例来说，我们展示了周一、周三和周六。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/b21fa6ea4067a78134f16dad701a97c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IzYoY-SHUHyFCE1fvZmsPg.png"/></div></div></figure><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/e625e5687b86777602e7324e498624a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1qrC1RxXMdWXkufQ8uUlhw.png"/></div></div></figure><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/2b9b8238f2a5050a1b08acc5178bb277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uf5_91bHcL09yeA1BBbOWw.png"/></div></div></figure><h1 id="f30e" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="a849" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">时间序列分析的数量和深度取决于我们试图解决的问题。例如，我们可能想要评估餐馆，或者只在早上 8 点到下午 3 点营业的企业，比如咖啡馆。</p><p id="7c2d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">EDA 的一个目的是为特征提取做准备。通过上面的练习，我们可以开始考虑一些特性，比如最常见的签到时间，或者说是白天的签到。</p></div></div>    
</body>
</html>