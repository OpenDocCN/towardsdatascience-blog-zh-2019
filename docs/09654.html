<html>
<head>
<title>Pandas Tips &amp; Tricks: Need For Speed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫小贴士:需要速度</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pandas-tips-tricks-need-for-speed-54e217cc6aa0?source=collection_archive---------22-----------------------#2019-12-18">https://towardsdatascience.com/pandas-tips-tricks-need-for-speed-54e217cc6aa0?source=collection_archive---------22-----------------------#2019-12-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="770d" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">像 PYTHON 专家一样进行数据分析</h2><div class=""/><div class=""><h2 id="c199" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">个人最喜欢的一句俏皮话</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/e425f594133d23ce0f32af67b98b931a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZDc9qR2c7-xu_2_hO-MDtQ.jpeg"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">Source: <a class="ae lh" href="https://unsplash.com/photos/dast7B6U2Aw" rel="noopener ugc nofollow" target="_blank">Unsplash</a>.</figcaption></figure><h1 id="2249" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">概观</h1><p id="0b40" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated"><a class="ae lh" rel="noopener" target="_blank" href="/demo-for-rfiw-2020-task-1-kinship-verification-8a8ed7081bcc">我的上一篇文章</a>展示了一个评估一组人脸对以确定这两个人是否有血缘关系的简单过程。几个片段像<em class="mw">黑盒</em>一样被轻轻带过。让我们来看看其中的一个片段，一个简单的<em class="mw">单命令行程序</em>:我最近学习的 Python <a class="ae lh" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">熊猫</a>特性，现在经常使用。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="754b" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">DataFrame 包含面对<em class="mw"> p1 </em>和<em class="mw"> p2 </em> ( <strong class="mc jd">图 1 </strong>)和特征(type <strong class="mc jd"> dict </strong>)的列表，文件名作为关键字，面编码作为值。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ne"><img src="../Images/1cdf080c6e67c86d068cfffb5d986516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f1Mnl_vNL75Xo62cNQfSLA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk"><strong class="bd nf"><em class="ng">Fig. 1.</em></strong><em class="ng"> </em>df_pairlist.<a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.head.html" rel="noopener ugc nofollow" target="_blank"><em class="ng">head</em></a><em class="ng">(5): top 5 of &gt;100,000 rows. Notice samples are repeated, but pairs are unique (i.e., member 1 of family 7 is the bother of member 9 of family 7, each with various face samples paired. Specifically, </em><a class="ae lh" href="https://www.mathsisfun.com/data/binomial-distribution.html" rel="noopener ugc nofollow" target="_blank"><em class="ng">N</em>choose<em class="ng">(2</em></a><em class="ng">) face pairs, where N is the total number of faces of the two relatives).</em></figcaption></figure><p id="d41e" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">原来你在这里！在短短一行代码中，我们对数百万对进行了评分，而没有考虑内存或速度问题，同时为配对创建了一个分数列，作为同一个<a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html" rel="noopener ugc nofollow" target="_blank">数据帧</a>的一部分。</p><h1 id="643d" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">那又怎样？谁在乎呢。</h1><p id="97ec" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">在我们认识到这一点之前，让我们确保我们看到了问题。</p><p id="7ab6" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">首先，读取上面描述的数据结构。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">Load lists of pairs and features for each face present in the list</figcaption></figure><p id="23af" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">请注意，有&gt; 100，000 对，但有～10，000 个面:面以肯定、唯一和错误对的形式重复。</p><p id="b2f9" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">如何衡量所有配对的相似性(即每行计算一个分数)？</p><p id="2e01" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated"><strong class="mc jd">胸围#1。一个人可以循环，这是使用熊猫或<a class="ae lh" href="https://numpy.org/" rel="noopener ugc nofollow" target="_blank"> NumPy </a>的最不理想的方式之一。举个例子，</strong></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="mx my l"/></div></figure><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="3fbc" class="nm lj it ni b gy nn no l np nq">60.61587691307068 seconds</span></pre><p id="6886" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">这太慢了。太慢了！！！</p><p id="3fff" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">我们没有充分利用 pandas 的优势，甚至没有充分利用 NumPy 的矢量化能力。点击了解更多<a class="ae lh" href="https://realpython.com/numpy-array-programming/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c4ec" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">那么我们还能做什么呢？</p><p id="48e9" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated"><strong class="mc jd">胸围#2。我们可以将整个矩阵读入内存，但这不仅是多余的，因为通常有数百万对，每个元素是一个大小为 512(即 512 x 8 字节)的向量。因此，<em class="mw"> I/O </em>开销将会很慢，内存使用将不是最佳的，并且在大多数情况下，内存量不足。</strong></p><p id="8b4b" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated"><strong class="mc jd">解决方案。</strong>我们可以将<a class="ae lh" href="https://www.w3schools.com/python/python_dictionaries.asp" rel="noopener ugc nofollow" target="_blank">字典对象的键</a>映射到一个面孔列表。然后，<a class="ae lh" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.apply.html" rel="noopener ugc nofollow" target="_blank">对每一行应用</a>一个度量(即面<em class="mw"> A </em>和面<em class="mw"> B </em>，或者列 A 和 B)。因此，每一行都有各自配对的分数。</p><p id="5c8c" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated"><strong class="mc jd">因此，Python Pandas 提供了一个奇妙的解决方案。</strong></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk">A 1 liner: map features from a list of strings as keys to a dictionary pointing to the feature vector and following a functional programming paradigm for optimal performance.</figcaption></figure><p id="219f" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">这里我们指定<em class="mw"> axis=1，</em>意味着跨列应用(即，逐行)。</p><pre class="ks kt ku kv gt nh ni nj nk aw nl bi"><span id="0d33" class="nm lj it ni b gy nn no l np nq">3.53662109375 seconds</span></pre><p id="d19f" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated"><strong class="mc jd">几乎不费吹灰之力就实现了近 18 倍的速度提升！</strong>请注意，加速比只会随着样本量的增加而增加。这里，只有<a class="ae lh" href="https://web.northeastern.edu/smilelab/fiw/" rel="noopener ugc nofollow" target="_blank"> FIW </a>的一个子集用于演示目的。</p><p id="be0f" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">这个有效的技巧可以推广到许多基于 ML 的问题中遇到的情况。</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h2 id="0def" class="nm lj it bd lk ny nz dn lo oa ob dp ls mj oc od lu mn oe of lw mr og oh ly iz bi translated">动机(又名 Spiel)</h2><p id="9a46" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">为了使一篇博客的长度与前一篇文章提供的信息量相匹配，一些值得强调的内容被跳过或略过。拉胡尔·阿加瓦尔对 ROC 曲线做了一个聪明的评论，这让我恍然大悟——没有提供分析或定义，只有实现。因此，我相应地进行了更新(参见 ROC 上的<a class="ae lh" rel="noopener" target="_blank" href="/demo-for-rfiw-2020-task-1-kinship-verification-8a8ed7081bcc#4d14">部分)。然后，其他部分似乎值得额外的解释。这激发了我在这篇文章中最喜欢的一行代码上写这篇博客:一个狭窄的主题，一个快速的博客。</a></p><p id="a4f8" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">作为一个新的博客作者，我计划继续学习、适应和提高。此外，我写信给的是你。因此，你的意见、回答和问题对我的这个新爱好来说是很有价值的。请分享任何积极和消极的想法。提问。提出改进建议，甚至提出自己的想法！</p><p id="3963" class="pw-post-body-paragraph ma mb it mc b md mz kd mf mg na kg mi mj nb ml mm mn nc mp mq mr nd mt mu mv im bi translated">总而言之，我希望你喜欢它。敬请关注更多博客！</p></div><div class="ab cl nr ns hx nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="im in io ip iq"><h1 id="1134" class="li lj it bd lk ll ok ln lo lp ol lr ls ki om kj lu kl on km lw ko oo kp ly lz bi translated">相关博客</h1><ul class=""><li id="9d22" class="op oq it mc b md me mg mh mj or mn os mr ot mv ou ov ow ox bi translated">Sofia Heisler ，<a class="ae lh" href="https://engineering.upside.com/a-beginners-guide-to-optimizing-pandas-code-for-speed-c09ef2c6a4d6" rel="noopener ugc nofollow" target="_blank">优化熊猫代码速度的初学者指南</a></li><li id="04f5" class="op oq it mc b md oy mg oz mj pa mn pb mr pc mv ou ov ow ox bi translated"><a class="oi oj ep" href="https://medium.com/u/ffd7e98955c4?source=post_page-----54e217cc6aa0--------------------------------" rel="noopener" target="_blank"> Robbert van der Gugten </a> , <a class="ae lh" href="https://medium.com/bigdatarepublic/advanced-pandas-optimize-speed-and-memory-a654b53be6c2" rel="noopener">高级熊猫:优化速度和内存</a></li><li id="fc7a" class="op oq it mc b md oy mg oz mj pa mn pb mr pc mv ou ov ow ox bi translated"><a class="oi oj ep" href="https://medium.com/u/b7def7a159d6?source=post_page-----54e217cc6aa0--------------------------------" rel="noopener" target="_blank">塞尔瓦拉塔姆·拉维南</a>，<a class="ae lh" rel="noopener" target="_blank" href="/understanding-the-need-for-optimization-when-using-pandas-8ce23b83330c">了解使用熊猫时的优化需求</a></li></ul></div></div>    
</body>
</html>