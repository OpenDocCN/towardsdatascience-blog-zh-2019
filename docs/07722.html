<html>
<head>
<title>Why window function in SQL is so important that you should learn it right now</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么 SQL 中的窗口函数如此重要，你应该马上学习它</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/why-window-function-in-sql-is-so-important-that-you-should-learn-it-right-now-1274b6096a86?source=collection_archive---------8-----------------------#2019-10-26">https://towardsdatascience.com/why-window-function-in-sql-is-so-important-that-you-should-learn-it-right-now-1274b6096a86?source=collection_archive---------8-----------------------#2019-10-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="87fa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在你下次面试被问到之前，现在就学会它</h2></div><p id="97fc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的上一篇文章中，我提到我被多次问到如何使用一个窗口函数。在掌握它之后，我确信我应该更早地学习，因为它可以帮助我通过 SQL 进行更深入的分析。</p><blockquote class="le lf lg"><p id="7f09" class="ki kj lh kk b kl km ju kn ko kp jx kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">我上一篇关于使用 SQL 进行数据分析的文章</p></blockquote><div class="ll lm gp gr ln lo"><a rel="noopener follow" target="_blank" href="/how-to-use-sql-to-perform-data-analysis-house-property-sales-time-series-bf36cd3c2528"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">如何使用 SQL 进行数据分析(房产销售时间序列)</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">回到 basic，使用 SQL 从数据集中获取所有必要的信息</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">towardsdatascience.com</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc md lo"/></div></div></a></div><p id="bc5a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与会减少行数的 group by 函数不同，window 函数可以在不减少行数的情况下对每一行执行聚合。有许多不同的窗口功能。但今天我将告诉你如何使用窗口函数的基本知识，以及如何在你的数据分析中应用。</p><p id="1344" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我今天将使用的数据集是从 Kaggle 获得的“学生饮酒量”中的“学生垫”。然后数据集存储在 dataset.student_mat 中。您可以从以下链接下载数据集:</p><div class="ll lm gp gr ln lo"><a href="https://www.kaggle.com/uciml/student-alcohol-consumption" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">学生饮酒</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">下载数千个项目的开放数据集+在一个平台上共享项目。探索热门话题，如政府…</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">www.kaggle.com</p></div></div><div class="lx l"><div class="me l lz ma mb lx mc md lo"/></div></div></a></div><p id="e08f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一般来说，有两种类型的窗口函数；一个是内置函数，如 row_number、dense_rank、lag 和 lead 另一个是聚合，就像通常的聚合函数一样。对于窗口功能，有一个意义重大的关键词“过”。一旦注意到查询中有“over ”,就可以知道有一个窗口函数。</p><p id="6646" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在第一部分，我将解释如何使用聚合窗口函数，因为我相信你已经有一些使用普通聚合函数的知识。在了解了窗口函数的基础知识之后，理解内置函数就更容易了。</p><ol class=""><li id="0513" class="mf mg it kk b kl km ko kp kr mh kv mi kz mj ld mk ml mm mn bi translated"><a class="ae mo" href="#e267" rel="noopener ugc nofollow">聚合窗口函数</a></li><li id="43c6" class="mf mg it kk b kl mp ko mq kr mr kv ms kz mt ld mk ml mm mn bi translated"><a class="ae mo" href="#29d8" rel="noopener ugc nofollow">内置窗口功能</a></li></ol></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="e267" class="nb nc it bd nd ne nf dn ng nh ni dp nj kr nk nl nm kv nn no np kz nq nr ns nt bi translated">聚合窗口函数</h2><p id="9dde" class="pw-post-body-paragraph ki kj it kk b kl nu ju kn ko nv jx kq kr nw kt ku kv nx kx ky kz ny lb lc ld im bi translated">聚合窗口函数的基本语法是普通的聚合函数，但在 over 子句语句之后。这里我就用数据来论证。数据集中的前三列是学校、性别和年龄。现在你想知道每所学校中男女学生的年龄差异。然后就可以使用窗口功能了。</p><p id="452f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一步是计算每个学校的平均年龄。这可以从“avg(年龄)over(按学校划分)”中获得。over 之前的第一部分与正态平均函数相同。over 之后的第二部分称为“partition by”子句，需要用括号括起来。“按学校划分”意味着选择学校中具有相同值的所有记录并进行计算。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="b5e0" class="nb nc it oe b gy oi oj l ok ol">select school, sex,age, <br/>avg(age) over (partition by school) as age_avg_by_shl , <br/>age - avg(age) over (partition by school) as age_diff_from_shl_avg <br/>from dataset.student_mat</span></pre><figure class="nz oa ob oc gt on gh gi paragraph-image"><div role="button" tabindex="0" class="oo op di oq bf or"><div class="gh gi om"><img src="../Images/309eebcb53a241dc54f40cb677cea535.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*Lyld3RvQO_-pxt-dxiIfLA.png"/></div></div><figcaption class="ot ou gj gh gi ov ow bd b be z dk">age_avg_by_shl is not a constant in the whole column but varies by school.</figcaption></figure><p id="1b8d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">16.5215 为学校相当于“GP”，18.0217 为学校相当于 MS 与学校正常平均函数组匹配。</p><figure class="nz oa ob oc gt on gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/a945196e5d17d2c0643f80726e8142ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/format:webp/1*WWYW0CIx0Zd-DSZnvZ5fnQ.png"/></div></figure><p id="81e0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，现在您可以计算每个学生与平均值之间的差异，就像 age_diff_from_shl_avg 在查询中执行的操作一样。</p><figure class="nz oa ob oc gt on gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/58bc13825f38da8e934356a873a1e63f.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*5KJzoV4joMFz3i2CaCt2UQ.png"/></div></figure><p id="4f64" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后可以按学校和性别得出平均年龄差。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="9d84" class="nb nc it oe b gy oi oj l ok ol">select school, sex, round(avg(age),2) as avg_age , round(avg(age_avg_by_shl),2) as avg_age_school, round(avg(age_diff_from_shl_avg),2) as avg_age_diff_from_shl<br/>from <br/>(<br/>select school, sex,age, avg(age) over (partition by school) as age_avg_by_shl , age - avg(age) over (partition by school) as age_diff_from_shl_avg <br/>from dataset.student_mat <br/>) a<br/>group by school, sex</span></pre><figure class="nz oa ob oc gt on gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/e15a484d4cdc2eaf4700012d30f00c52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*Io2l1_rAm9uUAz4Px4BWCg.png"/></div></figure><p id="fed2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从现在你可以看出女性在全科医生中的年龄比男性大，但在多发性硬化症中却不是这样。</p><p id="6826" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">还有一栏地址显示学生是住在城市还是农村。然后你可以使用一个窗口函数，按学校和地区计算每个地区居住的学生的百分比。</p><p id="06a6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一步是通过聚合计算学校和地址的每个组合中作为通常组的学生人数。然后使用窗口函数计算每个学校和每个地址区域的学生总数。“sum(student _ CNT)over(partition by school)”将返回 GP 和 MS 的学生总数，而“student _ CNT/sum(student _ CNT)over(partition by address)”将返回城市和农村地区的学生总数。因此，您可以按学校和地址区域获得学生的百分比。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="34d1" class="nb nc it oe b gy oi oj l ok ol">select school, address, student_cnt<br/>, student_cnt / sum(student_cnt) over (partition by school) as percent_by_shl<br/>, student_cnt / sum(student_cnt) over (partition by address) as percent_by_address<br/>from <br/>(<br/>select school, address, count(1) as student_cnt<br/>from dataset.student_mat <br/>group by school, address<br/>) a</span></pre><figure class="nz oa ob oc gt on gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/703c31ac4b9d04fd03e24cc009862e87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*FTuiZcfy2bZGZ1ss0V7Kzw.png"/></div></figure><p id="3ec3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以你可以看出更多的全科医生学生生活在城市地区，而更多的理学硕士学生生活在农村地区。如果你发现一个学生住在城市地区，你几乎可以肯定这个学生来自 GP，因为超过 93%的城市学生在 GP 学习。这已经成为一种预测性分析，你可以用它来根据地址给学生分类。</p><p id="3274" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">聚合窗口函数的第三个示例稍微复杂一些。既然数据集叫“学生饮酒量”，当然要对其做一些分析。有两个分类栏“Dalc”和“Walc”显示工作日和周末的消费。然后，我们可以发现酒精消耗量是否会影响“g3”栏所示的最终结果。</p><p id="b688" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了简化，我将把两列加在一起，而不是把它们分开。然后计算 g3 的总平均值以及单个 g3 和 g3 的总平均值之间的差值。为了计算 g3 的整体平均值，这里我们不能使用 group by 函数，因为这样会减少行数。相反，我们使用 window 函数来获取结果并放入每一行。</p><p id="3735" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">语法“avg(g3) over()”的 over 之后的第二部分是空的，因为我们不需要对数据集进行分类。我们需要整个数据集来计算整体平均值。因此括号里面是空的。</p><p id="32ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您可以计算每个 wkalc 组的平均差异。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="ea25" class="nb nc it oe b gy oi oj l ok ol">select wkalc, round(avg(avg_g3_overall),2) as avg_g3_overall, round(avg(g3),2) as avg_g3, round(avg(g3_diff),2) as avg_g3_diff<br/>from <br/>(<br/>select (Dalc + Walc) as wkalc, g3, avg(g3) over () as  avg_g3_overall, g3 - avg(g3) over () as g3_diff<br/>from dataset.student_mat<br/>) a <br/>group by wkalc<br/>order by wkalc</span></pre><figure class="nz oa ob oc gt on gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/93c264adb437f347a75acbe076e668aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*OqDrR23buGePQW7sGV4w8Q.png"/></div></figure><p id="4665" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">饮酒量和 g3 结果之间没有明确的关系。所以还是喝吧(？)</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="29d8" class="nb nc it bd nd ne nf dn ng nh ni dp nj kr nk nl nm kv nn no np kz nq nr ns nt bi translated">内置窗口函数</h2><p id="1258" class="pw-post-body-paragraph ki kj it kk b kl nu ju kn ko nv jx kq kr nw kt ku kv nx kx ky kz ny lb lc ld im bi translated">现在我希望你知道聚合窗口函数的基本用法。接下来我就说说内置的窗口功能。下面是 11 个内置窗口函数的列表:</p><p id="1734" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">CUME_DIST()，密集 _ 等级()，第一个值()，滞后()，最后一个值()，领先()，第 n 个值()，不完整()，百分比 _ 等级()，等级()，行数()</p><p id="3574" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我就不详细解释了。您可以从以下链接获得详细信息:</p><div class="ll lm gp gr ln lo"><a href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab fo"><div class="lq ab lr cl cj ls"><h2 class="bd iu gy z fp lt fr fs lu fu fw is bi translated">MySQL :: MySQL 8.0 参考手册::12.21.1 窗口函数描述</h2><div class="lv l"><h3 class="bd b gy z fp lt fr fs lu fu fw dk translated">在以下函数描述中，over_clause 表示 over 子句，如第 12.21.2 节“窗口…”所述</h3></div><div class="lw l"><p class="bd b dl z fp lt fr fs lu fu fw dk translated">dev.mysql.com</p></div></div></div></a></div><p id="8c6b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将以 rank()为例演示如何使用它。</p><p id="2088" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与聚合窗口函数类似，需要一个 over 子句语句。</p><p id="e993" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从 1 到 4 有一个分类列“学习时间”。而且我们想知道学习时间是不是 g3 的一个因素。除了用 studytime 计算 g3 的平均值，我们还可以用 rank()来得到顺序。</p><p id="c754" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在获得每个学习时间的 g3 的平均值后，我们可以使用平均结果按降序排列顺序。然后我们就可以排序排名直接得到对比。这种方法非常有用，尤其是当有许多组无法通过肉眼进行排序时。</p><pre class="nz oa ob oc gt od oe of og aw oh bi"><span id="53bf" class="nb nc it oe b gy oi oj l ok ol">select studytime, avg_g3, rank() over (order by avg_g3 desc) as ranking <br/>from <br/>(<br/>select studytime, avg(g3) as avg_g3<br/>from dataset.student_mat<br/>group by studytime<br/>) a<br/>order by ranking</span></pre><figure class="nz oa ob oc gt on gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/4d597b5c0d7db23cc64a93149f2fb75a.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*bcwCDHkn2voqpbDhDET2Jw.png"/></div></figure><p id="aa8f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以，学习越多，成绩越好，这仍然是事实。</p><p id="f08e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">PS:还有另外两个内置函数也提供排名，一个是 dense_rank()，另一个是 row_number()。区别在于当存在具有相同值的行时，它们如何返回等级。您可以通过以下链接了解更多信息:</p><p id="b6b6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae mo" href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html#function_rank" rel="noopener ugc nofollow" target="_blank">https://dev . MySQL . com/doc/ref man/8.0/en/window-function-descriptions . html # function _ rank</a></p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h2 id="d522" class="nb nc it bd nd ne nf dn ng nh ni dp nj kr nk nl nm kv nn no np kz nq nr ns nt bi translated">结局</h2><p id="6614" class="pw-post-body-paragraph ki kj it kk b kl nu ju kn ko nv jx kq kr nw kt ku kv nx kx ky kz ny lb lc ld im bi translated">掌握窗口功能可以为您提供更深入的数据分析，有时甚至可以帮助您执行预测分析。正如我在上一篇文章中所说的，掌握 SQL 是获得数据分析师职位的必要条件，窗口函数在面试中经常被问到(我不记得在面试中被问了多少次)。因此你也应该在读完我的文章后开始学习窗口函数。我希望你也能掌握它，并得到你梦想的工作。今天的文章到此为止。如果你喜欢它，请留下你的评论，给我一个掌声。并分享这篇文章让更多人知道窗口功能的重要性。下次见。</p></div></div>    
</body>
</html>