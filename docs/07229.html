<html>
<head>
<title>Detection and Classification of Blood Cells with Deep Learning (Part 2 — Training and Evaluation)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用深度学习对血细胞进行检测和分类(第 2 部分—训练和评估)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/detection-and-classification-of-blood-cells-with-deep-learning-part-2-training-and-evaluation-53381dbbc565?source=collection_archive---------18-----------------------#2019-10-11">https://towardsdatascience.com/detection-and-classification-of-blood-cells-with-deep-learning-part-2-training-and-evaluation-53381dbbc565?source=collection_archive---------18-----------------------#2019-10-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="f1da" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用 Tensorflow 对象检测 API 处理 BCCD 数据集</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/ea4235ad9628d71b9a4f6db47505c8c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKAE2jJcoogVkSqklbt8jA.png"/></div></div></figure></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="be05" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">训练</strong></h1><p id="ddac" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">我们现在终于为训练做好了准备。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="1311" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research/object_detection <br/># type the following into Anaconda Prompt</span><span id="2176" class="mp li it ml b gy mu mr l ms mt">python train.py --logtostderr --train_dir=training/ --pipeline_config_path=training/faster_rcnn_inception_v2_pets.config</span></pre><p id="953c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">大约 30 秒到 1 分钟后，训练过程应该开始。如果代码运行顺利，您应该会看到全局步数以及显示的每一步的损失。为了更好地监控训练，我们推出了 Tensorboard。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="c132" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research/object_detection <br/># type the following into Anaconda Prompt</span><span id="9c58" class="mp li it ml b gy mu mr l ms mt">tensorboard --logdir=training</span></pre><p id="76fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将<a class="ae mv" href="http://localhost:6006/" rel="noopener ugc nofollow" target="_blank"> http://localhost:6006/ </a>复制到浏览器中，打开 Tensorboard。我对我的模型进行了大约 30 分钟的训练，但你的训练时间可能会根据你的系统配置而有所不同。</p><h1 id="f1c6" class="lh li it bd lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma na mc md me bi translated"><strong class="ak">导出推理图</strong></h1><p id="4083" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">一旦你对训练损失感到满意，你可以在训练窗口中按 Ctrl + C 来中断训练。我们现在将导出推理图，以便可视化结果并对模型进行评估。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="2399" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research/object_detection <br/># type the following into Anaconda Prompt</span><span id="aaec" class="mp li it ml b gy mu mr l ms mt">python export_inference_graph.py --input_type image_tensor --pipeline_config_path training/faster_rcnn_inception_v2_pets.config --trained_checkpoint_prefix training/model.ckpt-<strong class="ml iu">YOUR_CHECKPOINT_NUMBER(e.g.2859) </strong>--output_directory inference_graph</span></pre><p id="1dca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">应该在…YOUR _ DIRECTORY/models/research/object _ detection/inference _ graph 下创建推理图文件夹。</p><h1 id="7019" class="lh li it bd lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma na mc md me bi translated"><strong class="ak">可视化结果</strong></h1><p id="86da" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">用 Jupyter 笔记本打开 models/research/object _ detection/文件夹中的<strong class="js iu">object _ detection _ tutorial . ipynb</strong>笔记本。为了适应我们的情况，我对笔记本做了一些修改。请随意将编辑过的代码复制到相应的部分。我没有对下面没有讨论的部分做任何修改。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="935f" class="mp li it ml b gy mq mr l ms mt"># Imports</span><span id="75fb" class="mp li it ml b gy mu mr l ms mt">import numpy as np<br/>import os<br/>import six.moves.urllib as urllib<br/>import sys<br/>import tarfile<br/>import tensorflow as tf<br/>import zipfile</span><span id="7eea" class="mp li it ml b gy mu mr l ms mt">from distutils.version import StrictVersion<br/>from collections import defaultdict<br/>from io import StringIO<br/>from matplotlib import pyplot as plt<br/>from matplotlib import patches<br/>from PIL import Image</span><span id="1927" class="mp li it ml b gy mu mr l ms mt"># This is needed since the notebook is stored in the object_detection folder.<br/>sys.path.append("..")<br/>from object_detection.utils import ops as utils_ops</span><span id="d1e1" class="mp li it ml b gy mu mr l ms mt">if StrictVersion(tf.__version__) &lt; StrictVersion('1.12.0'):<br/>  raise ImportError('Please upgrade your TensorFlow installation to v1.12.*.')</span></pre><p id="4de9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注释掉“变量”和“下载模型”部分。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="b098" class="mp li it ml b gy mq mr l ms mt">#Load a (frozen) Tensorflow model into memory</span><span id="b89c" class="mp li it ml b gy mu mr l ms mt">PATH_TO_FROZEN_GRAPH = r"...<strong class="ml iu">YOUR_DIRECTORY</strong>\models\research\object_detection\inference_graph\frozen_inference_graph.pb"<br/>detection_graph = tf.Graph()<br/>with detection_graph.as_default():<br/>    od_graph_def = tf.GraphDef()<br/>    with tf.gfile.GFile(PATH_TO_FROZEN_GRAPH, 'rb') as fid:<br/>        serialized_graph = fid.read()<br/>        od_graph_def.ParseFromString(serialized_graph)<br/>        tf.import_graph_def(od_graph_def, name='')</span></pre><p id="ba27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了显示预测，我们需要对测试图像目录进行更改。我在 images 文件夹中创建了一个名为“test_samples”的单独文件夹，并选择了前 3 个图像(BloodImage_00333 到 00335)来运行测试。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="e9ce" class="mp li it ml b gy mq mr l ms mt"># Detection</span><span id="e85e" class="mp li it ml b gy mu mr l ms mt">PATH_TO_TEST_IMAGES_DIR = r"...<strong class="ml iu">YOUR_DIRECTORY</strong>\models\research\object_detection\images\test_samples"<br/>FILE_NAME = 'BloodImage_00{}.jpg'<br/>FILE_NUMBER = range(333,336)<br/>TEST_IMAGE_PATHS = [ os.path.join(PATH_TO_TEST_IMAGES_DIR, FILE_NAME.format(i)) for i in FILE_NUMBER]</span></pre><p id="1339" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我计划在地面实况旁边显示预测，因此我们需要参考“test_labels.csv”。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="07fe" class="mp li it ml b gy mq mr l ms mt">import pandas as pd<br/>train = pd.read_csv(r"...<strong class="ml iu">YOUR_DIRECTORY</strong>\models\research\object_detection\images\test_labels.csv")<br/>train.head()</span></pre><p id="39b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的代码将在左边显示真实的图像，在右边显示预测。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="a2d3" class="mp li it ml b gy mq mr l ms mt">for image_path in TEST_IMAGE_PATHS:<br/>    image = Image.open(image_path)<br/>  # the array based representation of the image will be used later in order to prepare the<br/>  # result image with boxes and labels on it.<br/>    image_np = load_image_into_numpy_array(image)<br/>  # Expand dimensions since the model expects images to have shape: [1, None, None, 3]<br/>    image_np_expanded = np.expand_dims(image_np, axis=0)<br/>  # Actual detection.<br/>    output_dict = run_inference_for_single_image(image_np_expanded, detection_graph)<br/>  # Visualization of the results of a detection.<br/>    vis_util.visualize_boxes_and_labels_on_image_array(<br/>        image_np,<br/>        output_dict['detection_boxes'],<br/>        output_dict['detection_classes'],<br/>        output_dict['detection_scores'],<br/>        category_index,<br/>        instance_masks=output_dict.get('detection_masks'),<br/>        use_normalized_coordinates=True,<br/>        line_thickness=5)<br/>    figure, (ax2, ax1) = plt.subplots(1, 2, figsize=(20,18))<br/># plots prediction<br/>    ax1.set_title("Predictions (" + image_path[-20:] + ")", size=25)<br/>    ax1.imshow(image_np)<br/>    <br/># plots ground truth<br/>    original = image<br/>    ax2.set_title("Ground Truth (" + image_path[-20:] + ")", size=25)<br/>    ax2.imshow(original)<br/>    for _,row in train[train.filename == image_path[-20:]].iterrows():<br/>        xmin = row.xmin<br/>        xmax = row.xmax<br/>        ymin = row.ymin<br/>        ymax = row.ymax</span><span id="4c75" class="mp li it ml b gy mu mr l ms mt">width = xmax - xmin<br/>        height = ymax - ymin</span><span id="4773" class="mp li it ml b gy mu mr l ms mt"># assign different color to different classes of objects<br/>        if row["class"] == 'RBC':<br/>            edgecolor = 'lawngreen'<br/>            ax2.annotate('RBC', xy=(xmax-40,ymin+20), size=25)<br/>        elif row["class"] == 'WBC':<br/>            edgecolor = 'cyan'<br/>            ax2.annotate('WBC', xy=(xmax-40,ymin+20), size=25)<br/>        elif row["class"] == 'Platelets':<br/>            edgecolor = 'aquamarine'<br/>            ax2.annotate('Platelets', xy=(xmax-40,ymin+20), size=25)</span><span id="7b4c" class="mp li it ml b gy mu mr l ms mt"># add bounding boxes to the image<br/>        rect = patches.Rectangle((xmin,ymin), width, height, edgecolor = edgecolor, facecolor = 'none', lw=6)<br/>        ax2.add_patch(rect)<br/>       <br/>    plt.tight_layout()<br/>    plt.show()</span></pre><p id="e408" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一切运行正常，您应该看到以下内容:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nb"><img src="../Images/1c9bb9441ccbed31b81ed451494a4a2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GXJY7JjQeiguA7alChJiUQ.png"/></div></div></figure><p id="4661" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">仅通过视觉检查，该模型仅用 30 分钟的训练时间就表现良好。边界框很紧，它检测到了大部分血细胞。值得注意的是，该模型能够检测大(白细胞)和小(血小板)细胞。在某些情况下，它甚至检测出了未被标记的红细胞。这预示着该模型的可推广性。</p><h1 id="0a2c" class="lh li it bd lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma na mc md me bi translated"><strong class="ak">评估</strong></h1><p id="2475" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">由于对预测的肉眼观察似乎令人满意，我们现在将使用 COCO 指标进行正式评估。</p><p id="8494" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们必须 git clone COCO Python API。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="1ce4" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research<br/># type the following into Anaconda Prompt</span><span id="258f" class="mp li it ml b gy mu mr l ms mt">git clone https://github.com/cocodataset/cocoapi.git</span></pre><p id="37b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将下载“coco”文件夹，你应该在你的 _DIRECTORY/models/research 中看到它。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="9c75" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research<br/># type the following into Anaconda Prompt</span><span id="c547" class="mp li it ml b gy mu mr l ms mt">cd coco/PythonAPI</span></pre><p id="2c5b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将把目录更改为 YOUR _ DIRECTORY/models/research/coco/python API。在这个阶段，官方指令要求在 Anaconda 提示符下键入“make”。然而，我无法让它工作，在 github 和 stackoverflow 中搜索给了我解决方法。</p><p id="1a3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，你需要按照这里“Jason246”的回答安装 Microsoft Visual C++构建工具:<a class="ae mv" href="https://stackoverflow.com/questions/48541801/microsoft-visual-c-14-0-is-required-get-it-with-microsoft-visual-c-build-t" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/48541801/Microsoft-Visual-C-14-0-is-required-get-it-with-Microsoft-Visual-C-Build-t</a></p><p id="09a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，使用代码编辑器在您的 _ DIRECTORY/models/research/coco/python API 下打开“setup.py”文件，并进行以下更改。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="38fb" class="mp li it ml b gy mq mr l ms mt"># change this</span><span id="2bd2" class="mp li it ml b gy mu mr l ms mt">ext_modules = [<br/>    Extension(<br/>        'pycocotools._mask',<br/>        sources=['../common/maskApi.c', 'pycocotools/_mask.pyx'],<br/>        include_dirs = [np.get_include(), '../common'],<br/>        <strong class="ml iu">extra_compile_args=['-Wno-cpp', '-Wno-unused-function', '-std=c99']</strong>,<br/>    )<br/>]</span><span id="fad0" class="mp li it ml b gy mu mr l ms mt"># to this</span><span id="42fb" class="mp li it ml b gy mu mr l ms mt">ext_modules = [<br/>    Extension(<br/>        'pycocotools._mask',<br/>        sources=['../common/maskApi.c', 'pycocotools/_mask.pyx'],<br/>        include_dirs = [np.get_include(), '../common'],<br/>        <strong class="ml iu">extra_compile_args={'gcc': ['/Qstd=c99']}</strong>,<br/>    )<br/>]</span></pre><p id="8c54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，运行“setup.py”文件。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="3ab9" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research/coco/PythonAPI<br/># type the following into Anaconda Prompt</span><span id="5498" class="mp li it ml b gy mu mr l ms mt">python3 setup.py build_ext --inplace</span></pre><p id="2b7f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">之后，将您的 _DIRECTORY/models/research/coco/PythonAPI 中的 pycocotools 文件夹复制到您的 _ DIRECTORY/models/research 中。</p><p id="aaa6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，转到您的 _ DIRECTORY/models/research/object_detection/legacy，将“eval.py”文件复制到“object _ detection”文件夹。我们终于可以运行评估脚本了。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="2590" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research/object_detection<br/># type the following into Anaconda Prompt</span><span id="fe4e" class="mp li it ml b gy mu mr l ms mt">python eval.py --logtostderr --pipeline_config_path=training/faster_rcnn_inception_v2_pets.config --checkpoint_dir=training/ --eval_dir=eval/</span></pre><p id="8c30" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将把评估结果保存到 eval/目录中。就像训练一样，我们可以用 Tensorboard 来可视化评价。</p><pre class="kp kq kr ks gt mk ml mm mn aw mo bi"><span id="2f3c" class="mp li it ml b gy mq mr l ms mt"># directory = ...YOUR_DIRECTORY/models/research/object_detection <br/># type the following into Anaconda Prompt</span><span id="cdd4" class="mp li it ml b gy mu mr l ms mt">tensorboard --logdir=eval</span></pre><p id="cea6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“eval.py”还将基于 COCO 指标生成一份报告。我的模型的结果如下:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nc"><img src="../Images/d017cad56649dd6662bfdb4ace90529d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZljPFoXwiLneSP_ORg4Sog.png"/></div></div></figure><p id="abda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">精度(阳性预测值)是真阳性与真阳性+假阳性的比例。回忆(敏感度)是真阳性与真阳性+假阴性的比例。</p><p id="94d9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在宽松交集超过并集(IOU)为 0.5 的情况下，<strong class="js iu"> 96.7% </strong>的模型的阳性预测是真阳性。当我们以 0.05 的步长对 IOU 0.5 至 0.95 的 APs 取平均值时，该百分比降低为<strong class="js iu"> 64.5% </strong>。值得注意的是，该模型在较小的物体上表现不佳，对于小型和中型物体，AP 分别为<strong class="js iu"> 23.4% </strong>和<strong class="js iu"> 52.5% </strong>。</p><p id="0207" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从召回率来看，该模型平均检测到 71.9%的真阳性，对于小物体的性能较差。</p><h1 id="b3c4" class="lh li it bd lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma na mc md me bi translated"><strong class="ak">总结</strong></h1><p id="ea80" class="pw-post-body-paragraph jq jr it js b jt mf jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn im bi translated">总之，我们使用 Tensorflow 目标检测 API 建立了一个模型，以在 BCCD 数据集中定位和分类 3 种类型的血细胞。未来的工作包括增加训练时间，提高小对象的性能，以及将模型扩展到其他数据集。</p><p id="7312" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢阅读。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nd"><img src="../Images/ef04ead3a56e76cd276f5cce0fcbc23d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SQ8eVjx3CcNpX5O7"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk">Photo by <a class="ae mv" href="https://unsplash.com/@sakulich?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sergei Akulich</a> on <a class="ae mv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div>    
</body>
</html>