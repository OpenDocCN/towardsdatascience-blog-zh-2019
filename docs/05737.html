<html>
<head>
<title>Here’s How to Use CuPy to Make Numpy Over 10X Faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以下是如何使用 CuPy 让 Numpy 快 10 倍以上</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/heres-how-to-use-cupy-to-make-numpy-700x-faster-4b920dda1f56?source=collection_archive---------1-----------------------#2019-08-22">https://towardsdatascience.com/heres-how-to-use-cupy-to-make-numpy-700x-faster-4b920dda1f56?source=collection_archive---------1-----------------------#2019-08-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="96ca" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">是时候来点 GPU 的威力了！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5f5b2ddfb649018b7526776aa90dae4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2hIk9-59M0uk1tHBz0xN0Q.jpeg"/></div></div></figure><blockquote class="ku kv kw"><p id="b273" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想获得灵感？快来加入我的<a class="ae lu" href="https://www.superquotes.co/?utm_source=mediumtech&amp;utm_medium=web&amp;utm_campaign=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">超级行情快讯</strong> </a>。😎</p></blockquote><p id="192d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">Numpy 是 Python 社区的一份礼物。它允许数据科学家、机器学习从业者和统计学家以简单高效的方式处理矩阵格式的大量数据。</p><p id="9789" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">即使就其本身而言，Numpy 在速度上已经比 Python 有了很大的进步。每当您发现您的 Python 代码运行缓慢时，尤其是如果您看到许多 for 循环，将<a class="ae lu" rel="noopener" target="_blank" href="/one-simple-trick-for-speeding-up-your-python-code-with-numpy-1afc846db418">数据处理转移到 Numpy </a>并让其矢量化以最高速度完成工作总是一个好主意！</p><p id="c374" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">尽管如此，即使有这样的加速，Numpy 也只是在 CPU 上运行。由于消费类 CPU 通常只有 8 个内核或更少，因此并行处理的数量以及所能实现的加速是有限的。</p><p id="ba8d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">这就是我们的新朋友 CuPy 的切入点！</p><h1 id="5bea" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">什么是 CuPy？</h1><p id="8be4" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">CuPy 是一个通过利用 CUDA GPU 库在 Nvidia GPUs 上实现 Numpy 阵列的库。通过这种实现，由于 GPU 拥有许多 CUDA 核心，可以实现卓越的并行加速。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/8697aaa0de2493a626816ca090134199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Qg5AIeVmg2nnP2XV.png"/></div></div></figure><p id="0516" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">CuPy 的界面是 Numpy 的一面镜子，在大多数情况下，它可以作为一个直接的替代品。只需将 Numpy 代码替换为兼容的 CuPy 代码，就可以实现 GPU 加速。CuPy 将支持 Numpy 拥有的大多数数组操作，包括索引、广播、数组数学和各种矩阵转换。</p><p id="6973" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">如果你有一些特定的还不被支持的东西，你也可以写定制的 Python 代码来利用 CUDA 和 GPU 加速。所需要的只是一小段 C++格式的代码，CuPy 会自动进行 GPU 转换，非常类似于<a class="ae lu" rel="noopener" target="_blank" href="/use-cython-to-get-more-than-30x-speedup-on-your-python-code-f6cb337919b6">使用 Cython </a>。</p><p id="a393" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">要开始使用 CuPy，我们可以通过 pip 安装库:</p><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="5ab4" class="nb lz it mx b gy nc nd l ne nf">pip install cupy</span></pre><h1 id="2d5b" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">使用 CuPy 在 GPU 上运行</h1><p id="a2c6" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">对于这些基准测试，我将使用具有以下设置的 PC:</p><ul class=""><li id="f53d" class="ng nh it la b lb lc le lf lv ni lw nj lx nk lt nl nm nn no bi translated">i7–8700k CPU</li><li id="658c" class="ng nh it la b lb np le nq lv nr lw ns lx nt lt nl nm nn no bi translated">1080 Ti GPU</li><li id="0cd0" class="ng nh it la b lb np le nq lv nr lw ns lx nt lt nl nm nn no bi translated">32 GB DDR 4 3000 MHz 内存</li><li id="dc03" class="ng nh it la b lb np le nq lv nr lw ns lx nt lt nl nm nn no bi translated">CUDA 9.0</li></ul><p id="37e0" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">一旦安装了 CuPy，我们可以像导入 Numpy 一样导入它:</p><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="1f9b" class="nb lz it mx b gy nc nd l ne nf"><em class="kz">import </em>numpy <em class="kz">as </em>np<br/><em class="kz">import </em>cupy <em class="kz">as </em>cp<br/><em class="kz">import </em>time</span></pre><p id="0acb" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">对于其余的代码，在 Numpy 和 CuPy 之间切换就像用 CuPy 的<code class="fe nu nv nw mx b">cp</code>替换 Numpy 的<code class="fe nu nv nw mx b">np</code>一样简单。下面的代码为 Numpy 和 CuPy 创建了一个包含 10 亿个 1 的 3D 数组。为了测量创建数组的速度，我使用了 Python 的本地<code class="fe nu nv nw mx b">time</code>库:</p><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="8251" class="nb lz it mx b gy nc nd l ne nf">### Numpy and CPU<br/>s = time.time()<br/><strong class="mx iu">x_cpu = np.ones((1000,1000,1000))</strong><br/>e = time.time()<br/>print(e - s)</span><span id="254d" class="nb lz it mx b gy nx nd l ne nf">### CuPy and GPU<br/>s = time.time()<br/><strong class="mx iu">x_gpu = cp.ones((1000,1000,1000))<br/>cp.cuda.Stream.null.synchronize()</strong><br/>e = time.time()<br/>print(e - s)</span></pre><p id="4989" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">那很容易！</p><p id="481c" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">注意我们是如何在 cupy 数组初始化之后添加额外的一行的。这样做是为了确保我们的代码在进入下一行之前在 GPU 上完成执行。</p><p id="bd18" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">令人难以置信的是，尽管这只是创建数组，但 CuPy 的速度还是快得多。Numpy 在 1.68 秒内创建了 10 亿个 1 的数组，而 CuPy 只用了 0.16 秒；这是 10.5 倍的加速！</p><p id="3532" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">但是我们仍然可以做得更多。</p><p id="9e93" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">让我们试着在数组上做一些数学运算。这次我们将整个数组乘以 5，并再次检查 Numpy 与 CuPy 的速度。</p><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="a2b7" class="nb lz it mx b gy nc nd l ne nf">### Numpy and CPU<br/>s = time.time()<br/><strong class="mx iu">x_cpu *= 5</strong><br/>e = time.time()<br/>print(e - s)</span><span id="d2e7" class="nb lz it mx b gy nx nd l ne nf">### CuPy and GPU<br/>s = time.time()<br/><strong class="mx iu">x_gpu *= 5<br/>cp.cuda.Stream.null.synchronize()<br/></strong>e = time.time()<br/>print(e - s)</span></pre><p id="de55" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">在这种情况下，CuPy <strong class="la iu">撕碎</strong> Numpy。Numpy 拿了 0.5845 而 CuPy 只拿了<br/>0.0575；这是 10.17 倍的加速！</p><p id="ad8b" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">现在，让我们尝试使用多个数组并进行一些操作。下面的代码将完成以下工作:</p><ol class=""><li id="6c62" class="ng nh it la b lb lc le lf lv ni lw nj lx nk lt ny nm nn no bi translated">将数组乘以 5</li><li id="74d4" class="ng nh it la b lb np le nq lv nr lw ns lx nt lt ny nm nn no bi translated">将数组本身相乘</li><li id="66df" class="ng nh it la b lb np le nq lv nr lw ns lx nt lt ny nm nn no bi translated">将数组添加到自身</li></ol><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="85bb" class="nb lz it mx b gy nc nd l ne nf">### Numpy and CPU<br/>s = time.time()<br/><strong class="mx iu">x_cpu *= 5<br/>x_cpu *= x_cpu<br/>x_cpu += x_cpu</strong><br/>e = time.time()<br/>print(e - s)</span><span id="672c" class="nb lz it mx b gy nx nd l ne nf">### CuPy and GPU<br/>s = time.time()<br/><strong class="mx iu">x_gpu *= 5<br/>x_gpu *= x_gpu<br/>x_gpu += x_gpu<br/>cp.cuda.Stream.null.synchronize()<br/></strong>e = time.time()<br/>print(e - s)</span></pre><p id="9e29" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">在这种情况下，Numpy 在 CPU 上执行过程用了 1.49 秒，而 CuPy 在 GPU 上执行过程用了 0.0922 秒；一个更适度但仍然很棒的 16.16 倍加速！</p><h1 id="8117" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">总是超级快吗？</h1><p id="8d2e" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">使用 CuPy 是将 GPU 上的 Numpy 和 matrix 运算加速许多倍的好方法。值得注意的是，您将获得的加速在很大程度上取决于您正在使用的阵列的大小。下表显示了我们改变正在处理的数组大小时的速度差异:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="7832" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">当我们达到大约 1000 万个数据点时，速度会急剧加快，当我们超过 1 亿个数据点时，速度会快得多。低于这个，Numpy 其实更快。此外，请记住，更多的 GPU 内存将帮助您处理更多的数据，所以重要的是要看看您的 GPU 是否有足够的内存来容纳足够的数据。</p></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><h1 id="e63b" class="ly lz it bd ma mb oi md me mf oj mh mi jz ok ka mk kc ol kd mm kf om kg mo mp bi translated">喜欢学习？</h1><p id="3aeb" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">在<a class="ae lu" href="https://twitter.com/GeorgeSeif94" rel="noopener ugc nofollow" target="_blank"> twitter </a>上关注我，我会在那里发布所有最新最棒的人工智能、技术和科学！也在 LinkedIn 上与我联系！</p></div></div>    
</body>
</html>