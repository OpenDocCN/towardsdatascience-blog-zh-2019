<html>
<head>
<title>In-depth review of Soft Actor-Critic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">软演员评论家深度评论</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/in-depth-review-of-soft-actor-critic-91448aba63d4?source=collection_archive---------5-----------------------#2019-11-24">https://towardsdatascience.com/in-depth-review-of-soft-actor-critic-91448aba63d4?source=collection_archive---------5-----------------------#2019-11-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="804b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解最先进的强化学习算法</h2></div><h1 id="f4d9" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">介绍</h1><p id="c1fc" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本帖中，我们回顾了 Soft Actor-Critic (Haarnoja 等人，2018 &amp; 2019)，这是一种非常成功的强化学习算法，在连续控制任务(如机器人移动和操纵)中实现了最先进的性能。软演员评论家使用最大熵学习的概念，这带来了一些简洁的概念和实际的优势，我们将在本文中讨论。</p><p id="05e5" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">以下是这篇文章的结构:</p><p id="a1c8" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">首先，我们将简要回顾一般策略迭代(我将假设读者熟悉马尔可夫决策过程)，这是理解任何强化学习算法的基本概念。然后，我们将讨论软演员-评论家背后的直觉，以及它带来的概念上的好处。接下来，我们将讨论软政策迭代，软行动者-批评家(SAC)近似的理论框架，然后继续讨论 SAC。我还将在整篇文章中提供解释算法的代码片段。</p><h1 id="c6b0" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">SAC 是如何实现顶级性能的？</h1><p id="11f4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">本质上，SAC 寻求的是在政策中最大化“熵”,以及从环境中获得的预期回报。政策中的熵可以解释为政策中的<em class="mb">随机性</em>。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mc"><img src="../Images/b167efe0fb340f9cc51066cc83480afd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jFVsimYrTTwUiK-5trKGOA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Left: high(orange) and high (blue) entropy in categorical probability distributions | Right: high (orange) and low (blue) entropy in Gaussian distributions. Inspired by(<a class="ae ms" href="https://medium.com/@awjuliani/maximum-entropy-policies-in-reinforcement-learning-everyday-life-f5a1cc18d32d" rel="noopener">https://medium.com/@awjuliani/maximum-entropy-policies-in-reinforcement-learning-everyday-life-f5a1cc18d32d</a>)</figcaption></figure><p id="7a8b" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">从上图中，我们看到低熵的概率分布倾向于“贪婪地”采样某些值，因为概率质量分布相对不均匀。也就是说，奖励高熵的政策带来了几个概念上的优势:首先，它明确地鼓励探索状态空间，改善了收集的转换数据；第二，它允许策略捕获多种模式的好策略，防止过早收敛到坏的局部最优。</p><p id="531e" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">这种动机和提法在软演员-评论家论文中得到了实证验证；在许多 MuJoCo 控制任务中，软演员-评论家优于其他最先进的算法:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mt"><img src="../Images/a25fe2223dd80bc1ea91fa8523a84f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qMJiSZA6RIA9q2MWHgAOew.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Performance of SAC (2018) and SAC (2019) against other algorithms on MuJoCo tasks. Taken from Haarnoja et al. (2019) paper</figcaption></figure><h1 id="f475" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">背景:一般策略迭代</h1><p id="1349" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在经典的 MDP 理论中，寻找最大化每个州的预期累积折扣奖励的最优政策的标准方法是<em class="mb">政策迭代</em>。策略迭代是在策略评估和策略改进之间交替的两步迭代方案。</p><p id="1d49" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在策略评估步骤中，我们希望找到当前策略的准确值函数。为此，我们反复应用如下定义的贝尔曼算子:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mu"><img src="../Images/90e2a79490500cefed221e4ba0a98d0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ck_rhUhbpUp4ayJUlbX-_A.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Bellman operator</figcaption></figure><p id="86d8" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">策略改进步骤通过重复应用贝尔曼最优算子来执行:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/29a0102233222faf47ee50bddd3d5d77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*eQLuZBzio8i3096lE5Zxzw.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Bellman optimality operator</figcaption></figure><p id="6916" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">其在给定初始值函数<code class="fe mw mx my mz b">V</code>的情况下，保证收敛到真实(最佳)值函数<code class="fe mw mx my mz b">V*</code>。特别地，Bellman 算子和最优性算子的收敛性质是由于它们都是压缩映射。再者，理论上，最优策略<code class="fe mw mx my mz b">pi*</code>可以从最优值函数中构造出来；给定一个初始策略<code class="fe mw mx my mz b">pi</code>，我们最小化当前策略和派生的更新策略之间的一些度量。</p><p id="6594" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">因此，通过交替策略评估和策略改进，我们可以在表格情况下(即，有限状态-动作空间和无函数近似)找到马尔可夫决策过程的精确解。</p><h1 id="57aa" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">软策略迭代</h1><p id="48de" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在论文中，Haarnoja 引入了软策略迭代，它是一般策略迭代的一种扩展，将策略的熵作为一个附加的奖励项。特别是，代理人寻求最大化环境的预期回报和政策的熵。</p><p id="1765" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">为此，原始的贝尔曼算子增加了一个熵正则项:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi na"><img src="../Images/43fbb4e1a10d07e2ebae5b9e3796da55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cOynrBbUz77ugdvDE1CK2Q.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Soft Bellman operator</figcaption></figure><p id="3640" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">如同在非正则化的情况下，熵正则化的 Bellman 算子对任何初始 Q 函数的重复应用保证收敛到最优的“软”Q 函数。</p><p id="3494" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">对于策略改进步骤，我们将策略分布更新为当前 Q 函数的 softmax 分布(要了解为什么会这样，请查看<a class="ae ms" href="https://arxiv.org/pdf/1702.08165.pdf" rel="noopener ugc nofollow" target="_blank">哈尔诺贾等人的论文，(2017) </a>)。特别是，我们希望最小化两个分布之间的距离(“散度”)。这是通过最小化两种分布之间的 Kullback-Leibler (KL)散度来实现的:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nb"><img src="../Images/03c02699b5e280aff53a24b678f2da05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s1AJnZSuReO3cmt7XQ2AiA.png"/></div></div></figure><p id="efe2" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">如 Haarnoja 等人(2018)所证明的，这种更新方案保证了在表格情况下(即当状态和动作空间是有限的并且没有使用函数近似时)策略的单调改进。<em class="mb">后来，艾斯特等人(2019)将这些性质推广到正则化子的任何公式。</em></p><h1 id="683d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">软演员-评论家(警告:密集！)</h1><p id="abbd" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">对于具有高维和/或连续状态-动作空间的复杂学习域，找到 MDP 的精确解几乎是不可能的。因此，我们必须利用函数逼近(即神经网络)来找到软策略迭代的实际逼近。</p><p id="ecb5" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">为此，Haarnoja 等人将软 Q 函数建模为表达性神经网络，将策略建模为动作空间上的高斯分布，将当前状态作为输入，将平均值和协方差作为神经网络输出。下面是这些代码在实现过程中的样子:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nc nd l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Models</figcaption></figure><p id="ba26" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">此外，软行动者-批评家是一种非策略学习算法，这意味着我们可以用从不同于当前策略的策略中收集的经验数据来更新 Q 网络和策略参数；对于每个演员的推出，我们将所有的过渡数据保存在重放缓冲区中(在下面的等式中表示为<em class="mb"> D </em>)。</p><p id="3973" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">通过使用预测动作值和目标动作值<code class="fe mw mx my mz b">q_t</code>之间的均方损失的梯度，可以在每个更新步骤优化 Q 函数参数:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi ne"><img src="../Images/1d1d745c232d28a660f03df6152b3ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4NxMag9DdMY6lCiSDaDftg.png"/></div></div></figure><p id="5d68" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">这里，<code class="fe mw mx my mz b">alpha</code>项代表“熵温度”，即我们对政策的“随机性”与环境回报的权重。</p><p id="9672" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在代码中，我们可以这样实现:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nc nd l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Soft Q-network update in code</figcaption></figure></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><p id="3fce" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">现在进入策略改进步骤:在实践中，软行动者-批评家使用软策略迭代的一些修改。利用 Q 参数可微的事实，Haarnoja 等人对策略输出使用“重新参数化技巧”来获得低方差估计量；特别地，我们将动作表示为应用于 z 值的双曲正切(tanh ),该 z 值是从策略神经网络输出的平均值和协方差中采样的。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nm"><img src="../Images/371da0e19126253522b8255d80a56518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFUuYN4xd11k6k5mHaBZmw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">neural network transformation on Gaussian policy to obtain action</figcaption></figure><p id="b8b6" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">此外，为了解决我们的无界高斯分布的动作界限，我们必须将<code class="fe mw mx my mz b">log(pi)</code>计算修改为:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nn"><img src="../Images/ce1012e7559639f205f1fe8a5fbc226f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l1Mn0B1lUh1e8FFDVIYbfA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">log(pi) computation</figcaption></figure><p id="a307" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">这里，<code class="fe mw mx my mz b">log(mu)</code>表示根据来自策略神经网络的均值和协方差计算的累积分布函数(CDF)。也许这在代码中更清楚:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nc nd l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">log(pi) computation</figcaption></figure><p id="ec7b" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">然后，可以通过最小化来自软策略迭代的简化形式的 KL 发散来直接优化策略参数；我们取目标函数的随机梯度:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi no"><img src="../Images/4a03f1988f937d702cf23fadb88f8cb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H-khQyV2niVi2uEhAXm-kA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Policy objective for which we will compute the gradients</figcaption></figure><p id="2133" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">这种简化形式来自于忽略 Q 的 softmax 分布的分母，因为它对目标函数的梯度没有贡献。</p><p id="3f8f" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在代码中，我们可以这样实现:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nc nd l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Policy update in code</figcaption></figure></div><div class="ab cl nf ng hx nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="im in io ip iq"><h2 id="4d23" class="np kj it bd kk nq nr dn ko ns nt dp ks lj nu nv ku ln nw nx kw lr ny nz ky oa bi translated">可选:自动调节我们的熵温度<code class="fe mw mx my mz b">alpha</code></h2><p id="22fe" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在 SAC (2018)的第一个版本中使用了固定的熵温度<code class="fe mw mx my mz b">alpha</code>。尽管原始 SAC 的性能令人印象深刻，但<code class="fe mw mx my mz b">alpha</code>却是一个非常敏感的超参数。为了补救这一点，SAC (2019)的第二个版本将<code class="fe mw mx my mz b">alpha</code>转换为可更新的参数。特别地，我们通过取下面的目标函数的梯度来更新:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi ob"><img src="../Images/c61621fac1999a86447712e6fb143468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hv2C2DB2LLj9rU_0l4OeGQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Objective function for dynamically adjustable entropy temperature</figcaption></figure><p id="1362" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">其中 H_bar 表示所需的最小熵，通常设置为零向量。建议将 SAC (2019)与此可调<code class="fe mw mx my mz b">alpha</code>一起使用，因为它提高了算法的性能和稳定性。</p><p id="7a33" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在代码中:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="nc nd l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">alpha initialization and update</figcaption></figure><p id="c81a" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">这就结束了软演员-评论家算法的审查！</p><h1 id="a4ae" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">全面实施</h1><p id="eec7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">为了使我的帖子尽可能简洁，我只包含了相关的、特定的实现片段；要查看完整的实现，请查看我的 GitHub 库:</p><div class="oc od gp gr oe of"><a href="https://github.com/cyoon1729/Policy-Gradient-Methods" rel="noopener  ugc nofollow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd iu gy z fp ok fr fs ol fu fw is bi translated">cy oon 1729/策略-梯度-方法</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">策略梯度系列中算法的实现。目前包括:A2C，A3C，DDPG，TD3，SAC …</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">github.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot mm of"/></div></div></a></div><h1 id="77ba" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">参考资料:</h1><ol class=""><li id="cd8a" class="ou ov it lc b ld le lg lh lj ow ln ox lr oy lv oz pa pb pc bi translated">软行动者-批评家:带有随机行动者的非策略最大熵深度强化学习。哈尔诺贾等人(2018) </li><li id="c36f" class="ou ov it lc b ld pd lg pe lj pf ln pg lr ph lv oz pa pb pc bi translated"><a class="ae ms" href="https://arxiv.org/abs/1812.05905" rel="noopener ugc nofollow" target="_blank">软演员-评论家算法和应用。哈尔诺贾等人(2019 年)</a></li><li id="4449" class="ou ov it lc b ld pd lg pe lj pf ln pg lr ph lv oz pa pb pc bi translated"><a class="ae ms" href="https://arxiv.org/abs/1901.11275" rel="noopener ugc nofollow" target="_blank">正则化马尔可夫决策过程理论。艾斯特等人(2019) </a></li></ol></div></div>    
</body>
</html>