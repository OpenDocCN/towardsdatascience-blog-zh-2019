# 用 FB Prophet 快速启动时间序列预测的实例

> 原文：<https://towardsdatascience.com/a-quick-start-of-time-series-forecasting-with-a-practical-example-using-fb-prophet-31c4447a2274?source=collection_archive---------1----------------------->

![](img/d636fd0a7250aceed212634642bb60b8.png)

# 目录

1.  介绍

*   时间序列分析
*   为什么是脸书先知？

2.先知预测模型

*   饱和增长
*   趋势变化点
*   季节性、假日效应和回归因素

3.案例研究:用 Prophet 预测广告支出

4.结案摘要

## 1.1 时间序列分析

时间序列分析是一种分析时间序列数据的方法，以提取数据的有意义的特征，并产生应用于商业情况的其他有用的见解。通常，时间序列数据是按时间顺序存储的一系列观察值。在跟踪业务指标、监控工业过程等时，时间序列数据往往非常突出。

时间序列分析有助于理解一组度量数据点的基于时间的模式，这对任何业务都是至关重要的。时间序列预测技术可以回答一些商业问题，比如要维持多少库存，你的电子商店预计会有多少网站流量，下个月会卖出多少产品，所有这些都是需要解决的重要时间序列问题。时间序列分析的基本目标通常是确定一个描述时间序列模式并可用于预测的模型。

传统的时间序列预测技术建立在统计模型上，这需要大量的工作来调整模型，并在数据和行业中进行预期。当一个预测模型不能如预期的那样运行时，人们必须根据具体的问题来调整方法的参数。调整这些方法需要彻底了解基本的时间序列模型是如何工作的。如果没有数据科学团队，一些组织很难处理这些预测。如果没有必要建立一个复杂的预测平台或其他服务，对一个组织来说，有一大堆期望似乎没有什么好处。

1.2 为什么是脸书先知？

脸书开发了一个开源 Prophet，这是一个预测工具，有 Python 和 r 两种版本。它提供了易于调整的直观参数。即使是对时间序列预测模型缺乏深入专业知识的人，也可以利用这一点对业务场景中的各种问题做出有意义的预测。

来自[脸书先知网站](https://facebook.github.io/prophet/):

“无论对机器还是对大多数分析师来说，做出高质量的预测都不是一个容易的问题。在创建各种业务预测的实践中，我们观察到两个主要主题:

*   完全自动的预测技术可能是脆弱的，并且它们通常太不灵活而不能结合有用的假设或启发。
*   能够做出高质量预测的分析师非常少，因为预测是一项专业的数据科学技能，需要丰富的经验。"

1.3 脸书先知的亮点

*   非常快，因为它是内置的 [Stan](https://mc-stan.org/users/documentation/) ，一种用 C++编写的用于统计推断的编程语言。
*   一种加性回归模型，其中非线性趋势与每年、每周和每天的季节性以及假日效应相适应:1。分段线性或逻辑增长曲线趋势。Prophet 通过从数据中选择变化点来自动检测趋势的变化 2。使用傅立叶级数 3 模拟的年度季节分量。使用虚拟变量的每周季节性成分 4。用户提供的重要节假日列表。
*   对缺失数据和趋势变化稳健，通常处理异常值。
*   添加领域知识或业务见解时，调整预测的简单程序。

## 2.1 先知预测模型

Prophet 使用一个可分解的时间序列模型，它有三个主要的模型组件:趋势、季节性和假日。它们在以下等式中合并:

y(t)= g(t) + s(t) + h(t) + εt

*   g(t):分段线性或逻辑增长曲线，用于模拟时间序列中的非周期性变化
*   s(t):周期性变化(例如每周/每年的季节性)
*   h(t):不定期休假的影响(用户提供)
*   εt:误差项说明模型不能适应的任何异常变化
*   使用时间作为回归变量，Prophet 试图将时间的几个线性和非线性函数作为组件进行拟合。将季节性建模为附加成分与霍尔特-温特斯技术[中的指数平滑法](https://otexts.org/fpp2/holt-winters.html)采用的方法相同。Prophet 将预测问题框定为曲线拟合练习，而不是明确地查看时间序列内每个观察值的时间相关性。

2.2 饱和增长

![](img/cc663346cf7b3847e1ff5fb59f34409c.png)

*   设定一个承载能力`cap`,根据业务场景或约束条件指定最大可实现点:市场规模、总人口规模、最大预算等。
*   饱和最小值，用列`floor`指定，与列`cap`指定最大值的方式相同。

2.3 趋势变化点

使用趋势组件时，模型可能会过拟合或欠拟合。Prophet 允许的内置变点输入增加，拟合变得更加灵活。

在这里，你可以很好地运用你的商业洞察力:节假日期间销售额的大幅增长，有目的地降低未来的成本等等。如果需要的话，用户还可以手动地将这些业务洞察力提供给变更点。在下图中，虚线代表给定时间序列的变点。

![](img/a341d72573ebb4f5155043979062b4f0.png)

2.4 季节性、假日效应和回归因素

季节效应 s(t)由以下函数近似表示:

![](img/f4fe55b3b0f79d9b0ae0660e77cab44a.png)

Prophet 有一个内置的假日功能，允许输入定制的重复事件。

最后，行动时间！

## 3.案例研究:用 Python 中的 Prophet 预测广告支出

我从一个数字营销平台获取了广告支出的样本数据。为了在这个案例研究中使用，我还故意做了一些修改，使它成为一个“假”数据源。

在这里，我们尝试使用过去 17 个月的数据来预测未来 30 天的广告支出。

步骤 1:导入库和数据集:

[代码]:

*导入熊猫作为 PD
PD . set _ option(' display . max _ columns '，None)*

*从 fbprophet 导入 numpy 作为 np
导入 Prophet*

*%matplotlib inline
导入 matplotlib.pyplot 作为 plt*

*sample = PD . read _ CSV('/…/ad _ spend . CSV ')*

步骤 2:检查数据信息

[代码]:

![](img/a8165e36017500b11ee2cc957fbab018.png)

从上面可以看出，该数据集包含了从 2017 年 6 月 1 日到 2018 年 12 月 30 日的一年半的每日广告支出。数据框中有 577 行和两列(日期和花费)。

让我们检查缺少的值:

没有遗漏的价值(从下面的表格中),这很好！👏

[代码]:

![](img/73c349b2bb8e3c3fe0b42812565ca041.png)

步骤 3:绘制时间序列数据

![](img/00d79e672eaeec5f56c5777af0518594.png)

Y-Axis: Ad Spend; X-Axis: Date

从图中可以看出，水平大致不变(日均花费:20 万美元)。季节性波动和随机波动随着时间的推移在大小上大致是恒定的。这表明，使用 Prophet 建立的附加模型来描述数据可能是合适的。

第四步:建模

将数据集分为训练集和测试集。训练集包含 2017 年 6 月 1 日至 2018 年 11 月 30 日的每日广告支出，而测试集包含 2018 年 12 月 1 日至 2018 年 12 月 30 日的每日广告支出。在这里，我们希望使用训练数据集来预测未来 30 天的广告支出。

让我们在不给出任何参数的情况下单独尝试第一个模型。

[代码]:

*model 1 = Prophet(interval _ width = 0.95)*#默认为 80%

*'interval_width=0.95'* ，设置不确定性区间，产生预测的置信区间。

生成下面的预测图:

![](img/046b613d9c70e95b8437ce070d44bb88.png)

Y-Axis: Ad Spend; X-Axis: Date.

检查模型在历史数据上的表现总是好的。(深蓝线是预测花费数字，黑点实际上是花费数字。浅蓝色阴影是预测的 95%置信区间。)从图中可以看出，尽管该模型试图平滑地拟合所有数据点，但它未能捕捉到季节性。第一个模型仅仅通过应用 Prophet 本身并不能很好地拟合数据。

对于第二个模型，让我们应用一些业务见解来调整第一个模型。只需询问一些业务问题，如季节性趋势和假日事件影响，就可以轻松地将这些信息输入到 Prophet 中。

我们应用了:*yearly _ seasonity，weekly _ seasonality，holidays* (这里手动创建了假日事件，但是您也可以应用先知内置的[*Country Holidays*](https://facebook.github.io/prophet/docs/seasonality,_holiday_effects,_and_regressors.html#built-in-country-holidays)和 *changepoint_prior_scale* ，以使模型更加灵活地适应数据点。然后，我们增加了月度季节性。

[Code]:
*model 2 = Prophet(interval _ width = 0.95，yearly _ 季节性=True，weekly _ 季节性=True，holidays=us_public_holidays，change point _ prior _ scale = 2)
model 2 . add _ 季节性(name='monthly '，period=30.5，fourier_order=5，prior_scale=0.02)。*

生成下面的预测图:

![](img/d53f6e93990d3c7355621aa28c8bb8ab.png)

Y-Axis: Ad Spend; X-Axis: Date.

从图中可以看出，第二个模型能够很好地捕捉季节性和拟合历史数据。(深蓝线是预测花费数字，黑点实际上是花费数字。浅蓝色阴影是预测的 95%置信区间。)

检查趋势和季节性因素:

![](img/2e2cbf65e91f2ab86b0e17bbf0c2639b.png)![](img/80d00a636b8abd44e3a9dd4154da32a2.png)

从年度趋势来看，支出在年初上升，在 6 月、8 月和 12 月大幅下降。每周趋势显示，工作日在这里发挥了重要作用。节日事件对广告支出有负面影响，这意味着它会导致广告支出下降，等等。你可以用业务领域的知识来检查这些信息。

第五步:验证

首先，让我们通过可视化预测线和观察线来检查拟合度:

![](img/6a34b77f78e3515ef36cfe8c2cf46871.png)

Y-Axis: Ad Spend; X-Axis: Date.

从图中可以看出，该模型似乎能够很好地拟合数据点，尽管它没有捕捉到 12 月底的模式。但是，请记住，输入所有业务信息大约只需要 15 分钟就可以得到这样一个合理的结果。它不需要时间序列建模或机器学习知识方面的专业经验。几乎每个分析师都能做到这一点(然而，Python 或 R 的技能集是必备的。🙃)

通常，在建模评估过程中会用到一些流行的误差术语，如[均方根误差(RMSE)](https://en.wikipedia.org/wiki/Root-mean-square_deviation) 和[平均绝对误差(MAE)](https://en.wikipedia.org/wiki/Mean_absolute_error) 。但是我不想在这里讨论这些误差项，因为只有一个模型。(我将在下一篇文章中比较 Prophet 和经典时间序列模型时讨论这些错误术语)

让我们通过比较预测值和观察值来看看模型的性能:

[代码]:

![](img/5dbc32952229710605dc37cd78c052f1.png)

虽然预测值比实际值高出约 13%,但预测值与下限之间的间隔能够捕捉到实际值。到目前为止，该模型做得相当好，它需要大约 15 分钟。

5.结案摘要

从现在开始，我们可以探索许多时间序列分析方法，如异常检测、用外部数据源预测时间序列等。我们才刚刚开始。

从实际例子来看，Prophet 似乎提供了完全自动化的预测，正如其官方文件所述。如果您的组织没有一个非常可靠的数据科学团队来处理预测分析，它将非常有用。它节省了您回答内部利益相关者或客户的预测问题的时间，而无需花费太多精力来基于经典的时间序列建模技术构建一个令人惊叹的模型。

下一篇文章，我将比较 Prophet 和经典的时间序列预测技术，如 ARMIA 模型，重点是效率和性能。

## 参考和有用的来源:

[脸书先知官方文件](https://facebook.github.io/prophet/)，如果你想玩先知必须阅读。

[对脸书先知](https://www.youtube.com/watch?v=95-HMzxsghY)的介绍，它大致解释了什么是时间序列分析，并给出了脸书先知的概述。

[使用脸书的 Prophet(带 Python & R 代码)](https://www.analyticsvidhya.com/blog/2018/05/generate-accurate-forecasts-facebook-prophet-python-r/)生成快速准确的时间序列预测，它包括 R 和 Python 两种语言的脸书 Prophet 简介。如果你是一个 R 用户，它可能对你有用。