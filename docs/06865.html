<html>
<head>
<title>5 Step Guide to Scalable Deep Learning Pipelines with d6tflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">d6tflow 可扩展深度学习管道 5 步指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/5-step-guide-to-scalable-deep-learning-pipelines-with-d6tflow-94d21cb40d22?source=collection_archive---------30-----------------------#2019-09-29">https://towardsdatascience.com/5-step-guide-to-scalable-deep-learning-pipelines-with-d6tflow-94d21cb40d22?source=collection_archive---------30-----------------------#2019-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3e34" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">如何将典型的 Pytorch 脚本转换为可扩展的 d6tflow DAG 以加快研究&amp;开发</em></h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/515b28a00ff048bb374dce04776f7b8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Oncu34b99RRAgskE"/></div></div><figcaption class="ks kt gj gh gi ku kv bd b be z dk">Photo by <a class="ae kw" href="https://unsplash.com/@seanlimm?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sean Lim</a> on <a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="c489" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">引言:何苦呢？</h1><p id="f19a" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">构建深度学习模型通常涉及复杂的数据管道以及大量的反复试验，调整模型架构和需要比较其性能的参数。经常很难跟踪所有的实验，往好里说会导致混乱，往坏里说会导致错误的结论。</p><p id="18ca" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">在<a class="ae kw" rel="noopener" target="_blank" href="/4-reasons-why-your-machine-learning-code-is-probably-bad-c291752e4953">你的 ML 代码不好的 4 个原因</a>中，我们探讨了如何将 ML 代码组织成 DAG 工作流来解决这个问题。在本指南中，我们将通过一个实际的案例研究，利用<a class="ae kw" href="https://github.com/d6t/d6tflow" rel="noopener ugc nofollow" target="_blank"> d6tflow </a>将现有的 pytorch 脚本转变为可扩展的深度学习管道。起点是<a class="ae kw" href="https://github.com/facebookresearch/dlrm" rel="noopener ugc nofollow" target="_blank">脸书的 pytorch 深度推荐器模型</a>，我们将通过 5 个步骤将代码迁移到可扩展的深度学习管道中。下面的步骤是用部分伪代码编写的，以说明概念，完整的代码也是可用的，请参见文章末尾的说明。</p><p id="3903" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">我们开始吧！</p><h1 id="4bd6" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">第一步:计划你的 DAG</h1><p id="31b5" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">要计划您的工作并帮助他人了解您的管道是如何组合在一起的，您需要从考虑数据流、任务之间的依赖关系和任务参数开始。这有助于您将工作流程组织成逻辑组件。你可能想画一个这样的图</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/ce2e233968c317b8ecbaafba07fddd12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/0*jsN2cB2hQaz31Ug_"/></div></figure><p id="1c4a" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">下面是脸书深度学习推荐器模型(DLRM)的 Pytorch 模型训练 DAG。它显示了训练任务<code class="fe mr ms mt mu b">TaskModelTrain</code>及其所有的依赖项，以及这些依赖项是如何相互关联的。如果你写功能代码，很难看出你的工作流程是如何像这样组合在一起的。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="8a9b" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">第二步:写任务而不是函数</h1><p id="72cc" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">数据科学代码通常组织在函数中，这会导致很多问题，如<a class="ae kw" rel="noopener" target="_blank" href="/4-reasons-why-your-machine-learning-code-is-probably-bad-c291752e4953">4ML 代码不好的原因</a>中所述。相反，您希望编写 d6tflow 任务。好处是您可以:</p><ul class=""><li id="0460" class="mx my iq lr b ls ml lv mm ly mz mc na mg nb mk nc nd ne nf bi translated">将任务链接到 DAG 中，以便自动运行所需的依赖关系</li><li id="f71c" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">从依赖关系轻松加载任务输入数据</li><li id="ebf6" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">轻松保存任务输出，如预处理数据和训练模型。这样你就不会意外地重新运行长时间运行的训练任务</li><li id="1f67" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">将任务参数化，以便智能管理它们(参见下一步)</li><li id="3ffb" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">将输出保存到<a class="ae kw" href="https://github.com/d6t/d6tpipe" rel="noopener ugc nofollow" target="_blank"> d6tpipe </a>为了将数据从代码中分离出来并轻松共享数据，请参见<a class="ae kw" rel="noopener" target="_blank" href="/top-10-coding-mistakes-made-by-data-scientists-bb5bc82faaee">数据科学家犯下的 10 大编码错误</a></li></ul><p id="2f0d" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">下面是将功能代码转换成 d6t 流程任务后，脸书·DLRM 代码的“之前/之后”的样子。</p><p id="1b62" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">伸缩性不好的典型 Pytorch 功能代码:</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="b2ec" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">使用可伸缩 d6tflow 任务编写的相同逻辑:</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="1352" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">步骤 3:参数化任务</h1><p id="72fa" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">为了提高模型性能，您将尝试不同的模型、参数和预处理设置。为了跟踪所有这些，您可以向任务添加参数。这样，您可以:</p><ul class=""><li id="ee51" class="mx my iq lr b ls ml lv mm ly mz mc na mg nb mk nc nd ne nf bi translated">跟踪哪些模型已经用哪些参数进行了训练</li><li id="cfb2" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">随着参数的变化，智能地重新运行任务</li><li id="fa7a" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">帮助其他人了解工作流中引入参数的位置</li></ul><p id="817f" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">下面用参数设置脸书 DLRM 模型训练任务。请注意，您不再需要手动指定保存训练模型和数据的位置。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="3f58" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">比较训练模型</h1><p id="c597" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">现在，您可以使用该参数轻松地比较不同模型的输出。确保在加载任务输出之前使用该参数运行工作流(参见步骤 4)。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="ffb3" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">继承参数</h1><p id="a9d3" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">通常，您需要在工作流程的下游设置一个参数级联。如果你写函数代码，你必须在每个函数中重复这个参数。使用 d6tflow，您可以继承参数，以便终端任务可以根据需要将参数传递给上游任务。</p><p id="ce80" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">在脸书 DLRM 工作流中，<code class="fe mr ms mt mu b">TaskModelTrain</code>从<code class="fe mr ms mt mu b">TaskGetTrainDataset</code>继承参数。这样你可以运行<code class="fe mr ms mt mu b">TaskModelTrain(mini_batch_size=2)</code>，它会将参数传递给上游任务，即<code class="fe mr ms mt mu b">TaskGetTrainDataset</code>和所有依赖于它的其他任务。在实际代码中，注意<code class="fe mr ms mt mu b">self.clone(TaskName)</code>和<code class="fe mr ms mt mu b">@d6tflow.clone_parent</code>的使用。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="0312" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">步骤 4:运行 DAG 来处理数据和训练模型</h1><p id="17e0" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">要开始数据处理和模型训练，您需要运行 DAG。您只需要运行自动运行所有依赖项的终端任务。在实际运行 DAG 之前，您可以预览将要运行的内容。如果您对代码或数据进行了任何更改，这尤其有用，因为它将只运行已更改的任务，而不是整个工作流。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="ef4e" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">步骤 5:评估模型性能</h1><p id="4065" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">现在工作流已经运行并且所有任务都已完成，您可以加载预测和其他模型输出来比较和可视化输出。因为任务知道每个输出保存在哪里，所以您可以直接从任务加载输出，而不必记住文件路径或变量名。这也使得你的代码可读性更好。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="d685" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">比较模型</h1><p id="6db5" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">您可以很容易地比较具有不同参数的不同模型的输出。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="f7e9" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">继续迭代</h1><p id="bc4f" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">当您迭代、更改参数、代码和数据时，您会想要重新运行任务。d6tflow 智能地指出哪些任务需要重新运行，这使得迭代非常高效。如果你改变了参数，你不需要做任何事情，它会知道自动运行什么。如果您更改了代码或数据，您必须使用<code class="fe mr ms mt mu b">.invalidate()</code>将任务标记为未完成，d6tflow 将会解决剩下的问题。</p><p id="5101" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">在脸书 DLRM 工作流中，比如说您更改了培训数据或对培训预处理进行了更改。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="50ff" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">完整源代码</h1><p id="0261" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">所有代码都在 https://github.com/d6tdev/dlrm 提供。与<a class="ae kw" href="https://github.com/facebook/dlrm" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/dlrm</a>相同，增加了 d6tflow 文件；</p><ul class=""><li id="5699" class="mx my iq lr b ls ml lv mm ly mz mc na mg nb mk nc nd ne nf bi translated">flow_run.py:运行流= &gt;运行该文件</li><li id="5afb" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">flow_task.py:任务代码</li><li id="0d0a" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">flow_viz.py:显示模型输出</li><li id="1919" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">flow_cfg.py:默认参数</li><li id="eeb8" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">dlrm _ d6t _ py torch . py:dlrm _ data _ py torch . py 用于 d6tflow</li></ul><p id="3742" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">自己试试！</p><h1 id="b90f" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">你的下一个项目</h1><p id="6dba" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">在本指南中，我们展示了如何构建可扩展的深度学习工作流。我们使用了现有的代码库，并展示了如何将线性深度学习代码转换为 d6tflow DAGs 以及这样做的好处。</p><p id="f970" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">对于新项目，你可以从 https://github.com/d6t/d6tflow-template<a class="ae kw" href="https://github.com/d6t/d6tflow-template" rel="noopener ugc nofollow" target="_blank">的可扩展项目模板开始。结构非常相似:</a></p><ul class=""><li id="c4bc" class="mx my iq lr b ls ml lv mm ly mz mc na mg nb mk nc nd ne nf bi translated">运行. py:运行工作流</li><li id="2554" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">task.py:任务代码</li><li id="0f41" class="mx my iq lr b ls ng lv nh ly ni mc nj mg nk mk nc nd ne nf bi translated">cfg.py:管理参数</li></ul></div></div>    
</body>
</html>