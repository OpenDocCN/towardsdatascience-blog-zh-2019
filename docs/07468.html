<html>
<head>
<title>Detecting Cute Animals on iOS: A Continuation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 iOS 上检测可爱的动物:续</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/detecting-cute-animals-on-ios-a-continuation-a5fd6beec1d9?source=collection_archive---------36-----------------------#2019-10-18">https://towardsdatascience.com/detecting-cute-animals-on-ios-a-continuation-a5fd6beec1d9?source=collection_archive---------36-----------------------#2019-10-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7bed" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在 iOS 上构建自定义图像分类器应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6b50d53f944513a91607d752a2ad5ef2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Orwrqbdiz8uYnVmEPOXmCQ.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@austinkirk?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Austin Kirk</a> on <a class="ae kv" href="https://unsplash.com/s/photos/cute-animal?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f39b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之前写过<a class="ae kv" rel="noopener" target="_blank" href="/detecting-cute-animals-with-machine-learning-d39a511bd144">为一部手机</a>做一个带机器学习的可爱动物探测器。当时，我必须只为 Android 开发，因为 iOS 工具与我用来训练模型的工具不兼容。但是现在 iOS 工具更新了，我有了一些时间，所以下面是我在 iOS 上实现我的可爱动物检测器所做的事情。</p><h1 id="1cd0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">转换模型</h1><p id="84a4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在 iOS 上，CoreML 是用于机器学习模型的格式。苹果提供了<a class="ae kv" href="https://apple.github.io/coremltools/generated/coremltools.converters.keras.convert.html" rel="noopener ugc nofollow" target="_blank">工具，能够以一种简单明了的方式将我拥有的 Keras 模型转换成 CoreML </a>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Converting the trained model to be used on iOS</figcaption></figure><p id="e5a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与 Android 的情况一样，转换器需要提供输入形状。然而，在这种情况下，输入张量中的第一个维度必须为零，而不是设置为 1。需要 image_input_names 和 class_labels，以便 iOS 应用程序知道模型 1)处理图像，2)是分类器。这使得编写应用程序代码更加容易，因为有专门用途的 API 可用。</p><h1 id="56fa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">在 iOS 上读取相机</h1><p id="9264" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">该应用需要在 iOS 和 Android 上做同样的事情:</p><ol class=""><li id="ea94" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated">在屏幕上显示相机预览</li><li id="63a2" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">让用户按下按钮来捕捉当前图像</li><li id="e668" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">将捕获的图像输入分类器</li><li id="682b" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">分类完成后显示结果</li></ol><p id="19b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">图像捕捉的 Android 实现实际上没有使用相机。相反，当用户按下按钮时，它会以位图的形式获取预览内容，并生成图像进行分类。在 iOS 上，我没有找到将预览内容提取为位图的方法，所以我选择了指示相机拍摄正确图片的路线。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/05bb04722498273d763aa19351d17a25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wYlpnSxsmgPcNCbY36e0DA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@spdumb2025?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Amy Chen</a> on <a class="ae kv" href="https://unsplash.com/s/photos/cute-animal?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="c307" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在应用程序可以访问摄像机之前，用户必须授予它权限。还有其他可能的授权状态，当被询问时，用户可能会拒绝许可，但是对于一个仅关于使用相机的示例应用程序，我认为假设许可已经或将要被授予是没问题的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Checking for permission to use the camera, and requesting it if needed</figcaption></figure><p id="c27e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于相机的自定义使用，如在这个应用程序中，AVKit 是要使用的平台库。需要创建并启动摄像机会话。在会话中，有输入和输出，输入连接到输出。在这种情况下，输入设置为来自后置摄像头的视频输入，以便屏幕可以显示实时预览，输出是一张照片，因为该应用程序处理单张照片。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Creating and starting the camera session</figcaption></figure><p id="eb06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">照片输出是用来拍照的。evaluate 按钮的 target 方法创建一个 settings 对象，其中默认设置适合此用途，并指示要捕获的照片。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Callback method to take a photo</figcaption></figure><h1 id="cf3b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">裁剪照片</h1><p id="3221" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在 Android 应用程序中，应用程序正在处理位图，这使得裁剪和缩放变得容易。在 iOS 上，AVKit 将产生一个 AVCapturePhoto 对象，它需要更多的工作来匹配屏幕，因为屏幕分辨率与照片分辨率不同。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Cropping a captured photo to include only the part shown on screen</figcaption></figure><p id="7571" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，支持裁剪的最佳图像类型是 CGImage。与用于屏幕显示的 UIImage 不同，CGImage 不知道它的方向，因此需要从 AVCapturePhoto 对象中提取。方向用于确保屏幕边界的方向与照片的方向相同，以便可以正确计算缩放因子。(宽度和高度尺度不同；使用身高是正确的，但我不知道为什么。)</p><p id="b459" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要提取用于分类的图片是照片中心的 299x299 区域。因此，代码将一个 299x299 的矩形缩放到照片分辨率，将其居中，并进行裁剪。最后，返回一个具有适当的屏幕缩放因子和方向的 UIImage，因为使用 UIImage 比使用 CGImage 更方便。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/9ef317bfdee9e2757cd2fd6dca2dba03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMEn5JZu9PaWh9Qe4xhpjg.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@lilissa?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Liliya Lisa</a> on <a class="ae kv" href="https://unsplash.com/s/photos/cute-fox?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="f6b1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">运行分类器</h1><p id="5337" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">创建模型最好在启动时完成，因为它不会在应用程序运行时改变，并且需要一段时间来创建。创建的模型类型来自 Vision framework，这是一个很好的用于图像分类的库。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Creating a model object to run classification</figcaption></figure><p id="c689" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当试图用默认配置运行模型时，我遇到了一个溢出错误，<a class="ae kv" href="https://stackoverflow.com/questions/54773171/espresso-aneruntimeengine-program-inference-overflow" rel="noopener ugc nofollow" target="_blank">显然意味着模型对于神经引擎</a>来说太大了。这就是为什么它仅限于 CPU 和 GPU 的原因。</p><p id="a3bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从 Vision 框架开始分类非常简单。使用模型和回调方法创建分类请求，从(裁剪的)图像创建处理程序，并使用请求调用处理程序。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Starting classification of the image</figcaption></figure><p id="21ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">分类器完成后，将使用结果调用完成方法。该方法验证结果是分类结果。由于模型被转换为一个带有适当输出标签的图像分类器，代码可以查找标识符“cute ”,而不需要知道哪个索引对应于哪个类。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="c87c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">摘要</h1><p id="a54d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">构建 iOS 应用比构建 Android 应用要简单一些，部分原因是我已经有了一些 Android 应用的经验。最大的障碍是需要对捕获的照片进行图像处理，因为我对 UIImage、CGImage 和 AVCapturePhoto 的复杂性不是很熟悉。正如在制作了 Android 应用程序之后，我现在对自己在真正的 iOS 应用程序中应用机器学习的能力更有信心了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/20155cba13812fd45023e806d027cbd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n9_LDguoj0oGIzOrNEFGBw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Screenshot of the app evaluating a dog</figcaption></figure><p id="6081" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">是的，还能用。</p></div></div>    
</body>
</html>