<html>
<head>
<title>Introducing Copula in Monte Carlo Simulation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">蒙特卡罗模拟中 Copula 的引入</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introducing-copula-in-monte-carlo-simulation-9ed1fe9f905?source=collection_archive---------9-----------------------#2019-12-22">https://towardsdatascience.com/introducing-copula-in-monte-carlo-simulation-9ed1fe9f905?source=collection_archive---------9-----------------------#2019-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="af9f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">概率油气体积估算的一个演示案例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8c57e6c7cfe19067ebff47947567cf12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VpFWZ9cyrS1NkTnkxNEWWQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk"><a class="ae ky" href="https://thenextweb.com/insights/2019/07/30/quantum-darwinism-may-solve-the-question-of-whether-god-plays-dice-or-not/" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="5a2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在石油和天然气行业，从地表到地下，不确定性无处不在。为了在任何估计中嵌入不确定性，需要概率方法。</p><p id="8893" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个简单的例子是体积估计。估算碳氢化合物(石油/天然气)初始地质储量(HCIIP)的公式如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/8a79f00a94e395b2417da0ed1e45e99e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XtajnajmWEhl1C9L.jpg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk"><a class="ae ky" href="http://chapter24.one/hciip%20calculator.html" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="71aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了对 HCIIP 进行概率估计，使用了蒙特卡罗方法，并遵循以下步骤(<a class="ae ky" href="https://en.wikipedia.org/wiki/Monte_Carlo_method" rel="noopener ugc nofollow" target="_blank">来源</a>):</p><ol class=""><li id="274e" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">定义可能输入的域</li><li id="b6f7" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">根据域上的概率分布随机生成输入</li><li id="b13f" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">对输入执行确定性计算</li><li id="0f89" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">汇总结果</li></ol><p id="a80a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">概率油气远景评价的一个 Ms Excel 实现可以在这里<a class="ae ky" href="https://www.lsu.edu/ces/products/stats/index.php" rel="noopener ugc nofollow" target="_blank">得到</a>。</p><p id="3ca2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果所有输入都是<strong class="lb iu"> <em class="mk">独立</em> </strong>随机变量或者<strong class="lb iu"> <em class="mk">正态分布</em> </strong>，那么随机抽样就相当简单了。然而，输入，例如孔隙度和碳氢化合物饱和度在某种程度上与 相关，并具有不同的分布。在这种情况下，随机抽样是困难的。这时<strong class="lb iu"> <em class="mk">系词</em> </strong>来拯救我们了。</p><h1 id="af1b" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">介体</h1><p id="475f" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">根据<a class="ae ky" href="https://en.wikipedia.org/wiki/Copula_(probability_theory)" rel="noopener ugc nofollow" target="_blank">维基百科</a>，一个<strong class="lb iu"> copula </strong>是一个多元的累积分布函数，对于这个函数，每个变量的边际概率分布是均匀的。</p><p id="41ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的定义很抽象，很难理解。然而，实现相当容易。托马斯·威奇写了一篇鼓舞人心的文章，直观地展示了系词。</p><p id="faff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了完全掌握 copula 的概念，需要理解随机变量变换。</p><h2 id="4597" class="ni mm it bd mn nj nk dn mr nl nm dp mv li nn no mx lm np nq mz lq nr ns nb nt bi translated">随机变量变换</h2><p id="e8a4" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">让我们从 0 和 1 之间的均匀分布开始采样。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="a943" class="ni mm it nv b gy nz oa l ob oc">x = stats.uniform(0, 1).rvs(10000)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/bd6fde7f197b4d450e532ed57113cbef.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*hhJJr53EtbZSVV4GbwVw-A.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Uniformly distributed samples</figcaption></figure><p id="c05e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些样本不是均匀的，而是可以通过累积密度函数(CDF)的倒数转换成任何感兴趣的概率分布。假设我们希望这些样本呈正态分布。我们可以将这些样本传递给正态分布的逆 CDF 函数(例如<strong class="lb iu"> <em class="mk"> ppf </em> </strong>函数在<strong class="lb iu"> <em class="mk"> scipy.stats </em> </strong>中)。我们将得到以下正态分布的样本。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="042a" class="ni mm it nv b gy nz oa l ob oc">norm <strong class="nv iu">=</strong> stats<strong class="nv iu">.</strong>distributions<strong class="nv iu">.</strong>norm()<br/>x_trans <strong class="nv iu">=</strong> norm<strong class="nv iu">.</strong>ppf(x)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/0030b50ab48999c12446f0fb8461087a.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*GHVQwS4_N4_wWDBLD3P-Eg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Transformed samples that are normally distributed</figcaption></figure><p id="a7f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们在同一图上绘制均匀样本、变换样本和反向 CDF 曲线，我们得到:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/b867d272a166a70a5ade59b225cee687.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*B90mluWrM4bdYPW5vN8rPg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Overlaying uniform and transform (normally distributed) sample along with the CDF curve</figcaption></figure><p id="9a1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们想从给定的分布中抽取样本时，计算机会在幕后进行这种转换。</p><p id="ad35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">重要的是，这个过程是可逆的；这意味着我们可以通过相同的 CDF 将任何分布的样本转换回统一的分布。</p><h2 id="bd17" class="ni mm it bd mn nj nk dn mr nl nm dp mv li nn no mx lm np nq mz lq nr ns nb nt bi translated">高斯连接函数-添加变量相关性</h2><p id="62b9" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">高斯连接函数的步骤如下:</p><ol class=""><li id="644a" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">从相关的多元正态分布中抽取样本。变量相关性通过协方差矩阵指定。</li><li id="745e" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">转换相关样本，使边缘(每个输入)一致。</li><li id="626d" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">将统一边际转换为任何利益分布。例如，孔隙度服从截尾正态分布，碳氢化合物饱和度服从三角形分布等。</li></ol><p id="8a3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从相关多元正态分布中抽取样本开始。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="bf26" class="ni mm it nv b gy nz oa l ob oc">mvnorm = stats.multivariate_normal([0, 0], [[1., 0.5], [0.5, 1.]])<br/>x = mvnorm.rvs((10000,))</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/32b73db84e5164a655c7674b92111030.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*UPT1nfmVZVjG9wuXK18euw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Correlated samples from a multivariate normal distribution with a covariance of 0.5</figcaption></figure><p id="bcce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将边缘转换为均匀分布。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="7d72" class="ni mm it nv b gy nz oa l ob oc">norm = stats.norm([0],[1])<br/>x_unif = norm.cdf(x)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/5f570c61dec8fdec8c745b8e26f54967.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/1*5stmVtrx26TvBLR1YpPQ5w.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The joint &amp; marginal distributions of X1 and X2</figcaption></figure><p id="bced" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如我们所见，X1 和 X2 的联合分布是相关的，而它们的边际是一致的。</p><p id="ae9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以在保持相关性的同时，将边际转化为任何感兴趣的分布。例如，我们想从三角形分布中得出 X1，从正态分布中得出 X2。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="1ea8" class="ni mm it nv b gy nz oa l ob oc">x1_tri  = stats.triang.ppf(x_unif[:, 0],  c=0.158 , loc=36, scale=21)<br/>x2_norm =stats.norm(525, 112).ppf(x_unif[:, 1])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/27ccb46b467a7b6161cca56cf1995242.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*g2LyhvWVvMqXif6yLpoS9A.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The transformed marginal of X1</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/b4aa95dbfa121e1b7aad76c5bd68c4e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*wrprpeCspTLilHrIAu-y9Q.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The transformed marginal of X2</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/8400a9d00416bb592a88cb3a051390a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*DiwqA4bbtFUegZ8t6UI7OQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The joint distribution of X1 and X2</figcaption></figure><p id="a7bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们从不同的分布中得到 X1 和 X2 的期望的联合分布。</p><h1 id="cd2e" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">HCIIP 的概率估计</h1><p id="314a" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">有了<strong class="lb iu"> copula </strong>，我们已经准备好将变量相关性引入蒙特卡罗的采样阶段。以下是计算 OIIP 的完整 python 代码:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="10b3" class="ni mm it nv b gy nz oa l ob oc">import seaborn as sns<br/>from scipy import stats<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/># HCIIP = GRV*NTG*POR*SHC/FVF<br/>means = [0.]*5<br/>cov = [[1., 0., 0., 0., 0.],<br/>[0., 1., 0., 0., 0.],<br/>[0., 0., 1., 0., 0.],<br/>[0., 0., 0., 1., 0.],<br/>[0., 0., 0., 0., 1.]]</span><span id="5eab" class="ni mm it nv b gy ol oa l ob oc">mvnorm_std = stats.multivariate_normal(means,cov)<br/>x = mvnorm_std.rvs(10000,random_state=42)<br/>norm_std = stats.norm()<br/>x_unif = norm_std.cdf(x)</span><span id="b73c" class="ni mm it nv b gy ol oa l ob oc">#create individual distr.<br/>grv = stats.triang(c=0.1 , loc=10000, scale=300).ppf(x_unif[:, 0])<br/>ntg = stats.triang(c=0.2 , loc=0.5, scale=0.5).ppf(x_unif[:, 1])<br/>phi = stats.truncnorm(-2*1.96,1.96,0.2,0.05).ppf(x_unif[:, 2])<br/>shc = stats.norm(0.6,0.05).ppf(x_unif[:, 3])<br/>fvf= stats.truncnorm(-1.96,2*1.96,1.3,0.1).ppf(x_unif[:, 4])</span><span id="168d" class="ni mm it nv b gy ol oa l ob oc">stoiip = 7758*grv*ntg*phi*shc/fvf/1e6<br/>sns.distplot(stoiip  , kde=False, norm_hist=True)<br/>plt.figure()<br/>sns.distplot(stoiip ,hist_kws=dict(cumulative=True),<br/>kde_kws=dict(cumulative=True))<br/>plt.show()</span></pre><h2 id="153e" class="ni mm it bd mn nj nk dn mr nl nm dp mv li nn no mx lm np nq mz lq nr ns nb nt bi translated">无变量相关情况</h2><p id="0240" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">对于没有相关性的情况，协方差矩阵是一个对角矩阵(除了对角单元之外，处处为零)。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="8795" class="ni mm it nv b gy nz oa l ob oc">cov = [[1., 0., 0., 0., 0.],<br/>[0., 1., 0., 0., 0.],<br/>[0., 0., 1., 0., 0.],<br/>[0., 0., 0., 1., 0.],<br/>[0., 0., 0., 0., 1.]]</span></pre><p id="a689" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行上面的代码，我们得到下面的 OIIP 直方图和累积概率分布。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/cf5f6fdb6497e7f33cc49753ce41bef2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*8gdFn_B6PFRf-B0AAObtBA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Histogram of OIIP for no correlation case</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/91b2e5852baa67e9b4473139eb221548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*pGCz0XEMLzDf6L7ivdFtcw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Cumulative distribution of OIIP for no correlation case</figcaption></figure><h2 id="d49d" class="ni mm it bd mn nj nk dn mr nl nm dp mv li nn no mx lm np nq mz lq nr ns nb nt bi translated">可变相关情况</h2><p id="2b38" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">为了说明可变相关性的情况，我们任意指定 NTG、POR 和 SHC 之间的正相关性。</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="57bc" class="ni mm it nv b gy nz oa l ob oc">cov = [[1., 0., 0., 0., 0.],<br/>[0., 1., 0.7, 0.6, 0.],<br/>[0., 0.7, 1., 0.8, 0.],<br/>[0., 0.6, 0.8, 1., 0.],<br/>[0., 0., 0., 0., 1.]]</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/6cb200ba50146f6fd48c000ea3d1ecce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*qndJmsHUpZ8-aChd6rCbIQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Histogram of OIIP for correlation case</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/79edadc0191a9c0716f045f2ba8669ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*i0TxJgKmf3mN0AzCetsmaA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Cumulative distribution of OIIP for correlation case</figcaption></figure><h1 id="9656" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">总结</h1><p id="8cdf" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">通过观察 OIIP 直方图和累积分布，我们可以看到，包括变量相关性或依赖性扩展了计算 OIIP 的 P10-P90 范围。这是合理的，因为通过包括相关性，采样可以探索极端空间，否则，在没有相关性的情况下可能会被错过。在下一篇文章中，我们将看看贝叶斯下降曲线分析(DCA)。</p></div></div>    
</body>
</html>