<html>
<head>
<title>Airflow design pattern to manage multiple Airflow projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理多个气流项目的气流设计模式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/airflow-design-pattern-to-manage-multiple-airflow-projects-e695e184201b?source=collection_archive---------13-----------------------#2019-11-05">https://towardsdatascience.com/airflow-design-pattern-to-manage-multiple-airflow-projects-e695e184201b?source=collection_archive---------13-----------------------#2019-11-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fe62" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">探索数据工程技术和代码，以在 Airflow 实例上或作为 ECS 服务连续部署多个项目</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/71e97aef19fcf437ec2dbf49e1bfd6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QgEJVkWtsZELcrHk"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by I<a class="ae kv" href="https://unsplash.com/@sadswim?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">an Dooley</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="239a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Airflow 是调度、可视化和执行数据管道的一个很好的工具。但是如果你像我一样，必须管理大约 100 多个不同的管道，你会很快意识到开发和管理这些管道需要一点工程技术。</p><p id="31a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将探索设计模式的 3 个方面，这将帮助我们使开发过程简单和易于管理。</p><ol class=""><li id="72bb" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">每个项目 DAG 的单独存储库。</li><li id="c688" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用 CI/CD 部署代码。</li><li id="6a7c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用容器执行代码。</li></ol></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="6510" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">1.项目分离:如何维护每条管道的单独存储库？</h1><p id="7284" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Airflow 将自动初始化配置中指定的 DAG 主目录下的所有 DAG。但是要从单独的项目初始化 DAG.py，我们必须安装<em class="nk"> DAGFactory </em>。</p><p id="2e51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">Dag factory</strong>:<em class="nk"/>Dag factory 将从特定文件夹下的单个项目中收集并初始化 Dag，在我的例子中是@ airflow/projects。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="f41f" class="nq mo iq nm b gy nr ns l nt nu">airflow<br/>├── READEME.md<br/>├── airflow-scheduler.pid<br/>├── airflow.cfg<br/>├── dags<br/>│   └─ DAGFactory.py<br/>├── global_operators<br/>├── logs<br/>├── projects<br/>│     └── test_project<br/>│            └── DAG.py<br/>├── requirements.txt<br/>├── scripts<br/>├── tests<br/>└── unittests.cfg</span></pre><ul class=""><li id="a472" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nv ly lz ma bi translated">将其安装在<code class="fe nw nx ny nm b">airflow/dags/DAGFactory.py</code>下</li></ul><p id="f20a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">气流将初始化气流/dags 目录下的所有 Dag。所以我们将在这里安装 DAGFactory。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="1289" class="nq mo iq nm b gy nr ns l nt nu">airflow<br/>├── READEME.md<br/>├── airflow-scheduler.pid<br/>├── airflow.cfg<br/>└── dags<br/>    └─ DAGFactory.py</span></pre><p id="fca1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nw nx ny nm b">DAGFactory.py</code>的代码:遍历 airflow/projects 下的所有项目，并将<code class="fe nw nx ny nm b">DAG.py</code>中的<code class="fe nw nx ny nm b">DAGS</code>变量加载到 airflow 的全局名称空间中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="4b50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将允许我们将您的代码放在一个单独的存储库中。我们要做的就是</p><ol class=""><li id="7393" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">在你的回购协议的根层有一个<code class="fe nw nx ny nm b">DAG.py</code>文件</li><li id="728f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">有一个名为<code class="fe nw nx ny nm b">DAGS</code>的列表，里面有所有的<em class="nk">主</em>Dag。(可以，可以传多个 Dag。每个 dag 将在用户界面上显示为单独的 DAG。并且所有 Dag 都可以从相同的代码库中维护。)</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="5ee6" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">2.如何将项目的代码应用到生产气流服务中</h1><ol class=""><li id="a176" class="ls lt iq ky b kz nf lc ng lf ob lj oc ln od lr lx ly lz ma bi translated">如果你在虚拟机上运行气流。你可以在<code class="fe nw nx ny nm b">airflow/projects</code>下<code class="fe nw nx ny nm b">git checkout </code>这个项目</li><li id="d25b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">您可以使用类似<code class="fe nw nx ny nm b">chef</code>的配置管理工具在 airflow VM 上部署新项目。</li><li id="8c3f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">您可以在 AWS 上使用代码构建或代码管道来构建和部署您的 Kubernetes 服务。如果你在 EKS 运营 airflow 服务。(或 GCP 的 Kubernetes 发动机)</li></ol><p id="0379" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将很快就这些写一篇文章。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="51e7" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">3.创建复杂的 Dag v/s 编写复杂的代码并在容器中执行。</h1><p id="cf41" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">随着 Dag 数量的增加及其复杂性的增加。执行它们需要更多的资源，这意味着如果您的生产气流环境在虚拟机上，您将不得不进行扩展以满足不断增长的需求。(如果您使用 Kubernetes 来执行或任何其他执行人，这将不适用于您)。</p><p id="7083" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，为了克服这个问题，我建议为每个项目创建单独的容器，并通过气流在 ECS 中执行它们，而不是在单个 m/c 上执行所有的 Dag。</p><p id="cdaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种方法让我将我的 airflow 实例大小保持在最小，容器在 ECS 中的 FARGATE 上执行，我只为它们运行所需的时间付费。</p><p id="526f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于我可以通过使用 DAGFactory 将我的代码库分开，所以我可以将<code class="fe nw nx ny nm b">DAG.py</code>和<code class="fe nw nx ny nm b">dockerfile </code>放在同一个存储库中。我可以将 DAG.py 放在 ECR 中的 airflow 实例和 Docker 容器上。</p><p id="3a08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种方法的一个缺点是，您不能在内部使用气流操作符进行 ETL 或其他处理。但是您仍然可以构建您的模块库，并在不同的管道中使用它们。</p><p id="e79b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么为什么要保持气流呢？</p><p id="bc2f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好吧，Airflow 附带了一个更好的 UI 和一个调度程序。这使得跟踪作业失败、启动作业(本例中是一个容器)以及在一个地方查看日志变得很容易。</p><p id="2059" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简而言之，不需要登录到实例来调试问题。</p></div></div>    
</body>
</html>