<html>
<head>
<title>Use Cython to get more than 30X speedup on your Python code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Cython 可以将 Python 代码的速度提高 30 倍以上</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-cython-to-get-more-than-30x-speedup-on-your-python-code-f6cb337919b6?source=collection_archive---------0-----------------------#2019-07-25">https://towardsdatascience.com/use-cython-to-get-more-than-30x-speedup-on-your-python-code-f6cb337919b6?source=collection_archive---------0-----------------------#2019-07-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/46d4548c74f21127059f5539bed60bc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MXpk9zP1m7JWsUA73JEi9Q.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Cython will give your Python code super-car speed</figcaption></figure><blockquote class="kf kg kh"><p id="08f2" class="ki kj kk kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg im bi translated">想获得灵感？快来加入我的<a class="ae lh" href="https://www.superquotes.co/?utm_source=mediumtech&amp;utm_medium=web&amp;utm_campaign=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="kl iu">超级行情快讯</strong> </a>。😎</p></blockquote><p id="eba1" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">Python 是社区最喜欢的编程语言！这是迄今为止最容易使用的方法之一，因为代码是以直观、人类可读的方式编写的。</p><p id="1064" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">然而，你经常会一遍又一遍地听到对 Python 的相同抱怨，尤其是来自 C 代码大师的抱怨:<em class="kk"> Python 很慢。</em></p><p id="c082" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">他们没有错。</p><p id="9d08" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">相对于很多其他编程语言，Python <em class="kk">比较慢</em>。<a class="ae lh" href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/gpp-python3.html?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank">基准测试游戏</a>有一些比较各种编程语言在不同任务上速度的坚实基准。</p><p id="c5ce" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">我以前写过几个不同的方法可以加快速度:</p><p id="608f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">(1)使用<a class="ae lh" rel="noopener" target="_blank" href="/heres-how-you-can-get-a-2-6x-speed-up-on-your-data-pre-processing-with-python-847887e63be5">多处理库</a>来使用所有的 CPU 内核</p><p id="9011" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">(2)如果您使用 Numpy、Pandas 或 Scikit-Learn，请使用<a class="ae lh" rel="noopener" target="_blank" href="/heres-how-you-can-accelerate-your-data-science-on-gpu-4ecf99db3430"> Rapids 来加速 GPU </a>上的处理。</p><p id="0acf" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">如果您正在做的事情实际上可以并行化，例如数据预处理或矩阵运算，那就太棒了。</p><p id="ab89" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">但是如果你的代码是纯 Python 呢？如果你有一个大的 for 循环，而你只有<em class="kk">有</em>可以使用，并且不能放入一个矩阵中，因为数据必须在<em class="kk">序列</em>中处理，那该怎么办？有没有办法加速 Python <em class="kk">本身</em>？</p><p id="49d9" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">这就是 Cython 加速我们的原始 Python 代码的原因。</p><h1 id="70db" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Cython 是什么？</h1><p id="e821" class="pw-post-body-paragraph ki kj it kl b km mj ko kp kq mk ks kt li ml kw kx lj mm la lb lk mn le lf lg im bi translated">就其核心而言，Cython 是 Python 和 C/C++之间的中间步骤。它允许您编写纯 Python 代码，只需稍加修改，然后直接翻译成 C 代码。</p><p id="455e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">您对 Python 代码所做的唯一调整是向每个变量添加类型信息。通常，我们可以像这样在 Python 中声明一个变量:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="4855" class="mx lm it mt b gy my mz l na nb">x = 0.5</span></pre><p id="4a16" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">使用 Cython，我们将为该变量添加一个类型:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6085" class="mx lm it mt b gy my mz l na nb">cdef float x = 0.5</span></pre><p id="532b" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">这告诉 Cython，我们的变量是浮点型的，就像我们在 c 中做的一样。使用纯 Python，变量的类型是动态确定的。Cython 中类型的显式声明使得到 C 的转换成为可能，因为显式类型声明是必需的+。</p><p id="1bde" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">安装 Cython 只需要一行 pip:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2103" class="mx lm it mt b gy my mz l na nb">pip install cython</span></pre><h1 id="dfe0" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Cython 中的类型</h1><p id="2ed7" class="pw-post-body-paragraph ki kj it kl b km mj ko kp kq mk ks kt li ml kw kx lj mm la lb lk mn le lf lg im bi translated">使用 Cython 时，变量和函数有两组不同的类型。</p><p id="30a5" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">对于变量，我们有:</p><ul class=""><li id="dbdb" class="nc nd it kl b km kn kq kr li ne lj nf lk ng lg nh ni nj nk bi translated">cdef int  a、b、c</li><li id="f3df" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated">cdef char  *s</li><li id="7113" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cdef 浮点型</strong> x = 0.5(单精度)</li><li id="0281" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cdef double </strong> x = 63.4(双精度)</li><li id="833d" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cdef 列表</strong>名称</li><li id="ae0d" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cdef 词典</strong>进球 _for_each_play</li><li id="3bb4" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cdef 对象</strong>卡片 _ 卡片组</li></ul><p id="9a3f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">请注意，所有这些类型都来自 C/C++！对于我们拥有的功能:</p><ul class=""><li id="e2ba" class="nc nd it kl b km kn kq kr li ne lj nf lk ng lg nh ni nj nk bi translated"><strong class="kl iu"> def </strong> —常规 python 函数，仅从 Python 调用。</li><li id="c016" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cdef </strong> — Cython only 不能从纯 python 代码访问的函数，即必须在 Cython 内调用</li><li id="74dc" class="nc nd it kl b km nl kq nm li nn lj no lk np lg nh ni nj nk bi translated"><strong class="kl iu"> cpdef </strong> — C 和 Python。可以从 C 和 Python 中访问</li></ul><p id="34cd" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">有了对 Cython 类型的了解，我们就可以开始实施我们的加速了！</p><h1 id="5ac1" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">如何用 Cython 加速你的代码</h1><p id="9ad2" class="pw-post-body-paragraph ki kj it kl b km mj ko kp kq mk ks kt li ml kw kx lj mm la lb lk mn le lf lg im bi translated">我们要做的第一件事是建立一个 Python 代码基准:一个用于计算数字阶乘的 for 循环。原始 Python 代码如下所示:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="d5e7" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">我们的 Cython 相同的功能看起来非常相似。首先，我们将确保我们的 Cython 代码文件有一个<code class="fe ns nt nu mt b">.pyx</code>扩展名。代码本身唯一的变化是我们声明了每个变量和函数的类型。</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="9e34" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">注意这个函数有一个<code class="fe ns nt nu mt b">cpdef</code>来确保我们可以从 Python 中调用它。也看看我们的循环变量<code class="fe ns nt nu mt b">i</code>是如何拥有类型的。你需要为函数中的所有变量<strong class="kl iu">设置类型，以便 C 编译器知道使用什么类型！</strong></p><p id="007f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">接下来，创建一个<code class="fe ns nt nu mt b">setup.py</code>文件，该文件将 Cython 代码编译成 C 代码:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="e199" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">并执行编译:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="1e88" class="mx lm it mt b gy my mz l na nb">python setup.py build_ext --inplace</span></pre><p id="89da" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">嘣！我们的 C 代码已经编译好了，可以使用了！</p><p id="d96a" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">你会看到在你的 Cython 代码所在的文件夹中，有运行 C 代码所需的所有文件，包括<code class="fe ns nt nu mt b">run_cython.c</code>文件。如果你很好奇，可以看看 Cython 生成的 C 代码！</p><p id="d841" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">现在我们已经准备好测试我们新的超快的 C 代码了！查看下面的代码，它实现了一个速度测试来比较原始 Python 代码和 Cython 代码。</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f424" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">代码非常简单。我们以与普通 Python 相同的方式导入文件，并以与普通 Python 相同的方式运行函数！</p><p id="15ab" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">Cython 几乎可以在任何原始 Python 代码上获得很好的加速，根本不需要太多额外的努力。需要注意的关键是，你经历的循环越多，你处理的数据越多，Cython 就能提供越多的帮助。</p><p id="68bc" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">查看下表，它显示了 Cython 为我们提供的不同阶乘值的速度。我们通过 Cython 获得了超过 36 倍的速度提升！</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="nq nr l"/></div></figure></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><h1 id="6bc9" class="ll lm it bd ln lo oc lq lr ls od lu lv lw oe ly lz ma of mc md me og mg mh mi bi translated">喜欢学习？</h1><p id="eee8" class="pw-post-body-paragraph ki kj it kl b km mj ko kp kq mk ks kt li ml kw kx lj mm la lb lk mn le lf lg im bi translated">在 twitter 上关注我，我会在这里发布所有最新最棒的人工智能、技术和科学！也在<a class="ae lh" href="https://www.linkedin.com/in/georgeseif/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上和我联系吧！</p></div></div>    
</body>
</html>