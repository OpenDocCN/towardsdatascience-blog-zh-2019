<html>
<head>
<title>Load that &amp;%$*# Checkpoint!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加载&amp;%$*#检查点！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/load-that-checkpoint-51142d44fb5d?source=collection_archive---------23-----------------------#2019-01-02">https://towardsdatascience.com/load-that-checkpoint-51142d44fb5d?source=collection_archive---------23-----------------------#2019-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9640" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">成功的 Udacity 项目检查点加载的提示和技巧</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/16ee93c3e2b016216b354efedde99cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m7eTnVNb5IOkUk13"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@vidarnm?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Vidar Nordli-Mathisen</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="4f33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">加载那个检查点有问题吗？</p><p id="eb7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我也是。</p><p id="cec2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成为 Udacity 脸书 AI PyTorch 挑战赛的一员真是太棒了，一路上我学到了很多。完成最后的挑战后，我想分享一些技巧和诀窍，这些技巧和诀窍使我能够成功地将深度学习图像分类器项目的检查点提交到 Udacity 工作区。</p><p id="aa7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最重要的是，遵循实验室的指示！我希望你知道这一点，但我把它放在这里以防万一…</p><h2 id="c5c0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">保存您的检查点</h2><p id="fc42" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">如果您正在尝试在实验室中加载检查点，我假设您已经保存了检查点，但您确实需要保存检查点，因为这是您将在实验室中加载的内容！Torch.save 在这里非常方便。例如，这里有一个可能的检查点:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="7836" class="ls lt iq mr b gy mv mw l mx my">checkpoint = {'input_size': 2208,<br/>              'output_size': 102,<br/>              'epochs': epochs,<br/>              'batch_size': 64,<br/>              'model': models.densenet161(pretrained=True),<br/>              'classifier': classifier,<br/>              'scheduler': sched,<br/>              'optimizer': optimizer.state_dict(),<br/>              'state_dict': model.state_dict(),<br/>              'class_to_idx': model.class_to_idx<br/>             }<br/>   <br/>torch.save(checkpoint, 'checkpoint.pth')</span></pre><p id="2d19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只装你需要的东西。你可能不需要我在这个检查点加载的所有信息，但是我把上面的一个作为例子，这样你可以看到一些选项。在实验室中加载检查点之前，应该完成检查点保存。</p><p id="f250" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保您知道您的检查点保存在哪里，以便您可以将该文件上传到 Udacity 工作区！</p><h2 id="52bc" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">在 Colab 工作？</h2><p id="5cf3" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">如果您正在使用 Google Colab，并且将您的 Google Drive 安装到您的笔记本上(<a class="ae kv" rel="noopener" target="_blank" href="/getting-started-with-google-colab-f2fff97f594c">这里有一篇很棒的文章，如果您刚刚开始使用 Colab 并且不知道我在说什么</a>，您可以通过运行以下命令将您的检查点直接移动到您的 Google Drive 中:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="780a" class="ls lt iq mr b gy mv mw l mx my">model_save_name = 'classifier.pth'<br/>path = F"/content/gdrive/My Drive/{model_save_name}" <br/>torch.save(model.state_dict(), path)</span></pre><p id="c033" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请确保文件路径正确无误！</p><p id="5b51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">*如果您决定将您的检查点保存到您的 Google Drive，您实际上可以将它从那里移动到 Udacity 的工作区，方法是转到您的 Google Drive，获取可共享的链接文件，并找到您的文件 ID。您只需要文件 ID:它将是“id=”后面的一长串字母和数字。然后转到 Udacity 实验室笔记本运行</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="6f13" class="ls lt iq mr b gy mv mw l mx my">!pip install gdown==3.6.0</span></pre><p id="96fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装 gdown。那就跑</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="0b92" class="ls lt iq mr b gy mv mw l mx my">ckpt_file_id = "YOUR-FILE-ID-GOES-HERE"</span></pre><p id="2cab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(确保用您的实际文件 ID 替换“YOUR-FILE-ID-GOES-HERE ”!)</p><p id="b9cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="9625" class="ls lt iq mr b gy mv mw l mx my">!gdown <a class="ae kv" href="https://drive.google.com/uc?id={1kX4IwGUB88x9CTHAfhsAz7PljqnKZdEp" rel="noopener ugc nofollow" target="_blank">https://drive.google.com/uc?id={</a>ckpt_file_id}</span></pre><p id="0eb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将下载您的文件并将其放在 Udacity 实验室中。</p><h2 id="60d5" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">在 Udacity 工作区中</h2><p id="f6d2" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">如果您没有使用 Google Drive，那么当您到达实验室时，您需要点击“上传”按钮，上传您的检查点文件。确保它一直到 100%,否则你可能会得到一个损坏的文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/ef77c89c6b339a0a80f9c23c64632c5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sb7U374foVeIDLrFE944Vg.png"/></div></div></figure><p id="b6b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是您提交项目所需的重要信息:</p><p id="0fd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你需要加载你的参数。我从</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="1d26" class="ls lt iq mr b gy mv mw l mx my">ckpt = torch.load('checkpoint.pth')<br/>ckpt.keys()</span></pre><p id="f204" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样我就可以快速看一下我的钥匙。然后我运行我的进口。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="e3ae" class="ls lt iq mr b gy mv mw l mx my">from collections import OrderedDict</span><span id="2fcf" class="ls lt iq mr b gy na mw l mx my">import torch<br/>import torch.nn as nn<br/>from torchvision import models<br/>import os<br/>from torchvision import datasets, transforms</span></pre><p id="095c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一个非常重要的细节:如果您还没有定义图像大小，请运行以下命令:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="c1ff" class="ls lt iq mr b gy mv mw l mx my">image_size = 224<br/># Values you used for normalizing the images. Default here are for<br/># pretrained models from torchvision.<br/>norm_mean = [0.485, 0.456, 0.406]<br/>norm_std = [0.229, 0.224, 0.225]</span></pre><p id="e33f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，您可以创建一个检查点加载函数，并使用它来加载模型。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="0265" class="ls lt iq mr b gy mv mw l mx my">def load_checkpoint(filepath):<br/>    checkpoint = torch.load(filepath, map_location='cpu')<br/>    model = checkpoint['model']<br/>    model.classifier = checkpoint['classifier']<br/>    model.load_state_dict(checkpoint['state_dict'], strict=False)<br/>    model.class_to_idx = checkpoint['class_to_idx']<br/>    optimizer = checkpoint['optimizer']<br/>    epochs = checkpoint['epochs']<br/>    <br/>   for param in model.parameters():<br/>        param.requires_grad = False<br/>        <br/>    return model, checkpoint['class_to_idx']</span><span id="acdc" class="ls lt iq mr b gy na mw l mx my">model, class_to_idx = load_checkpoint('/home/workspace/checkpoint.pth')</span></pre><p id="d642" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你看到上面写着</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="d9a4" class="ls lt iq mr b gy mv mw l mx my">map_location='cpu'</span></pre><p id="3e10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">和</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="56a0" class="ls lt iq mr b gy mv mw l mx my">strict=False</span></pre><p id="f62f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi">?</p><p id="a0a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你想包括那些！</p><p id="c227" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不是开玩笑。Udacity 的工作空间没有连接 GPU，因此您需要确保指定了 CPU。您还希望使用“strict=False ”,以避免遇到任何不必要的版本兼容性问题。</p><p id="1c6d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仔细检查分类器的文件路径。正如你在上面看到的，我的是</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="b907" class="ls lt iq mr b gy mv mw l mx my">model, class_to_idx = load_checkpoint('/home/workspace/checkpoint.pth')</span></pre><p id="598d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你真的需要有正确的道路！如果你看一下测试单元上面的说明，几乎可以肯定你的文件路径应该是什么样子。Udacity 真的希望你成功，所以一定要认真看说明书！</p><h2 id="3886" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">最后</h2><p id="24da" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">将所有内容放入一个单元格中！将每一行代码放入提供的测试单元中。许多学生在做了一个简单的改变后，最终成功提交了项目。去做吧！</p><p id="0ea2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在测试代码并开始您的项目！这个项目是严格的通过/失败，所以如果你通过了，你就完成了！恭喜你！！！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/c7b17ebfe8a299abf025d6b0bfa21aee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1oF23aJ4Dy4tPcLEq3dLBA.png"/></div></div></figure><p id="d4e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在去庆祝吧！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/5e36de87b225efef2598effdb63a19aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rP3sp8t0aDdy1PiG"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@jayson_hinrichsen?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jayson Hinrichsen</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div>    
</body>
</html>