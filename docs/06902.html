<html>
<head>
<title>Sparkify User Churn Prediction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Sparkify 用户流失预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sparkify-user-churn-prediction-eff0868c5554?source=collection_archive---------35-----------------------#2019-09-30">https://towardsdatascience.com/sparkify-user-churn-prediction-eff0868c5554?source=collection_archive---------35-----------------------#2019-09-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b30e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">音乐是我们生活中重要的一部分。众所周知的事实是，如果你在免费层，你将无法逃脱广告打断你的会话。这难道不令人沮丧吗？:)是...</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/812bb77542700ac5ba995a64e87c1809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RfLO8IqUHmnnoQPqjLdIYw.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk"><a class="ae lb" href="https://imgflip.com/i/3bx9on" rel="noopener ugc nofollow" target="_blank">https://imgflip.com/i/3bx9on</a></figcaption></figure><p id="ec02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">客户参与、保持和流失一直是企业的重要课题。预测分析有助于企业采取主动行动，如提供优惠和折扣，以留住客户，并在某些情况下提高忠诚度。如今，我们产生了大量可用于此类分析的数据，数据科学对公司来说变得非常重要。</p><p id="2e38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Sparkify 是由 Udacity 创建的虚拟音乐流媒体应用程序。对于这个项目，我们给出了小型、中型和大型的应用数据。我在 AWS EMR 上使用 Spark 处理过中等规模的数据。</p><p id="8ce9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">github:<a class="ae lb" href="https://github.com/elifinspace/sparkify" rel="noopener ugc nofollow" target="_blank">https://github . com/elifinspace/spark ify/blob/master/readme . MD</a></p><h2 id="af6b" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">探测</h2><p id="f2fa" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">考虑到 ML，数据集相对较小，它有 543705 行和 18 列，包含客户信息(性别、姓名等。)和 API 事件(登录、播放下一首歌等。).</p><p id="f223" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">数据集从 2018 年 10 月 1 日到 2018 年 12 月 1 日。在这个数据集中，流失的客户数量是 99，客户总数是 449。相对于顾客总数来说，翻炒者的数量可能看起来很少，但当你想到这一点时，它就很大了。Sparkify 流失了 22%的客户！</p><p id="af12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是一些从初步调查中挑选出来的图片:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/53719a99164e9a07f5be3970d571fcaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O7sj-mtLmmX79gsQLB_zgw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">All customers event count free/paid distribution by gender</figcaption></figure><p id="b92b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到男性客户使用 Sparkify 活跃，付费客户比免费用户活跃。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/71d1e7e53ebeda9fcd38695516c88ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pj9P9XtXRTq7G9ZGxdD6GQ.png"/></div></div></figure><p id="ea1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从上面的图表我们可以得出结论，付费用户比免费用户流失更多。(标签=1 次流失)</p><p id="e39c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有趣的是，状态也显示出对搅动的影响:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/aa71462c5f4bc3d0aae6d7cbc2f4dbe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYrdhzq2wURxD4RkQ-EuXw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Churn count by States</figcaption></figure><h2 id="0f9f" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">特征工程</h2><p id="6be7" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">数据集包含了相当多的信息，我可以想到许多组合和计算来提取有用的信息。因此，我选择使用页面事件的每日和每月平均值(下一首歌，广告，..)、不同的会话、会话持续时间、项目以及项目的长度。我还添加了一些数字特征，比如注册后的时间。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/efebcd606ea42fa56b89b4fe43ed44af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r1nOC3c7gN5eCj8_jkk2gA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">A screenshot of features data frame</figcaption></figure><p id="69fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">生成特征后，还要进行后处理，以便为建模准备数据。分类列需要编码，数字列必须在管道中组装。pyspark.ml 为我们提供了这些功能，您不需要自己进行热编码。</p><p id="8ef7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用 stringIndexer 为每个分类列创建索引(将标签的<strong class="jp ir">字符串</strong>列编码为标签索引列)，VectorAssembler 是一个特征转换器，它将多个列组装(合并)为一个(特征)向量/列。[1]这些是作为阶段添加到管道中的，我们将对其进行数据拟合。代码和细节可以在开头提到的 Github 资源库中找到。</p><h2 id="e939" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">培训、指标和调整</h2><p id="d6d1" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们的问题是预测哪些用户可能流失，哪些不会，所以本质上这是二元分类。</p><p id="1450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用正确的度量标准评估模型是很重要的。对于这项工作，当我选择正确的模型时，我选择以下指标:<br/> # f1 得分:解释模型的稳健性和精确性。</p><p id="2484" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"># AUC:表示模型能够区分类别的程度，以及分类器将随机选择的正例排序高于随机选择的负例的概率。</p><p id="35cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对我们来说，对没有流失的客户进行正确分类很重要，否则我们可能会采取错误的行动，或者我们可能会采取不应该采取的行动，这可能会让客户感到困惑。</p><p id="74c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从简单到复杂的模型开始，对逻辑回归、随机森林分类和梯度推进分类器的 f1 得分和 AUC(ROC 曲线下面积)进行了比较:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="e8ec" class="lc ld iq md b gy mh mi l mj mk">logistic_regression<br/>The F1 score on the test set is 79.83%<br/>The areaUnderROC on the test set is 67.17%</span><span id="4175" class="lc ld iq md b gy ml mi l mj mk">random_forest_classifier<br/>The F1 score on the test set is 87.81%<br/>The areaUnderROC on the test set is 95.08%</span><span id="5aa5" class="lc ld iq md b gy ml mi l mj mk">gradient_boosting_classifier<br/>The F1 score on the test set is 85.68%<br/>The areaUnderROC on the test set is 88.83%</span></pre><p id="541f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我选择了随机森林模型，并应用了基于 f1 分数的超参数调整:</p><p id="9e02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网格搜索方式:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="870a" class="lc ld iq md b gy mh mi l mj mk">paramGrid = ParamGridBuilder() \<br/>    .addGrid(clf.numTrees, [20,75]) \<br/>    .addGrid(clf.maxDepth, [10,20]) \<br/>    .build()</span></pre><p id="a68d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="0831" class="lc ld iq md b gy mh mi l mj mk">The F1 score on the test set is 91.03%<br/>The areaUnderROC on the test set is 93.25%</span></pre><p id="cead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最佳参数:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="1229" class="lc ld iq md b gy mh mi l mj mk">maxDepth:10</span><span id="b10e" class="lc ld iq md b gy ml mi l mj mk">numTrees:75</span></pre><p id="1100" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们可以通过选择这些参数来改善我们的管道。</p><p id="d652" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">准确率和 f1 成绩都相当惊人。然而，我们不应该忘记，我们的数据集可能无法代表所有的客户群，我已经使用了中等规模的数据集。此外，在实际应用中，70%以上的精度被认为是良好的和可接受的。</p><p id="fdb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，当我们检查功能的重要性，级别(免费/付费)，注册以来的时间，每月平均滚动广告似乎是最重要的 3 个功能，这并没有让我感到惊讶。总是这些广告！… :)</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="4fee" class="lc ld iq md b gy mh mi l mj mk">avg_daily_sessions : 0.04236219536508317 <br/><br/>avg_monthly_sessions : 0.03951447819898451 <br/><br/>avg_daily_session_duration : 0.02073779077811611 <br/><br/>avg_monthly_session_duration : 0.016396278628309786 <br/><br/>avg_daily_items : 0.020040353630460424 <br/><br/>avg_monthly_items : 0.022926933384472603 <br/><br/>avg_daily_RollAdvert : 0.019136923054740844<br/>....</span></pre><h2 id="50a9" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">结论</h2><p id="e669" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Spark 的机器学习使我们能够处理大量数据，获得洞察力，并以可扩展的方式从结果中制定行动。使用大型数据集时，配置环境参数也非常重要，还应考虑模型的准确性、运行时内存使用和资源优化。在实际应用中，可行性和成本变得非常重要。这种模式可以每周或每月运行一次，具体取决于数据延迟和业务需求。应监控运营成本，并通过测试(A/B 测试)验证模型结果。应该跟踪实验结果(评估指标、KPI ),以便我们的模型和后续行动能够为业务带来价值。</p><p id="90d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【1】:<a class="ae lb" href="https://spark.apache.org/docs/2.2.0/ml-features.html" rel="noopener ugc nofollow" target="_blank">https://spark.apache.org/docs/2.2.0/ml-features.html</a></p></div></div>    
</body>
</html>