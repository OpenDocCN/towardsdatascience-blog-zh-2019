<html>
<head>
<title>How to do batch predictions of TensorFlow models directly in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 BigQuery 中直接批量预测张量流模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-batch-predictions-of-tensorflow-models-directly-in-bigquery-ffa843ebdba6?source=collection_archive---------23-----------------------#2019-04-10">https://towardsdatascience.com/how-to-do-batch-predictions-of-tensorflow-models-directly-in-bigquery-ffa843ebdba6?source=collection_archive---------23-----------------------#2019-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c90c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">BigQuery ML 现在支持 TensorFlow SavedModel</h2></div><p id="3209" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您已经在 TensorFlow 中训练了一个模型，并将其导出为 SavedModel，那么您现在可以使用 ML。BigQuery 中的 PREDICT SQL 函数进行预测。如果您想要进行批量预测(例如，对过去一小时收集的所有数据进行预测)，这非常有用，因为任何 SQL 查询都可以在 BigQuery 中调度。</p><p id="c077" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">步骤:</p><ul class=""><li id="e8eb" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">在 TensorFlow 中训练和导出保存的模型</li><li id="4800" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">在 BigQuery 中，创建一个模型，传递保存的模型的位置</li><li id="6d20" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">用 ML。评估，ML。预测等。就像在 BigQuery 中使用其他(内置)模型类型训练模型一样。</li></ul><p id="8f2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lp">注意:该功能目前处于公开测试阶段。联系您的 GCP 代表获得白名单。</em></p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/ebf1519aef320e22d2dd5e3f25302849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gtAtm8GgvWROfTQLut3oDw.jpeg"/></div></div></figure><h2 id="cf93" class="mc md iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">1.在 TensorFlow/Keras 中训练和导出保存的模型</h2><p id="fd9a" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我将使用我在这篇博文中描述的<a class="ae na" rel="noopener" target="_blank" href="/how-to-do-text-classification-using-tensorflow-word-embeddings-and-cnn-edae13b3e575">文本分类模型</a>进行演示，其 Keras 代码在<a class="ae na" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/courses/machine_learning/deepdive/09_sequence/txtclsmodel" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上。我在 Cloud ML 引擎上训练模型，但你可以在任何地方以任何方式训练它。重要的一点是将模型作为保存的模型导出到 Google 云存储中:</p><pre class="lr ls lt lu gt nb nc nd ne aw nf bi"><span id="6092" class="mc md iq nc b gy ng nh l ni nj">exporter = tf.estimator.LatestExporter('exporter', serving_input_fn)</span></pre><h2 id="4b81" class="mc md iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">2.创建模型</h2><p id="a680" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">在 BigQuery 中创建模型只需指定一个不同的 model_type，并将其指向导出 SavedModel 的 model_path(注意末尾的通配符，用于选择资产、词汇等)。):</p><pre class="lr ls lt lu gt nb nc nd ne aw nf bi"><span id="a04b" class="mc md iq nc b gy ng nh l ni nj">CREATE OR REPLACE MODEL advdata.txtclass_tf<br/>OPTIONS (<strong class="nc ir">model_type='tensorflow',</strong><br/>         <strong class="nc ir">model_path=</strong>'gs://cloud-training-demos/txtclass/export/exporter/1549825580/*')</span></pre><p id="8a3d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我已经将上面的 bucket 设置为 public，所以您可以按原样尝试上面的查询(首先创建一个名为 advdata 的数据集)。这将在 BigQuery 中创建一个模型，其工作方式类似于任何内置模型:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi nk"><img src="../Images/2f152d40f667794ec4be1ca19eb2ca18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TdbMH6O3qXbCxN5U59M1Hw.png"/></div></div></figure><p id="3c80" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">特别是，该模式指出模型所需的输入称为“输入”,并且是一个字符串。</p><h2 id="35c3" class="mc md iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">3.用模型预测</h2><p id="e69c" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">用模型预测非常简单。例如，我们可以从 BigQuery 表中提取一些数据，并确保在 select 中，我们根据 TensorFlow 的要求来命名列。在这种情况下，我的 TensorFlow 模型的 serving_input_fn 指定该模型需要一个名为“input”的输入字符串。</p><p id="26c1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">鉴于此，我们现在可以做一个预测:</p><pre class="lr ls lt lu gt nb nc nd ne aw nf bi"><span id="9ee2" class="mc md iq nc b gy ng nh l ni nj">WITH extracted AS (<br/>SELECT source, REGEXP_REPLACE(LOWER(REGEXP_REPLACE(title, '[^a-zA-Z0-9 $.-]', ' ')), "  ", " ") AS title FROM<br/>  (SELECT<br/>    ARRAY_REVERSE(SPLIT(REGEXP_EXTRACT(url, '.*://(.[^/]+)/'), '.'))[OFFSET(1)] AS source,<br/>    title<br/>  FROM<br/>    `bigquery-public-data.hacker_news.stories`<br/>  WHERE<br/>    REGEXP_CONTAINS(REGEXP_EXTRACT(url, '.*://(.[^/]+)/'), '.com$')<br/>    AND LENGTH(title) &gt; 10<br/>  )<br/>)<br/>, input_data AS (<br/>  SELECT title AS input FROM extracted limit 5<br/>)</span><span id="a17a" class="mc md iq nc b gy nl nh l ni nj">SELECT *<br/>FROM ML.PREDICT(MODEL advdata.txtclass_tf, <br/>               (SELECT * FROM input_data))</span></pre><p id="f258" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这提供了结果:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi nm"><img src="../Images/684a275f8c3bdd7a28ed62df80e26dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZhR17PWfceBFKQ960wXf1A.png"/></div></div></figure><p id="78e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">知道了实际的标签，我们可以使实际的查询更好:</p><pre class="lr ls lt lu gt nb nc nd ne aw nf bi"><span id="d7f4" class="mc md iq nc b gy ng nh l ni nj">SELECT<br/>  input,<br/>  (SELECT AS STRUCT(p, ['github', 'nytimes', 'techcrunch'][ORDINAL(s)]) prediction FROM<br/>    (SELECT p, ROW_NUMBER() OVER() AS s FROM<br/>      (SELECT * FROM UNNEST(dense_1) AS p)) <br/>  ORDER BY p DESC LIMIT 1).*</span><span id="cada" class="mc md iq nc b gy nl nh l ni nj">FROM ML.PREDICT(MODEL advdata.txtclass_tf,<br/>(<br/>SELECT 'Unlikely Partnership in House Gives Lawmakers Hope for Border Deal' AS input<br/>UNION ALL SELECT "Fitbit\'s newest fitness tracker is just for employees and health insurance members"<br/>UNION ALL SELECT "Show HN: Hello, a CLI tool for managing social media"<br/>))</span></pre><p id="de67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，这个函数直接在 SQL 中提供值。结果是:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi nn"><img src="../Images/d28792f6d1214653821bcd08a8efce60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4mLgWHtLix81v66CrS3C4g.png"/></div></div></figure><p id="1bb0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！</p></div></div>    
</body>
</html>