<html>
<head>
<title>Detect Greek language in text using Docker, &amp; store in S3 without Boto3.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Docker 检测文本中的希腊语，并在没有 Boto3 的情况下存储在 S3。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/detect-greek-language-in-text-using-docker-store-in-s3-without-boto3-3c6d6b220639?source=collection_archive---------34-----------------------#2019-10-15">https://towardsdatascience.com/detect-greek-language-in-text-using-docker-store-in-s3-without-boto3-3c6d6b220639?source=collection_archive---------34-----------------------#2019-10-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/bcc70de51d7df81c30e8b87d9f4c13dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rCkCbdsuoqu_H6CYhprrTw.jpeg"/></div></div></figure><p id="cea8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="kz">嗨，你好！在这篇文章中，我们将构建一个小的“应用程序”，它能够检测文本中的希腊语并在 AWS S3 中存储一些结果。</em>T3】</strong></p><p id="9d87" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更详细地说，该应用程序将是一个 docker 容器，它将接受输入文件路径，将能够获取文件(例如，从 AWS S3 桶)，使用 python 脚本来处理它，检测文本中的希腊语，仅保留希腊语文本，并最终上传结果。希腊文本的 csv 文件放回 AWS S3 桶。</p><p id="c586" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为第一步，我们将构建一个 Docker 映像&amp;确保语言检测、文本处理和 AWS 通信所需的所有模块都安装在映像的虚拟 OS 中，只要保存 AWS 凭证的环境变量被正确地传递到 Docker 映像中。</p><p id="9502" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更有趣的是:</p><ul class=""><li id="479e" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">我们将不使用 boto3 库，因为当 AWS S3 的访问权限严格时，它并不总是与 AWS CLI 功能相同。</li><li id="1fbd" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">我们将使用<a class="ae lo" href="https://fasttext.cc/" rel="noopener ugc nofollow" target="_blank"> fastText </a>文本分类库，它实际上将是我们的语言检测工具，因为它提供了微小的<a class="ae lo" href="https://dl.fbaipublicfiles.com/fasttext/supervised-models/lid.176.ftz" rel="noopener ugc nofollow" target="_blank"> lid.176.ftz </a>模型；其对应主模型的压缩版本，文件大小仅为 917kB！</li></ul></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="94f6" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">需要的文件</h1><p id="5c8d" class="pw-post-body-paragraph kb kc it kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">在设置我们的流程之前，我们需要准备一些文件:</p><ul class=""><li id="f162" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">。:在目录中创建一个本地文件夹，docker 文件将放在其中并用于构建映像。</li><li id="03a5" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">。/init/:在上面的主文件夹中，创建一个' init '文件夹，该文件夹将包含所有需要复制到 docker 映像中的文件。</li><li id="377c" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">。/init/envs.py:环境变量文件:</li></ul><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="182b" class="ni lx it ne b gy nj nk l nl nm">envs = {<br/>    "LOCAL_FILE": 'temp.csv',<br/>    "LOCAL_OUT_FILE": 'output.csv',<br/>    "AWS_S3_PROFILE": 'my_aws_s3_profile_name'<br/>}</span></pre><ul class=""><li id="d22d" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">。/init/s3.py:主要功能的脚本。</li><li id="f678" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">。/init/lib _ process . py:S3 . py 文件导入和使用的帮助器库。</li><li id="8ecc" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">。/init/lid.176.ftz:语言检测模型。</li><li id="892a" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">。/init/credentials:AWS 凭据文件:</li></ul><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="bd2d" class="ni lx it ne b gy nj nk l nl nm">[my_aws_s3_profile_name]<br/>aws_access_key_id = ABCDE<br/>aws_secret_access_key = 12345</span></pre><ul class=""><li id="6231" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">。/init/config:AWS 配置文件:</li></ul><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="6cb8" class="ni lx it ne b gy nj nk l nl nm">[my_aws_s3_profile_name]<br/>output=json<br/>region=us-east-2</span></pre><p id="2086" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">其中我们假设我们的 AWS 区域是 us-east-2。</p><ul class=""><li id="bc82" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">Dockerfile:用于构建 docker 映像的 docker 指令。</li></ul></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="63bb" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated"><strong class="ak"> Docker 图像</strong></h1><p id="b0bc" class="pw-post-body-paragraph kb kc it kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">让我们一起逐行解析<strong class="kd iu">docker 文件</strong>:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="af3f" class="ni lx it ne b gy nj nk l nl nm">1 FROM python:3.6.6-slim<br/>2 WORKDIR .<br/>3 COPY ./init/envs.py .<br/>4 COPY ./init/s3.py .<br/>5 COPY ./init/lib_process.py .<br/>6 COPY ./init/lid.176.ftz .<br/>7 RUN mkdir -p /.aws/<br/>8 RUN apt-get update &amp;&amp; apt-get install -y \<br/>9         python-dev \<br/>10        python-numpy \<br/>11        python-scipy \<br/>12        &amp;&amp; rm -rf /var/cache/apk/*<br/>13 COPY ./init/credentials /.aws/<br/>14 COPY ./init/config /.aws/<br/>15 ENV AWS_CONFIG_FILE=/.aws/config<br/>16 ENV AWS_SHARED_CREDENTIALS_FILE=/.aws/credentials<br/>17 RUN pip3 install --upgrade awscli<br/>18 RUN pip3 install fasttext<br/>19 RUN chmod u+x s3.py<br/>20 ENTRYPOINT ["python3","s3.py"]<br/>21 CMD ['']</span></pre><p id="eeb0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="kz">按大小构建最佳 docker 图像超出了范围；在《走向数据科学》中有许多关于这方面的好文章:-) </em></p><ul class=""><li id="7d5a" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated"><strong class="kd iu">第一行:</strong>我们从一个 python3.6 小图开始。</li><li id="b896" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 2 行:</strong>我们将当前目录设置为构建映像时看到的目录。</li><li id="ebec" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 3 行:</strong>将 env 移动到映像的操作系统中。</li><li id="c903" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">第 4 行&amp; 5: 用 python 脚本做同样的事情。</li><li id="a1c2" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 6 行:</strong>对语言检测模型做同样的操作。</li><li id="2c83" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">第 7 行:创建 AWS-CLI 设置目录。</li><li id="0ae7" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 8–12 行:</strong>通过 docker 镜像的 Ubuntu OS 安装一些基本的 python 模块，但是不保留它们的安装文件。</li><li id="6b2d" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 13 行&amp; 14: </strong>将 AWS 设置文件(包括 AWS-CLI 凭证)移动到映像的操作系统默认 AWS-CLI 设置目录中。✧:这很重要。我们在构建时注入凭证，而不是在 docker 文件或相关源代码(共享代码)中硬编码凭证。<br/>  ✧ <em class="kz">让运行中的容器要求凭证作为输入参数会更安全。<br/> </em> ✧ <em class="kz">以上是我们通过 envs.py 文件传递凭证的例子。</em></li><li id="3dcf" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 15 行&amp; 16: </strong>刷新(设置)显示设置文件路径的 AWS 环境变量。</li><li id="c682" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 17 行:</strong>通过 python 的 pip 安装 AWS-CLI。</li><li id="de6f" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 18 行:</strong>通过 python 的 pip 安装 fasttext 库。</li><li id="d61a" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 19 行:</strong>使 s3.py 文件可执行。</li><li id="01b0" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><strong class="kd iu">第 20 行&amp; 21: </strong>默认情况下，上面的映像创建的任何容器都将使用虚拟操作系统的 python3 来运行 python 可执行文件 s3.py。</li></ul></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="23c5" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">使用 docker 图像</h1><p id="103a" class="pw-post-body-paragraph kb kc it kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">我们可以运行以下命令，例如在 Ubuntu 中:</p><ul class=""><li id="ea17" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">建立形象:</li></ul><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="54c1" class="ni lx it ne b gy nj nk l nl nm">docker build --no-cache -t &lt;image_name&gt; .</span></pre><ul class=""><li id="b540" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">创建并运行图像的容器:</li></ul><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="d605" class="ni lx it ne b gy nj nk l nl nm">docker run --rm -t --name &lt;container_name&gt; &lt;image_name&gt; \<br/>"s3://&lt;bucket_name&gt;/&lt;relative path to file&gt;/input.csv" \ "s3://&lt;bucket_name&gt;/&lt;relative path to file&gt;/output.csv"</span></pre><p id="18ce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我们的例子中，上面的意思是我们创建并运行一个容器，它将在第一个 s3 路径中找到输入文件，并将处理后的结果文件存储在第二个 s3 路径中。</p><ul class=""><li id="322e" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">通过打开虚拟操作系统进行手动探索来调试映像:</li></ul><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="1e7f" class="ni lx it ne b gy nj nk l nl nm">docker run --entrypoint "/bin/bash" -it \ <br/>--name &lt;container_name&gt; &lt;image_name&gt;</span></pre></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="1f71" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated"><strong class="ak">内部流动</strong></h1><p id="87a7" class="pw-post-body-paragraph kb kc it kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">正如我们在上面看到的，容器使用一些给定的参数执行 s3.py 脚本。剧本:</p><ul class=""><li id="4f32" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">读取参数。</li><li id="d429" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">通过其主机操作系统(即 docker 映像操作系统)运行 aws-cli 命令，并从 aws s3 获取输入。csv 文件。</li><li id="fcd2" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">处理输入文件并生成输出文件。</li><li id="1b89" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">再次运行 aws-cli 命令，并将其上传到 s3 输出中。csv 文件。</li><li id="bd11" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">对于本教程。csv 文件是 utf-8 编码的，用逗号分隔。</li></ul><p id="44d3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> s3.py </strong>脚本:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="a37f" class="ni lx it ne b gy nj nk l nl nm">#!/usr/bin/python3</span><span id="f6f1" class="ni lx it ne b gy nn nk l nl nm">import os<br/>import sys<br/>from envs import envs<br/>from lib_process import processing</span><span id="5ede" class="ni lx it ne b gy nn nk l nl nm">if __name__ == '__main__':<br/>    print(os.uname())<br/>    print("This is the name of the script: ", sys.argv[0])<br/>    print("Number of arguments: ", len(sys.argv))<br/>    print("The arguments are: ", str(sys.argv))<br/>    REMOTE_IN_FILE = sys.argv[1]<br/>    LOCAL_FILE = "./" + envs["LOCAL_FILE"]<br/>    LOCAL_OUT_FILE = "./" + envs["LOCAL_OUT_FILE"]<br/>    REMOTE_OUT_FILE = sys.argv[2]<br/>    print("Entered the python script.")<br/>    print("Envs: REMOTE_IN_FILE:", REMOTE_IN_FILE)<br/>    print("Envs: LOCAL_FILE:", LOCAL_FILE)<br/>    print("Envs: REMOTE_OUT_FILE:", REMOTE_OUT_FILE)<br/>    print("Envs: AWS_S3_PROFILE:", envs['AWS_S3_PROFILE'])</span><span id="97c9" class="ni lx it ne b gy nn nk l nl nm">    down_command = "aws s3 cp " + "--profile " + <br/>        envs['AWS_S3_PROFILE'] + " " + REMOTE_IN_FILE + " " <br/>        + LOCAL_FILE<br/>    print(down_command)<br/>    os.system(down_command)</span><span id="b827" class="ni lx it ne b gy nn nk l nl nm">    processing(LOCAL_FILE, LOCAL_OUT_FILE)</span><span id="5e38" class="ni lx it ne b gy nn nk l nl nm">    up_command = "aws s3 cp " + "--profile " + <br/>        envs['AWS_S3_PROFILE'] + " " + LOCAL_OUT_FILE + " " <br/>        + REMOTE_OUT_FILE<br/>    print(up_command)<br/>    os.system(up_command)</span></pre></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="2776" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">处理</h1><p id="a093" class="pw-post-body-paragraph kb kc it kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">s3.py 脚本使用包含执行处理的函数的助手库 python 文件。</p><p id="7825" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">假设输入文件的行是这样的格式:"&lt; text_id &gt;，&lt; text &gt; \n" </strong></p><p id="8c41" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> lib_process.py </strong>库:</p><pre class="mz na nb nc gt nd ne nf ng aw nh bi"><span id="5e6b" class="ni lx it ne b gy nj nk l nl nm">import fasttext</span><span id="7837" class="ni lx it ne b gy nn nk l nl nm"><br/>def is_greek(txt, model):<br/>    # Predict only the most dominant language in the text:<br/>    pred = model.predict(txt, k=1)<br/>    # Fetch the found language<br/>    pred_langs = pred[0]<br/>    pred_lang = pred_langs[0]<br/>    # Compare the predicted language with the greek lang label:        <br/>    return False if pred_lang != '__label__el' else True</span><span id="b60e" class="ni lx it ne b gy nn nk l nl nm"><br/>def processing(local_file, out_file):<br/>    # Open the file readers:        <br/>    fin = open(local_file, mode='r')<br/>    fout = open(out_file, mode='a')</span><span id="1208" class="ni lx it ne b gy nn nk l nl nm">    # Load the language detection model, once:<br/>    model = fasttext.load_model('lid.176.ftz')</span><span id="3c9e" class="ni lx it ne b gy nn nk l nl nm">    line_count = 0    <br/>    while True: # Loop over all input lines<br/>        # Split text by sentence<br/>        line = fin.readline()<br/>        if not line:<br/>            break # File ended<br/>        line_count += 1</span><span id="3b29" class="ni lx it ne b gy nn nk l nl nm">        # Split line(sentence) into tokens &amp; keep the text<br/>        txt = line.strip().split(",")[1]<br/>    <br/>        # Keep Greek sentences<br/>        if is_greek(txt, model):<br/>            # Store in the output file the found greek sentence:            <br/>            fout.write(line + '\n')</span><span id="f956" class="ni lx it ne b gy nn nk l nl nm">    # Close the files:<br/>    fin.close()<br/>    fout.close()</span></pre></div><div class="ab cl lp lq hx lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="im in io ip iq"><h1 id="6c2e" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated"><strong class="ak">原来如此！我希望你喜欢它！</strong></h1><p id="77be" class="pw-post-body-paragraph kb kc it kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">感谢阅读，请不要犹豫留下任何评论或分享意见。</p></div></div>    
</body>
</html>