<html>
<head>
<title>Use Python to wrap business figures from listed company reports (tabula-py)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 包装上市公司报告中的业务数据(tabula-py)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-python-to-wrap-business-figures-from-listed-company-reports-6a48b01bf624?source=collection_archive---------20-----------------------#2019-10-20">https://towardsdatascience.com/use-python-to-wrap-business-figures-from-listed-company-reports-6a48b01bf624?source=collection_archive---------20-----------------------#2019-10-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="ee81" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(声明:这是一个只教 Python 的教育帖。内容仅供参考。它无意成为投资建议。)</p><p id="7af6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于一家上市公司来说，它不断在网上发布不同的报告和数据，让投资者和潜在投资者更好地了解企业。然而，大多数报告都是 PDF 格式的，我们都知道很难复制和处理数字。对于大型投资公司和机构来说，他们肯定有专门的和复杂的工具来阅读 pdf 报告。但是像你我这样的个人投资者呢？有什么方法可以自动读取 pdf 报告并存储或分析？幸运的是，在 Python 的帮助下，答案是肯定的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/94c8eab6c3d7a54699e28fd48e95876e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hfh9L9WaE1XS1Jt0iPsUbw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">This is the result. Impressed? You can do it also.</figcaption></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="e124" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将使用的主要模块叫做“tabula”。还有一些其他的模块可以读取 pdf 文件，但是到目前为止，经过多次测试,“tabula”是从 pdf 文件包装表格并存储为 dataframe 的最佳模块。因此，包装后，您可以将结果存储为 csv 文件或与历史数据相结合。</p><p id="943e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将使用的公司是国泰航空公司。国泰航空是香港的上市航空公司。每个月，它都会通过不同的目的地释放大量的乘客和货物。因此，通过了解每月的数据，您可以更好地了解其收入流，并帮助您做出更好的投资判断。</p><p id="f49e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一步是获取 pdf 报告。我将使用更直接的方法在线访问文件并阅读 pdf 文件，而不是手动下载。因此，有必要知道存储这些报告的路径。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ll"><img src="../Images/d686032b0b761b7cee79a195b054d6a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VhgeYW_zPJLi_sdSTxoytQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk"><a class="ae lm" href="https://www.cathaypacific.com/cx/en_HK/about-us/investor-relations/announcements.html" rel="noopener ugc nofollow" target="_blank">https://www.cathaypacific.com/cx/en_HK/about-us/investor-relations/announcements.html</a></figcaption></figure><p id="2b38" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上图是下载各种公告的页面。“交通数字”报告是我们感兴趣的一个。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ln"><img src="../Images/ef52f93596bf419aa686050b47faa050.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S2w6lKw6Ft8OqyK34Eczzw.png"/></div></div></figure><p id="011f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">输入关键词后，可以看到所有的流量数字报告。</p><p id="c6c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步是研究如何在线获取这些报告。幸运的是，文件路径是标准化的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lo"><img src="../Images/27f6de24d2e6c10c4977531c88fff3f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOsv-gi-sM9X6K4kFQKMQw.png"/></div></div></figure><p id="11ed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如上图所示，唯一的变化就是最后显示年和月的数字。第一部分不变。</p><p id="95fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，在某些月份，文件路径的子前缀不是“pdf”，而是“PDF”(全部大写)。因此，在编写 Python 脚本时，有必要处理这种情况。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lp"><img src="../Images/b73153c9b0ae3fa707dfbe73a2d931e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K9NxuDPrsT3Rtlf0JOO-EQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Please keep the format unchanged!!</figcaption></figure><p id="a52a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以文件路径是“' https://www . cathay Pacific . com/dam/CX/about-us/investor-relations/announcements/en/{ year _ month } _ cxtraffic _ en . pdf(或 PDF)”。</p><p id="9f6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们感兴趣的页面显示了每个月的流量和容量。它们存储在两个独立的表中。这是我们下一阶段需要努力的地方。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lq"><img src="../Images/e184a646136718f6b3b1b986501c8515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRfI5Ejs6VxVp9o4vwrhFQ.png"/></div></div></figure><p id="c3a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">遗憾的是，显示这些表的页面并不是恒定的。相反，它们显示在每个报告的倒数第二页。所以在包装之前，有必要知道每份报告的页数。</p><p id="d881" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面显示了 Python 脚本应该执行的列表:</p><ol class=""><li id="f271" class="lr ls it js b jt ju jx jy kb lt kf lu kj lv kn lw lx ly lz bi translated"><a class="ae lm" href="#6dde" rel="noopener ugc nofollow">通过文件路径</a>访问文件</li><li id="10ed" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated"><a class="ae lm" href="#bc66" rel="noopener ugc nofollow">检查总页数</a></li><li id="a0c1" class="lr ls it js b jt ma jx mb kb mc kf md kj me kn lw lx ly lz bi translated"><a class="ae lm" href="#faa6" rel="noopener ugc nofollow">转到倒数第二页，将两张表格换行</a></li></ol></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="6dde" class="mf mg it bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated"><strong class="ak">通过文件路径</strong>访问文件</h1><p id="c087" class="pw-post-body-paragraph jq jr it js b jt nd jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj nh kl km kn im bi translated">所需模块:请求</p><p id="ca86" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于文件路径中的{year_month}变量每个月都会发生变化，因此变量“link”与格式一起使用，以便包含变量“month”。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="44e6" class="nn mg it nj b gy no np l nq nr">link = 'https://www.cathaypacific.com/dam/cx/about-us/investor-relations/announcements/en/{}_cxtraffic_en.pdf'.format(month)</span></pre><p id="3976" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步是使用请求模块来访问文件</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="0e83" class="nn mg it nj b gy no np l nq nr">import requests<br/>response = requests.get(link)</span></pre><p id="2d1b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如前所述，在某些月份子 fix 是 pdf，所以上面的链接不会给你 PDF 文件，而只是一个错误页面。所以有必要检查一下反应。如果响应是 404(错误)，则更改链接并以 PDF 结尾。通过键入 response.status_code 可以获得响应代码。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="fa13" class="nn mg it nj b gy no np l nq nr">if response.status_code == 404:<br/>    link = 'https://www.cathaypacific.com/dam/cx/about-us/investor-relations/announcements/en/{}_cxtraffic_en.PDF'.format(month)<br/>    response = requests.get(link)</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="bc66" class="mf mg it bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">检查总页数</h1><p id="de11" class="pw-post-body-paragraph jq jr it js b jt nd jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj nh kl km kn im bi translated">所需模块:io，PyPDF2</p><p id="e015" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">成功访问文件路径后，下一步是读取文件并获得页数。</p><p id="b56d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，内置模块“io”与“BytesIO”一起使用，从请求中读取响应的内容。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="81c1" class="nn mg it nj b gy no np l nq nr">import io<br/>io.BytesIO(response.content)</span></pre><p id="e2fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在是时候引入另一个模块来读取 pdf 文件了，PyPDF2。不像 tabula，PyPDF2 可以让你获得关于 PDF 文件的信息，甚至合并 pdf 文件。您可以通过在线阅读 PyPDF2 文档来了解更多信息。</p><div class="ns nt gp gr nu nv"><a href="https://pythonhosted.org/PyPDF2/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">PyPDF2 文档- PyPDF2 1.26.0 文档</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">编辑描述</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">pythonhosted.org</p></div></div></div></a></div><p id="e5ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要使用的类是“PdfFileReader ”,并使用“getNumPages”返回页数。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="dc08" class="nn mg it nj b gy no np l nq nr">import PyPDF2<br/>with io.BytesIO(response.content) as open_pdf_file:<br/>    pdf_file  = PyPDF2.PdfFileReader(open_pdf_file)<br/>    num_pages = pdf_file.getNumPages()</span></pre></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="faa6" class="mf mg it bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">翻到倒数第二页，把两张表包起来</h1><p id="3fd3" class="pw-post-body-paragraph jq jr it js b jt nd jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj nh kl km kn im bi translated">所需模块:白板</p><p id="432c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个阶段，您需要做的就是转到那个特定的页面，复制这两个表。很简单，对吧？不完全是。</p><p id="e3b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">之前说过，pdf 是给人类看的，不是给机器看的。因此，当您使用 tabula 来包装表格时，tabula 很有可能无法成功读取表格或读取不正确。</p><p id="076e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Tabula 允许您定义 pdf 文件中指定的区域。但是，在这种情况下，由于两个表在同一页上，所以先包装整个页面，然后再拆分成两个表会更容易。使用 tabula.read_pdf 来完成此操作。</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="3c76" class="nn mg it nj b gy no np l nq nr">table  = read_pdf(link, pages = num_pages-1)</span></pre><p id="0c5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">PS:如果你想指定一个特定的区域，你可以在函数中包含“区域”选项。首先，您可以在 Acrobat Reader 中使用 Measure 来获得上、左、下和右(以英寸为单位)的距离，然后乘以 72。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/742d38839429f3c6d6dbbb6d18df2745.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*s5PXBYZkLgEocxzDupc5MQ.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Click “Tool” tab and select “Measure” in Acrobat Reader</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi of"><img src="../Images/2c21ccaef9821b887957a6f9c1dfa679.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*px_dtLPdbNIO7tuQ0vXufw.png"/></div></div></figure><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="d728" class="nn mg it nj b gy no np l nq nr">table  = read_pdf(link, pages = 4 , area = [1.1*72, 0.9*72, 4.8*72, 7.26*72])</span></pre><p id="e7a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最好包含一个稍微大一点的区域，这样 tabula 可以正确地包裹表格。</p><p id="4974" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果成功，返回的表将是您想要的结果。通常在结果数据帧中有一些不必要的行或列，所以你需要在换行后清理表格。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="0e0e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，您不需要手动复制和保存任何公司报告中的数据。您还可以使用这种方法包装任何 pdf 文件中的数字，例如您部门的月销售额。这可以为你节省很多做无聊工作的时间，这样你就可以做更重要的工作了。</p><p id="bc3b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是这篇文章的结尾。希望你看完能有所收获。给我一个评论或者鼓掌表示支持。下次见。</p><p id="bd88" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完整的代码可以在<a class="ae lm" href="https://github.com/wyfok/Cathay_Pacific_Monthly_figures" rel="noopener ugc nofollow" target="_blank">https://github.com/wyfok/Cathay_Pacific_Monthly_figures</a>找到</p></div></div>    
</body>
</html>