<html>
<head>
<title>A Complete Guide to an Interactive Geographical Map using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 的交互式地理地图完整指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-complete-guide-to-an-interactive-geographical-map-using-python-f4c5197e23e0?source=collection_archive---------2-----------------------#2019-02-05">https://towardsdatascience.com/a-complete-guide-to-an-interactive-geographical-map-using-python-f4c5197e23e0?source=collection_archive---------2-----------------------#2019-02-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/31fe96d16969125c2e2c3993b8068393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0ncdSQp1wZRX-wSO-JsRg.png"/></div></div></figure><div class=""/><p id="6774" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有没有想过这些美丽的地理地图是如何制作的？<a class="ae kz" href="https://ourworldindata.org" rel="noopener ugc nofollow" target="_blank">我们的数据世界</a>收集了大量关于健康、人口增长、教育、文化、暴力、政治权力、技术和我们关心的几个方面的交互式数据可视化。这些可视化帮助我们理解过去几十年世界是如何以及为什么发生变化的。我对这些丰富的信息很感兴趣，并激发了我更深入的探索。</p><p id="932d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一次快速的谷歌搜索让我找到了 choropleth 地图。地图显示与数据变量相关的彩色、阴影或图案化的划分的地理区域。地理区域可能覆盖整个世界，或者一个国家，州，甚至一个县。有许多工具和软件包可以使用 Python 制作独立的或静态的地图。然而，创建一个动态地图有点棘手，这正是我们将在这个博客中学习的内容。在这个循序渐进的指南中，我们将使用 Python 库和包在<strong class="kd jf"> <em class="la">肥胖成人的比例(1975-2016 年)</em> </strong>上重新创建一个交互式全球合唱团地图-熊猫、<a class="ae kz" href="http://geopandas.org" rel="noopener ugc nofollow" target="_blank">地球熊猫</a>和<a class="ae kz" href="https://bokeh.pydata.org/en/latest/" rel="noopener ugc nofollow" target="_blank"> Bokeh </a>。</p><p id="9e11" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在第一部分，我们将创建一个静态地图，然后在代码的基础上引入交互性。</p><h2 id="4d72" class="lb lc je bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">把密码给我</h2><p id="55a4" class="pw-post-body-paragraph kb kc je kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">整个代码也可以在我的<a class="ae kz" href="https://github.com/CrazyDaffodils/Interactive-Choropleth-Map-Using-Python" rel="noopener ugc nofollow" target="_blank">github.com</a>找到。</p><h2 id="afa0" class="lb lc je bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">下载和安装</h2><p id="26eb" class="pw-post-body-paragraph kb kc je kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">要渲染世界地图，我们需要一个带有世界坐标的 shapefile。<a class="ae kz" href="https://www.naturalearthdata.com" rel="noopener ugc nofollow" target="_blank"> Natural Earth </a>是一个公共领域地图数据集，提供各种分辨率的地理空间数据。对于我们的目的来说，<a class="ae kz" href="https://www.naturalearthdata.com/downloads/110m-cultural-vectors/" rel="noopener ugc nofollow" target="_blank">1–110m 小规模数据</a>已经足够好了。点击绿色按钮<strong class="kd jf"> <em class="la">下载国家 4.1.0 版</em> </strong>下载 shape 文件夹。接下来，进入<a class="ae kz" href="https://ourworldindata.org/obesity" rel="noopener ugc nofollow" target="_blank">我们的数据世界</a>，点击图表上的数据选项卡，下载定义为肥胖的成年人份额. csv。或者，也可以从我的<a class="ae kz" href="https://github.com/CrazyDaffodils/Interactive-Choropleth-Map-Using-Python" rel="noopener ugc nofollow" target="_blank"> github </a>库下载文件。安装 Geopandas 和 Bokeh。</p><h2 id="6ae6" class="lb lc je bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">探索熊猫和地理熊猫数据框</h2><p id="538c" class="pw-post-body-paragraph kb kc je kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">导入 geopandas。Geopandas 可以使用返回地理数据框架对象的<code class="fe lz ma mb mc b">read_file</code>命令读取几乎任何基于矢量的空间数据格式，包括 ESRI shapefile。shapefile 由许多列组成，其中只有 3 列是我们感兴趣的。为了便于参考，对列进行了重命名。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="6244" class="lb lc je mc b gy ml mm l mn mo">import geopandas as gpd</span><span id="f3e1" class="lb lc je mc b gy mp mm l mn mo">shapefile = 'data/countries_110m/ne_110m_admin_0_countries.shp'</span><span id="91a1" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Read shapefile using Geopandas<br/></em>gdf = gpd.read_file(shapefile)[['ADMIN', 'ADM0_A3', 'geometry']]</span><span id="984c" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Rename columns.</em><br/>gdf.columns = ['country', 'country_code', 'geometry']<br/>gdf.head()</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mq"><img src="../Images/6315d9322cfc547187f4af0be4bd0e60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RSev-aqVvnUCy_1PknLcag.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">Geopandas GeoDataFrame</figcaption></figure><p id="2ef5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们可以删除“南极洲”这一行，因为它在我们的地图上不必要地占据了很大的空间，在我们当前的分析中也不需要。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="2666" class="lb lc je mc b gy ml mm l mn mo">print(gdf[gdf['country'] == 'Antarctica'])</span><span id="5dff" class="lb lc je mc b gy mp mm l mn mo">#<em class="la">Drop row corresponding to 'Antarctica'<br/></em>gdf = gdf.drop(gdf.index[159])</span></pre><p id="cb73" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们进口熊猫并阅读。csv 文件。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="18a4" class="lb lc je mc b gy ml mm l mn mo">import pandas as pd</span><span id="0fea" class="lb lc je mc b gy mp mm l mn mo">datafile = 'data/obesity.csv'</span><span id="48d4" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Read csv file using pandas</em><br/>df = pd.read_csv(datafile, names = ['entity', 'code', 'year', 'per_cent_obesity'], skiprows = 1)</span><span id="7202" class="lb lc je mc b gy mp mm l mn mo">df.head()</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/96048d5131e4e4f93c7e08bdd4a44031.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*OQBfYX1j5DKtNFDlaAkzlw.png"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">Pandas DataFrame</figcaption></figure><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="4abd" class="lb lc je mc b gy ml mm l mn mo">df.info()<br/>df[df['code'].isnull()</span></pre><div class="md me mf mg gt ab cb"><figure class="mw iv mx my mz na nb paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><img src="../Images/37a878710e724d69cfac9a5abc37c8e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*IbGY5VIGjhIYzS9CG_g3aA.png"/></div></figure><figure class="mw iv nc my mz na nb paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><img src="../Images/afa91b98a1325d49a3d934b61db10afc.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*asoozjKbHDR6yyAO0ycHoQ.png"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk nd di ne nf">Investigating missing values in df</figcaption></figure></div><p id="b4fe" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">调查熊猫数据框架显示苏丹缺失值。我们的数据跨度从 1975 年到 2016 年；而苏丹在 2011 年 7 月分裂成两个国家。这导致了新分裂国家的 3 个字母的 ISO 代码的变化。为了简单起见，让我们忽略苏丹缺失的数据。</p><h2 id="8bcb" class="lb lc je bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">2016 年静态 choropleth 地图</h2><p id="795c" class="pw-post-body-paragraph kb kc je kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">让我们首先创建一个表示 2016 年成人肥胖比例的静态地图。这需要从 df 中过滤 2016 年的数据。然后，可以将生成的数据框架 df_2016 合并到地理数据框架 gdf 中。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="c868" class="lb lc je mc b gy ml mm l mn mo"><em class="la">#Filter data for year 2016.</em><br/>df_2016 = df[df['year'] == 2016]</span><span id="1fe6" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Merge dataframes gdf and df_2016.</em><br/>merged = gdf.merge(df_2016, left_on = 'country_code', right_on = 'code')</span></pre><p id="76d5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">合并后的文件是一个 GeoDataframe 对象，可以使用 geopandas 模块进行渲染。然而，由于我们想加入数据可视化的交互性，我们将使用散景库。散景使用 GeoJSON 格式，用 JSON 表示地理要素。GeoJSON 将点、线和多边形(在散景中称为面片)描述为要素的集合。因此，我们将合并后的文件转换为 GeoJSON 格式。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="b293" class="lb lc je mc b gy ml mm l mn mo">import json</span><span id="4bc2" class="lb lc je mc b gy mp mm l mn mo">#<em class="la">Read data to json.</em><br/>merged_json = json.loads(merged.to_json())</span><span id="4e4c" class="lb lc je mc b gy mp mm l mn mo">#<em class="la">Convert to String like object.</em><br/>json_data = json.dumps(merged_json)</span></pre><p id="7ae9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们现在准备使用散景渲染我们的 choropleth 地图。导入所需的模块。代码是内联描述的。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="a2d5" class="lb lc je mc b gy ml mm l mn mo">from bokeh.io import output_notebook, show, output_file<br/>from bokeh.plotting import figure<br/>from bokeh.models import GeoJSONDataSource, LinearColorMapper, ColorBar<br/>from bokeh.palettes import brewer</span><span id="0a64" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Input GeoJSON source that contains features for plotting.</em><br/>geosource = GeoJSONDataSource(geojson = json_data)</span><span id="234e" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Define a sequential multi-hue color palette.</em><br/>palette = brewer['YlGnBu'][8]</span><span id="abd0" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Reverse color order so that dark blue is highest obesity.</em><br/>palette = palette[::-1]</span><span id="3b53" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Instantiate LinearColorMapper that linearly maps numbers in a range, into a sequence of colors.</em><br/>color_mapper = LinearColorMapper(palette = palette, low = 0, high = 40)</span><span id="aab6" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Define custom tick labels for color bar.</em><br/>tick_labels = {'0': '0%', '5': '5%', '10':'10%', '15':'15%', '20':'20%', '25':'25%', '30':'30%','35':'35%', '40': '&gt;40%'}</span><span id="230e" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Create color bar. </em><br/>color_bar = ColorBar(color_mapper=color_mapper, label_standoff=8,width = 500, height = 20,<br/>border_line_color=None,location = (0,0), orientation = 'horizontal', major_label_overrides = tick_labels)</span><span id="8e7f" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Create figure object.</em><br/>p = figure(title = 'Share of adults who are obese, 2016', plot_height = 600 , plot_width = 950, toolbar_location = None)<br/>p.xgrid.grid_line_color = None<br/>p.ygrid.grid_line_color = None</span><span id="7897" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Add patch renderer to figure. </em><br/>p.patches('xs','ys', source = geosource,fill_color = {'field' :'per_cent_obesity', 'transform' : color_mapper},<br/>          line_color = 'black', line_width = 0.25, fill_alpha = 1)</span><span id="6e90" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Specify figure layout.</em><br/>p.add_layout(color_bar, 'below')</span><span id="6dc4" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Display figure inline in Jupyter Notebook.</em><br/>output_notebook()</span><span id="2a7e" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Display figure.</em><br/>show(p)</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ng"><img src="../Images/3f099c48a1e19d47e0ae269513ab5b43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QclVXreJxsnUKbTxZgB_vQ.png"/></div></div></figure><p id="9a8e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">酷！我们的 choropleth 地图已经生成。你可能在这张地图上发现了一个问题。非洲大陆看起来支离破碎；那是因为苏丹、南苏丹、索马里兰不见了。还有，格陵兰在世界地图上不见了。没有画出这些国家的原因是我们的中缺少一个或多个对应于这些国家的值。csv 文件，因此，数据帧 df。让我们解决这个问题，因为它会让一些人反感，这是理所当然的！</p><h2 id="ccd5" class="lb lc je bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">更正缺失的国家</h2><p id="259f" class="pw-post-body-paragraph kb kc je kd b ke lu kg kh ki lv kk kl km lw ko kp kq lx ks kt ku ly kw kx ky im bi translated">我们可以确保缺失的国家被绘制在地图上，并用浅灰色填充，表示缺失的数据。这需要在我们之前的代码中进行一些编辑。</p><p id="867e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了保留合并数据框中缺失的国家，我们执行了左合并/左外连接。因此，地理数据框架 gdf 中的每个国家都会保留在合并的数据框架中，即使熊猫数据框架 df 中缺少相应的行。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="5ee9" class="lb lc je mc b gy ml mm l mn mo">df_2016 = df[df['year'] == 2016]</span><span id="e6db" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Perform left merge to preserve every row in gdf.</em><br/>merged = gdf.merge(df_yr, left_on = 'country_code', right_on = 'code', how = 'left')</span></pre><p id="5f9c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这导致了下图。</p><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ng"><img src="../Images/b14daef540dbaf5de5eafd0dae0cb169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZD4sKPyWfpTwk56AUNQwwA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">Choropleth map for year 2016 (after left merge)</figcaption></figure><p id="c3cf" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以现在我们在地图上看到了之前缺失的国家，但是还有一个问题。新添加的国家按照我们的颜色映射器中的定义进行颜色编码，表示肥胖率在 0–5%的范围内。这具有误导性，因为实际上这些数据是缺失的。理想情况下，我们希望这些国家以中性色显示，如浅灰色，表示缺少数据。我们如何才能做到这一点？</p><p id="d550" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">左合并导致在合并的数据帧中为右数据帧中相应的缺失值添加 NaN 值(df_2016)。当我们将这个合并的数据帧转换成 GeoJSON 格式时，问题就出现了，因为 NaN 不是一个有效的 JSON 对象。为了避免这种情况，我们将把合并数据帧中的所有 NaN 值替换为字符串“No data”。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="f734" class="lb lc je mc b gy ml mm l mn mo">df_2016 = df[df['year'] == 2016]</span><span id="73c0" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Perform left merge to preserve every row in gdf.</em><br/>merged = gdf.merge(df_2016, left_on = 'country_code', right_on = 'code', how = 'left')</span><span id="bd7d" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Replace NaN values to string 'No data'.</em><br/>merged.fillna('No data', inplace = True)</span></pre><p id="2171" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们还将十六进制代码输入到带有“无数据”的颜色代码国家，作为颜色映射器的参数。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="ab50" class="lb lc je mc b gy ml mm l mn mo"><em class="la">#Instantiate LinearColorMapper that maps numbers in a range linearly into a sequence of colors. Input nan_color.</em></span><span id="e603" class="lb lc je mc b gy mp mm l mn mo">color_mapper = LinearColorMapper(palette = palette, low = 0, high = 40, nan_color = '#d9d9d9')</span></pre><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nh"><img src="../Images/3bffae5c9efbdce8dc4f9405e2f97af6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wDqTWfEqR7kFqexs6QQ62A.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">Choropleth map for year 2016 (after left merge and replacing NaNs)</figcaption></figure><p id="c2a9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">太好了！我对我们 2016 年的 choropleth 地图很满意。是时候增加一些互动性了。</p><p id="aea7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我们的可视化中增加交互性使用户能够提取他们感兴趣的信息。我们的目标是创建一个动态地图，根据 1975-2016 年间选择的年份更新数据。我们还将添加一个悬停工具，允许用户只需将鼠标悬停在特定国家/地区上方即可查看详细信息。</p><p id="b96d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Bokeh 提供了大量的小部件和工具，使得创建丰富的交互式可视化变得非常简单。我们将定义一些函数，并重用为创建静态地图而编写的大部分代码。代码是内联描述的。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="f4bc" class="lb lc je mc b gy ml mm l mn mo">from bokeh.io import curdoc, output_notebook<br/>from bokeh.models import Slider, HoverTool<br/>from bokeh.layouts import widgetbox, row, column</span><span id="e1cd" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Define function that returns json_data for year selected by user.</em><br/>    <br/>def json_data(selectedYear):<br/>    yr = selectedYear<br/>    df_yr = df[df['year'] == yr]<br/>    merged = gdf.merge(df_yr, left_on = 'country_code', right_on =     'code', how = 'left')<br/>    merged.fillna('No data', inplace = True)<br/>    merged_json = json.loads(merged.to_json())<br/>    json_data = json.dumps(merged_json)<br/>    return json_data</span><span id="2d0c" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Input GeoJSON source that contains features for plotting.</em><br/>geosource = GeoJSONDataSource(geojson = json_data(2016))</span><span id="4bcf" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Define a sequential multi-hue color palette.</em><br/>palette = brewer['YlGnBu'][8]</span><span id="cc27" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Reverse color order so that dark blue is highest obesity.</em><br/>palette = palette[::-1]</span><span id="c71f" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Instantiate LinearColorMapper that linearly maps numbers in a range, into a sequence of colors. Input nan_color.</em><br/>color_mapper = LinearColorMapper(palette = palette, low = 0, high = 40, nan_color = '#d9d9d9')</span><span id="edb4" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Define custom tick labels for color bar.</em><br/>tick_labels = {'0': '0%', '5': '5%', '10':'10%', '15':'15%', '20':'20%', '25':'25%', '30':'30%','35':'35%', '40': '&gt;40%'}</span><span id="fe23" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Add hover tool</em><br/>hover = HoverTool(tooltips = [ ('Country/region','<a class="ae kz" href="http://twitter.com/country" rel="noopener ugc nofollow" target="_blank">@country</a>'),('% obesity', '@per_cent_obesity')])</span><span id="4f7f" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Create color bar.</em> <br/>color_bar = ColorBar(color_mapper=color_mapper, label_standoff=8,width = 500, height = 20,<br/>                     border_line_color=None,location = (0,0), orientation = 'horizontal', major_label_overrides = tick_labels)</span><span id="fa9c" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Create figure object.</em><br/>p = figure(title = 'Share of adults who are obese, 2016', plot_height = 600 , plot_width = 950, toolbar_location = None, tools = [hover])<br/>p.xgrid.grid_line_color = None<br/>p.ygrid.grid_line_color = None</span><span id="bb09" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Add patch renderer to figure.</em> <br/>p.patches('xs','ys', source = geosource,fill_color = {'field' :'per_cent_obesity', 'transform' : color_mapper},<br/>          line_color = 'black', line_width = 0.25, fill_alpha = 1)</span><span id="858a" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Specify layout</em><br/>p.add_layout(color_bar, 'below')</span><span id="9a81" class="lb lc je mc b gy mp mm l mn mo"><em class="la"># Define the callback function: update_plot</em></span><span id="c7da" class="lb lc je mc b gy mp mm l mn mo">def update_plot(attr, old, new):<br/>    yr = slider.value<br/>    new_data = json_data(yr)<br/>    geosource.geojson = new_data<br/>    p.title.text = 'Share of adults who are obese, %d' %yr<br/>    <br/><em class="la"># Make a slider object: slider </em><br/>slider = Slider(title = 'Year',start = 1975, end = 2016, step = 1, value = 2016)<br/>slider.on_change('value', update_plot)</span><span id="87ce" class="lb lc je mc b gy mp mm l mn mo"><em class="la"># Make a column layout of widgetbox(slider) and plot, and add it to the current document</em><br/>layout = column(p,widgetbox(slider))<br/>curdoc().add_root(layout)</span><span id="123f" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Display plot inline in Jupyter notebook</em><br/>output_notebook()</span><span id="31c1" class="lb lc je mc b gy mp mm l mn mo"><em class="la">#Display plot</em><br/>show(layout)</span></pre><p id="25a3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">厉害！我们已经成功地为肥胖的成年人重新创建了交互式 choropleth 地图。请注意，当您更改 Jupyter 笔记本中的滑块值时，图不会更新。要以交互模式查看此应用程序，您需要设置一个本地散景服务器。在当前目录下打开命令行窗口，执行<code class="fe lz ma mb mc b">bokeh serve --show filename.ipynb</code>命令。</p><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ni"><img src="../Images/ab43701802f730fb3be7a4a6f440337b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Pf8BRyL8qWjKL9WM5g3iA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">Setting up local Bokeh server</figcaption></figure><p id="495a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">单击提示的链接，在浏览器中打开应用程序。我已经插入了一个简短的剪辑，显示了互动模式的应用程序。</p><figure class="md me mf mg gt iv"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">World obesity Interactive Choropleth map</figcaption></figure><p id="4ec7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在数据中的<a class="ae kz" href="https://ourworldindata.org/obesity" rel="noopener ugc nofollow" target="_blank">我们的世界的原始地图上有一些很酷的特征，我无法合并；就像悬停时高亮显示一个国家，悬停在颜色栏上的某个部分时高亮显示所有国家一样。我也搞不清楚与颜色条并列的“无数据”的“浅灰色”段的显示。如果您对我们如何进一步增强应用程序的交互性有任何意见或建议，我很乐意倾听！</a></p></div></div>    
</body>
</html>