<html>
<head>
<title>Calculating New and Returning Customers in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 R 中计算新客户和老客户</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/calculating-new-and-returning-customers-in-r-909518f62264?source=collection_archive---------18-----------------------#2019-05-22">https://towardsdatascience.com/calculating-new-and-returning-customers-in-r-909518f62264?source=collection_archive---------18-----------------------#2019-05-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8469" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近遇到一个问题，我想计算新客户和老客户。所以，我很自然地谷歌了一下，惊讶地发现我在 R 中找不到任何关于它的解决方案，这通常是大多数 R 博客/教程的问题，它们不是非常面向商业的。</p><p id="f75d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于在网上找不到解决方案，我开始自己动手。我能够使用 DAX 和 Power Pivot 在 Excel 和 Power BI 中很快找到解决方案，但我想在 r 中完成它。实际上，我有点不好意思承认这个解决方案非常简单。我期望你对 R 中的<strong class="js iu"> Tidyverse </strong>包有一些基本的了解，主要是<strong class="js iu"> dplyr </strong>来理解本教程。</p><p id="0d66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在继续之前，我们首先需要决定如何定义一个客户是“新客户”还是“回头客”</p><h2 id="ca8d" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">新客户</h2><p id="f64b" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">任何过去没有与我们合作过的客户都将被归类为“新客户”</p><h2 id="e78b" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">回头客</h2><p id="1b8b" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">任何过去与我们合作过的客户，如果在当前期间再次与我们合作，都被视为“回头客”</p><h2 id="c3ef" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">加载库</h2><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="77c7" class="ko kp it lr b gy lv lw l lx ly">library(tidyverse)# For data manipulation<br/>library(readxl) # Read in Excel File<br/>library(lubridate)# Working with Dates</span></pre><h2 id="bb15" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">加载和查看数据</h2><p id="62e1" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">我们使用下面的代码读入销售数据，并查看一下数据类型。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="6a03" class="ko kp it lr b gy lv lw l lx ly"><strong class="lr iu">sales_data</strong> &lt;- read_xlsx(path="C:\\Users\\ACER\\Downloads\\sale_data.xlsx")</span><span id="826e" class="ko kp it lr b gy lz lw l lx ly">glimpse(sales_data)</span></pre><p id="2d4e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们得到以下输出。销售日期显示为日期时间变量，而客户 ID 被识别为数字类型。</p><figure class="lm ln lo lp gt mb gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/5a5ad436692589633590da21d7634bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*DtbZ_Ydfygk7RoyQOa4OJg.png"/></div></figure><p id="96ed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们现在将使用 dplyr 中的 mutate 函数将“销售日期”和“客户 ID”列分别更改为日期和字符类型。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="3550" class="ko kp it lr b gy lv lw l lx ly"><strong class="lr iu">sales_data</strong> &lt;- sales_data%&gt;%<br/> mutate(`Sale Date` = dmy(`Sale Date`),<br/>        `Customer ID`=as.character(`Customer ID`))</span></pre><p id="22f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们的数据已经准备好了，我们要做的第一件事就是计算每一行中每个客户的首次签约日期。这将决定他们在那个时间点是新客户还是回头客。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="d9fa" class="ko kp it lr b gy lv lw l lx ly"><strong class="lr iu">sales_data</strong> &lt;- sales_data %&gt;%<br/>group_by(`Customer ID`)%&gt;%<br/>mutate(date_of_first_engagement=min(`Sale Date`))%&gt;%<br/>ungroup()</span></pre><p id="663a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于我们想计算每一行中每个客户的第一次接洽日期，我们将首先按“客户 ID”对数据进行分组，然后使用<strong class="js iu"> mutate </strong>函数计算他们在“销售日期”使用<strong class="js iu"> min </strong>函数与我们第一次接洽的时间。这基本上是在 r 中计算条件计算列的一种非常有用的方法。<br/>一旦计算完成，我们将取消对它的分组，因为我们不想要任何基于“客户 ID”的进一步计算。下面是我们的数据集在计算完成后的样子</p><figure class="lm ln lo lp gt mb gh gi paragraph-image"><div class="gh gi me"><img src="../Images/93537afc949da846252b3179032a4a4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*MjSCHVdUvdWxvIXeYRIjFw.png"/></div></figure><p id="2b19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在第 10 行，客户“39099”于 2018 年 9 月 17 日与我们合作，但我们可以看到，他们与我们的首次合作日期是 2018 年 8 月 9 日，这意味着在 9 月 17 日，该客户是“回头客”，而在 8 月 9 日，他们是“新客户”。</p><p id="cc21" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用这个逻辑，我们现在将创建一个新列——“客户状态”。我们将使用<strong class="js iu"> case_when </strong>函数，根据“销售日期”和“首次接洽日期”的差异，在每个时间点对每个客户进行分类</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="68e5" class="ko kp it lr b gy lv lw l lx ly"><strong class="lr iu">sales_data</strong> &lt;- sales_data%&gt;%<br/> mutate(Customer_Status = case_when(`Date Interviewed`&gt;date_of_first_engagement ~ "Returning",<br/>`Date Interviewed` == date_of_first_engagement ~ "New",<br/> TRUE ~ "Other"))</span></pre><p id="b2ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">基本上，我们所做的是计算如果客户的“销售日期”大于客户的第一次合作日期，那么这意味着他们以前与我们合作过，因此是“回头客”，如果他们的“销售日期”等于他们的第一次合作日期，那么这意味着这是他们第一次与我们合作，因此在那个时间点上是“新客户”。以下是数据集的外观。</p><figure class="lm ln lo lp gt mb gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/8b7820a3a01998c15c737a4eee30788d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*z5QNtK83wUcukoPcrTmLng.png"/></div></figure><p id="625e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的数据终于准备好了！现在我们可以对它做一些有趣的分析。我想看看我们每个月有多少“新”和“回头客”。我们将使用<strong class="js iu"> group by </strong>和<strong class="js iu">summary</strong>函数来得到这个结果</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="1e19" class="ko kp it lr b gy lv lw l lx ly"><strong class="lr iu">New_and_Returning_Customers</strong> &lt;-  sales_data%&gt;%<br/>group_by(floor_date(`Sale Date`,unit = 'month'))%&gt;%<br/>summarise<br/>(New_Customers = n_distinct(`Customer ID`[Customer_Status=="New"]),</span><span id="28e2" class="ko kp it lr b gy lz lw l lx ly">Returning_Customers= n_distinct(`Customer ID`[Customer_Status=="Returning"]))</span></pre><p id="a7e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为我想按月分组，所以我使用 lubridate 包中的<strong class="js iu"> floor_date </strong>函数将“销售日期”四舍五入到最近的月份，然后使用条件非重复计数来获得每月新老客户的唯一计数。</p><figure class="lm ln lo lp gt mb gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/8cfb4be5593c95d3a73fa8010da13f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*Bkf-A5LiqUzLTfbYCxYrww.png"/></div></figure><figure class="lm ln lo lp gt mb gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/980649eec576e8308fe8113a4c003b91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*rcyMRnwIS-e-Ce3Zh73LsA.png"/></div></figure><p id="2791" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以使用<strong class="js iu"> ggplot2 </strong>包来制作一个简单的数据折线图</p><h1 id="ff50" class="mi kp it bd kq mj mk ml kt mm mn mo kw mp mq mr kz ms mt mu lc mv mw mx lf my bi translated">结论</h1><p id="1de5" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">现在我们已经了解了如何计算新客户和老客户，我们可以对他们进行各种分析。本教程的目的是让你了解如何以一种相对简单明了的方式进行计算。</p></div></div>    
</body>
</html>