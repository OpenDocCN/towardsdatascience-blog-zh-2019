<html>
<head>
<title>Base R Scripting Excercise : Converting a RIS file to a well-formed XML document.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Base R 脚本练习:将 RIS 文件转换为格式良好的 XML 文档。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/base-r-scripting-excercise-converting-a-ris-file-to-a-well-formed-xml-document-ddda70a96b3?source=collection_archive---------24-----------------------#2019-06-12">https://towardsdatascience.com/base-r-scripting-excercise-converting-a-ris-file-to-a-well-formed-xml-document-ddda70a96b3?source=collection_archive---------24-----------------------#2019-06-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="27be" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="1d54" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这篇文章的目的是分享我遇到的一个脚本问题。我没有太多应对这类挑战的经验，所以我认为这是一个分享和寻求反馈的好机会。</p><h2 id="f1f4" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated"><strong class="ak">挑战</strong></h2><p id="0cf4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">编写一个脚本，将任何。RIS 文件转换成格式良好的 XML 文档。</p><ul class=""><li id="178b" class="lv lw iq kn b ko lx ks ly kw lz la ma le mb li mc md me mf bi translated">包括假设和详细注释。</li><li id="98c2" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">该脚本不得有任何基础语言之外的依赖。</li><li id="9185" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">该脚本应该能够防止意外误用。</li><li id="29e9" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">每条记录都应该放在一个文章标签中。</li></ul><p id="ffc6" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">虽然我知道其他语言可能更适合这些类型的过程，但我还是选择用 R 编写脚本来探索这个过程。</p><h1 id="2225" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">第一部分-理解。RIS 和。XML 格式</h1><h2 id="5b54" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated">RIS(研究信息系统)</h2><p id="0ec3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">ris 文件格式是一种标记格式，是为标准化书目信息而创建的。例如，生命科学和生物医学信息的免费书目数据库 MEDLINE 使用 ris 格式进行引用。</p><p id="5f45" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">让我们看看它是什么样子的:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mo"><img src="../Images/c11a85d0b72bacec863a53cb30e77604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M8Mygb_NuZ-QMkKHEvnpDg.png"/></div></div></figure><p id="a5f1" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">如你所见，基本结构是:每一行包含一个标记和一个用“-”分隔的值。每个 RIS 记录以“TY”标签(引用类型)开始，以 ER 标签(引用结束)结束。<a class="ae na" href="https://en.wikipedia.org/wiki/RIS_(file_format)" rel="noopener ugc nofollow" target="_blank">这里有更多关于 ris 格式的信息。</a></p><p id="9e8f" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated"><strong class="kn ir"> XML(扩展标记语言)</strong></p><p id="eea8" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">XML 本质上就像任何其他标记语言(HTML)一样，通过使用<tags> </tags>来注释文档。然而，XML 是可扩展的，这意味着用户可以创建他/她自己的标签(也就是说，你可以用<blog title="">代替<h1>)。这显示了 XML 的主要优势。标签可以更好地描述它们所包含的信息。当试图做除了在 web 浏览器中显示该信息之外的任何事情时，这是有利的。由于其简单性和标准化，XML 在数据交换和存储方面也很流行。这里有更多关于 XML 的内容。</h1></blog></p><p id="3af0" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">让我们快速看一个例子:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nb"><img src="../Images/52ef0f9e9ba96b2072905907b4b2408a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-zJbaYd2Gpjf2bph7kjJSw.png"/></div></div></figure><p id="2606" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">现在让我们来看看格式约束，这样我就可以确保文件的格式正确。这些是主要的限制因素:</p><ul class=""><li id="41a5" class="lv lw iq kn b ko lx ks ly kw lz la ma le mb li mc md me mf bi translated">XML 文档可以以 XML 声明开始(即<?xml version=”1.0" encoding=”UTF-8"??>)</li><li id="9665" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">任何特殊字符(“&lt;&gt; &amp;”)都不能出现，除非是在执行其角色时。</li><li id="fe79" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">开始标签、结束标签被正确地嵌套</li><li id="6cd2" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">标记名区分大小写；开始标记和结束标记必须完全匹配。</li><li id="09a5" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">标记名不能包含任何字符！"#$%&amp;'()*+,/;&lt;=&gt;？@[\]^`{|}~，也不是空格字符，不能以“-”、“”开头或一个数字。</li><li id="2b41" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">单个根元素包含所有其他元素。</li></ul><p id="0dba" class="pw-post-body-paragraph kl km iq kn b ko lx kq kr ks ly ku kv kw ml ky kz la mm lc ld le mn lg lh li ij bi translated">更多关于结构良好的 XML 文档<a class="ae na" href="https://en.wikipedia.org/wiki/XML" rel="noopener ugc nofollow" target="_blank">和约束</a>的信息。</p><h1 id="2a10" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">第二部分-剧本</h1><p id="d61e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">假设:</strong><br/>RIS 文件遵循标准 RIS 标签格式，包括:</p><ul class=""><li id="1933" class="lv lw iq kn b ko lx ks ly kw lz la ma le mb li mc md me mf bi translated">每张 RIS 唱片都以“唱片结束”标签结尾:“呃-”</li><li id="f96e" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">每个 RIS 标签和值由“-”分隔</li><li id="a50b" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">每个 RIS 标签和值都在各自的行上</li></ul><pre class="mp mq mr ms gt nc nd ne nf aw ng bi"><span id="4250" class="lj jo iq nd b gy nh ni l nj nk"># naming function and function arguments</span><span id="2f9c" class="lj jo iq nd b gy nl ni l nj nk">ris2xml &lt;- function(x = "", root = "root_element", save = FALSE, file_name = "new_file"){</span><span id="0487" class="lj jo iq nd b gy nl ni l nj nk"># read lines<br/>  ris2 &lt;- readLines(x, encoding = "UTF-8")</span><span id="1699" class="lj jo iq nd b gy nl ni l nj nk"># seperating articles<br/>  df &lt;- data.frame(article = NA, ris = ris2, stringsAsFactors = FALSE)<br/>  end_of_records &lt;- rev(grep(pattern = '^ER  -', ris2))<br/>  article = length(end_of_records)<br/>  for(i in end_of_records){<br/>    df$article[1:i] &lt;- article<br/>    article = article - 1<br/>  }</span><span id="68cf" class="lj jo iq nd b gy nl ni l nj nk"># removing ER lines and empty Lines<br/>  df &lt;- df[-end_of_records,]<br/>  df &lt;- df[grep(pattern = '\\S', df$ris ),]</span><span id="853a" class="lj jo iq nd b gy nl ni l nj nk"># splitting tags and values<br/>  split &lt;- strsplit(df$ris, split = "  -")<br/>  df$tags &lt;- sapply(split, "[[", 1)<br/>  df$values &lt;- sapply(split, "[[", 2)</span><span id="2e00" class="lj jo iq nd b gy nl ni l nj nk"># trim any extra white space<br/>  df$tags &lt;- trimws(df$tags, which = "both")<br/>  df$values &lt;- trimws(df$values, which = "both")<br/>  <br/># xml special character restraints<br/>  df$values &lt;- gsub('&lt;', '&amp;lt;', df$values)<br/>  df$values &lt;- gsub('&gt;', '&amp;gt;', df$values)<br/>  df$values &lt;- gsub('&amp;', '&amp;amp;', df$values)<br/>  df$values &lt;- gsub("'", '&amp;apos;', df$values)<br/>  df$values &lt;- gsub('"', '&amp;quot;', df$values)</span><span id="cf40" class="lj jo iq nd b gy nl ni l nj nk">######## Function for finishing steps after tag constraints #########<br/>  finish &lt;- function(){<br/>    # putting values in tags<br/>    for(i in 1:nrow(df)){<br/>      df$tagged[i] &lt;- paste0('&lt;', df$tags[i], '&gt;', df$value[i], '&lt;/', df$tags[i], '&gt;', collapse = "" )<br/>    }</span><span id="8566" class="lj jo iq nd b gy nl ni l nj nk"># adding article tags and I2E tag<br/>    document &lt;- data.frame(article= unique(df$article), body = NA)</span><span id="5a93" class="lj jo iq nd b gy nl ni l nj nk"># article tags<br/>    for(i in document$article){<br/>      vect &lt;- unlist(df[df$article == i, "tagged"])<br/>      temp &lt;-  paste0(vect, collapse = "")<br/>      document[document$article == i, "body"] &lt;- paste0("&lt;Article&gt;", temp, '&lt;/Article&gt;', collapse = "")<br/>    }</span><span id="b2ca" class="lj jo iq nd b gy nl ni l nj nk"># adding root tag &amp; xml tag<br/>    body &lt;- paste0(document$body, collapse = "")<br/>    document_final &lt;- paste0('&lt;?xml version="1.0"?&gt;','&lt;', root, '&gt;',body,'&lt;/', root ,'&gt;', collapse = "")<br/>    <br/>    # return xml document<br/>    return(document_final)<br/>    # save file if user chose to<br/>    if(save == TRUE){<br/>      write(document_final, file = paste0(file_name, ".xml"))<br/>    }<br/>  }<br/>######################################################################<br/># Enforcing XML tag constraints</span><span id="0b08" class="lj jo iq nd b gy nl ni l nj nk">#finding invalid tags<br/>invalid &lt;- grep("[\\[\\!\"#\\$%&amp;'\\(\\)\\*\\+,/;&lt;=&gt;\\?@\\[\\\\\\]\\^`\\{\\|\\}~]|(^\\d)|(^-)|(^\\.)", df$tags, perl = TRUE)</span><span id="3aaa" class="lj jo iq nd b gy nl ni l nj nk"># if there are invalid tags: print warning and print the invalid tags<br/>  <br/>if(length(invalid) &gt; 0){<br/>    print('WARNING: there may be invalid tag names. please check to make sure the tags follow the xml constraints')<br/>    print("The following tags are invalid: ")<br/>    print(df$tags[invalid])</span><span id="502a" class="lj jo iq nd b gy nl ni l nj nk"># give the user the option to re-write the tags<br/>    re_write &lt;- readline(prompt = "to re-write these tags please do so in order and seperated by a comma: ")<br/>    re_write &lt;- unlist(strsplit(x = re_write, split = ","))<br/>    re_write &lt;- trimws(re_write, which = "both")</span><span id="632f" class="lj jo iq nd b gy nl ni l nj nk"># check user inputs for validity<br/>    re_invalid &lt;- grep("[\\[\\!\"#\\$%&amp;'\\(\\)\\*\\+,/;&lt;=&gt;\\?@\\[\\\\\\]\\^`\\{\\|\\}~]|(^\\d)|(^-)|(^\\.)", re_write, perl = TRUE)</span><span id="a159" class="lj jo iq nd b gy nl ni l nj nk"># make sure the number of inputs match &amp; inputs meet contsraints before finishing script<br/>    if((length(re_write) == length(invalid)) &amp; (length(re_invalid) == 0)){<br/>      df[invalid, "tags"] &lt;- re_write<br/>    # constraints are met so finish script<br/>    finish()<br/>    # if contsraints not met, print error and exit.<br/>    }else{<br/>        print("Error: re-writing tags not valid. Please try function again")<br/>    }<br/>  }else{<br/>  # constraints are met so finish script<br/>  finish()<br/>  }</span><span id="e6cf" class="lj jo iq nd b gy nl ni l nj nk">}</span></pre><h2 id="8ed1" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated">参数:</h2><ul class=""><li id="5d8b" class="lv lw iq kn b ko kp ks kt kw nm la nn le no li mc md me mf bi translated">x = " ":要转换的文件</li><li id="9f51" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">root = "root_element ":将保存文档其余部分的根标签</li><li id="f1d7" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">save = FALSE : T/F 如果用户想要保存转换后的文件。</li><li id="65ed" class="lv lw iq kn b ko mg ks mh kw mi la mj le mk li mc md me mf bi translated">file_name = "new_file ":保存转换后文件的文件名。</li></ul><h2 id="6100" class="lj jo iq bd jp lk ll dn jt lm ln dp jx kw lo lp kb la lq lr kf le ls lt kj lu bi translated">结论</h2><p id="4513" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">仅此而已。至于测试，我通过一些 xml 验证器运行输出文件，并在 R 中使用一些 XML 解析器来确保格式正确。我已经能想到我还可以增加几个步骤，比如在继续之前检查 RIS 的文件以确保它符合假设。我知道这个脚本远非完美，但这是一种我从未有过的用 R 工作的有趣方式。我喜欢听想法！感谢阅读。</p></div></div>    
</body>
</html>