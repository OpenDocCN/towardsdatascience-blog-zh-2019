<html>
<head>
<title>Put data to Amazon Kinesis Firehose delivery stream using Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Spring Boot 将数据放入亚马逊 Kinesis 消防水管交付流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/put-data-to-amazon-kinesis-firehose-delivery-stream-using-spring-boot-6098f3e70d54?source=collection_archive---------14-----------------------#2019-09-26">https://towardsdatascience.com/put-data-to-amazon-kinesis-firehose-delivery-stream-using-spring-boot-6098f3e70d54?source=collection_archive---------14-----------------------#2019-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="e12a" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">最初发表于<a class="ae kp" href="https://blog.contactsunny.com/tech/put-data-to-amazon-kinesis-firehose-delivery-stream-using-spring-boot" rel="noopener ugc nofollow" target="_blank">我的个人博客</a>。</p></blockquote><p id="c521" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如果你处理需要收集、转换和分析的大数据流，你肯定会听说过亚马逊 Kinesis Firehose。它是一种 AWS 服务，用于将数据流加载到数据湖或分析工具，以及压缩、转换或加密数据。</p><p id="6bf5" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">你可以使用 Firehose 将流数据加载到 S3 或红移中。从那里，您可以使用 SQL 查询引擎，如<a class="ae kp" href="https://blog.contactsunny.com/tag/amazon-athena" rel="noopener ugc nofollow" target="_blank"> Amazon Athena </a>来查询这些数据。您甚至可以将这些数据连接到您的 BI 工具，并获得数据的实时分析。这在需要实时数据分析的应用中非常有用。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/79c71d150f78d5795e3066449a848fc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GYVsBwGCKCR01VuzPjCmEA.jpeg"/></div></div></figure><p id="d6f7" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">在这篇文章中，我们将看到如何在 Kinesis Firehose 中创建一个<em class="js">交付流</em>，并编写一段简单的 Java 代码将记录(生成数据)放入这个交付流。我们将设置 Kinesis Firehose 将传入的数据保存到亚马逊 S3 的一个文件夹中，该文件夹可以添加到一个管道中，您可以使用 Athena 查询它。仔细想想，当事情失去控制时，你真的会使你的管道变得复杂，并在将来遭受损失。建议在项目的架构阶段后退一步，分析所有管道可能导致瓶颈的地方。的确，大多数 AWS 服务都是完全托管和自动扩展的。但是，控制您的架构并以这样一种方式设计它，使管道不会成为您项目中最薄弱的结构，这不会有什么坏处。不管怎样，我们继续吧。</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="e86a" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">在 Kinesis Firehose 中创建交付流</h1><p id="cf1b" class="pw-post-body-paragraph jq jr iq jt b ju mk jw jx jy ml ka kb kq mm ke kf kr mn ki kj ks mo km kn ko ij bi translated">要开始向 Kinesis Firehose 交付流发送消息，我们首先需要创建一个。为此，让我们登录 AWS 控制台，并前往 Kinesis 服务。您应该会在 Kinesis 主页上看到一个创建新的消防软管交付流的按钮。希望你找到了那个按钮。创建交付流包括四个步骤。让我们一个接一个地看看它们:</p><p id="da2b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated"><strong class="jt ir">第一步:名称和来源</strong></p><p id="122d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">这里，我们指定了流的名称，以及流如何获取数据，这是源部分。为该流选择一个名称。该页面应该类似于下面的截图:</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mp"><img src="../Images/3b11959cbef2fb7647892503907e7df4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-KftZJouVm2LDOJf1psfdQ.png"/></div></div></figure><p id="5691" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">接下来，我们必须指定这个流的数据源。有两种方法可以将数据放入流中:</p><ul class=""><li id="b305" class="mq mr iq jt b ju jv jy jz kq ms kr mt ks mu ko mv mw mx my bi translated">使用 AWS 提供的 Put data APIs，它可以集成到您的应用程序中，直接向流发送数据。</li><li id="10ea" class="mq mr iq jt b ju mz jy na kq nb kr nc ks nd ko mv mw mx my bi translated">从另一个数据流传输数据。</li></ul><p id="e749" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">在这个例子中，我们将使用第一个选项，直接看跌期权或其他来源。选择此选项，然后单击页面底部的“下一步”进入第二步。</p><p id="ef5e" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated"><strong class="jt ir">第二步:流程记录</strong></p><p id="c4e9" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">Kinesis Firehose 的众多功能之一是，它可以在将传入数据发送到目的地之前对其进行转换。在第二步中，我们可以告诉 Kinesis 它与这个流的传入数据有什么关系。现在，我们将保持一切默认。这意味着没有任何形式的转换，也没有数据格式的转换。理想情况下，您会希望将数据转换为 Parquet 格式，这样既可以压缩数据，又可以提高处理效率。保持这两个配置处于禁用状态，然后单击页面底部的 Next 按钮。</p><p id="50aa" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated"><strong class="jt ir">第三步:选择目的地</strong></p><p id="3e30" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">既然我们已经配置了 Firehose 来获取数据，现在我们必须告诉它将数据发送到哪里。有四个选项:</p><ol class=""><li id="a2d7" class="mq mr iq jt b ju jv jy jz kq ms kr mt ks mu ko ne mw mx my bi translated">亚马逊 S3</li><li id="d51f" class="mq mr iq jt b ju mz jy na kq nb kr nc ks nd ko ne mw mx my bi translated">亚马逊红移</li><li id="3cbd" class="mq mr iq jt b ju mz jy na kq nb kr nc ks nd ko ne mw mx my bi translated">亚马逊弹性搜索服务</li><li id="92f2" class="mq mr iq jt b ju mz jy na kq nb kr nc ks nd ko ne mw mx my bi translated">Splunk</li></ol><p id="be3f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">每个目标都有自己配置。因为我们现在并不真正担心其他任何事情，只是想将数据发送到 Firehose，所以我们将数据保存到 S3，这也是默认选项。</p><p id="3a06" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">向下滚动，您会发现提供一个 S3 存储桶来存储数据的选项。您可以选择现有的存储桶，也可以创建新的存储桶。</p><p id="fe56" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">接下来，我们有前缀选项。所以 Firehose 写给 S3 的任何东西都会被默认分区，格式为“YYYY/MM/DD/HH”(UTC)。您当然可以覆盖它，但是您的前缀中必须至少有一个时间戳。如果你没有提供一个带有时间戳的前缀，Firehose 会自动添加一个，因为这是强制的。此外，您不能添加一部分传入数据作为前缀。所以不要打算这样设计。现在，让它为空或者给出一个随机的字符串。</p><p id="7c0a" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">类似地，你也可以给错误一个前缀。我会让它暂时为空，因为这只是一个概念验证。单击页面底部的“下一步”按钮。我们将进入流程的下一步。</p><p id="0ced" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated"><strong class="jt ir">第四步:配置设置</strong></p><p id="27b4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">在这一步中，我们将为我们数据在 S3 中的存储方式指定一些重要的配置。我将对每一项进行解释，但我建议在此 POC 中保留它们的默认设置。</p><p id="c87b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">首先，我们有缓冲条件。这里有两个配置，缓冲区大小和缓冲区间隔。Kinesis Firehose 在将传入数据写入 S3 之前对其进行缓冲。将收到的每一条信息写给 S3 将会非常昂贵。因此数据被缓冲并批量写入 S3。您可以指定缓冲区大小，例如 5MB，以及缓冲区间隔，例如 300 秒。所以无论哪个先发生都会被考虑。例如，如果缓冲区在短短 10 秒内达到 5MB 的大小限制，数据将被写入 S3，缓冲区将被清除。此外，如果数据还不到 5MB，但自上次写入以来已经过了 300 秒，则缓冲区中的任何数据都将被写入 S3，缓冲区将被清除。</p><p id="4e2a" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">接下来，我们可以选择在 S3 压缩和加密数据。我们可以使用压缩算法，如 GZIP 和 SNAPPY 来压缩数据。当我们处理千兆字节的数据时，会考虑到这一点。对于此 POC，请将其禁用。我们现在也不需要任何加密。</p><p id="4dfd" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如果有必要，我们可以启用错误日志。或许还可以添加一些标签。但是我不认为他们中的任何一个需要这个概念验证。所以让我们直接翻到这一页的底部。</p><p id="8839" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">这里，我们需要指定一个 IAM 角色，该角色有权向 S3 写入数据。Kinesis Firehose 将使用这个 IAM 角色将传入数据写入 S3。您可以选择现有的 IAM 角色，也可以创建新的 IAM 角色。选择此项后，单击页面底部的“下一步”按钮。</p><p id="a79d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">您现在应该已经创建了交付流。我们已经完成了流的创建。我们可以转到 Java 代码，我们将使用它向这个流发送数据。</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="3a97" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Java 代码</h1><p id="e345" class="pw-post-body-paragraph jq jr iq jt b ju mk jw jx jy ml ka kb kq mm ke kf kr mn ki kj ks mo km kn ko ij bi translated">在我们进入代码之前，像往常一样，让我们看一下我们需要的依赖项。我为此创建了一个 Maven 项目。所以我有一个<em class="js"> pom.xml </em>文件用于依赖管理。我已经列出了我在这里使用的所有依赖项:</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="be92" class="nk ln iq ng b gy nl nm l nn no">&lt;dependencies&gt;</span><span id="901a" class="nk ln iq ng b gy np nm l nn no">    &lt;dependency&gt;<br/>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;<br/>    &lt;/dependency&gt;<br/>    &lt;dependency&gt;<br/>        &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;<br/>        &lt;artifactId&gt;aws-java-sdk&lt;/artifactId&gt;<br/>        &lt;version&gt;1.11.627&lt;/version&gt;<br/>    &lt;/dependency&gt;<br/>    &lt;dependency&gt;<br/>        &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;<br/>        &lt;artifactId&gt;amazon-kinesis-client&lt;/artifactId&gt;<br/>        &lt;version&gt;1.11.2&lt;/version&gt;<br/>    &lt;/dependency&gt;<br/>    &lt;dependency&gt;<br/>        &lt;groupId&gt;org.codehaus.jettison&lt;/groupId&gt;<br/>        &lt;artifactId&gt;jettison&lt;/artifactId&gt;<br/>        &lt;version&gt;1.2&lt;/version&gt;<br/>    &lt;/dependency&gt;</span><span id="bd62" class="nk ln iq ng b gy np nm l nn no">&lt;/dependencies&gt;</span></pre><p id="968d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">接下来，使用 AWS SDK，我们需要创建一个<em class="js"> AmazonKinesisFirehose </em>客户端，它将用于将数据或<em class="js">记录</em>放入 Firehose 交付流。为此，我们首先需要创建 AWS 凭证对象。对于这个例子，我使用的是<em class="js"> BasicAWSCredentials </em>类。这意味着，我们必须提供访问密钥和访问秘密。我们将把这些数据保存在<em class="js"> application.properties </em>文件中，这样我们就可以将这些数据放入 Java 代码中，而无需硬编码。因为这是一个 Spring Boot 应用程序，所以我们可以为此使用<em class="js"> @Value() </em>注释:</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="8b7f" class="nk ln iq ng b gy nl nm l nn no">@Value("${aws.auth.accessKey}")<br/>private String awsAccessKey;</span><span id="d8f2" class="nk ln iq ng b gy np nm l nn no">@Value("${aws.auth.secretKey}")<br/>private String awsSecretKey;</span></pre><p id="7ad1" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">使用这两个变量，我们将创建凭证对象和 Firehose 客户端:</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="cf19" class="nk ln iq ng b gy nl nm l nn no">BasicAWSCredentials awsCredentials = new BasicAWSCredentials(awsAccessKey, awsSecretKey);</span><span id="c139" class="nk ln iq ng b gy np nm l nn no">AmazonKinesisFirehose firehoseClient = AmazonKinesisFirehoseClient.builder()<br/>        .withRegion(Regions.US_WEST_2)<br/>        .withCredentials(new AWSStaticCredentialsProvider(awsCredentials))<br/>        .build();</span></pre><p id="0e8d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">请确保您更改了上面代码片段中的区域，以匹配您的 Kinesis 设置。一旦我们创建了这个 Firehose 客户端，我们就可以开始向 Firehose“放记录”了。但是让我们来看看我们将要输入的数据。</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="8bda" class="nk ln iq ng b gy nl nm l nn no">JSONObject messageJson = new JSONObject();<br/>messageJson.put("key1", "We are testing Amazon Kinesis Firehose!");<br/>messageJson.put("integerKey", 123);<br/>messageJson.put("booleanKey", true);<br/>messageJson.put("anotherString", "This should work!");</span><span id="ff1f" class="nk ln iq ng b gy np nm l nn no">logger.info("Message to Firehose: " + messageJson.toString());</span></pre><p id="630d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如您所见，我创建了一个简单的 JSON 对象，它将被序列化，转换成字节，然后发送到 Firehose。在我们实际发送数据之前，我们必须创建一个<em class="js"> PutRecordRequest </em>对象，使用它我们将指定向哪个流发送数据。流名称不是硬编码的，但是我们从<em class="js">application . propertiets</em>文件中获取它，类似于 AWS 凭证:</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="4a4e" class="nk ln iq ng b gy nl nm l nn no">@Value("${aws.kinesis.firehose.deliveryStream.name}")<br/>private String fireHoseDeliveryStreamName;</span></pre><p id="4433" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">我们现在将创建 PutRecordRequest:</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="9a17" class="nk ln iq ng b gy nl nm l nn no">PutRecordRequest putRecordRequest = new PutRecordRequest();<br/>putRecordRequest.setDeliveryStreamName(fireHoseDeliveryStreamName);</span></pre><p id="e841" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">接下来，我们将创建一个<em class="js">记录</em>对象，它将保存将要发送的实际数据。我们将这个记录设置为我们刚刚创建的<em class="js"> putRecordRequest </em>对象，并调用<em class="js">。Firehose 客户端对象上的 putRecord() </em>方法。</p><pre class="ku kv kw kx gt nf ng nh ni aw nj bi"><span id="1fbc" class="nk ln iq ng b gy nl nm l nn no">Record record = new Record().withData(ByteBuffer.wrap(messageJson.toString().getBytes()));<br/>putRecordRequest.setRecord(record);</span><span id="c90a" class="nk ln iq ng b gy np nm l nn no">PutRecordResult putRecordResult = firehoseClient.putRecord(putRecordRequest);</span></pre><p id="1642" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">就是这样。如果您没有从 AWS 客户端得到任何错误，您可以确信您发送的数据将在您的 S3 桶中。去看看。</p><p id="c3f3" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kq kd ke kf kr kh ki kj ks kl km kn ko ij bi translated">如果你对这个例子中完整的 Spring Boot 项目感兴趣，可以去<a class="ae kp" href="https://github.com/contactsunny/SpringBootAmazonKinesisFirehoseProducerPOC" rel="noopener ugc nofollow" target="_blank">我的 Github 库</a>看看，也许可以分支一下？</p><blockquote class="jn jo jp"><p id="dfc6" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">在<a class="ae kp" href="https://twitter.com/contactsunny" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，了解更多<a class="ae kp" href="https://blog.contactsunny.com/tag/data-science" rel="noopener ugc nofollow" target="_blank">数据科学</a>、<a class="ae kp" href="https://blog.contactsunny.com/tag/machine-learning" rel="noopener ugc nofollow" target="_blank">机器学习</a>，以及一般<a class="ae kp" href="https://blog.contactsunny.com/category/tech" rel="noopener ugc nofollow" target="_blank">技术更新</a>。此外，你可以<a class="ae kp" href="https://blog.contactsunny.com/" rel="noopener ugc nofollow" target="_blank">关注我的个人博客</a>，因为我在那里发布了很多我的教程、操作方法帖子和机器学习的优点。</p></blockquote></div></div>    
</body>
</html>