<html>
<head>
<title>Build a Python Crawler to Get Activity Stream with GitHub API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 GitHub API 构建一个 Python 爬虫来获取活动流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-a-python-crawler-to-get-activity-stream-with-github-api-d1e9f5831d88?source=collection_archive---------21-----------------------#2019-11-29">https://towardsdatascience.com/build-a-python-crawler-to-get-activity-stream-with-github-api-d1e9f5831d88?source=collection_archive---------21-----------------------#2019-11-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="faeb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从头做起</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/40074a7ec5666454270a068e40d46ba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*03wdCFj-AFDrD4TQwrNyJg.jpeg"/></div></div></figure><p id="6777" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我之前的文章<a class="ae lq" rel="noopener" target="_blank" href="/download-course-materials-with-a-simple-python-crawler-94e06d5f84b5">用一个简单的 Python 爬虫</a>下载课程资料中，我介绍了一个简单的 Python 爬虫来下载文件。要构建这样一个爬虫，我们必须自己找到文件的模式。但是如果我们想从著名的网站收集数据，比如 Twitter 和 GitHub，事情可能会简单一些。因为通常，这些网站都提供了 API，我们可以直接获取我们想要的数据。在这篇文章中，我将构建一个 Python 爬虫来用 GitHub API 获取活动流。</p><h1 id="ffa3" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">1 个目标</h1><p id="8a0f" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated"><a class="ae lq" href="https://www.wikiwand.com/en/Activity_stream" rel="noopener ugc nofollow" target="_blank">活动流</a>显示用户最近的活动，例如下面显示的是我在 GitHub 中的活动。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/f46a751a04988b7e4b9b136c89e4293f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*10bb5GJw3B_eN8txT9145g.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">activity stream in GitHub</figcaption></figure><p id="9374" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我想得到如下这些活动</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="2ab5" class="my ls it mu b gy mz na l nb nc">ShusenTang starred lyprince/sdtw_pytorch<br/>chizhu starred markus-eberts/spert<br/>Hexagram-King starred BrambleXu/knowledge-graph-learning<br/>Yevgnen starred BrambleXu/knowledge-graph-learning<br/>......</span></pre><h1 id="8844" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">2 用 GitHub API 获取数据</h1><h2 id="90ba" class="my ls it bd lt nd ne dn lx nf ng dp mb ld nh ni md lh nj nk mf ll nl nm mh nn bi translated">2.1 GitHub API</h2><p id="7607" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">首先，我们来看看<a class="ae lq" href="https://developer.github.com/v3/" rel="noopener ugc nofollow" target="_blank"> GitHub API 文档</a>。如果您<strong class="kw iu">没有启用</strong> <a class="ae lq" href="https://help.github.com/en/github/authenticating-to-github/configuring-two-factor-authentication" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">双因素认证</strong> </a>，您可以运行下面的命令来测试 API。输入密码后，您应该会看到响应。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="7be2" class="my ls it mu b gy mz na l nb nc">$ curl -u '&lt;usename&gt;' <a class="ae lq" href="https://api.github.com" rel="noopener ugc nofollow" target="_blank">https://api.github.com</a><br/>Enter host password for user '&lt;usename&gt;': &lt;password&gt;</span><span id="e04f" class="my ls it mu b gy no na l nb nc">{<br/>  "current_user_url": "<a class="ae lq" href="https://api.github.com/user" rel="noopener ugc nofollow" target="_blank">https://api.github.com/user</a>",<br/>  "current_user_authorizations_html_url": "<a class="ae lq" href="https://github.com/settings/connections/applications{/client_id" rel="noopener ugc nofollow" target="_blank">https://github.com/settings/connections/applications{/client_id</a>}",<br/>  "authorizations_url": "<a class="ae lq" href="https://api.github.com/authorizations" rel="noopener ugc nofollow" target="_blank">https://api.github.com/authorizations</a>",<br/> ......</span></pre><p id="6491" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是<strong class="kw iu">如果您已经启用了</strong> <a class="ae lq" href="https://help.github.com/en/github/authenticating-to-github/configuring-two-factor-authentication" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">双因素认证</strong> </a> <strong class="kw iu">，我们需要使用</strong> <a class="ae lq" href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">个人访问令牌</strong> </a> <strong class="kw iu">来进行认证</strong>。按照帮助页面创建个人令牌。至于访问权限/范围，因为我们只想获得活动流，选择<em class="np">通知</em>就足够了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/604548e44c83f2594c44390a0df54b05.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*fSxrOM2Hn1o5ebk6VH1fdw.png"/></div></figure><p id="71de" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果一切顺利，我们现在应该有一个令牌。按照<a class="ae lq" href="https://developer.github.com/v3/#authentication" rel="noopener ugc nofollow" target="_blank">认证指令</a>使用以下命令测试令牌。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="d89b" class="my ls it mu b gy mz na l nb nc">$ curl -H "Authorization: token &lt;TOKEN&gt;" <a class="ae lq" href="https://api.github.com" rel="noopener ugc nofollow" target="_blank">https://api.github.com</a><br/>                    <br/>{<br/>  "current_user_url": "<a class="ae lq" href="https://api.github.com/user" rel="noopener ugc nofollow" target="_blank">https://api.github.com/user</a>",<br/>  "current_user_authorizations_html_url": "<a class="ae lq" href="https://github.com/settings/connections/applications{/client_id" rel="noopener ugc nofollow" target="_blank">https://github.com/settings/connections/applications{/client_id</a>}",<br/>  "authorizations_url": "<a class="ae lq" href="https://api.github.com/authorizations" rel="noopener ugc nofollow" target="_blank">https://api.github.com/authorizations</a>",<br/>  .......</span></pre><h2 id="c51d" class="my ls it bd lt nd ne dn lx nf ng dp mb ld nh ni md lh nj nk mf ll nl nm mh nn bi translated">2.2 获取激活流</h2><p id="0db7" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">在<a class="ae lq" href="https://developer.github.com/v3/auth/#via-oauth-and-personal-access-tokens" rel="noopener ugc nofollow" target="_blank">其他认证方式</a>中，我们可以使用下面的命令直接获取用户数据。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="e66d" class="my ls it mu b gy mz na l nb nc">$ curl -u &lt;usename&gt;:&lt;TOKEN&gt; <a class="ae lq" href="https://api.github.com/user" rel="noopener ugc nofollow" target="_blank">https://api.github.com/user</a></span><span id="1e8f" class="my ls it mu b gy no na l nb nc">{<br/>  "login": "xxxx",<br/>  "id": xxxxx,<br/>  "node_id": "xxxx",<br/>  "avatar_url": "<a class="ae lq" href="https://avatars1.gi" rel="noopener ugc nofollow" target="_blank">x</a>xxx",<br/>  ......</span></pre><p id="033d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们需要浏览 API 文档来找到与活动相关的 API。在右侧的切换列表中，“活动”下有“事件”、“提要”、“通知”。但是我们需要确定哪个适合我们的需求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/97766601355757f456bff917d2fe1205.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kvImhiC1Z3lj2CZjWapmXw.png"/></div></div></figure><p id="2e5b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">浏览文档后，我们可以知道“事件”下的“<a class="ae lq" href="https://developer.github.com/v3/activity/events/#list-events-that-a-user-has-received" rel="noopener ugc nofollow" target="_blank">列出用户收到的</a>的事件是我们需要的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/11c7b12d4b0de438bc3cf8c0a9276561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*6kQNwWQ2QiKywOxil1AHpg.png"/></div></div></figure><p id="fabb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以用这个 API 命令测试<code class="fe nt nu nv mu b">curl</code>命令。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="edc8" class="my ls it mu b gy mz na l nb nc">$ curl -u &lt;usename&gt;:&lt;TOKEN&gt; https://api.github.com/users/&lt;usename&gt;/received_events</span></pre><p id="30aa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这会返回很多消息，所以最好将响应保存为 JSON 文件。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="e2f6" class="my ls it mu b gy mz na l nb nc">$ curl -u &lt;usename&gt;:&lt;TOKEN&gt; https://api.github.com/users/&lt;usename&gt;/received_events &gt; github_stream.json</span></pre><h1 id="291b" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">3 分析 JSON 文件</h1><p id="9ae8" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">我们可以查看 JSON 数据来熟悉格式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/d2d8c71fec295db1d144296f3ea13192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*6PGxKn4R9u1i6S8UArpdMQ.png"/></div></figure><p id="8fe5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">似乎有不同种类的事件类型。我们可以编写一个简单的脚本来获取各种事件类型。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6b02" class="my ls it mu b gy mz na l nb nc">import json</span><span id="649c" class="my ls it mu b gy no na l nb nc">with open('github_stream.json', 'r') as f:<br/>  data_string = f.read() # read object as string<br/>  data = json.loads(data_string) # convert JSON (str, bytes or bytearray) to a Python object</span><span id="004a" class="my ls it mu b gy no na l nb nc"># Get all event types<br/>events = set()<br/>for event in data:<br/>  events.add(event['type'])<br/>print(events)</span><span id="3d8e" class="my ls it mu b gy no na l nb nc"># output<br/>{'IssueCommentEvent', 'ForkEvent', 'PushEvent', 'PullRequestEvent', 'WatchEvent', 'IssuesEvent'}</span></pre><p id="57b1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过比较我们在 GitHub 主页上看到的活动流，我们可以看到只存在三种事件类型，WatchEvent(星号)、ForkEvent(分叉)、PushEvent(推送)。</p><p id="d6e8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以我们只需要从这三种事件类型中获取活动。下面是剧本。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="0ffd" class="my ls it mu b gy mz na l nb nc"># github-api-json-parse.py</span><span id="c715" class="my ls it mu b gy no na l nb nc">import json</span><span id="e8f2" class="my ls it mu b gy no na l nb nc">with open('github_stream.json', 'r') as f:<br/>  data_string = f.read() # read object as string<br/>  data = json.loads(data_string) </span><span id="5cec" class="my ls it mu b gy no na l nb nc">event_actions = {'WatchEvent': 'starred', 'PushEvent': 'pushed to'}</span><span id="7f84" class="my ls it mu b gy no na l nb nc">for event in data:<br/>  if event['type'] in event_actions:<br/>    name = event['actor']['display_login']<br/>    action = event_actions[event['type']] <br/>    repo = event['repo']['name'] <br/>    print('{name} {action} {repo}'.format(name=name, action=action, repo=repo))</span><span id="03d4" class="my ls it mu b gy no na l nb nc">if event['type'] == 'ForkEvent':<br/>    name = event['actor']['display_login']<br/>    repo = event['repo']['name']  <br/>    forked_repo = event['payload']['forkee']['full_name'] <br/>    print('{name} forked {forked_repo} from {repo}'.format(name=name, forked_repo=forked_repo,repo=repo))</span></pre><p id="a658" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">运行脚本，我们可以得到下面的输出。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="3d77" class="my ls it mu b gy mz na l nb nc">ShusenTang starred lyprince/sdtw_pytorch<br/>chizhu starred markus-eberts/spert<br/>Hexagram-King starred BrambleXu/knowledge-graph-learning<br/>icoxfog417 pushed to arXivTimes/arXivTimes<br/>icoxfog417 pushed to arXivTimes/arXivTimes<br/>Yevgnen starred BrambleXu/knowledge-graph-learning<br/>......</span></pre><h1 id="73d2" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">4 实时获取激活流</h1><p id="7597" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">直到现在，我们都可以通过 API 获取 JSON 数据文件，解析 JSON 文件得到活动流。接下来，我们将消除 JSON 文件，直接获得活动流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><blockquote class="nz oa ob"><p id="38a5" class="ku kv np kw b kx ky ju kz la lb jx lc oc le lf lg od li lj lk oe lm ln lo lp im bi translated"><strong class="kw iu"> <em class="it">查看我的其他帖子</em> </strong> <a class="ae lq" href="https://medium.com/@bramblexu" rel="noopener"> <strong class="kw iu"> <em class="it">中等</em> </strong> </a> <strong class="kw iu"> <em class="it">同</em> </strong> <a class="ae lq" href="https://bramblexu.com/posts/eb7bd472/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> <em class="it">一分类查看</em> </strong> </a> <strong class="kw iu"> <em class="it">！<br/>GitHub:</em></strong><a class="ae lq" href="https://github.com/BrambleXu" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"><em class="it">荆棘徐</em> </strong> </a> <strong class="kw iu"> <em class="it"> <br/>领英:</em> </strong> <a class="ae lq" href="https://www.linkedin.com/in/xu-liang-99356891/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> <em class="it">徐亮</em> </strong> </a> <strong class="kw iu"> <em class="it"> <br/>博客:</em></strong><a class="ae lq" href="https://bramblexu.com" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"><em class="it"/></strong></a></p></blockquote><h1 id="68a1" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated"><strong class="ak">参考</strong></h1><ul class=""><li id="4db1" class="of og it kw b kx mj la mk ld oh lh oi ll oj lp ok ol om on bi translated"><a class="ae lq" rel="noopener" target="_blank" href="/download-course-materials-with-a-simple-python-crawler-94e06d5f84b5">用一个简单的 Python 爬虫下载课程资料</a></li><li id="e70e" class="of og it kw b kx oo la op ld oq lh or ll os lp ok ol om on bi translated"><a class="ae lq" href="https://developer.github.com/v3/" rel="noopener ugc nofollow" target="_blank">https://developer.github.com/v3/</a></li><li id="fda8" class="of og it kw b kx oo la op ld oq lh or ll os lp ok ol om on bi translated"><a class="ae lq" href="https://developer.github.com/v3/auth/#via-oauth-and-personal-access-tokens" rel="noopener ugc nofollow" target="_blank">https://developer . github . com/v3/auth/# via-oauth-and-personal-access-tokens</a></li><li id="b732" class="of og it kw b kx oo la op ld oq lh or ll os lp ok ol om on bi translated"><a class="ae lq" href="https://developer.github.com/v3/activity/events/#list-events-that-a-user-has-received" rel="noopener ugc nofollow" target="_blank">https://developer . github . com/v3/activity/events/# list-events-a-user-has-received</a></li></ul></div></div>    
</body>
</html>