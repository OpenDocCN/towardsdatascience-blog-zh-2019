<html>
<head>
<title>ML Design Pattern #2: Checkpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ML 设计模式#2:检查点</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ml-design-pattern-2-checkpoints-e6ca25a4c5fe?source=collection_archive---------18-----------------------#2019-09-27">https://towardsdatascience.com/ml-design-pattern-2-checkpoints-e6ca25a4c5fe?source=collection_archive---------18-----------------------#2019-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="abf0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在训练期间保存模型的中间权重可以提供弹性、泛化和可调性</h2></div><p id="ed34" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">偶尔为 ML 工程师设计的一系列设计模式。</em> <a class="ae lc" href="https://medium.com/@lakshmanok/machine-learning-design-patterns-58e6ecb013d7" rel="noopener"> <em class="lb">完整列表在此。</em>T9】</a></p><p id="1d34" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">机器学习流水线的关键步骤是训练模型(使用 Keras 中的<code class="fe ld le lf lg b">model.fit()</code>)、评估模型(使用<code class="fe ld le lf lg b">model.evaluate()</code>)、导出模型(使用<code class="fe ld le lf lg b">model.save()</code>)、部署模型(使用<code class="fe ld le lf lg b">gcloud ai-platform versions create</code>)以及通过访问模型的 REST API 使用模型进行预测。然而，有时使用检查点对训练和评估循环进行更多的控制会更好。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/efc2c022bb38f0ec9e383fbebb08b433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwVx5_Gf7RY3zj1e1rV06Q.png"/></div></div></figure><p id="62ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个检查点是一个模型的整个内部状态(它的权重，当前学习率等)的中间转储。)以便框架可以在任何需要的时候从这一点继续训练。包括检查点后，ML 管道变成:</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lt"><img src="../Images/5d71666d54730be715aa024d4321a1d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzmZh4aP7B9j_aPv6a7gqw.png"/></div></div></figure><p id="a3dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">换句话说，你训练一些迭代，然后评估模型，检查它，然后再拟合一些。完成后，保存模型，并像平常一样部署它。</p><p id="dc6b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">保存中间检查点有几个好处:</p><ul class=""><li id="3d11" class="lu lv iq kh b ki kj kl km ko lw ks lx kw ly la lz ma mb mc bi translated"><strong class="kh ir">韧性</strong>:如果你正在进行非常长时间的训练，或者在很多机器上进行分布式训练，那么机器出现故障的可能性就会增加。如果机器出现故障，TensorFlow 可以从最后保存的检查点恢复，而不必从头开始。此行为是自动的— TensorFlow 会查找检查点并从最后一个检查点恢复。</li><li id="69f0" class="lu lv iq kh b ki md kl me ko mf ks mg kw mh la lz ma mb mc bi translated"><strong class="kh ir">泛化</strong>:一般来说，训练时间越长，训练数据集上的损失越低。然而，在某一点上，被搁置的评估数据集上的误差可能停止减小。如果您有一个非常大的模型，并且没有进行充分的正则化，则评估数据集上的误差甚至可能开始增加。如果发生这种情况，返回并导出具有最佳验证错误的模型会很有帮助。这也被称为<em class="lb">提前停止</em>，因为如果您看到验证错误开始增加，您可以停止。(当然，一个更好的想法是降低模型复杂性或增加正则化，这样就不会发生这种情况)。您可以返回到最佳验证错误或提前停止的唯一方法是，如果您已经定期评估和检查模型。</li><li id="7c02" class="lu lv iq kh b ki md kl me ko mf ks mg kw mh la lz ma mb mc bi translated"><strong class="kh ir">可调性</strong>:在一个表现良好的训练循环中，梯度下降的表现是，你可以根据你的大部分数据快速到达最佳误差的邻域，然后通过优化拐角情况慢慢收敛到最低误差。现在，假设您需要定期根据新数据重新训练模型。你通常希望强调新的数据，而不是上个月的关键案例。你最好不要从最后一个检查点开始训练，而是从蓝线标记的检查点开始:</li></ul><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lt"><img src="../Images/9bc98402ae070ca4c93a05b45b2f144d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I01k6WYBSPpcGf0OCyU2xQ.png"/></div></div></figure><p id="ec45" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在 Keras 中检查模型，请提供一个回调:</p><pre class="li lj lk ll gt mi lg mj mk aw ml bi"><span id="ecdb" class="mm mn iq lg b gy mo mp l mq mr">trainds = load_dataset('taxi-train*', TRAIN_BATCH_SIZE, tf.estimator.ModeKeys.TRAIN)<br/>evalds = load_dataset('taxi-valid*', 1000, tf.estimator.ModeKeys.EVAL).take(NUM_EVAL_EXAMPLES)</span><span id="b5d5" class="mm mn iq lg b gy ms mp l mq mr">steps_per_epoch = NUM_TRAIN_EXAMPLES // (TRAIN_BATCH_SIZE * NUM_EVALS)</span><span id="e20a" class="mm mn iq lg b gy ms mp l mq mr">shutil.rmtree('{}/checkpoints/'.format(OUTDIR), ignore_errors=True)<br/>checkpoint_path = '{}/checkpoints/taxi'.format(OUTDIR)<br/><strong class="lg ir">cp_callback = tf.keras.callbacks.ModelCheckpoint(checkpoint_path, <br/>                                                 save_weights_only=True,<br/>                                                 verbose=1)</strong></span><span id="de68" class="mm mn iq lg b gy ms mp l mq mr">history = model.fit(trainds, <br/>                    validation_data=evalds,<br/>                    epochs=NUM_EVALS, <br/>                    steps_per_epoch=steps_per_epoch,<br/>                    verbose=2, # 0=silent, 1=progress bar, 2=one line per epoch<br/>                    <strong class="lg ir">callbacks=[cp_callback]</strong>)</span></pre><p id="c6bb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>