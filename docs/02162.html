<html>
<head>
<title>Multi-Class Text Classification with LSTM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于 LSTM 的多类文本分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/multi-class-text-classification-with-lstm-1590bee1bd17?source=collection_archive---------0-----------------------#2019-04-10">https://towardsdatascience.com/multi-class-text-classification-with-lstm-1590bee1bd17?source=collection_archive---------0-----------------------#2019-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/2f8745f4f1de97026124081158d5ba1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpIwpT1n6OBfeePP4f-U4g.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Photo credit: Pixabay</figcaption></figure><div class=""/><div class=""><h2 id="75df" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">如何使用 Keras 深度学习库开发 Python 中文本分类问题的 LSTM 递归神经网络模型</h2></div><p id="5ac4" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">自动文本分类或文档分类可以在机器学习中以许多不同的方式完成，如我们在之前看到的<a class="ae lq" rel="noopener" target="_blank" href="/multi-class-text-classification-model-comparison-and-selection-5eb066197568">。</a></p><p id="aacb" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">本文旨在提供一个示例，说明如何使用<a class="ae lq" href="https://keras.io/" rel="noopener ugc nofollow" target="_blank"> Keras </a>实现使用<a class="ae lq" href="https://en.wikipedia.org/wiki/Long_short-term_memory" rel="noopener ugc nofollow" target="_blank">长短期记忆</a> (LSTM)架构的<a class="ae lq" href="https://en.wikipedia.org/wiki/Recurrent_neural_network" rel="noopener ugc nofollow" target="_blank">递归神经网络</a> (RNN)。我们将使用与我们使用 Scikit-Lean 的<a class="ae lq" rel="noopener" target="_blank" href="/multi-class-text-classification-with-scikit-learn-12f1e60e0a9f">多类文本分类相同的数据源，即源自</a><a class="ae lq" href="https://catalog.data.gov/dataset/consumer-complaint-database" rel="noopener ugc nofollow" target="_blank">data.gov</a>的消费者投诉数据集。</p><h1 id="b3ef" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">数据</h1><p id="cde2" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated">我们将使用一个较小的数据集，您也可以在<a class="ae lq" href="https://www.kaggle.com/cfpb/us-consumer-finance-complaints" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>上找到数据。在该任务中，给定一个消费者投诉叙述，该模型尝试预测投诉是关于哪个产品的。这是一个多类文本分类问题。我们走吧！</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ff1c" class="mx ls jf mt b gy my mz l na nb">df = pd.read_csv('consumer_complaints_small.csv')<br/>df.info()</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/5f1640637ccc7ccd75aa35a55cb616bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r21cIOMgB2in2zATge4axA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 1</figcaption></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e616" class="mx ls jf mt b gy my mz l na nb">df.Product.value_counts()</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/8ee7509573097070dee445120c5ade30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vJJC1Q0ITVZok6YR6Iyqjg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 2</figcaption></figure><h1 id="bf23" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">标签合并</h1><p id="4de1" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated">第一眼看到标签后，我们意识到我们可以做些事情来让我们的生活变得更轻松。</p><ul class=""><li id="36f2" class="ne nf jf kw b kx ky la lb ld ng lh nh ll ni lp nj nk nl nm bi translated">将“信用报告”合并为“信用报告、信用修复服务或其他个人消费者报告”。</li><li id="4052" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">将“信用卡”合并为“信用卡或预付卡”。</li><li id="07b9" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">将“发薪日贷款”合并为“发薪日贷款、产权贷款或个人贷款”。</li><li id="13c2" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">将“虚拟货币”合并为“货币转移、虚拟货币或货币服务”。</li><li id="23fc" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">“其他金融服务”的投诉数量很少，没有任何意义，所以，我决定删除它。</li></ul><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0a51" class="mx ls jf mt b gy my mz l na nb">df.loc[df['Product'] == 'Credit reporting', 'Product'] = 'Credit reporting, credit repair services, or other personal consumer reports'<br/>df.loc[df['Product'] == 'Credit card', 'Product'] = 'Credit card or prepaid card'<br/>df.loc[df['Product'] == 'Payday loan', 'Product'] = 'Payday loan, title loan, or personal loan'<br/>df.loc[df['Product'] == 'Virtual currency', 'Product'] = 'Money transfer, virtual currency, or money service'<br/>df = df[df.Product != 'Other financial service']</span></pre><p id="cdff" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">整合后，我们有 13 个标签:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="98b2" class="mx ls jf mt b gy my mz l na nb">df['Product'].value_counts().sort_values(ascending=False).iplot(kind='bar', yTitle='Number of Complaints', <br/>                                                                title='Number complaints in each product')</span></pre><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 3</figcaption></figure><h1 id="8873" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">文本预处理</h1><p id="28d6" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated">让我们看看这些短信有多脏:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="16bd" class="mx ls jf mt b gy my mz l na nb">def print_plot(index):<br/>    example = df[df.index == index][['Consumer complaint narrative', 'Product']].values[0]<br/>    if len(example) &gt; 0:<br/>        print(example[0])<br/>        print('Product:', example[1])</span><span id="85a2" class="mx ls jf mt b gy nu mz l na nb">print_plot(10)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/130857fd3848e1236c30c02f88383b00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xy1SaB-HO1Q_PbXvwNQX3Q.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 4</figcaption></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3a20" class="mx ls jf mt b gy my mz l na nb">print_plot(100)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nw"><img src="../Images/d174720a7b4a68d4177a28f0d787d25b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RhHjXsxUOKxkMZMhEWYdkw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 5</figcaption></figure><p id="efd7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">很脏，是吧！</p><p id="9c73" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们的文本预处理将包括以下步骤:</p><ul class=""><li id="98d7" class="ne nf jf kw b kx ky la lb ld ng lh nh ll ni lp nj nk nl nm bi translated">将所有文本转换为小写。</li><li id="fd26" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">在文本中用空格替换 REPLACE_BY_SPACE_RE 符号。</li><li id="a1d0" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">从文本中删除 BAD_SYMBOLS_RE 中的符号。</li><li id="2830" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">删除文本中的“x”。</li><li id="2746" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">删除停用词。</li><li id="0589" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">删除文本中的数字。</li></ul><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nx nt l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">text_preprocessing_LSTM.py</figcaption></figure><p id="19bb" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在回过头来检查我们的文本预处理的质量:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="eb47" class="mx ls jf mt b gy my mz l na nb">print_plot(10)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ny"><img src="../Images/e7ece296afb83ee4866d3714fea82579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Sx3Q-K6Svlt3HaT-cHgUg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 6</figcaption></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b75e" class="mx ls jf mt b gy my mz l na nb">print_plot(100)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nz"><img src="../Images/86f16e0285d299e88f91ef4af5db35ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_370HxvVr1WioPUfSsQoA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 7</figcaption></figure><p id="0fe5" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">不错！我们完成了文本预处理。</p><h1 id="db37" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">LSTM 造型</h1><ul class=""><li id="b8c7" class="ne nf jf kw b kx mj la mk ld oa lh ob ll oc lp nj nk nl nm bi translated">通过将每个文本转换成整数序列或向量，对消费者投诉文本进行矢量化。</li><li id="f0d6" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">将数据集限制在 50000 个单词以内。</li><li id="8b42" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">将每个投诉的最大字数设置为 250。</li></ul><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="41b9" class="mx ls jf mt b gy my mz l na nb"># The maximum number of words to be used. (most frequent)<br/>MAX_NB_WORDS = 50000<br/># Max number of words in each complaint.<br/>MAX_SEQUENCE_LENGTH = 250<br/># This is fixed.<br/>EMBEDDING_DIM = 100</span><span id="7046" class="mx ls jf mt b gy nu mz l na nb">tokenizer = Tokenizer(num_words=MAX_NB_WORDS, filters='!"#$%&amp;()*+,-./:;&lt;=&gt;?@[\]^_`{|}~', lower=True)<br/>tokenizer.fit_on_texts(df['Consumer complaint narrative'].values)<br/>word_index = tokenizer.word_index<br/>print('Found %s unique tokens.' % len(word_index))</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi od"><img src="../Images/00330b5832c7529202b89de7f749e2d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*eWwM1yT_grfXaBrXL3La1Q.png"/></div></figure><ul class=""><li id="81c2" class="ne nf jf kw b kx ky la lb ld ng lh nh ll ni lp nj nk nl nm bi translated">截断并填充输入序列，使它们在建模时长度相同。</li></ul><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8c11" class="mx ls jf mt b gy my mz l na nb">X = tokenizer.texts_to_sequences(df['Consumer complaint narrative'].values)<br/>X = pad_sequences(X, maxlen=MAX_SEQUENCE_LENGTH)<br/>print('Shape of data tensor:', X.shape)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/28b058d0707b265a1dceac984b8794eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*VLJiui2PTpOCVjDoKV5XeQ.png"/></div></figure><ul class=""><li id="0f51" class="ne nf jf kw b kx ky la lb ld ng lh nh ll ni lp nj nk nl nm bi translated">将分类标签转换为数字。</li></ul><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="985a" class="mx ls jf mt b gy my mz l na nb">Y = pd.get_dummies(df['Product']).values<br/>print('Shape of label tensor:', Y.shape)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi of"><img src="../Images/079b9e32ded715a9e683703d1e77f581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*4ySPkl6gGPuJT5aqj5x5bg.png"/></div></figure><ul class=""><li id="e081" class="ne nf jf kw b kx ky la lb ld ng lh nh ll ni lp nj nk nl nm bi translated">列车测试分离。</li></ul><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="a755" class="mx ls jf mt b gy my mz l na nb">X_train, X_test, Y_train, Y_test = train_test_split(X,Y, test_size = 0.10, random_state = 42)<br/>print(X_train.shape,Y_train.shape)<br/>print(X_test.shape,Y_test.shape)</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi og"><img src="../Images/8f1a745e26a70b95d8266c675200019d.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*etShT3KizzWbt1mH53oP8Q.png"/></div></figure><ul class=""><li id="5de5" class="ne nf jf kw b kx ky la lb ld ng lh nh ll ni lp nj nk nl nm bi translated">第一层是嵌入层，使用 100 个长度向量来表示每个单词。</li><li id="61e2" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">SpatialDropout1D 在 NLP 模型中执行变分丢失。</li><li id="e8b4" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">下一层是具有 100 个存储单元的 LSTM 层。</li><li id="a448" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">输出层必须创建 13 个输出值，每个类一个。</li><li id="1f15" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">激活功能是 softmax 用于多类分类。</li><li id="a9ef" class="ne nf jf kw b kx nn la no ld np lh nq ll nr lp nj nk nl nm bi translated">因为这是一个多类分类问题，所以使用 categorical _ crossentropy 作为损失函数。</li></ul><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nx nt l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">consumer_complaint_lstm.py</figcaption></figure><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oh"><img src="../Images/54ec53f3ef2abf4efba1c08e1864ed98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EpgBozPdgoHiJ0Sm3D7Sng.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 8</figcaption></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="468b" class="mx ls jf mt b gy my mz l na nb">accr = model.evaluate(X_test,Y_test)<br/>print('Test set\n  Loss: {:0.3f}\n  Accuracy: {:0.3f}'.format(accr[0],accr[1]))</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oi"><img src="../Images/5c821a239f43a14d7a803dffe7cca55a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h698bGhxXg99t2Wkt6KfIg.png"/></div></div></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2bb8" class="mx ls jf mt b gy my mz l na nb">plt.title('Loss')<br/>plt.plot(history.history['loss'], label='train')<br/>plt.plot(history.history['val_loss'], label='test')<br/>plt.legend()<br/>plt.show();</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/4e803c3dc747a4c8bea62fc8c906e69b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*8hhkR6GqhRVyDlQDLZ1GnQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 9</figcaption></figure><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="58a1" class="mx ls jf mt b gy my mz l na nb">plt.title('Accuracy')<br/>plt.plot(history.history['acc'], label='train')<br/>plt.plot(history.history['val_acc'], label='test')<br/>plt.legend()<br/>plt.show();</span></pre><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/236da63276ef239479d02c89098a05b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*cAwsR_vvRVQVBoi-CleJGg.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 10</figcaption></figure><p id="2cda" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这些图表明，该模型有一点过度拟合的问题，更多的数据可能会有所帮助，但更多的时代不会有助于使用当前的数据。</p><h1 id="b81b" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">用新投诉进行测试</h1><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nx nt l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">test_new_complaint.py</figcaption></figure><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ol"><img src="../Images/1b6dd69da162112400d3078b3ead65c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RoYfMGjsgvGYN9EdP6f0Ig.png"/></div></div></figure><p id="8fd8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">Jupyter 笔记本可以在<a class="ae lq" href="https://github.com/susanli2016/NLP-with-Python/blob/master/Multi-Class%20Text%20Classification%20LSTM%20Consumer%20complaints.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。享受这周剩下的时光吧！</p><p id="c1be" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">参考:</p><div class="ip iq gp gr ir om"><a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd jg gy z fp or fr fs os fu fw je bi translated">基于 LSTM 递归神经网络的序列分类</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">序列分类是一个预测性的建模问题，在这个问题中，你在空间或时间上有一些输入序列，并且…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">machinelearningmastery.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ix om"/></div></div></a></div></div></div>    
</body>
</html>