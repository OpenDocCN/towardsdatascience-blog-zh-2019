<html>
<head>
<title>The PyTorch training loop</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PyTorch 训练循环</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-pytorch-training-loop-3c645c56665a?source=collection_archive---------8-----------------------#2019-09-27">https://towardsdatascience.com/the-pytorch-training-loop-3c645c56665a?source=collection_archive---------8-----------------------#2019-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4e8879de2d3875b780120fb238e1ae92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vUuxmjwPcbmqVh5mYDZYVQ.jpeg"/></div></div></figure><h2 id="3ed0" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">设置</h2><p id="e61e" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">现在我们知道了如何执行<a class="ae lp" href="https://becominghuman.ai/matrix-multiplication-the-pytorch-way-c0ad724402ed" rel="noopener ugc nofollow" target="_blank">矩阵乘法</a>和<a class="ae lp" href="https://becominghuman.ai/initializing-neural-networks-3a774eb63745" rel="noopener ugc nofollow" target="_blank">初始化神经网络</a>，我们可以继续进行训练。一如既往，我们将从占领 MNIST 开始。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/2bd06db7de709bcfaeb83dcf755c69fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-UVh600Af66tHiejedqiIQ.png"/></div></div></figure><p id="b9ab" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">然后定义一个非常简单的模型。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/d6abf587b7149a66f4dfc7bf5b3cf36e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sYIR4rf5lyRPwbBIkTdhXw.png"/></div></div></figure><p id="5e4e" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">我们将选择交叉熵作为我们的损失函数，准确度作为我们的度量。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mb"><img src="../Images/f0cb979cbca99cabd78cbb19fb3f6683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T5u8yfIIYZbBN0FlHAr8eg.png"/></div></div></figure><p id="5f58" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">我们还将设置开始学习的学习速率和时代数。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mc"><img src="../Images/81821419c4a32ef95432a84f6806f2b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wLJPFQE8XdxJ6G6v5BUBQw.png"/></div></div></figure><h1 id="1851" class="md jz iq bd ka me mf mg kd mh mi mj kg mk ml mm kk mn mo mp ko mq mr ms ks mt bi translated">训练循环</h1><p id="2c73" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">我们现在将从头开始编写训练循环。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/58125081f1b636bf232d92a13b18cf64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wDlavTABmeEoZZ8bRbUOGA.png"/></div></div></figure><p id="a448" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">然而，这看起来效率并不高。尤其是我们更新权重的部分。不需要遍历每一层并更新它的参数，如果我们能一起更新我们所有的参数就好了。我们希望能够做这样的事情:</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/4d1599c105ca2289b095ea34042db7ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p9I-v7QZgZfIxH59voi1xg.png"/></div></div></figure><p id="1f56" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">为了做到这一点，我们希望我们的模型存储所有层的信息，然后当我们对它调用<code class="fe mv mw mx my b">.parameters()</code>时返回它。让我们创建一个虚拟模型如下:</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/bfe31ee1d6adcbf0c03faf4b6e55eda5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ZucPs7jcHrx9ELvTWbnIg.png"/></div></div></figure><p id="4031" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">在这个模型中，我们使用了 Python 特殊的名为<code class="fe mv mw mx my b">__setattr__.</code>的 dunder 方法，这个方法将在我们每次设置属性时被调用，例如<code class="fe mv mw mx my b">self.l1 = nn.Linear(n_in, nh)</code>。</p><p id="9b68" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">所以现在我们每创建一个层，都会进入这个方法，把层的信息存储在一个叫做<code class="fe mv mw mx my b">self.modules</code>的字典里。然后，我们可以使用这个字典来生成我们所有的参数，如下所示。</p><p id="58c0" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">这就是 PyTorch 在我们从<code class="fe mv mw mx my b">nn.Module</code>继承时在幕后为我们做的事情，这就是为什么我们必须首先调用<code class="fe mv mw mx my b">super().__init__()</code>。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/9e6008bcc630d9904ffa09047f8e34d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jouWEBwMPQmpX0UH63tNxg.png"/></div></div></figure><p id="de15" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">然后我们可以在模型上调用<code class="fe mv mw mx my b">named_children()</code>来获得我们的层。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/fc2287287358d542f275a7163fffd922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Kzhjua6sk1CyJR5h4IGjg.png"/></div></div></figure><p id="782b" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">我们可以使用<code class="fe mv mw mx my b">model.parameters()</code>直接更新我们所有的参数。我们的训练循环现在看起来像这样。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/da842ed75bb5318ff638f5fad9ae84d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ty9Z9GJDhduzSb2DdVYzSA.png"/></div></div></figure><h2 id="8f97" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">了解 nn。连续的</h2><p id="05a1" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">如果我们创建了一个层的列表，那么我们不能通过简单地执行<code class="fe mv mw mx my b">self.layers = layers</code>来使用<code class="fe mv mw mx my b">model.parameters</code>访问它们的参数。我们需要将每个层添加到我们的模块中，如下所示:</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/04916316e44c0b0f2ba3aa7fd0427eed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*amtdJQY8R-kPCPJfzgqF_A.png"/></div></div></figure><p id="539c" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">PyTorch 使用<code class="fe mv mw mx my b">nn.ModuleList</code>做同样的事情。所以我们可以做的是:</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/fa60ac6a073365aa59a3324d8c2fa498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yB3Rb-QTInvI7dKFyOlX7w.png"/></div></div></figure><p id="ad2d" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">然而，这仍然是笨拙的，所以我们可以直接做:</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/bd13f1d656ab2dcdc32c484aece16e6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5tKqMtIbTG2pEDctk_poQ.png"/></div></div></figure><p id="a946" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">我们现在知道了<code class="fe mv mw mx my b">nn.Sequential</code>是如何实现的。</p><h2 id="9b12" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">了解优化器</h2><p id="1563" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">让我们进一步改进我们的权重更新代码，这样我们就可以从</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/4d1599c105ca2289b095ea34042db7ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p9I-v7QZgZfIxH59voi1xg.png"/></div></div></figure><p id="da34" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">只是为了</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/0888e61c7c0dae25ecd305807a7401a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0u3jJcWI3u7pnnky5cW8w.png"/></div></div></figure><p id="dc4f" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">为此，我们将定义一个<strong class="kw ir">优化器</strong>类，并将这些功能放入其中。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/a9edf48bef316a57b423af9d6fc7f7c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p3ah25vod_XP82RB0h5lAg.png"/></div></div></figure><p id="3873" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">我们的训练循环现在看起来干净多了。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/199ebfd370725bb0c0a66d6982532da3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fxc2DCME-xdY0Xb-s3opWA.png"/></div></div></figure><h2 id="b259" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">了解数据集和数据加载器</h2><p id="4ed2" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated">我们要改进的下一点是小型批处理。我们分别迭代 x 和 y 小批量，这不好。因此，我们将创建一个数据集，并一起处理它们。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/f7d7ee1ef77bbdddfb24aab775760c40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9JgKpkBWsgU6XUtTbtbrg.png"/></div></div></figure><p id="95b0" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">这将我们的循环修改如下:</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/d21ef87ef3815d15daf843c3ad67dd76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hd2IOkbtTfM74hBdgIGh8g.png"/></div></div></figure><p id="f47f" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">最后，我们为数据加载器创建一个类，以进一步清理小型批处理过程。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/81b43f162a8e0cb2baeae16eb4fb0690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8f8eM48mU-SvA4EZzIwaww.png"/></div></div></figure><p id="6c95" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">这是可行的，因为<code class="fe mv mw mx my b">yield</code>总是返回下一个小批量。我们最后的训练循环就像简单的英语一样容易阅读。</p><figure class="lr ls lt lu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/3da8791e78e2124a183244c6693bd6b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5H7dCKNy07GVWjQ7eGTZg.png"/></div></div></figure><p id="91fa" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">这就是本文的全部内容。</p><p id="e0ee" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">如果你想了解更多关于深度学习的知识，你可以看看我下面的深度学习系列。</p><div class="nl nm gp gr nn no"><a href="https://medium.com/@dipam44/deep-learning-series-30ad108fbe2b" rel="noopener follow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">深度学习系列</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">我所有关于深度学习的文章的系统列表</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">medium.com</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc jw no"/></div></div></a></div><p id="3bff" class="pw-post-body-paragraph ku kv iq kw b kx lv kz la lb lw ld le kh lx lg lh kl ly lj lk kp lz lm ln lo ij bi translated">~快乐学习</p><h2 id="d1c5" class="jy jz iq bd ka kb kc dn kd ke kf dp kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">参考:</h2><p id="1ef7" class="pw-post-body-paragraph ku kv iq kw b kx ky kz la lb lc ld le kh lf lg lh kl li lj lk kp ll lm ln lo ij bi translated"><a class="ae lp" href="https://www.fast.ai/2019/06/28/course-p2v3/" rel="noopener ugc nofollow" target="_blank">深度学习从基础做起，fast.a </a> i</p></div></div>    
</body>
</html>