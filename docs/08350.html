<html>
<head>
<title>How To Compute Satellite Image Statistics And use It In Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何计算卫星图像统计数据并将其用于熊猫</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-compute-satellite-image-statistics-and-use-it-in-pandas-81864a489144?source=collection_archive---------15-----------------------#2019-11-13">https://towardsdatascience.com/how-to-compute-satellite-image-statistics-and-use-it-in-pandas-81864a489144?source=collection_archive---------15-----------------------#2019-11-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d879" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从 Sentinel 2 影像中获取分区统计数据，并与您的 Pandas 数据框合并。洪灾区 NDWI 水指数计算演练。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/651d1817b80573633e9f156f7c0eb2cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q34cSEvWUG7FNA2fNyMohQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Example of Zonal Statistics — Elevation DEM overlayed on derived statistics (Max elevation in each grid shown)</figcaption></figure><p id="5e2f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">卫星数据非常密集，使用像元来存储值。但是，在许多情况下，您只想将卫星(栅格)影像的摘要转换为表格格式 CSV 或 Pandas 数据框。</p><p id="284c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们举例说:您有一个数字高程模型(DEM)。DEM 图像清晰地显示了该区域的高程和地形。现在，如果您想要获取高程值并整合您拥有的表格数据(例如，建筑物)来获取每座建筑物的高程，该怎么办呢？</p><p id="5df2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从光栅图像导出表格输出(汇总统计)的过程称为<strong class="la iu">区域统计。</strong></p><p id="d095" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本教程中，我们将学习如何从栅格数据中提取值，并以表格格式存储这些值(Pandas Dataframe)。</p><p id="92b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本教程的数据集和代码可以在 Github 中找到。让我们从探索数据开始。</p><h2 id="9af5" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">数据探索</h2><p id="88c6" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">本教程的数据集是 2019 年 11 月 1 日在索马里贝莱德文拍摄的哨兵图像。该地区在此期间被淹没，我们计算 NDWI 来测量水压力水平。我们用的是 Google Colab 笔记本，直接从 URL 下载笔记本里的数据。</p><p id="ff27" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们导入本教程中使用的库。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="016e" class="lu lv it mt b gy mx my l mz na">import pandas as pd<br/>import numpy as np<br/>import geopandas as gpd<br/>import rasterio as rio<br/>from rasterio.plot import show<br/>from rasterio.mask import mask<br/>import matplotlib.pyplot as plt</span></pre><p id="81c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用 Rasterio，您可以读取 Sentinel 2 图像的不同波段。在这种情况下，我们读取波段 8 (NIR)、4(红色)、3(绿色)和 2(蓝色)。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1586" class="lu lv it mt b gy mx my l mz na">b8 = rio.open(“/content/Data/20191101/B08–20191101.tif”)<br/>b4 = rio.open(“/content/Data/20191101/B04–20191101.tif”)<br/>b3 = rio.open(“/content/Data/20191101/B03–20191101.tif”)<br/>b2 = rio.open(“/content/Data/20191101/B02–20191101.tif”)</span></pre><p id="20f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们看看图像的宽度和高度。我只使用 b4，但你可以检查是否所有带都有相同的重量和长度。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5441" class="lu lv it mt b gy mx my l mz na">b4.width,<br/>b4.height</span></pre><p id="cde7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们绘制数据，以查看和探索我们拥有的卫星图像。在这里，我只绘制波段 3。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="0920" class="lu lv it mt b gy mx my l mz na">fig, ax = plt.subplots(1, figsize=(12, 10))<br/>show(b3, ax=ax)<br/>plt.show()</span></pre></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><p id="4feb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想知道如何用 Rasterio 制作 RGB 图像，我这里有一个教程你可能想看。</p><div class="ni nj gp gr nk nl"><a rel="noopener follow" target="_blank" href="/satellite-imagery-access-and-analysis-in-python-jupyter-notebooks-387971ece84b"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">Python 和 Jupyter 笔记本中的卫星图像访问和分析</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">使用 Python 在 Jupyter 笔记本中访问、预处理、分析和可视化卫星图像。</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">towardsdatascience.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz ks nl"/></div></div></a></div></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><p id="52fd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该区域的哨兵 2 影像(仅波段 3)如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/29178ff2b4d93a9b18d4116cef0a55bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*xRFhjnSJoV9z2HJ2jqtDGg.png"/></div></figure><p id="7102" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们也读一下 buildings 表，我们将使用它来存储从卫星图像得到的统计概要。请注意，您可以使用其他多边形，如区域、矩形网格，而不是本例中的建筑多边形。</p><p id="7e77" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用 Geopandas 来读取数据。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="a27d" class="lu lv it mt b gy mx my l mz na">buildings = gpd.read_file(“/content/Data/shapefiles/osm_buildings.shp”)<br/>buildings = buildings[[“osm_id”,”building”, “geometry”]]<br/>buildings.head()</span></pre><p id="4572" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是表格的前五行。我们有每个建筑的几何列、osm_id 和建筑列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/0f27bab58432006161c8993526017cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQyuOyYODkpc93TYbtuLrA.png"/></div></div></figure><p id="8533" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们也可以在哨兵 2 号图像的顶部绘制建筑物。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="53e3" class="lu lv it mt b gy mx my l mz na">fig, ax = plt.subplots(figsize=(12, 10))<br/>show(b4, ax=ax)<br/>buildings.plot(ax=ax, color=”white”, alpha=.50)<br/>plt.show();</span></pre><p id="0ca9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">建筑物在图像中被标记为白色并被覆盖，如下所示。图为蜿蜒的谢贝利河延伸到城市(居民区)的范围。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/04cffe76c6cc23463d0a4610a16d319b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2vX_4PO-20dHBb2yJsjsaA.png"/></div></div></figure><p id="61b7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们计算哨兵 2 号图像的 NDWI 值。</p><h2 id="c8e4" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">计算归一化差异水指数(NDWI)</h2><p id="7e24" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">为了计算 NDWI 值，我们使用以下公式:</p><blockquote class="od"><p id="6142" class="oe of it bd og oh oi oj ok ol om lt dk translated">(频段 3 —频段 8)/(频段 3 +频段 8)</p></blockquote><p id="a842" class="pw-post-body-paragraph ky kz it la b lb on ju ld le oo jx lg lh op lj lk ll oq ln lo lp or lr ls lt im bi translated">所以，让我们用拉斯特里奥的这个公式来计算。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9e01" class="lu lv it mt b gy mx my l mz na">green = b3.read()<br/>nir = b8.read()<br/>ndwi = (nir.astype(float)-green.astype(float))/(nir+green)</span></pre><p id="ac98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以使用 Rasterio 绘制 NDWI 阵列，如下所示。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9520" class="lu lv it mt b gy mx my l mz na">fig, ax = plt.subplots(1, figsize=(12, 10))<br/>show(ndwi, ax=ax, cmap=”coolwarm_r”)<br/>plt.show()</span></pre><p id="a801" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">NDWI 图清楚地显示了谢贝利河(蓝色)附近未标注日期的区域。洪水淹没了居民区。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/3c95281463c624aeabecb933fd56005a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*ZT0sfDQUS5Ya4-KKSupRWQ.png"/></div></figure><p id="6eb7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以将 NDWI 阵列保存为光栅图像，以便以后使用。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ac0b" class="lu lv it mt b gy mx my l mz na">meta = b4.meta<br/>meta.update(driver='GTiff')<br/>meta.update(dtype=rio.float32)<br/>with rio.open('NDWI.tif', 'w', **meta) as dst:<br/>     dst.write(ndvi.astype(rio.float32))</span><span id="55e6" class="lu lv it mt b gy ot my l mz na"># Read the saved <br/>ndwi_raster = rio.open(“NDWI.tif”)</span></pre><p id="e63b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们已经计算了 NDWI 值，是时候从 NDWI 栅格影像中获取统计数据并将其合并到建筑物表中了。我们使用栅格掩膜功能从 NDWI 栅格图像中获取像元值。</p><p id="08c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是一个小函数，它将像元值屏蔽到数据框表中。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="f297" class="lu lv it mt b gy mx my l mz na">def derive_stats(geom, data=ndwi_raster, **mask_kw):<br/>    masked, mask_transform = mask(dataset=data, <br/>          shapes=geom,)crop=True, all_touched=True, filled=True)<br/>    return masked</span></pre><p id="576a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以像这样得到我们想要的值。假设我们对获取每栋建筑的 NDWI 平均值感兴趣。我们为“mean_ndwi”创建了一个列，并传递我们函数来应用建筑物的几何图形，还使用 Numpy 应用到 mean。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="bb1e" class="lu lv it mt b gy mx my l mz na">buildings[‘mean_ndwi’] = buildings.geometry.apply(derive_stats).apply(np.mean)</span></pre><p id="6f61" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">或者，获取每个建筑物的最大 NDWI 值。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c736" class="lu lv it mt b gy mx my l mz na">buildings[‘max_ndwi’] = buildings.geometry.apply(derive_stats).apply(np.max)</span></pre><p id="a33c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的表现在有两个新列，mean_ndwi 和 max_ndwi，我们在其中存储每个建筑物的平均和最大 ndwi 值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/b3d70e6dd7bb035afd0f6b32ea4d2783.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rLnm-njpaXbmbZQuhe-CjQ.png"/></div></div></figure><p id="f1f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该数据集还包括该地区以前数据(洪水之前)中的哨兵图像。在“数据”文件夹中，有“20191002”文件夹。尝试使用这些图像计算平均和最大 NDWI 值。将此与我们为 20191101(洪水期)计算的图像得出的统计数据进行比较。</p><h2 id="fc29" class="lu lv it bd lw lx ly dn lz ma mb dp mc lh md me mf ll mg mh mi lp mj mk ml mm bi translated">结论</h2><p id="04d9" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">在本教程中，我们已经了解了如何从 Sentinel 2 影像中计算 NDWI 值，并从中获取汇总统计数据。代码和 Google Colab 笔记本可以在这个 Github 存储库中找到。</p><div class="ni nj gp gr nk nl"><a href="https://github.com/shakasom/zonalstatistics" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">shaka som/区域统计</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">python-Rasterio 和 Geopandas 计算分区统计数据卫星数据密集，并使用像元存储值…</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">github.com</p></div></div><div class="nu l"><div class="ov l nw nx ny nu nz ks nl"/></div></div></a></div><p id="fb3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">或者直接在这个谷歌合作实验室笔记本上</p><div class="ni nj gp gr nk nl"><a href="https://github.com/shakasom/zonalstatistics/blob/master/Zonal_Statistics_Sentinel.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">shaka som/区域统计</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">github.com</p></div></div><div class="nu l"><div class="ow l nw nx ny nu nz ks nl"/></div></div></a></div></div></div>    
</body>
</html>