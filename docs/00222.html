<html>
<head>
<title>Advanced Keras — Constructing Complex Custom Losses and Metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高级 Keras —构建复杂的定制损失和指标</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/advanced-keras-constructing-complex-custom-losses-and-metrics-c07ca130a618?source=collection_archive---------1-----------------------#2019-01-10">https://towardsdatascience.com/advanced-keras-constructing-complex-custom-losses-and-metrics-c07ca130a618?source=collection_archive---------1-----------------------#2019-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/48eecadb1fdb25854284d75ee79540a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XhfwKNNwYhAiUmCBkkjeNQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo Credit: Eyal Zakkay</figcaption></figure></div><div class="ab cl kc kd hu ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="ij ik il im in"><p id="9b5b" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">TL；DR——在本教程中，我将介绍一个简单的技巧，它将允许您在 Keras 中构造自定义损失函数，该函数可以接收除<code class="fe lh li lj lk b">y_true</code>和<code class="fe lh li lj lk b">y_pred</code>之外的参数。</p><h1 id="70a8" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">背景— Keras 损失和指标</h1><p id="ef72" class="pw-post-body-paragraph kj kk iq kl b km mj ko kp kq mk ks kt ku ml kw kx ky mm la lb lc mn le lf lg ij bi translated">在 Keras 中编译模型时，我们向<code class="fe lh li lj lk b">compile</code>函数提供所需的损失和度量。例如:</p><p id="4a3d" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated"><code class="fe lh li lj lk b">model.compile(loss=’mean_squared_error’, optimizer=’sgd’, metrics=‘acc’)</code></p><p id="13de" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">出于可读性的目的，从现在开始我将集中讨论损失函数。然而，所写的大部分内容也适用于度量标准。</p><p id="90fd" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">来自 Keras 的<a class="ae mo" href="https://keras.io/losses/" rel="noopener ugc nofollow" target="_blank">损失文件</a>:</p><blockquote class="mp mq mr"><p id="90fb" class="kj kk ms kl b km kn ko kp kq kr ks kt mt kv kw kx mu kz la lb mv ld le lf lg ij bi translated">您可以传递现有损失函数的名称，也可以传递 TensorFlow/Theano 符号函数，该函数为每个数据点返回一个标量，并采用以下两个参数:</p><p id="292a" class="kj kk ms kl b km kn ko kp kq kr ks kt mt kv kw kx mu kz la lb mv ld le lf lg ij bi translated"><strong class="kl ir"> y_true </strong>:真标签。张量流/Theano 张量。</p><p id="99d1" class="kj kk ms kl b km kn ko kp kq kr ks kt mt kv kw kx mu kz la lb mv ld le lf lg ij bi translated"><strong class="kl ir"> y_pred </strong>:预测。tensor flow/与 y_true 形状相同的 Theano 张量。</p></blockquote><p id="6246" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">因此，如果我们想使用一个常见的损失函数，如 MSE 或分类交叉熵，我们可以通过传递适当的名称轻松做到这一点。</p><p id="0760" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">Keras 文档中提供了可用的<a class="ae mo" href="https://keras.io/losses/" rel="noopener ugc nofollow" target="_blank">损失</a>和<a class="ae mo" href="https://keras.io/metrics/" rel="noopener ugc nofollow" target="_blank">指标</a>列表。</p><h1 id="6cd4" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">自定义损失函数</h1><p id="aee3" class="pw-post-body-paragraph kj kk iq kl b km mj ko kp kq mk ks kt ku ml kw kx ky mm la lb lc mn le lf lg ij bi translated">当我们需要使用一个可用的损失函数(或度量)时，我们可以构造我们自己的自定义函数并传递给<code class="fe lh li lj lk b">model.compile</code>。</p><p id="6bc7" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">例如，构建自定义指标(来自 Keras 的文档):</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="d780" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">多参数损失/度量函数</h1><p id="c97a" class="pw-post-body-paragraph kj kk iq kl b km mj ko kp kq mk ks kt ku ml kw kx ky mm la lb lc mn le lf lg ij bi translated">您可能已经注意到，损失函数<strong class="kl ir">必须只接受两个参数</strong> : <code class="fe lh li lj lk b">y_true</code>和<code class="fe lh li lj lk b">y_pred</code>，它们分别是目标张量和模型输出张量。但是如果我们希望我们的损失/度量依赖于这两个之外的其他张量呢？</p><p id="fa27" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">为此，我们需要使用<a class="ae mo" href="https://en.wikipedia.org/wiki/Closure_(computer_programming)" rel="noopener ugc nofollow" target="_blank">函数闭包</a>。我们将创建一个损失函数(使用我们喜欢的任何参数)<strong class="kl ir">，它返回一个<code class="fe lh li lj lk b">y_true</code>和<code class="fe lh li lj lk b">y_pred</code>的函数</strong>。</p><p id="c9dd" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">例如，如果我们(出于某种原因)想要创建一个损失函数，将第一层中所有激活的均方值加到 MSE 上:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="95b2" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">请注意，我们已经创建了一个返回合法损失函数的函数(不限制参数的数量)，该函数可以访问其封闭函数的参数。</p><p id="d788" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated"><strong class="kl ir">更具体的例子:</strong></p><p id="eb0f" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">前面的例子是一个不太有用的用例的玩具例子。那么什么时候我们会想要使用这样的损失函数呢？</p><p id="3a2d" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">假设你正在设计一个可变的自动编码器。您希望您的模型能够从编码的潜在空间重建其输入。然而，你也希望你在潜在空间中的编码是(近似)正态分布的。</p><p id="5e0e" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">而前一个目标可以通过设计一个仅取决于你的输入和期望输出<code class="fe lh li lj lk b">y_true</code>和<code class="fe lh li lj lk b">y_pred</code>的重建损失来实现。对于后者，你需要设计一个作用于潜在张量的损失项(例如 Kullback Leibler 损失)。为了让你的损失函数接近这个中间张量，我们刚刚学过的技巧可以派上用场。</p><p id="13a9" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">示例用途:</p><figure class="mw mx my mz gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="7751" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">这个例子是序列到序列变分自动编码器模型的一部分，更多上下文和完整代码请访问<a class="ae mo" href="https://github.com/eyalzk/sketch_rnn_keras" rel="noopener ugc nofollow" target="_blank">这个报告——Sketch-RNN 算法的一个 Keras 实现</a>。</p><p id="a9b0" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">如前所述，尽管示例是针对损失函数的，但是创建定制度量函数的工作方式是相同的。</p><p id="692e" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated"><em class="ms">撰写本文时的 Keras 版本:2.2.4 </em></p><p id="0908" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated"><strong class="kl ir">参考文献:</strong></p><p id="1e11" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">[1] <a class="ae mo" href="https://keras.io/losses/" rel="noopener ugc nofollow" target="_blank"> Keras —损失</a></p><p id="951c" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">[2] <a class="ae mo" href="https://keras.io/metrics/" rel="noopener ugc nofollow" target="_blank"> Keras —指标</a></p><p id="4463" class="pw-post-body-paragraph kj kk iq kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg ij bi translated">[3] <a class="ae mo" href="https://github.com/keras-team/keras/issues/2121" rel="noopener ugc nofollow" target="_blank"> Github 问题—向目标函数传递附加参数</a></p></div></div>    
</body>
</html>