<html>
<head>
<title>Bayesian A/B Testing with Python: the easy guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 进行贝叶斯 A/B 测试:简易指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bayesian-a-b-testing-with-python-the-easy-guide-d638f89e0b8a?source=collection_archive---------4-----------------------#2019-01-14">https://towardsdatascience.com/bayesian-a-b-testing-with-python-the-easy-guide-d638f89e0b8a?source=collection_archive---------4-----------------------#2019-01-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/023bcaa0d3621ce180ec53ba565c7135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*M5BjyNgAvjBhd_UgTfBMDA.jpeg"/></div></figure><p id="a501" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你登陆了这个页面，你已经知道什么是<a class="ae ks" href="https://en.wikipedia.org/wiki/A/B_testing" rel="noopener ugc nofollow" target="_blank"> A/B 测试</a>，但是也许你对如何在贝叶斯框架内分析结果有一些疑问。</p><p id="bd14" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇文章的开始，那么，让我指出贝叶斯方法与经典的“频繁主义者”方法的实际区别:区别在于你实际上想要研究的度量的形式。对于常客来说，这是一个简单的数字，而对于贝叶斯人来说，这是一个<a class="ae ks" href="https://en.wikipedia.org/wiki/Probability_distribution" rel="noopener ugc nofollow" target="_blank">分布</a>。</p><p id="7ecd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">虽然用分布代替数字看起来只是一个复杂的问题，但它在很多情况下非常有用，在 A/B 测试中也是如此。通过这篇文章，你会发现在实践中处理起来并不困难。事实上，只有几行代码。</p><p id="827e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> Edit 18/01/2018:该页面代码已成为与</strong><a class="ae ks" href="http://www.mixpanel.com" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir">Mixpanel</strong></a><strong class="jw ir">配合使用的</strong> <a class="ae ks" href="https://github.com/NaturalCycles/MixBABA" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir"> A/B 测试工具的基线。</strong></a></p><h1 id="3924" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">直奔主题</h1><p id="2079" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">我答应了一个简单的向导。因此，在这一部分中，我将只向您展示代码，在下一部分中，如果您感兴趣，您将看到隐藏在它背后的一些细节。</p><p id="6423" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，没有使用任何近似方法:没有马尔可夫链蒙特卡罗(MCMC)，或任何其他随机(和缓慢)过程。因此，不需要主动的编程框架。</p><p id="8660" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们来介绍一下样本数据:我们已经运行了一个 A/B 测试来检查一个网页的转化率(CR，从现在开始)，结果在下面的表 1 中。</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/d97fd57a2fe85c95e8009ec8c60d1578.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/1*zwlO_-OlPjcvPPCh5xp_Lw.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk">Table 1: The data</figcaption></figure><p id="77bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是代码。你只需要安装 Scipy 和 Numba，插入你的数字，你就会得到你的结果。</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="524e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">和模块导入的内容，<code class="fe mh mi mj mk b">calc_prob.py</code>:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="82c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">根据表 1 中的数字，测试选项的性能比控制选项好得多:几乎提升了 60%,有超过 98%的可能性更好。</p><p id="7876" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如你所见，这些都是赤裸裸的、不可知的结果。他们是好是坏取决于你的情况。关于阈值的更深入的考虑将在另一篇文章中讨论，但是就概率而言，任何高于 95%的值都足够好了。</p><p id="7414" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很简单，对吧？现在让我们深入了解一下细节。</p><h1 id="1519" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">细节</h1><p id="ae84" class="pw-post-body-paragraph ju jv iq jw b jx lr jz ka kb ls kd ke kf lt kh ki kj lu kl km kn lv kp kq kr ij bi translated">在代码中，我初始化了两个<a class="ae ks" href="https://en.wikipedia.org/wiki/Beta_distribution" rel="noopener ugc nofollow" target="_blank">“Beta”函数</a>，每个选项一个，用我们在表中的数字填充它们:</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/743166f9567876c3b73c9ec7bee87353.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*HjtYZngt7sh3Ujcq7xBsow.png"/></div></figure><p id="9abe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些实际上是为 A/B 测试建立数据模型的函数。为了更好地介绍它们的行为，请查看下面的动画:</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/251e98bdf04332e4af2b06befc944d7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/1*8CxN7lOhf3ChFg3Mur-6kw.gif"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk">Figure 1: animation of the Beta distribution for a fixed CR. The ‘X’ axis has been zoomed.</figcaption></figure><p id="c813" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">每个函数都建立在平坦的、无信息的函数之上，由β(1，1)定义。我们在这个基础上增加的信息(数据)越多，这个函数就变得越窄。</p><p id="2426" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在你大概在想:真的这么简单吗？为什么存在一个看起来完全是为模型 A/B 测试而构建的函数？</p><p id="a4e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">答案在于贝叶斯定理的精确性。在不深入细节的情况下，贝叶斯定理的解通常很难(如果不是不可能的话)精确求解，这就是为什么很少有近似方法被开发出来，如马尔可夫链蒙特卡罗(MCMC)。你可以在网上找到很多使用这种方法的文章。</p><p id="f455" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是 A/B 测试是一个幸运的案例，我们实际上可以基于"<a class="ae ks" href="https://en.wikipedia.org/wiki/Conjugate_prior" rel="noopener ugc nofollow" target="_blank">共轭先验</a>"的概念得到一个精确的解。当这个概念适用时，贝叶斯定理的后验函数与前一个后验函数属于同一族，因此我们可以通过迭代过程来构建最终函数。</p><p id="2c0c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">A/B 测试是随机实验，只有两种可能的结果，“转换”或“不转换”，因此被描述为<a class="ae ks" href="https://en.wikipedia.org/wiki/Bernoulli_trial" rel="noopener ugc nofollow" target="_blank">伯努利试验</a>，贝塔分布是这种过程的共轭先验。这就是为什么我们敢用我所用的简单方法来使用它。但是如果你仍然有疑问和/或你想更深入地挖掘，你可以在<a class="ae ks" href="https://en.wikipedia.org/wiki/Conjugate_prior#Example" rel="noopener ugc nofollow" target="_blank">这里</a>查看数学细节:维基百科页面上的例子正是我们的例子。</p><p id="598c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到我们的例子，让我给你看两个分布:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/9ea2e0e1dfd434cbcc69687dff247d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*7Aaj97rSPVFse48w9g6yHg.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk">Figure 2: distributions for the two CR.</figcaption></figure><p id="6f33" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以注意到，两个分布的峰值与您以经典方式计算的值一致:</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/8ea7464ec760bfd566418194763a3868.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/format:webp/1*Uv2RwdVzAmsNphRSmfLETw.png"/></div></figure><p id="d698" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如前所述，不同之处在于 CR 有一个完整的概率密度函数(<em class="mp"> PDF </em>)，而不是一个简单的数字。由于这一点，你可以计算，例如，CRs 上的方差(俗称“误差”)，它也显示在图中的标签上。</p><p id="c39a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您可以计算所谓的“提升”，即相对于控制选项，测试选项增加了多少 CR:</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/1edd58235b30055dadef9f4f62c2b0e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:658/format:webp/1*1aA3Dj4gQwlbFeo7x0ZNFw.png"/></div></figure><p id="4425" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是，在这一点上，你需要评估这个结果的可信度。怎么会？嗯，你可以估计一个选择比另一个更好的概率！</p><p id="8c08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注意，在经典的“频率主义者”范式中，你没有办法计算这样的概率。在这种方法中，你通常会计算“<a class="ae ks" href="https://en.wikipedia.org/wiki/P-value" rel="noopener ugc nofollow" target="_blank"> p 值</a>”，然后检查它是否落在任意选择的阈值之下(“α值”，通常为 5%)，最终你可以宣布一些几乎不可能向任何经理/客户/董事会解释的事情:“在 95%的置信水平下，我们可以拒绝零假设”。然后，你必须解释这个声明与“这个假设比另一个有 95%的可能性更好”是非常不同的，这正是他们真正想从你那里听到的句子。</p><p id="cba8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是现在我们在贝叶斯世界里，我们可以这么说。事实上，我们有定义 CR 的 pdf，概率由曲线下的面积给出。实际上，这就是 PDF 的定义。</p><p id="dc52" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一个简单的例子:你希望测试选项的 CR 的概率大于 0.003 吗？它只是测试曲线下 0.003 和 1.0 之间的区域，在图 3 中用阴影表示。</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/51c145a67382baf75932bab05c1fa190.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*RC23dWNTSPCN_hBQTF9y7Q.png"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk">Figure 3: The probability for the Test option CR to be greater than 3E-03.</figcaption></figure><p id="4620" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在数学语言中，你通过在两个极限之间的曲线上积分来计算面积:0.003(我们选择的极限)和 1(硬极限)。</p><p id="ce30" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">借助 Python，我们可以精确地计算这个积分(仍然:不需要蒙特卡罗)，这是由<a class="ae ks" href="http://mpmath.org/" rel="noopener ugc nofollow" target="_blank"> Mpmath </a>库提供的:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="b8e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个例子中，我们只考虑了一个分布(测试分布)，但是为了测量我们提升的可信度，我们必须考虑两个分布(控制和测试)，因此为了可视化这种情况，我们必须增加一个维度。因此，我们要测量的概率不再由面积来定义，而是由体积来定义。特别是，试验组和对照组在<a class="ae ks" href="https://en.wikipedia.org/wiki/Joint_probability_distribution" rel="noopener ugc nofollow" target="_blank">联合概率分布</a>下的体积大于对照组。让我们看看它是什么:</p><div class="lx ly lz ma gt ab cb"><figure class="mr jr ms mt mu mv mw paragraph-image"><img src="../Images/f9949c72f512780ccbabe46011816a31.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*TfHWi1hSP7sEUhrYW1-RhA.png"/></figure><figure class="mr jr mx mt mu mv mw paragraph-image"><img src="../Images/ab80c3c90dff172ff35f6bb091f8cdc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*8lS1RGfxd6C5UEYdL-vElg.png"/><figcaption class="mb mc gj gh gi md me bd b be z dk my di mz na">Figure 4: the Joint PDF of the two options. Left: 3-d visualization. Right: view from the top (zoomed). The gray plane (or line, in the 2-d) separate the zone where the Test dominate the Control.</figcaption></figure></div><p id="ed24" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">把图 4 左边的图想象成一座山的图片，右边的图是从卫星上看到的。关注右侧的地块，您可以看到灰色线是属于测试选项(上方三角形)的土地和控制选项的土地之间的边界。在这种情况下，问题就变成了:测试比控制多了多少山？</p><p id="6554" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">更新(13/05/2019) </strong>:因为我有几个关于这个的请求，下面你可以找到重建图 4 情节的代码，对吧。这使用蒙特卡罗抽样，需要大量的点来产生一个好看的图形:</p><figure class="lx ly lz ma gt jr"><div class="bz fp l di"><div class="mf mg l"/></div><figcaption class="mb mc gj gh gi md me bd b be z dk">Code for creating the right plot of the Figure 4.</figcaption></figure><p id="dd5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了计算这个量(在图 4 的上三角中)，我在网上看到了很多帖子，这些帖子也使用了近似的方法(比如蒙特卡罗)。好吧，写它们的人不知道约翰·库克已经在 2005 年部署了一个精确的方法(第二章，这里<a class="ae ks" href="https://www.johndcook.com/UTMDABTR-005-05.pdf" rel="noopener ugc nofollow" target="_blank"/>)。模块<code class="fe mh mi mj mk b">calc_prob.py</code>中的代码复制了这个公式，并且几乎完全来自最初由<a class="ae ks" href="http://ars.iki.fi/" rel="noopener ugc nofollow" target="_blank"> Antti Rasinen </a>编写的<a class="ae ks" href="https://gist.github.com/arsatiki/1395348/f0275f529d322d3c23e18201f26890f5a09dcb51" rel="noopener ugc nofollow" target="_blank">版本</a>。</p><p id="64ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们的例子中，面积是 0.98，这意味着“测试”选项以 98%的概率比“控制”选项表现得更好。</p><p id="a1f3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我强调一下，如果结果本质上是 50%，那么这座山是完全共享的，这意味着没有选项比另一个更好，而较小的值意味着测试选项实际上比控制选项更差。</p><p id="3fb5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">仅此而已。</p><p id="44a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如你所见，这篇文章开头的几行代码背后的细节很深奥，而且不那么简单。但是我希望我已经清楚简单地描述了这些概念，正如我在标题中所说的。</p></div></div>    
</body>
</html>