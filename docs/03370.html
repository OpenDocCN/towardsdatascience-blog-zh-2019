<html>
<head>
<title>Hosting your ML model on AWS Lambdas + API Gateway Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 AWS Lambdas + API Gateway 上托管您的 ML 模型第 2 部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hosting-your-ml-model-on-aws-lambdas-api-gateway-part-2-23517609522b?source=collection_archive---------23-----------------------#2019-05-29">https://towardsdatascience.com/hosting-your-ml-model-on-aws-lambdas-api-gateway-part-2-23517609522b?source=collection_archive---------23-----------------------#2019-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="8f45" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/modeldeployment" rel="noopener" target="_blank">我关于模型部署的其他帖子</a></h2><div class=""/><div class=""><h2 id="024e" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">这是我在 AWS 系列上托管您的 ML 模型的第 2 部分，我将通过 API 网关安全地公开您的 ML 模型 lambda。</h2></div><p id="8e2f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我有一些好消息，虽然，<strong class="kq ja">这是容易的一点</strong>。</p><p id="a450" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你已经完成了设置 lambda 函数和所有层的所有艰苦工作，所以这应该是小菜一碟。</p><p id="6146" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="kq ja">关于我的其他关于模型部署的文章，请查看标题上方的链接。</strong></p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/6fc0df0438cd5894a0880cadcf18bb1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tv6O3_ZEH6lukEIiLrdMsQ.png"/></div></div></figure><h1 id="003f" class="lw lx iq bd ly lz ma mb mc md me mf mg kf mh kg mi ki mj kj mk kl ml km mm mn bi translated">将 lambda 链接到 API</h1><p id="86da" class="pw-post-body-paragraph ko kp iq kq b kr mo ka kt ku mp kd kw kx mq kz la lb mr ld le lf ms lh li lj ij bi translated">因此，首先您需要通过 API 网关创建一个新的 API。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mt"><img src="../Images/e05ff510aa604545055fe5637325f9ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RfYNMWbewdqCZwrV4rdbxA.png"/></div></div></figure><p id="ddc7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对于您的新 API，选择 resources 并单击 actions。您需要添加一个资源，然后添加一个 POST 方法。让我们称资源为 predict，因为这就是它的作用(有趣的想法),并将 POST 方法分配给 predict 资源。</p><p id="a76a" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，您将需要将 API 与 lambda 函数集成在一起。输入您的 lambda 函数名，并允许 API 访问该资源。它应该是这样的:</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mu"><img src="../Images/cc805f4068665fc27a199457563ba17e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5MtUOHo01w_Au4deh33HZA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">APIs are easy AF</figcaption></figure><p id="9c9c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来我们只需要部署 API。重新单击 Actions 按钮，选择 Deploy API，并为您的新部署命名和描述(如果您愿意的话)。</p><p id="525d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我通常把我所有的 API 都称为测试，这样至少人们不会太惊讶，然后他们会爆炸。</p><h1 id="df82" class="lw lx iq bd ly lz ma mb mc md me mf mg kf mh kg mi ki mj kj mk kl ml km mm mn bi translated">测试您是否可以访问您的 API</h1><p id="a4a1" class="pw-post-body-paragraph ko kp iq kq b kr mo ka kt ku mp kd kw kx mq kz la lb mr ld le lf ms lh li lj ij bi translated">你已经在 AWS 端完成了所有的配置，现在让我们看看是否能从你的 API 中得到一些预测。</p><p id="9515" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">其实超级简单。</p><pre class="ll lm ln lo gt mz na nb nc aw nd bi"><span id="0b89" class="ne lx iq na b gy nf ng l nh ni">import requests<br/><br/>url = "https:your_url.amazonaws.com/test/predict"</span><span id="2e01" class="ne lx iq na b gy nj ng l nh ni">input_data = {<br/>  "Property Type": "S",<br/>  "Old/New": "Y",<br/>  "Duration": "L"<br/>}<br/><br/>r = requests.post(url, json=input_data)<br/>print(r.json())</span><span id="ea8e" class="ne lx iq na b gy nj ng l nh ni">164735.29632791804</span></pre><p id="bc90" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">维奥拉。您实际上已经部署了您的模型，现在可以从任何可以在您的 API 上创建 POST 请求的地方访问它。</p><p id="fadc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这很酷。</p><h1 id="28f5" class="lw lx iq bd ly lz ma mb mc md me mf mg kf mh kg mi ki mj kj mk kl ml km mm mn bi translated">为您的 API 增加一些安全性</h1><p id="cf8a" class="pw-post-body-paragraph ko kp iq kq b kr mo ka kt ku mp kd kw kx mq kz la lb mr ld le lf ms lh li lj ij bi translated">但是很明显，我们不希望任何获得 URL 的人能够从 API 访问结果。</p><p id="296d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">也许它是商业 IP 或其他东西，但无论哪种方式，你都必须为通过它的所有请求付费(不要担心它真的很便宜)，所以让我们为 API 添加一个 API 密钥，这样它就变得很好很安全。</p><p id="bbee" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你需要做的第一件事是创建一个使用计划。您可以通过 API 设置节流/突发流量。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nk"><img src="../Images/0ad26112adf736432ae262cff21146f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXFR2fX1hDB6DuPALljoZg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">Just click the toolbar on the left hand side and select usage plan. Please set your quota to more than 5 per month though. Testing will be hell otherwise</figcaption></figure><p id="d0ab" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦您创建了您的使用计划(如果您正在与企业合作<strong class="kq ja">，您可能希望每秒钟有 5 个以上的请求</strong>)，您就可以开始了，然后接下来会提示您创建您的 API 密钥。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nl"><img src="../Images/f1827d9b6dd5275bdd12ba8e8084c860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z5ut87e17iq6lcHo_SNvkQ.png"/></div></div></figure><p id="efe2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在我发誓我们快到了。接下来，您需要进入您的 APIs POST 方法并添加 API 密钥需求，否则您仍然可以在没有密钥的情况下访问 API。</p><p id="26ff" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">所以让我们直接进入方法响应</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nm"><img src="../Images/321dd0634721c9ce516eb5a48fd39f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YGS23crsYKaLkhdo2ovdmA.png"/></div></div></figure><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nn"><img src="../Images/4f7f3ef6125ab395690a6629c9b03677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UQyV4XbI9jNBqZLdYqcdyA.png"/></div></div></figure><p id="b9a3" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="kq ja">最后一步，别忘了部署您的 API。</strong></p><p id="f97c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您会惊讶地发现，做出更改却忘记部署是多么容易。</p><p id="ce7b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在我们需要去做一些测试，以确保这是我们所希望的工作。所以我们要检查一下:</p><ul class=""><li id="6f6d" class="no np iq kq b kr ks ku kv kx nq lb nr lf ns lj nt nu nv nw bi translated">#1:测试没有密钥的 API 请求失败</li><li id="f37c" class="no np iq kq b kr nx ku ny kx nz lb oa lf ob lj nt nu nv nw bi translated">#2:测试带有密钥的 API 请求成功</li></ul><h2 id="4564" class="ne lx iq bd ly oc od dn mc oe of dp mg kx og oh mi lb oi oj mk lf ok ol mm iw bi translated">#1 测试没有 API 密钥的 API 密钥失败</h2><pre class="ll lm ln lo gt mz na nb nc aw nd bi"><span id="54ac" class="ne lx iq na b gy nf ng l nh ni">import requests<br/><br/>url = "https:your_url.amazonaws.com/test/predict"</span><span id="d028" class="ne lx iq na b gy nj ng l nh ni">input_data = {<br/>  "Property Type": "S",<br/>  "Old/New": "Y",<br/>  "Duration": "L"<br/>}<br/><br/>r = requests.post(url, json=input_data)<br/>print(r.json())</span></pre><p id="d59c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">运行该脚本应该会返回以下错误。</p><pre class="ll lm ln lo gt mz na nb nc aw nd bi"><span id="f5c6" class="ne lx iq na b gy nf ng l nh ni">{'message': 'Forbidden'}</span></pre><p id="578b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果这种情况没有发生，你需要检查你的 API 密匙是否已经被正确地附加到你的 API 上，因为它现在不工作。</p><p id="ed38" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">但是，现在你已经成功地保护了你的 API。</p><h2 id="fd91" class="ne lx iq bd ly oc od dn mc oe of dp mg kx og oh mi lb oi oj mk lf ok ol mm iw bi translated">#2:带有密钥的 API 请求成功</h2><p id="3395" class="pw-post-body-paragraph ko kp iq kq b kr mo ka kt ku mp kd kw kx mq kz la lb mr ld le lf ms lh li lj ij bi translated">您需要返回到 API 网关，在 API 密钥下，您需要显示您的 API 密钥。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi om"><img src="../Images/214ba616e5b0960801da035b16d6aca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-7vwJa2x9rqoZzkJX4ttqg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk">Half the battle of AWS is knowing where to find these things</figcaption></figure><p id="c359" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">将它粘贴到 Pycharm(或您正在使用的任何 IDE)中，这样您就可以在 POST 请求中传递它。</p><p id="c635" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">所以你的帖子请求应该是这样的:</p><pre class="ll lm ln lo gt mz na nb nc aw nd bi"><span id="38c5" class="ne lx iq na b gy nf ng l nh ni">key="yourapikey" # In reality it'll look much weirder<br/><br/>headers = {<br/>  'x-api-key': key<br/>}<br/><br/>r = requests.post(url, json=input_data, headers=headers)<br/>print(r.json())</span></pre><p id="4989" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您应该得到这样的有效响应(实际结果可能会有所不同)</p><pre class="ll lm ln lo gt mz na nb nc aw nd bi"><span id="e5cb" class="ne lx iq na b gy nf ng l nh ni">164735.29632791804</span></pre><h1 id="e8ea" class="lw lx iq bd ly lz ma mb mc md me mf mg kf mh kg mi ki mj kj mk kl ml km mm mn bi translated">包裹</h1><p id="e09d" class="pw-post-body-paragraph ko kp iq kq b kr mo ka kt ku mp kd kw kx mq kz la lb mr ld le lf ms lh li lj ij bi translated">因此，在本教程之后，您应该能够将您的模型部署为 lambda 函数，并使用 API 网关安全地将该 lambda 公开给外界。</p><p id="46d3" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我希望你们都学到了一些新的东西，如果有什么你想让我介绍的，就写在评论里，我会研究的。</p></div></div>    
</body>
</html>