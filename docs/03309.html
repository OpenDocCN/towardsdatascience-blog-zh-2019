<html>
<head>
<title>Real Time Anomaly Detection with AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动气象站的实时异常检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/real-time-anomaly-detection-with-aws-c237db9eaa3f?source=collection_archive---------8-----------------------#2019-05-27">https://towardsdatascience.com/real-time-anomaly-detection-with-aws-c237db9eaa3f?source=collection_archive---------8-----------------------#2019-05-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq"><p id="9236" class="jr js it bd jt ju jv jw jx jy jz ka dk translated">数据越新，就越具有可操作性和价值。这是实时数据分析的基本逻辑。</p></blockquote><p id="8d1a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ka im bi translated">可能会有一些用户进行可疑的活动，或滥用您的折扣。另一方面，你也可以只是观察客户的行为并采取行动。为了实现这个目标，我将介绍如何使用 AWS 工具创建一个实时数据分析应用程序。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/f18f25743a5c1bc13377e931660fb9ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*ZukumHQqW8TF1wHLyQLetQ.png"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">Picture taken from <a class="ae lr" href="https://docs.aws.amazon.com/kinesisanalytics/latest/sqlref/sqlrf-random-cut-forest.html" rel="noopener ugc nofollow" target="_blank">AWS Docs</a></figcaption></figure><p id="6926" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">想象一下，你想要实时观察的最后一千个数据点就画在上面这样的 2D 图上。我们的应用程序将能够捕捉那些暗示异常值的红色点。最重要的是，我们还建立了一个警报系统，只要出现一个<em class="lx">红色</em>点就会触发。</p><h1 id="eefd" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">管道</h1><h2 id="39fd" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">投入</h2><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/3bad6b1bbfa78d9ddbc83d190ab01068.png" data-original-src="https://miro.medium.com/v2/resize:fit:242/format:webp/1*rVImEYDpojHzOPWs7LXIZA.jpeg"/></div></figure><p id="5bab" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">我们的应用程序的输入实际上<em class="lx">可以是任何流数据。</em>然而，我们需要它成为可操作的数据，以便我们的异常检测应用程序有意义。后端的方法日志、来自移动应用程序的点击/触摸事件或数据库更改事件将会很好，因为它们的性质赋予了我们观察客户端动作的能力。</p><h2 id="ef39" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">溪流</h2><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/a0785d3730c439d18ed05d17dbbcc5b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*-y41FB3oKZH4KbJz4fpedg.png"/></div></figure><p id="f00a" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">我们如何将现有数据接收并传输到我们的应用程序中？AWS Kinesis 是一个非常方便的工具，易于使用，易于配置和自我管理。坦率地说，Kinesis 由 3 个不同的服务组成；对于流媒体，我们将使用<a class="ae lr" href="https://aws.amazon.com/kinesis/data-streams/" rel="noopener ugc nofollow" target="_blank"> Kinesis 数据流</a>。</p><p id="241b" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">为了创建一个 Kinesis 数据流，你需要给它一个名字，并为它选择碎片计数。碎片是 Kinesis 流的处理单位，在我写这篇文章的时候，一个碎片可以每秒接收 1MB 和 1000 条记录，每秒发出 2MB。对于大多数基本应用程序，1 个 shard 足以处理您的输入数据。</p><h2 id="2e1f" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">摄取</h2><p id="2b41" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">现在我们已经创建了流，我们可以接收实时数据了。有官方库可以使用 AWS 工具，例如:</p><ul class=""><li id="a7e3" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated"><strong class="kd iu">boto</strong>for<em class="lx">Python 2</em></li><li id="8881" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated"><strong class="kd iu"> boto3 </strong>为<em class="lx"> Python 3 </em></li><li id="5c1e" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated"><strong class="kd iu">AWS-SDK</strong>for<em class="lx">node . js</em></li></ul><p id="9fa6" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">我们只需要我们想要放置记录的流的名称，以及写入该流的权限。</p><h2 id="1f84" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">数据分析应用</h2><p id="c29a" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">为了处理数据并从我们的实时数据中捕捉异常，我们将使用 Kinesis 的另一项名为<a class="ae lr" href="https://aws.amazon.com/kinesis/data-analytics/" rel="noopener ugc nofollow" target="_blank"> Kinesis 数据分析</a>的服务。这是一个非常灵活的工具，它使我们能够在应用程序处理数据之前对数据进行预处理，然后使用丰富的 SQL 引擎处理数据，并对应用程序捕获的数据进行后处理。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/1fd341e31fda876fccfafc101bb8b39f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*0i3pBB8u3coL-n0rzOkAPw.jpeg"/></div></figure><ul class=""><li id="e6ab" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">预处理器是一个由 Kinesis 数据流触发的 AWS Lambda 函数，它可能会丰富数据或清理数据。如果我们想在应用程序中使用一些其他数据，我们可以用这些数据丰富我们的输入。此外，我们可能希望通过类型转换来清理输入，或者移除未使用的字段。</li><li id="e051" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">异常检测是我们的 Kinesis 数据分析应用程序的名称。它是用 SQL 编写的，并增加了特殊的分析功能。我将在下一部分对此进行更深入的探讨。</li><li id="0e93" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">后处理器是一个 AWS Lambda 函数，由 Kinesis 数据分析为其每个结果触发。你可以对结果做任何你想做的事。您可以将它附加到一个警报系统，或者您可以调用一个端点，或者您可能希望用该数据训练一个模型。灵活性是存在的。</li></ul><h2 id="ce92" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">警报</h2><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/a63ff91dfbc64c3496fd97d48c1a8fd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:294/format:webp/1*mnZ-03eEMoFUYSmX57k2MA.png"/></div></figure><p id="3bf6" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">AWS 提供了一个名为<a class="ae lr" href="https://aws.amazon.com/sns/" rel="noopener ugc nofollow" target="_blank">简单通知服务</a>的工具，您可以用它来创建警报系统。在我们的例子中，我们将异常检测应用程序的结果发送到一个 SNS <em class="lx">主题</em>。然后，订阅该主题的每个用户都会收到一个通知，比如说，一封电子邮件。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><p id="59bb" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">因此，我们的管道如下图所示。你可以断开 Lambda functions，或者 SNS，用你想要的另一个服务来代替。这种方法提供了灵活性，同时借助 AWS 工具保持了自我管理和持久性。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/795cacaf5bede5c799482ce50d86760a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*aiOhneYOxoFIk304gSo16Q.jpeg"/></div></figure><h1 id="2db0" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">数据分析应用</h1><p id="73b8" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">在 Kinesis 中创建数据分析应用相当简单:</p><ul class=""><li id="afdd" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">我们选择应用引擎，SQL 或 Apache Flink。我们将在我们的案例中使用 SQL。</li><li id="707d" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">我们选择一个数据源，Kinesis 流或 Kinesis 消防水带交付流。在我们的例子中，我们将使用 Kinesis 流。</li><li id="b144" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">可以创建一个 lambda 函数来预先预处理数据。</li><li id="4b22" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">由于我们是用 SQL 构建我们的应用程序，我们的数据需要严格类型化，这意味着需要一个模式。Kinesis 数据分析具有自动推断模式的功能，然后您可以根据需要编辑模式。</li></ul><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi og"><img src="../Images/289fa8b27bd9e8b4bb67f60bdff6ddb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cYAukPE4q1RLG51_P9fG7A.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">An example schema enforced data analytics app input format</figcaption></figure><ul class=""><li id="f117" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">我们可以连接另一个称为参考数据的数据源，以便在应用程序中使用。我们将暂时忽略它。</li><li id="83b8" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">我们可以在 Kinesis 流、Kinesis 消防水管输送流或 Lambda 函数中选择结果的目的地。在我们的例子中，选择了一个后处理器 Lambda 函数来将数据发送到 SNS 以创建警报。</li><li id="9860" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">至于应用程序的代码，人们需要阅读<a class="ae lr" href="https://docs.aws.amazon.com/kinesisanalytics/latest/sqlref/analytics-sql-reference.html" rel="noopener ugc nofollow" target="_blank"> AWS Kinesis 数据分析 SQL 参考文档</a>。SQL for data analytics 应用程序增加了分析功能和技术，如流、泵和窗口。我将在接下来的章节中略微谈到它们。</li></ul><h2 id="d86b" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">整体逻辑</h2><ul class=""><li id="a6cc" class="np nq it kd b ke nk ki nl km ol kq om ku on ka nu nv nw nx bi translated">有<em class="lx">流</em>像带有 TTL(生存时间)数据的表。</li></ul><pre class="lg lh li lj gt oo op oq or aw os bi"><span id="2ba9" class="mw lz it op b gy ot ou l ov ow">CREATE OR REPLACE STREAM "DESTINATION_SQL_STREAM" <br/>(<br/>"field1" DOUBLE, <br/>"field2" INTEGER, <br/>"ANOMALY_SCORE" DOUBLE<br/>);</span></pre><ul class=""><li id="b497" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">还有将实时数据输入数据流的<em class="lx">泵</em>。</li><li id="c6d2" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">您可以用名称<code class="fe ox oy oz op b">SOURCE_SQL_STREAM_001</code>访问您的输入流。</li><li id="adb7" class="np nq it kd b ke ny ki nz km oa kq ob ku oc ka nu nv nw nx bi translated">代码的输出应该是一个流。你需要把结果注入到这条流中。</li></ul><pre class="lg lh li lj gt oo op oq or aw os bi"><span id="f15a" class="mw lz it op b gy ot ou l ov ow">CREATE OR REPLACE PUMP "STREAM_PUMP" <br/>AS INSERT INTO "DESTINATION_SQL_STREAM"</span><span id="3151" class="mw lz it op b gy pa ou l ov ow">SELECT "field1", "field2", ANOMALY_SCORE<br/>FROM TABLE (RANDOM_CUT_FOREST(CURSOR(</span><span id="fc7c" class="mw lz it op b gy pa ou l ov ow">SELECT STREAM "field1", "field2" <br/>FROM "SOURCE_SQL_STREAM_001"<br/>WHERE "field1" &gt; 0 AND "field2" &gt; 0<br/>ORDER BY STEP("TEMP_STREAM".ROWTIME BY INTERVAL '10' SECOND);</span><span id="1b9e" class="mw lz it op b gy pa ou l ov ow">)));</span></pre><blockquote class="pb pc pd"><p id="379a" class="kb kc lx kd b ke ls kg kh ki lt kk kl pe lu ko kp pf lv ks kt pg lw kw kx ka im bi translated">上面的代码片段实际上构建了一个完整的实时数据分析应用程序代码。我们确实从 windows 中的流中读取了<em class="it"> field1 </em>和<em class="it"> field2 </em>，我将在这之后谈到，并将它们应用到后台使用机器学习的<a class="ae lr" href="https://docs.aws.amazon.com/kinesisanalytics/latest/sqlref/sqlrf-random-cut-forest.html" rel="noopener ugc nofollow" target="_blank"><em class="it">RANDOM _ CUT _ FOREST</em></a>内置 SQL 函数中。该模型被增量地训练，并且在为具有足够数据来训练的模型输入一些数据点之后，可以说出一个数据点是否是异常。随机切割森林函数的结果被泵入目标流。</p></blockquote><h2 id="8051" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">Windows 操作系统</h2><p id="0087" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">窗口让我们能够对数据执行聚合功能。例如，要对实时数据进行计数，我们需要为数据设定边界。</p><p id="0036" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">窗口有不同的技术，但我将只通过最常用的窗口:翻滚和滑动。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi ph"><img src="../Images/054400aaae59817b73c1baf351525c72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FhEgj3Bq1ByYyDlhLluVQA.png"/></div></div></figure><ul class=""><li id="f7da" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">滚动窗口分批分离数据。这些批次的界限通常以时间为基础选择，很少以数据计数为基础。我们想要使用滚动窗口的根本原因是我们不会两次使用相同的数据点。</li></ul><pre class="lg lh li lj gt oo op oq or aw os bi"><span id="c5a1" class="mw lz it op b gy ot ou l ov ow">GROUP BY field1,<br/>STEP("SOURCE_SQL_STREAM_001".ROWTIME BY INTERVAL '60' SECOND);</span></pre><ul class=""><li id="d484" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">进行时基聚合时，滑动窗口更有用。有一个固定大小的窗口，它逐渐向右移动。你可能想用它来观察一个峰值点。</li></ul><pre class="lg lh li lj gt oo op oq or aw os bi"><span id="5ef0" class="mw lz it op b gy ot ou l ov ow">WINDOW W1 AS (    <br/>PARTITION BY field1     <br/>RANGE INTERVAL '1' MINUTE PRECEDING);</span></pre><p id="68e8" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">您还可以构建自定义窗口或使用交错窗口，每当新数据点到达时都会创建一个窗口。</p><h2 id="a9e9" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">高级用法</h2><p id="a91d" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">Kinesis 数据分析 SQL 引擎让您可以灵活地创建更复杂的逻辑来处理更困难的情况。</p><ul class=""><li id="16cd" class="np nq it kd b ke ls ki lt km nr kq ns ku nt ka nu nv nw nx bi translated">如果我们只想发送异常值大于特定值的记录，该怎么办？或者，如果该分数需要与一些其他参考数据聚合在一起呢？为了解决这些问题，可以在应用程序中定义第二个流。异常检测算法的结果应该被泵送到这个新的临时流中，而不是我们的目的流中。然后，我们有另一个窗口来对我们的结果数据进行新的聚合。这种新聚合的结果现在可以被注入到我们的目标流中。</li></ul><p id="992e" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ka im bi translated">从上面的例子可以看出，可以有多个不同窗口类型的流。</p><h1 id="0907" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">结论</h1><p id="975a" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">我已经经历了灵活的结构，强大的 SQL 引擎与实现流技术，自我管理服务的 AWS。我们已经创建了一个示例实时数据分析应用程序，用于检测数据中的异常。我们利用 AWS Lambda 在手动数据分析应用之前和之后对数据进行预处理和后处理。我们使用 AWS SNS 创建了一个警报系统，一旦出现异常情况，该系统就会实时通知我们。</p><h2 id="0d3b" class="mw lz it bd ma mx my dn me mz na dp mi km nb nc mm kq nd ne mq ku nf ng mu nh bi translated">感兴趣的</h2><p id="ce60" class="pw-post-body-paragraph kb kc it kd b ke nk kg kh ki nl kk kl km nm ko kp kq nn ks kt ku no kw kx ka im bi translated">Zynga 技术团队展示了他们对 Kinesis 数据分析的使用，以及他们如何使用它来解决复杂的情况。</p></div></div>    
</body>
</html>