<html>
<head>
<title>CI/CD fbprophet to AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI/CD fbprophet 到 AWS Lambda</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ci-cd-fbprophet-on-aws-lambda-using-circleci-b7f584115737?source=collection_archive---------21-----------------------#2019-08-17">https://towardsdatascience.com/ci-cd-fbprophet-on-aws-lambda-using-circleci-b7f584115737?source=collection_archive---------21-----------------------#2019-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="72f5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用 CircleCI 将预测整合到您的开发流程中</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/426ac3eb7d8dd055c65eb75851954455.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qXlfnAZ4xGpRqdTdZfQjow.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Greg Studio / Unsplash</figcaption></figure><p id="5847" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大约一年前，我试图弄清楚如何让 fbprophet 在 AWS Lambda 上进行预测工作，并最终让它工作起来。从那时起，对无服务器预测的需求成熟了，越来越多的人对无缝技术感兴趣，导致了一些非常有用的东西，如由<a class="ls lt ep" href="https://medium.com/u/9da2f3392040?source=post_page-----b7f584115737--------------------------------" rel="noopener" target="_blank">马克·梅斯</a>为 AWS Lambda 开发的 fbprophet <a class="ae lr" href="https://medium.com/@marc.a.metz/docker-run-rm-it-v-pwd-var-task-lambci-lambda-build-python3-7-bash-c7d53f3b7eb2" rel="noopener">汇编器</a>。</p><p id="205f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让软件包正常工作的一个自然发展是让它成为你的 CI/CD 过程的一部分。我需要经常部署我的预测代码——将预测微服务集成到其他应用程序中——手动生成和上传 zip 不是一个选项。我要分享一下我是如何为 CircleCI 解决的。希望您会发现它对其他 CI/CD 解决方案有用并可重用。</p><p id="5d95" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一致部署的基础是预装在 AWS Lambda Python 3.6 环境中的这个<a class="ae lr" href="https://hub.docker.com/r/amacenov/aws-lambda-fbprophet" rel="noopener ugc nofollow" target="_blank"> Docker 映像</a>。它有完整的、未编辑的 fbprophet，因此可以在 CI/CD 端进行定制。例如，您可能希望也可能不希望从 Docker 中卸载 matplotlib。</p><p id="22e4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以随意使用这张图片。下面是它的文档(根据马克·梅茨的而建)，这里是整个回购<a class="ae lr" href="https://github.com/matse004/docker-prophet" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="kg kh ki kj gt lu lv lw lx aw ly bi"><span id="08f7" class="lz ma iq lv b gy mb mc l md me"># Dockerfile</span><span id="d33b" class="lz ma iq lv b gy mf mc l md me">FROM lambci/lambda:build-python3.6</span><span id="7caa" class="lz ma iq lv b gy mf mc l md me">ENV <em class="mg">VIRTUAL_ENV</em>=venv<br/>ENV <em class="mg">PATH </em>$<em class="mg">VIRTUAL_ENV</em>/bin:$<em class="mg">PATH</em></span><span id="52a1" class="lz ma iq lv b gy mf mc l md me">RUN python3 -m venv $<em class="mg">VIRTUAL_ENV<br/></em>RUN . $<em class="mg">VIRTUAL_ENV</em>/bin/activate</span><span id="f4b8" class="lz ma iq lv b gy mf mc l md me">COPY requirements.txt .<br/>RUN pip install — upgrade pip<br/>RUN pip install -r requirements.txt</span><span id="5e96" class="lz ma iq lv b gy mf mc l md me"># requirements.txt<br/>pystan==2.18<br/>fbprophet</span></pre><p id="7333" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是我用的 CircleCI config.yml 代码。它利用 Docker 中设置的 virtualenv 的路径来准备 fbprophet 进行部署。</p><pre class="kg kh ki kj gt lu lv lw lx aw ly bi"><span id="cc1f" class="lz ma iq lv b gy mb mc l md me"># config.yml</span><span id="8ac5" class="lz ma iq lv b gy mf mc l md me"># assumes the repo structure like this:<br/># repo_name<br/>#   main_repo_folder<br/>#      ...<br/>#   name_of_lambda_handler.py<br/>#   requirements.txt</span><span id="c094" class="lz ma iq lv b gy mf mc l md me">version: 2<br/>jobs:<br/>  build:<br/>    docker:<br/>      - image: amacenov/aws-lambda-fbprophet<br/>        environment:<br/>          AWS_ACCESS_KEY_ID: 'xxx'<br/>          AWS_SECRET_ACCESS_KEY: 'xxx'<br/>          AWS_DEFAULT_REGION: 'xxx'<br/><br/>    steps:<br/>      - checkout<br/><br/>      - restore_cache:<br/>          keys:<br/>            - v1-dependencies- <em class="mg">#{{ checksum "requirements.txt" }}<br/><br/>      </em>- run:<br/>          name: install dependencies<br/>          command: |<br/>            VIRTUAL_ENV=/var/task/$VIRTUAL_ENV  # path was set up in the Docker image<br/>            source $VIRTUAL_ENV/bin/activate<br/>            pip install -r requirements.txt<br/><br/>      - run:<br/>          name: make prophet small enough for lambda<br/>          command: |<br/>            VIRTUAL_ENV=/var/task/$VIRTUAL_ENV<br/>            source $VIRTUAL_ENV/bin/activate<br/>            pip uninstall -y matplotlib<br/>            find "$VIRTUAL_ENV/lib/python3.6/site-packages" -name "test" | xargs rm -rf<br/>            find "$VIRTUAL_ENV/lib/python3.6/site-packages" -name "tests" | xargs rm -rf<br/>            rm -rf "$VIRTUAL_ENV/lib/python3.6/site-packages/pystan/stan/src"<br/>            rm -rf "$VIRTUAL_ENV/lib/python3.6/site-packages/pystan/stan/lib/stan_math/lib"<br/><br/>      - run:<br/>          name: prepare zip<br/>          command: |<br/>            VIRTUAL_ENV=/var/task/$VIRTUAL_ENV<br/>            pushd $VIRTUAL_ENV/lib/python3.6/site-packages/<br/>            zip -9qr ~/repo/name_of_the_zip.zip *<br/>            popd<br/>            zip -9r name_of_the_zip.zip main_repo_folder/<br/>            zip -9 name_of_the_zip.zip name_of_lambda_handler.py</span><span id="705b" class="lz ma iq lv b gy mf mc l md me">- save_cache:<br/>          paths:<br/>            - ./cache<br/>          key: v1-dependencies- <em class="mg">#{{ checksum "requirements.txt" }}<br/><br/>      </em>- run:<br/>          name: push to s3<br/>          command: aws s3 cp name_of_the_zip.zip s3://your_s3_bucket_name/name_of_the_zip.zip<br/><br/>      - run:<br/>          name: push function code<br/>          command: &gt;<br/>            aws lambda update-function-code --function-name your_aws_lambda_function_arn<br/>            --s3-bucket your_s3_bucket_name<br/>            --s3-key name_of_the_zip.zip<br/><br/><br/>workflows:<br/>  version: 2<br/>  deploy:<br/>    jobs:<br/>      - build:<br/>          filters:<br/>            branches:<br/>              only: [master]</span></pre><p id="70ee" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下一次将分享更多关于我如何大规模使用 fbprohet 的信息。</p><p id="e0d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">干杯！</p></div></div>    
</body>
</html>