<html>
<head>
<title>Productionize a Machine Learning Model with a Django API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Django API 生产机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/productionize-a-machine-learning-model-with-a-django-api-c774cb47698c?source=collection_archive---------1-----------------------#2019-12-31">https://towardsdatascience.com/productionize-a-machine-learning-model-with-a-django-api-c774cb47698c?source=collection_archive---------1-----------------------#2019-12-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f0aa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于在 Django API 背后部署机器学习模型的教程。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/307dd981ef1f8095c20c9723effd872c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GF-Zyjl6oHohdkdmzKptXg.png"/></div></div></figure><p id="9144" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">之前，我写过一篇关于用烧瓶制作 ML 模型的教程。</p><p id="3ed7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Flask 的重量更轻，但是如果我们需要更多的功能，django 会附带它。</p><p id="81ff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我构建了一个 API，通过 sklearn 模型进行预测。下面是我一步一步的代码。</p><p id="e9d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">本教程包含 3 个部分:</strong> <br/> 1。训练 ML 模型<br/> 2。构建 django 应用程序<br/> 3。测试 API</p><h1 id="3502" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">第 1 部分:训练 ML 模型</h1><p id="e784" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">第一部分可以在笔记本上完成。</p><p id="6ac9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这不是关于机器学习的教程。所以我们将根据虚构的数据训练一个模型。也就是说，它将像你可以训练的任何其他 sklearn 模型一样工作。</p><p id="b852" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的模型将根据动物发出的噪音来检测动物是否是狗。</p><p id="0a5f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创造虚构的数据！在每个内部列表中，第一个索引是动物的声音，第二个索引是指示动物是否是狗的布尔标签。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="3ff6" class="mt ls it mp b gy mu mv l mw mx">data = [<br/>    ['woof', 1],<br/>    ['bark', 1],<br/>    ['ruff', 1],<br/>    ['bowwow', 1],<br/>    ['roar', 0],<br/>    ['bah', 0],<br/>    ['meow', 0],<br/>    ['ribbit', 0],<br/>    ['moo', 0],<br/>    ['yip', 0],<br/>    ['pika', 0]<br/>]</span></pre><p id="12dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将上述内容转换为功能和标签列表。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="7418" class="mt ls it mp b gy mu mv l mw mx">X = []<br/>y = []</span><span id="b505" class="mt ls it mp b gy my mv l mw mx">for i in data:<br/>    X.append( i[0] )<br/>    y.append( i[1] )</span></pre><p id="3dd7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">安装矢量器并转换要素。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="fb5f" class="mt ls it mp b gy mu mv l mw mx">from sklearn.feature_extraction.text import CountVectorizer</span><span id="fa23" class="mt ls it mp b gy my mv l mw mx">vectorizer = CountVectorizer()<br/>X_vectorized = vectorizer.fit_transform(X)</span></pre><p id="31f7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">训练线性回归。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="1967" class="mt ls it mp b gy mu mv l mw mx">from sklearn.linear_model import LinearRegression<br/>import numpy as np</span><span id="b781" class="mt ls it mp b gy my mv l mw mx">regressor = LinearRegression()<br/>regressor.fit(X_vectorized, y)</span></pre><p id="0356" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在用几个例子来测试一下。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="7d79" class="mt ls it mp b gy mu mv l mw mx">test_feature = vectorizer.transform(['woof'])<br/>prediction = regressor.predict(test_feature)<br/>print(prediction)</span><span id="f067" class="mt ls it mp b gy my mv l mw mx">test_feature = vectorizer.transform(['ribbit'])<br/>prediction = regressor.predict(test_feature)<br/>print(prediction)</span><span id="2c9a" class="mt ls it mp b gy my mv l mw mx">test_feature = vectorizer.transform(['meoww'])<br/>prediction = regressor.predict(test_feature)<br/>print(prediction)</span><span id="5215" class="mt ls it mp b gy my mv l mw mx">#=&gt; [1.]<br/>#=&gt; [0.]<br/>#=&gt; [0.36363636]</span></pre><p id="da78" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">完美。</p><p id="02cd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将我们的模型打包成字节流，这样我们就可以将它们存储在应用程序中。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="a4c5" class="mt ls it mp b gy mu mv l mw mx">import pickle</span><span id="8b2c" class="mt ls it mp b gy my mv l mw mx">pickl = {<br/>    'vectorizer': vectorizer,<br/>    'regressor': regressor<br/>}<br/>pickle.dump( pickl, open( 'models' + ".p", "wb" ) )</span></pre><h1 id="1609" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">第 2 部分:构建 django 应用程序</h1><p id="b8f8" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">打开命令行，进入存储 django 项目的目录。为这个应用程序创建一个目录并<code class="fe mz na nb mp b">cd</code>到其中。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="82a4" class="mt ls it mp b gy mu mv l mw mx">mkdir DjangoMLAPI &amp;&amp; cd DjangoMLAPI</span></pre><p id="8508" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建虚拟环境并安装所需的软件包。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="3797" class="mt ls it mp b gy mu mv l mw mx">python3 -m venv env<br/>source env/bin/activate<br/>pip install django djangorestframework sklearn numpy</span></pre><p id="14d2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在创建一个 django 项目，这个目录包含了我们正在处理的所有代码。如果我们需要的话，这还包括数据库配置和应用程序设置。</p><p id="f3c6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">虽然“项目”实际上代表了我们正在构建的应用程序，但是 django 使用术语“app”来指代项目中的包。我们的主包将被称为<code class="fe mz na nb mp b">api</code>。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="8fde" class="mt ls it mp b gy mu mv l mw mx">django-admin startproject api</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/29a6005a446034b46541eef85727813e.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*6AcpXRIp_YoUJrv5G_kt9g.png"/></div></figure><p id="b1f9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这生成了一堆支持我们的项目所需的样板代码。它看起来像左边的文件树。</p><p id="371b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">外层的<code class="fe mz na nb mp b">/api</code>只是一个包含我们所有项目代码的文件夹。</p><p id="a154" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">内部的<code class="fe mz na nb mp b">/api</code>是我们项目的主要 python 包。</p><p id="7b8b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们将在项目中生成一个“应用程序”。这将为我们 API 背后的机器学习提供动力。</p><p id="69be" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们把这个叫做预测器。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="74cf" class="mt ls it mp b gy mu mv l mw mx">cd api<br/>python manage.py startapp predictor</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/9f573ee4c019630aefeb457c3f0ccaa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*OP-CwjN9FURInwIWdlq3Ag.png"/></div></figure><p id="1ca0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">完整的目录现在看起来像左边的文件树。</p><p id="e7d5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们在这里添加了一个名为<code class="fe mz na nb mp b">/predictor</code>的文件夹，里面有很多文件。</p><p id="288d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的用例甚至不需要这些文件中的几个。在本教程的最后，我们将继续删除它们。</p><p id="229e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mz na nb mp b">apps.py</code>是我们定义配置类的地方。这是只运行一次(而不是每次请求都运行)的代码，所以我们最终会将代码放在那里来加载我们的模型。</p><p id="9acd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将包含在每个请求上运行的代码。所以我们把矢量化和回归逻辑放在那里。</p><p id="fdad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在让我们将这个应用程序添加到<code class="fe mz na nb mp b">INSTALLED_APPS</code>中。打开<code class="fe mz na nb mp b">/api/api/settings.py</code>，给<code class="fe mz na nb mp b">INSTALLED_APPS</code>添加<code class="fe mz na nb mp b">'predictor'</code>。它应该如下图所示。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="5cc5" class="mt ls it mp b gy mu mv l mw mx">INSTALLED_APPS = [<br/>    'django.contrib.admin',<br/>    'django.contrib.auth',<br/>    'django.contrib.contenttypes',<br/>    'django.contrib.sessions',<br/>    'django.contrib.messages',<br/>    'django.contrib.staticfiles',<br/>    'predictor'<br/>]</span></pre><p id="2b66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在在<code class="fe mz na nb mp b">/predictor</code>中创建一个名为<code class="fe mz na nb mp b">/models</code>的文件夹。把你训练好的腌渍模型移到这个目录。</p><p id="8884" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，在真实的生产环境中，我会将它从应用程序中分离出来(可能使用 S3)，这样我们就不需要在每次更新模型时都重新部署应用程序。但在这里，我们只是将模型包含在应用程序中。</p><p id="328c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将这一行也添加到设置中。我们将使用它来加载我们的模型。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="7c46" class="mt ls it mp b gy mu mv l mw mx">MODELS = os.path.join(BASE_DIR, 'predictor/models')</span></pre><p id="9372" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在编写在应用程序启动时加载我们的模型的代码。在<code class="fe mz na nb mp b">/api/predictor/apps.py</code>里面使用这个代码。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="33a6" class="mt ls it mp b gy mu mv l mw mx">from django.apps import AppConfig<br/>from django.conf import settings<br/>import os<br/>import pickle</span><span id="e97d" class="mt ls it mp b gy my mv l mw mx">class PredictorConfig(AppConfig):</span><span id="ac59" class="mt ls it mp b gy my mv l mw mx">    # create path to models<br/>    path = os.path.join(settings.MODELS, 'models.p')<br/> <br/>    # load models into separate variables<br/>    # these will be accessible via this class<br/>    with open(path, 'rb') as pickled:<br/>       data = pickle.load(pickled)</span><span id="16b5" class="mt ls it mp b gy my mv l mw mx">    regressor = data['regressor']<br/>    vectorizer = data['vectorizer']</span></pre><p id="5774" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在创建一个支持我们回归逻辑的视图。打开<code class="fe mz na nb mp b">/api/predictor/views.py</code>并用此代码更新。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="266f" class="mt ls it mp b gy mu mv l mw mx">from django.shortcuts import render</span><span id="2e84" class="mt ls it mp b gy my mv l mw mx">from .apps import PredictorConfig</span><span id="9970" class="mt ls it mp b gy my mv l mw mx">from django.http import JsonResponse<br/>from rest_framework.views import APIView</span><span id="5dfa" class="mt ls it mp b gy my mv l mw mx">class call_model(APIView):<br/>    def get(self,request):<br/>        if request.method == 'GET':</span><span id="7117" class="mt ls it mp b gy my mv l mw mx">            # get sound from request<br/>            sound = request.GET.get('sound')<br/>   <br/>            # vectorize sound<br/>            vector = PredictorConfig.vectorizer.transform([sound])</span><span id="06b8" class="mt ls it mp b gy my mv l mw mx">            # predict based on vector<br/>            prediction = PredictorConfig.regressor.predict(vector)[0]</span><span id="fe47" class="mt ls it mp b gy my mv l mw mx">            # build response<br/>            response = {'dog': prediction}</span><span id="f440" class="mt ls it mp b gy my mv l mw mx">            # return response<br/>            return JsonResponse(response)</span></pre><p id="7b7e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">设置路由，将 URL 映射到<code class="fe mz na nb mp b">/api/api/urls.py</code>中的视图。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="9a94" class="mt ls it mp b gy mu mv l mw mx">from django.urls import path<br/>from predictor import views</span><span id="8f44" class="mt ls it mp b gy my mv l mw mx">urlpatterns = [<br/>    path('classify/', views.call_model.as_view())<br/>]</span></pre><p id="21f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可以删除以下文件，因为我们不需要它们。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="4e63" class="mt ls it mp b gy mu mv l mw mx">api/predictor/tests.py<br/>api/predictor/models.py<br/>api/predictor/admin.py</span></pre><h1 id="7b2d" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">第 3 部分:测试 API</h1><p id="5151" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">现在启动服务器。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="be9c" class="mt ls it mp b gy mu mv l mw mx">python manage.py runserver</span></pre><p id="7b77" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">并发出几个 curl 请求来测试它。你也可以直接在浏览器中输入网址。</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="2a3d" class="mt ls it mp b gy mu mv l mw mx">curl -X GET <a class="ae lq" href="http://127.0.0.1:8000/classify/?sound=meow" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8000/classify/?sound=meow</a><br/>#=&gt; {"dog": 0.0}</span><span id="9a68" class="mt ls it mp b gy my mv l mw mx">curl -X GET <a class="ae lq" href="http://127.0.0.1:8000/classify/?sound=woof" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8000/classify/?sound=woof</a><br/>#=&gt; {"dog": 1.0}</span></pre><p id="bd73" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">放松点皮兹。起作用了！接近<code class="fe mz na nb mp b">1</code>的数字表示是狗，接近<code class="fe mz na nb mp b">0</code>的数字表示不是狗。</p><p id="6e89" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们找到了。一个 django API，加载并运行一个经过训练的机器学习模型！</p></div></div>    
</body>
</html>