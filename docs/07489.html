<html>
<head>
<title>Deploying your first Deep Learning Model: MNIST in production environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">部署您的第一个深度学习模型:生产环境中的 MNIST</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-your-first-deep-learning-model-mnist-in-production-environment-510bfdc4808d?source=collection_archive---------19-----------------------#2019-10-19">https://towardsdatascience.com/deploying-your-first-deep-learning-model-mnist-in-production-environment-510bfdc4808d?source=collection_archive---------19-----------------------#2019-10-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="2580" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">让你的深度学习模型飞起来</h2><div class=""/><p id="68c1" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">如何在生产环境中部署您的 MNIST 模型</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/d3abc43c4a111768338326a0be13b8c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qofNH7sKIVji5UF-"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk">Photo by <a class="ae ln" href="https://unsplash.com/@ravi_roshan_inc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ravi Roshan</a> on <a class="ae ln" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="75d9" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated"><a class="ae ln" href="http://yann.lecun.com/exdb/mnist/" rel="noopener ugc nofollow" target="_blank"><strong class="kb jd"/></a>数据集对于像我们这样的大多数 ML 爱好者来说是一个 hello world 数据集。在某个时候，每个已经开始这个领域的旅程或愿意开始的人都会遇到这个数据集，并肯定会得到它。</p><blockquote class="lo lp lq"><p id="8fe7" class="jz ka lr kb b kc kd ke kf kg kh ki kj ls kl km kn lt kp kq kr lu kt ku kv kw im bi translated">对于那些希望在真实世界数据上尝试学习技术和模式识别方法，同时花费最少精力进行预处理和格式化的人来说，这是一个很好的数据集。——扬·勒昆</p></blockquote><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/5bf3081c5bf4cef0407d058931405075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/0*vMa8mjiz7BbsCXQ3.png"/></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk"><a class="ae ln" href="http://yann.lecun.com/exdb/mnist/" rel="noopener ugc nofollow" target="_blank">MNIST</a></figcaption></figure><h1 id="4a1a" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">我们在建造什么？</h1><p id="f0da" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">在这篇文章中，我将讲述每个完成 MNIST 的人如何在生产环境中使用 Django 和 Heroku 将训练好的模型部署为漂亮的 web 应用程序。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/165abe47abd820cfe560b86c5674e57d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*O7dIAVNyGA-J4U3fcQLZNg.gif"/></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk">MNIST Web App Demo</figcaption></figure><h2 id="4b65" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">先决条件</h2><p id="c0b7" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">您应该具备以下基本知识:</p><ol class=""><li id="fc53" class="nl nm it kb b kc kd kg kh kk nn ko no ks np kw nq nr ns nt bi translated">Python 编程语言</li><li id="b51b" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated"><a class="ae ln" href="https://www.djangoproject.com/" rel="noopener ugc nofollow" target="_blank"> Django </a> — Web 应用框架</li><li id="0381" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated"><a class="ae ln" href="https://dashboard.heroku.com/" rel="noopener ugc nofollow" target="_blank">Heroku</a>——平台即服务(<strong class="kb jd">可选</strong>:你将在这篇文章中学习如何使用它)</li></ol><p id="fe55" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">并且你应该有一个基于<strong class="kb jd"> Keras </strong>的<strong class="kb jd"> MNIST </strong>的模型文件；<strong class="kb jd"> </strong>或者你可以马上开始用<strong class="kb jd"/><a class="ae ln" href="https://colab.research.google.com/drive/16wrpQXdtYLjp2Kvtl4uxCyX4oVmgmHvo" rel="noopener ugc nofollow" target="_blank"><strong class="kb jd"/></a>的小本子整理文件。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="cbcc" class="lw lx it bd ly lz og mb mc md oh mf mg mh oi mj mk ml oj mn mo mp ok mr ms mt bi translated">准备好您的后端</h1><p id="b0c0" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">首先，让我们使用 CMD 或 bash 终端安装 Django 如果你还没有这样做。</p><blockquote class="lo lp lq"><p id="6b4c" class="jz ka lr kb b kc kd ke kf kg kh ki kj ls kl km kn lt kp kq kr lu kt ku kv kw im bi translated">如果你以前没有 Django 的经验，网上有很多免费的资源。请考虑看看。对于使用 Python 构建 Web 应用程序来说，这是一个非常棒的框架。没什么可失去的。</p></blockquote><h2 id="da7b" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">启动项目</h2><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/709d8deef16b1702303c7cc9828c6952.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*j6QXFviQla8-Cjs-f07W0A.gif"/></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk"><a class="ae ln" href="https://media.giphy.com/media/Y3MbPtRn74uR3Ziq4P/giphy.gif" rel="noopener ugc nofollow" target="_blank">SOURCE</a></figcaption></figure><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="fed0" class="na lx it on b gy or os l ot ou">pip install django</span></pre><p id="b05d" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这将为您安装 Django，您将可以访问 Django CLI 来创建您的项目文件夹。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="1597" class="na lx it on b gy or os l ot ou">django-admin startproject digitrecognizer</span></pre><p id="adfa" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">我将把我的项目命名为<strong class="kb jd"> digitrecognizer </strong>你可以随意命名。一旦你这样做了，你会看到一个文件夹，里面有一些文件。</p><p id="85f6" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">让我们使用<strong class="kb jd"> mange.py </strong> cli 在该文件夹中创建我们的新应用程序<strong class="kb jd"> main </strong>。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="20b1" class="na lx it on b gy or os l ot ou">python manage.py startapp main</span></pre><p id="f827" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这将为您创建一个名为<strong class="kb jd"> main </strong>的新应用程序。现在我们可以在<strong class="kb jd"> views.py </strong>文件中编写我们的主要代码了。</p><h2 id="55eb" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">代码部分</h2><p id="cfa1" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">让我们在<strong class="kb jd"> views.py </strong>文件中编写一些代码:</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="fe87" class="na lx it on b gy or os l ot ou">## Views.py</span><span id="1eb5" class="na lx it on b gy ov os l ot ou">from django.shortcuts import render<br/>from scipy.misc.pilutil import imread, imresize<br/>import numpy as np<br/>import re<br/>import sys<br/>import os<br/>sys.path.append(os.path.abspath("./model"))<br/>from .utils import *<br/>from django.http import JsonResponse<br/>from django.views.decorators.csrf import csrf_exempt<br/>global model, graph<br/>model, graph = init()<br/>import base64</span><span id="67b2" class="na lx it on b gy ov os l ot ou">OUTPUT = os.path.join(os.path.dirname(__file__), 'output.png')</span><span id="aac1" class="na lx it on b gy ov os l ot ou">from PIL import Image<br/>from io import BytesIO</span><span id="9da5" class="na lx it on b gy ov os l ot ou">def getI420FromBase64(codec):<br/>    base64_data = re.sub('^data:image/.+;base64,', '', codec)<br/>    byte_data = base64.b64decode(base64_data)<br/>    image_data = BytesIO(byte_data)<br/>    img = Image.open(image_data)<br/>    img.save(OUTPUT)</span><span id="0e01" class="na lx it on b gy ov os l ot ou">def convertImage(imgData):<br/>    getI420FromBase64(imgData)</span><span id="fd10" class="na lx it on b gy ov os l ot ou"><a class="ae ln" href="http://twitter.com/csrf_exempt" rel="noopener ugc nofollow" target="_blank">@csrf_exempt</a><br/>def predict(request):</span><span id="ca22" class="na lx it on b gy ov os l ot ou">imgData = request.POST.get('img')</span><span id="9dd0" class="na lx it on b gy ov os l ot ou">convertImage(imgData)<br/>    x = imread(OUTPUT, mode='L')<br/>    x = np.invert(x)<br/>    x = imresize(x, (28, 28))<br/>    x = x.reshape(1, 28, 28, 1)<br/>    with graph.as_default():<br/>        out = model.predict(x)<br/>        print(out)<br/>        print(np.argmax(out, axis=1))<br/>        response = np.array_str(np.argmax(out, axis=1))<br/>        return JsonResponse({"output": response})</span></pre><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/d527f558f9ea94313358490a02f0ddec.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/0*n3TU1qHP10F32Mzs"/></div></figure><p id="ebc3" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">看起来很多，其实不是！😂相信我。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="7aff" class="lw lx it bd ly lz og mb mc md oh mf mg mh oi mj mk ml oj mn mo mp ok mr ms mt bi translated">我们来分解一下</h1><p id="6e6d" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">在代码的最开始，我们导入每个需要的库和模块。</p><h2 id="d053" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">进口</h2><p id="0264" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">每一个导入都是不言自明的，我也评论了重要的部分，考虑看看它。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="a9e0" class="na lx it on b gy or os l ot ou">from django.shortcuts import render<br/>from scipy.misc.pilutil import imread, imresize<br/>import numpy as np<br/>import re<br/>import sys</span><span id="ef29" class="na lx it on b gy ov os l ot ou">## Apending MNIST model path<br/>import os<br/>sys.path.append(os.path.abspath("./model"))</span><span id="e84d" class="na lx it on b gy ov os l ot ou">## custom utils file create for writing some helper func<br/>from .utils import *</span><span id="f8e0" class="na lx it on b gy ov os l ot ou">from django.http import JsonResponse<br/>from django.views.decorators.csrf import csrf_exempt</span><span id="a6b4" class="na lx it on b gy ov os l ot ou">## Declaring global variable<br/>global model, graph</span><span id="9089" class="na lx it on b gy ov os l ot ou">## initializing MNIST model file (It comes from utils.py file)<br/>model, graph = init()</span><span id="a415" class="na lx it on b gy ov os l ot ou">import base64<br/>from PIL import Image<br/>from io import BytesIO</span><span id="25b4" class="na lx it on b gy ov os l ot ou">## Declaring output path to save our image</span><span id="22d9" class="na lx it on b gy ov os l ot ou">OUTPUT = os.path.join(os.path.dirname(__file__), 'output.png')</span></pre><h2 id="bcfa" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">什么是 utils.py 文件？</h2><p id="28a0" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">导入所需的库之后，让我们编写一些助手函数来处理一个<strong class="kb jd"> utils.py </strong>文件中的 MNIST 模型。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="204b" class="na lx it on b gy or os l ot ou">## utils.py</span><span id="5532" class="na lx it on b gy ov os l ot ou">from keras.models import model_from_json<br/>from scipy.misc.pilutil import imread, imresize, imshow<br/>import tensorflow as tf<br/>import os</span><span id="b9c5" class="na lx it on b gy ov os l ot ou">JSONpath = os.path.join(os.path.dirname(__file__), 'models', 'model.json')<br/>MODELpath = os.path.join(os.path.dirname(__file__), 'models', 'mnist.h5')</span><span id="ea7b" class="na lx it on b gy ov os l ot ou">def init():<br/>    json_file = open(JSONpath, 'r')<br/>    loaded_model_json = json_file.read()<br/>    json_file.close()<br/>    loaded_model = model_from_json(loaded_model_json)<br/>    loaded_model.load_weights(MODELpath)<br/>    print("Loaded Model from disk")<br/>    loaded_model.compile(loss='categorical_crossentropy',<br/>                         optimizer='adam', metrics=['accuracy'])</span><span id="aecb" class="na lx it on b gy ov os l ot ou">    graph = tf.get_default_graph()</span><span id="563f" class="na lx it on b gy ov os l ot ou">    return loaded_model, graph</span></pre><p id="37a1" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这个文件包含了<strong class="kb jd"> init </strong>函数，它基本上初始化了我们使用<strong class="kb jd"> Keras </strong>保存的<strong class="kb jd"> MNIST </strong>模型文件。它抓取或模型文件加载它们，并使用<strong class="kb jd"> adam </strong> optimizer 编译它们，使它们为预测做好准备。</p><p id="b12f" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这里，我们使用<strong class="kb jd">分类交叉熵</strong>作为我们的损失函数，<strong class="kb jd"> adam </strong>作为我们的优化器，而<strong class="kb jd">准确性</strong>作为我们的性能测量指标。</p><p id="0f0a" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">你可以从<a class="ae ln" href="https://machinelearningmastery.com/save-load-keras-deep-learning-models/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb jd">这里</strong> </a>学习如何使用 Keras 保存模型。</p><h2 id="889a" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">继续查看. py</h2><p id="78fd" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">这里我们有另一个帮助函数来帮助我们转换我们的<strong class="kb jd"> BASE64 </strong>图像文件；它是从客户端抓取到一个<strong class="kb jd"> PNG </strong>文件；并保存为<strong class="kb jd">输出</strong>变量中的任何内容；即在当前目录下保存为 output.png 文件。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="2ba5" class="na lx it on b gy or os l ot ou">def getI420FromBase64(codec):<br/>    base64_data = re.sub('^data:image/.+;base64,', '', codec)<br/>    byte_data = base64.b64decode(base64_data)<br/>    image_data = BytesIO(byte_data)<br/>    img = Image.open(image_data)<br/>    img.save(OUTPUT)</span><span id="d670" class="na lx it on b gy ov os l ot ou">def convertImage(imgData):<br/>    getI420FromBase64(imgData)</span></pre><h2 id="e91f" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">编写我们的 API</h2><p id="5cf9" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">现在让我们把主要的 API 写到:</p><ol class=""><li id="d427" class="nl nm it kb b kc kd kg kh kk nn ko no ks np kw nq nr ns nt bi translated">获取客户端提交的 base64 图像文件</li><li id="7684" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">将其转换成 png 文件</li><li id="fee8" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">处理它以适应我们的训练模型文件</li><li id="7a40" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">使用我们之前的帮助函数预测图像，并获得相应的性能指标</li><li id="cd8a" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">将其作为 JSON 响应返回</li></ol><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="2012" class="na lx it on b gy or os l ot ou"><a class="ae ln" href="http://twitter.com/csrf_exempt" rel="noopener ugc nofollow" target="_blank">@csrf_exempt</a><br/>def predict(request):</span><span id="da02" class="na lx it on b gy ov os l ot ou">imgData = request.POST.get('img')</span><span id="222c" class="na lx it on b gy ov os l ot ou">convertImage(imgData)<br/>    x = imread(OUTPUT, mode='L')<br/>    x = np.invert(x)<br/>    x = imresize(x, (28, 28))<br/>    x = x.reshape(1, 28, 28, 1)<br/>    with graph.as_default():<br/>        out = model.predict(x)<br/>        print(out)<br/>        print(np.argmax(out, axis=1))<br/>        response = np.array_str(np.argmax(out, axis=1))<br/>        return JsonResponse({"output": response})</span></pre><p id="2035" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">它使用<strong class="kb jd"> csrf_exempt </strong> decorator，因为 Django 对安全性非常严格。通过使用它，我们只是禁用 CSRF 验证。</p><p id="aa49" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">现在，我们已经完成了应用程序后端代码的编写，可以对给定图像的标签进行分类。</p><h2 id="6ccd" class="na lx it bd ly nb nc dn mc nd ne dp mg kk nf ng mk ko nh ni mo ks nj nk ms iz bi translated">提供路线</h2><p id="6fe3" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">现在，让我们为我们的主要功能提供一条路线。</p><p id="da73" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">转到 settings.py 和 urls.py 文件所在的项目文件夹。</p><p id="4813" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">在 INSTALLED_APPS 数组下的 settings.py 文件中，安装我们之前创建的用于编写函数的主应用程序。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="f0bf" class="na lx it on b gy or os l ot ou">INSTALLED_APPS = [<br/>    'django.contrib.admin',<br/>    'django.contrib.auth',<br/>    'django.contrib.contenttypes',<br/>    'django.contrib.sessions',<br/>    'django.contrib.messages',<br/>    'django.contrib.staticfiles',</span><span id="5256" class="na lx it on b gy ov os l ot ou">    ## our main application<br/>    'main'<br/>]</span></pre><p id="0e2e" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">之后，返回 urls.py 文件，编写一条到达我们的 predict 函数的路径。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="a926" class="na lx it on b gy or os l ot ou">from django.contrib import admin<br/>from django.urls import path, include<br/>from main.views import predict</span><span id="08e4" class="na lx it on b gy ov os l ot ou">urlpatterns = [<br/>    path('', include('main.urls')),<br/>    path('api/predict/', predict)<br/>]</span></pre><p id="a4db" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">保存所有东西，现在我们的后端 API 已经准备好了。</p><h1 id="741a" class="lw lx it bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">前端部分</h1><p id="ea45" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">现在是时候写我们的前端代码，使我们能够与我们的后端 API 进行交互。</p><p id="4b85" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">我们使用 Django 的模板来编写我们的前端。</p><p id="e4d4" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">让我们在主文件夹中创建一个模板文件夹，然后在里面创建一个<strong class="kb jd">index.html</strong>文件。</p><p id="3499" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">在 HTML 文件中，让我们编写一些代码来创建一个画布，并提交用户在该画布中绘制的图像。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="bcc4" class="na lx it on b gy or os l ot ou">&lt;canvas<br/>          id="canvas"<br/>          width="280"<br/>          height="280"<br/>          style="border:2px solid; float: left; border-radius: 5px; cursor: crosshair;"<br/>        &gt;&lt;/canvas&gt;</span><span id="d2bb" class="na lx it on b gy ov os l ot ou">&lt;p id="result" class="text-center text-success"&gt;&lt;/p&gt;<br/>&lt;a href="#" class="btn btn-success btn-block p-2"  id="predictButton"&gt;<br/>            Predict<br/>&lt;/a&gt;<br/>&lt;input<br/>        type="button"<br/>        class="btn btn-block btn-secondary p-2"<br/>        id="clearButton"<br/>        value="Clear"<br/> /&gt;</span></pre><p id="443f" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">你可以随心所欲地设计你的前端，并在里面创建画布。</p><p id="bcd7" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">显示画布后，让我们用一些 JS(Jquery)使它变得难以处理。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="267a" class="na lx it on b gy or os l ot ou">(function()<br/>{<br/> var canvas = document.querySelector( "#canvas" );<br/> canvas.width = 280;<br/> canvas.height = 280;<br/> var context = canvas.getContext( "2d" );<br/> var canvastop = canvas.offsetTop</span><span id="b926" class="na lx it on b gy ov os l ot ou">var lastx;<br/>   var lasty;</span><span id="4fa5" class="na lx it on b gy ov os l ot ou">context.strokeStyle = "#000000";<br/>   context.lineCap = 'round';<br/>   context.lineJoin = 'round';<br/>   context.lineWidth = 5;</span><span id="fef8" class="na lx it on b gy ov os l ot ou">function dot(x,y) {<br/>     context.beginPath();<br/>     context.fillStyle = "#000000";<br/>     context.arc(x,y,1,0,Math.PI*2,true);<br/>     context.fill();<br/>     context.stroke();<br/>     context.closePath();<br/>   }</span><span id="dcd6" class="na lx it on b gy ov os l ot ou">function line(fromx,fromy, tox,toy) {<br/>     context.beginPath();<br/>     context.moveTo(fromx, fromy);<br/>     context.lineTo(tox, toy);<br/>     context.stroke();<br/>     context.closePath();<br/>   }</span><span id="f12c" class="na lx it on b gy ov os l ot ou">canvas.ontouchstart = function(event){<br/>     event.preventDefault();</span><span id="a0f5" class="na lx it on b gy ov os l ot ou">lastx = event.touches[0].clientX;<br/>     lasty = event.touches[0].clientY - canvastop;</span><span id="c9fe" class="na lx it on b gy ov os l ot ou">dot(lastx,lasty);<br/>   }</span><span id="a338" class="na lx it on b gy ov os l ot ou">canvas.ontouchmove = function(event){<br/>     event.preventDefault();</span><span id="f034" class="na lx it on b gy ov os l ot ou">var newx = event.touches[0].clientX;<br/>     var newy = event.touches[0].clientY - canvastop;</span><span id="976d" class="na lx it on b gy ov os l ot ou">line(lastx,lasty, newx,newy);</span><span id="6f3f" class="na lx it on b gy ov os l ot ou">lastx = newx;<br/>     lasty = newy;<br/>   }</span><span id="0735" class="na lx it on b gy ov os l ot ou">var Mouse = { x: 0, y: 0 };<br/> var lastMouse = { x: 0, y: 0 };<br/> context.fillStyle="white";<br/> context.fillRect(0,0,canvas.width,canvas.height);<br/> context.color = "black";<br/> context.lineWidth = 10;<br/>    context.lineJoin = context.lineCap = 'round';</span><span id="af65" class="na lx it on b gy ov os l ot ou">debug();</span><span id="96f9" class="na lx it on b gy ov os l ot ou">canvas.addEventListener( "mousemove", function( e )<br/> {<br/>  lastMouse.x = Mouse.x;<br/>  lastMouse.y = Mouse.y;</span><span id="da99" class="na lx it on b gy ov os l ot ou">Mouse.x = e.pageX - this.offsetLeft;<br/>  Mouse.y = e.pageY - this.offsetTop;</span><span id="c356" class="na lx it on b gy ov os l ot ou">}, false );</span><span id="75ff" class="na lx it on b gy ov os l ot ou">canvas.addEventListener( "mousedown", function( e )<br/> {<br/>  canvas.addEventListener( "mousemove", onPaint, false );</span><span id="78f5" class="na lx it on b gy ov os l ot ou">}, false );</span><span id="0a4c" class="na lx it on b gy ov os l ot ou">canvas.addEventListener( "mouseup", function()<br/> {<br/>  canvas.removeEventListener( "mousemove", onPaint, false );</span><span id="4d29" class="na lx it on b gy ov os l ot ou">}, false );</span><span id="2fed" class="na lx it on b gy ov os l ot ou">var onPaint = function()<br/> {<br/>  context.lineWidth = context.lineWidth;<br/>  context.lineJoin = "round";<br/>  context.lineCap = "round";<br/>  context.strokeStyle = context.color;</span><span id="ab35" class="na lx it on b gy ov os l ot ou">context.beginPath();<br/>  context.moveTo( lastMouse.x, lastMouse.y );<br/>  context.lineTo( Mouse.x, Mouse.y );<br/>  context.closePath();<br/>  context.stroke();<br/> };</span><span id="81fb" class="na lx it on b gy ov os l ot ou">function debug()<br/> {<br/>  /* CLEAR BUTTON */<br/>  var clearButton = $( "#clearButton" );</span><span id="be3a" class="na lx it on b gy ov os l ot ou">clearButton.on( "click", function()<br/>  {</span><span id="ee47" class="na lx it on b gy ov os l ot ou">context.clearRect( 0, 0, 280, 280 );<br/>    context.fillStyle="white";<br/>    context.fillRect(0,0,canvas.width,canvas.height);</span><span id="1169" class="na lx it on b gy ov os l ot ou">});</span><span id="a6e0" class="na lx it on b gy ov os l ot ou">/* COLOR SELECTOR */</span><span id="7ac5" class="na lx it on b gy ov os l ot ou">$( "#colors" ).change(function()<br/>  {<br/>   var color = $( "#colors" ).val();<br/>   context.color = color;<br/>  });</span><span id="de0b" class="na lx it on b gy ov os l ot ou">/* LINE WIDTH */</span><span id="68f4" class="na lx it on b gy ov os l ot ou">$( "#lineWidth" ).change(function()<br/>  {<br/>   context.lineWidth = $( this ).val();<br/>  });<br/> }<br/>}());</span></pre><p id="585d" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这基本上是我们的 JS 函数，允许用户在我们的画布内绘图。它抓住用户的鼠标+触摸笔划，并根据他们的绘图在画布内绘制线条。</p><p id="98f7" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">之后，让我们编写一个代码，将这些绘制的线条作为 base64 图像文件提交到后端。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="ff3f" class="na lx it on b gy or os l ot ou">&lt;script type="text/javascript"&gt;<br/>      $("#predictButton").click(function() {<br/>        var $SCRIPT_ROOT = "/api/predict/";<br/>        var canvasObj = document.getElementById("canvas");<br/>        var context = canvas.getContext( "2d" );<br/>        var img = canvasObj.toDataURL();<br/>        $.ajax({<br/>          type: "POST",<br/>          url: $SCRIPT_ROOT,<br/>          data: { img: img },<br/>          success: function(data) {<br/>            $("#result").text("Predicted Output is: " + data.output);</span><span id="b8d7" class="na lx it on b gy ov os l ot ou">context.clearRect( 0, 0, 280, 280 );<br/>            context.fillStyle="white";<br/>            context.fillRect(0,0,canvas.width,canvas.height);</span><span id="0172" class="na lx it on b gy ov os l ot ou">}<br/>        });<br/>      });<br/>    &lt;/script&gt;</span></pre><p id="c110" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这里我们使用 jquery 来:</p><ol class=""><li id="385d" class="nl nm it kb b kc kd kg kh kk nn ko no ks np kw nq nr ns nt bi translated">收听我们的按钮点击事件</li><li id="c5da" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">定义我们的 API 路由路径</li><li id="f207" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">抓住我们的画布元素</li><li id="0246" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">以 base64 图像的形式获取画布的上下文</li><li id="0a03" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">使用 ajax 请求将其提交到我们的后端</li><li id="05cc" class="nl nm it kb b kc nu kg nv kk nw ko nx ks ny kw nq nr ns nt bi translated">从我们的后端获得一个响应，并显示在我们的输出部分。</li></ol><p id="a339" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">现在最后，让我们添加一个路由到我们的前端，并编写一个函数来服务我们的主应用程序中的 HTML 文件。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="9682" class="na lx it on b gy or os l ot ou"># views.py</span><span id="c3cb" class="na lx it on b gy ov os l ot ou">def index(request):<br/>    return render(request, 'index.html', {})</span><span id="0de0" class="na lx it on b gy ov os l ot ou"># urls.py<br/>from django.urls import path<br/>from .views import index</span><span id="74f7" class="na lx it on b gy ov os l ot ou">urlpatterns = [<br/>    path('', index, name="index")<br/>]</span></pre><p id="aff9" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">就是这样！我们已经成功地完成了我们的后端+前端开发，以识别手写数字。</p><p id="b61d" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">现在让我们部署它。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="f172" class="lw lx it bd ly lz og mb mc md oh mf mg mh oi mj mk ml oj mn mo mp ok mr ms mt bi translated">部署</h1><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi ox"><img src="../Images/0556f705f286d674ee4bff0d7659426c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SmAESFpJZQFkklcU.png"/></div></div></figure><p id="4172" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">我们将使用<a class="ae ln" href="https://dashboard.heroku.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb jd"> Heroku </strong> </a> <strong class="kb jd"> </strong>来部署我们的 Django 项目，因为它很棒而且免费！</p><blockquote class="lo lp lq"><p id="f836" class="jz ka lr kb b kc kd ke kf kg kh ki kj ls kl km kn lt kp kq kr lu kt ku kv kw im bi translated">你可以从 heroku 的官方文档页面了解更多。它很漂亮，一切都有据可查。</p></blockquote><p id="059a" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">在你的笔记本电脑上安装 Heroku CLI，让我们开始吧。</p><p id="2343" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">为了准备好我们的 Django 项目 Heroku，让我们在根目录中编写一个<strong class="kb jd"> Procfile </strong>。</p><pre class="ky kz la lb gt om on oo op aw oq bi"><span id="c834" class="na lx it on b gy or os l ot ou"># Procfile</span><span id="998f" class="na lx it on b gy ov os l ot ou">web: gunicorn digitrecognizer.wsgi --log-file - --log-level debug</span></pre><p id="7ffc" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">现在让我们在 Heroku 中创建新的应用程序存储库，并获取该应用程序的远程 URL。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi oy"><img src="../Images/970d8689c472e37587661603b9b24db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9wCklu0S9ATZ-u6AxMwO3g.png"/></div></div></figure><p id="f86b" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">之后，git 初始化我们的项目目录，将 git 远程 URL 添加到 Heroku url，并将我们的项目文件夹推送到 Heroku，其中包含<strong class="kb jd"> requirements.txt </strong>文件。</p><p id="87af" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">这就是部署😊。我们已经成功地在云中部署了我们的应用程序，现在它已经上线了。您可以使用 Heroku 在您的应用仪表板中提供的 URL 来访问该应用。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="4f6b" class="lw lx it bd ly lz og mb mc md oh mf mg mh oi mj mk ml oj mn mo mp ok mr ms mt bi translated">最后的想法</h1><p id="6dcc" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">在真实环境中部署您的项目以展示您的项目是非常重要的。这对你的项目组合很有帮助。</p><p id="5247" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">我希望您已经学到了一些东西，尝试构建自己的手写数字分类器，并将其部署到生产环境中。你可以从<a class="ae ln" href="https://digit-recog.herokuapp.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb jd">这里</strong> </a>查看我的演示 app。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="969b" class="lw lx it bd ly lz og mb mc md oh mf mg mh oi mj mk ml oj mn mo mp ok mr ms mt bi translated">参考</h1><p id="19cf" class="pw-post-body-paragraph jz ka it kb b kc mu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks my ku kv kw im bi translated">[1] <em class="lr">熊伟·弗莱塔斯，</em>如何在 Heroku 上部署 Django 应用，2016 年 8 月 9 日[ <a class="ae ln" href="https://simpleisbetterthancomplex.com/tutorial/2016/08/09/how-to-deploy-django-applications-on-heroku.html" rel="noopener ugc nofollow" target="_blank">在线</a> ]</p><p id="10e2" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">[2] <em class="lr">扬·勒库恩，</em> MNIST 数据库，1998 [ <a class="ae ln" href="http://yann.lecun.com/exdb/mnist/" rel="noopener ugc nofollow" target="_blank">在线</a> ]</p></div></div>    
</body>
</html>