<html>
<head>
<title>Visualizing Bike Mobility in London using Interactive Maps and Animations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用交互式地图和动画可视化伦敦的自行车移动性</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualizing-bike-mobility-in-london-using-interactive-maps-for-absolute-beginners-3b9f55ccb59?source=collection_archive---------12-----------------------#2019-01-07">https://towardsdatascience.com/visualizing-bike-mobility-in-london-using-interactive-maps-for-absolute-beginners-3b9f55ccb59?source=collection_archive---------12-----------------------#2019-01-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4122" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">探索 Python 中的数据可视化工具</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f0d786556d81f1b60000afc557b467a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*f0DPJGOZBYD6YPVL"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@na399?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Max Adulyanukosol</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="52e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated">近年来，自行车共享系统已经成为流行的出行方式，为大都市的市民提供了一种绿色灵活的交通方案。世界上许多政府都认为这是一项创新战略，有可能带来许多社会效益。例如，它可以减少汽车的使用，从而减少温室气体排放，缓解市中心的交通拥堵。</p><blockquote class="me mf mg"><p id="7c53" class="kz la mh lb b lc ld ju le lf lg jx lh mi lj lk ll mj ln lo lp mk lr ls lt lu im bi translated"><a class="ae ky" href="http://content.tfl.gov.uk/attitudes-to-cycling-2016.pdf" rel="noopener ugc nofollow" target="_blank">报道</a>显示 77%的伦敦人同意骑自行车是短途旅行最快的方式。从长远来看，这也可能有助于提高城市的预期寿命。</p></blockquote><p id="2549" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我一直在研究一种数据驱动的经济有效的算法，用于优化(重新平衡)伦敦公共自行车租赁计划桑坦德自行车系统，一旦我的论文发表，我应该就此发表一篇文章(更多信息<a class="ae ky" href="https://edenau.github.io/bike-sharing/" rel="noopener ugc nofollow" target="_blank">这里</a>)。在真正研究算法之前，我必须深入研究大量数据，如果我能以某种方式将它们可视化，那将非常有帮助。</p><blockquote class="ml"><p id="3432" class="mm mn it bd mo mp mq mr ms mt mu lu dk translated">TL；DR——让我们看看如何使用图表、地图和动画来可视化自行车共享系统。</p></blockquote><p id="f85b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated"><em class="mh">你可以在这个</em> <a class="ae ky" href="https://edenau.github.io/maps/" rel="noopener ugc nofollow" target="_blank"> <em class="mh">页面</em> </a> <em class="mh">找到网络地图。大多数地图、动画和源代码都可以在</em><a class="ae ky" href="https://github.com/edenau/maps" rel="noopener ugc nofollow" target="_blank"><em class="mh">GitHub</em></a><em class="mh">上找到。数据现已在</em><a class="ae ky" href="https://www.kaggle.com/edenau/london-bike-sharing-system-data" rel="noopener ugc nofollow" target="_blank"><em class="mh">ka ggle</em></a><em class="mh">上。</em></p><h2 id="e973" class="na nb it bd nc nd ne dn nf ng nh dp ni li nj nk nl lm nm nn no lq np nq nr ns bi translated">目录</h2><ul class=""><li id="25ac" class="nt nu it lb b lc nv lf nw li nx lm ny lq nz lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#9f3c" rel="noopener">更多关于数据—钻头</a></li><li id="f0bc" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#aafa" rel="noopener">条形图</a></li><li id="1cab" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#06fb" rel="noopener">互动地图</a></li><li id="df85" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#b4fb" rel="noopener">密度图</a></li><li id="b7e7" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#ad60" rel="noopener">连接图</a></li><li id="69a1" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#06e4" rel="noopener">动画</a></li><li id="05ca" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#ab6f" rel="noopener">结论</a></li><li id="40be" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://medium.com/p/3b9f55ccb59#d0d8" rel="noopener">备注</a></li></ul><p id="3541" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mh">原载于我的博客</em><a class="ae ky" href="https://edenau.github.io" rel="noopener ugc nofollow" target="_blank"><em class="mh">edenau . github . io</em></a><em class="mh">。我的作品灵感来源于</em> <a class="ae ky" href="https://blog.prototypr.io/interactive-maps-in-python-part-3-29f14a9b2f7d" rel="noopener" target="_blank"> <em class="mh">文森特·隆尼</em> </a> <em class="mh">和</em> <a class="ae ky" rel="noopener" target="_blank" href="/master-python-through-building-real-world-applications-part-2-60d707955aa3"> <em class="mh">德鲁米尔·帕特尔</em> </a> <em class="mh">。看看他们的帖子！</em></p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="9f3c" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">关于数据的更多信息—枯燥的部分</h1><p id="f4c4" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">我从伦敦交通局(TfL)获得了关于自行车旅行的数据。自 2012 年以来，他们系统中的每一次自行车旅行都被记录下来，这些公开数据可以在网上获得。</p><p id="f293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">分析了从 2017 年 8 月 1 日到 9 月 13 日的 36 天旅程记录。在此期间，伦敦 700 多个自行车停靠站的行程超过 150 万次。从 2014 年开始，我们见证了自行车旅行的增长超过 190%。该系统中自行车和停靠站的数量都增加了两倍多，以适应伦敦市中心和地区自行车需求的显著增长。确切的数据将在我即将发表的论文中给出。<a class="ae ky" href="https://edenau.github.io/" rel="noopener ugc nofollow" target="_blank">敬请期待</a>。</p><h2 id="22eb" class="na nb it bd nc nd ne dn nf ng nh dp ni li nj nk nl lm nm nn no lq np nq nr ns bi translated">数据操作</h2><p id="0780" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">我相信工作日和周末的出行模式会有很大的不同。我们来做一些编码，看看这是不是真的。我们首先通过<code class="fe pe pf pg ph b">pd.read_csv()</code>导入旅程数据。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="439f" class="na nb it ph b gy pm pn l po pp"># Load journey data</span><span id="c916" class="na nb it ph b gy pq pn l po pp">f = 'journeys.csv'<br/>j = pd.read_csv(f)</span><span id="52f1" class="na nb it ph b gy pq pn l po pp">date = j['date'].values<br/>month = j['month'].values<br/>year = j['year'].values<br/>hour = j['hour'].values<br/>minute = j['minute'].values<br/>station_start = j['id_start'].values<br/>station_end = j['id_end'].values</span></pre><p id="f6bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们通过<code class="fe pe pf pg ph b">date.weekday()</code>提取工作日数据，并将一天 24 小时平均分成 72 个时间片，这样每个时间片代表 20 分钟的间隔。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="93cd" class="na nb it ph b gy pm pn l po pp"># Compute IsWeekday</span><span id="ec93" class="na nb it ph b gy pq pn l po pp">weekday = np.zeros(len(date))<br/>weekday[:] = np.nan<br/>cnt = 0</span><span id="8255" class="na nb it ph b gy pq pn l po pp">for _year, _month, _date, _hour, _minute in zip(year, month, date, hour, minute):<br/>  _dt = datetime.datetime(_year, _month, _date, _hour, _minute)<br/>  _weekday = _dt.weekday()<br/>  weekday[cnt] = _weekday<br/>  cnt += 1</span><span id="3bc7" class="na nb it ph b gy pq pn l po pp">IsWeekday = weekday &lt; 5<br/>j['IsWeekday'] = IsWeekday</span><span id="f86c" class="na nb it ph b gy pq pn l po pp"># Compute TimeSlice</span><span id="cd84" class="na nb it ph b gy pq pn l po pp">j['TimeSlice'] = (hour*3 + np.floor(minute/20)).astype(int)</span></pre><p id="d7f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要检查这些自行车旅行是否是从/到被废除的车站，因为没有办法获得这些车站的信息，如位置、车站名称等。(干得好，TfL)。我们把它们称为“无效”旅行。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="3bb9" class="na nb it ph b gy pm pn l po pp"># Load station data</span><span id="3f12" class="na nb it ph b gy pq pn l po pp">f = 'stations.csv'<br/>stations = pd.read_csv(f)<br/>station_id = stations['station_id'].values</span><span id="cd83" class="na nb it ph b gy pq pn l po pp"># Extract valid journeys</span><span id="aee0" class="na nb it ph b gy pq pn l po pp">valid = np.zeros(len(date))<br/>valid[:] = False<br/>cnt = 0</span><span id="ea9b" class="na nb it ph b gy pq pn l po pp">for _start, _end in zip(station_start, station_end):<br/>  if np.logical_and((_start in station_id), (_end in station_id)):<br/>    valid[cnt] = True<br/>  cnt += 1</span><span id="248d" class="na nb it ph b gy pq pn l po pp">j['Valid'] = valid</span></pre><p id="0e40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们只保留在工作日进行的“有效”<strong class="lb iu">和</strong>的旅程，这占数据的 73%左右。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="37ff" class="na nb it ph b gy pm pn l po pp">df = j[j["IsWeekday"] == True].drop(columns="IsWeekday")<br/>df = df[df["Valid"] == True].drop(columns="Valid")</span><span id="18ef" class="na nb it ph b gy pq pn l po pp">print('Ratio of valid journeys= {:.2f}%'.format(df.shape[0] / j.shape[0] * 100))</span></pre></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="aafa" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">条形图</h1><p id="56e9" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">我们最后深入研究可视化部分！数据可视化最简单的形式可以说是图表。通过一个简单的<code class="fe pe pf pg ph b">groupby('TimeSlice')</code>函数，我们可以看到不同时间的旅行有多频繁。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="223f" class="na nb it ph b gy pm pn l po pp">grp_by_timeslice = df.groupby('TimeSlice').count().values[:,0]</span><span id="7c3a" class="na nb it ph b gy pq pn l po pp">plt.bar(range(0,72), grp_by_timeslice)<br/>plt.xlabel('Time Slice')<br/>plt.ylabel('Departures')<br/>plt.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pr"><img src="../Images/a38106d77cd16563d9c26224632b0b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uWUPJb121CcJA8qeWqXWmA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Average departure rates on weekdays (left) and weekends (right)</figcaption></figure><p id="01d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看到了吗？我们的假设是对的！工作日和周末的出行模式如此不同，因为我们可以看到工作日的两个高峰时间，大多数人在那里通勤，但周末不是。我们也可以用类似的方式观察旅行持续时间和速度的分布。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pr"><img src="../Images/d355653f9784b6b989faddde82edbcac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TFXtjTRsdAIG_zOkGoflqg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Distribution of journey duration (left) and speed (right)</figcaption></figure><p id="4ad4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，由于数据限制(它们不跟踪您的运动)，我们假设采用的是直线路径，这将比实际路径短，因此根据起点站和终点站之间的距离计算的速度将被低估<strong class="lb iu"><em class="mh"/></strong>。如果顾客在租车的同一个站点归还自行车，计算出的速度将是 0，这解释了为什么会出现 0 公里/小时的奇怪峰值。</p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="06fb" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">交互式地图</h1><p id="287c" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">如果图表很奇特，地图就更奇特了。我们将使用<code class="fe pe pf pg ph b"><a class="ae ky" href="https://python-visualization.github.io/folium/" rel="noopener ugc nofollow" target="_blank">folium</a></code>，它是制作交互式地图的<a class="ae ky" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank">fleet . js</a>的 Python 包装器。确保通过以下方式安装最新版本</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="fed0" class="na nb it ph b gy pm pn l po pp">$ pip install folium==0.7.0</span></pre><p id="e111" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(或其<code class="fe pe pf pg ph b">conda install</code>等价物)。我在谷歌合作实验室工作，预装版本是功能最少的<code class="fe pe pf pg ph b">0.2.0</code>。</p><p id="2d45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我创建了一个简单的模板，用圆圈标记(不同的颜色)生成地图。)使用集群。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="df58" class="na nb it ph b gy pm pn l po pp">import folium</span><span id="3228" class="na nb it ph b gy pq pn l po pp"># Change colours</span><span id="ce72" class="na nb it ph b gy pq pn l po pp">def color_change(c):<br/>    if(c &lt; 15):<br/>        return('red')<br/>    elif(15 &lt;= c &lt; 30):<br/>        return('orange')<br/>    else:<br/>        return('green')</span><span id="305d" class="na nb it ph b gy pq pn l po pp"># Create base map</span><span id="0e02" class="na nb it ph b gy pq pn l po pp">London = [51.506949, -0.122876]<br/>map = folium.Map(location = London,<br/>                 zoom_start = 12, <br/>                 tiles = "CartoDB positron")<br/>marker_cluster = MarkerCluster(locations=[lat, lon]).add_to(map)</span><span id="404b" class="na nb it ph b gy pq pn l po pp"># Plot markers</span><span id="dc71" class="na nb it ph b gy pq pn l po pp">for _lat, _lon, _cap, _name in zip(lat, lon, cap, name):<br/>    folium.CircleMarker(location = [_lat, _lon], <br/>                        radius = 9, <br/>                        popup = "("+str(_cap)+") "+_name, <br/>                        fill_color = color_change(_cap), <br/>                        color = "gray", <br/>                        fill_opacity = 0.9).add_to(marker_cluster)<br/>    <br/>f = 'map_station_cluster.html'<br/>map.save(f)</span></pre><p id="a8c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么是集群？<code class="fe pe pf pg ph b">MarkerCluster()</code>缩小时，标记如果靠得太近，可以聚集在一起。你不希望你的地图太乱，标记互相重叠。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/b92966f4c3ee461875a110007d2a5cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZ-FwJ-YHlLxBpJx8cTmKg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Station cluster map</figcaption></figure><p id="35b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您放大时，它会自动分解/展开:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/c2cffc1f8686c46cb0f271c553fcb563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XrdX0WwOopUSueMrrS-wNA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Station cluster map — zoomed in</figcaption></figure><p id="912f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我答应你<strong class="lb iu"> <em class="mh">互动</em> </strong>地图。您可以设置<code class="fe pe pf pg ph b">popup</code>参数，当您点击它时会显示站点名称及其容量。太棒了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/3189614937377dd9035631446509a11f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1cVmYJ032pC2otNb842LQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Interactions in the station cluster map</figcaption></figure><p id="5a99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mh">此地图在</em><a class="ae ky" href="https://edenau.github.io/maps/station-cluster/" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://edenau.github.io/maps/station-cluster/</em></a><em class="mh">上有售。</em></p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="b4fb" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">密度图</h1><p id="f541" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">上面的代码使用了一个动态的颜色方案，这个方案取决于站点的容量。我们还可以根据每个车站的出发和到达次数，为这些圆形标记实施动态半径方案。我们可以获得我们称之为<strong class="lb iu"> <em class="mh">的密度图</em> </strong>，它显示了每个站点的净出发/到达。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="bbc8" class="na nb it ph b gy pm pn l po pp">def DensityMap(stations, cnt_departure, cnt_arrival):</span><span id="eb9a" class="na nb it ph b gy pq pn l po pp">London = [51.506949, -0.122876]<br/>  <br/>  map = folium.Map(location = London, <br/>                   zoom_start = 12, <br/>                   tiles = "CartoDB dark_matter")<br/>  <br/>  stations['Total Departure'] = cnt_departure<br/>  stations['Total Arrival'] = cnt_arrival</span><span id="7628" class="na nb it ph b gy pq pn l po pp">for index, row in stations.iterrows():<br/>    net_departure = row['Total Departure'] - row['Total Arrival']<br/>    <br/>    _radius = np.abs(net_departure) <br/>    if np.isnan(_radius):<br/>      _radius = 0<br/>    <br/>    if net_departure &gt; 0:<br/>      _color= '#E80018' # target red<br/>    else:<br/>      _color= '#81D8D0' # tiffany blue<br/>  <br/>    lat, lon = row['lat'], row['lon']<br/>    _popup = '('+str(row['capacity'])+'/'+str(int(_radius))+') '+row['station_name']<br/>  <br/>    folium.CircleMarker(location = [lat,lon], <br/>                        radius = _radius, <br/>                        popup = _popup, <br/>                        color = _color, <br/>                        fill_opacity = 0.5).add_to(map)<br/>  <br/>  return map</span></pre><p id="7340" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在这里使用了不同的配色方案(<em class="mh">目标红</em>和<em class="mh">蒂芙尼蓝</em>都是在美国注册的颜色)来显示某个车站的出发人数是多于还是少于到达人数。大圆圈标记代表较大的出发-到达差异。</p><p id="2c55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看早晚高峰时段的密度图:</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="2d77" class="na nb it ph b gy pm pn l po pp"># Select peak hours</span><span id="3cde" class="na nb it ph b gy pq pn l po pp">TimeSlice = [25,53] # morning and evening<br/>keyword = ['map_morning', 'map_evening']</span><span id="04c0" class="na nb it ph b gy pq pn l po pp"># Journeys depart between 0820 and 0859, and between 1740 and 1819<br/>for ts, kw in zip(TimeSlice, keyword):<br/>  df_1 = df[df["TimeSlice"] == ts]<br/>  df_2 = df[df["TimeSlice"] == (ts+1)]<br/>  df_target = df_1.append(df_2)</span><span id="df7e" class="na nb it ph b gy pq pn l po pp">  cnt_departure = df_target.groupby("id_start").count().iloc[:,0]<br/>  cnt_arrival = df_target.groupby("id_end").count().iloc[:,0]</span><span id="9d04" class="na nb it ph b gy pq pn l po pp">  vars()[kw] = DensityMap(stations, cnt_departure, cnt_arrival)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/1f74d9d90d33aa043c86df4ef4b17fa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*myb6B3njP9mnnM_X3OT0Hg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Density map in morning peak hours</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/929fdf4ca79c8cefdd9e420861b4bbb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Io7sp9gDPhvrO0t7x6RbXA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Density map in evening peak hours</figcaption></figure><p id="a6ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mh">密度图在</em><a class="ae ky" href="https://edenau.github.io/maps/density-morning/" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://edenau.github.io/maps/density-morning/</em></a><em class="mh">和</em><a class="ae ky" href="https://edenau.github.io/maps/density-evening/" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://edenau.github.io/maps/density-evening/</em></a><em class="mh">上可用。</em></p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="ad60" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">连接图</h1><p id="b135" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">前面提到的所有地图都关注车站而不是旅程，但是我们也可以通过我们所谓的<strong class="lb iu"><em class="mh"/></strong>连接地图，通过简单地在地图上绘制完成的旅程来可视化旅程。无需深究细节:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/1094439839a97570a2dfa3ca0aaf9083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YCuR20Lr-KB5-iia1FTz-Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Connection map</figcaption></figure><p id="b774" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以通过<code class="fe pe pf pg ph b">folium.LayerControl()</code>添加多层连接，将频繁使用和不频繁使用的路径分开。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pt"><img src="../Images/68981e29e277e197ff8161dac80007f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AhOkgluIt2vDVBkRNOcqGw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Multi-layer connection map</figcaption></figure><p id="e425" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mh">连接图在</em><a class="ae ky" href="https://edenau.github.io/maps/connection-morning/" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://edenau.github.io/maps/connection-morning/</em></a><em class="mh">和</em><a class="ae ky" href="https://edenau.github.io/maps/connection-morning-layers/" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://edenau.github.io/maps/connection-morning-layers/</em></a><em class="mh">上都有。</em></p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="06e4" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">动画片</h1><p id="c160" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">到目前为止，我们已经演示了如何通过图表可视化时间和分布信息，以及通过各种地图可视化空间信息。但是如果我们在连续的时间实例上生成多个地图呢？我们可以用动画来可视化时空信息！</p><p id="d7ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生成的地图是<em class="mh">中的 web 地图。html </em>文件。这个想法是:</p><blockquote class="me mf mg"><p id="b309" class="kz la mh lb b lc ld ju le lf lg jx lh mi lj lk ll mj ln lo lp mk lr ls lt lu im bi translated">为每个时间实例生成一个地图，在 web 浏览器上浏览，截屏并保存图片，并将所有图片链接成视频或. gif 文件。</p></blockquote><p id="60fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在<code class="fe pe pf pg ph b"><a class="ae ky" href="https://www.seleniumhq.org/" rel="noopener ugc nofollow" target="_blank">selenium</a></code>之前实现网页浏览和屏幕截图过程的自动化。我们还需要一个网络驱动，作为 Chrome 用户，我选择了<code class="fe pe pf pg ph b">chromedriver</code>。</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="a74a" class="na nb it ph b gy pm pn l po pp">from selenium import webdriver</span><span id="7cde" class="na nb it ph b gy pq pn l po pp">def a_frame(i, frame_time, data):<br/>    my_frame = get_image_map(frame_time, data)<br/>    <br/>    # Save the web map    <br/>    delay = 5 # give it some loading time<br/>    fn = 'frame_{:0&gt;5}'.format(i)<br/>    DIR = 'frames'<br/>    f = DIR + '/' + fn + '.html'<br/>    tmpurl='file://{path}/{mapfile}'.format(path=os.getcwd()+<br/>'/frames',mapfile=fn)<br/>    my_frame.save(f)</span><span id="cb72" class="na nb it ph b gy pq pn l po pp">    # Open the web map and take screenshot<br/>    browser = webdriver.Chrome()<br/>    browser.get(tmpurl)<br/>    time.sleep(delay)<br/>    f = DIR + '/' + fn + '.png'<br/>    browser.save_screenshot(f)<br/>    browser.quit()</span><span id="8f7c" class="na nb it ph b gy pq pn l po pp">    f = 'frames/frame_{:0&gt;5}.png'.format(i)<br/>    image = Image.open(io.BytesIO(f))<br/>    draw = ImageDraw.ImageDraw(image)<br/>    font = ImageFont.truetype('Roboto-Light.ttf', 30)<br/>    <br/>    # Add text on picture<br/>    draw.text((20, image.height - 50), <br/>              'Time: {}'.format(frame_time),<br/>              fill=(255, 255, 255), <br/>              font=font)<br/>    <br/>    # Write the .png file<br/>    dir_name = "frames"<br/>    if not os.path.exists(dir_name):<br/>        os.mkdir(dir_name)<br/>    image.save(os.path.join(dir_name, 'frame_{:0&gt;5}.png'.format(i)), 'PNG')</span><span id="b299" class="na nb it ph b gy pq pn l po pp">    return image</span></pre><p id="b94a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以在<code class="fe pe pf pg ph b"><a class="ae ky" href="https://www.ffmpeg.org/" rel="noopener ugc nofollow" target="_blank">ffmpeg</a></code>之前制作视频或 gif。对于 Mac 用户来说，在<a class="ae ky" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>的帮助下，安装<code class="fe pe pf pg ph b">ffmpeg</code>简直不费吹灰之力，因为</p><blockquote class="ml"><p id="5c06" class="mm mn it bd mo mp mq mr ms mt mu lu dk translated">家酿安装了你需要的苹果没有的东西。</p></blockquote><p id="9390" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">安装 Homebrew(用一个命令)后，只需输入</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="6431" class="na nb it ph b gy pm pn l po pp">$ brew install ffmpeg</span></pre><p id="9861" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧！要创建一个<em class="mh"> .mp4 </em>文件，请尝试</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="0edc" class="na nb it ph b gy pm pn l po pp">$ ffmpeg -r 10 -i frames/frame_%05d.png -c:v libx264 -vf fps=25 -crf 17 -pix_fmt yuv420p video.mp4</span></pre><p id="bf01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于<em class="mh">。gif </em>文件，试试</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="838d" class="na nb it ph b gy pm pn l po pp">$ ffmpeg -y  -t 3 -i frames/frame_%05d.png \ -vf fps=10,scale=320:-1:flags=lanczos,palettegen palette.png</span><span id="0a76" class="na nb it ph b gy pq pn l po pp">$ ffmpeg -r 10  -i frames/frame_%05d.png -i palette.png -filter_complex \ "fps=10,scale=720:-1:flags=lanczos[x];[x][1:v]paletteuse" animation.gif</span></pre><p id="aaba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看全天密度图的动画:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pu"><img src="../Images/93f07e9aff7c5ab8d3429970aff6a4d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*bB0OTIKP51yoKgKG6Bd9zg.gif"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Animation of density maps throughout a day</figcaption></figure><p id="0040" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以及不同时间旅程的动画:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pu"><img src="../Images/753f6b0ed1f6a54de2bf312b0abe3cc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*NLp3bbu59nWFYMCr0fCcLQ.gif"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Animation of journeys in the morning</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pu"><img src="../Images/0898a332e6b4bb263f62f89031e48c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*vEdPDCXjC64rcvkp7I0TTg.gif"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Animation of journeys after midnight</figcaption></figure><h1 id="ab6f" class="oq nb it bd nc or pv ot nf ou pw ow ni jz px ka nl kc py kd no kf pz kg nr pa bi translated">结论</h1><p id="49cd" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">伦敦的自行车共享系统使用条形图、密度图、连接图和动画进行可视化。</p><p id="ba76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python 的抽象使其成为时空数据可视化的非常好的工具(以计算时间为代价)。我利用了<code class="fe pe pf pg ph b">folium</code>、<code class="fe pe pf pg ph b">selenium</code>、<code class="fe pe pf pg ph b">chromedriver</code>、<code class="fe pe pf pg ph b">brew</code>、<code class="fe pe pf pg ph b">ffmpeg</code>，以及最重要的，来自文森特<a class="ae ky" href="https://github.com/vincentropy/python_cartography_tutorial" rel="noopener ugc nofollow" target="_blank">代码</a>的部分构建模块来实现这一点。</p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><h1 id="d0d8" class="oq nb it bd nc or os ot nf ou ov ow ni jz ox ka nl kc oy kd no kf oz kg nr pa bi translated">评论</h1><p id="e169" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li pb lk ll lm pc lo lp lq pd ls lt lu im bi translated">如果您对 Python 或编程感兴趣，以下文章可能会有所帮助:</p><div class="qa qb gp gr qc qd"><a rel="noopener follow" target="_blank" href="/5-python-features-i-wish-i-had-known-earlier-bc16e4a13bf4"><div class="qe ab fo"><div class="qf ab qg cl cj qh"><h2 class="bd iu gy z fp qi fr fs qj fu fw is bi translated">我希望我能早点知道的 5 个 Python 特性</h2><div class="qk l"><h3 class="bd b gy z fp qi fr fs qj fu fw dk translated">超越 lambda、map 和 filter 的 Python 技巧</h3></div><div class="ql l"><p class="bd b dl z fp qi fr fs qj fu fw dk translated">towardsdatascience.com</p></div></div><div class="qm l"><div class="qn l qo qp qq qm qr ks qd"/></div></div></a></div><div class="qa qb gp gr qc qd"><a rel="noopener follow" target="_blank" href="/handling-netcdf-files-using-xarray-for-absolute-beginners-111a8ab4463f"><div class="qe ab fo"><div class="qf ab qg cl cj qh"><h2 class="bd iu gy z fp qi fr fs qj fu fw is bi translated">绝对初学者使用 XArray 处理 NetCDF 文件</h2><div class="qk l"><h3 class="bd b gy z fp qi fr fs qj fu fw dk translated">探索 Python 中与气候相关的数据操作工具</h3></div><div class="ql l"><p class="bd b dl z fp qi fr fs qj fu fw dk translated">towardsdatascience.com</p></div></div><div class="qm l"><div class="qs l qo qp qq qm qr ks qd"/></div></div></a></div><p id="8564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次感谢<a class="ae ky" href="https://blog.prototypr.io/interactive-maps-in-python-part-3-29f14a9b2f7d" rel="noopener" target="_blank"> Vincent Lonij </a>和<a class="ae ky" rel="noopener" target="_blank" href="/master-python-through-building-real-world-applications-part-2-60d707955aa3"> Dhrumil Patel </a>展示相关作品。</p><p id="410a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这项工作基于我的硕士论文<a class="ae ky" href="https://edenau.github.io/bike-sharing/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> <em class="mh">基于站点的自行车共享系统</em> </strong> </a>的优化。敬请关注我即将发表的论文。</p><p id="b316" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mh">原载于我的博客</em><a class="ae ky" href="https://edenau.github.io" rel="noopener ugc nofollow" target="_blank"><em class="mh">edenau . github . io</em></a><em class="mh">。</em></p><h2 id="f1b5" class="na nb it bd nc nd ne dn nf ng nh dp ni li nj nk nl lm nm nn no lq np nq nr ns bi translated">参考</h2><ul class=""><li id="20f7" class="nt nu it lb b lc nv lf nw li nx lm ny lq nz lu oa ob oc od bi translated"><a class="ae ky" href="http://content.tfl.gov.uk/attitudes-to-cycling-2016.pdf" rel="noopener ugc nofollow" target="_blank">http://content.tfl.gov.uk/attitudes-to-cycling-2016.pdf</a></li><li id="1ace" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/master-python-through-building-real-world-applications-part-2-60d707955aa3">https://towards data science . com/master-python-through-building-real-world-applications-part-2-60d 707955 aa3</a></li><li id="a29f" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://blog.prototypr.io/interactive-maps-with-python-part-1-aa1563dbe5a9" rel="noopener" target="_blank">https://blog . prototypr . io/interactive-maps-with-python-part-1-aa 1563 dbe5a 9</a></li><li id="6a83" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://python-visualization.github.io/folium/" rel="noopener ugc nofollow" target="_blank">https://python-visualization.github.io/folium/</a></li><li id="694a" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><a class="ae ky" href="https://www.seleniumhq.org/" rel="noopener ugc nofollow" target="_blank">https://www.seleniumhq.org/</a></li><li id="a19f" class="nt nu it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">【https://www.ffmpeg.org/ T2】号</li></ul></div></div>    
</body>
</html>