<html>
<head>
<title>Making the Mueller Report Searchable with OCR and Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 OCR 和 Elasticsearch 搜索穆勒报告</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/making-the-mueller-report-searchable-with-ocr-and-elasticsearch-4e73e55de341?source=collection_archive---------9-----------------------#2019-04-19">https://towardsdatascience.com/making-the-mueller-report-searchable-with-ocr-and-elasticsearch-4e73e55de341?source=collection_archive---------9-----------------------#2019-04-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a970" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4 月 18 日标志着穆勒报告的全面发布——这份文件概述了对俄罗斯可能干预 2016 年总统选举的调查。像大多数政府文件一样，这份文件很长(448 页)，读起来会非常乏味。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/e32239bdd330c7b8ce7f6be5c328e27a.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/0*fC6jbIOuEiTiEg1m.jpg"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk"><a class="ae la" href="https://cdn.cnn.com/cnnnext/dam/assets/190417144337-20190418-mueller-report-drop-generic-blue-large-169.jpg" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="f1b7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更糟糕的是，实际下载的 PDF 基本上只是一张图片。您不能复制/粘贴文本，或者如果您想在文档中搜索更有针对性的信息，可以使用 ctrl+f 查找文本的特定部分。</p><p id="abf4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，我们可以很容易地使用两种伟大的技术来搜索这个文档:光学字符识别(OCR)和弹性搜索。</p><h2 id="9df5" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">光学字符识别</h2><p id="1910" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">OCR 允许我们对文本进行拍照、识别，然后将其转换为实际文本——参见维基百科上的<a class="ae la" href="https://en.wikipedia.org/wiki/Optical_character_recognition" rel="noopener ugc nofollow" target="_blank">这一描述</a>。幸运的是，在当今时代，有许多开源库/产品来完成这项任务。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/93c671fe528b58c9f428792ea165b96e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*XK7pdVOpmuaUdlKC.png"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk"><a class="ae la" href="https://upload.wikimedia.org/wikipedia/commons/7/78/Tesseract_OCR_logo_%28Google%29.png" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="d681" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae la" href="https://opensource.google.com/projects/tesseract" rel="noopener ugc nofollow" target="_blank">宇宙魔方</a>就是这样一个引擎。它最初开发于 80 年代，自 2006 年以来一直是谷歌的项目，是最受欢迎的 OCR 引擎之一。今天，我们将使用 Python 包装器:<a class="ae la" href="https://pypi.org/project/pytesseract/" rel="noopener ugc nofollow" target="_blank">pytesserac</a>。我从<a class="ae la" href="https://medium.com/@winston.smith.spb/python-ocr-for-pdf-or-compare-textract-pytesseract-and-pyocr-acb19122f38c" rel="noopener">这篇文章</a>中获得了我最初的 PDF-OCR 灵感——看看吧！</p><h2 id="9af6" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">弹性搜索</h2><p id="a732" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">Elasticsearch 是一个可扩展的搜索平台，它使用类似于 TF-IDF 的算法，TF-IDF 代表词频逆文档频率。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ma"><img src="../Images/adb9b32754661059c93c7974f0b7f52b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*POxdSXXxZ2lenKry.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk"><a class="ae la" href="https://www.antaresnet.com/wp-content/uploads/2018/07/Elasticsearch-Logo-Color-V.png" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="e803" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本质上，它是一个简单的函数，经常在搜索/相似性空间中使用，根据关键字定位文档。它也不太强调频繁出现的单词。例如，因为单词“the”出现在如此多的文本中，我们不希望它被认为是我们搜索查询的重要部分。TF-IDF 在将您的查询与文档进行比较时会考虑这一点。对于它的基本概述，只需查看维基百科<a class="ae la" href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="dc07" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">装置</h2><p id="3791" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">你可以从<a class="ae la" href="https://www.elastic.co/downloads/elasticsearch" rel="noopener ugc nofollow" target="_blank">网站</a>或者你的操作系统各自的包管理器下载并安装 elastic。然后你只需要我们将要使用的所有 Python 包。</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="5f49" class="lb lc it mg b gy mk ml l mm mn">pip install elasticsearch<br/>pip install pdf2image<br/>pip install pytesseract</span></pre><h2 id="6291" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">OCR 文本提取</h2><p id="51e2" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">首先，将<a class="ae la" href="https://cdn.cnn.com/cnn/2019/images/04/18/mueller-report.pdf" rel="noopener ugc nofollow" target="_blank">穆勒报告</a>下载到您的主机。然后，我们可以创建一个快速函数，使用 pytesseract 和 pdf2image 库从 PDF 中逐页提取文本。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="e88a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意，我设置了默认值<code class="fe mq mr ms mg b">num_pages=10</code>。这是因为这份报告真的很长，在你的个人电脑上，从每一页提取文本可能要花很长时间。此外，如果您不打算将本地 Elasticsearch 索引部署到云上，那么它也是大量数据。不过，您可以随意将该参数更改为您选择的任何值。</p><p id="aa26" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是不管怎样，当我们在 PDF 上运行这个函数时，我们现在有了所有 PDF 页面的文本和页码！这是一个字典列表(json ),对于 elastic 来说，这是一个很好的入口，可以让它被搜索到。</p><h2 id="38d1" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">弹性研究索引</h2><p id="4bac" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">你需要做的第一件事是确保 elastic 运行在正确的端口上。打开一个终端，启动 elastic(如果在你的<code class="fe mq mr ms mg b">$PATH</code>里面，应该就是<code class="fe mq mr ms mg b">elasticsearch</code>)。默认情况下，这将在端口 9200 上启动服务。</p><p id="2242" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">之后，我们可以很容易地使用 Python 客户机与我们的实例进行交互。如果 elastic 在端口 9200 上运行正常，下面的代码应该创建索引<code class="fe mq mr ms mg b">mueller-report</code>，它有两个字段:<code class="fe mq mr ms mg b">text</code>和<code class="fe mq mr ms mg b">page</code>(它们对应于我们在前面函数中的字典键)。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mo mp l"/></div></figure><h2 id="92f9" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">搜索我们的索引</h2><p id="db1d" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">我不会深入细节，但是 elastic 使用一种叫做 query DSL 的语言来与索引交互。您可以对它做很多事情，但我们在这里要做的只是创建一个将我们的查询矢量化的函数，并将其与我们的索引中的<code class="fe mq mr ms mg b">text</code>进行相似性比较。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="7f19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mq mr ms mg b">res</code>将是一个 json，包含我们搜索的一系列信息。实际上，我们只想要相关的结果。所以一旦我们实际调用了这个函数，我们就可以解析 json 来获得最相关的文本和页码。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="85d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这样，我们的搜索功能在页面文本中查找“司法部”,并返回结果。上面语句中的<code class="fe mq mr ms mg b">[0]</code>只是为了查看第一个最相关的页面文本和编号。但是，您可以定制解析，以便它返回您喜欢的少/多的结果。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mt"><img src="../Images/609079a0986e142f25a22c63846dd44e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*vCDzlmenac-ssPmq2PZcSg.gif"/></div></div></figure><h2 id="c9ca" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">使用基巴纳前端</h2><p id="a67a" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">实际上，我们可以使用另一个弹性工具来更好地查看我们的结果，而不是查看我的 jupyter 笔记本中记录不佳的 gif。Kibana 是 elastic 的开源前端，非常适合可视化。首先，从<a class="ae la" href="https://www.elastic.co/downloads/kibana" rel="noopener ugc nofollow" target="_blank">这个链接</a>安装 kibana。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mu"><img src="../Images/0a5e820378ed6f7ce7242f0ac3af0c6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3cgWEdyTbm_jnNu1.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk"><a class="ae la" href="https://www.elastic.co/assets/blt2d6c527d2050e9dd/kibana50dashboard.png" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="441c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦你安装了 Kibana，在终端中运行<code class="fe mq mr ms mg b">kibana</code>启动服务，然后在你最喜欢的浏览器中导航到<code class="fe mq mr ms mg b">localhost:5601</code>。这将允许您与应用程序进行交互。</p><p id="89ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在与索引交互之前，我们唯一要做的事情是创建一个索引模式。转到 Management &gt; Create Index Pattern，然后输入“mueller-report”——ki Bana 应该会让您知道该模式与我们之前在 elastic 中创建的索引相匹配。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mv"><img src="../Images/c85ea419749062479d0c61ef7e1fd0f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*63v4YnbjdUCVqrp9qioWwQ.png"/></div></div></figure><p id="15be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样！如果你转到左边的 Discover 标签，你可以用一种比我们在 elastic 更容易(也更美观)的方式搜索你的索引。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mt"><img src="../Images/c32ee38245f239208a4749f75bda00e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*m9GJ1RAAOTlZYqlmxmQPGA.gif"/></div></div></figure><h2 id="72a6" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">后续步骤</h2><p id="cf32" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">把它放在 AWS 上可能会很酷，这样任何人都可以使用它(有一个更好的前端)，但我现在真的不想把我的信用卡绑定到那个实例上。如果其他人想，请自便！我将很快更新 docker 容器和 github 链接。</p><h2 id="4eea" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">更新</h2><p id="11a3" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated"><strong class="js iu">2019 年 4 月 21 日</strong>—Mueller Report 上有很多关于 OCR 和后续 NLP 的帖子/工作。似乎主要关注的是 OCR 文本的实际质量，因为由于格式或一般的不准确性，结果可能是混乱的。虽然可能没有简单的方法来解决这个问题以供未来分析(除了政府发布了一份<em class="mw">有用的</em>文件)，但我们至少可以通过在我们的搜索功能中添加一个<code class="fe mq mr ms mg b">fuzziness</code>参数来弹性补偿我们搜索中的任何拼写错误。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="bf27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一种粗略但通用的方法，可以解释我们可能在 OCR 后的文本中发现的一些错误。</p></div></div>    
</body>
</html>