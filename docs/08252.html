<html>
<head>
<title>Web scraping for financial statements with Python — 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 实现财务报表的网络抓取— 1</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/web-scraping-for-accounting-analysis-using-python-part-1-b5fc016a1c9a?source=collection_archive---------3-----------------------#2019-11-11">https://towardsdatascience.com/web-scraping-for-accounting-analysis-using-python-part-1-b5fc016a1c9a?source=collection_archive---------3-----------------------#2019-11-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1e91" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我复制了一个基于 Excel 的会计工作，以前我要花几个小时才能完成，现在这项任务可以在几秒钟内完成。</h2></div><h1 id="f85a" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak">背景</strong></h1><p id="225b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">会计的数据科学用例并不多。然而，会计工作是需要自动化的繁琐类别之一。我曾经做过的一项任务是获取单个公司的财务报表，这样我就可以对照行业分析它们的表现。基本上，我会在雅虎财经上搜索他们的名字，并在 Excel 上收集关键指标。</p><p id="8c73" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">操纵网络数据有时会很棘手，尤其是当网站更新时，但是掌握这几个步骤将会在将来为你节省大量的时间。这是一个<strong class="lc iu">使用 Python 从雅虎财经</strong>获取财务报表的例子。</p><h2 id="3326" class="mb kj it bd kk mc md dn ko me mf dp ks lj mg mh ku ln mi mj kw lr mk ml ky mm bi translated"><strong class="ak">导入库</strong></h2><p id="0915" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Urlib.request 是一个开源库，用于解析网页内容。当你调用它时，你基本上是要求网站从那个网站获取数据。如果感兴趣，这里有更多的信息。</p><p id="3a92" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated"><a class="ae mn" href="https://docs.python.org/3/library/urllib.request.html" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3/library/urllib.request.html</a></p><p id="480c" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">另一个库叫做<strong class="lc iu"> Beautiful Soup </strong>，它使得读取以 XML 格式存储的数据变得更加容易。XML 是一种类似于 HTML 的格式，在标记之间存储值。如果你打开它，它看起来有点乱。就像你拿到一个网页的源代码一样。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="06c7" class="mb kj it mt b gy mx my l mz na">import pandas as pd<br/>from bs4 import BeautifulSoup<br/>import urllib.request as ur</span></pre></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><h2 id="2346" class="mb kj it bd kk mc md dn ko me mf dp ks lj mg mh ku ln mi mj kw lr mk ml ky mm bi translated">处理</h2><p id="f643" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这里有一个简单的技巧，你可以灵活地调整股票代码，并将其插入网址链接。如果你想提取数百份公司财务报表，它会派上用场。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="42c0" class="mb kj it mt b gy mx my l mz na"># Enter a stock symbol<br/>index= ‘MSFT’</span><span id="2676" class="mb kj it mt b gy ni my l mz na"># URL link <br/>url_is = ‘<a class="ae mn" href="https://finance.yahoo.com/quote/'" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/'</a> + index + ‘/financials?p=’ + index<br/>url_bs = ‘<a class="ae mn" href="https://finance.yahoo.com/quote/'" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/'</a> + index +’/balance-sheet?p=’ + index<br/>url_cf = ‘<a class="ae mn" href="https://finance.yahoo.com/quote/'" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/'</a> + index + ‘/cash-flow?p=’+ index</span></pre><p id="c413" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">现在我们已经保存了 URL 链接。如果您在 Web 浏览器上手动打开它们，它将看起来像这样。</p><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nj"><img src="../Images/8b3a00f07f59119236ba12f953478f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FSUM4CJ98B9b8nnylyaq4Q.png"/></div></div></figure><h2 id="7837" class="mb kj it bd kk mc md dn ko me mf dp ks lj mg mh ku ln mi mj kw lr mk ml ky mm bi translated">阅读网址</h2><p id="754c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接下来，我们只需要打开链接，将它读入一个名为 lxml 的适当格式。很简单。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="fe4e" class="mb kj it mt b gy mx my l mz na">read_data = ur.urlopen(url_is).read() <br/>soup_is= BeautifulSoup(read_data,’lxml’)</span></pre><p id="fd9c" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">嗯，如果你打开 soup_is，它看起来会很乱，因为元素最初是 HTML 格式的。所有元素都被系统地安排在类中。</p><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nr"><img src="../Images/1b9dc660939b5b9f27033798c9724d1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4xFcpZD2rbt6qz6SQYQFCw.png"/></div></div></figure><h1 id="4555" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">数据操作</h1><p id="b16e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">但是如何知道相关数据存储在哪个类中呢？</p><p id="d845" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">经过几次搜索，我们知道它们存储在“div”中，我们可以创建一个空列表并使用 for 循环来查找所有元素并将它们追加到列表中。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="69a5" class="mb kj it mt b gy mx my l mz na">ls= [] # Create empty list<br/>for l in soup_is.find_all(‘div’): <br/>  #Find all data structure that is ‘div’<br/>  ls.append(l.string) # add each element one by one to the list<br/> <br/>ls = [e for e in ls if e not in (‘Operating Expenses’,’Non-recurring Events’)] # Exclude those columns</span></pre><p id="87bc" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">你会发现 ls 里面有很多“none”元素，因为不是所有的“div”都有一个元素。我们只需要把那些过滤掉。</p><blockquote class="ns nt nu"><p id="63e5" class="la lb nv lc b ld lw ju lf lg lx jx li nw ly ll lm nx lz lp lq ny ma lt lu lv im bi translated"><code class="fe nz oa ob mt b"><em class="it">new_ls = list(filter(None,ls))</em></code></p></blockquote><p id="3725" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">现在看起来像这样。</p><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/8829d1544fd295d659a690ba8b26bcad.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*mDVpyF0yN-VL75nabV4KNw.png"/></div></figure><p id="6595" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">如果我们更进一步，从第 12 个位置开始读列表。</p><blockquote class="ns nt nu"><p id="6815" class="la lb nv lc b ld lw ju lf lg lx jx li nw ly ll lm nx lz lp lq ny ma lt lu lv im bi translated"><code class="fe nz oa ob mt b">new_ls = new_ls[12:]</code></p></blockquote><p id="b0db" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">好吧，现在我们有一个名单。但是我们怎么把它变成一个数据框呢？首先，我们需要一次迭代 6 个项目，并将它们存储在元组中。然而，我们需要一个列表，以便熊猫图书馆可以将它读入数据框。</p><blockquote class="ns nt nu"><p id="925b" class="la lb nv lc b ld lw ju lf lg lx jx li nw ly ll lm nx lz lp lq ny ma lt lu lv im bi translated"><code class="fe nz oa ob mt b">is_data = list(zip(*[iter(new_ls)]*6))</code></p></blockquote><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/4a12d583934182812881d6c7c900d496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*_q3gV3uNyc8wFUveCEhSyA.png"/></div></figure><p id="2d72" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">太好了，这正是我们想要的。现在，我们只需将它读入数据框。</p><blockquote class="ns nt nu"><p id="f986" class="la lb nv lc b ld lw ju lf lg lx jx li nw ly ll lm nx lz lp lq ny ma lt lu lv im bi translated"><code class="fe nz oa ob mt b">Income_st = pd.DataFrame(is_data[0:])</code></p></blockquote><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/5de0cdead5f5f87508b8533c428a2ed7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*wOpKI5EjO2LRmvs3srF8KQ.png"/></div></figure><h1 id="399f" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">数据清理</h1><p id="7315" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">太好了。差不多完成了。我们只需要读取第一行作为列，第一列作为行索引。这里有一些清理。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0e5b" class="mb kj it mt b gy mx my l mz na">Income_st.columns = Income_st.iloc[0] # Name columns to first row of dataframe</span><span id="5d48" class="mb kj it mt b gy ni my l mz na">Income_st = Income_st.iloc[1:,] # start to read 1st row</span><span id="b6b9" class="mb kj it mt b gy ni my l mz na">Income_st = Income_st.T # transpose dataframe</span><span id="e5a3" class="mb kj it mt b gy ni my l mz na">Income_st.columns = Income_st.iloc[0] #Name columns to first row of dataframe</span><span id="5e12" class="mb kj it mt b gy ni my l mz na">Income_st.drop(Income_st.index[0],inplace=True) #Drop first index row</span><span id="facd" class="mb kj it mt b gy ni my l mz na">Income_st.index.name = ‘’ # Remove the index name</span><span id="644b" class="mb kj it mt b gy ni my l mz na">Income_st.rename(index={‘ttm’: ‘12/31/2019’},inplace=True) #Rename ttm in index columns to end of the year</span><span id="aa81" class="mb kj it mt b gy ni my l mz na">Income_st = Income_st[Income_st.columns[:-5]] # remove last 5 irrelevant columns</span></pre><p id="cc8f" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在对损益表、资产负债表和现金流使用相同的技术后，您的数据框架应该如下所示。</p><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi of"><img src="../Images/dde25dbc2e0b9de5039fae03d5221e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RPI76f9YR04JMcDr3At3zA.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk">Income Statement</figcaption></figure><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi ok"><img src="../Images/6b0d965e8b913db039940be2d6e0f603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TGyyywxLoEysrThe8bx_sQ.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk">Balance Sheet</figcaption></figure><figure class="mo mp mq mr gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi of"><img src="../Images/8d2381a65176eeda1146d6d3a5091641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ivjlHjcCvaD_lvVTwv22fw.png"/></div></div><figcaption class="og oh gj gh gi oi oj bd b be z dk">Cash flow statement</figcaption></figure><p id="2924" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">在对数据帧进行转置后，DateTime 被转换为行索引，而特性成为列名。</p><p id="92a5" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">以下是一些事后思考的问题:</p><ol class=""><li id="ebeb" class="ol om it lc b ld lw lg lx lj on ln oo lr op lv oq or os ot bi translated">这些特征如何与公司的股票价格相关联？你如何发现它们是否相关？</li><li id="9da9" class="ol om it lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">如果是，哪些时间段的股票价格与我们财务报表的特征相关？</li><li id="f1ec" class="ol om it lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">在开发算法交易模型时，你还可以用提取的数据做什么？</li></ol><p id="1f55" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">欢迎在回复中留下你的答案和评论，看看你是否能想出一些独特的答案。</p><p id="6a81" class="pw-post-body-paragraph la lb it lc b ld lw ju lf lg lx jx li lj ly ll lm ln lz lp lq lr ma lt lu lv im bi translated">感谢您阅读本文，如果您觉得有用，请随意分享。<a class="ae mn" href="https://medium.com/@dsjoench/replace-traditional-accounting-analysis-with-python-advanced-dupont-9b24f7719ee0" rel="noopener">这里</a>是另一篇关于利用新数据框架和用 Python 做进一步财务会计分析的文章。</p></div></div>    
</body>
</html>