<html>
<head>
<title>Intelligent, realtime and scalable video processing in Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure 中智能、实时和可扩展的视频处理</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/intelligent-realtime-and-scalable-video-processing-in-azure-201f87104f03?source=collection_archive---------5-----------------------#2019-06-18">https://towardsdatascience.com/intelligent-realtime-and-scalable-video-processing-in-azure-201f87104f03?source=collection_archive---------5-----------------------#2019-06-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="d7f8" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">1.介绍</h1><p id="26de" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在本教程中，创建了一个端到端项目，以便在 Azure 中进行智能、实时和可伸缩的视频处理。在这种情况下，可以利用火车的视频检测涂鸦和识别车皮号码。本项目的性质如下:</p><ul class=""><li id="9379" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">检测涂鸦和识别车牌号的智能算法</li><li id="00ba" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">从边缘到云端实时可靠地处理视频</li><li id="64aa" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">可扩展以适应视频数量的指数级增长</li><li id="9168" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">可以针对任何视频处理功能进行优化的功能项目</li></ul><p id="cf67" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">该项目的架构可描述如下:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/8c1587d0843e36b377f86e3b5f595f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZRrz6IbqeWnnwgyUisjnA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">1. Architecture overview</figcaption></figure><p id="fabd" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在这个博客中，这个架构是这样实现的:</p><ul class=""><li id="ac3e" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">2a。检测火车上涂鸦的认知服务(自定义视觉)</li><li id="d2b6" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">2b。识别货车编号的认知服务(计算机视觉 OCR)</li><li id="ab24" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3.用于视频并行处理的 Azure 函数</li><li id="bfae" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">4.用于可视化的 Power BI(可选)</li><li id="6561" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">5.用于数据自动分层的物联网边缘架构(可选)</li><li id="1e49" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">6.结论</li></ul><p id="bc2a" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在这个博客中，所有的视频处理都是在 Azure 中完成的。参考<a class="ae mv" href="https://medium.com/@rebremer/how-to-deploy-your-ai-model-on-edge-devices-8c38a9519c58" rel="noopener">这个后续教程</a>其中涂鸦检测是在摄像头(边缘)本身上完成的。下一章，将部署 Azure 认知服务。</p><h1 id="ffc4" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">2.Azure 认知服务</h1><p id="7808" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><a class="ae mv" href="https://azure.microsoft.com/en-us/services/cognitive-services/" rel="noopener ugc nofollow" target="_blank"> Azure 认知服务</a>是一组可以注入你的应用的 API。它包含语音识别、图片中的对象识别和语言翻译的智能算法。这些模型大多是预先训练好的，可以集成到您的项目中。大多数模型也可以作为容器部署在边缘。在这个项目中，将使用两个 API:</p><ul class=""><li id="fe05" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">将用于检测火车上涂鸦的自定义视觉。这个模型需要有/没有涂鸦的火车的图片来学习。这一步可以被视为“在已经在 Azure Cognitive Services 中训练过的图像识别模型的神经网络中添加最后一个自定义层”</li><li id="1c2b" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">将用于识别列车上车厢号计算机视觉 OCR。这种模式不需要培训，可以下架</li></ul><p id="f33c" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在本章的剩余部分，将执行以下步骤:</p><ul class=""><li id="09e9" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">2a。培训和部署自定义视觉 API 来检测涂鸦</li><li id="bc7d" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">2b。部署 OCR 计算机视觉 API</li></ul><p id="60fa" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">以及实现的架构的以下部分:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mw"><img src="../Images/79f443abb9e3302fcb0a8542ef14d09f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mvvPk6wZtieqGg4gQz6aTg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">2. Cognitive services to detect graffiti and identif wagon number</figcaption></figure><h2 id="3351" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">2a。培训和部署自定义视觉 API 来检测涂鸦</h2><p id="c968" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">转到<a class="ae mv" href="https://www.customvision.ai/" rel="noopener ugc nofollow" target="_blank">自定义视觉网站</a>并使用您的 Azure 广告凭证登录。登录后，选择创建具有属性“分类”和“多类(每个图像一个标签)”的自定义视觉项目，另请参见下文。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nj"><img src="../Images/bd13ace785468d2777160ab25724c5d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JelFZ8IxBwb9Hwr79I7-EA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">2a1. Create Custom Vision API project</figcaption></figure><p id="3818" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">然后将以下图像下载到以下 git 项目中的文件夹<a class="ae mv" href="https://github.com/rebremer/realtime_video_processing/tree/master/CognitiveServices" rel="noopener ugc nofollow" target="_blank">cognitive services</a>/CustomVisionImages 中:</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="bae4" class="mx jr it nl b gy np nq l nr ns"><a class="ae mv" href="https://github.com/rebremer/realtime_video_processing.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/realtime_video_processing.git</a></span></pre><p id="4d24" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">第一步，将带有涂鸦标签的涂鸦图片添加到您的项目中。其次，将带有标记涂鸦的 no_graffiti 图片添加到您的项目中，然后进行底片处理。然后使用快速通道训练模型，也见下文。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nt"><img src="../Images/63bb29cdecc6f017a92e8f3fb50569b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-wvtwamCJLSNOulyHEhlTg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">2a2. Train Custom Vision Api project</figcaption></figure><p id="3068" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">一旦您训练了模型，您可以通过点击“快速测试”来测试模型，然后使用之前下载的 git 项目从测试文件夹中选择一个图像。</p><h2 id="69ef" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">2b。部署 OCR 计算机视觉 API</h2><p id="f324" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">转到在步骤 2a 中创建的资源组，部署 OCR 计算机视觉 API。点击添加按钮，在搜索框中输入“<strong class="kq iu">计算机视觉</strong>”。选择 F0 作为定价层。部署计算机视觉 API 后，资源组将如下所示。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nu"><img src="../Images/37ddcf3267d15b1ec87c18fdaa776835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lk6GJypfn9GigLeX-IsPzg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">2b1. Resource group after Custom Vision API and Computer Vision for OCR is deployed</figcaption></figure><p id="6d20" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在下一章中，API 将用于检测视频中的涂鸦和货车号。</p><h1 id="cd24" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">3.用于并行视频处理的 Azure 函数</h1><p id="23ad" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一旦一个新的视频被上传(同步)到 Azure Blob 存储器中，它将立即被如下处理:</p><ul class=""><li id="7aba" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">Azure Blob 存储有一个触发器，它执行一个简单的 Azure 函数，向 Azure 队列发送消息</li><li id="3ebb" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">Azure Queue 有一个执行高级 Azure 功能的触发器，该功能 1)从 blob 存储帐户检索视频，2)使用 OpenCV 每秒获取一帧视频，3)检测帧上的涂鸦，识别货车号并将结果写入 csv 文件</li></ul><p id="9e92" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">Azure 队列步骤是并行视频所必需的。在 blob 触发器直接触发高级 Azure 功能的情况下，视频仅被串行处理。并行视频处理架构如下所示。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nv"><img src="../Images/6f3541bf283290b235dfe4bfbaba5554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9yKOfjq_YLsJMGMP4cERug.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3.1. Parallel video processing</figcaption></figure><p id="741d" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在本章的剩余部分，将执行以下步骤:</p><ul class=""><li id="3ca3" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">3a。用 docker 安装 Azure 函数的预备程序</li><li id="6c10" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3b。使用 blob 容器和队列创建 Azure 存储帐户</li><li id="4e00" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3c1。(可选)为 Azure 函数 Blob 触发器创建 docker 图像</li><li id="dcc1" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3c2。部署 Azure 函数 Blob 触发器</li><li id="42fc" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3d1。(可选)为 Azure 函数队列触发器创建 docker 映像</li><li id="59f5" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3d2。部署 Azure 函数队列触发器</li><li id="e72c" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">3e。用视频运行测试</li></ul><p id="aa43" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">以及实现的架构的以下部分:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi nw"><img src="../Images/a7cf8de3de39b92fafaed95d163ece59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8YCRmVp3_EbTSt1yOKVrfQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3.2. Steps in blog plotted on Architecture. Parallel video processing in bold as next step</figcaption></figure><p id="ed6d" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">其中并行视频处理能力的细节可以在前面的图 3.1“并行视频处理”中找到。</p><h2 id="be07" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">3a。用 docker 安装 Azure 函数的预备程序</h2><p id="0940" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了从视频创建帧，需要一个带有 OpenCV 的 Azure 函数。为此，使用了一个带有 Python 的 Azure 函数，该函数使用一个预装了 OpenCV 依赖项的 docker 映像。为此，需要安装以下预备程序:</p><ul class=""><li id="59b3" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">安装<a class="ae mv" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio 代码</a></li><li id="66cc" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">安装<a class="ae mv" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#v2" rel="noopener ugc nofollow" target="_blank"> Azure 核心工具版本 2.x </a>。</li><li id="677f" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">安装<a class="ae mv" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>。此博客需要 Azure CLI 版或更高版本。运行<code class="fe nx ny nz nl b">az --version</code>找到您拥有的版本。</li><li id="e3d3" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">(可选，如果你想创建自己的图像)安装<a class="ae mv" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank"> Docker </a></li><li id="3115" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">(强烈推荐)在运行本教程中的命令之前，请先执行本教程中的命令</li></ul><h2 id="9efd" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">3b。使用 blob 容器和队列创建 Azure 存储帐户</h2><p id="e42d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">需要 Azure 存储帐户来上传视频和运行 Azure 队列服务，Azure 功能将在这些服务上触发。打开 Visual Studio 代码，打开一个新的终端会话，并执行以下命令:</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="7f20" class="mx jr it nl b gy np nq l nr ns">az login</span><span id="871e" class="mx jr it nl b gy oa nq l nr ns">az group create -n blog-rtvideoproc-rg -l westeurope</span><span id="9bdf" class="mx jr it nl b gy oa nq l nr ns">az storage account create -n &lt;stor name&gt; -g blog-rtvideoproc-rg --sku Standard_LRS<br/>az storage container create -n videoblob --account-name &lt;stor name&gt;<br/>az storage container create -n pics --account-name &lt;stor name&gt;<br/>az storage container create -n logging --account-name &lt;stor name&gt;<br/>az storage blob upload -f Storage/ImageTaggingLogging.csv -c logging -n ImageTaggingLogging.csv --account-name &lt;stor name&gt; --type append</span><span id="ab55" class="mx jr it nl b gy oa nq l nr ns">az storage queue create -n videoqueue --account-name &lt;stor name&gt;</span></pre><p id="fcdc" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">确保将<stor name="">的全局唯一名称作为存储帐户名。</stor></p><h2 id="c58f" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">3c1。(可选)为 Azure 函数 Blob 触发器创建 docker 图像</h2><p id="f7d1" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这一步中，创建了一个简单的 Azure 函数，当一个新的视频被添加到存储帐户时，该函数被触发。然后提取视频的名称，并将其添加到在步骤 3b 中创建的存储队列中。打开 Visual Studio 代码，创建一个新的终端会话并执行以下命令(出现提示时选择 python 作为运行时)</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="3cdc" class="mx jr it nl b gy np nq l nr ns">func init afpdblob_rtv --docker<br/>cd afpdblob_rtv<br/>func new --name BlobTrigger --template "Azure Blob Storage trigger"</span></pre><p id="7cb6" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">随后，打开 Visual Studio 代码，选择“文件”，选择“打开文件夹”，然后选择在前面的命令中创建的目录 afpdblob_rtv，另请参见下文:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi ob"><img src="../Images/4be29515a189f6b8d8b6dd0d63a4fefe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CN-fZlvJv3RwOxf-LKYtzg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3c1. Azure Function Blob trigger</figcaption></figure><p id="84d0" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在此项目中，替换以下文件的内容</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="8932" class="mx jr it nl b gy np nq l nr ns">BlobTrigger/__init__.py<br/>BlobTrigger/function.json<br/>Dockerfile<br/>requirements.txt</span></pre><p id="29f5" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">同 github 项目内容<a class="ae mv" href="https://github.com/rebremer/realtime_video_processing/tree/master/AzureFunction/afpdblob/" rel="noopener ugc nofollow" target="_blank">https://github . com/reb remer/real time _ video _ processing/tree/master/azure function/afpdblob _ RTV/</a>。下一步是构建 docker 映像，并将 docker 映像发布到公共 Docker Hub。或者，也可以使用私有的 Azure 容器注册中心(ACR ),但是要确保设置了凭证。执行以下命令发布到 docker hub</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="9acb" class="mx jr it nl b gy np nq l nr ns">docker login<br/>docker build --tag &lt;&lt;your dockerid&gt;&gt;/afpdblob_rtv .<br/>docker push &lt;&lt;your dockerid&gt;&gt;/afpdblob_rtv:latest</span></pre><h2 id="d274" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">3c2。部署 Azure 函数 Blob 触发器</h2><p id="9c03" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这一步中，docker 映像被部署为 Azure 函数。如果您跳过了 3c1 部分来创建自己的 docker 映像，您可以用 bremerov 替换<your dockerid="">，即 bremerov/afpdblob_rtv:latest。执行以下命令:</your></p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="4943" class="mx jr it nl b gy np nq l nr ns">az appservice plan create --name blog-rtvideoproc-plan2 --resource-group blog-rtvideoproc-rg --sku B1 --is-linux</span><span id="29b2" class="mx jr it nl b gy oa nq l nr ns">az functionapp create --resource-group blog-rtvideoproc-rg --os-type Linux --plan blog-rtvideoproc-plan --deployment-container-image-name &lt;your dockerid&gt;/afpdblob_rtv:latest --name blog-rtvideoproc-funblob --storage-account &lt;stor name&gt;</span><span id="6a63" class="mx jr it nl b gy oa nq l nr ns">az functionapp config appsettings set --name blog-rtvideoproc-funblob --resource-group blog-rtvideoproc-rg --settings remoteStorageInputContainer="videoblob" `<br/>AzureQueueName="videoqueue" `<br/>remoteStorageAccountName="&lt;stor name&gt;" `<br/>remoteStorageAccountKey="&lt;stor key&gt;"</span><span id="fff4" class="mx jr it nl b gy oa nq l nr ns">az functionapp restart --name blog-rtvideoproc-funblob --resource-group blog-rtvideoproc-rg</span></pre><p id="826e" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">当功能被正确部署后，在门户中创建的功能如下</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oc"><img src="../Images/7cbd6de832877e051258a3f1ad5926ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLy8mcWVMOvrUqLAlYGhlw.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3c2.1 Azure Function Blob trigger deployed correctly</figcaption></figure><p id="483d" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">当您在 Blob Trigger 上打卡时，您可以看到 docker 图像中的代码。最后一步，添加应用洞察(见截图)并按照向导进行操作。这使您能够在 Monitor 选项卡中查看日志记录。作为测试，找到视频 Video1_NoGraffiti_wagonnumber。MP4，并使用向导将其上传到 blob 存储容器视频博客，见下文</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi od"><img src="../Images/b8c8c7705bc240873ae4acc9d29f8bf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6rqxT5RRbvXY0DNvJiFuNw.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3c2.2 Upload blob</figcaption></figure><p id="d1c1" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">视频上传后，使用 blob 触发器触发 Azure 函数，一个 json 文件被添加到 Azure queue videoqueue，如下所示</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oe"><img src="../Images/7d8c3ca0a56aa6a80de151aa278590f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*455btMWM4Y21dyuSHgORlQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3c2.3 Json file with video name added to queue</figcaption></figure><h2 id="62d1" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">3d1。(可选)为 Azure 函数队列触发器创建图像</h2><p id="2b23" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这一步中，创建了一个 advancedAzure 函数，当消息被发送到在步骤 3c2 中部署的 Azure 队列时，该函数被触发。打开 Visual Studio 代码，创建一个新的终端会话并执行以下命令(出现提示时选择 python 作为运行时)</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="2c8f" class="mx jr it nl b gy np nq l nr ns">func init afpdqueue_rtv --docker<br/>cd afpdqueue_rtv<br/>func new --name QueueTrigger --template "Azure Queue Storage trigger"</span></pre><p id="3e72" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">随后，打开 Visual Studio 代码，选择“文件”，选择“打开文件夹”，然后选择在前面的命令中创建的目录 afpdblob，另请参见下文:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi of"><img src="../Images/185dca543fb4d29e66cf1b9dc3c71eec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KYr2rsMm72Bs73_pM6HcLQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3d1.1 Azure Function Queue trigger</figcaption></figure><p id="33d4" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在此项目中，替换以下文件的内容</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="85ff" class="mx jr it nl b gy np nq l nr ns">QueueTrigger/__init__.py<br/>QueueTrigger/function.json<br/>Dockerfile<br/>requirements.txt</span></pre><p id="b453" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">同 github 项目内容<a class="ae mv" href="https://github.com/rebremer/realtime_video_processing/tree/master/AzureFunction/afpdblob/" rel="noopener ugc nofollow" target="_blank">https://github . com/rebremer/real time _ video _ processing/tree/master/azure function/afpdqueue _ RTV/</a>。下一步是构建 docker 映像，并将 docker 映像发布到公共 Docker Hub。或者，也可以使用私有的 Azure 容器注册中心(ACR ),但是要确保设置了凭证。执行以下命令发布到 docker hub</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="83ef" class="mx jr it nl b gy np nq l nr ns">docker login<br/>docker build --tag &lt;&lt;your dockerid&gt;&gt;/afpdqueue_rtv .<br/>docker push &lt;&lt;your dockerid&gt;&gt;/afpdqueue_rtv:latest</span></pre><h2 id="e1b4" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">3d2。部署 Azure 函数队列触发器</h2><p id="c18d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这一步中，docker 映像被部署为 Azure 函数。如果您跳过了 3d1 部分来创建自己的 docker 映像，您可以用 bremerov 替换<your dockerid="">,即 bremerov/afpdqueue_rtv:latest。执行以下命令:</your></p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="57cd" class="mx jr it nl b gy np nq l nr ns">az functionapp create --resource-group blog-rtvideoproc-rg --os-type Linux --plan blog-rtvideoproc-plan --deployment-container-image-name <strong class="nl iu">&lt;your dockerid&gt;</strong>/afpdqueue_rtv:latest --name blog-rtvideoproc-funqueue --storage-account &lt;stor name&gt;</span><span id="ba17" class="mx jr it nl b gy oa nq l nr ns">az functionapp config appsettings set --name blog-rtvideoproc-funqueue --resource-group blog-rtvideoproc-rg --settings `<br/>remoteStorageAccountName="&lt;stor name&gt;" `<br/>remoteStorageAccountKey="&lt;stor key&gt;" `<br/>remoteStorageConnectionString="&lt;stor full connection string&gt;" `<br/>remoteStorageInputContainer="videoblob" `<br/>AzureQueueName="videoqueue" `<br/>remoteStorageOutputContainer="pics" `<br/>region="westeurope" `<br/>cognitiveServiceKey="&lt;key of Computer vision&gt;" `<br/>numberOfPicturesPerSecond=1 `<br/>loggingcsv="ImageTaggingLogging.csv" `<br/>powerBIConnectionString=""</span><span id="7397" class="mx jr it nl b gy oa nq l nr ns">az functionapp restart --name blog-rtvideoproc-funqueue --resource-group blog-rtvideoproc-rg</span></pre><p id="0e0e" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">当正确部署了这些功能后，就会在门户中创建如下功能。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi og"><img src="../Images/310bb431272cf2f0dfb57b0a755d2981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BvC74xlnDvrWpEHGZT28XA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3d2.1 Azure Function Queue trigger deployed correctly</figcaption></figure><p id="6242" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">同样，选择添加 Applications Insights(参见顶部屏幕截图)，您可以选择为 blob 触发器创建的相同 application Insights 资源。Application Insights 可用于查看 monitor 选项卡中 QueueTrigger 的日志记录。</p><p id="dbb8" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">如果 Azure 函数队列触发器成功运行，Azure 队列中的消息将被处理，图片日志可在 pics 目录中找到，见下文</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oh"><img src="../Images/a3139ef72c13ad17abe9d829a5d49801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7oPEvcYQ8oQhOU66bC2tIw.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">3d2.2 Videos logging in frames</figcaption></figure><p id="a091" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">日志也可以在文件 logging/imagetaggingloging . CSV 中找到。在下一部分中，输出在 Power BI 中可视化。</p><h1 id="ddc3" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">4.用于可视化的 Power BI(可选)</h1><p id="9cb0" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">Power BI 旨在提供交互式可视化和商业智能功能，其界面非常简单，最终用户可以创建自己的报告和仪表板。在这个博客中，它被用来创建一个流媒体仪表板，当检测到涂鸦伴随着车号时，它会发出警报。在本章的剩余部分，将执行以下步骤:</p><ul class=""><li id="3df2" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">4a。安装电源 BI 的准备工作</li><li id="89e1" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">4b。创建流式数据集</li><li id="4784" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">4c。从磁贴创建仪表板</li><li id="442c" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">4d。将 Power BI 链接添加到 Azure 函数</li></ul><p id="1d79" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">以及实现的架构的以下部分:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oi"><img src="../Images/0fa5af1ef05895fd39d8bd1d24ca11dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t_o7Emmoya0ERZhY9UCdQQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">4. Steps in blog plotted on Architecture. Visualize output in bold as next step</figcaption></figure><p id="5144" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">请注意，完成博客物联网中心的最后一步并不需要可视化输出。</p><p id="63ed" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated"><strong class="kq iu"> 4a。安装电源 BI </strong>的准备工作</p><p id="c1b3" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在这篇博客中，所有数据集和仪表板将直接在 Power BI 中创建，因此没有必要安装 Power BI dashboard。转到以下链接创建帐户:</p><div class="oj ok gp gr ol om"><a href="https://powerbi.microsoft.com/en-us/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">Power BI |交互式数据可视化 BI 工具</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">借助 Microsoft Power BI 的交互式数据可视化 BI 工具，以全新的方式查看您公司的数据。</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">powerbi.microsoft.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa mp om"/></div></div></a></div><p id="26cf" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated"><strong class="kq iu"> 4b。创建流数据集</strong></p><p id="c3f7" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">登录后，转到您的工作区，选择创建，然后选择流式数据集。这个流数据集是从您的 Azure 函数队列触发器推送的。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pb"><img src="../Images/f741903471d63487bfa41254c32ca493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aCfedsmNln_csntHsKJ6AA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">4b1. Create streaming dataset</figcaption></figure><p id="af38" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在向导中选择 API {}，然后添加以下字段(字段也可以在 __init__ 中)。publishPowerBI()方法中 Azure 函数队列触发器的 py</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="de68" class="mx jr it nl b gy np nq l nr ns">location (Text)<br/>track (Text)<br/>time (DateTime)<br/>trainNumber (Text)<br/>probGraffiti (Number)<br/>caption (Text)<br/>sasPictureTrainNumber (Text)<br/>sasPictureGraffiti (Text)</span></pre><h2 id="e178" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">4c。从磁贴创建仪表板</h2><p id="5dca" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在下一步中，将基于流式数据集创建一个实时控制面板，一旦有新数据进入，该控制面板将自动刷新。首先，创建一个报表和一个可视化表格。只需将所有字段添加到该表格中。接下来，选择“锁定视觉对象”来创建视觉对象的活动 dasboard，也见下文。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pc"><img src="../Images/f9f572b0686e71b42998d4781ea62a3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Gxu_K3ioXEi4bh99vAi0Q.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">4c1. Create streaming dataset</figcaption></figure><p id="4ba7" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">这样，可以在一个报告中创建多个视觉效果，并发布到同一个仪表板上。请参见下面的仪表板示例。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pd"><img src="../Images/b702f109d2a7ea7f142f599f750115f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLGtpAZzgm7F-b0IJs9Yog.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">4c2. Example dashboard</figcaption></figure><h2 id="0946" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">4d。将 Power BI 链接添加到 Azure 函数</h2><p id="6501" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">最后，需要将 Power BI push URL 添加到 Azure 函数队列触发器中，以便发布数据。单击您的流数据集的…,选择 API 信息并复制 URL，如下所示。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pe"><img src="../Images/302e818f586bdf838d5183d9fe1a0785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nzrOEeq7gD7lpl9-Zt2MLQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">4d1. API info</figcaption></figure><p id="f421" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">随后，将 Power BI push URL 添加到您的 Azure 函数队列触发器，并重新启动该函数，见下文。</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="eaad" class="mx jr it nl b gy np nq l nr ns">az functionapp config appsettings set --name blog-rtvideoproc-funqueue --resource-group blog-rtvideoproc-rg --settings `<br/>powerBIConnectionString="&lt;Power BI push URL"</span><span id="9f96" class="mx jr it nl b gy oa nq l nr ns">az functionapp restart --name blog-rtvideoproc-funqueue --resource-group blog-rtvideoproc-rg</span></pre><p id="7450" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">删除视频 Video1_NoGraffiti_wagonnumber。MP4 并将其再次上传到您的 blob 存储帐户的 videoblob 容器中。这将把数据推送到您的 Power BI 仪表板。</p><h1 id="c0ca" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">5.用于数据自动分层的物联网边缘(可选)</h1><p id="bf41" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">物联网边缘上的 Azure Blob 存储是一个轻量级 Azure 一致模块，它提供本地块 Blob 存储。借助分层功能，数据会自动从本地 blob 存储上传到 Azure。这在以下情况下尤其有用:1)设备(如照相机)存储容量有限，2)要处理大量设备和数据，以及 3)互联网连接时断时续。在这篇博客中，一个相机在一个 Ubuntu 虚拟机上被模拟，这个虚拟机使用了 Blob on Edge。在本章的剩余部分，将执行以下步骤:</p><ul class=""><li id="bc4a" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">5a。创建物联网中心和 Ubuntu 虚拟机作为边缘设备</li><li id="9d78" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">5b。将模块 Blob 存储添加到边缘设备</li><li id="1989" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">5c。使用边缘设备模拟摄像机</li></ul><p id="3755" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">以及实现的架构的以下部分:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pf"><img src="../Images/4d232181734bf49af33f60c443e32f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGBCPkei_kTjqqUtfRRVig.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">5. Steps in blog plotted on Architecture. IoT Hub Edge in bold as next step</figcaption></figure><h2 id="0f19" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">5a。在物联网边缘安装 Azure Blob 存储的准备工作</h2><p id="962d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了在 IoT Edge 上使用 Azure Blob 存储，需要运行以下命令(更多详细信息，请参见<a class="ae mv" href="https://docs.microsoft.com/en-us/azure/iot-edge/quickstart-linux" rel="noopener ugc nofollow" target="_blank">此处</a>)。</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="7567" class="mx jr it nl b gy np nq l nr ns">az extension add --name azure-cli-iot-ext</span><span id="3f44" class="mx jr it nl b gy oa nq l nr ns">az vm create --resource-group blog-rtvideoproc-rg --name blog-rtvideoproc-edge --image microsoft_iot_edge:iot_edge_vm_ubuntu:ubuntu_1604_edgeruntimeonly:latest --admin-username azureuser --generate-ssh-keys --size Standard_DS1_v2</span><span id="893a" class="mx jr it nl b gy oa nq l nr ns">az iot hub create --resource-group blog-rtvideoproc-rg --name blog-rtvideoproc-iothub --sku F1</span><span id="0b8c" class="mx jr it nl b gy oa nq l nr ns">az iot hub device-identity create --hub-name blog-rtvideoproc-iothub --device-id blog-rtvideoproc-edge --edge-enabled</span></pre><p id="6529" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">运行以下命令检索密钥</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="b1e3" class="mx jr it nl b gy np nq l nr ns">az iot hub device-identity show-connection-string --device-id blog-rtvideoproc-edge --hub-name blog-rtvideoproc-iothub</span></pre><p id="6f61" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">并使用以下命令将此密钥添加到您的虚拟机中</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="6556" class="mx jr it nl b gy np nq l nr ns">az vm run-command invoke -g blog-rtvideoproc-rg -n blog-rtvideoproc-edge --command-id RunShellScript --script "/etc/iotedge/configedge.sh '&lt;device_connection_string from previous step&gt;'"</span></pre><p id="2d5d" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">正确创建物联网集线器和边缘设备后，您应该会在门户中看到以下内容</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pg"><img src="../Images/7c23e8a8e0c3acac373778912a4f59d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N2RuiBFsJx8RJWC2JIiToA.png"/></div></div></figure><h2 id="e2d4" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">5b。将模块 Blob 存储添加到边缘设备</h2><p id="0ec8" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在该步骤中，Blob 存储模块被安装在边缘设备上。选择您的边缘设备，并使用 Azure 门户按照教程中的步骤进行操作</p><div class="oj ok gp gr ol om"><a href="https://docs.microsoft.com/en-us/azure/iot-edge/how-to-deploy-blob" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">将 Azure Blob 存储模块部署到设备- Azure IoT Edge</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">有几种方法可以将模块部署到物联网边缘设备，所有这些方法都适用于物联网边缘上的 Azure Blob 存储…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">docs.microsoft.com</p></div></div><div class="ov l"><div class="ph l ox oy oz ov pa mp om"/></div></div></a></div><p id="8d44" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在这种情况下，使用以下容器创建选项</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="2e2b" class="mx jr it nl b gy np nq l nr ns">{<br/>  "Env":[<br/>    "LOCAL_STORAGE_ACCOUNT_NAME=localvideostor",<br/>    "LOCAL_STORAGE_ACCOUNT_KEY=xpCr7otbKOOPw4KBLxtQXdG5P7gpDrNHGcrdC/w4ByjMfN4WJvvIU2xICgY7Tm/rsZhms4Uy4FWOMTeCYyGmIA=="<br/>  ],<br/>  "HostConfig":{<br/>    "Binds":[<br/>        "/srv/containerdata:/blobroot"<br/>    ],<br/>  "PortBindings":{<br/>    "11002/tcp":[{"HostPort":"11002"}]<br/>    }<br/>  }<br/>}</span></pre><p id="1896" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">以及下面的“设置模块 twin 的期望属性”:</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="d9b9" class="mx jr it nl b gy np nq l nr ns">{<br/>  "properties.desired": {<br/>    "<!-- -->deviceToCloudUploadProperties<!-- -->": {<br/>      "<!-- -->uploadOn<!-- -->": true,<br/>      "uploadOrder": "OldestFirst",<br/>      "<!-- -->cloudStorageConnectionString<!-- -->": "<!-- -->&lt;your <!-- -->stor conn string&gt;",<br/>      "<!-- -->storageContainersForUpload<!-- -->": {<br/>        "localvideoblob": {<br/>          "target": "<!-- -->videoblob<!-- -->"<br/>        }<br/>      },<br/>      <!-- -->"deleteAfterUpload":false<br/>    }<br/>  }<br/>}</span></pre><p id="96f3" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">如果一切都部署成功，门户中应该有以下内容</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pi"><img src="../Images/099849cd2f7c09ba4735bf03be4320e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05ImeX3rOeBIEh8fM1yyyA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">5b. Blob on Edge successfully deployed</figcaption></figure><p id="bf91" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">此外，您可以从 CLI 运行以下命令，以查看是否一切安装正确。</p><pre class="mg mh mi mj gt nk nl nm nn aw no bi"><span id="00ad" class="mx jr it nl b gy np nq l nr ns">ssh azureuser@&lt;&lt;public IP of your Ubuntu VM&gt;&gt;<br/>sudo systemctl status iotedge <br/>journalctl -u iotedge<br/>cd /srv/containerdata<br/>ls -la</span></pre><p id="6b39" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">如果一切都部署成功，我们可以运行一个相机模拟器，上传一个文件到您的本地 blob 存储在下一部分。</p><h2 id="acf7" class="mx jr it bd js my mz dn jw na nb dp ka kz nc nd ke ld ne nf ki lh ng nh km ni bi translated">5c。使用边缘设备模拟摄像机</h2><p id="decb" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这篇博客的最后一部分，我们将使用一个相机模拟器，将一个文件放在边缘设备上。</p><p id="aa04" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">首先，您需要打开 Ubuntu 虚拟机的入站端口 11002。找到虚拟机的网络安全组(NSG)并添加端口 11002，另请参见下文</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pj"><img src="../Images/3d3e46f46191f59037eb28440e6637dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kQS8W2D-Kw8GO0XjhkVcwQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">5c1. Add port 11002 to NSG</figcaption></figure><p id="3342" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">从 CameraSimulator/CameraSimulator . py 中的 github 运行代码，在这个项目中，替换你的 UbuntuVM 的 IP 地址和你要上传的视频文件的位置。</p><p id="eb1b" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">该模拟器上传视频并触发本教程中完成的所有操作，即 1)将视频同步到存储帐户，因为自动分层已启用，2)触发处理视频的博客触发器和队列触发器功能，3)调用认知服务来检测涂鸦并识别货车编号，以及 4)将结果推送到 Power BI dashboard，另请参见下文。</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi pk"><img src="../Images/7aab7d818671cb7ec8375d9c874c26d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W2-kFTEFo7JBVwRTjI3hIw.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">5c2. End result project</figcaption></figure><h1 id="da5d" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">6.结论</h1><p id="ef21" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这篇博客中，为了在 Azure 中进行智能、实时和可伸缩的视频处理，创建了一个端到端的项目。在这方面，创造了一种能力，可以检测涂鸦和识别车厢号码使用视频的火车。在这种情况下，使用了以下 Azure 函数</p><ul class=""><li id="d512" class="lm ln it kq b kr lo kv lp kz lq ld lr lh ls ll lt lu lv lw bi translated">认知服务被用作智能算法来检测火车上的涂鸦(自定义视觉 API)和 OCR 来识别货车编号(计算机视觉 API)</li><li id="1eef" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">使用 Python 和 docker 的 Azure 函数以可扩展的方式实时处理视频</li><li id="3a67" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">Azure Blob 存储和边缘计算用于处理从边缘到云的可靠视频。</li><li id="3915" class="lm ln it kq b kr lx kv ly kz lz ld ma lh mb ll lt lu lv lw bi translated">使用仪表盘中的流数据增强 BI 的可视化输出</li></ul><p id="bb32" class="pw-post-body-paragraph ko kp it kq b kr lo kt ku kv lp kx ky kz mc lb lc ld md lf lg lh me lj lk ll im bi translated">在这个博客中，所有的视频处理都是在 Azure 中完成的。在本博客的后续部分，涂鸦检测模型将被部署在摄像头(edge)上，这样可以节省数据传输，并且可以节省成本。已经看到<a class="ae mv" href="https://github.com/Azure-Samples/Custom-vision-service-iot-edge-raspberry-pi" rel="noopener ugc nofollow" target="_blank">本教程</a>这是如何在不同的场景中完成的。最后，请参见下面描述的项目架构:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/8c1587d0843e36b377f86e3b5f595f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZRrz6IbqeWnnwgyUisjnA.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk">6. Intelligent, realtime and scalable video processing in Azure</figcaption></figure></div></div>    
</body>
</html>