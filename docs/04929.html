<html>
<head>
<title>Speeding up data wrangling with dtplyr</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 dtplyr 加速数据争论</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introduction-to-dtplyr-783d89e9ae56?source=collection_archive---------12-----------------------#2019-07-25">https://towardsdatascience.com/introduction-to-dtplyr-783d89e9ae56?source=collection_archive---------12-----------------------#2019-07-25</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><figure class="iu iv gp gr iw ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi it"><img src="../Images/b72ce2982282dc1cbb4ce461d0ea02b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uiK90opmX3b3eQuHxaD8Tg.png"/></div></div></figure><div class=""/><div class=""><h2 id="20c4" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">了解如何轻松地将<code class="fe kv kw kx ky b">dplyr</code>的可读性与<code class="fe kv kw kx ky b">data.table</code>的性能结合起来！</h2></div><p id="eaab" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">我最近看到了哈德利·韦翰关于《T2》上映的推文。这是一个支持在<code class="fe kv kw kx ky b">data.table</code>对象上使用<code class="fe kv kw kx ky b">dplyr</code>语法的包。<code class="fe kv kw kx ky b">dtplyr</code>自动将<code class="fe kv kw kx ky b">dplyr</code>语法翻译成等价的<code class="fe kv kw kx ky b">data.table</code>，最终导致性能提升。</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="lz ma l"/></div></figure><blockquote class="mb mc md"><p id="7999" class="kz la me lb b lc ld kh le lf lg kk lh mf lj lk ll mg ln lo lp mh lr ls lt lu io bi translated">漫威:无限战争是历史上最雄心勃勃的跨界事件。哈德利·韦翰:拿着我的啤酒。</p></blockquote><p id="1573" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">我一直很喜欢<code class="fe kv kw kx ky b">dplyr</code>的易用性和可读性，也很渴望对比一下软件包的性能。让我们看看它在实践中是如何工作的！</p><h1 id="d276" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">加载库</h1><p id="1b42" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated">对于本文，我们需要通过运行<code class="fe kv kw kx ky b">devtools::install_github(“tidyverse/dtplyr”)</code>从 GitHub 安装<code class="fe kv kw kx ky b">dtplyr</code>，我们使用<code class="fe kv kw kx ky b">microbenchmark</code>进行性能比较。</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><h1 id="7af6" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">生成数据集</h1><p id="2279" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated">我们生成一个人工数据集。我首先想到的是订单注册表，我们在其中存储:</p><ul class=""><li id="2a08" class="ng nh jg lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe kv kw kx ky b">id</code>客户端的</li><li id="850d" class="ng nh jg lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe kv kw kx ky b">name</code>产品的</li><li id="bf46" class="ng nh jg lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe kv kw kx ky b">date</code>采购</li><li id="3068" class="ng nh jg lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe kv kw kx ky b">amount</code>购买的产品</li><li id="4203" class="ng nh jg lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">某一产品的单位<code class="fe kv kw kx ky b">price</code></li></ul><p id="0622" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">由于这只是一个玩具示例，我们不会深入研究数据集背后的逻辑。我们可以同意这有点像现实生活中的场景。为了测试不同方法的性能，我们生成了 1000 万行数据。</p><p id="a462" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">通过使用<code class="fe kv kw kx ky b">lazy_dt()</code>我们触发了惰性评估——直到我们通过使用<code class="fe kv kw kx ky b">as.data.table()</code>、<code class="fe kv kw kx ky b">as.data.frame()</code>或<code class="fe kv kw kx ky b">as_tibble()</code>明确请求它，才执行任何计算。为了便于比较，我们储存一个<code class="fe kv kw kx ky b">data.frame</code>，一个<code class="fe kv kw kx ky b">data.table</code>，一个【懒人】<code class="fe kv kw kx ky b">data.table</code>。</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><p id="1602" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">我们可以通过打印结果来预览转换以及生成的<code class="fe kv kw kx ky b">data.table</code>代码:</p><pre class="lv lw lx ly gt nu ky nv nw aw nx bi"><span id="04e4" class="ny mj jg ky b gy nz oa l ob oc"><strong class="ky jh">Source: </strong>local data table [?? x 3]<br/><strong class="ky jh">Call:   </strong>`_DT3`[date &lt; as.Date("2019-02-01"), .(id, product, date)][order(date)]</span><span id="48b2" class="ny mj jg ky b gy od oa l ob oc">  id    product date      <br/>  <em class="me">&lt;chr&gt;</em> <em class="me">&lt;chr&gt;</em>   <em class="me">&lt;date&gt;</em>    <br/>1 DHQ   GVF     2019-01-01<br/>2 NUB   ZIU     2019-01-01<br/>3 CKW   LJH     2019-01-01<br/>4 AZO   VIQ     2019-01-01<br/>5 AQW   AGD     2019-01-01<br/>6 OBL   NPC     2019-01-01</span></pre><p id="5bb8" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">通常，这应该用于调试。我们应该指出我们希望在管道末端接收哪种类型的对象，以清楚地表明我们已经完成了转换。</p><h1 id="b969" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">用例 1:过滤、选择和排序</h1><p id="556e" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated">假设我们想要一个 2019 年 2 月 1 日之前发生的交易列表，按日期排序，我们不关心金额或价格。</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><figure class="lv lw lx ly gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi oe"><img src="../Images/66fbd2e99ec5efe8b6949c91fe9f165f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2QaLHYp2e1LOP1S8AneVnw.png"/></div></div></figure><p id="de97" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">我们看到<code class="fe kv kw kx ky b">dtplyr</code>比<code class="fe kv kw kx ky b">data.table</code>稍慢，但是通过观察中间时间，它比<code class="fe kv kw kx ky b">dplyr.</code>快了大约 4 倍</p><h1 id="f717" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">用例 2:过滤后添加新变量</h1><p id="6757" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated">在本例中，我们要过滤产品数量超过 5000 的订单，并计算订单值，即<code class="fe kv kw kx ky b">amount * price</code>。</p><p id="a19d" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">大部分使用<code class="fe kv kw kx ky b">mutate()</code>的表达式必须复制(不要原地修改)，直接使用<code class="fe kv kw kx ky b">data.table</code>就没必要了。为了应对这种情况，我们可以在<code class="fe kv kw kx ky b">lazy_dt()</code>中指定<code class="fe kv kw kx ky b">immutable = FALSE</code>来退出上述行为。</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><figure class="lv lw lx ly gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi of"><img src="../Images/8df122fb616e6aee74a5b8988ec0c081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2j8CREHylv_VZcVc-YpQLA.png"/></div></div></figure><p id="416b" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">这一次，差异没有那么明显。当然，这取决于对表进行操作的复杂性。</p><h1 id="41c5" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">用例 3:顶层聚合</h1><p id="771f" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated">假设我们想要:</p><ul class=""><li id="7e48" class="ng nh jg lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">根据金额&lt;= 4000</li><li id="b810" class="ng nh jg lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">Calculate the average order value per customer</li></ul><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><figure class="lv lw lx ly gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi og"><img src="../Images/1e81517d341d0e79c4be5a84627c6cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a0y-pSsMW1lMltjZq8tJKQ.png"/></div></div></figure><p id="f665" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">This time we get ~3x improvement in median execution time.</p><h1 id="1360" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">Use-case 4: Joining</h1><p id="f53c" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated">In the last example, we consider a case of joining datasets. For that, we create a new  【T8】 / 【T9】  called  【T10】  by selecting 75% of the available products and assigning a random letter to them. We can assume that the letter corresponds to a distribution center (variable called  【T11】 ), from which the item is shipped.</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><p id="3a3c" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">We want to calculate the average order value per distribution center. In case we do not have data regarding the distribution center, we discard the row.</p><figure class="lv lw lx ly gt ix"><div class="bz fp l di"><div class="nf ma l"/></div></figure><figure class="lv lw lx ly gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi oh"><img src="../Images/63675c03a5a9c1a17608cbf5726d744b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HXewcRm37HGxRBJ30n31Cg.png"/></div></div></figure><p id="cd79" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">Again we see a ~3x speedup in the median execution time.</p><h1 id="c653" class="mi mj jg bd mk ml mm mn mo mp mq mr ms km mt kn mu kp mv kq mw ks mx kt my mz bi translated">Conclusions</h1><p id="c691" class="pw-post-body-paragraph kz la jg lb b lc na kh le lf nb kk lh li nc lk ll lm nd lo lp lq ne ls lt lu io bi translated"> 【T12】  is (and always will be) slightly slower than  【T13】 . That is because:</p><p id="3401" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">1. Each  【T14】  verb must be converted to a  【T15】  equivalent. For large datasets, this should be negligible, as these translation operations take time proportional to the complexity of the input code, rather than the amount of data.<br/> 2 过滤所有订单。一些<code class="fe kv kw kx ky b">data.table</code>表达式没有直接的<code class="fe kv kw kx ky b">dplyr</code>等价物。<br/> 3。用例 2 中提到的不变性问题。</p><p id="9774" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">综上所述，我认为<code class="fe kv kw kx ky b">dtplyr</code>是对<code class="fe kv kw kx ky b">tidyverse</code>的一个有价值的补充，因为只需对<code class="fe kv kw kx ky b">dplyr</code>代码做很小的改动，我们就可以实现显著的性能提升。</p><p id="f693" class="pw-post-body-paragraph kz la jg lb b lc ld kh le lf lg kk lh li lj lk ll lm ln lo lp lq lr ls lt lu io bi translated">一如既往，我们欢迎任何建设性的反馈。你可以在推特上或评论中联系我。你可以在我的<a class="ae oi" href="https://github.com/erykml/medium_articles/blob/master/Data%20Wrangling/introduction_to_dtplyr.Rmd" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到本文使用的代码。</p></div></div>    
</body>
</html>