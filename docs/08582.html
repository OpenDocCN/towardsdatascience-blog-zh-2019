<html>
<head>
<title>Productionalize Your Machine Learning Model Using Flask And Google App Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Flask 和 Google App Engine 生产您的机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/productionalize-your-machine-learning-model-using-flask-and-google-app-engine-594896714d69?source=collection_archive---------33-----------------------#2019-11-19">https://towardsdatascience.com/productionalize-your-machine-learning-model-using-flask-and-google-app-engine-594896714d69?source=collection_archive---------33-----------------------#2019-11-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/720d5da8b15d6c9552e4d75f9b7a7f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hCm1bgT7T-nH1PjfwxQ6gA.png"/></div></div></figure><p id="4b7c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个小教程将帮助你理解一个经过训练的机器学习模型是如何用于生产的。</p><p id="3cfb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如今，你可以找到很多学习数据科学和机器学习的教程、MOOCs 和视频。但它们都没有解释当你在 jupyter notebook 或其他 IDE 中的本地系统上训练和优化一个机器学习模型后，你的机器学习模型会发生什么。</p><p id="cf32" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在生产环境中，没有人坐在系统前面提供输入并检查您创建的模型的输出。</p><p id="1ca3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，在本教程中，我们将在 flask 中创建一个简单的 RESTful web 服务，以 API 响应的形式提供我们的机器学习模型输出，然后在谷歌云平台的应用引擎中部署该应用。</p><blockquote class="kz la lb"><p id="660a" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">设置和要求:</strong></p></blockquote><ol class=""><li id="52bc" class="lg lh it kd b ke kf ki kj km li kq lj ku lk ky ll lm ln lo bi translated">Python 3.6</li><li id="9fe7" class="lg lh it kd b ke lp ki lq km lr kq ls ku lt ky ll lm ln lo bi translated">文字编辑器</li><li id="cb81" class="lg lh it kd b ke lp ki lq km lr kq ls ku lt ky ll lm ln lo bi translated">谷歌云平台账户</li><li id="2e1b" class="lg lh it kd b ke lp ki lq km lr kq ls ku lt ky ll lm ln lo bi translated">Jupyter 笔记本</li></ol><p id="ce62" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另外，请安装下面指定的库:</p><p id="4295" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在 Flask 中创建 RESTful API 所需的库</p><blockquote class="kz la lb"><p id="8d93" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">训练一个样本机器学习模型:</strong></p></blockquote><p id="3c68" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我将在波士顿住房数据集上训练一个样本线性回归模型，这两个数据集都可以在 Scikit-learn 库中找到，最后我将使用 Joblib 将训练好的模型保存在一个文件中。</p><p id="08a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是示例 python 代码:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="0074" class="md me it lz b gy mf mg l mh mi">## Importing required Libraries</span><span id="c7fe" class="md me it lz b gy mj mg l mh mi">import pandas as pd<br/>import numpy as np<br/>## for sample dataset<br/>from sklearn.datasets import load_boston<br/>## for splitting data into train and test<br/>from sklearn.model_selection import train_test_split<br/>## LinearRegression model<br/>from sklearn.linear_model import LinearRegression<br/>## For saving trained model as a file<br/>from sklearn.externals import joblib</span><span id="c751" class="md me it lz b gy mj mg l mh mi">## Getting sample dataset<br/>boston_dataset = load_boston()<br/>boston = pd.DataFrame(boston_dataset.data, columns=boston_dataset.feature_names)<br/>boston['MEDV'] = boston_dataset.target</span><span id="eecc" class="md me it lz b gy mj mg l mh mi">## Preparing variable<br/>X = pd.DataFrame(np.c_[boston['LSTAT'], boston['RM']], columns = ['LSTAT','RM'])<br/>Y = boston['MEDV']</span><span id="055a" class="md me it lz b gy mj mg l mh mi">## splitting train and test data<br/>X_train, X_test, Y_train, Y_test = train_test_split(X, Y, test_size = 0.2, random_state=5)<br/>#print(X_train.shape)<br/>#print(X_test.shape)<br/>#print(Y_train.shape)<br/>#print(Y_test.shape)</span><span id="2c29" class="md me it lz b gy mj mg l mh mi">## Training Model<br/>lin_model = LinearRegression()<br/>lin_model.fit(X_train, Y_train)</span><span id="1a53" class="md me it lz b gy mj mg l mh mi">## Saving trained model<br/>joblib.dump(lin_model, 'test_model')</span></pre><blockquote class="kz la lb"><p id="3b45" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">创建一个简单的烧瓶应用程序:</strong></p></blockquote><p id="3745" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，我们将创建一个简单的 RESTful 应用程序，将我们的模型输出作为 API 响应。我们的应用程序将完成以下任务:</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mk"><img src="../Images/eede2ab2225fd1e2a5f224b6124fe26d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5eCFwSDUvMyjV9ddsHxBJg.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Task flow of our API</figcaption></figure><p id="5482" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是 flask 应用程序的代码。你也可以从 GitHub 获得，使用这个<a class="ae mp" href="https://github.com/aakashrathore92/mlprodflask/blob/master/test_flask.py" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="faee" class="md me it lz b gy mf mg l mh mi">from flask import Flask,request<br/>from flask_restful import Resource,Api<br/>from sklearn.externals import joblib<br/>import pandas as pd</span><span id="73c6" class="md me it lz b gy mj mg l mh mi">app=Flask(__name__)<br/>api=Api(app)</span><span id="e7f4" class="md me it lz b gy mj mg l mh mi">class Test_index(Resource):<br/>    def post(self):<br/>        loaded_model = joblib.load('./model/test_model')<br/>        test_data=request.get_json()<br/>        input_df=pd.DataFrame([test_data])<br/>        input_df.rename(columns={"input_lstat":'LSTAT',"input_rm":'RM'},inplace=True)<br/>        print(input_df)<br/>        y_train_predict = loaded_model.predict(input_df)<br/>        test_output=pd.DataFrame(y_train_predict,columns={'output'})<br/>        output=test_output.to_dict(orient="list")<br/>        return output</span><span id="0082" class="md me it lz b gy mj mg l mh mi">api.add_resource(Test_index,"/test")<br/>if __name__=='__main__':<br/>    app.run(debug=True)</span></pre><blockquote class="kz la lb"><p id="103e" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">测试我们的应用程序(本地或开发环境):</strong></p></blockquote><p id="e353" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在编写完我们的应用程序后，我们将在本地或开发环境中进行测试，然后在 Google 云平台中进行生产。</p><p id="1447" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我使用 Gunicorn，一个运行我们应用程序的 WSGI 应用服务器。</p><p id="476c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">只需在终端中打开项目目录并运行以下命令:</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="5d69" class="md me it lz b gy mf mg l mh mi">$ gunicorn test_flask:app</span></pre><p id="07c1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将获得运行我们的应用程序的本地端口的详细信息:</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/7fb0eaa0adcda49133e068b94b1f4c9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rAHX562PSzMG6rJLjR6B0g.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">App running in gunicorn server</figcaption></figure><p id="e5ac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们用 postman 应用程序测试 API 响应。我们将向应用程序端点发出一个 POST 请求，传递一个包含输入参数的 JSON 请求体，如果没有错误，我们将得到一个包含模型预测的 JSON 对象响应。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/bdc55e0e65c0193b4a5efbf822e7a105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FCaR2BIbbRKAlPgsjfrQcA.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Testing app response in Postman</figcaption></figure><blockquote class="kz la lb"><p id="907b" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">在 Google 云平台中将应用部署到生产:</strong></p></blockquote><p id="37c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们测试的应用程序部署在本地系统中。为了使我们的系统可以全球访问，我们需要将它部署在一些服务器上，这些服务器有一个全球 URL 来评估我们的应用程序。</p><p id="01eb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为此，我们将使用谷歌云平台的应用程序引擎。</p><p id="0058" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="lc">注意:在接下来的步骤之前，请检查您是否拥有 Google Cloud Platform 帐户，以及您的系统中是否安装了 google cloud SDK。你可以在这里</em>  <em class="lc">找到设置 google SDK </em> <a class="ae mp" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank"> <em class="lc">的细节。</em></a></p><p id="481e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Google App Engine 需要一个名为“app.yaml”的部署描述符文件，用于在 google cloud 中部署我们的应用程序。</p><p id="7e57" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是部署描述符 app.yaml 文件的内容:</p><p id="487c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">app.yaml 文件的内容</p><p id="a682" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在创建一个目录结构，如下所示:</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/ed59ad3dfa45522ecab8c699620dd843.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*E3gfzF8JGff85Xfg3zFsLw.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Directory Structure for deploying app in production</figcaption></figure><p id="2611" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，在终端中打开同一个目录文件夹，使用 below 命令在 Google cloud 中部署 app。</p><pre class="lu lv lw lx gt ly lz ma mb aw mc bi"><span id="5bb0" class="md me it lz b gy mf mg l mh mi">$ gcloud app deploy --version 1</span></pre><p id="7f4f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Google Cloud SDK 将检查适当的权限，然后读取部署描述符文件“app.yaml”并要求确认。键入“Y”。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/23077c1aa11a75ec42c661470c61060a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ys_D03fQPeL0Eb0erOdIrw.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">App deployment in Google app engine</figcaption></figure><p id="152a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">得到确认后，Google cloud SDK 将复制应用程序引擎实例中所有需要的文件，如果没有错误，我们将获得应用程序的全局端点。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/e20a8c0c0e1fa051172581ab81abe1f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I8b56As97-MpMYlo-o3hSg.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Successful deployment in google app engine</figcaption></figure><p id="b11e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我们的例子中，全局端点 URL 是:<em class="lc"/><a class="ae mp" href="https://hadooptest-223316.appspot.com" rel="noopener ugc nofollow" target="_blank"><em class="lc">https://hadooptest223316.appspot.com</em></a><em class="lc"/></p><blockquote class="kz la lb"><p id="1c0e" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">测试我们的应用程序(生产环境):</strong></p></blockquote><p id="3715" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们再次用 postman 应用程序测试我们的 API 响应。我们将向我们的全局端点 URL 发出 POST 请求:</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/a6f63ba1c8480694ec198a64da53557d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vIAjZhj7EKXbn2MzciTtZg.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Testing the production app in GCP app engine</figcaption></figure><p id="1392" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们再次将所需模型的预测作为 API 响应。</p><blockquote class="kz la lb"><p id="7504" class="kb kc lc kd b ke kf kg kh ki kj kk kl ld kn ko kp le kr ks kt lf kv kw kx ky im bi translated"><strong class="kd iu">结论:</strong></p></blockquote><p id="c9d9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本文中，我们看到了机器学习模型是如何在生产中使用的。虽然这是一个非常基本的用例。但这将让你对机器学习模型如何在不同应用程序内的云服务器中投入生产有所了解。</p><p id="b4cc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">我希望你喜欢我的文章，如果你想了解更多关于这个话题的信息，你可以在</strong><a class="ae mp" href="https://www.instagram.com/_aakash.rathore/" rel="noopener ugc nofollow" target="_blank"><strong class="kd iu">insta gram</strong></a><strong class="kd iu">或</strong><a class="ae mp" href="http://www.linkedin.com/in/aakash-rathore-big-data-engineer" rel="noopener ugc nofollow" target="_blank"><strong class="kd iu">LinkedIn</strong></a><strong class="kd iu">上关注并留言给我。</strong></p></div></div>    
</body>
</html>