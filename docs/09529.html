<html>
<head>
<title>Population Pyramid Animation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">人口金字塔动画</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/population-pyramid-animation-cfa7c1a79a63?source=collection_archive---------17-----------------------#2019-12-15">https://towardsdatascience.com/population-pyramid-animation-cfa7c1a79a63?source=collection_archive---------17-----------------------#2019-12-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="89a5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">RStudio 中 ganimate 的简短入门</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/06bc39b8f8024b96a071cc952d824a29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2U_77TeULXQZQ141"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">CHUTTERSNAP</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="58fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated">可视化是展示在数据中发现的洞察力的一种极好的方式。如果一张图片能表达一千个单词，那么一部动画就能表达一百万个单词。如果使用得当，动画可以非常清晰地展示我们从数据中提取的智慧财富。为了让决策者注意到它的真正价值，他们必须能够将提供给他们的信息内在化。我们可以通过讲述更具视觉吸引力的故事来帮助他们建立联系。</p><p id="735f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个简短的教程中，我将向您展示如何在 RStudio 中制作加拿大 1960 年至 2018 年的动画人口金字塔。你可以把你学到的东西应用到其他动画项目中。我们开始吧！</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><p id="5ed9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从安装和加载必要的包开始。</p><ul class=""><li id="6f82" class="ml mm it lb b lc ld lf lg li mn lm mo lq mp lu mq mr ms mt bi translated"><strong class="lb iu">吃豆人</strong>:一次装载所有的包裹</li><li id="d22c" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu mq mr ms mt bi translated"><strong class="lb iu"> tidyverse </strong>:准备数据帧(<em class="mz"> tidyr </em>)，轻松操作数据帧(<em class="mz"> dplyr </em>，<em class="mz"> stringr </em>)，生成绘图(<em class="mz"> ggplot2 </em>)</li><li id="9666" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu mq mr ms mt bi translated"><strong class="lb iu">gg pol</strong>:gg plot 2 的附加特性</li><li id="5e76" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu mq mr ms mt bi translated"><strong class="lb iu"> gganimate </strong>:图形动画(<em class="mz">这就是你来这里的目的！</em>)</li><li id="6052" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu mq mr ms mt bi translated">gifski :将文件渲染成 GIF 格式</li><li id="9ca1" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu mq mr ms mt bi translated">kableExtra:创建视觉上吸引人的表格</li></ul><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="8e88" class="nf ng it nb b gy nh ni l nj nk">if(!require('pacman')) install.packages('pacman')<br/>pacman::p_load(tidyverse, ggpol, gganimate, gifski, kableExtra)</span></pre><p id="cff9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">加拿大的人口数据来自世界银行网站<a class="ae ky" href="https://databank.worldbank.org/" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu"/></a>。时间跨度从 1960 年<strong class="lb iu">到 2018 年</strong>。数据帧最初是在<strong class="lb iu">宽格式</strong> t 中，由代表每个年龄组和性别的<strong class="lb iu"> 34 条记录构成。数据保存为 csv 文件并导入到<strong class="lb iu"> RStudio IDE </strong>中。要跟进，你可以在这里</strong> 下载数据集<a class="ae ky" href="https://github.com/SiphuLangeni/Population-Pyramid-Animation/blob/master/CAPop.csv" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">。</strong></a></p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="64ad" class="nf ng it nb b gy nh ni l nj nk">CAPop &lt;- read.csv('CAPop.csv')</span></pre><p id="001a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大部分工作都是准备数据，以便在动画中使用。<strong class="lb iu">步骤如下</strong>:</p><ol class=""><li id="bba7" class="ml mm it lb b lc ld lf lg li mn lm mo lq mp lu nl mr ms mt bi translated">移除数据框底部的<strong class="lb iu"> NA 值</strong></li><li id="7299" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">为<strong class="lb iu">年龄</strong>组创建列</li><li id="ee4a" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">更改<strong class="lb iu">最后一个年龄组</strong>的值</li><li id="5347" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">为<strong class="lb iu">性别</strong>创建一列</li><li id="a2f3" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">对<strong class="lb iu">因子</strong>等级重新排序(对显示的顺序数据很重要)</li><li id="0717" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">移除<strong class="lb iu">未使用的柱</strong></li><li id="ba1e" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">从宽格式变为<strong class="lb iu">长格式</strong></li><li id="952a" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">从年份中删除前缀</li><li id="dc4f" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">将人口金字塔的所有<strong class="lb iu">男性流行值更改为负</strong></li></ol><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="e400" class="nf ng it nb b gy nh ni l nj nk">CAPop &lt;- CAPop %&gt;% <br/>  na.omit %&gt;% <br/>  mutate(Age = substr(Series.Name, 17, 21),<br/>         Age = as.factor(case_when(Age == '80 an' ~ '80+', TRUE ~ Age)),<br/>         Gender = as.factor(ifelse(str_detect(Series.Name, 'female$') == TRUE, 'Female', 'Male')),<br/>         Gender = factor(Gender, levels = c('Male', 'Female'))) %&gt;% <br/>  select(-Country.Name, - Series.Name) %&gt;% <br/>  gather(Year, Pop, X1960:X2018) %&gt;% <br/>  mutate(Year = as.integer(substr(Year, 2, 5)),<br/>         Pop = ifelse(Gender == 'Male', as.integer(Pop * -1), as.integer(Pop)))</span></pre><p id="c208" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">处理完数据后，我们剩下<strong class="lb iu"> 2006 </strong>行和<strong class="lb iu"> 4 </strong>列。让我们看一看我们在做什么。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="91cb" class="nf ng it nb b gy nh ni l nj nk">dim(CAPop)</span><span id="7316" class="nf ng it nb b gy nm ni l nj nk">kable(head(CAPop)) %&gt;%<br/>  kable_styling(bootstrap_options = 'striped', font_size = 12, full_width = FALSE)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/e2b39e273288dfb10e72a0ccf32b13e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:542/format:webp/0*X1MIgnVzybSUayjY.png"/></div></figure><p id="827c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们<strong class="lb iu">在<strong class="lb iu"> 3 </strong>个不同的步骤中创建动画</strong>:</p><ol class=""><li id="575d" class="ml mm it lb b lc ld lf lg li mn lm mo lq mp lu nl mr ms mt bi translated">创建<strong class="lb iu">静态图</strong></li><li id="1620" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated">应用<strong class="lb iu">动画</strong>参数</li><li id="55fa" class="ml mm it lb b lc mu lf mv li mw lm mx lq my lu nl mr ms mt bi translated"><strong class="lb iu">渲染</strong>到文件</li></ol><h1 id="2d87" class="no ng it bd np nq nr ns nt nu nv nw nx jz ny ka nz kc oa kd ob kf oc kg od oe bi translated">静态情节</h1><p id="6ed4" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">每个动画都是从一张图片开始的。首先，通过<strong class="lb iu">将变量映射到美学</strong>来确定情节将显示什么。一个<strong class="lb iu">人口金字塔</strong>是一种特殊的<strong class="lb iu">条形图</strong>。它在背靠背的 x 轴上显示男性和女性人口。如果你还记得的话，男性人口数值是负数。这允许沿着<strong class="lb iu">共享 x 轴</strong>显示两个图形的<strong class="lb iu">“镜像】</strong>。<strong class="lb iu"> facet_share </strong>函数允许条形图背靠背放置。插入参数<strong class="lb iu"> reverse_num = TRUE </strong>以获得正确的比例，因为左边的图本质上是一个反向图。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="4714" class="nf ng it nb b gy nh ni l nj nk">PopPyramid &lt;- CAPop %&gt;%<br/> ggplot(aes(<br/>            x = Age,<br/>            y = Pop/1000,<br/>            fill = Gender<br/>           )<br/>       ) +<br/> geom_bar(stat = ‘identity’) +<br/> scale_fill_manual(values = c(‘#4682b4’, ‘#ee7989’)) + <br/> coord_flip() + <br/> facet_share(<br/>             ~ Gender,<br/>             dir = ‘h’,<br/>             scales = ‘free’,<br/>             reverse_num = TRUE<br/>            )</span></pre><h1 id="9462" class="no ng it bd np nq nr ns nt nu nv nw nx jz ny ka nz kc oa kd ob kf oc kg od oe bi translated">设置主题</h1><p id="f5e8" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">为了操纵情节的整体外观，你可以使用主题。有九个内置主题可供选择，这可能是一个很好的开始。我已经选择创建我自己的<strong class="lb iu">自定义主题</strong>来操作背景、面板、边框、网格线、刻度线和所有元素文本。主题( )中有<strong class="lb iu"><em class="mz">90 多个参数</em> </strong>进行最大化定制！正如你所看到的，这给了<strong class="lb iu">很大的灵活性</strong>来决定你的动画的<strong class="lb iu">整体外观</strong>。我只用了其中的 17 个论点。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="4ed5" class="nf ng it nb b gy nh ni l nj nk">PopPyramid &lt;- PopPyramid +<br/> theme(<br/>       plot.background = element_blank(),<br/>       axis.ticks = element_blank(),<br/>       axis.title.y = element_blank(),<br/>       legend.title = element_blank(),<br/>       panel.background = element_blank(),<br/>       panel.border = element_blank(),<br/>       strip.background = element_blank(),<br/>       strip.text.x = element_blank(),<br/>       panel.grid.minor = element_blank(),<br/>       panel.grid.major = element_blank(), <br/>       axis.text = element_text(size = 14),<br/>       legend.key.size = unit(0.75, ‘cm’),<br/>       legend.text = element_text(<br/>                                  size = 15,<br/>                                  face = ‘bold’<br/>                                 ),<br/>       plot.title = element_text(<br/>                                 size = 22,<br/>                                 hjust = 0.5,<br/>                                 face = ‘bold’<br/>                                ),<br/>       plot.subtitle = element_text(<br/>                                    size = 14,<br/>                                    hjust = 0.5,<br/>                                    face = ‘bold’<br/>                                   ),<br/>       axis.title.x = element_text(<br/>                                   size = 16,<br/>                                   face = ‘bold’<br/>                                  ),<br/>       plot.caption = element_text(<br/>                                   size = 12,<br/>                                   hjust = 0.5,<br/>                                   face = ‘italic’,<br/>                                   color = ‘gray’<br/>                                  )<br/>      )</span></pre><h1 id="96a0" class="no ng it bd np nq nr ns nt nu nv nw nx jz ny ka nz kc oa kd ob kf oc kg od oe bi translated">标签</h1><p id="2174" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">最后，我添加了<strong class="lb iu">有意义的标签</strong>让观众更容易理解。我希望动画随着时间的变化而变化，所以我希望这种变化能反映在标题中。使用<strong class="lb iu">{最近状态} </strong>，将显示与画面最近的状态的年份。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="1ea5" class="nf ng it nb b gy nh ni l nj nk">PopPyramid &lt;- PopPyramid + <br/> labs(<br/>      title = ‘Canada Population Estimate 1960 - 2018\n\n{closest_state}’,<br/>      subtitle = ‘\n\nAge Group’,<br/>      y = ‘\n\nPopulation (in thousands)’,<br/>      caption = ‘\n\nData Source: <a class="ae ky" href="https://databank.worldbank.org%27/" rel="noopener ugc nofollow" target="_blank">https://databank.worldbank.org’</a><br/>     )</span></pre><h1 id="af15" class="no ng it bd np nq nr ns nt nu nv nw nx jz ny ka nz kc oa kd ob kf oc kg od oe bi translated">动画</h1><p id="c64c" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">接下来，使用<strong class="lb iu"> transition_states </strong>来确定动画的行为。这种转变应该跨时间发生，在本例中是<strong class="lb iu">年</strong>。<strong class="lb iu">过渡 _ 长度</strong>和<strong class="lb iu">状态 _ 长度</strong>分别给出了过渡和状态的相对长度。在本例中，这产生了 1:2 的比率。<strong class="lb iu"> ease_aes </strong>函数描述了<strong class="lb iu">补间</strong>如何在状态之间发生。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="e661" class="nf ng it nb b gy nh ni l nj nk">PopPyramid &lt;- PopPyramid + <br/>  transition_states(<br/>                    Year,<br/>                    transition_length = 1,<br/>                    state_length = 2<br/>                   ) + <br/>  enter_fade() +<br/>  exit_fade() + <br/>  ease_aes('cubic-in-out')</span></pre><h1 id="51b2" class="no ng it bd np nq nr ns nt nu nv nw nx jz ny ka nz kc oa kd ob kf oc kg od oe bi translated">渲染到文件</h1><p id="b4e8" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">在这种情况下，产生了一个 gif 文件。使用<strong class="lb iu"> gifski </strong>，你可以微调文件的渲染方式。我选择了<strong class="lb iu">每秒 24 帧</strong>平滑运动，<strong class="lb iu"> 30 秒总时长</strong>和<strong class="lb iu"> 500x500 大小</strong>。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="ada4" class="nf ng it nb b gy nh ni l nj nk">animate(<br/>        PopPyramid,<br/>        fps = 24,<br/>        duration = 30,<br/>        width = 500,<br/>        height = 500,<br/>        renderer = gifski_renderer(‘PopPyramid.gif’)<br/>       )</span></pre><p id="67a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可能是<strong class="lb iu"> <em class="mz">休息一下</em> </strong>的好时机。根据您为动画选择的参数，此步骤可能需要很长时间进行渲染。如果我打算在 GitHub 上展示所有的 gif 图片，我会尽量保持在 30 秒或更短的时间内，因为在这个平台上 gif 图片似乎有时间限制。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="3a7e" class="no ng it bd np nq ok ns nt nu ol nw nx jz om ka nz kc on kd ob kf oo kg od oe bi translated">瞧啊。</h1><p id="2c02" class="pw-post-body-paragraph kz la it lb b lc of ju le lf og jx lh li oh lk ll lm oi lo lp lq oj ls lt lu im bi translated">现在你有了:<strong class="lb iu">加拿大人口金字塔动画</strong>从 1960 年到 2018 年！借助动画，我们可以更有说服力地看到加拿大人口正在老龄化 T21。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/619d245664e2e23ca7beb99dbd09df40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*VxlTqxBdLvnEtneVBuFJcw.gif"/></div></figure><p id="5149" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谢谢你抽空过来。我希望你在创建自己的动画形象时有信心。完整代码可以在我的<a class="ae ky" href="https://github.com/SiphuLangeni/Population-Pyramid-Animation" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>上查看。请随时在<a class="ae ky" href="https://www.linkedin.com/in/SiphuLangeni/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上与我联系。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="ada7" class="no ng it bd np nq ok ns nt nu ol nw nx jz om ka nz kc on kd ob kf oo kg od oe bi translated">脚注</h1><ol class=""><li id="1a02" class="ml mm it lb b lc of lf og li oq lm or lq os lu nl mr ms mt bi translated">2019 年 12 月 12 日检索数据。根据检索日期的不同，结果可能略有不同。</li></ol></div></div>    
</body>
</html>