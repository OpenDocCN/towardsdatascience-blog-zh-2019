<html>
<head>
<title>Getting Machine Learning Models Ready For Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为生产准备好机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-machine-learning-models-ready-for-production-a970b5cfb88d?source=collection_archive---------13-----------------------#2019-09-08">https://towardsdatascience.com/getting-machine-learning-models-ready-for-production-a970b5cfb88d?source=collection_archive---------13-----------------------#2019-09-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4b34" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">银行中的数据科学团队如何将机器学习模型投入生产</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/da9d8ecb277305ba4654cf46ee53580b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JiQiRmzpI_YcltTNrmDLnw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The Journey To Production</figcaption></figure><p id="85c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">作为一名科学家，能够通过应用新的研究和快速原型化来自由地进行实验是令人难以置信的满足感。这种满足感在实验室环境中可以保持得很好，但在公司环境中会很快消失。这是因为科学在商业环境中的潜在商业价值动机——如果它不能为员工或客户增加商业价值，就没有它的位置！然而，商业价值不仅仅是向员工或客户展示潜在价值的漂亮实验。在机器学习模型的背景下，唯一[商业]有价值的模型是生产中的模型！</p><p id="631d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇博文中，我将带您了解我和我的团队在将机器学习模型投入生产的过程中所经历的旅程，以及在此过程中所学到的一些重要经验。</p><h1 id="9b2d" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">我们的方法</h1><p id="0204" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在构建了几个没有转化为 MVP 的概念验证后，我们意识到有 3 件事我们需要做好:</p><ul class=""><li id="a37b" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">高度集中—团队成员不能同时处理多个项目。分散的焦点和频繁的上下文切换使人们脱离了他们的问题陈述(缺乏解决问题的沉浸感),也导致了大量的技术债务。</li><li id="558b" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">软件工程<strong class="la iu">和</strong>数据科学——从机器学习模型中获取价值既是一个数据科学问题，也是一个软件工程问题。葡萄干面包的比喻在这里响亮地响起:人工智能是葡萄干，软件工程和系统集成是面包。它们一起构成了美味而有价值的产品，但它们本身都不特别或不令人想要。</li><li id="f440" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">接近我们的业务！！与你的商业利益相关者保持一致可以成就你的项目，也可以毁掉你的项目——<strong class="la iu">这一点我怎么强调都不为过！</strong></li></ul><p id="8c8c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，为了做好这三件事，我们制定了一个 8 周的 sprint 计划(从数据科学的角度来看),如下所示。</p><p id="6f3f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注:本帖不讨论实际生产部署中涉及的技术细节。我将把它留到另一篇文章中。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/a4acde87ab321fd2e6420ebd5c9bb641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y442xJW1xLc4O2ZykHT6hw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">8 Week Production Cycle Sprint Plan</figcaption></figure><h1 id="295d" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">冲刺 1:研究/文献综述</h1><p id="2c33" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">AI 是一个极其压倒性的领域！每天都有新的技术、算法和方法被开发和发布。为此，研究是关键！</p><p id="2f47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的环境中，我们正在处理一个异常检测问题，因此团队中的每个数据科学家都在第一个 sprint 中研究可以应用于我们问题的不同异常检测方法。这个研究过程包括阅读论文、博客、观看视频、克隆 Github repos 和玩代码——你能想到的都有！所有这些研究最终形成了与解决我们的问题相关的技术前景的综合视图。</p><p id="1d4e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">到周末，每个数据科学家都必须写一篇简短的文献综述，并向团队播放他们的研究结果。</p><h1 id="5096" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">冲刺 2:探索性数据分析(EDA)</h1><blockquote class="ng"><p id="e896" class="nh ni it bd nj nk nl nm nn no np lt dk translated">垃圾进，垃圾出。</p></blockquote><p id="1a5b" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">这就是做模特的方式！因此，为了防止这种情况发生，您<strong class="la iu">理解您正在处理的数据</strong>是至关重要的！要获得这种理解，EDA 是必由之路！</p><p id="fb1f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对我们来说，这个过程是相当模型不可知的——我们只是想理解我们的数据。这个过程包括检查我们的数据的清洁度，绘制数据分布图，发现相关性，并提取对特征工程潜在有用的字段。有大量的资源可以帮助 EDA，包括一些非常棒的库，如<a class="ae nv" href="https://github.com/pandas-profiling/pandas-profiling" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">熊猫简介</strong> </a> <strong class="la iu">。</strong></p><p id="a418" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该练习的结果是理解了使用什么数据以及如何将它用于特征工程和模型构建。</p><h1 id="dcd9" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">冲刺 3–4:特征工程和模型选择</h1><p id="5a6b" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">特征工程可以说是建立机器学习模型最重要的一步。不管您有多少数据，也不管您应用什么模型架构，<strong class="la iu">糟糕的特性=糟糕的模型！</strong></p><p id="2cd8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们决定了一个规则:<em class="nw">每个模型有一名数据科学家</em>。每个数据科学家都花了这个 sprint 在特定的机器学习算法的上下文中进行功能工程。在特性工程中涉及了相当多的实验，但是在之前的 sprint 中执行的 EDA，以及来自我们业务利益相关者的一些直觉，给了我们一个很好的起点。我们很快意识到，很难决定哪些功能最适合某个特定的型号。为了做出决定，我们运行了各种特性排列的基线模型(默认超参数),并根据适当的成功指标测量了模型性能。</p><p id="e889" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个 sprint 的输出是向业务和团队回放我们的特性选择，向他们展示基线模型性能结果，并通过所用特性背后的直觉进行讨论。</p><h1 id="bca7" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">冲刺 5:模型开发</h1><p id="d538" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">“性感的东西！”</p><p id="32b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个常见的误解是，模型开发占用了数据科学家的大部分时间。正如我们发现的那样，大量数据科学家的时间都花在了清理、探索和操作数据上，以便机器学习算法可以使用这些数据，而不是开发算法本身。</p><p id="6ae9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这次冲刺的目的我们很清楚:<strong class="la iu"> <em class="nw">找到完美的泡菜！</em> </strong></p><p id="9670" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">每个数据科学家都通过尝试不同的模型架构和超参数，在基线模型的基础上进一步开发。适当的成功指标很重要，例如 F1 分数、准确性等。在这个 sprint 之前被选中，因为这是决定你的模型表现如何的因素。</p><p id="d687" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个冲刺阶段结束时的可交付成果是<strong class="la iu"> <em class="nw">完美的泡菜</em></strong>——一个可以投入生产的经过训练的模型文件。</p><h1 id="4090" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">Sprint 6:模型优化和代码重构</h1><p id="c4a8" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">一旦我们有了一个训练有素的模型，产生了我们和我们的企业都满意的结果，我们就继续进行模型优化。对我们来说，模型优化过程主要集中在提高模型的预测速度上。我们有一个独特的系统集成限制，要求我们在 100 毫秒内执行端到端预测。</p><p id="0ad6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此时，大多数数据科学家会停下来说“<em class="nw">好了，我的工作完成了”。</em></p><p id="3050" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据科学家:“好的，酷，我已经训练好了我的模型。给你……”</p><p id="f419" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">软件工程师:“我必须用这个做什么？”</p><p id="c5e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据科学家:“拿去生产？”</p><p id="95ae" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">软件工程师:“怎么做？”</p><p id="4e24" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数据科学家:“不知道。那是你的工作，不是吗？”</p><p id="5227" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有点夸张的转换，但信息是明确的:数据科学必须满足工程！这就是代码重构的用武之地。</p><p id="3d8b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">每个模型都必须有服务代码(代码将获取生产数据，对其进行适当的转换，加载模型文件，并使用它进行预测)。对我们来说，创建了一个标准的模型服务模板，我们的服务代码放在其中。然后，这个服务代码被打包成一个模块，封装并部署到开发环境中。这个重构过程的一个重要部分是要求必须为服务方法编写单元测试，并且在你的代码可以被合并到主代码之前，所有的单元测试都必须通过。</p><p id="f4fb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我迄今为止的经验表明，让数据科学家编写生产就绪代码是困难的，但并非不可能。在这一点上，工程师和数据科学家之间有相当多的摩擦，但有一些策略可以让事情变得更顺利(我也将在另一篇博客文章中讨论)。</p><p id="5da8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个 sprint 的输出是在 Dev 中部署和运行的服务代码和模型文件！</p><h1 id="2db2" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">冲刺 7–8:最后冲刺</h1><p id="99c4" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在我们为期 8 周的生产周期中，最后两次冲刺涉及以下内容:</p><ul class=""><li id="3596" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">最终模型培训</li><li id="8a93" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">端到端测试</li></ul><p id="af67" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的上下文中，我们有一个非常大的数据集(&gt; 200 000 000 行)。在如此大的数据集上进行实验是不可行的，因此，我们将基线模型(在较小的数据子集上进行训练)部署到开发中。这样做的目的是确保与本地环境相比，部署到开发环境的代码和模型能够如预期的那样执行。</p><p id="5c05" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行了几个集成测试，以确保我们架构中的每个组件在开发中都能按预期执行。</p><p id="1f66" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦我们对 Dev 中的性能感到满意，我们就开始在完整的数据集上进行训练。最终培训中的模型是将要投入生产的模型。</p><blockquote class="ng"><p id="fd2c" class="nh ni it bd nj nk nl nm nn no np lt dk translated"><em class="nx">轰！我们现在可以开始生产了！</em></p></blockquote><h1 id="8040" class="lu lv it bd lw lx ly lz ma mb mc md me jz ny ka mg kc nz kd mi kf oa kg mk ml bi translated">吸取的教训和遵循的纪律</h1><p id="9c71" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在生产过程中遇到了许多挑战。下面总结了一些挑战以及我们为实现交付目标而必须遵循的原则:</p><ul class=""><li id="f6e7" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">[实际上]运行敏捷——每日站立、每周回顾和业务冲刺计划确保了我们保持高度专注，软件工程符合数据科学，并且存在业务一致性。</li><li id="9e87" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">DevOps 工具——强大的 Git 纪律对我们的部署成功至关重要。是的，数据科学家也必须使用 Git，这是无可避免的！我们利用<a class="ae nv" href="https://www.atlassian.com/software/jira?&amp;aceid=&amp;adposition=1t1&amp;adgroup=63127837864&amp;campaign=1439934854&amp;creative=340023072955&amp;device=c&amp;keyword=jira&amp;matchtype=e&amp;network=g&amp;placement=&amp;ds_kids=p34164036290&amp;ds_e=GOOGLE&amp;ds_eid=700000001558501&amp;ds_e1=GOOGLE&amp;gclid=CjwKCAjwzdLrBRBiEiwAEHrAYoKr0ymRtBNy2MAk8Y2ylxZlmdLHVn8HhGAl6G2_gWolbQHlCe1FARoC4sAQAvD_BwE&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank"> JIRA </a>来管理我们的 sprint 故事，<a class="ae nv" href="https://bitbucket.org/product?&amp;aceid=&amp;adposition=1t1&amp;adgroup=55499725436&amp;campaign=1407243005&amp;creative=377621228819&amp;device=c&amp;keyword=bitbucket&amp;matchtype=e&amp;network=g&amp;placement=&amp;ds_kids=p33208875779&amp;ds_e=GOOGLE&amp;ds_eid=700000001551985&amp;ds_e1=GOOGLE&amp;gclid=CjwKCAjwzdLrBRBiEiwAEHrAYhLoDHnKJ8dMWDXAk5IGNuS1eU-Frw4U5hV4S3KT--ThGZ5emkSUehoCBOEQAvD_BwE&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank"> Bitbucket </a>来管理我们的代码库，以及<a class="ae nv" href="https://www.atlassian.com/software/confluence?&amp;aceid=&amp;adposition=1t1&amp;adgroup=56762752698&amp;campaign=1398156602&amp;creative=301831929106&amp;device=c&amp;keyword=confluence&amp;matchtype=e&amp;network=g&amp;placement=&amp;ds_kids=p32969589259&amp;ds_e=GOOGLE&amp;ds_eid=700000001542923&amp;ds_e1=GOOGLE&amp;gclid=CjwKCAjwzdLrBRBiEiwAEHrAYhHgfnMme1QmZjZq8bSKb-yo-i9yH7RjYEl1bnB9QHVx8e9W3wIkHRoCrSwQAvD_BwE&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank"> Confluence </a>来管理文档。</li><li id="f1a6" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">文档——为了确保可重复性和连续性，每个团队成员都必须对他们的代码做一定程度的文档记录。这防止了关键人物依赖性的形成。简单文档的一个例子包括简要概述开始特定模型的培训所涉及的步骤。</li><li id="52ba" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">过早的优化是万恶之源——我们首先关注基线性能，让代码工作起来！如果代码库一开始就不工作，那么投入资源进行优化是没有意义的。我们还很快了解到，企业对技术细节不太感兴趣。他们想看到结果。每周向他们展示逐渐改善的结果，你会赢得他们的信任。</li><li id="c9ea" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">自动化——在数百个需要手动运行的 Untitled.ipynb 笔记本中编写代码所产生的技术债务是惊人的！一般来说，如果某件事需要重复几次，那就自动化吧！这包括数据提取、模型训练和集成测试等活动。自动化为您节省了大量时间，并且可以像参数化 Python 脚本一样简单。</li></ul><p id="bb22" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我在本文开头提到的，从实验中获得的满足感是巨大的！同样重要的是，或者至少对我来说，看到你的工作实时运行所获得的满足感！</p><p id="c775" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将机器学习模型投入生产绝非易事！重要的是要认识到这确实是一次旅程——一次需要耐心、承诺、纪律和韧性的旅程，但带你到达一个目的地是非常有益的！</p></div></div>    
</body>
</html>