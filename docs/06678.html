<html>
<head>
<title>Backtesting trading strategies using custom data in zipline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 zipline 中的自定义数据对交易策略进行回溯测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/backtesting-trading-strategies-using-custom-data-in-zipline-e6fd65eeaca0?source=collection_archive---------12-----------------------#2019-09-24">https://towardsdatascience.com/backtesting-trading-strategies-using-custom-data-in-zipline-e6fd65eeaca0?source=collection_archive---------12-----------------------#2019-09-24</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><figure class="iu iv gp gr iw ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi it"><img src="../Images/b79fe19463734778ef01fc72a8534614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JOZC_fNrOTVKztuxspFRQ.jpeg"/></div></div><figcaption class="je jf gj gh gi jg jh bd b be z dk">Source: <a class="ae ji" href="https://pixabay.com/photos/chart-trading-courses-forex-1905225/" rel="noopener ugc nofollow" target="_blank">pixabay</a></figcaption></figure><div class=""/><div class=""><h2 id="d1ff" class="pw-subtitle-paragraph km jk jl bd b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dk translated">了解如何将自定义数据导入<code class="fe ki kj kk kl b">zipline</code></h2></div><p id="6483" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">在之前的<a class="ae ji" rel="noopener" target="_blank" href="/introduction-to-backtesting-trading-strategies-7afae611a35e">文章</a>中，我已经展示了如何使用<code class="fe ki kj kk kl b">zipline</code>回测基本交易策略。为此，我使用了内置的<code class="fe ki kj kk kl b">quandl</code>数据集，这对于许多用例来说已经足够了。然而，它也有一些缺点:</p><ul class=""><li id="50e0" class="ma mb jl lg b lh li lk ll ln mc lr md lv me lz mf mg mh mi bi translated">2018 年年中，它停产了，所以没有最近的价格</li><li id="cd7d" class="ma mb jl lg b lh mj lk mk ln ml lr mm lv mn lz mf mg mh mi bi translated">它只考虑美国股票</li></ul><p id="552d" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">这就是为什么我还想展示如何获取定制数据集，即一小部分欧洲股票。我将通过使用已经由 Zipline 提供的<code class="fe ki kj kk kl b">csvdir</code>包来这样做。还有其他的方法，我在本文最后会提到。</p><p id="db16" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">为了简洁起见，我将不再谈论<code class="fe ki kj kk kl b">zipline</code>的设置。有关该主题的详细信息，请参考之前的<a class="ae ji" rel="noopener" target="_blank" href="/introduction-to-backtesting-trading-strategies-7afae611a35e">文章</a>。</p><h1 id="d719" class="mo mp jl bd mq mr ms mt mu mv mw mx my kv mz kw na ky nb kz nc lb nd lc ne nf bi translated">获取数据</h1><p id="7600" class="pw-post-body-paragraph le lf jl lg b lh ng kq lj lk nh kt lm ln ni lp lq lr nj lt lu lv nk lx ly lz io bi translated">我们首先需要收集我们想要输入到<code class="fe ki kj kk kl b">zipline</code>中的数据。为此，我使用了<code class="fe ki kj kk kl b">yahoofinancials</code>库。为了加载到<code class="fe ki kj kk kl b">zipline</code>中，数据必须是 CSV 文件和预定义的格式(示例如下)。为了这篇文章，我下载了两种证券的数据:ABN AMRO(一家荷兰银行)和 AEX(一种由在泛欧交易所交易的荷兰公司组成的股票市场指数)。我们使用后者作为基准。</p><p id="a851" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们从加载所需的库开始。</p><pre class="nl nm nn no gt np kl nq nr aw ns bi"><span id="43f6" class="nt mp jl kl b gy nu nv l nw nx">import numpy as np<br/>import matplotlib.pyplot as plt<br/>import pandas as pd<br/>from yahoofinancials import YahooFinancials</span></pre><p id="9c80" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">然后，我们定义一个简短的函数，用于使用<code class="fe ki kj kk kl b">yahoofinancials</code>下载数据，并准备数据帧供<code class="fe ki kj kk kl b">zipline</code>接收。准备好数据后，该函数将数据作为 CSV 文件保存在一个名为<code class="fe ki kj kk kl b">daily</code>的文件夹中(该文件夹以所考虑数据的频率命名)。</p><figure class="nl nm nn no gt ix"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b59e" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们从下载 ABN·AMRO 的股票价格开始。</p><pre class="nl nm nn no gt np kl nq nr aw ns bi"><span id="8a4d" class="nt mp jl kl b gy nu nv l nw nx">download_csv_data(ticker='ABN.AS', <br/>                  start_date='2017-01-01', <br/>                  end_date='2017-12-31', <br/>                  freq='daily', <br/>                  path='european/daily/abn.csv')</span></pre><p id="a2e6" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">该函数返回下载价格的曲线图:</p><figure class="nl nm nn no gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi oa"><img src="../Images/0235dbeac60ae8b062dbd9da77366761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rlLD_jbLH0RMcCxtCGBEqQ.png"/></div></div></figure><p id="068b" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们还展示了 zipline 接受的文本文件的结构。</p><pre class="nl nm nn no gt np kl nq nr aw ns bi"><span id="eccb" class="nt mp jl kl b gy nu nv l nw nx">!head ./european/daily/abn.csv</span></pre><figure class="nl nm nn no gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi ob"><img src="../Images/3f9c042400bdd28d298da0bbda6d5b11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TrkwME2mN3JeUM64nBcteg.png"/></div></div></figure><p id="7e18" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们以类比的方式下载索引数据。</p><pre class="nl nm nn no gt np kl nq nr aw ns bi"><span id="00fb" class="nt mp jl kl b gy nu nv l nw nx">download_csv_data(ticker='^AEX', <br/>                  start_date='2017-01-01', <br/>                  end_date='2017-12-31', <br/>                  freq='daily', <br/>                  path='european/daily/aex.csv')</span></pre><p id="2012" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">也可以将多个 tickers 以 Python 列表的形式传递给<code class="fe ki kj kk kl b">yahoofinancials</code>并一次性下载。然而，我们选择这种方式是为了简化所需的操作。</p><h1 id="6157" class="mo mp jl bd mq mr ms mt mu mv mw mx my kv mz kw na ky nb kz nc lb nd lc ne nf bi translated">摄取 CSV</h1><p id="9569" class="pw-post-body-paragraph le lf jl lg b lh ng kq lj lk nh kt lm ln ni lp lq lr nj lt lu lv nk lx ly lz io bi translated">让我们通过运行以下命令来检查当前加载的包。</p><pre class="nl nm nn no gt np kl nq nr aw ns bi"><span id="9f27" class="nt mp jl kl b gy nu nv l nw nx">!zipline bundles</span></pre><figure class="nl nm nn no gt ix gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/74b8371bf7a6d51a993c299494507d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*KYObaMbYyVKqtxg4PewNsA.png"/></div></figure><p id="3b7d" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们现在将添加一个名为<code class="fe ki kj kk kl b">eu_stocks</code>的定制包。为此，我们需要修改 zipline 目录中的<code class="fe ki kj kk kl b">extension.py</code>文件。我们需要添加以下代码:</p><figure class="nl nm nn no gt ix"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="6f41" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">在调用<code class="fe ki kj kk kl b">register()</code>时，我们必须指定一个交易日历，在本例中是<code class="fe ki kj kk kl b">XAMS</code>，它对应于泛欧交易所。有关所有提供的日历列表，请参考此<a class="ae ji" href="https://github.com/quantopian/trading_calendars" rel="noopener ugc nofollow" target="_blank">文档</a>。也可以定义自己的交易日历，你可以在<code class="fe ki kj kk kl b">zipline</code>的文档<a class="ae ji" href="https://www.zipline.io/trading-calendars.html" rel="noopener ugc nofollow" target="_blank">中找到更多信息。</a></p><p id="a125" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">请记住，我们需要传递之前下载的数据的确切日期范围。在本例中，我们从<code class="fe ki kj kk kl b">2017–01–02</code>开始，因为这是我们获得价格数据的第一天。</p><p id="f234" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">为了最终接收数据，我们运行以下命令:</p><pre class="nl nm nn no gt np kl nq nr aw ns bi"><span id="381f" class="nt mp jl kl b gy nu nv l nw nx">!zipline ingest --bundle eu_stocks</span></pre><h1 id="b602" class="mo mp jl bd mq mr ms mt mu mv mw mx my kv mz kw na ky nb kz nc lb nd lc ne nf bi translated">买入并持有策略示例</h1><p id="a82c" class="pw-post-body-paragraph le lf jl lg b lh ng kq lj lk nh kt lm ln ni lp lq lr nj lt lu lv nk lx ly lz io bi translated">最后，我们展示了如何使用自定义数据来回溯测试交易策略。为此，我们采用基本的买入并持有策略。我们使用 ABN·AMRO 的股票，并选择 2017 年作为回溯测试的持续时间。默认情况下，<code class="fe ki kj kk kl b">zipline</code>使用美元，但是，当所有资产都是同一种外币时，使用欧元报价的股票和指数没有问题。</p><figure class="nl nm nn no gt ix"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="b2ca" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">关于这段代码中发生的事情的更详细的描述，我再次参考以前的<a class="ae ji" rel="noopener" target="_blank" href="/introduction-to-backtesting-trading-strategies-7afae611a35e">文章</a>。让我描述一些细微差别:</p><ul class=""><li id="d882" class="ma mb jl lg b lh li lk ll ln mc lr md lv me lz mf mg mh mi bi translated">我们需要通过在<code class="fe ki kj kk kl b">zipline</code>魔术中包含<code class="fe ki kj kk kl b"> —- bundle eu_stocks</code>来指定我们想要使用的定制包</li><li id="2556" class="ma mb jl lg b lh mj lk mk ln ml lr mm lv mn lz mf mg mh mi bi translated">我们还需要通过在<code class="fe ki kj kk kl b">zipline</code>魔术中包含<code class="fe ki kj kk kl b">--trading-calendar XAMS</code>来指定交易日历</li><li id="83c6" class="ma mb jl lg b lh mj lk mk ln ml lr mm lv mn lz mf mg mh mi bi translated">我们需要在<code class="fe ki kj kk kl b">initialize()</code>函数中设置基准:<code class="fe ki kj kk kl b">set_benchmark(symbol(‘AEX’))</code>。原因是默认基准是在纽约证券交易所交易的 SP500，这与我们的设置不兼容。</li></ul><p id="9be4" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们的买入并持有策略的结果如下图所示。</p><figure class="nl nm nn no gt ix gh gi paragraph-image"><div role="button" tabindex="0" class="iy iz di ja bf jb"><div class="gh gi od"><img src="../Images/f37b1a398e79f397605d93521be8a2ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*95imeqPp97Pxfy34FAO9Ag.png"/></div></div></figure><p id="3dcd" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我们简单的策略在一年内成功创造了近 50 个€。</p><h1 id="e229" class="mo mp jl bd mq mr ms mt mu mv mw mx my kv mz kw na ky nb kz nc lb nd lc ne nf bi translated">结论</h1><p id="57c7" class="pw-post-body-paragraph le lf jl lg b lh ng kq lj lk nh kt lm ln ni lp lq lr nj lt lu lv nk lx ly lz io bi translated">在本文中，我展示了如何使用定制数据在<code class="fe ki kj kk kl b">zipline</code>中运行回溯测试。正如我提到的，使用<code class="fe ki kj kk kl b">csvdir</code> bundle 并不是我们获取定制数据的唯一方式。我们也可以写一个完整的定制包(更多细节请看<a class="ae ji" href="https://www.zipline.io/bundles.html#writing-a-new-bundle" rel="noopener ugc nofollow" target="_blank">这里</a>)，例如，它使用 API 自动从加密交换中下载数据。然而，这可能是另一篇文章的主题:)</p><p id="6c41" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">一如既往，我们欢迎任何建设性的反馈。你可以在<a class="ae ji" href="https://twitter.com/erykml1" rel="noopener ugc nofollow" target="_blank">推特</a>或评论中联系我。您可以在我的<a class="ae ji" href="https://github.com/erykml/medium_articles/blob/master/Quantitative%20Finance/introduction_to_backtesting_eur_stocks.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到本文使用的代码。</p><p id="d688" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">以下是该系列的其他文章:</p><ul class=""><li id="fc88" class="ma mb jl lg b lh li lk ll ln mc lr md lv me lz mf mg mh mi bi translated">介绍 zipline 框架并展示如何测试基本策略(<a class="ae ji" rel="noopener" target="_blank" href="/introduction-to-backtesting-trading-strategies-7afae611a35e">链接</a>)</li><li id="8720" class="ma mb jl lg b lh mj lk mk ln ml lr mm lv mn lz mf mg mh mi bi translated">评估交易策略的绩效(<a class="ae ji" rel="noopener" target="_blank" href="/the-easiest-way-to-evaluate-the-performance-of-trading-strategies-in-python-4959fd798bb3">链接</a>)</li><li id="e7bb" class="ma mb jl lg b lh mj lk mk ln ml lr mm lv mn lz mf mg mh mi bi translated">基于技术分析建立算法交易策略(<a class="ae ji" rel="noopener" target="_blank" href="/algorithmic-trading-based-on-technical-analysis-in-python-80d445dc6943">链接</a>)</li><li id="2a26" class="ma mb jl lg b lh mj lk mk ln ml lr mm lv mn lz mf mg mh mi bi translated">基于均值-方差分析建立算法交易策略(<a class="ae ji" rel="noopener" target="_blank" href="/algorithmic-trading-based-on-mean-variance-optimization-in-python-62bdf844ac5b">链接</a>)</li></ul></div><div class="ab cl oe of hz og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="io ip iq ir is"><p id="03a7" class="pw-post-body-paragraph le lf jl lg b lh li kq lj lk ll kt lm ln lo lp lq lr ls lt lu lv lw lx ly lz io bi translated">我最近出版了一本关于使用 Python 解决金融领域实际任务的书。如果你有兴趣，我贴了一篇文章介绍这本书的内容。你可以在亚马逊或者帕克特的网站 T21 买到这本书。</p></div></div>    
</body>
</html>