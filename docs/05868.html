<html>
<head>
<title>Left Join with Pandas Data Frames in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 中熊猫数据框的左连接</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/left-join-with-pandas-data-frames-in-python-c29c85089ba4?source=collection_archive---------0-----------------------#2019-08-27">https://towardsdatascience.com/left-join-with-pandas-data-frames-in-python-c29c85089ba4?source=collection_archive---------0-----------------------#2019-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3305" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于如何在左连接的结果中正确标记空值来源的教程。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/9cca7e3fa1107f721cbc2f88d9e2c61c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OnOLAilM2pB5diGgUWre2g.jpeg"/></div></div></figure><p id="d4dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">StackOverflow 文章<a class="ae kx" href="https://stackoverflow.com/questions/53645882/pandas-merging-101" rel="noopener ugc nofollow" target="_blank"> Pandas Merging 101 </a>详细介绍了合并 Pandas 数据帧。然而，我给数据科学课后测试评分的经验让我相信左连接对许多人来说仍然是一个挑战。在本文中，我将展示如何正确处理 Pandas 左连接中的右表(数据框)包含空值的情况。</p><p id="bf28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们考虑一个场景，其中我们有一个表<code class="fe ky kz la lb b">transactions</code>包含一些用户执行的事务，还有一个表<code class="fe ky kz la lb b">users</code>包含一些用户属性，例如他们喜欢的颜色。我们希望用用户的属性来注释事务。以下是数据框:</p><pre class="km kn ko kp gt lc lb ld le aw lf bi"><span id="6e64" class="lg lh iq lb b gy li lj l lk ll">import numpy as np<br/>import pandas as pd</span><span id="502f" class="lg lh iq lb b gy lm lj l lk ll">np.random.seed(0)<br/># transactions<br/>left_df = pd.DataFrame({'transaction_id': ['A', 'B', 'C', 'D'], <br/>                       'user_id': ['Peter', 'John', 'John', 'Anna'],<br/>                       'value': np.random.randn(4),<br/>                      })</span><span id="23d4" class="lg lh iq lb b gy lm lj l lk ll"># users<br/>right_df = pd.DataFrame({'user_id': ['Paul', 'Mary', 'John',<br/>                                     'Anna'],<br/>                        'favorite_color': ['blue', 'blue', 'red', <br/>                                           np.NaN],<br/>                       })</span></pre><p id="f89f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，彼得不在<code class="fe ky kz la lb b">users</code>表中，安娜也没有最喜欢的颜色。</p><pre class="km kn ko kp gt lc lb ld le aw lf bi"><span id="0431" class="lg lh iq lb b gy li lj l lk ll">&gt;&gt;&gt; left_df<br/>  transaction_id user_id     value<br/>0              A   Peter  1.867558<br/>1              B    John -0.977278<br/>2              C    John  0.950088<br/>3              D    Anna -0.151357</span><span id="74ac" class="lg lh iq lb b gy lm lj l lk ll">&gt;&gt;&gt; right_df<br/>  user_id favorite_color<br/>0    Paul           blue<br/>1    Mary           blue<br/>2    John            red<br/>3    Anna            NaN</span></pre><p id="d053" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用用户 id 上的左连接将用户喜欢的颜色添加到事务表中似乎很简单:</p><pre class="km kn ko kp gt lc lb ld le aw lf bi"><span id="f272" class="lg lh iq lb b gy li lj l lk ll">&gt;&gt;&gt; left_df.merge(right_df, on='user_id', how='left')<br/>  transaction_id user_id     value favorite_color<br/>0              A   Peter  1.867558            NaN<br/>1              B    John -0.977278            red<br/>2              C    John  0.950088            red<br/>3              D    Anna -0.151357            NaN</span></pre><p id="8dee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到彼得和安娜在<code class="fe ky kz la lb b">favorite_color</code>列中有<code class="fe ky kz la lb b">NaN</code>。然而，丢失的值有两个不同的原因:Peter 的记录在<code class="fe ky kz la lb b">users</code>表中没有匹配，而 Anna 没有最喜欢的颜色的值。在某些情况下，这种细微的差别很重要。例如，它对于在初始勘探期间理解数据和提高数据质量至关重要。</p><p id="9551" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有两个简单的方法来跟踪左连接结果中缺少值的原因。第一个由<code class="fe ky kz la lb b">merge</code>函数通过<code class="fe ky kz la lb b">indicator</code>参数直接提供。当设置为<code class="fe ky kz la lb b">True</code>时，结果数据帧有一个附加列<code class="fe ky kz la lb b">_merge</code>:</p><pre class="km kn ko kp gt lc lb ld le aw lf bi"><span id="8c88" class="lg lh iq lb b gy li lj l lk ll">&gt;&gt;&gt; left_df.merge(right_df, on='user_id', how='left', indicator=True)<br/>  transaction_id user_id     value favorite_color     _merge<br/>0              A   Peter  1.867558            NaN  left_only<br/>1              B    John -0.977278            red       both<br/>2              C    John  0.950088            red       both<br/>3              D    Anna -0.151357            NaN       both</span></pre><p id="0cee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二种方法与它在 SQL 世界中的实现方式有关，它在右边的表中显式地添加了一个表示<code class="fe ky kz la lb b">user_id</code>的列。我们注意到，如果两个表中的连接列具有不同的名称，那么这两个列都会出现在结果数据框中，因此我们在合并之前重命名了<code class="fe ky kz la lb b">users</code>表中的<code class="fe ky kz la lb b">user_id</code>列。</p><pre class="km kn ko kp gt lc lb ld le aw lf bi"><span id="360b" class="lg lh iq lb b gy li lj l lk ll">&gt;&gt;&gt; left_df.merge(right_df.rename({'user_id': 'user_id_r'}, axis=1),<br/>               left_on='user_id', right_on='user_id_r', how='left')<br/>  transaction_id user_id     value user_id_r favorite_color<br/>0              A   Peter  1.867558       NaN            NaN<br/>1              B    John -0.977278      John            red<br/>2              C    John  0.950088      John            red<br/>3              D    Anna -0.151357      Anna            NaN</span></pre><p id="f985" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个等效的 SQL 查询是</p><pre class="km kn ko kp gt lc lb ld le aw lf bi"><span id="f16e" class="lg lh iq lb b gy li lj l lk ll"><strong class="lb ir">select</strong><br/>    t.transaction_id<br/>    , t.user_id<br/>    , t.value<br/>    , u.user_id as user_id_r<br/>    , u.favorite_color<br/><strong class="lb ir">from</strong><br/>    transactions t<br/>    <strong class="lb ir">left join</strong><br/>    users u<br/>    <strong class="lb ir">on</strong> t.user_id = u.user_id<br/>;</span></pre><p id="b9f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总之，添加一个额外的列来指示 Pandas left join 中是否有匹配，这允许我们随后根据用户是否已知但没有最喜欢的颜色或者用户是否从<code class="fe ky kz la lb b">users</code>表中缺失来不同地处理最喜欢的颜色的缺失值。</p><p id="f5a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章最初出现在<a class="ae kx" href="http://www.lifearounddata.com/left-join-with-pandas-data-frames-in-python/" rel="noopener ugc nofollow" target="_blank"> Life Around Data </a>博客上。<em class="ln">照片由 Unsplash 上的</em> <a class="ae kx" href="https://unsplash.com/@julilona" rel="noopener ugc nofollow" target="_blank"> <em class="ln">伊洛娜·弗罗利希</em> </a> <em class="ln">拍摄。</em></p></div></div>    
</body>
</html>