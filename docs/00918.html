<html>
<head>
<title>Automatic White Balance Adjustment of Selfies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自拍的自动白平衡调节</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automatic-white-balance-adjustment-of-selfies-f7b8bda5e47c?source=collection_archive---------28-----------------------#2019-02-11">https://towardsdatascience.com/automatic-white-balance-adjustment-of-selfies-f7b8bda5e47c?source=collection_archive---------28-----------------------#2019-02-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="40fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">时尚科学来拯救！(其中包括机器学习)</p><p id="31b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">问题是相机真的很努力——但坦率地说，在呈现准确的肤色方面经常失败。在我的例子中，为智能手机建立一个个性化的颜色推荐工具，我要求肤色要像皮肤一样。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/03913fcd108434cf49b32ee160ed93e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*pK5HGgTpDd9ajBqRtN5loA.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Before and After Automatic White Balance Adjustment</figcaption></figure><p id="f7ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下次你在脸书的时候，看看人们给自己的图片。它们离我们有多远，以及人类大脑是如何适应这种情况的，真是不可思议。</p><p id="5f77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了说明这一点，举例来说，Photoshop 确实有多种颜色校正算法。不幸的是，它们并不总是有效，最终的方法要求一个人在图像中找到一个灰点。我们确实有他们没有的优势——我们知道这张照片是自拍，我们知道如何提取肤色——相信我，文章就要来了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/1590ac2e75f38af0fca001002d646b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*JoqKeNFZfLXkfbLEvi1mBQ.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Accurate skin colors</figcaption></figure><p id="4027" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看一些数据。随附的图表显示了在受控灯光下精心制作的一系列模特的肤色。很明显，这里有一个很好的模式。</p><p id="4d6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我进一步指出，这代表了人性和大致的肤色范围。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/90495e57da2ade30c6372e682791a062.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/1*gAixsCg3Zx4uwjC5js2E5g.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Real-life Model Results plotted against Baseline Models</figcaption></figure><p id="060b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那又怎样？</p><p id="0de4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是上面的同一组数据，现在用红 x 表示。(简化为二维，红色对绿色。)肉色圆点来自用 iPhone 拍摄的现实生活中的模特。有些很离谱——他们是人类吗？</p><p id="003c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是更好的是——它们都来自同一个人！</p><p id="16b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谁知道这种变化来自哪里——照明类型/温度、照明位置、曝光、相机显影处理等等。有很多变化。</p><p id="3731" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顺便说一下，我们从我们的应用程序“所有的眼睛都在色调上”收集了超过 10 万张模型图像(在匿名的承诺下)用于分析。显示的测试集是一个用户在不同条件下拍摄了大约 20 张自拍。谢谢匿名人士！</p><p id="ae51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以首先，一个工作定义<strong class="jp ir">白平衡</strong>。见鬼，去维基百科，搜索“色彩平衡”以获得更好的定义。m 定义是图像在红色、绿色和蓝色通道中被线性地独立破坏。通过将每个像素乘以每个 RGB 通道的白平衡调整因子，我们可以校正图像。那三个线性调整——姑且称之为 R <em class="kz"> wb </em>，G <em class="kz"> wb </em>，B <em class="kz"> wb </em>。是的，这显然是一种简化——但它似乎在大多数情况下都能产生足够好的结果。</p><h1 id="4464" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">解决方案 1</h1><p id="fa3a" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">校正图像的一个简单方法是:</p><ul class=""><li id="6c17" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">识别模特的肤色</li><li id="8b63" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">确定基线中最接近“好”模特的肤色——上图中的红色 x</li><li id="73cb" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">将模型的皮肤颜色拖到最接近的“好”模型上。</li></ul><p id="1f10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。数学很简单。这很有效——我们每次都能得到“人类”的肤色。顺便说一下，我有一个俗气的 iOS 应用程序可以做到这一点——更好的 Selfie⁴.</p><h1 id="3bcd" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">但是等等…</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/e50215f038d5f707763110875c0b8317.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/1*PjAidOJPcHAfnU6abj0ySg.png"/></div></figure><p id="6af0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想我在上面的图表中提到过，所有这些变异都来自同一个人。将每种肤色拖到最接近的“好”肤色会给我们好的肤色——但<strong class="jp ir">不是</strong>他们的那种，真正的肤色。这就是我想要的！让我们重新定义这个问题——我们希望将所有这些不同的肤色统一为一种肤色。</p><p id="74ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顺便说一下，为了测试我们的方法，我们将假设正确的“好”答案是使用解决方案 1 的所有校正肤色的平均值。</p><h1 id="4065" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">解决方案 2</h1><p id="e83d" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">机器学习 101。获取大量训练数据来训练模型。完成了。</p><p id="a1f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的训练数据从之前显示的“好”模型开始。每种肤色都有特定的平均 RGB 值。它的白平衡校正系数为 1.0、1.0、1.0。也就是说，不需要进行白平衡校正就可以将其校正到良好的肤色。</p><p id="5597" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要的是一个涵盖可能的“坏”肤色范围的训练集，以及相应的白平衡校正因子，以将其移回“好”肤色。我们要做的是用不同的白平衡因子生成糟糕的合成肤色。例如，如果我们想创造一个合理的“坏”肤色，我们可以将“好”肤色乘以 1.1、0.9、1.05。用于回到“良好”状态的白平衡与此相反，即 1/1.1、1/0.9、1/1.05。很简单。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/3830f24587f34e5807dd0f67115fe271.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*d9zuZSq-2HRC1USvZlE-Qw.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Synthetic Training Set</figcaption></figure><p id="342e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建大型数据集有不同的方法。一种方法是在可能的范围内使用高斯分布。另一种方式是三角形分布(numpy . random . normal/numpy . random . triangular)。我们最终得到的是一大组训练数据。</p><p id="9254" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有价值的优化是创建训练集，以便覆盖预期的“坏”肤色，但仅此而已。这使我们能够将我们的训练数据点集中在它做得好的地方。(我觉得那是个专业术语。)</p><p id="b1d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这里让我们跳到 Python。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="1d6f" class="my lb iq mu b gy mz na l nb nc">cls = Classifier()</span><span id="a2d9" class="my lb iq mu b gy nd na l nb nc">cls.fit(X_train, y_train)</span><span id="7cd6" class="my lb iq mu b gy nd na l nb nc">predictions = cls.predict(X_test)</span></pre><p id="16ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要的是训练许多可能的分类器中的一个。这些来自 scikit-learn 库以及一些定制的神经网络方法。以下是各种方法的结果:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ne"><img src="../Images/bd907b01e08567bdc22925868aa99363.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ZD0DBkC5xcbx2R7-TBuSg.png"/></div></div></figure><p id="2315" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的列表示:</p><ul class=""><li id="f734" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">方法——实际使用的分类方法。比如线性回归参考 sk learn . Linear _ model . Linear Regression，后面三个解释一下。</li><li id="d218" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">相同模型的均方误差—根据我们之前对正确答案的定义，这显示了我们的预测结果与该平均值的均方误差。越低越好。</li><li id="881f" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">集群——请记住，我们的目标不仅仅是获得“好”的肤色，而是获得一个“好”的肤色。事实证明这是不可能的——但是 3 比 10 好——我们仍然可以解决这个问题。顺便说一句，我们使用肘方法来确定集群的数量——“没有肘”意味着没有一个明确的答案。</li></ul><p id="2afc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后三个分类器是使用 Keras 定制的神经网络。</p><ul class=""><li id="6ee2" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">仅 DNN 平均颜色-这是一个密集的神经网络，输入仅为肤色 RGB，输出为白平衡校正</li><li id="e0f9" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">CNN-仅图像-这有一个 CNN 输入来开始拍摄眼睛周围的图像，包括大量的肉，输出是白平衡校正。这个想法是，见鬼，让 CNN 发挥它的魔力，也许加入一些眼睛的颜色——巩膜和虹膜。</li><li id="3fdc" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">CNN +标量注入——这是上述两种方法的结合。每一个都有其相应的输入，但它们加入了一个密集的神经网络，以产生白平衡校正的输出</li></ul><p id="9f22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你从图表中看到的，DNN 平均颜色比其他方法都要好。</p><h1 id="87f7" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">所以我们仍然有 3 个集群，我们需要 1 个…</h1><p id="f161" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">好吧，所以这不能完全解决我们的问题。对于正确的肤色，我们得到的不是一个事实，而是三个潜在的事实。我只想说，不是同一个人的每一个可能的损坏图像都可以被校正到一个肤色，而不需要比单个图像提供的更多的知识。</p><p id="afb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我又变了两个戏法:</p><ol class=""><li id="87da" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk nj mj mk ml bi translated">训练美国有线电视新闻网检测非常糟糕的图像。这是基于完整的自拍图像，我将图像分类为不可接受或可接受。不可接受的原因是明亮照明、黑暗照明和眩光等因素。与白平衡关系不大，但对更广泛的目标(为个人创建个性化的最佳调色板)很重要的是不可接受的元素，如眼镜和阴影。这个 CNN 在过滤掉明显不好的图像方面做得很好，我们可以要求用户拍摄另一张图像。</li><li id="7f31" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk nj mj mk ml bi translated">手动将“好”肤色的数量限制在一个能够产生“一个”答案的数量，而不会过度限制所有人看起来相似。</li></ol><h1 id="12bb" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">还不错！</h1><p id="7c3b" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">总之，这是一种自动白平衡校正的强大方法。</p><p id="a5bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">未来的方向实际上只是机器学习 101 方向，即模型和更多数据点的调整。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/fca0509262116c306faeba179bd93dd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*eDa5ZD6Jq6fOfVhPcKt45w.png"/></div><figcaption class="kt ku gj gh gi kv kw bd b be z dk">Sample Before/After Selfies</figcaption></figure><h1 id="11ac" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">脚注</h1><p id="e719" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated"><a class="ae nl" href="https://www.youtube.com/watch?v=B-W44JJToG8" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=B-W44JJToG8</a></p><p id="d5ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae nl" href="http://johnthemathguy.blogspot.com/2013/08/what-color-is-human-skin.html" rel="noopener ugc nofollow" target="_blank">http://johnthemathguy . blogspot . com/2013/08/what-color-is-human-skin . html</a></p><p id="0e0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae nl" href="https://itunes.apple.com/us/app/all-eyes-on-hue-portable-personalized-seasonal-color/id939633468?mt=8" rel="noopener ugc nofollow" target="_blank">https://itunes . apple . com/us/app/all-eyes-on-hue-portable-personalized-season-color/id 939633468？mt=8 </a></p><p id="eead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">https://itunes.apple.com/us/app/better-selfie/id999484452 的⁴ <a class="ae nl" href="https://itunes.apple.com/us/app/better-selfie/id999484452" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>