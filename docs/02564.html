<html>
<head>
<title>Identifying regional differences of Perinatal Mental Health indicators in the UK with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 R 确定英国围产期精神健康指标的地区差异</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/identifying-regional-differences-in-perinatal-mental-health-indicators-in-the-uk-with-r-1e8a8f1e7fb0?source=collection_archive---------14-----------------------#2019-04-26">https://towardsdatascience.com/identifying-regional-differences-in-perinatal-mental-health-indicators-in-the-uk-with-r-1e8a8f1e7fb0?source=collection_archive---------14-----------------------#2019-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b2fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> fingertipsR </strong>包提供了一个简单的接口来访问<a class="ae kl" href="https://fingertips.phe.org.uk/" rel="noopener ugc nofollow" target="_blank">指尖</a> API。该库包含由英国公共卫生部管理的大量公共卫生指标。</p><p id="bf25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将重点关注与<strong class="jp ir">围产期心理健康</strong>相关的数据，因为<a class="ae kl" href="https://www.meaney.lab.mcgill.ca/" rel="noopener ugc nofollow" target="_blank">我们的实验室</a>对早期逆境的表观遗传嵌入(以及其他方面)感兴趣。围产期心理健康问题发生在怀孕期间或孩子出生后的第一年。多达 20%的女性患有围产期精神疾病。围产期心理健康问题也会对儿童的情感、社交和认知发展产生长期影响。如果不进行治疗，它会对妇女及其家庭产生重大而持久的影响。</p><p id="1dc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我认为在监测指标上使用主成分分析和中等量分割来识别区域差异会很有意思，这可以为这些区域的控制提供改进(就像对<a class="ae kl" href="https://www.samabbott.co.uk/post/cluster-england-tb/" rel="noopener ugc nofollow" target="_blank"> TB </a>所做的那样)。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="884d" class="kv kw iq kr b gy kx ky l kz la"># load the needs package to load a bunch of libraries quickly (or install them if you don't already have them)<br/>library(needs)</span><span id="7c28" class="kv kw iq kr b gy lb ky l kz la">needs(purrr,<br/>      dplyr,<br/>      tibble,<br/>      fingertipsR,<br/>      tidyr,<br/>      magrittr,<br/>      FactoMineR,<br/>      impute,<br/>      DT,<br/>      broom,<br/>      stringr,<br/>      skimr,<br/>      cluster,<br/>      ggplot2,<br/>      ggfortify,<br/>      viridis,<br/>      hrbrthemes,<br/>      ggthemes,<br/>      cluster,<br/>      maptools,<br/>      gpclib<br/>      )</span></pre><h2 id="af09" class="kv kw iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">让我们看看指尖 API 中有什么</h2><p id="18f7" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated"><strong class="jp ir"> profiles() </strong>功能用于搜索<em class="ly"> profiles </em> —与特定疾病或风险因素相关的指标。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="6a4e" class="kv kw iq kr b gy kx ky l kz la">profs &lt;- profiles()<br/>DT::datatable(profs, rownames= FALSE)</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/62120d61c62162e3a3276725d51dd709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*mpxQKZmt_E4sX_uTeQi_Xw.png"/></div></figure><p id="1c0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所述，我对<strong class="jp ir">围产期心理健康</strong>感兴趣，所以我会选择这些档案。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="b5e1" class="kv kw iq kr b gy kx ky l kz la">sel_profs &lt;- profs[grepl("Perinatal Mental Health", profs$ProfileName),]<br/>DT::datatable(sel_profs, rownames = FALSE)</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/b29cd5f94e15367deb8633e93a1af799.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*wQ9uL7W3IlJyxDikLijtdA.png"/></div></figure><p id="9019" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有四个<strong class="jp ir">领域</strong>与<strong class="jp ir">围产期心理健康</strong>相关。在这些领域中，有许多在不同时期、不同地域、不同性别、不同年龄段等出现的<strong class="jp ir">指标</strong>。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="98a6" class="kv kw iq kr b gy kx ky l kz la">peri_inds &lt;- indicators(ProfileID = sel_profs$ProfileID)<br/>DT::datatable(peri_inds, rownames= FALSE)</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/086a23e8e1be7d9e27739612d2ed5059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*cMYDTuvnIYwYggpU9mw4YQ.png"/></div></figure><p id="4c17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这给了我们<strong class="jp ir"> 49 </strong>围产期心理健康<strong class="jp ir">指标</strong>，我们现在可以使用<strong class="jp ir">指尖 _ 数据()</strong>函数结合调用<strong class="jp ir"> purrr::map() </strong>来提取这些指标。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="2863" class="kv kw iq kr b gy kx ky l kz la">peri_df &lt;- peri_inds$IndicatorID %&gt;% map(~fingertips_data(IndicatorID = .))</span></pre><p id="a342" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这导致<strong class="jp ir"> 49 </strong>不稳定；但是，许多是空的，需要删除。</p><p id="068b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将对这 49 个指标使用降维(PCA)和聚类(PAM)来生成具有类似围产期心理健康指标特征的县的聚类。这可能有助于确定区域差异，并可能有助于改进研究和控制工作的未来框架。</p><p id="6d72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将从<strong class="jp ir">风险&amp;相关因素</strong>领域中选择<strong class="jp ir">抑郁症:%记录患病率(18 岁以上)</strong>作为所有其他指标匹配的关键指标。下面的代码在县一级提取这些数据，将值变量重新编码为最近的发病率，并提取病例的总体发病率。我过滤掉缺失的数据，并调整时间段来代表每个滚动平均值的最后一年。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="95ff" class="kv kw iq kr b gy kx ky l kz la">peri_inc &lt;- as_tibble(peri_df[[10]]) %&gt;% <br/>        dplyr::filter(AreaType %in% "County &amp; UA") %&gt;% <br/>        dplyr::select(AreaName, Timeperiod, rec_inc_rate = Value) %&gt;% <br/>        mutate(Timeperiod = Timeperiod %&gt;% <br/>                 str_split("/") %&gt;% <br/>                 map_chr(first) %&gt;% <br/>                 as.numeric() %&gt;% <br/>                 {. + 2} %&gt;% <br/>                 as.character())</span><span id="8b3c" class="kv kw iq kr b gy lb ky l kz la">peri_df_extraction &lt;- function(peri_df, var_name, area_type = "County &amp; UA") {<br/>  df &lt;- peri_df %&gt;% <br/>    filter(AreaType %in% area_type) %&gt;% <br/>    dplyr::select(AreaName, Value, Timeperiod) %&gt;% <br/>    rename_at(.vars = vars(Value), funs(paste0(var_name)))<br/>  <br/>  return(df)<br/>}</span><span id="2d70" class="kv kw iq kr b gy lb ky l kz la">var_names &lt;- c("fertility_rate",<br/>               "booking_under_20",<br/>               "reproductive_age",<br/>               "non_UK",<br/>               "birth_under_20",<br/>               "booking_over_40",<br/>               "booking_BAME",<br/>               "poverty",<br/>               "IDACI",<br/>               "homelessness",<br/>               "contraceptions_under_18",<br/>               "single_parent",<br/>               "sever_mental_illness",<br/>               "drug_treatment",<br/>               "alcohol_treatment",<br/>               "child_protection", <br/>               "child_in_need", <br/>               "infant_mortality",<br/>               "child_looked_after", <br/>               "sole_birth",<br/>               "complex_social_factors",<br/>               "multiparity",<br/>               "caesarean",<br/>               "preterm",<br/>               "stillbirth",<br/>               "abuse", <br/>               "skin_contact",<br/>               "distress_lb", <br/>               "distress_ub", <br/>               "mild_depressive_lb", <br/>               "mild_depressive_ub", <br/>               "chronic_SMI", <br/>               "postpartum_psychosis", <br/>               "PTSD", <br/>               "severe_depressive",<br/>               "booking_detection",<br/>               "booking_substance",<br/>               "booking_support",<br/>               "booking_alcohol",<br/>               "booking_complex_social_factors",<br/>               "booking_early",<br/>               "less_14_days",<br/>               "review_8_weeks",<br/>               "review_12_months",<br/>               "antenatal_MH_detection",<br/>               "postnatal_MH_detection",<br/>               "postnatal_emotional_change",<br/>               "postnatal_MH_support"<br/>               )</span><span id="a6c1" class="kv kw iq kr b gy lb ky l kz la">extracted_tb &lt;- map2(peri_df[-10], var_names, ~peri_df_extraction(.x, .y)) %&gt;% <br/>    reduce(full_join, by = c("AreaName", "Timeperiod"))</span><span id="cc53" class="kv kw iq kr b gy lb ky l kz la">com_peri_df &lt;- peri_inc %&gt;% <br/>  left_join(extracted_tb, by = c("AreaName", "Timeperiod")) %&gt;% <br/>  mutate(year = Timeperiod %&gt;% as.numeric) %&gt;% <br/>  mutate_if(is.character, as.factor) %&gt;% <br/>  dplyr::select(-Timeperiod)</span><span id="ee8d" class="kv kw iq kr b gy lb ky l kz la">skimr::skim(com_peri_df)</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi md"><img src="../Images/d7a86ec2ade6907fd64dba9fd95a1196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PEgJA5CiJB2gkZG1exREvw.png"/></div></div></figure><p id="940f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要检查数据的完整性:</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="61f5" class="kv kw iq kr b gy kx ky l kz la">get_frac_missing &lt;- function(df) {<br/>  df %&gt;% <br/>    nest() %&gt;% <br/>    mutate(missing = map(data,~map_dfr(. ,~sum(is.na(.))/length(.)))) %&gt;% <br/>    dplyr::select(-data) %&gt;% <br/>    unnest(missing) <br/>}</span><span id="7d91" class="kv kw iq kr b gy lb ky l kz la">## Get the proportion missing per variableby year<br/>peri_miss_per_year &lt;- com_peri_df %&gt;% <br/>  group_by(year) %&gt;% <br/>  get_frac_missing %&gt;% <br/>  mutate_all(~round(., 2)) %&gt;% <br/>  arrange(year)</span><span id="fffb" class="kv kw iq kr b gy lb ky l kz la">## Drop full missing variables<br/>peri_partial_miss_year &lt;- peri_miss_per_year %&gt;% <br/>  select_if(~!sum(.) == length(.))</span><span id="3c68" class="kv kw iq kr b gy lb ky l kz la">## Full missing variables<br/>com_miss_vars &lt;- setdiff(names(peri_miss_per_year), names(peri_partial_miss_year))</span><span id="5303" class="kv kw iq kr b gy lb ky l kz la">## Which year has the most complete data<br/>peri_complete_years_all_vars &lt;- com_peri_df %&gt;% <br/>  group_by(year) %&gt;% <br/>  nest() %&gt;% <br/>  mutate(missing = map(data,~mean(colSums(is.na(.))/nrow(.)))) %&gt;% <br/>  dplyr::select(-data) %&gt;% <br/>  unnest(missing) %&gt;% <br/>  mutate(missing = round(missing, 2)) %&gt;% <br/>  arrange(year)</span><span id="e2bf" class="kv kw iq kr b gy lb ky l kz la">DT::datatable(peri_complete_years_all_vars, rownames = FALSE)</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/72acf72295662d6e48964ab7915cbe1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*9wt1MX8VOupd-mayX6jkUw.png"/></div></figure><p id="e34c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常我会用最新的可用数据；然而，在这种情况下，它是相当稀疏的，所以让我们看看来自<strong class="jp ir"> 2015 年的数据。</strong></p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="9aec" class="kv kw iq kr b gy kx ky l kz la">peri_df_2015  &lt;- janitor::remove_empty(com_peri_df) %&gt;% <br/>  filter(year == 2015) %&gt;% <br/>  filter(rec_inc_rate &gt; 7.39) %&gt;% <br/>  select(-year)</span><span id="b86d" class="kv kw iq kr b gy lb ky l kz la">DT::datatable(peri_df_2015, rownames = FALSE)</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mj"><img src="../Images/15370274225090d729ca393495af3aa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t907chcsJPF7jTMyoHP_Mg.png"/></div></div></figure><p id="71c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这给我们留下了 2015 年以来 38 个县的 8 个孕产妇心理健康指标的整洁数据集。</p><h2 id="d82d" class="kv kw iq bd lc ld le dn lf lg lh dp li jy lj lk ll kc lm ln lo kg lp lq lr ls bi translated">降维</h2><p id="36c1" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">我们现在准备对数据进行一些聚类分析。第一步是使用 PCA 降低数据的维数。我们使用 FactoMineR 包中的<strong class="jp ir"> estim_ncp </strong>函数(该函数使用本文中概述的<a class="ae kl" href="https://www.sciencedirect.com/science/article/pii/S0167947311004099" rel="noopener ugc nofollow" target="_blank">方法)来估计所需的主要组件的数量。然后，我们执行主成分分析，并绘制每个成分解释的方差，作为对<strong class="jp ir"> estim_ncp </strong>的检查。以下所有分析都是使用嵌套 tibbles 完成的，因此可以很容易地推广到更高维的用例。</a></p><p id="876e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们使用<strong class="jp ir"> estim_ncp </strong>函数计算主成分的最佳数量，使用<strong class="jp ir"> prcomp </strong>函数执行 PCA，并绘制每个成分解释的方差，作为对<strong class="jp ir"> estim_ncp </strong>的检查。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="2169" class="kv kw iq kr b gy kx ky l kz la">df &lt;- as.data.frame(peri_df_2015)<br/>FactoMineR::estim_ncp(df[2:9], ncp.min = 2, ncp.max = 10) </span></pre><p id="36e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">组件的最佳数量为<strong class="jp ir"> 4。</strong></p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="734c" class="kv kw iq kr b gy kx ky l kz la">peri_pca &lt;- peri_df_2015 %&gt;% <br/>  nest() %&gt;% <br/>  mutate(<br/>    numeric_data = map(data, ~select_if(., is.numeric) %&gt;% <br/>                         as.data.frame()),<br/>    optimal_pca_no = map(numeric_data, ~estim_ncp(., <br/>                                                  scale = TRUE, <br/>                                                  ncp.min = 2, <br/>                                                  ncp.max = 6)) %&gt;% <br/>      map_dbl(~.$ncp),<br/>    pca = map(numeric_data, ~prcomp(.x, <br/>                                    center = TRUE, <br/>                                    scale = TRUE)),<br/>    pca_data = map(pca, ~.$x),<br/>    pca_aug = map2(pca, data, ~augment(.x, data = .y)))</span><span id="6a07" class="kv kw iq kr b gy lb ky l kz la">## Variance explained<br/>var_exp &lt;- peri_pca %&gt;% <br/>  dplyr::select(-optimal_pca_no) %&gt;% <br/>  unnest(pca_aug) %&gt;% <br/>  summarize_at(.vars = vars(contains("PC")), .funs = funs(var)) %&gt;% <br/>  gather(key = pc, value = variance) %&gt;% <br/>  mutate(var_exp = variance/sum(variance) * 100,<br/>         cum_var_exp = cumsum(var_exp),<br/>         pc = str_replace(pc, ".fitted", "") %&gt;% <br/>           str_replace("PC", ""))</span><span id="2c6a" class="kv kw iq kr b gy lb ky l kz la">## Plot variance explained<br/>var_exp %&gt;% <br/>  rename(<br/>    `Variance Explained` = var_exp,<br/>    `Cumulative Variance Explained` = cum_var_exp<br/>  ) %&gt;% <br/>  gather(key = key, value = value, `Variance Explained`, `Cumulative Variance Explained`) %&gt;%<br/>  mutate(key = key %&gt;% <br/>           factor(levels  = c("Variance Explained", <br/>                              "Cumulative Variance Explained"))) %&gt;% <br/>  mutate(value = value / 100) %&gt;% <br/>  mutate(pc = factor(pc, levels = as.character(1:max(var_exp$pc %&gt;% as.numeric)))) %&gt;% <br/>  ggplot(aes(pc, value, group = key)) + <br/>  geom_point(size = 2, alpha = 0.8) + <br/>  geom_line(size = 1.1, alpha = 0.6) + <br/>  facet_wrap(~key, scales = "free_y") +<br/>  theme_bw() +<br/>  labs(<br/>    title = "Variance Explained by Principal Component",<br/>    subtitle = paste0("The optimal number of principal components suggested by estim_ncp was ",<br/>                      peri_pca$optimal_pca_no, " which explains ", round(var_exp$cum_var_exp[[2]], 0), "% of the data."),<br/>    x = "Principal Component",<br/>    y = "Variance Explained (%)",<br/>    caption = "<a class="ae kl" href="http://twitter.com/MattOldach" rel="noopener ugc nofollow" target="_blank">@MattOldach</a> Source: Public Health England (fingertipsR)"<br/>  )</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mk"><img src="../Images/057f79c4f366c3535c80a88e69301ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hiZWHvS1MluZ9Kiq-POI9g.png"/></div></div></figure><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="1377" class="kv kw iq kr b gy kx ky l kz la">## Perform pam on pca data 1 to 6 groups<br/>peri_pca_pam &lt;- peri_pca %&gt;%<br/>  mutate(centers = list(2:10)) %&gt;% <br/>  unnest(centers, .preserve = everything()) %&gt;% <br/>  dplyr::select(-centers, centers = centers1) %&gt;% <br/>  group_by(centers) %&gt;% <br/>  mutate(<br/>    pam = map(pca_data,<br/>              ~ pam(x = .x[, 1:optimal_pca_no], k = centers, stand = TRUE)),<br/>    clusters = map(pam, ~.$clustering),<br/>    avg_silhouette_width = map(pam, ~.$silinfo$avg.width),<br/>    data_with_clusters = map2(.x = data, .y = clusters, ~mutate(.x, cluster = factor(.y, ordered = TRUE)))<br/>  ) %&gt;% <br/>  ungroup</span><span id="c7fd" class="kv kw iq kr b gy lb ky l kz la">## Get max silhouette width<br/>max_silhouette_width &lt;- peri_pca_pam %&gt;% <br/>  dplyr::select(centers, avg_silhouette_width) %&gt;% <br/>  unnest(avg_silhouette_width) %&gt;% <br/>  arrange(desc(avg_silhouette_width)) %&gt;% <br/>  slice(1)<br/>  <br/>## Plot average silhouette width<br/>peri_pca_pam %&gt;% <br/>  dplyr::select(centers, avg_silhouette_width) %&gt;% <br/>  unnest(avg_silhouette_width) %&gt;% <br/>  ggplot(aes(x = centers, y = avg_silhouette_width)) +<br/>  geom_line(size = 2, alpha = 0.4) +<br/>  geom_point(size = 3, alpha = 0.8) +<br/>  theme_bw() +<br/>  scale_x_continuous(breaks = seq(1, 10, 1), minor_breaks = NULL) +<br/>  scale_y_continuous(limits = c(NA, NA), breaks = seq(0, 1, 0.01), minor_breaks = NULL) +<br/>  labs(title = "Average Silhouette Width by Number of PAM Clusters",<br/>       subtitle = paste0("The optimal number of clusters identifed by avg. silhouette width was ",<br/>                      max_silhouette_width$centers,<br/>                      " with an avg. silhouette width of ", <br/>                      round(max_silhouette_width$avg_silhouette_width, 2)<br/>       ),<br/>       x = "Clusters",<br/>       y = "Avg. Silhouette Width",<br/>       caption = "<a class="ae kl" href="http://twitter.com/MattOldach" rel="noopener ugc nofollow" target="_blank">@MattOldach</a> Source: Public Health England (fingertipsR)")</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mk"><img src="../Images/82d195984a34e3547dc47441c5565828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LgriD3bUGeaX0p9hdCIWsg.png"/></div></div></figure><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="abd6" class="kv kw iq kr b gy kx ky l kz la">## Plot clusters<br/>pca_plot &lt;- peri_pca_pam %&gt;% <br/>  filter(centers == max_silhouette_width$centers) %&gt;% <br/>  select(data_with_clusters, pca) %&gt;% <br/>  mutate(pca_graph = map2(.x = pca, <br/>                          .y = data_with_clusters,<br/>                          ~ autoplot(.x, x = 1, y = 2, <br/>                                     loadings = TRUE, loadings.label = TRUE,<br/>                                     loadings.label.repel = TRUE,<br/>                                     loadings.label.size = 2, loadings.alpha = 0.8,<br/>                                     loadings.label.vjust = -1, data = .y, <br/>                                     label = TRUE, label.label = "AreaName",<br/>                                     label.size = 1.5, label.vjust = -1, <br/>                                     alpha = 0.3, frame = TRUE, <br/>                                     frame.type = 'convex', frame.alpha= 0.05,<br/>                                     colour = "cluster", size = "rec_inc_rate") +<br/>                            theme_bw() +<br/>                            labs(x = paste0("Principal Component 1 (Variance Explained: ",<br/>                                            round(var_exp$var_exp[[1]], 1), "%)"),<br/>                                 y = paste0("Principal Component 2 (Variance Explained: ",<br/>                                            round(var_exp$var_exp[[2]], 1), "%)")) +<br/>                            guides(colour=guide_legend(title = "Cluster", ncol = 2), <br/>                                   fill=guide_legend(title= "Cluster", ncol = 2),<br/>                                   size = guide_legend(title = "Depression: % recorded prevalence",<br/>                                                       ncol = 2)) +<br/>                           scale_color_manual(name = "Cluster",<br/>                                              values = c("#6b5b95",<br/>                                                         "#feb236",<br/>                                                         "#d64161",<br/>                                                         "#ff7b25",<br/>                                                         "#87bdd8")) +<br/>                           scale_fill_manual(name = "Cluster",<br/>                                              values = c("#6b5b95",<br/>                                                         "#feb236",<br/>                                                         "#d64161",<br/>                                                         "#ff7b25",<br/>                                                         "#87bdd8")) +<br/>                            theme(legend.position = "bottom", <br/>                                  legend.box = "horizontal") +<br/>                            labs(<br/>                              title = "Maternal Mental Health in England",<br/>                              subtitle = "The arrows are variable loadings and points are counties coloured by cluster membership",<br/>                              caption = "<a class="ae kl" href="http://twitter.com/MattOldach" rel="noopener ugc nofollow" target="_blank">@MattOldach</a> Source: Public Health England (fingertipsR)"<br/>                            )<br/>  )) %&gt;% <br/>  pull(pca_graph) %&gt;% <br/>  first</span><span id="17eb" class="kv kw iq kr b gy lb ky l kz la">pca_plot</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mk"><img src="../Images/aacea101143ada79068c04b3aa8e06c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tQ2WXXKfM06Cy_dqXlB0OA.png"/></div></div></figure><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="45a0" class="kv kw iq kr b gy kx ky l kz la">sum_peri_df &lt;- peri_pca_pam %&gt;% <br/>  filter(centers == max_silhouette_width$centers) %&gt;% <br/>  pull(data_with_clusters) %&gt;% <br/>  map(~ gather(., key = "Variable", value = "value", -AreaName, -cluster)) %&gt;% <br/>  first %&gt;% <br/>  rename(Cluster = cluster)</span><span id="bb54" class="kv kw iq kr b gy lb ky l kz la">plot_cluster_diff &lt;- sum_peri_df %&gt;% <br/>  ggplot(aes(x = Variable, y = value, col = Cluster, fill = Cluster)) +<br/>  geom_violin(draw_quantiles = c(0.025, 0.5, 0.975), alpha = 0.2, scale = "width") +<br/>  geom_jitter(position = position_jitterdodge(), alpha = 0.3) +<br/>  coord_flip() +<br/>  theme_minimal() +<br/>  scale_y_continuous(breaks = seq(0, 100, 6), minor_breaks = NULL) +<br/>  scale_fill_manual(name = "Cluster",<br/>                                              values = c("#6b5b95",<br/>                                                         "#feb236",<br/>                                                         "#d64161",<br/>                                                         "#ff7b25",<br/>                                                         "#87bdd8")) +<br/>  scale_color_manual(name = "Cluster",<br/>                                              values = c("#6b5b95",<br/>                                                         "#feb236",<br/>                                                         "#d64161",<br/>                                                         "#ff7b25",<br/>                                                         "#87bdd8")) +<br/>  theme(legend.position = "bottom") +<br/>  labs( <br/>    title = "Maternal Mental Health in England; Summarised by Cluster",<br/>    subtitle = "Violin plots are scaled by width, with the 2.5%, 50% and 97.5% quantiles shown.",<br/>    x = "Variable",<br/>    y = "Recorded % depression prevalance (aged 18+) for rec_int_rate, otherwise proportion (0-100%)",<br/>    caption = "<a class="ae kl" href="http://twitter.com/MattOldach" rel="noopener ugc nofollow" target="_blank">@MattOldach</a> Source: Public Health England (fingertipsR)")</span><span id="89b7" class="kv kw iq kr b gy lb ky l kz la">plot_cluster_diff</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mk"><img src="../Images/93f72f67c798960085c8f1faedf17f53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y82z9AZP0OLkN4Hbh2sEew.png"/></div></div></figure><p id="5b94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从这些图中，我们看到，显示较高近期增长率的第三组有较高比例的产后精神病、轻度抑郁和苦恼。</p><p id="a9ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以在地图上用英国数据服务提供的英国各县的轮廓来绘制每个县的聚类成员关系(<a class="ae kl" href="https://borders.ukdataservice.ac.uk/easy_download_data.html?data=England_ct_2011" rel="noopener ugc nofollow" target="_blank">在此</a>下载 ShapeFiles，在此<a class="ae kl" href="https://borders.ukdataservice.ac.uk/easy_download_data.html?data=England_urb_2001" rel="noopener ugc nofollow" target="_blank">下载</a>)。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="cc43" class="kv kw iq kr b gy kx ky l kz la">peri_cluster_map &lt;- function(peri_pca_pam) {<br/>gpclibPermit()</span><span id="f7de" class="kv kw iq kr b gy lb ky l kz la">england_counties &lt;- rgdal::readOGR("england_ct_2011.shp") %&gt;%<br/>  fortify(region = "code") %&gt;% <br/>  as_tibble</span><span id="7734" class="kv kw iq kr b gy lb ky l kz la">england_urban_areas &lt;- rgdal::readOGR("england_urb_2001.shp") %&gt;% <br/>  fortify(region = "name") %&gt;% <br/>  as_tibble %&gt;% <br/>  filter(id %in% c("Sheffield Urban Area", <br/>                   "Plymouth",<br/>                   "Skelton (Redcar and Cleveland)",<br/>                   "Brighton/Worthing/Littlehampton",<br/>                   "Leicester Urban Area"<br/>                   ))</span><span id="44ac" class="kv kw iq kr b gy lb ky l kz la">## Make custom positions for urban area labels<br/>urban_area_labels &lt;- england_urban_areas %&gt;%<br/>  group_by(id) %&gt;% <br/>  slice(100) %&gt;% <br/>  ungroup() %&gt;% <br/>  mutate(long = long - 200000,<br/>         lat = lat + 20000)<br/>  <br/>  <br/>peri_cluster_results &lt;- peri_pca_pam %&gt;% <br/>  filter(centers == max_silhouette_width$centers) %&gt;% <br/>  pull(data_with_clusters) %&gt;% <br/>  first</span><span id="873f" class="kv kw iq kr b gy lb ky l kz la">peri_cluster_results &lt;- peri_df[[14]] %&gt;% <br/>              dplyr::select(AreaName, AreaCode, AreaType) %&gt;% <br/>  filter(AreaType %in% "County &amp; UA") %&gt;% <br/>              unique %&gt;% <br/>  left_join(peri_cluster_results,<br/>            by = "AreaName") %&gt;% <br/>  left_join(england_counties, by = c("AreaCode" = "id"))</span><span id="fec5" class="kv kw iq kr b gy lb ky l kz la">peri_cluster_results %&gt;% <br/>  rename(Cluster = cluster) %&gt;% <br/>  drop_na(Cluster) %&gt;% <br/>  dplyr::select(long, lat, Cluster, group) %&gt;% <br/>  ggplot( <br/>                 aes(x = long, <br/>                     y = lat,<br/>                     fill = Cluster)) +<br/>    geom_polygon(data = england_urban_areas, <br/>                 aes(group = group, fill = NULL),<br/>                 alpha = 0.4) +<br/>    geom_path(data = peri_cluster_results, <br/>              aes(group = group, fill = NULL), <br/>              alpha = 0.4) +<br/>    geom_polygon(data = peri_cluster_results, <br/>                 aes(group = group, fill = NULL),<br/>                 alpha = 0.1) +<br/>    geom_polygon(aes(group = group), alpha = 0.6) +<br/>    geom_line(data = urban_area_labels %&gt;% <br/>                bind_rows(urban_area_labels %&gt;% <br/>                            mutate(long = long + 200000, <br/>                                   lat = lat - 20000)),<br/>              aes(fill = NA, group = id), alpha = 0.8) + <br/>    geom_label(data = urban_area_labels,<br/>              aes(label = id), fill = "grey") +<br/>    scale_fill_manual(name = "Cluster",<br/>                                              values = c("#6b5b95",<br/>                                                         "#feb236",<br/>                                                         "#d64161",<br/>                                                         "#ff7b25",<br/>                                                         "#87bdd8")) +<br/>    coord_equal() +<br/>    theme_map() +<br/>    theme(legend.position = "bottom") +<br/>    labs(title = "Maternal Mental Health Indicators; Map of County Level Clusters in England",<br/>         subtitle = "Using data from 2015",<br/>         caption = "Selected urban areas are shown (dark grey) and labelled.<br/><a class="ae kl" href="http://twitter.com/MattOldach" rel="noopener ugc nofollow" target="_blank">@MattOldach</a> Source: Public Health England (fingertipsR)<br/>Contains National Statistics data © Crown copyright and database right 2019. <br/>         Contains OS data © Crown copyright and database right 2019")<br/>}</span><span id="a0f4" class="kv kw iq kr b gy lb ky l kz la">plot_peri_cluster_map &lt;- peri_cluster_map(peri_pca_pam)</span><span id="16d9" class="kv kw iq kr b gy lb ky l kz la">plot_peri_cluster_map</span></pre><figure class="km kn ko kp gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ml"><img src="../Images/08dd4ff72c47d65685169837f26d507e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kTo7dOaRbr29F1m8Dq4n5w.png"/></div></div></figure></div></div>    
</body>
</html>