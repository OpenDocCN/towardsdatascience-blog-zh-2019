<html>
<head>
<title>Testing Serverless Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试无服务器服务</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/testing-serverless-services-59c688812a0d?source=collection_archive---------4-----------------------#2019-09-08">https://towardsdatascience.com/testing-serverless-services-59c688812a0d?source=collection_archive---------4-----------------------#2019-09-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f3d6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 moto 对 AWS lambda 函数进行 python 单元测试。</h2></div><p id="75e1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated">避免测试对于任何软件项目的成功都是至关重要的。如果您正在开发一个应用程序，您希望编写测试来检查您的应用程序的功能。通过测试，您可以添加新的特性或修复错误，并轻松地部署更改后的代码。没有测试，你将生活在一个充满不安全感和挫败感的世界里。</p><p id="5b1f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用 python 默认测试框架<strong class="kk iu"> unittest </strong>和一个名为<strong class="kk iu"> moto </strong>的 AWS 服务模拟工具来测试我们的 AWS lambda 的 python 功能。此外，我们将解释如何使用<strong class="kk iu"> AAA 模式</strong> (Arrange，Act，Assert)来安排和格式化你的测试代码。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ln"><img src="../Images/52fc24291657099564701c82b43c03c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XOuJBLibYja567wwgmTHyA.jpeg"/></div></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk">Photo by <a class="ae md" href="https://unsplash.com/@battlecreekcoffeeroasters?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Battlecreek Coffee Roasters</a> on <a class="ae md" href="https://unsplash.com/search/photos/quality-control?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="3165" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">Lambda 处理器逻辑</h1><p id="19be" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">下面的代码是原始代码的一部分，它是一个名为“无服务器数据管道示例”的项目的一部分，是我之前写的<a class="ae md" rel="noopener" target="_blank" href="/build-a-serverless-data-pipeline-on-aws-7c7d498d9707">教程</a>的结果。这个处理程序的原始代码可以在我的 Github 上找到。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="6df9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">lambda 处理程序由 s3 事件触发。该事件是一个. eml 文件(电子邮件文件),它是在我们的 s3 bucket 的 unzip/文件夹中创建的。lambda 的配置和触发 lambda 的 s3 事件可以在项目的 serverless.yml 中的<a class="ae md" href="https://github.com/vincentclaes/serverless_data_pipeline_example/blob/master/serverless.yml#L43" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="b840" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该事件以字典的形式作为第一个参数传递给我们的处理函数。我们从事件中获取桶名和 s3 键，它指向我们的电子邮件文件的位置。我们读取电子邮件文件，并将内容提取为 JSON 对象。JSON 对象被转储回 s3。从环境变量中检索目标桶和关键字。环境变量在 serverless.yml 文件中配置<a class="ae md" href="https://github.com/vincentclaes/serverless_data_pipeline_example/blob/master/serverless.yml#L52" rel="noopener ugc nofollow" target="_blank">这里是</a>。</p><h1 id="99d9" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">测试 Lambda 处理器逻辑</h1><p id="44ed" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">从为项目中的测试创建一个结构开始。最简单的方法是模仿 tests 文件夹中的应用程序结构。你可以在这里找到一个例子:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="8985" class="ni mf it ne b gy nj nk l nl nm">.<br/>├── serverless_data_pipeline<br/>│   ├── lambda_function<br/>│   │   ├── extract.py<br/>└── serverless_data_pipeline_tests<br/>    └── lambda_function<br/>        └── test_extract.py</span></pre><p id="ab73" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 test_extract.py 模块中，我们有以下代码:</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="ba19" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">单元测试</h1><p id="9938" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">为了测试我们的 lambda 处理程序的逻辑，我们将使用<a class="ae md" href="https://docs.python.org/3/library/unittest.html#module-unittest" rel="noopener ugc nofollow" target="_blank"> unittest </a>。unittest 是 python 标准库的一部分，帮助您创建和运行单元测试。</p><h2 id="be96" class="ni mf it bd mg nn no dn mk np nq dp mo kr nr ns mq kv nt nu ms kz nv nw mu nx bi translated"><strong class="ak">测试用例</strong></h2><p id="783c" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">我们首先在 test_extract.py 文件中创建一个名为<code class="fe ny nz oa ne b">TestExtract</code>的类。我们的类继承自 unittest.TestCase。通过从 TestCase 继承，您可以访问有助于您的测试的函数。在一个测试用例中，以关键字“test”开头的方法被 unittest 测试运行器视为一个测试。您将在我们的示例中找到一个测试函数:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="a779" class="ni mf it ne b gy nj nk l nl nm">test_extract_the_contents_of_an_email_successfully(self):</span></pre><blockquote class="ob oc od"><p id="68af" class="ki kj oe kk b kl km ju kn ko kp jx kq of ks kt ku og kw kx ky oh la lb lc ld im bi translated">提示:以你的测试函数的名义描述你正在测试的东西，让你自己和他人容易理解你正在测试的东西。</p></blockquote><h2 id="9f8d" class="ni mf it bd mg nn no dn mk np nq dp mo kr nr ns mq kv nt nu ms kz nv nw mu nx bi translated"><strong class="ak">安装()和拆卸()</strong></h2><p id="ca4b" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">unittest 提供了一些函数，这些函数可以设置和拆除您的测试环境，而不需要在每次测试之前和之后显式调用它们。在我们的例子中，为了让我们的测试成功运行，我们需要必要的 s3 存储桶和一些环境变量。我们将此逻辑添加到<a class="ae md" href="https://gist.github.com/vincentclaes/659f940445b482ae74aad92ac5d056bf#file-test_extract-py-L20" rel="noopener ugc nofollow" target="_blank"> <em class="oe">设置</em> </a>功能中，并在执行测试之前调用设置功能。</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="6358" class="ni mf it ne b gy nj nk l nl nm">def setUp(self):<br/>    os.environ[TestExtract.ENV_DEST_KEY] = TestExtract.DEST_KEY<br/>    os.environ[TestExtract.ENV_DEST_BUCKET] = TestExtract.DEST_BUCKET<br/><br/>    conn = boto3.resource('s3')<br/>    conn.create_bucket(Bucket=TestExtract.SOURCE_BUCKET)<br/>    conn.create_bucket(Bucket=TestExtract.DEST_BUCKET)</span></pre><p id="798e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">测试运行后，我们要删除 s3 存储桶和环境变量。我们在<a class="ae md" href="https://gist.github.com/vincentclaes/659f940445b482ae74aad92ac5d056bf#file-test_extract-py-L28" rel="noopener ugc nofollow" target="_blank"> <em class="oe">拆卸</em> </a>函数中添加了该逻辑，并且每次测试完成时，都会执行拆卸函数。</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="6fec" class="ni mf it ne b gy nj nk l nl nm">def tearDown(self):<br/>    del os.environ[TestExtract.ENVIRON_DEST_KEY]<br/>    del os.environ[TestExtract.ENVIRON_DEST_BUCKET]<br/><br/>    self.remove_bucket(TestExtract.SOURCE_BUCKET)<br/>    self.remove_bucket(TestExtract.DESTINATION_BUCKET)</span></pre><h1 id="9957" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated"><strong class="ak">摩托</strong></h1><p id="836c" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">我们希望在本地执行我们的功能，而不想与“真实的”AWS 环境交互。最好我们想与一个模拟的 AWS 环境互动。为了创建一个模拟的 AWS 环境，我们将使用<a class="ae md" href="https://github.com/spulec/moto" rel="noopener ugc nofollow" target="_blank"> moto </a>。moto 是一个库，允许您的测试轻松模拟 AWS 服务。我们从 moto 继承了 mock_s3，并将其用作测试类的装饰器:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="fec4" class="ni mf it ne b gy nj nk l nl nm">@mock_s3<br/>class TestExtract(unittest.TestCase):</span></pre><p id="7260" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦将 mock_s3 设置为装饰器，通过 boto3 与 s3 的每一次交互都会被模仿。像这样，我们的测试可以离线运行，就像它们与 AWS 服务交互一样。</p><h1 id="64d5" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">安排动作断言(AAA)</h1><p id="b0d3" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">在测试函数中，我们测试内容是否从。eml 文件，并且内容作为 JSON 对象成功地转储到 s3 上。每个测试函数都是按照<a class="ae md" href="http://wiki.c2.com/?ArrangeActAssert" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu">安排、动作、断言(AAA) </strong>原则</a>构造的。</p><h2 id="01b4" class="ni mf it bd mg nn no dn mk np nq dp mo kr nr ns mq kv nt nu ms kz nv nw mu nx bi translated"><strong class="ak">安排你的模拟 AWS 环境</strong></h2><p id="db7c" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">首先，我们<a class="ae md" href="https://github.com/vincentclaes/serverless_data_pipeline_example/blob/master/serverless_data_pipeline_tests/lambda_function/test_extract.py#L106" rel="noopener ugc nofollow" target="_blank"> <em class="oe">安排</em> </a>我们的环境以便执行我们的测试。如上所述，一般的设置和拆卸功能可以在设置和拆卸功能中完成。特定于测试的配置可以在测试函数本身中完成。</p><p id="0d3f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦创建了 s3 存储桶并在 setUp 函数中设置了环境变量，我们就通过读取一个. eml 文件并将该文件上传到 s3 来在我们的测试函数中安排特定于测试的环境。读取和上传发生在函数中</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="5a23" class="ni mf it ne b gy nj nk l nl nm">def put_email_to_s3(self, test_email_path, email_name):</span></pre><h2 id="c75e" class="ni mf it bd mg nn no dn mk np nq dp mo kr nr ns mq kv nt nu ms kz nv nw mu nx bi translated"><strong class="ak">执行您想要测试的功能</strong></h2><p id="b817" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">下一步是<a class="ae md" href="https://github.com/vincentclaes/serverless_data_pipeline_example/blob/master/serverless_data_pipeline_tests/lambda_function/test_extract.py#L113" rel="noopener ugc nofollow" target="_blank"> <em class="oe"> act </em> </a> <em class="oe"> </em>通过执行我们想要测试的 lambda 处理函数。</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="48ef" class="ni mf it ne b gy nj nk l nl nm">s3_key_extracted_message = extract.handler(event, None)</span></pre><p id="99f8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们看到我们的处理函数返回了一个 s3 键。在生产中，这个 s3 密钥没有被使用，也没有任何价值。我们返回这个值只是为了验证我们的测试是否如我们所期望的那样运行。</p><h2 id="cec7" class="ni mf it bd mg nn no dn mk np nq dp mo kr nr ns mq kv nt nu ms kz nv nw mu nx bi translated"><strong class="ak">断言我们得到了预期的结果</strong></h2><p id="ff44" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">一旦我们的处理函数运行，我们<a class="ae md" href="https://github.com/vincentclaes/serverless_data_pipeline_example/blob/master/serverless_data_pipeline_tests/lambda_function/test_extract.py#L116" rel="noopener ugc nofollow" target="_blank"> <em class="oe">断言</em> </a>预期的结果已经出现。我们通过获取 lambda 处理程序返回的 s3 键并检查被模仿的 s3 桶是否包含预期的 JSON 对象来做到这一点。</p><p id="6c99" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们从 s3 中读取对象，并断言 JSON 对象等于我们期望的对象。不要开始写自己的断言函数，unittest 有一堆高级断言方法，可以在<a class="ae md" href="https://docs.python.org/2/library/unittest.html#assert-methods" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我们使用函数</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="ad3c" class="ni mf it ne b gy nj nk l nl nm">self.assertDictEqual(json.loads(email_as_json), expected_json)</span></pre><p id="b7ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">比较字典是否相等。</p><h1 id="a079" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">运行测试</h1><p id="c5e3" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">要自己运行上面的示例，从克隆原始项目并安装依赖项开始:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="57e5" class="ni mf it ne b gy nj nk l nl nm">git clone <a class="ae md" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:vincentclaes/serverless_data_pipeline_example.git</span><span id="fc41" class="ni mf it ne b gy oi nk l nl nm">cd serverless_data_pipeline_example<br/>pipenv install<br/>pipenv shell</span></pre><p id="cf03" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要执行项目中的所有测试，请运行:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="72c5" class="ni mf it ne b gy nj nk l nl nm">python -m unittest</span></pre><p id="3a9d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它将运行测试用例的所有测试功能。测试应该通过，您应该看到输出“OK”。</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="5ef9" class="ni mf it ne b gy nj nk l nl nm">bash-3.2$  . /Users/vincent/.local/share/virtualenvs/serverless_data_pipeline-27feO5HC/bin/activate<br/>(serverless_data_pipeline) bash-3.2$ python -m unittest serverless_data_pipeline_tests/lambda_function/test_extract.py<br/>email object {'id': 'test_extract_the_contents_of_an_email_successfully.eml', 'from': '<a class="ae md" href="mailto:vclaes1986@gmail.com" rel="noopener ugc nofollow" target="_blank">vclaes1986@gmail.com</a>', 'to': '<a class="ae md" href="mailto:vincent.v.claes@gmail.com" rel="noopener ugc nofollow" target="_blank">vincent.v.claes@gmail.com</a>', 'cc': '', 'subject': 'Hey how are you doing', 'date': '2019-07-09 13:42:54+02:00', 'body': '\nCash Me Outside How Bout Dah'}<br/>.<br/>----------------------------------------------------------------------<br/>Ran 1 test in 0.185s</span><span id="cf9f" class="ni mf it ne b gy oi nk l nl nm">OK</span></pre><p id="7773" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要运行一个单独的测试用例，您可以运行:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="d60c" class="ni mf it ne b gy nj nk l nl nm">python -m unittest serverless_data_pipeline_tests.lambda_function.test_extract.TestExtract</span></pre><p id="9ca9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要运行单个测试函数，您可以运行:</p><pre class="lo lp lq lr gt nd ne nf ng aw nh bi"><span id="c89e" class="ni mf it ne b gy nj nk l nl nm">python -m unittest serverless_data_pipeline_tests.lambda_function.test_extract.TestExtract.test_extract_the_contents_of_an_email_successfully</span></pre><p id="0276" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您的所有测试都通过了，您就可以放心地将项目部署到 AWS 了。</p><p id="ce3d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">祝你好运！</p></div></div>    
</body>
</html>