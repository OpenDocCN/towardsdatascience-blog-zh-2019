<html>
<head>
<title>Building Web App For Canada-US Border Crossing Wait Time Forecast</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为加拿大-美国边境过境等待时间预测构建 Web 应用程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-web-app-for-canada-us-border-crossing-wait-time-forecast-18602373c79d?source=collection_archive---------42-----------------------#2019-11-25">https://towardsdatascience.com/building-web-app-for-canada-us-border-crossing-wait-time-forecast-18602373c79d?source=collection_archive---------42-----------------------#2019-11-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="177b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">黑色星期五即将来临。许多加拿大购物者将开车南下，加入购物狂欢。如果你计划在 11 月 29 日跨境旅行，你会想聪明地计划，以避免在边境长时间延误。为了解决这个问题，我们建立了一个网络应用程序，预测未来 7 天的过境等待时间。</p><p id="7276" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是该项目的工作流程:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ae2e14091c282d70592afa5fb86302c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9wYxkFtFyanZvU3FajmWFQ.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Image by <a class="ae lb" href="https://unsplash.com/@timester12" rel="noopener ugc nofollow" target="_blank">Imre Tömösvári</a> on <a class="ae lb" href="https://unsplash.com/license" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><ol class=""><li id="9d6d" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">从<a class="ae lb" href="http://www.cascadegatewaydata.com/Api" rel="noopener ugc nofollow" target="_blank">级联网关 API </a>中检索过境等待时间</li><li id="a218" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">使用 Python + <a class="ae lb" href="https://xgboost.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> XGBoost </a>建立未来穿越的预测模型</li><li id="fd55" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">使用 Flask，HTML，CSS，ajax 开发 web 应用程序 REST API</li><li id="447c" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">在 AWS 上部署 web 应用程序</li><li id="4036" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">每天刷新数据并重新构建预测模型</li></ol><p id="2a0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【链接到网页 app<a class="ae lb" href="http://35.164.32.109:5000/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">http://35.164.32.109:5000/</strong></a></p><p id="7229" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它没有永久地址，因为它是一个低成本的 AWS 实例。目前的预报只适用于未来 7 天和平拱门路口(不列颠哥伦比亚省和华盛顿州之间)的南行交通。</p><p id="a6cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的一点是:通过边界的车流量可以用来预测，而不是等待时间。交通量应更加可预测，因为它不会因边境管制的变化而频繁变化，例如更严格的安全检查、开放的车道/岗哨数量以及有时的现场施工。然而，从通勤者的角度来看，他/她更感兴趣的是知道时间延误，而不是通过边界的车辆总数。</p><h1 id="95f0" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">数据采集</h1><p id="40b7" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">从<a class="ae lb" href="http://www.cascadegatewaydata.com/Api" rel="noopener ugc nofollow" target="_blank">级联网关</a>数据仓库中检索过境等待时间数据。它有一个很好的 API 参考文档，使用起来非常简单。</p><p id="3333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们提取了自 2014 年 1 月 1 日以来 Peach Arch (BC-Washington)南行车辆的每小时交叉等待时间。以下是一些记录示例:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="50cf" class="my lr iq mu b gy mz na l nb nc">Group Starts,Avg - Delay (Peace Arch)<br/>2018-01-01 07:00:00,0.3<br/>2018-01-01 08:00:00,1.6<br/>2018-01-01 09:00:00,1.3<br/>2018-01-01 10:00:00,18.8<br/>2018-01-01 11:00:00,37.8<br/>2018-01-01 12:00:00,41.4<br/>2018-01-01 13:00:00,49.1</span></pre><p id="9989" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一天前的过境等待时间记录被添加到我们每天的模型训练中。</p><h1 id="74ea" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">模特培训</h1><p id="f89d" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">从过境日期和时间中，我们提取年、月、月中的日、周中的日和小时作为训练特征。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="fd58" class="my lr iq mu b gy mz na l nb nc">data['HourOfDay'] = data['Date_time'].dt.hour        <br/>data['Year'] = data['Date_time'].dt.year<br/>data['Month'] = data['Date_time'].dt.month<br/>data['DayOfMonth'] = data['Date_time'].dt.day <br/>data['DayOfWeek'] = data['Date_time'].dt.dayofweek</span></pre><p id="d99f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不列颠哥伦比亚省和西澳大利亚州的假日也是新增的特色。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="be65" class="my lr iq mu b gy mz na l nb nc"># Get Canadian - BC holidays<br/>ca_holidays = holidays.CountryHoliday('CA', prov='BC', state=None)<br/># Check each date what Canadian holiday it is<br/>data['Holiday_CA'] = [ca_holidays.get(x) for x in data['Date_time']]<br/># Treat Observed holiday same as regular<br/>data['Holiday_CA'] = pd.Series(data['Holiday_CA']).str.replace(" \(Observed\)", "")<br/># Convert holiday columns<br/>data = pd.get_dummies(data, columns=['Holiday_CA'])<br/># Get US - WA holidays<br/>us_holidays = holidays.CountryHoliday('US', prov=None, state='WA')<br/>data['Holiday_US'] = [us_holidays.get(x) for x in data['Date_time']]<br/>data['Holiday_US'] = pd.Series(data['Holiday_US']).str.replace(" \(Observed\)", "")<br/>data = pd.get_dummies(data, columns=['Holiday_US'])</span></pre><p id="7cb7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用<a class="ae lb" href="https://xgboost.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> XGBoost </a>算法训练我们的模型，并使用 RMSE(均方根误差)评估其性能。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="7083" class="my lr iq mu b gy mz na l nb nc">n_iter = 48<br/>tscv = TimeSeriesSplit(n_splits=4)<br/>xgb_regressor = xgb.XGBRegressor(random_state=29, n_jobs=-1)<br/>xgb_grid_search = RandomizedSearchCV(xgb_regressor, <br/>         xgb_parameters, <br/>         n_iter = n_iter, <br/>         cv=tscv,<br/>         scoring = 'neg_mean_squared_error',<br/>         verbose=1,                                  <br/>         n_jobs=-1,                                  <br/>         random_state= 50)</span></pre><p id="89e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以定义 XGBoost 超参数范围的网格，并从网格中随机采样。产生最佳结果的参数组被选为最终模型。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="6793" class="my lr iq mu b gy mz na l nb nc">xgb_parameters = {'objective': ['reg:squarederror'],<br/>      'n_estimators': [80, 100, 120],<br/>      'learning_rate': [0.01, 0.1, 0.5],<br/>      'gamma': [0, 0.01, 0.1],<br/>      'reg_lambda': [0.5, 1],<br/>      'max_depth': [3, 5, 10], <br/>      'subsample': [0.5, 1.0], <br/>      'colsample_bytree': [0.5, 0.7, 1], <br/>      'seed':[0]<br/>      }</span></pre><p id="f052" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">数据集中最后 7 天的等待时间记录用于验证。这是一个将实际过境延误与我们对 2018 年 8 月 25 日至 8 月 31 日的预测进行比较的例子。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/4dd91d69a82e77ca041db3d3270dd10e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s4HLZg9RXIO3w2r-.png"/></div></div></figure><p id="ef8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们可以保存我们的模型，并为生成未来 7 天的预测做好准备。</p><h1 id="e907" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">Flask Web 应用程序</h1><p id="e0ea" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">现在，我们已经完成了预测模型的构建，并准备通过 web 应用程序来展示它。Flask 是一个微型 web 框架，在用 Python 构建 web 应用程序时很流行。它是轻量级的，因为它不需要特定的库来启动。它旨在使入门变得快速简单，并能够扩展到复杂的任务。</p><h1 id="9824" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">AWS 设置</h1><p id="b89d" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">有很多关于如何设置 AWS EC2 实例的资源，例如<a class="ae lb" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html" rel="noopener ugc nofollow" target="_blank"> AWS 用户指南</a>、<a class="ae lb" href="https://course.fast.ai/start_aws.html" rel="noopener ugc nofollow" target="_blank"> fast.ai 参考</a>等。我们使用 Linux 2 AMI t2.micro，它有 1 个 CPU 和 1GB 内存，因为它很便宜。只需记住在安全组中配置 HTTP、SSH 和端口 5000(用于我们的 web 应用程序访问)。</p><h1 id="0785" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">环境设置和软件包安装</h1><p id="bef5" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">设置好 AWS EC2 实例后，克隆我们的 GitHub 项目</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="24b6" class="my lr iq mu b gy mz na l nb nc">git <strong class="mu ir">clone</strong> <a class="ae lb" href="https://github.com/wangpengcn/border-crossing-delay-forecast-web-app-flask.git" rel="noopener ugc nofollow" target="_blank">https:<em class="ne">//github.com/wangpengcn/border-crossing-delay-forecast-web-app-flask.git</em></a><em class="ne"> border_forecast</em></span></pre><p id="f333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，运行脚本来安装 python，创建虚拟环境，安装必要的包，并安排每日模型重建</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="cea8" class="my lr iq mu b gy mz na l nb nc">./install.sh</span></pre><p id="a122" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看这个脚本做了什么。</p><p id="ab93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定义一些环境变量。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="8bbd" class="my lr iq mu b gy mz na l nb nc">FOLDER_PATH=”/home/ec2-user/border_forecast/”<br/>FOLDER_NAME=”border_forecast”<br/>VENV_NAME=”venv_border_forecast”</span></pre><p id="f118" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行 yum 安装更新并安装 Python 3.6。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="3658" class="my lr iq mu b gy mz na l nb nc">sudo yum update<br/>sudo yum install python36-pip</span></pre><p id="9c8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，如果不确定可以安装什么 Python 包，运行<code class="fe nf ng nh mu b">sudo yum list | grep python3</code>进行检查。</p><p id="fbae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，安装并创建虚拟环境，它有自己的站点目录，并与系统站点目录隔离。它使得项目部署更加容易，并且独立于其他正在进行的 Python 项目。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="9fc9" class="my lr iq mu b gy mz na l nb nc">pip3 install — user virtualenv<br/>python3 -m venv $VENV_NAME</span></pre><p id="c0e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">激活我们的虚拟环境。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="76df" class="my lr iq mu b gy mz na l nb nc">source $VENV_NAME/bin/activate</span></pre><p id="d4f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，安装所需的 Python 包</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="6a46" class="my lr iq mu b gy mz na l nb nc">$VENV_NAME/bin/pip3 install -r requirements.txt</span></pre><p id="e31b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！您的 Python 环境非常适合。</p><p id="fd22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该脚本的最后一行是安排一个每日作业来重建预测模型并生成未来 7 天的预测。</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="6582" class="my lr iq mu b gy mz na l nb nc">(crontab -l 2&gt;/dev/<strong class="mu ir">null</strong>; echo “0 5 * * * cd $FOLDER_PATH &amp;amp;&amp;amp; $VENV_NAME/bin/python3 border_wait_time_forecast.py &gt; /tmp/border.log”) | crontab -</span></pre><p id="8caf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">咖啡时间到了！让脚本运行几分钟，我们就可以启动我们的 web 应用程序了。</p><h1 id="446c" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">运行 Web 应用程序</h1><p id="fe2e" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">运行<code class="fe nf ng nh mu b">./run_app.sh</code>启动 web 应用程序。它将运行并显示一条警告消息“<em class="ne">这是一个开发服务器</em>”。这是因为我们运行在 Flask 开发服务器上。它应该被生产中的 WSGI 服务器所取代。</p><p id="8a24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Web app 现在运行在<a class="ae lb" href="http://0.0.0.0:5000" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:5000 </a>上访问时，用您的 AWS IPv4 公共 IP 替换 0.0.0.0，例如<a class="ae lb" href="http://35.164.32.109:5000/" rel="noopener ugc nofollow" target="_blank">http://35.164.32.109:5000/</a></p><p id="f841" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">搞定了。您的 web 应用程序现已上线！</p><h1 id="7306" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">未来作品</h1><ul class=""><li id="5a2e" class="lc ld iq jp b jq mo ju mp jy ni kc nj kg nk kk nl li lj lk bi translated">扩大对其他边境口岸的预测</li><li id="ed2b" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk nl li lj lk bi translated">允许用户报告实际过境时间，并纳入模型</li></ul><p id="a84d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Python 代码可以在我的<a class="ae lb" href="https://github.com/wangpengcn/border-crossing-delay-forecast-web-app-flask" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><p id="c26f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感恩节快乐！机器学习快乐！</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="71ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ne">如果你喜欢这篇文章或者有任何问题，欢迎留下评论。帮我接通</em> <a class="ae lb" href="https://www.linkedin.com/in/peng-wang-cpa/" rel="noopener ugc nofollow" target="_blank"> <em class="ne"> LinkedIn </em> </a> <em class="ne">。</em></p></div></div>    
</body>
</html>