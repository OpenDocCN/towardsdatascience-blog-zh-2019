<html>
<head>
<title>Create Trending Animated Bar Charts using R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 R 创建趋势动画条形图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/create-animated-bar-charts-using-r-31d09e5841da?source=collection_archive---------3-----------------------#2019-04-05">https://towardsdatascience.com/create-animated-bar-charts-using-r-31d09e5841da?source=collection_archive---------3-----------------------#2019-04-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4da720a45d0754c82e7a544671d075cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uhU09i05wLx3sztM2mtT0g.gif"/></div></div></figure><p id="a258" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最近，动画柱状图开始在社交媒体上疯传，让许多数据爱好者想知道这些动画柱状图是如何制作的。这篇文章的目的是解释如何使用 R-R 和多用途的软件包来构建这样一个动画条形图。</p><h1 id="c276" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><a class="ae lu" href="https://datacamp.pxf.io/c/2888696/1240322/13294?u=https%3A%2F%2Fpromo.datacamp.com" rel="noopener ugc nofollow" target="_blank">享受 78%的 DataCamp 折扣</a></h1><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/0421ee0146365a53f921bac019c2453a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*07xcVJgssX7RiLQo.png"/></div></div></figure><h1 id="a977" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">包装</h1><p id="89e9" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">在 R 中构建动画情节所需的包有:</p><ul class=""><li id="2d95" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">ggplot2</li><li id="5c44" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated"><a class="ae lu" href="https://gganimate.com/index.html" rel="noopener ugc nofollow" target="_blank"> gganimate </a></li></ul><p id="1894" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然以上两个是基本的软件包，但我们也在这个项目中使用了整个<code class="fe mt mu mv mw b">tidyverse</code>、<code class="fe mt mu mv mw b">janitor</code>和<code class="fe mt mu mv mw b">scales</code>来进行数据操作、清理和格式化。</p><h1 id="c33a" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">数据</h1><p id="7e47" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">用于本项目的原始数据集是从<a class="ae lu" href="https://databank.worldbank.org/data/reports.aspx?source=2&amp;series=NY.GDP.MKTP.CD&amp;country=#" rel="noopener ugc nofollow" target="_blank">世界银行数据</a>下载的。相同的 csv 文件可以在<a class="ae lu" href="https://github.com/amrrs/animated_bar_charts_in_R" rel="noopener ugc nofollow" target="_blank">项目文件夹</a>中找到。</p><h1 id="c7ee" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">关于数据:</h1><p id="b530" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">这个数据包含了大部分国家几年(尤其是 2000 年到 2017 年)的 GDP 值。</p><h1 id="9b07" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">数据预处理:</h1><p id="5e76" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">我们将使用下面的代码以期望的格式准备我们的数据。实际上，我们正在清理列名，将数字转换成数字格式，并使用 tidyr 的<code class="fe mt mu mv mw b">gather()</code>函数将数据从宽格式转换成长格式。整理后的数据保存到一个新的 csv 文件<code class="fe mt mu mv mw b">gdp_tidy.csv</code>中，以备后用。</p><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="05b6" class="nb kx iq mw b gy nc nd l ne nf">library(tidyverse)<br/>library(janitor)</span><span id="6b10" class="nb kx iq mw b gy ng nd l ne nf">gdp &lt;- read_csv("./data/GDP_Data.csv")</span><span id="9a12" class="nb kx iq mw b gy ng nd l ne nf">#select required columns</span><span id="ac5d" class="nb kx iq mw b gy ng nd l ne nf">gdp &lt;- gdp %&gt;% select(3:15) </span><span id="bfa5" class="nb kx iq mw b gy ng nd l ne nf">#filter only country rows</span><span id="ab71" class="nb kx iq mw b gy ng nd l ne nf">gdp &lt;- gdp[1:217,]</span><span id="929f" class="nb kx iq mw b gy ng nd l ne nf">gdp_tidy &lt;- gdp %&gt;% <br/>  mutate_at(vars(contains("YR")),as.numeric) %&gt;% <br/>  gather(year,value,3:13) %&gt;% <br/>  janitor::clean_names() %&gt;% <br/>  mutate(year = as.numeric(stringr::str_sub(year,1,4)))</span><span id="73ad" class="nb kx iq mw b gy ng nd l ne nf">write_csv(gdp_tidy,"./data/gdp_tidy.csv")</span></pre><h1 id="a137" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">动画情节</h1><p id="7c96" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">动画情节构建过程包括两个主要部分:</p><ul class=""><li id="f103" class="mf mg iq ka b kb kc kf kg kj mh kn mi kr mj kv mk ml mm mn bi translated">使用 ggplot2 构建整套实际静态图</li><li id="5b4d" class="mf mg iq ka b kb mo kf mp kj mq kn mr kr ms kv mk ml mm mn bi translated">使用 gganimate 以所需参数激活静态图</li></ul><p id="dae2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这两个主要步骤之后的最后一步是以所需的文件格式渲染动画，如 GIF 或 MP4(视频)。</p><h1 id="e8e9" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">加载所需的库</h1><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="6a03" class="nb kx iq mw b gy nc nd l ne nf">library(tidyverse)<br/>library(gganimate)</span></pre><h1 id="ed05" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">数据处理:</h1><p id="d291" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">在这一步中，我们将过滤数据集，仅保留给定年份的前 10 个国家。我们还将创建几个列来帮助我们在绘图中显示标签。</p><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="6a1e" class="nb kx iq mw b gy nc nd l ne nf">gdp_tidy &lt;- read_csv("./data/gdp_tidy.csv")<br/></span><span id="d15b" class="nb kx iq mw b gy ng nd l ne nf">gdp_formatted &lt;- gdp_tidy %&gt;%<br/>  group_by(year) %&gt;%<br/>  # The * 1 makes it possible to have non-integer ranks while sliding<br/>  mutate(rank = rank(-value),<br/>         Value_rel = value/value[rank==1],<br/>         Value_lbl = paste0(" ",round(value/1e9))) %&gt;%<br/>  group_by(country_name) %&gt;% <br/>  filter(rank &lt;=10) %&gt;%<br/>  ungroup()</span></pre><h1 id="d3a0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">构建静态图</h1><p id="5bfb" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">现在我们的数据已经准备好绘制了，我们将构建所有需要的静态图。正如你可能已经在这篇文章顶部的动画中看到的，我们将看到在给定的数据集中，GDP 排名前 10 位的国家在过去几年中是如何变化的。为此，我们需要为每一年建造单独的地块。</p><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="ea0e" class="nb kx iq mw b gy nc nd l ne nf">staticplot = ggplot(gdp_formatted, aes(rank, group = country_name, <br/>                fill = as.factor(country_name), color = as.factor(country_name))) +<br/>  geom_tile(aes(y = value/2,<br/>                height = value,<br/>                width = 0.9), alpha = 0.8, color = NA) +<br/>  geom_text(aes(y = 0, label = paste(country_name, " ")), vjust = 0.2, hjust = 1) +<br/>  geom_text(aes(y=value,label = Value_lbl, hjust=0)) +<br/>  coord_flip(clip = "off", expand = FALSE) +<br/>  scale_y_continuous(labels = scales::comma) +<br/>  scale_x_reverse() +<br/>  guides(color = FALSE, fill = FALSE) +<br/>  theme(axis.line=element_blank(),<br/>        axis.text.x=element_blank(),<br/>        axis.text.y=element_blank(),<br/>        axis.ticks=element_blank(),<br/>        axis.title.x=element_blank(),<br/>         axis.title.y=element_blank(),<br/>        legend.position="none",<br/>        panel.background=element_blank(),<br/>        panel.border=element_blank(),<br/>        panel.grid.major=element_blank(),<br/>        panel.grid.minor=element_blank(),<br/>        panel.grid.major.x = element_line( size=.1, color="grey" ),<br/>        panel.grid.minor.x = element_line( size=.1, color="grey" ),<br/>        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),<br/>        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),<br/>        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),<br/>        plot.background=element_blank(),<br/>       plot.margin = margin(2,2, 2, 4, "cm"))</span></pre><p id="b6d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们不会详细讨论如何构建静态图，因为这与使用<code class="fe mt mu mv mw b">ggplot2</code>构建普通图非常相似。正如你在上面的代码中看到的,<code class="fe mt mu mv mw b">theme()</code>函数有几个关键方面是为了让它与动画配合得更好，比如——只画了垂直的网格线，图例、轴标题和其他一些组件都从图中删除了。</p><h1 id="81f8" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">动画</h1><p id="c810" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">这里的关键功能是<code class="fe mt mu mv mw b">transition_states()</code>，它在<em class="nh">年</em>前将各个静态图缝合在一起。<code class="fe mt mu mv mw b">view_follow()</code>用于提供背景线(网格线)随着动画的进行而移动的视图。</p><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="9aaf" class="nb kx iq mw b gy nc nd l ne nf">anim = staticplot + transition_states(year, transition_length = 4, state_length = 1) +<br/>  view_follow(fixed_x = TRUE)  +<br/>  labs(title = 'GDP per Year : {closest_state}',  <br/>       subtitle  =  "Top 10 Countries",<br/>       caption  = "GDP in Billions USD | Data Source: World Bank Data")</span></pre><h1 id="58c1" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">翻译</h1><p id="0c8e" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">随着动画被构建(准备好)并保存在对象<code class="fe mt mu mv mw b">anim</code>中，是时候我们使用<code class="fe mt mu mv mw b">animate()</code>函数渲染动画了。<code class="fe mt mu mv mw b"> animate()</code>中使用的渲染器因所需输出文件的类型而异。</p><p id="5acb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">对于 GIF 文件格式:</strong></p><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="f126" class="nb kx iq mw b gy nc nd l ne nf"># For GIF</span><span id="57d4" class="nb kx iq mw b gy ng nd l ne nf">animate(anim, 200, fps = 20,  width = 1200, height = 1000, <br/>        renderer = gifski_renderer("gganim.gif"))</span></pre><p id="110f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">对于视频(MP4)文件格式:</strong></p><pre class="lw lx ly lz gt mx mw my mz aw na bi"><span id="905c" class="nb kx iq mw b gy nc nd l ne nf"># For MP4</span><span id="000f" class="nb kx iq mw b gy ng nd l ne nf">animate(anim, 200, fps = 20,  width = 1200, height = 1000, <br/>        renderer = ffmpeg_renderer()) -&gt; for_mp4</span><span id="7a45" class="nb kx iq mw b gy ng nd l ne nf">anim_save("animation.mp4", animation = for_mp4 )</span></pre><h1 id="5352" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">最终输出:</h1><p id="0e4d" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">该项目的 GIF 输出:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4da720a45d0754c82e7a544671d075cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uhU09i05wLx3sztM2mtT0g.gif"/></div></div></figure><h1 id="b131" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">总结:</h1><p id="7d47" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">因此，我们已经成功地构建了动画条形图，根据 GDP 值来可视化排名靠前的国家在几年内的变化情况。一旦数据预处理和数据操作步骤将输入数据重新整形为所需的格式，就可以很容易地根据您的目的修改这些代码。r 是任何形式的数据可视化的神奇工具，要了解更多<a class="ae lu" href="https://www.datacamp.com/courses/forecasting-in-r?irclickid=V0FwRdyHGxyIW7HRYNWRwwwzUkG3P3TqCXti2k0&amp;irgwc=1&amp;utm_medium=affiliate&amp;utm_source=impact&amp;utm_campaign=2888696" rel="noopener ugc nofollow" target="_blank">请查看这个</a>。这个完整的项目可以在<a class="ae lu" href="https://github.com/amrrs/animated_bar_charts_in_R" rel="noopener ugc nofollow" target="_blank"> my github </a>上获得，你可以随意地使用它。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h2 id="4c46" class="nb kx iq bd ky np nq dn lc nr ns dp lg kj nt nu lk kn nv nw lo kr nx ny ls nz bi translated"><a class="ae lu" href="https://nulldata.substack.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">免费注册接收我的数据科学简讯— AI </strong> </a></h2></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="4c7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="nh">免责声明:</em> </strong> <em class="nh">此处使用的代码是从本栈溢出问题</em> <a class="ae lu" href="https://stackoverflow.com/questions/53162821/animated-sorted-bar-chart-with-bars-overtaking-each-other" rel="noopener ugc nofollow" target="_blank"> <em class="nh">动画排序条形图各条互相超越</em> </a>的答案中长时间借用(可以说是启发、复制)</p></div></div>    
</body>
</html>