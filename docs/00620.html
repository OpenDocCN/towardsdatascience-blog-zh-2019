<html>
<head>
<title>Fast, static D3 maps built with Turf.js and the command-line</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Turf.js 和命令行构建的快速静态 D3 地图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/fast-static-d3-maps-built-with-turf-js-and-the-command-line-5b7c72b7e775?source=collection_archive---------19-----------------------#2019-01-28">https://towardsdatascience.com/fast-static-d3-maps-built-with-turf-js-and-the-command-line-5b7c72b7e775?source=collection_archive---------19-----------------------#2019-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7e09" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将 Mike Bostock 的命令行制图教程与 Node.js 的灵活性结合起来</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e27816d399b42ae690b9730ff4361bd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dvzO6qCovd__hZfv4yEs1g.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Estimated percent of undocumented residents in U.S. metro areas. Source: <a class="ae kv" href="http://www.pewhispanic.org/2017/02/13/estimates-of-unauthorized-immigrant-population-by-metro-area-2014/" rel="noopener ugc nofollow" target="_blank">Pew Research Center</a></figcaption></figure><p id="8bf6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近，我需要制作一些美国各州的泡沫地图，嵌入到《圣安东尼奥快报新闻》的<a class="ae kv" href="https://www.expressnews.com/news/local/politics/article/Immigrant-who-won-a-labor-case-for-back-pay-hides-13303195.php?t=c8def45e81" rel="noopener ugc nofollow" target="_blank">报道中。我想使用 D3，但担心缓慢的资产加载和地图渲染，特别是因为 CMS 的限制，我需要单独<code class="fe ls lt lu lv b">iframe</code>每个地图。</a></p><p id="9e1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了找到导出 D3 生成的 SVG 的方法，我进行了一些谷歌搜索。</p><p id="b41e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="http://bl.ocks.org/Rokotyan/0556f8facbaf344507cdc45dc3622177" rel="noopener ugc nofollow" target="_blank">这家伙做了个出口按钮</a>，挺酷的。<em class="lw">纽约时报</em>有<a class="ae kv" href="https://nytimes.github.io/svg-crowbar/" rel="noopener ugc nofollow" target="_blank"> SVG Crowbar </a>，提供类似的功能。然而，我发现的最令人兴奋的结果是这篇由四部分组成的文章，Mike Bostock 的<a class="ae kv" href="https://medium.com/@mbostock/command-line-cartography-part-1-897aa8f8ca2c" rel="noopener"><em class="lw"/></a><em class="lw"/>。</p><p id="3497" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我强烈推荐 Bostock 的文章，本教程的大部分内容都来源于此。我对他的方法的唯一问题是，对我来说，在命令行上编写 d3 代码会变得复杂和混乱。这里有一个片段:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="f33c" class="mb mc iq lv b gy md me l mf mg">(topo2geo tracts=- \<br/>    &lt; ca-topo.json \<br/>    | ndjson-map -r d3 -r d3=d3-scale-chromatic 'z = d3.scaleThreshold().domain([1, 10, 50, 200, 500, 1000, 2000, 4000]).range(d3.schemeOrRd[9]), d.features.forEach(f =&gt; f.properties.fill = z(f.properties.density)), d' \<br/>    | ndjson-split 'd.features'; \<br/>topo2geo counties=- \<br/>    &lt; ca-topo.json \<br/>    | ndjson-map 'd.properties = {"stroke": "#000", "stroke-opacity": 0.3}, d')\<br/>  | geo2svg -n --stroke none -p 1 -w 960 -h 960 \<br/>  &gt; ca.svg</span></pre><p id="4be2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想找到一个利用 Node.js 的解决方案，允许我仍然从命令行使用 Bostock 的<a class="ae kv" href="https://github.com/d3/d3-geo-projection/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> d3-geo-projection </a>，但是将大部分制图操作和地图渲染的处理交给 JavaScript。这就是 Turf.js 的用武之地——一个用于编写和操作 GeoJSON 的令人惊叹的开源地理空间分析工具。</p><p id="ee1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本教程一步一步地介绍如何使用 node 和命令行生成静态地图。我们将以 SVG 格式构建上述地图，该地图显示了美国 100 个最大的大都市区中无证居民比例最高的 50 个大都市区。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="6ea6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步:加载你的数据</p><p id="a141" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">地图需要的文件有:</p><ol class=""><li id="ea42" class="mo mp iq ky b kz la lc ld lf mq lj mr ln ms lr mt mu mv mw bi translated">2017 年皮尤研究中心研究的未记录居民数据。</li><li id="8331" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">定义美国城市区域位置的 shapefile。</li><li id="25e4" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">定义美国各州轮廓的 shapefile。</li></ol><p id="6013" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">启动命令行并创建一个工作目录:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="76c3" class="mb mc iq lv b gy md me l mf mg">mkdir undocumented-residents-map<br/>cd undocumented-residents-map</span></pre><p id="b5e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个 bash 文件，我们将使用它作为我们的主要构建脚本:</p><p id="2202" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">touch buildmap.sh</code></p><p id="df0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">原始皮尤数据在处<a class="ae kv" href="http://www.pewhispanic.org/2017/02/13/estimates-of-unauthorized-immigrant-population-by-metro-area-2014/" rel="noopener ugc nofollow" target="_blank">可用。我将其简化为两列，并将其存储在 data.world </a>上<a class="ae kv" href="https://data.world/lukewhyte/estimated-percent-of-undocumented-residents-in-us-metro-ar" rel="noopener ugc nofollow" target="_blank">。shapefiles 由</a><a class="ae kv" href="https://www.census.gov/geo/maps-data/data/tiger-cart-boundary.html" rel="noopener ugc nofollow" target="_blank">人口普查局</a>提供。我们可以通过浏览器下载所有这些文件，但以编程方式进行更有趣。</p><p id="a534" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在您最喜欢的文本编辑器中打开<code class="fe ls lt lu lv b">buildmap.sh</code>,写下如下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="8467" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面有条件地下载并解压所有三个文件到我们的项目文件夹的根目录。</p><p id="e692" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们有了我们的资产，我们可以开始构建我们的地图。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="749e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步:将 Shapefiles 转换为 GeoJSON </strong></p><p id="b076" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用 NPM 包来实现这一点，所以现在是设置<code class="fe ls lt lu lv b">package.json</code>的好时机。</p><p id="ba1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe ls lt lu lv b">npm init</code>并按照提示生成 JSON。接下来，您需要将以下内容添加到生成的<code class="fe ls lt lu lv b">package.json</code>中:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="8b20" class="mb mc iq lv b gy md me l mf mg">"scripts": { "buildmap": "sh buildmap.sh" }</span></pre><p id="ee1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将允许我们在当前 NPM 一揽子计划的背景下管理<code class="fe ls lt lu lv b">buildmap.sh</code>。</p><p id="afc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装 Mike Bostock 的流 shapefile 解析器(<code class="fe ls lt lu lv b">npm i shapefile -D)</code>，并在<code class="fe ls lt lu lv b">buildmap.sh</code>的底部添加以下代码行，将我们的 shape file 转换为 GeoJSON:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="01b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这两个 GeoJSON 文件用于以下目的:</p><ul class=""><li id="7bf5" class="mo mp iq ky b kz la lc ld lf mq lj mr ln ms lr ne mu mv mw bi translated"><code class="fe ls lt lu lv b">metroareas.geojson</code>:我们将使用地理数据将未记录的常驻 CSV 数据绑定到地图上。</li><li id="da7c" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr ne mu mv mw bi translated"><code class="fe ls lt lu lv b">states.geojson</code>:我们将用来绘制地图背景的美国州轮廓。</li></ul><p id="c8c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终，这两个文件将与 CSV 文件合并成一个主 GeoJSON 文件，我们将把它转换成 SVG。但是首先…</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="b39e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步:将位置数据添加到我们未记录的居民数据点</strong></p><p id="a69f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这一步中，我们将使用 Node 将 CSV 中的数据(美国大都市区未登记居民的百分比)转换为 GeoJSON 文件中以各自大都市区为中心的缩放圆。</p><p id="3567" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你是 GeoJSON 新手，我推荐你从维基百科页面开始。</p><p id="4712" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们输出的 GeoJSON 将包括 CSV 中每个大都市区域的单个要素-一个点。这些特征的坐标将从<code class="fe ls lt lu lv b">metroarea.geojson</code>中获得，每个点的“属性”对象将包括一个<code class="fe ls lt lu lv b">pointRadius</code>属性，用于相对于在该城市区域中发现的无证居民的相应百分比来缩放点的大小。</p><p id="d318" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是我们将在 JS 文件中采取的步骤的概述:</p><ol class=""><li id="0909" class="mo mp iq ky b kz la lc ld lf mq lj mr ln ms lr mt mu mv mw bi translated">将<code class="fe ls lt lu lv b">metroareas.geojson</code>和<code class="fe ls lt lu lv b">metro-area-percent-undocumented.csv</code>转换为 JS 对象</li><li id="642f" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">过滤<code class="fe ls lt lu lv b">metroareas.geojson</code>,只包括我们的 CSV 中也存在的城市区域</li><li id="9c5b" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">使用 Turf.js 找到每个都会区多边形的中心，并将我们的点固定到中心的坐标上。</li><li id="d989" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">在每个特性的“properties”对象中为我们的点添加样式(颜色等),包括我们的<code class="fe ls lt lu lv b">pointRadius</code>属性，它是使用 d3 缩放的。</li><li id="3f65" class="mo mp iq ky b kz mx lc my lf mz lj na ln nb lr mt mu mv mw bi translated">将要素集导出为新的 GeoJSON 文件。</li></ol><p id="1f34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，创建文件:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="e467" class="mb mc iq lv b gy md me l mf mg">touch mapMetroPathsToCircles.js</span></pre><p id="ad5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开<code class="fe ls lt lu lv b">mapMetroPathsToCircles.js</code>并编写以下代码，完成上述 5 个步骤，并在注释中详细说明每个步骤:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="80f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在将它添加到 bash 文件之前，我们需要安装所需的依赖项:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="27bb" class="mb mc iq lv b gy md me l mf mg">npm i @turf/turf d3 csv-parse@3.1.3 -D</span></pre><p id="13ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，在<code class="fe ls lt lu lv b">buildmap.sh</code>中我们可以添加:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="49fb" class="mb mc iq lv b gy md me l mf mg">node mapMetroPathsToCircles.js # Create circles.geojson</span></pre></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="bb87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第四步:将州轮廓添加到我们的城市区域 GeoJSON 中</strong></p><p id="40c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们有了圆形的地理图，但是没有背景图。因此，我们将合并到美国的州大纲中。</p><p id="beb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在命令行上:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="4ad6" class="mb mc iq lv b gy md me l mf mg">touch mapAndMergeStates.js</span></pre><p id="e6d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用以下内容填充文件(注释中的详细信息):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="33f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后把这个加到<code class="fe ls lt lu lv b">buildmap.sh</code>:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="f779" class="mb mc iq lv b gy md me l mf mg">node mapAndMergeStates.js # merge in states, output topo.geojson</span></pre></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="9539" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">步骤五:</strong> <strong class="ky ir">将 GeoJSON 转换为 SVG </strong></p><p id="f2a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在有了主 GeoJSON 文件(<code class="fe ls lt lu lv b">topo.geojson</code>)，可以将其转换为 SVG。</p><p id="9ff4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，我们应该首先对我们的数据应用地理投影，这样 SVG 就可以按比例生成。为此，我们将使用 Bostock 的<a class="ae kv" href="https://github.com/d3/d3-geo-projection/blob/master/README.md#geoproject" rel="noopener ugc nofollow" target="_blank">地质项目</a>。</p><p id="28b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还希望分割 GeoJSON，以便每个要素都在一行上。因此，当我们将 GeoJSON 转换为 SVG 时，每个要素将在 XML 中占据一个新行。当我们在本教程末尾使用命令行拼接图例时，这将非常有用。</p><p id="a787" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="abb6" class="mb mc iq lv b gy md me l mf mg">npm i d3-geo-projection ndjson-cli -D</span></pre><p id="9552" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe ls lt lu lv b">buildmap.sh</code>的顶部，将您需要的投影(在我们的例子中是美国艾伯斯)和 SVG 输出的高度和宽度放入 bash 变量:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="b4c8" class="mb mc iq lv b gy md me l mf mg"># USA albers<br/>PROJECTION='d3.geoAlbersUsa()'</span><span id="12e9" class="mb mc iq lv b gy nf me l mf mg"># Display height and width<br/>WIDTH=960<br/>HEIGHT=600</span></pre><p id="2058" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后在<code class="fe ls lt lu lv b">buildmap.sh</code>底部添加:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="fe8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意第 7 行，我们运行 sed 命令从 SVG 中提取最后一行:因为我们使用了<code class="fe ls lt lu lv b">ndjson-split</code>将 GeoJSON 转换为换行符分隔的 JSON 文件，所以我们的 SVG XML 也是换行符分隔的。因此，使用 sed 命令，我们去掉了 SVG 的右括号。当我们构建我们的 legend SVG 时，我们也将去掉它的左括号，并将两者连接到我们的最终输出中。</p><p id="309f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在这里了解更多关于换行符分隔的 JSON 及其用法<a class="ae kv" href="https://medium.com/@kandros/newline-delimited-json-is-awesome-8f6259ed4b4b" rel="noopener">。</a></p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="b74e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第六步:给我们的地图添加一个图例</strong></p><p id="0756" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们快完成了。最后一步是使用 node 和 D3 生成 SVG 格式的图例，然后将所述图例合并到我们的地图中。</p><p id="0c5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用 Brad Oyler 的<a class="ae kv" href="https://bradoyler.com/projects/d3-node/" rel="noopener ugc nofollow" target="_blank"> D3 节点库</a>在 D3 手写我们的图例(并导出 SVG)。我们还将使用标志传入我们的 SVG 高度和宽度变量，并用<a class="ae kv" href="https://github.com/substack/minimist" rel="noopener ugc nofollow" target="_blank">minimit</a>库解析所述标志。</p><p id="dc7a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="81ff" class="mb mc iq lv b gy md me l mf mg">npm i d3-node minimist -D</span></pre><p id="ddee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在命令行上创建我们的 JS 文件:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="b088" class="mb mc iq lv b gy md me l mf mg">touch buildLegend.js</span></pre><p id="027e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后写下以下内容(细节再次在评论中):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="c348" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，在<code class="fe ls lt lu lv b">buildmap.sh</code>中，我们可以添加:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="b325" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面运行<code class="fe ls lt lu lv b">buildLegend.js</code>，传入我们的 SVG 宽度和高度。然后，它使用<code class="fe ls lt lu lv b">tail</code>将图例和地图连接到我们的最终输出<code class="fe ls lt lu lv b">topo.svg</code>。</p><p id="087e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后两行只是清理目录，删除不必要的文件。</p><p id="a24e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们完事了。！！在命令行上运行:</p><pre class="kg kh ki kj gt lx lv ly lz aw ma bi"><span id="b2ef" class="mb mc iq lv b gy md me l mf mg">npm run buildmap</span></pre><p id="d8ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切顺利，这应该会生成<code class="fe ls lt lu lv b">topo.svg</code>，看起来<a class="ae kv" href="https://s3.amazonaws.com/graphics.expressnews.com/graphics/undocumented-resident-percentages/raw_assets/topo.svg" rel="noopener ugc nofollow" target="_blank">有点像这个</a>。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="a912" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为参考，<a class="ae kv" href="https://github.com/sa-express-news/undocumented-resident-percentages" rel="noopener ugc nofollow" target="_blank">这里有一个回购</a>包括所有这些文件的最终形式和<a class="ae kv" href="https://github.com/sa-express-news/undocumented-resident-percentages/blob/master/buildmap.sh" rel="noopener ugc nofollow" target="_blank">一个直接链接</a>到所述回购中的<code class="fe ls lt lu lv b">buildmap.sh</code>。</p></div></div>    
</body>
</html>