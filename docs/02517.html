<html>
<head>
<title>3D CNN Classification of Prostate Cancer on PROSTATEx-2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">前列腺癌在 PROSTATEx-2 上的 3D CNN 分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3d-cnn-classification-of-prostate-tumour-on-multi-parametric-mri-sequences-prostatex-2-cced525394bb?source=collection_archive---------19-----------------------#2019-04-24">https://towardsdatascience.com/3d-cnn-classification-of-prostate-tumour-on-multi-parametric-mri-sequences-prostatex-2-cced525394bb?source=collection_archive---------19-----------------------#2019-04-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9398" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">多参数磁共振序列的三维 CNN</h2></div><h2 id="3fd6" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">内容</h2><p id="ad9c" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">本文描述了在多参数 MRI 序列上使用 3D CNN 对前列腺癌进行显著或不显著的分类。内容如下:</p><ul class=""><li id="968c" class="lx ly it lg b lh lz lk ma kr mb kv mc kz md lw me mf mg mh bi translated">数据集描述</li><li id="2263" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">Dicom 到 Nifti 文件格式的转换</li><li id="8a99" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">不同磁共振成像序列的配准</li><li id="61db" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">围绕损伤中心裁剪并调整大小至 30 毫米乘 30 毫米</li><li id="f6bc" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">二元标签提取</li><li id="fa6f" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">训练-验证分割</li><li id="4593" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">3D CNN 架构</li><li id="3587" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">结果</li></ul><h2 id="cd34" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">数据集描述</h2><p id="d9e0" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">使用的数据集取自<a class="ae mn" href="https://wiki.cancerimagingarchive.net/display/Public/SPIE-AAPM-NCI+PROSTATEx+Challenges#b07aa11d8dd248838322e5d1b67e0909" rel="noopener ugc nofollow" target="_blank">前列腺素-2 — SPIE-AAPM-NCI 前列腺素 MR Gleason 等级组挑战赛</a>。数据集由 162 名患者组成，其中 99 名患者作为训练案例，63 名患者作为测试案例。MRI 序列由一系列 2D 扫描组成，这些扫描以 3D 形式描绘了身体的一部分。每位患者有五种 MRI 序列模式:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mo"><img src="../Images/030655bcceb15b7ea11b0d9859dbbd71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kKMqecwIVsO4F6fK9617wg.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">(left) demonstration of MRI sequences, (middle) demonstration of views, (right) five modes of MRI in PROSTATEx-2 dataset</figcaption></figure><ul class=""><li id="7306" class="lx ly it lg b lh lz lk ma kr mb kv mc kz md lw me mf mg mh bi translated">T2 加权横向序列</li><li id="6922" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">T2 加权矢状序列</li><li id="9c81" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">ADC 横向序列</li><li id="79a3" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">DWI 横向序列</li><li id="4f1f" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">Ktrans 横向序列</li></ul><p id="1e2f" class="pw-post-body-paragraph le lf it lg b lh lz ju lj lk ma jx lm kr ne lo lp kv nf lr ls kz ng lu lv lw im bi translated">由于 T2 横切面、ADC、DWI、KTrans 都是前列腺的横切面视图，所以它们被一起用于对前列腺病变进行分类。没有使用 T2 矢状序列，这是前列腺的侧视图。</p><p id="47eb" class="pw-post-body-paragraph le lf it lg b lh lz ju lj lk ma jx lm kr ne lo lp kv nf lr ls kz ng lu lv lw im bi translated">每个患者在他或她的 MRI 序列中可能有一个以上的病变发现。在随附的 CSV 文件中，每个病灶都标有:</p><ul class=""><li id="6e31" class="lx ly it lg b lh lz lk ma kr mb kv mc kz md lw me mf mg mh bi translated">格里森等级组(GGG)1-5(1 为最有利，5 为最不利)，</li><li id="97fc" class="lx ly it lg b lh mi lk mj kr mk kv ml kz mm lw me mf mg mh bi translated">以及图片中病变中心的 X、Y、Z 坐标。</li></ul><h2 id="51ad" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">Dicom 到 NIFTI 文件格式的转换</h2><p id="1bff" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">T2、ADC、DWI 序列采用 Dicom 文件格式，KTrans 采用 MHD 文件格式。所有的 DICOM 文件和 MHD 文件首先使用 MRIcoGL(【https://www.nitrc.org/projects/mricrogl/】)转换成 NIFTI 文件，MRIcoGL 使用 dcm2niix 将 Dicom 转换成 NIFTI。</p><blockquote class="nh ni nj"><p id="df0a" class="le lf nk lg b lh lz ju lj lk ma jx lm nl ne lo lp nm nf lr ls nn ng lu lv lw im bi translated">提示:打开 MRIconGL.exe=&gt;Import= &gt;将 Dicom 转换为 NIFITI，将数据集的根文件夹转储到白色窗口空间，并等待转换完成，这将需要一段时间。然后用 python 脚本组织你的 Nii 文件(不是最好的方法)。或者，您可以尝试使用<a class="ae mn" href="https://github.com/icometrix/dicom2nifti" rel="noopener ugc nofollow" target="_blank"> dicom2nifti </a> python 包用 python 脚本进行转换。</p></blockquote><h2 id="37b4" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">不同磁共振成像序列的配准</h2><p id="5c60" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">由于不同的横向 MRI 模式具有不同的尺度和不同的位置，因此需要配准步骤来对准不同的模式。仿射变换用于将 ADC 序列、DWI 序列和 Ktrans 序列与 T2 序列对齐。然后这四种模式作为一个 NumPy 阵列相互堆叠。堆叠式 NumPy 阵列类似于三通道图像文件，其中红色、蓝色和绿色通道对应于 T2、ADC 和 DWI。然而，还有第四个渠道，即 Ktrans。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi no"><img src="../Images/1c15cbfc0696e0dbff2a3bfab5c56391.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16fLl1_KStAx7aUf86Egpw.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">(top row) unregistered T2, ADC, DWI images, (btm row) co-registered T2, ADC, DWI, depicted as three channels of an image file. Ktrans is left out only in this depiction but it is used and will be shown later on.</figcaption></figure><pre class="mp mq mr ms gt np nq nr ns aw nt bi"><span id="644f" class="ki kj it nq b gy nu nv l nw nx">import nibabel as nib<br/>import os<br/>from dipy.align.imaffine import AffineMap</span><span id="e80c" class="ki kj it nq b gy ny nv l nw nx">patients = os.listdir("D:\ProstateX2")<br/>stack = []<br/>for i in patients:<br/> directory = “D:\\ProstateX2\\” + i<br/> s = os.listdir(directory)<br/>#Load T2.nii file<br/> t2 = nib.load(“D:\\ProstateX2\\” + i+ “\\” + s[7])<br/>#Load ADC.nii file<br/> ADC = nib.load(“D:\\ProstateX2\\” + i+ “\\” + s[3])<br/> <br/> t2_static = t2.get_data()<br/> t2_static_grid2world = t2.affine<br/> <br/> ADC_moving = Diff1.get_data()<br/> ADC_moving_grid2world = ADC_moving.affine<br/> identity = np.eye(4)</span><span id="94bb" class="ki kj it nq b gy ny nv l nw nx"> ADC_affine_map = AffineMap(identity, t2_static.shape,         t2_static_grid2world, ADC_moving.shape, ADC_moving_grid2world)<br/> <br/> transformADC = ADC_affine_map.transform(ADC_moving)<br/> <br/> out= np.stack([static.transpose(2,0,1), transformADC.transpose(2,0,1) axis=-1)<br/> <br/> stack += [patient]</span></pre><h2 id="27c1" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">围绕病变中心裁剪并调整大小至 30 毫米乘 30 毫米</h2><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nz"><img src="../Images/eee41d677130eab2ccc64585c7be5fe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KAxViDYCC--zdiJirb9PSA.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">columns: stacked mode (comprising T2, ADC, DWI, Ktrans), T2 mode, ADC mode, DWI mode, KTrans mode; rows: ProstateX-0000 co-registered, ProstateX-0000 cropped and resized, ProstateX-0199 co-registered, ProstateX-0199 cropped and resized</figcaption></figure><p id="077e" class="pw-post-body-paragraph le lf it lg b lh lz ju lj lk ma jx lm kr ne lo lp kv nf lr ls kz ng lu lv lw im bi translated">由于每个病变在序列中都有 x、y、z 坐标标签，因此可以识别病变中心，并用蓝色圈出。每个军团病例将有 30 毫米乘 30 毫米的真实世界长度，以病变为中心。由于 T2 序列的分辨率对于所有患者都不相同，所以图像的每个像素代表真实世界长度中的不同毫米。要裁剪的像素数将由公式给出:<code class="fe oa ob oc nq b">30/pixel_spacing</code>其中<code class="fe oa ob oc nq b">pixel_spacing</code>是在附带的 CSV 文件中给出的每个像素代表的毫米数。在病变中心裁剪所需数量的像素后，所有裁剪的图像都被调整到 60X60 分辨率，这是裁剪后最常见的分辨率。</p><p id="cb7d" class="pw-post-body-paragraph le lf it lg b lh lz ju lj lk ma jx lm kr ne lo lp kv nf lr ls kz ng lu lv lw im bi translated">此外，将只保留病变中心 z 坐标上下的 2 个切片。因此，裁剪和调整大小将导致 5X60X60X4 分辨率的立方体被馈送到 3D CNN 模型。最后一个通道 4 对应于每个像素上的堆叠通道(T2、ADC、DWI、Ktrans)。裁剪到较小的立方体大小将会有更集中的感兴趣区域，这将有助于模型更好地分类。</p><h2 id="5882" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">标签提取</h2><p id="f965" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">给出的标签是每个病变发现的 GGG(1-5)。当 GGG 为 1 时，病变发现可进一步分组为无临床意义，当 GGG 大于 1 时，可进一步分组为有临床意义。当比较 PRSTATEx2 和 PROSTATEx 的结果时可以看出这一点，因为它们具有相同的病例。然后，根据基于 GGG 发现的它们是否具有临床意义，将每个损伤病例重新标记为真或假。对于二元标记，未来的任务是对病变是否具有临床意义进行二元分类。</p><h2 id="22df" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">训练-验证分割</h2><p id="448f" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">该数据集由 99 名患者的 MRI 序列组成，但是每个患者在他或她的 MRI 序列中可能有一个以上的病变发现。如预处理步骤中所述，总共呈现和提取了 112 个发现。这 112 项发现分为 78 项用于培训的发现和 34 项用于验证的发现。</p><h2 id="ffae" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">3D CNN 架构</h2><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi od"><img src="../Images/d44a2855191871d6cbd32910cbbf37da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0p5YexVnnWS8wDIesSXJwg.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">3D CNN architecture</figcaption></figure><p id="1bb4" class="pw-post-body-paragraph le lf it lg b lh lz ju lj lk ma jx lm kr ne lo lp kv nf lr ls kz ng lu lv lw im bi translated">建议的架构如图所示。输入形状是 Batch_SizeX5X60X60X4。输入通过一系列 1x3x3 和 3x3x3 内核，然后是 Maxpool3D 层和另一系列 1x3x3 内核来扩展特性空间。然后，扩展的特征空间被展平，通过 64 个密集节点，最后通过 SoftMax 激活 2 个密集节点。交叉熵用于 SoftMax 输出的损失函数。</p><h2 id="509b" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结果</h2><p id="4672" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">验证集上的混淆矩阵和度量分数如下:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/365a3634a28708aaa22eb76795f17acd.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*0HrM02tufaw0WdNgvGkcTw.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Confusion Matrix on the validation set</figcaption></figure><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi of"><img src="../Images/62e58709fbf4e23512e81c5d06af475d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qy80KGKJ3MqVLJSKOPdpgg.png"/></div></div></figure><p id="3c56" class="pw-post-body-paragraph le lf it lg b lh lz ju lj lk ma jx lm kr ne lo lp kv nf lr ls kz ng lu lv lw im bi translated">真阳性、假阴性、真阴性和假阳性打印在左侧。结果显示，虽然很难单独从每种模式中分辨出病变应该是阳性还是阴性，但是当应该是阳性(真阳性和假阴性)时，堆叠模式显示的白色多于灰色，而当应该是阴性时，堆叠模式显示的灰色多于白色。这可能是一个明显的迹象，表明多参数 MRI 可能比单一模式的 MRI 扫描更好地对前列腺癌进行分类。</p></div></div>    
</body>
</html>