<html>
<head>
<title>Create your first ETL in Luigi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Luigi 中创建您的第一个 ETL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/create-your-first-etl-in-luigi-23202d105174?source=collection_archive---------10-----------------------#2019-11-18">https://towardsdatascience.com/create-your-first-etl-in-luigi-23202d105174?source=collection_archive---------10-----------------------#2019-11-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/16839840721ba24662acc69833deb7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/0*p_Sfog6czED5Ipv6.png"/></div></figure><p id="6849" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">本帖是</em> <a class="ae kt" href="http://blog.adnansiddiqi.me/tag/data-engineering/" rel="noopener ugc nofollow" target="_blank"> <em class="ks">数据工程系列</em> </a> <em class="ks">的一部分。</em></p><p id="f8a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在以前的帖子中，我讨论了用 Bonobo、Spark 和 Airflow 编写 ETL。在这篇文章中，我将介绍另一个由<em class="ks"> Spotify </em>开发的 ETL 工具，名为<strong class="jw ir"> Luigi </strong>。</p><p id="18ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">之前我已经讨论过关于编写基本 ETL 管道的<a class="ae kt" href="http://blog.adnansiddiqi.me/develop-your-first-etl-job-in-python-using-bonobo/" rel="noopener ugc nofollow" target="_blank">这里</a>，这里<a class="ae kt" href="http://blog.adnansiddiqi.me/getting-started-with-apache-airflow/" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae kt" href="http://blog.adnansiddiqi.me/create-your-first-etl-pipeline-in-spark-and-python/" rel="noopener ugc nofollow" target="_blank">这里</a>。Bonobo 在编写 ETL 管道方面很酷，但是这个世界并不全是编写 ETL 管道来实现自动化。还有一些其他的用例，在这些用例中，您必须按照一定的顺序执行任务一次或者定期执行。例如:</p><ul class=""><li id="f3cf" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated">监控 Cron 作业</li><li id="a21f" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">将数据从一个地方传输到另一个地方。</li><li id="643f" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">自动化您的开发运维。</li><li id="135a" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">定期从网站上获取数据，并为你令人敬畏的价格比较系统更新数据库。</li><li id="34a7" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">基于推荐系统的数据处理。</li><li id="394d" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">机器学习管道。</li></ul><p id="6659" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可能性是无限的。</p><p id="e4ba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们进一步在我们的系统中实现<em class="ks"> Luigi </em>之前，让我们讨论一下什么是气流及其术语。</p><h1 id="7696" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">什么是路易吉？</h1><p id="ea58" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">来自<a class="ae kt" href="https://github.com/spotify/luigi" rel="noopener ugc nofollow" target="_blank"> Github 页面</a>:</p><blockquote class="ml mm mn"><p id="3bea" class="ju jv ks jw b jx jy jz ka kb kc kd ke mo kg kh ki mp kk kl km mq ko kp kq kr ij bi translated">Luigi 是一个 Python (2.7、3.6、3.7 测试版)包，可以帮助你构建复杂的批处理作业管道。它处理依赖关系解析、工作流管理、可视化、处理故障、命令行集成等等。</p></blockquote><p id="378d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们学习和理解基本组件和术语。</p><ul class=""><li id="425c" class="ku kv iq jw b jx jy kb kc kf kw kj kx kn ky kr kz la lb lc bi translated"><strong class="jw ir">目标:- </strong>简单来说，一个目标持有一个任务的输出。目标可以是本地(例如:文件)、HDFS 或 RDBMS(MySQL 等)</li><li id="b827" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated">任务是实际工作发生的地方。任务可以是独立的，也可以是从属的。相关任务的示例是将数据转储到文件或数据库中。在加载数据之前，数据必须以任何方式存在(抓取、API 等)。每个任务都表示为一个 Python 类，其中包含某些强制成员函数。任务函数包含以下方法:</li><li id="05b8" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><strong class="jw ir">requires():-</strong>task 类的这个成员函数包含了当前任务之前必须执行的所有任务实例。在我上面分享的例子中，一个名为<strong class="jw ir"> ScrapeData </strong>的任务将包含在<code class="fe mr ms mt mu b">requires()</code>方法中，因此使一个任务成为一个依赖任务。</li><li id="327b" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><strong class="jw ir"> output():- </strong>这个方法包含了任务输出将被存储的目标。这可能包含一个或多个目标对象。</li><li id="7681" class="ku kv iq jw b jx ld kb le kf lf kj lg kn lh kr kz la lb lc bi translated"><strong class="jw ir"> run():- </strong>这个方法包含了运行任务的实际逻辑。</li></ul><p id="7c46" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">图示将如下所示:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/1fc62ccdea78735a99027065ac17d38e.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*mT2bCzkvGKWTJAOw.jpg"/></div></figure><p id="bb65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们先写一个玩具 ETL。它什么也不做，只是把 Hello World 放到一个文本文件中，然后用你输入的名字替换 World。</p><p id="7d0b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第一个类或任务<code class="fe mr ms mt mu b">HelloWorld</code>是 ETL 的<em class="ks">提取</em>部分，假设文本为 Hello World！来自外部来源(API、DB 等)并存储在文件<code class="fe mr ms mt mu b">helloworld.txt</code>中。<code class="fe mr ms mt mu b">output()</code>方法设定目标。因为目标是文件名为<code class="fe mr ms mt mu b">helloworld.txt</code>的本地文件<code class="fe mr ms mt mu b">LocalTarget</code>。<code class="fe mr ms mt mu b">run</code>方法负责所有的处理逻辑。因为这个任务不依赖于任何任务，所以<code class="fe mr ms mt mu b">requires()</code>返回一个<code class="fe mr ms mt mu b">None</code>。</p><p id="78cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二个类<code class="fe mr ms mt mu b">NameSubstituter</code>可以被认为是一个将原始文本转换成其他内容并保存到另一个文本文件中的类。因此，这个类(任务)负责 ETL 的<strong class="jw ir"> T </strong>和<strong class="jw ir"> L </strong>部分。</p><p id="5523" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe mr ms mt mu b">name = luigi.Parameter()</code>是将 ETL 参数化，便于从外部数据源接受数据。<code class="fe mr ms mt mu b">infile.read()</code>从传入文件中读取数据，在我们的例子中，它是<code class="fe mr ms mt mu b">helloworld.txt</code>和内容<em class="ks"> Hello World！</em>被保存在一个<code class="fe mr ms mt mu b">text</code>变量中。文本<em class="ks">世界</em>，然后被替换为输入名称。文件名也遵循在<code class="fe mr ms mt mu b">output()</code>方法中设置的特定格式。</p><p id="6449" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，代码准备好了。是时候运行它了。我转到命令行并运行以下命令:</p><p id="0ff7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe mr ms mt mu b">python luigitutorial.py --scheduler-host localhost NameSubstituter</code></p><p id="b7e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">哎呀！它坠毁了！</p><p id="391f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如您所见，错误消息很清楚:<em class="ks">需要设置‘name’参数。</em></p><p id="9884" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们必须传递 name 参数。为此，我们将采取以下措施:</p><p id="0e80" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe mr ms mt mu b">python luigitutorial.py --scheduler-host localhost NameSubstituter --name Adnan</code></p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/634e758597f29081fb719aaa3240a587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dnOp00mm8N2aYg5D.png"/></div></div></figure><p id="b76e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你能看到笑脸符号吗？一切顺利！</p><p id="74f1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在让我解释一下这个命令。Luigi 使用一种不同的调度程序来调度作业。出于开发目的，使用了<code class="fe mr ms mt mu b">--local-schedular</code>,但是如果您希望可视化监控过程，那么您应该使用<code class="fe mr ms mt mu b">--schedular-host</code>在基于 web 的界面上监控它。确保运行运行本地 web 服务器的<code class="fe mr ms mt mu b">luigid</code>守护进程。如果你不设置<code class="fe mr ms mt mu b">--schedular-host</code>，它仍然会运行，但是你不能监控正在运行的任务，所以一定要小心！如果所有的点都连接得很好，你可以通过访问<code class="fe mr ms mt mu b"><a class="ae kt" href="http://localhost:8082/" rel="noopener ugc nofollow" target="_blank">http://localhost:8082/</a></code>来了解事情的进展</p><p id="0974" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在访问中，您可以看到如下屏幕:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nf"><img src="../Images/3c6a0f93a51223e4553823ae59b79681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9oUOaUFc-NbpahbT.png"/></div></div></figure><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ng"><img src="../Images/9bf1ff3167ce0146727d29f74b96eb9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*T3pbSOuKe-MLdJh1.png"/></div></div></figure><p id="dfa6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">任务正在运行，您可以看到状态。万一你想知道我为什么加了<code class="fe mr ms mt mu b">sleep</code>，你现在就可以猜到了。如果不增加延迟，你就无法想象它，因为它会执行得非常快。此外，请注意在<em class="ks">细节</em>部分中带有参数的<code class="fe mr ms mt mu b">NameSubstituter</code>类的多个条目。这是因为它们被认为是独特的工作，而 HelloWorld 却不是。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nh"><img src="../Images/26e2097b239d9f53691d0efaf6753703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AhextPROwmWgFB5p.png"/></div></div></figure><p id="bd36" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您单击单个任务，您可以看到任务的依赖关系图。类似于<a class="ae kt" href="http://blog.adnansiddiqi.me/getting-started-with-apache-airflow/" rel="noopener ugc nofollow" target="_blank">气流</a>。</p><p id="00bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您会看到文件名附加了输入名称。如果您还记得，我们已经这样设置了文件名。这是不必要的，你可以选择任何你想要的，因为我自己从一个例子。</p><p id="9fc3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">哦，对了，任务运行一次。并不是每次运行都会生成文件。如果你想有一个新的开始，而不仅仅是删除所有的输入和输出文件。在这个例子中，例如，如果您想重新运行名为 Adnan 的 ETL，那么只需删除<code class="fe mr ms mt mu b">helloworld.txt.name_Adnan</code>，而不是所有文件。如果您的输入文件内容被更改，那么也删除它。</p><h1 id="5a90" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">结论</h1><p id="ef80" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">因此，您了解了 Luigi 如何使编写满足您需求的 ETL 变得更加容易。在下一部分中，我们将讨论一个真实世界的例子，就像我们对 Apache Airflow 所做的那样。像往常一样，代码可以在<a class="ae kt" href="https://github.com/kadnan/Luigi-Python-Tutorial" rel="noopener ugc nofollow" target="_blank"> Github </a>获得。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="21d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">原载于 2019 年 11 月 18 日</em><a class="ae kt" href="http://blog.adnansiddiqi.me/create-your-first-etl-in-luigi/" rel="noopener ugc nofollow" target="_blank"><em class="ks">http://blog . adnansiddiqi . me</em></a><em class="ks">。</em></p></div></div>    
</body>
</html>