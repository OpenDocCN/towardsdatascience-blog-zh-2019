<html>
<head>
<title>Web Scraping Google Sheets with RSelenium</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 RSelenium 抓取谷歌表单</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/web-scraping-google-sheets-with-rselenium-9001eda399b0?source=collection_archive---------9-----------------------#2019-01-29">https://towardsdatascience.com/web-scraping-google-sheets-with-rselenium-9001eda399b0?source=collection_archive---------9-----------------------#2019-01-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1b0dffeaad7c22c0d83fc7e74908ebe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eBZrWn2oyPO3oAIm-v5uPg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/photos/ZArDeAtxj0Q?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">freestocks.org</a> on <a class="ae kc" href="https://unsplash.com/search/photos/web-scraping?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b016" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我喜欢学习新的东西，我学得最好的方法之一就是实践。也有人说<a class="ae kc" href="https://kottke.org/17/06/if-you-cant-explain-something-in-simple-terms-you-dont-understand-it" rel="noopener ugc nofollow" target="_blank">你永远不会完全理解一个话题，直到你能够解释它</a>，我认为博客是解释事情的一个低门槛。</p><p id="076b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在蒙特利尔的一个当地数据科学会议上遇到的一个人想要帮助网络抓取，以从<a class="ae kc" href="http://www.puzzledpint.com/standings/" rel="noopener ugc nofollow" target="_blank">puzzled point</a>获得团队排名。我抓住了这个机会，因为我知道这将是我最终学习<a class="ae kc" href="https://github.com/ropensci/RSelenium" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">硒的机会！</strong> </a></p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/9feb84414be89e9fffa33616f6354f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*txFP2X4BWaCm0fefpSzqbg.jpeg"/></div></div></figure><h1 id="e464" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">静态刮擦与动态刮擦</h1><p id="32aa" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">静态抓取忽略 JavaScript。它不需要浏览器的帮助就可以从服务器获取网页。你得到的正是你在“查看页面源代码”中看到的内容，然后你对它进行分割。如果你正在寻找的内容是可用的，你不需要再进一步。但是，如果内容类似于“iframe ”,就需要动态抓取。</p><p id="f022" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">动态抓取使用实际的浏览器(或无头浏览器),让 JavaScript 来完成它的工作。然后，它查询 DOM 来提取它正在寻找的内容。有时，您需要通过模拟用户来获得您需要的内容，从而使浏览器自动化。为了让我获得其余帖子的相同详细信息，我需要首先导航到下一页，这包括单击搜索结果页底部的 next 按钮。</p><h1 id="0f87" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">用 Docker 设置 RSelenium</h1><p id="8860" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">RSelenium 为 Selenium Webdriver API 提供了<strong class="kf ir"> R </strong>绑定。Selenium 是一个专注于 web 浏览器自动化的项目。</p><p id="7b5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您需要遵循 Windows 或 Ubuntu 上 Docker Toolbox 的<a class="ae kc" href="https://docs.docker.com/toolbox/toolbox_install_windows/" rel="noopener ugc nofollow" target="_blank">安装说明</a>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/76450a55caee895510cfdc781a33ef70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XvJ0GDWOAEHNApZvw-dOVQ.png"/></div></div></figure><p id="686e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Docker 通过使用容器来运行应用程序。容器只是一个包中的一组库和其他依赖项。你可以把它想象成一个虚拟机，但它不是创建一个完整的操作系统，而是允许应用程序使用同一个 Linux 内核，只是没有在主机上运行。基本上，它显著提高了性能并减小了应用程序的大小。此外，您可以放心，应用程序将在任何其他 Linux 机器上运行，而不管该机器的任何定制设置可能与用于编写和测试代码的机器不同。</p><p id="d12c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你还需要<a class="ae kc" href="http://www.tightvnc.com/download.php" rel="noopener ugc nofollow" target="_blank">安装 TightVNC </a>，这将允许你看到你是如何用 RSelenium 实时操纵网页的。</p><p id="9a75" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来按照<a class="ae kc" href="http://ropensci.github.io/RSelenium/articles/docker.html" rel="noopener ugc nofollow" target="_blank">的说明创建一个 Docker 容器，运行 selenium 服务器和它自己的 firefox </a>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/0e25922416132f3694c19d879eaa9bb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rMlftpSVS9BHbh9UBwCgsw.png"/></div></div></figure><blockquote class="mm mn mo"><p id="aaba" class="kd ke mk kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated"><em class="iq">注意:一旦你设置了 docker 容器(并且每次你重新启动你的计算机或再次启动时),打开 Docker Quickstart 终端并运行下面的命令。</em></p></blockquote><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="e650" class="mx lh iq mt b gy my mz l na nb">docker run -d -p 4445:4444 selenium/standalone-firefox:2.53.0</span></pre><p id="2a03" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你已经启动了你的<strong class="kf ir"> Docker Quickstart 终端</strong>进入<strong class="kf ir"> R </strong>并连接到一个正在运行的服务器。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="a928" class="mx lh iq mt b gy my mz l na nb">library(RSelenium)<br/>remDr &lt;- remoteDriver(<br/>  remoteServerAddr = "192.168.99.100",<br/>  port = 4445L<br/>)<br/>remDr$open()</span></pre><p id="c575" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用 Rselenium 导航到页面。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="6e79" class="mx lh iq mt b gy my mz l na nb"># navigate to the website of interest<br/>remDr$navigate("<a class="ae kc" href="http://www.puzzledpint.com/standings/" rel="noopener ugc nofollow" target="_blank">http://www.puzzledpint.com/standings/</a>")<br/># confirm you got there<br/>remDr$getTitle()0</span></pre><p id="65eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，让我们在 RStudio 的<strong class="kf ir">查看器</strong>选项卡中获取一个现场截图。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="ce00" class="mx lh iq mt b gy my mz l na nb">remDr$screenshot(display = TRUE)</span></pre><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/d9c9dcd2ca27f732a8b812ddd7e54b30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzaElAcPM2Mp-8tiVvHHXg.jpeg"/></div></div></figure><p id="f37c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请记住，这只是一个静态的屏幕截图。在开发你的管道时，你需要使用<strong class="kf ir"> TightVNC </strong>来实时查看你的互动，这样你就可以看到你是如何与网站互动的。</p><blockquote class="mm mn mo"><p id="a2e5" class="kd ke mk kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">当你在你的<code class="fe nc nd ne mt b">…$findElement()</code>和<code class="fe nc nd ne mt b">…$switchToFrame()</code> / <code class="fe nc nd ne mt b">…$clickElement()</code>命令之间使用<code class="fe nc nd ne mt b">…$highlightElement()</code>时，注意 TightVNC 是很重要的，这样你实际上知道你选择了合适的东西！</p></blockquote><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/59d99f95d4ab7d4ce46ecd3898e86865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4u3CxR8Z3e5PSwnzEpjKQ.jpeg"/></div></div></figure><p id="c06a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">打开<strong class="kf ir"> TighVNC 查看器</strong>，输入端口号；在本例中为<code class="fe nc nd ne mt b">192.168.99.100</code>，并在<strong class="kf ir">远程主机:</strong>字段中输入。点击<strong class="kf ir">连接</strong>，输入密码:<code class="fe nc nd ne mt b">secret</code>。</p><blockquote class="mm mn mo"><p id="d7ac" class="kd ke mk kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">注意:如果 TightVNC 停止工作(在 Windows 10 上经常如此)并给出错误消息:“由于目标机器主动拒绝，无法建立连接”，那么请按照<a class="ae kc" href="http://ropensci.github.io/RSelenium/articles/docker.html" rel="noopener ugc nofollow" target="_blank">“使用 VNC 调试”的步骤进行操作。</a></p></blockquote><h1 id="bb40" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">访问 DOM 中的元素</h1><p id="2a1b" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">网页是一组嵌套对象(统称为<strong class="kf ir">文档对象模型</strong>或<strong class="kf ir"> DOM </strong>)。它是一种跨平台和独立于语言的约定，用于表示 HTML、XHTML 和 XML 文档中的对象并与之交互。与 DOM 的互动对我们与硒元素的关系非常重要。</p><p id="6a1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Hadley Wickham 建议使用 Chrome 扩展软件<a class="ae kc" href="http://selectorgadget.com/" rel="noopener ugc nofollow" target="_blank"> Selectorgadget </a>，来帮助识别你需要的网页元素。他推荐<a class="ae kc" href="http://flukeout.github.io/" rel="noopener ugc nofollow" target="_blank">这一页</a>来学习更多关于选择器的知识。</p><p id="03aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，通过使用 SelectorGadget，您可以选择感兴趣的表。在这种情况下，它说这是一个<strong class="kf ir"> iframe </strong>。为了仅隔离月度排名，我们将单击另一个框，仅选择感兴趣的一个:<code class="fe nc nd ne mt b">iframe:nth-child(68)</code>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/4890e731ad73e6b2b6bff424a9e16efb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDfMiT9bM80mW7xMeD-jPQ.jpeg"/></div></div></figure><p id="4cc6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 web 浏览器的上下文中，框架是网页或浏览器窗口的一部分，它独立于其容器显示内容，并具有独立加载内容的能力。在这种情况下，网站从另一个来源获取数据，在主排名页面之外以交互方式显示这些表格。对我来说幸运的是，它们都来自 Google Sheets，所以这将使我更加容易。遗憾的是，您无法使用“selectorgadget”找到这些工作表的链接。你需要在 Chrome 或 Firefox 中使用名为“Inspector”的开发者工具仔细查看源代码。如果你有 Windows 和 Firefox，你可以点击<strong class="kf ir">打开菜单</strong>然后点击<code class="fe nc nd ne mt b">Web Developer &gt; Inspector</code>或者直接点击<code class="fe nc nd ne mt b">Ctrl+Shift+c</code>。然后我用搜索框寻找 Montréal 的链接(<code class="fe nc nd ne mt b">src=</code>)。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/9a772010b47adee78c1fd9b44c8831ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yEL28XbgOFIF0yTR5SmAMg.jpeg"/></div></div></figure><blockquote class="mm mn mo"><p id="83fb" class="kd ke mk kf b kg kh ki kj kk kl km kn mp kp kq kr mq kt ku kv mr kx ky kz la ij bi translated">对我来说，找到我要找的东西是一件非常痛苦的事情，因为有时候高光看起来像你想要的，但实际上不是。例如:</p></blockquote><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/87475eaf784f11cde239666d426b6c45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Bu0acQcB_CpRmdDhOKLtA.jpeg"/></div></div></figure><p id="2549" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我猜要弄清楚 HTML，它涉及到逐渐的“<strong class="kf ir">拒绝和错误</strong>”尝试。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/27e804387a5a01cb860be2a045fa261b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*CP-fXLA8NMeNbl81qjJ2wQ.jpeg"/></div></figure><h1 id="cb2a" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">用 RSelenium 抓取 Google 表单</h1><h2 id="80f8" class="mx lh iq bd li ng nh dn lm ni nj dp lq ko nk nl lu ks nm nn ly kw no np mc nq bi translated">法律免责声明</h2><p id="227a" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">值得一提的是，管理员可能出于多种原因<a class="ae kc" href="http://www.robotstxt.org/norobots-rfc.txt" rel="noopener ugc nofollow" target="_blank">想要保护他们网站的某些部分</a>，例如"<em class="mk">对未经宣布的站点进行索引、遍历需要大量服务器资源的站点部分、递归遍历无限 URL 空间等。</em></p><p id="7812" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，应该经常检查他们是否有许可。一种方法是使用 robotstxt 包来检查你的网络机器人是否有权限访问网页的某些部分。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="f3e2" class="mx lh iq mt b gy my mz l na nb"># check permissions<br/>library(robotstxt)<br/>paths_allowed("<a class="ae kc" href="https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=690408156" rel="noopener ugc nofollow" target="_blank">https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=690408156</a>")</span></pre><p id="5653" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果在特定的页面上写着<strong class="kf ir">真</strong>你就有权限。或者，只需转到主页 url 上的 robots.txt 文件，就可以更广泛地了解什么是允许的(什么是不允许的)。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/b93008ea8b685f74a5ac3dbceb664ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*Y5y6dhHtDd_6U0m9L8KNNg.jpeg"/></div></figure><h2 id="a795" class="mx lh iq bd li ng nh dn lm ni nj dp lq ko nk nl lu ks nm nn ly kw no np mc nq bi translated">方法 1</h2><p id="2110" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">有时候网站可以用框架来组成。这些实际上是被放在一个框架集中的独立网页。我们需要在这些帧之间来回跳转。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="9e1d" class="mx lh iq mt b gy my mz l na nb">library(RSelenium)<br/>library(XML)<br/>library(janitor)<br/>library(lubridate)<br/>library(magrittr)<br/>library(dplyr)</span><span id="5d5e" class="mx lh iq mt b gy ns mz l na nb">remDr &lt;- remoteDriver(<br/>  remoteServerAddr = "192.168.99.100",<br/>  port = 4445L<br/>)<br/>remDr$open()</span><span id="7868" class="mx lh iq mt b gy ns mz l na nb"># Now open TightVNC to follow along with Selenium driving the browser. Set 192.168.99.100:5901 and password: secret</span><span id="b734" class="mx lh iq mt b gy ns mz l na nb"># navigate to the main page<br/>remDr$navigate("<a class="ae kc" href="https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=690408156" rel="noopener ugc nofollow" target="_blank">https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=690408156</a>")</span><span id="8136" class="mx lh iq mt b gy ns mz l na nb"># <a class="ae kc" href="https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=552987877" rel="noopener ugc nofollow" target="_blank">https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=552987877</a></span><span id="ad0c" class="mx lh iq mt b gy ns mz l na nb"># look for table element<br/>tableElem &lt;- remDr$findElement(using = "id", "pageswitcher-content")</span><span id="e619" class="mx lh iq mt b gy ns mz l na nb"># switch to table<br/>remDr$switchToFrame(tableElem)<br/># parse html<br/>doc &lt;- htmlParse(remDr$getPageSource()[[1]])<br/>table_tmp &lt;- readHTMLTable(doc)<br/>table_tmp &lt;- table_tmp[[1]][-2,-1]<br/>table_tmp &lt;- table_tmp[-1,]<br/>colnames(table_tmp) &lt;- c("team_name", "team_size", "start_time", "end_time", "total_time", "puzzels_solved")<br/>table_tmp$city &lt;- rep("montreal", nrow(table_tmp))<br/>table_tmp$date &lt;- rep(Sys.Date()-5, nrow(table_tmp))</span></pre><p id="d152" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了第一个月，我们可以为剩下的日期创建一个 for 循环。首先让我们切换回外部框架，并选择我们将要操作的元素。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="af50" class="mx lh iq mt b gy my mz l na nb"># switch back to the main/outter frame<br/>remDr$switchToFrame(NULL)</span><span id="3a4e" class="mx lh iq mt b gy ns mz l na nb"># find the elements you'll manipulate with Inspector mode in a browser<br/>webElems &lt;- remDr$findElements(using = "css", ".switcherItem") # Month/Year tabs at the bottom<br/>arrowElems &lt;- remDr$findElements(using = "css", ".switcherArrows") # Arrows to scroll left and right at the bottom<br/>tableElem &lt;- remDr$findElement(using = "id", "pageswitcher-content") # The inner table frame</span></pre><p id="0d92" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我知道会有很多桌子，但是到底有多少呢？我们可以通过<code class="fe nc nd ne mt b">length(webElems)</code>来检查这个。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/43e0b21d50a59bf2f4acc2793d7edd6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQhjpdvfaEJ95OvaNY-C8A.jpeg"/></div></div></figure><p id="bf8d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">实际上总共有 49 个表，但是从上面的第一个表开始，只有 48 个链接。与其硬编码<code class="fe nc nd ne mt b">1:48</code>,不如通过代码来实现，因为将来会添加更多的表。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="bcb8" class="mx lh iq mt b gy my mz l na nb"># Create NULL object to be used in forloop<br/>big_df &lt;- NULL<br/>for (i in seq(length(webElems))){ # for every <br/>check &lt;- try(expression, silent = TRUE) # or suppressMessages(try(expression, silent = TRUE))<br/>if (any(class(check) == "try-error")) {<br/>        # choose the i'th Month/Year tab <br/>        webElem &lt;- webElems[[i]]<br/>        webElem$clickElement()</span><span id="d15b" class="mx lh iq mt b gy ns mz l na nb"># Find the tableElem again other wise you get a StaleElementReference <br/>## TO DO: look into WebDriverWait: <a class="ae kc" href="https://stackoverflow.com/questions/5709204/random-element-is-no-longer-attached-to-the-dom-staleelementreferenceexception" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/5709204/random-element-is-no-longer-attached-to-the-dom-staleelementreferenceexception</a> <br/>tableElem &lt;- remDr$findElement(using = "id", "pageswitcher-content") # The inner table frame</span><span id="8df6" class="mx lh iq mt b gy ns mz l na nb"># switch to table frame<br/>remDr$switchToFrame(tableElem)<br/>Sys.sleep(3)<br/># parse html with XML package<br/>doc &lt;- htmlParse(remDr$getPageSource()[[1]])<br/>Sys.sleep(3)<br/># Extract data from HTML table in HTML doucment<br/>table_tmp &lt;- readHTMLTable(doc)<br/>Sys.sleep(3)<br/># put this into a format you can use<br/>table &lt;- table_tmp[[1]][-2,-1]<br/>table &lt;- table[-1,]<br/># rename the columns<br/>colnames(table) &lt;- c("team_name", "team_size", "start_time", "end_time", "total_time", "puzzels_solved")<br/># add city name to a column<br/>table$city &lt;- rep("Montreal", nrow(table))</span><span id="cd57" class="mx lh iq mt b gy ns mz l na nb"># add the Month/Year this table was extracted from<br/>today &lt;- Sys.Date() %m-% months(i + 1)<br/>table$date &lt;- today</span><span id="b43c" class="mx lh iq mt b gy ns mz l na nb"># concatenate each table together<br/>big_df &lt;- dplyr::bind_rows(big_df, table)</span><span id="b47b" class="mx lh iq mt b gy ns mz l na nb"># Switch back to the main frame<br/>remDr$switchToFrame(NULL)</span><span id="fc4e" class="mx lh iq mt b gy ns mz l na nb">arrowElem &lt;- arrowElems[[1]]<br/># once you "click"" the element it is "held down" as far as I know there is no way to " unclick"<br/># to prevent it from scrolling too far I make sure not to take too long by setting the sleep short<br/>arrowElem$clickElement()<br/># give it "just enough time" to scroll right<br/>Sys.sleep(0.3)<br/># switch back to outer frame to re-start the loop<br/>remDr$switchToFrame(NULL)<br/>        }<br/>}</span><span id="4baf" class="mx lh iq mt b gy ns mz l na nb">temp1 &lt;- dplyr::bind_rows(table_tmp, big_df)</span></pre><p id="8271" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里的问题是，当 for 循环试图单击右箭头时，它最终会失败，但它已经尽可能地向右了，因此它不会下载最后几个表(~5)。通常情况下，人们会这样处理这种情况:</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="bfc3" class="mx lh iq mt b gy my mz l na nb">check &lt;- try(expression, silent = TRUE) # or suppressMessages(try(expression, silent = TRUE))<br/>if (any(class(check) == "try-error")) {<br/>  # do stuff<br/>}</span></pre><p id="26d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它通常运行良好，包括使用硒时。然而，这里遇到的问题是，单击一次箭头总是会将我带到最后一张<em class="mk">可见的工作表，跳过中间的所有内容。因此，我的工作是这样的:</em></p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="813c" class="mx lh iq mt b gy my mz l na nb"># ctrl+x from the google sheet then use the read.delim() to assign it to an object<br/>march &lt;- read.delim("clipboard")<br/>february &lt;- read.delim("clipboard")<br/>january &lt;- read.delim("clipboard")<br/>december &lt;- read.delim("clipboard")<br/>november &lt;- read.delim("clipboard")</span><span id="e084" class="mx lh iq mt b gy ns mz l na nb"># add the city and date<br/>january$city &lt;- rep("montreal", nrow(january))<br/>january$date &lt;- rep("2015-01-30", nrow(january))</span><span id="d89e" class="mx lh iq mt b gy ns mz l na nb">february$city &lt;- rep("montreal", nrow(february))<br/>february$date &lt;- rep("2015-02-15", nrow(february))</span><span id="eaa1" class="mx lh iq mt b gy ns mz l na nb">march$city &lt;- rep("montreal", nrow(march))<br/>march$date &lt;- rep("2015-03-15", nrow(march))</span><span id="f5b7" class="mx lh iq mt b gy ns mz l na nb">december$city &lt;- rep("montreal", nrow(december))<br/>december$date &lt;- rep("2014-12-15", nrow(december))</span><span id="f947" class="mx lh iq mt b gy ns mz l na nb">november$city &lt;- rep("montreal", nrow(november))<br/>november$date &lt;- rep("2014-11-15", nrow(november))</span><span id="8894" class="mx lh iq mt b gy ns mz l na nb"># clean up the column names<br/>january %&lt;&gt;% janitor::clean_names()<br/>february %&lt;&gt;% janitor::clean_names()<br/>march %&lt;&gt;% janitor::clean_names()<br/>december %&lt;&gt;% janitor::clean_names()<br/>november %&lt;&gt;% janitor::clean_names()</span><span id="b578" class="mx lh iq mt b gy ns mz l na nb"># concatenate these five dataframes together<br/>xyz &lt;- bind_rows(march, february, january, december, november)</span><span id="8d8d" class="mx lh iq mt b gy ns mz l na nb"># convert characters into actual dates<br/>xyz$date &lt;-as.Date(xyz$date)</span><span id="c177" class="mx lh iq mt b gy ns mz l na nb"># reorder the columns<br/>xyz %&lt;&gt;% dplyr::select(team_name, team_size, start_time, end_time, total_time, puzzles, city, date)</span><span id="0e6b" class="mx lh iq mt b gy ns mz l na nb"># rename this column to match temp1<br/>xyz &lt;- rename(xyz, puzzels_solved = puzzles)</span><span id="a9df" class="mx lh iq mt b gy ns mz l na nb"># change to a character<br/>xyz$puzzels_solved &lt;- as.character(xyz$puzzels_solved)</span><span id="8d3f" class="mx lh iq mt b gy ns mz l na nb"># add NA for team size<br/>xyz$team_size &lt;- rep(NA, nrow(xyz))</span><span id="5c8b" class="mx lh iq mt b gy ns mz l na nb"># concatenate this onto the larger dataframe<br/>temp2 &lt;- bind_rows(temp1, xyz)</span><span id="7c82" class="mx lh iq mt b gy ns mz l na nb"># save the object<br/>write_csv(temp2, "puzzeld_pint_raw.csv")</span></pre><h2 id="6dfd" class="mx lh iq bd li ng nh dn lm ni nj dp lq ko nk nl lu ks nm nn ly kw no np mc nq bi translated">方法 2</h2><p id="c837" class="pw-post-body-paragraph kd ke iq kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ij bi translated">非常感谢 Nate on SO 指出了一个替代方案，解决了<em class="mk">废弃表</em>的任务，但<strong class="kf ir">没有解决上述意义上的</strong>异常处理的任务。</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="2e97" class="mx lh iq mt b gy my mz l na nb">remDr &lt;- RSelenium::remoteDriver(<br/>  remoteServerAddr = "192.168.99.100",<br/>  port = 4445L<br/>)<br/>remDr$open(silent = TRUE)</span><span id="d942" class="mx lh iq mt b gy ns mz l na nb"># navigate to the main page<br/># needs no be done once before looping, else content is not available<br/>remDr$navigate("https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pub?output=html&amp;widget=true#gid=690408156")</span><span id="767f" class="mx lh iq mt b gy ns mz l na nb"># I. Preliminaries:<br/># <br/># 1. build the links to all spreadsheets<br/># 2. define the function create_table<br/># <br/># 1.<br/># get page source<br/>html &lt;- remDr$getPageSource()[[1]]<br/># split it line by line<br/>html &lt;- unlist(strsplit(html, '\n'))<br/># restrict to script section<br/>script &lt;- grep('^\\s*var\\s+gidMatch', html, value = TRUE)<br/># split the script by semi-colon<br/>script &lt;- unlist(strsplit(script, ';'))<br/># retrieve information<br/>sheet_months &lt;- gsub('.*name:.{2}(.*?).{1},.*', '\\1', <br/>                     grep('\\{name\\s*\\:', script, value = TRUE), perl = TRUE)<br/>sheet_gid &lt;- gsub('.*gid:.{2}(.*?).{1},.*', '\\1', <br/>                  grep('\\gid\\s*\\:', script, value = TRUE), perl = TRUE)<br/>sheet_url &lt;- paste0('https://docs.google.com/spreadsheets/d/1o1PlLIQS8v-XSuEz1eqZB80kcJk9xg5lsbueB7mTg1U/pubhtml/sheet?headers%5Cx3dfalse&amp;gid=',<br/>                    sheet_gid)</span><span id="66cb" class="mx lh iq mt b gy ns mz l na nb"># 2.<br/># table yielding function<br/># just for readability in the loop<br/>create_table &lt;- function (remDr) {<br/>  # parse html with XML package<br/>  doc &lt;- XML::htmlParse(remDr$getPageSource()[[1]])<br/>  Sys.sleep(3)<br/>  # Extract data from HTML table in HTML document<br/>  table_tmp &lt;- XML::readHTMLTable(doc)<br/>  Sys.sleep(3)<br/>  # put this into a format you can use<br/>  table &lt;- table_tmp[[1]][-2, -1]<br/>  # add a check-up for size mismatch<br/>  table_fields &lt;- as.character(t(table[1,]))<br/>  if (! any(grepl("size", tolower(table_fields)))) {<br/>    table &lt;- table[-1, ]<br/>    # rename the columns<br/>    colnames(table) &lt;- c("team_name", "start_time", "end_time", "total_time", "puzzels_solved")<br/>    table$team_size &lt;- NA_integer_<br/>    table &lt;- table[,c("team_name", "team_size", "start_time", "end_time", "total_time", "puzzels_solved")]<br/>  } else {<br/>    table &lt;- table[-1, ]<br/>    # rename the columns<br/>    colnames(table) &lt;- c("team_name", "team_size", "start_time", "end_time", "total_time", "puzzels_solved")<br/>  }<br/>  # add city name to a column<br/>  table$city &lt;- rep("Montreal", nrow(table))<br/><br/>  # add the Month/Year this table was extracted from<br/>  today &lt;- Sys.Date()<br/>  lubridate::month(today) &lt;- lubridate::month(today)+1<br/>  table$date &lt;- today<br/><br/>  # returns the table<br/>  table<br/>}<br/><br/># II. Scrapping the content<br/># <br/># 1. selenium to generate the pages<br/># 2. use create_table to extract the table<br/># <br/>big_df &lt;- NULL<br/>for (k in seq_along(sheet_url)) {<br/>  # 1. navigate to the page<br/>  remDr$navigate(sheet_url[k])<br/>  # remDr$screenshot(display = TRUE) maybe one wants to see progress<br/>  table &lt;- create_table(remDr)<br/><br/>  # 2. concatenate each table together<br/>  big_df &lt;- dplyr::bind_rows(big_df, table)<br/><br/>  # inform progress <br/>  cat(paste0('\nGathered table for: \t', sheet_months[k]))<br/>}<br/><br/># close session<br/>remDr$close()</span></pre><p id="be8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要执行这项任务，首先要生成文档中所有电子表格的链接。为此:</p><ul class=""><li id="ddec" class="nt nu iq kf b kg kh kk kl ko nv ks nw kw nx la ny nz oa ob bi translated">导航到文档一次</li><li id="a80c" class="nt nu iq kf b kg oc kk od ko oe ks of kw og la ny nz oa ob bi translated">提取源代码</li><li id="35e5" class="nt nu iq kf b kg oc kk od ko oe ks of kw og la ny nz oa ob bi translated">使用<code class="fe nc nd ne mt b">regex</code>提取工作表月份和 URL(通过<code class="fe nc nd ne mt b">gid</code>数字)</li><li id="7e68" class="nt nu iq kf b kg oc kk od ko oe ks of kw og la ny nz oa ob bi translated">完成后，遍历 URL，收集并绑定表</li></ul><p id="e77f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有一个名为<code class="fe nc nd ne mt b">create_table</code>的小函数，它以正确的格式返回最终的表格，并对列数进行安全度量(一些电子表格没有<code class="fe nc nd ne mt b">team_size</code>字段——在这种情况下，我将其设置为<code class="fe nc nd ne mt b">NA_integer</code>)。</p><p id="9ed1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你觉得这篇文章有用，请随意与他人分享或推荐这篇文章！😃</p><p id="1d69" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一如既往，如果您有任何问题或意见，请随时在下面留下您的反馈，或者您可以随时通过<a class="ae kc" href="https://www.linkedin.com/in/matthewoldach/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。在那之前，下一篇文章再见！😄</p></div></div>    
</body>
</html>