<html>
<head>
<title>Using open source tools to create interactive maps of political surveys</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用开源工具创建交互式政治调查地图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-open-source-tools-to-create-interactive-maps-of-political-surveys-f10ee0195984?source=collection_archive---------31-----------------------#2019-10-16">https://towardsdatascience.com/using-open-source-tools-to-create-interactive-maps-of-political-surveys-f10ee0195984?source=collection_archive---------31-----------------------#2019-10-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4101" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">设想英国地区对硬英国退出欧盟的支持</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/a2a9e14e7e7d16a4457105154ee59603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*_Yfaf9tdjzhVT_y3"/></div></figure><p id="bd6c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这个星期谁说了谁的坏话？谁将被投票淘汰出局？谁去勾搭这一季的人气先生？不，我们不是在谈论爱情岛或单身汉，而是另一个越来越受欢迎的真人秀节目:BBC 的议会频道。英国退出欧盟可能有点像一辆破车，但它确实提供了一些有趣的民意调查。</p><p id="33b8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将使用今年 3 月的民意调查数据(以 SPSS 文件的形式)来查看对无交易英国退出欧盟的支持，并将结果显示为交互式地图。最终结果将如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/b9c293494345c216b7f09a4fa3861067.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/0*q6TsPDjAwCWqMPma"/></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">Support for a no-deal Brexit across regions shortly after Theresa May announced that she’d reached a deal with the EU.</figcaption></figure><h1 id="2453" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">轮询数据</h1><p id="488b" class="pw-post-body-paragraph kq kr it ks b kt mj ju kv kw mk jx ky kz ml lb lc ld mm lf lg lh mn lj lk ll im bi translated">为了读取 SPSS 文件并计算我们的结果，我们将使用开源软件库<a class="ae mo" href="https://www.github.com/quantipy/quantipy3" rel="noopener ugc nofollow" target="_blank"> Quantipy </a>，这是一个专门为处理调查数据而设计的库。我们以前写过 Jupyter 笔记本环境对于处理调查数据有多好，我们在这里再次使用它。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="2de7" class="mu ls it mq b gy mv mw l mx my">import quantipy as qp<br/>dataset = qp.DataSet(“Political survey”)<br/>dataset.read_spss(“results.sav”)</span></pre><p id="642d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们已经导入了数据集，让我们来看看我们想要可视化的问题，<code class="fe mz na nb mq b">Deal_or_no_deal</code>:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="933d" class="mu ls it mq b gy mv mw l mx my">dataset.crosstab(“Deal_or_no_deal”, “Regions”, pct=True)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nc"><img src="../Images/1af6d1f74e5c7f8c814b0f451d1644e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nW6L9RqAfo5Y419k"/></div></div></figure><p id="23bc" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们还清理空列(“Northern Ireland”和“Other”)的输出，并删除“All”列，以使结果更容易阅读。然后，我们将只提取结果数据行“不再向欧盟让步，必要时不达成协议就离开”，并给它一个漂亮的简短报告标签:“不达成协议”。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="4100" class="mu ls it mq b gy mv mw l mx my">vote = dataset.crosstab(‘Deal_or_no_deal’, <br/>                        “Regions”, pct=True, f=filter)<br/>vote = vote.droplevel(level=0,axis=1)<br/>vote = vote.droplevel(level=0,axis=0)<br/>vote = vote.drop([‘Other’,‘Northern Ireland’,“All”],axis=1)<br/>vote.index.name = ‘No deal’<br/>poll_result = vote.iloc[5,:]</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nh"><img src="../Images/5769ab0516173c9c72659496e11e7593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KW-M2plnWnxS_dlw"/></div></div></figure><p id="5529" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是我们的数据，但是在地图上看起来像什么呢？</p><h1 id="6405" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">使用 geopandas 通过 python 映射数据</h1><p id="0807" class="pw-post-body-paragraph kq kr it ks b kt mj ju kv kw mk jx ky kz ml lb lc ld mm lf lg lh mn lj lk ll im bi translated">为了绘制我们的结果，我们使用 geopandas python 库，这是一个非常强大但易于使用的库，它可以将地理空间数据转换为 pandas 数据框架。方便的是，有人已经在 GitHub 上收集了英国大部分主要的<a class="ae mo" href="https://github.com/martinjc/UK-GeoJSON" rel="noopener ugc nofollow" target="_blank">地理空间数据(这就是使用开源解决方案的好处，通常有人会为你做大部分艰苦的工作)，我们使用 UK-geo JSON/JSON/electronic/GB/文件夹中的 eer.json 文件。将其保存到文件后，我们将其导入到 geopandas:</a></p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="fd1f" class="mu ls it mq b gy mv mw l mx my">import geopandas<br/>gdata = gpd.read_file(‘eer.json’)<br/>gdaga.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi ni"><img src="../Images/1b04716b4508010ecdd564ad140d66e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MYz2Vkp1JavT6jsg"/></div></div></figure><p id="da6e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">请注意，这些区域存储在列“EER13NM”中。我们将这个数据框的结果与我们之前计算的数据合并。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="a609" class="mu ls it mq b gy mv mw l mx my">gdata = gdata.join(poll_result, on=”EER13NM”)<br/>gdata.plot(columns=”No more concessions to the EU, leave without a deal if necessary”)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/be0ca510c395a808cf48ffaa1c90b80a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/0*cAzKtAqfxMnfmx1y"/></div></figure><p id="bf7b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们有进展了。但是我们想知道不同性别和不同地区的投票结果有什么不同。所以我们给 DataSet.crosstab()方法发送了一个过滤器。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="7e88" class="mu ls it mq b gy mv mw l mx my">dataset.crosstab("Deal_or_no_deal", <br/>                 "Regions", pct=True,<br/>                 f={"Gender":[1]})</span></pre><h1 id="1542" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">交互式 Jupyter 小工具</h1><p id="bac9" class="pw-post-body-paragraph kq kr it ks b kt mj ju kv kw mk jx ky kz ml lb lc ld mm lf lg lh mn lj lk ll im bi translated">接下来，我们需要一个交互式小部件，允许我们选择要查看的过滤器。我们使用 Jupyter 的 ipywidgets，它允许我们在笔记本中注入交互性。我们使用 dropdown 小部件，并使用 dataset.value_texts()和 dataset.codes()来填充它们。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="4e05" class="mu ls it mq b gy mv mw l mx my">gender = widgets.Dropdown(<br/>   options=[(“All”, None)] + <br/>      list(zip(dataset.value_texts(‘Gender’), <br/>      dataset.codes(‘Gender’)))[:2],value=None,  <br/>      description=’Gender:’,<br/>      disabled=False<br/>)</span><span id="7ffa" class="mu ls it mq b gy nk mw l mx my">age = widgets.Dropdown(<br/>    options=[(“All”, None)] +    <br/>    list(zip(dataset.value_texts(‘grouped_age’),<br/>    dataset.codes(‘grouped_age’))),<br/>    value=None,<br/>    description=’Age:’,<br/>    disabled=False<br/>)</span></pre><p id="1103" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">最后，将 Jupyter 的交互式 dropdown 小部件连接到我们的地图，这样我们就可以使用名为 interactive 的 ipywidgets 库的一部分来控制它所显示的内容(这是一种在笔记本中连接 Jupyter 前端和 python 后端的简单方法)。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="f590" class="mu ls it mq b gy mv mw l mx my">interactive(update_map, gender=gender, age=age)</span></pre><p id="f398" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们的 update_map 方法封装了过滤器的计算和地图的绘制。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="2d1c" class="mu ls it mq b gy mv mw l mx my">def update_map(gender, age):</span><span id="ed91" class="mu ls it mq b gy nk mw l mx my">    filter = []<br/>    if gender:<br/>        filter.append( {‘Gender’: [gender]})<br/>    if age:<br/>        filter.append({‘grouped_age’: [age]})</span><span id="aa25" class="mu ls it mq b gy nk mw l mx my">    vote_data = get_vote_data(filter).to_dict()</span><span id="2177" class="mu ls it mq b gy nk mw l mx my">    map = gdata.join(get_vote_data(filter),<br/>               on=”EER13NM”).plot(vmin=0, vmax=60,<br/>               column=”No more consessions to the EU,<br/>               leave without a deal if necessary”)<br/> <br/>    out.clear_output()<br/>    # out is a Jupyter Widget that captures output<br/>    with out:<br/>        display(map.figure)</span></pre><p id="271b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了简洁起见，我们省略了图的一些格式(改变颜色图、边框、图例格式)和一个我们调用的方法，以便用不同的过滤器检索数据。但我们现在已经准备好了，有了一张互动地图，可以显示不同地区的人们的观点是如何不同的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nl"><img src="../Images/3ec81aba080c3c1c82ed900ffa274e4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hq4n9TvmeGlTemvv"/></div></div></figure><p id="f51a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在你知道了，使用开源解决方案不仅可以计算公众对“不交易英国退出欧盟”意见的地区差异，还可以使这些差异对消费信息的人有意义。</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><p id="bc43" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">盖尔·弗雷松是<a class="ae mo" href="https://www.datasmoothie.com/" rel="noopener ugc nofollow" target="_blank"> Datasmoothie </a>的联合创始人，这是一个专门从事调查数据分析和可视化的平台。如果你对使用开源软件进行调查数据分析感兴趣，注册我们的时事通讯，名为<a class="ae mo" href="https://confirmsubscription.com/h/r/123C34C5066BF0AD2540EF23F30FEDED" rel="noopener ugc nofollow" target="_blank">自发认知</a>。</p></div></div>    
</body>
</html>