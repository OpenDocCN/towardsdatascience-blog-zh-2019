<html>
<head>
<title>AWS SageMaker Endpoint as REST service with API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS SageMaker 端点作为带有 API 网关的 REST 服务</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/aws-sagemaker-endpoint-as-rest-service-with-api-gateway-48c36a3cf46c?source=collection_archive---------8-----------------------#2019-07-03">https://towardsdatascience.com/aws-sagemaker-endpoint-as-rest-service-with-api-gateway-48c36a3cf46c?source=collection_archive---------8-----------------------#2019-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="e622" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有许多方法可以将 AWS SageMaker endpoint 部署为 REST 服务，其中一种方法在 AWS 博客中使用 Lambda 函数进行了介绍。在本文中，我将展示如何在不涉及 Lambda 等主动组件的情况下实现这一点。我们将要设置的体系结构概述将具有以下简单结构:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/dad70c276897f7095017e3354b1e5598.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*Oe-oO9C1vzLFBsqA8qqOQA.png"/></div></figure></div><div class="ab cl kw kx hx ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="im in io ip iq"><h2 id="4b01" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">模型准备</h2><p id="002e" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">首先，让我们为 sage maker——特别是 MNIST——训练一个演示模型。这段代码将进行训练，并在当前目录下创建<code class="fe mb mc md me b">model.tar.gz</code>文件。</p><p id="3f7a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保在执行培训脚本之前运行<code class="fe mb mc md me b">pip install tensorflow</code>。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="bbaf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">脚本会将模型文件保存在<code class="fe mb mc md me b">./model/{timestamp}</code>目录下，并在当前目录下创建<code class="fe mb mc md me b">model.tar.gz</code>。通常，在为 SageMaker 创建模型时，您还需要提供包含您的推理代码、web 服务器、相关库等的 docker 映像。但是因为我们使用 tensorflow 模型，我们可以利用 AWS 管理的<code class="fe mb mc md me b"><a class="ae mh" href="https://github.com/aws/sagemaker-tensorflow-serving-container/" rel="noopener ugc nofollow" target="_blank">sagemaker-tensorflow-serving</a></code>容器作为推理图像。所有繁重的代码和样板代码都已经打包在这个映像中。我们只需要提供模型文件和可选的定制代码来进行推理前/后处理。</p><p id="f2ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">服务容器只接受<code class="fe mb mc md me b">application/json</code>内容类型作为输入。我们可以添加定制的推理代码来处理额外的内容类型，比如图像负载，但这超出了本文的范围。</p></div><div class="ab cl kw kx hx ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="im in io ip iq"><h2 id="f115" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">部署</h2><p id="c604" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">创建模型文件后，我们可以继续 AWS 部署。以下是在此设置中使用的 AWS 资源的更详细的架构</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mi"><img src="../Images/0125ffb2aea4db30735bd01af29b8b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_q2XGMPZrPrIDg1pFNYKQ.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk">Detailed diagram of AWS resources</figcaption></figure><p id="afbf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mr">请注意，所有示例都是使用 terraform 0.12(带有 HCL 2 语法)</em>构建的。</p><p id="8252" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们将创建 S3 桶，并将模型包上传到桶中。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="7cc8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们可以创建 SageMaker 模型并部署端点。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="7cff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mr">请注意，此处创建的 IAM 角色仅用于演示目的，不要在生产中使用</em> <code class="fe mb mc md me b"><em class="mr">AmazonSageMakerFullAccess</em></code> <em class="mr">策略。</em></p><p id="08ea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">端点部署由两个主要部分组成(除了 IAM 角色之外)。</p><p id="2679" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，创建模型。它封装了角色、S3 桶中的模型文件、推理 docker 映像和一些环境变量。如前所述，我们使用的是 AWS 托管推理映像，它属于<code class="fe mb mc md me b">520713654638</code> AWS 帐户。</p><p id="0ce2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">其次，端点配置和端点本身被创建。</p><p id="c29d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">部署通常需要 5-6 分钟，请耐心等待:)</p><p id="4151" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们测试端点。我们需要一些<code class="fe mb mc md me b">JSON</code>格式的测试数据。可以使用以下代码片段从 MNIST 数据集中提取它</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="c6c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它会将单个图像保存到<code class="fe mb mc md me b">payload.json</code>文件中，并将预期的结果打印到 stdout 中(本例中为<code class="fe mb mc md me b">7</code>)。您可以更改<code class="fe mb mc md me b">idx</code>变量，以提取其他图像。请注意，整个结果封装在附加数组中，因为 API 可以一次对多个图像进行推断。现在我们可以调用<code class="fe mb mc md me b">sagemaker-runtime invoke-endpoint</code>来做预测。</p><pre class="kp kq kr ks gt ms me mt mu aw mv bi"><span id="c3b5" class="ld le it me b gy mw mx l my mz">$ aws sagemaker-runtime invoke-endpoint --endpoint-name mnist-test --body file://payload.json --content-type application/json result.json<br/>{<br/>    "ContentType": "application/json",<br/>    "InvokedProductionVariant": "main"<br/>}</span><span id="6282" class="ld le it me b gy na mx l my mz">$ cat res.json<br/>{<br/>    "predictions": [[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0]<br/>    ]<br/>}</span></pre><p id="8854" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">到目前为止一切顺利，但我们仍然只部署了 SageMaker 端点。现在有趣的部分来了——与 API Gateway 的集成。</strong></p><p id="0bc0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们先创建常规的东西，即 API Gateway REST 资源、方法和方法响应。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="1c0b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，让我们创建与 SageMaker 的集成。为了使集成工作，我们需要另一个 IAM 角色，允许 API 网关 InvokeEndpoint 访问和集成资源本身。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="76d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这段代码中最重要的一行是集成资源中的 URL，<em class="mr">，它在 AWS 文档</em>中既没有文档也没有示例。</p><pre class="kp kq kr ks gt ms me mt mu aw mv bi"><span id="b4fa" class="ld le it me b gy mw mx l my mz">arn:aws:apigateway:${var.region}:runtime.sagemaker:path//endpoints/${aws_sagemaker_endpoint.endpoint.name}/invocations</span></pre><p id="9e23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，双斜线(<code class="fe mb mc md me b">//</code>)是有意的，没有它们集成将不起作用。成功部署后，terraform 将输出调用端点 URL。我们可以使用我们的<code class="fe mb mc md me b">payload.json</code>通过<code class="fe mb mc md me b">curl</code>进行预测:</p><pre class="kp kq kr ks gt ms me mt mu aw mv bi"><span id="1fb2" class="ld le it me b gy mw mx l my mz">$ curl -XPOST <a class="ae mh" href="https://omxuj9h9of.execute-api.eu-central-1.amazonaws.com/predict" rel="noopener ugc nofollow" target="_blank">https://<strong class="me iu">{api-gw-id}</strong>.execute-api.eu-central-1.amazonaws.com/predict</a> -H "Content-Type: application/json" -d <a class="ae mh" href="http://twitter.com/payload" rel="noopener ugc nofollow" target="_blank">@payload</a>.json<br/>{<br/>    "predictions": [[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0]<br/>    ]<br/>}</span></pre></div><div class="ab cl kw kx hx ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="im in io ip iq"><h2 id="d171" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">限制</h2><p id="68c5" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">有关更多详细信息，请查看 API 网关和 SageMaker 端点限制。值得注意的是</p><ul class=""><li id="a6e5" class="nb nc it js b jt ju jx jy kb nd kf ne kj nf kn ng nh ni nj bi translated">API 网关将最大有效负载限制为 10 MB</li><li id="96a4" class="nb nc it js b jt nk jx nl kb nm kf nn kj no kn ng nh ni nj bi translated">SageMaker 的最大执行时间为 60 秒</li></ul><h2 id="c0e3" class="ld le it bd lf lg lh dn li lj lk dp ll kb lm ln lo kf lp lq lr kj ls lt lu lv bi translated">结论</h2><p id="2ca3" class="pw-post-body-paragraph jq jr it js b jt lw jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj ma kl km kn im bi translated">这是制作灵活的 RESTish 推理端点的非常快速、简单、稳定和成本有效的方法。它还可以扩展到支持</p><ul class=""><li id="e7aa" class="nb nc it js b jt ju jx jy kb nd kf ne kj nf kn ng nh ni nj bi translated">基于认知或静态密钥的授权</li><li id="c3bb" class="nb nc it js b jt nk jx nl kb nm kf nn kj no kn ng nh ni nj bi translated">VPC 私人部署</li><li id="981a" class="nb nc it js b jt nk jx nl kb nm kf nn kj no kn ng nh ni nj bi translated">以及 API 网关的所有其他特性</li><li id="9259" class="nb nc it js b jt nk jx nl kb nm kf nn kj no kn ng nh ni nj bi translated">使用 SageMaker 自动缩放</li><li id="8fc3" class="nb nc it js b jt nk jx nl kb nm kf nn kj no kn ng nh ni nj bi translated">利用弹性推理获得 GPU 能力</li></ul><p id="23a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢阅读。</p></div></div>    
</body>
</html>