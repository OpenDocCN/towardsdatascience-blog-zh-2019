<html>
<head>
<title>Predicting a Waiter’s Tips</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">预测服务员的小费</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-a-waiters-tips-1990342a0d02?source=collection_archive---------20-----------------------#2019-10-07">https://towardsdatascience.com/predicting-a-waiters-tips-1990342a0d02?source=collection_archive---------20-----------------------#2019-10-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cd79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">fast.ai《程序员实用深度学习》第四课</p><p id="3638" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在 fast.ai 的<a class="ae kl" href="https://course.fast.ai/" rel="noopener ugc nofollow" target="_blank">“程序员实用深度学习”</a>第四课中，我们发现了如何使用深度学习和协同过滤来解决表格数据问题。正如我在 fast.ai 讲座上经常做的那样，我将讲座从头到尾看了一遍，然后在浏览笔记本时又看了一遍，必要时暂停一下。当我完成后，我想确保我可以用不同的数据集复制这个过程，我选择了乔·杨的 Kaggle 数据集“<a class="ae kl" href="https://www.kaggle.com/jsphyg/tipping" rel="noopener ugc nofollow" target="_blank"> A Waiter's Tips </a>”。有了这个数据集，我们想建立一个模型来预测餐馆服务员的小费金额。</p><p id="560c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我从下载数据集并解压它开始，检查丢失的值(没有！)，然后将 tips.csv 文件上传到工作目录中的“data”文件夹。</p><p id="609c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe km kn ko kp b">from fastai.tabular import *</code>之后，我需要编辑笔记本以使路径指向正确的位置，因为笔记本默认路径指向讲座中使用的数据集。我的数据在‘data’文件夹中，所以我相应地设置了路径，并告诉它将数据存储在熊猫<code class="fe km kn ko kp b">DataFrame</code>中:</p><pre class="kq kr ks kt gt ku kp kv kw aw kx bi"><span id="c401" class="ky kz iq kp b gy la lb l lc ld">path = Path(‘data’)<br/>df = pd.read_csv(path/’tips.csv’)</span></pre><p id="3a8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我设置列名、因变量和预处理函数。因为我想根据其他因素来预测小费金额，所以我将<code class="fe km kn ko kp b">tip</code>设置为因变量，并且因为可以从简短的可能性列表中选择一周的<code class="fe km kn ko kp b">sex</code>、<code class="fe km kn ko kp b">smoker</code>和<code class="fe km kn ko kp b">day</code>，所以我将这些设置为“分类”变量。<code class="fe km kn ko kp b">total_bill</code>和<code class="fe km kn ko kp b">size</code>只是数字，所以它们是“连续”变量。我必须思考一分钟关于一天的<code class="fe km kn ko kp b">time</code>，虽然:“时间”感觉像是一个连续的概念，但看着数据，我看到“时间”被定义为“午餐”或“晚餐”那就绝对的。</p><p id="6bba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">笔记本附带了预处理函数<code class="fe km kn ko kp b">FillMissing</code>、<code class="fe km kn ko kp b">Categorify</code>和<code class="fe km kn ko kp b">Normalize</code>，我暂时保留它们。</p><pre class="kq kr ks kt gt ku kp kv kw aw kx bi"><span id="d280" class="ky kz iq kp b gy la lb l lc ld">dep_var = 'tip'<br/>cat_names = ['sex', 'smoker', 'day', 'time']<br/>cont_names = ['total_bill', 'size']<br/>procs = [FillMissing, Categorify, Normalize]</span></pre><p id="4c12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(这位加州女孩惊讶地看到“吸烟者”被列为餐馆顾客的一个可能属性)</p><p id="e054" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我需要为我的测试集选择一个大小。我们通常为测试集留出 20%的数据，因此由于我的数据集有 244 个元素，我将测试集设置为使用从 196 到 244 的索引范围。</p><pre class="kq kr ks kt gt ku kp kv kw aw kx bi"><span id="a632" class="ky kz iq kp b gy la lb l lc ld">test = TabularList.from_df(df.iloc[196:244].copy(), path=path, cat_names=cat_names, cont_names=cont_names)</span></pre><p id="4354" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后是时候使用 fastai 库的 Datablock API 来创建我的<code class="fe km kn ko kp b">databunch</code>:</p><pre class="kq kr ks kt gt ku kp kv kw aw kx bi"><span id="a578" class="ky kz iq kp b gy la lb l lc ld">data = (TabularList.from_df(df, path=path, cat_names=cat_names,    cont_names=cont_names, procs=procs)<br/> .split_by_idx(list(range(196,244)))<br/> .label_from_df(cols=dep_var)<br/> .add_test(test)<br/> .databunch())</span></pre><p id="e41e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我检查出一批数据:</p><p id="290f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">data.show_batch(rows=10)</code></p><figure class="kq kr ks kt gt lf gh gi paragraph-image"><div class="gh gi le"><img src="../Images/36647a0b1561751801a57c5d350d6b0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*e3LisARxj0MwvVGhNndBLA.png"/></div></figure><p id="beba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">total_bill</code>和<code class="fe km kn ko kp b">size</code>经常有负值？我不认为餐馆付钱给任何顾客在那里吃饭，所以这一定是调用<code class="fe km kn ko kp b">Normalize</code>预处理的结果。我查看了<a class="ae kl" href="https://docs.fast.ai/tabular.data.html#TabularProcessor" rel="noopener ugc nofollow" target="_blank">文档</a>，没有发现<code class="fe km kn ko kp b">Normalize</code>实际上做了什么，所以我返回到<a class="ae kl" href="https://github.com/hiromis/notes/blob/master/Lesson4.md" rel="noopener ugc nofollow" target="_blank">详细的课堂笔记</a>，发现了这个:</p><p id="0149" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">"<code class="fe km kn ko kp b">Normalize</code>:提前做一个归一化，就是取连续变量，减去它们的均值，除以它们的标准差。"好吧，那么这就和统计学中的 z 分数一样，所以低于平均值的值为负是有道理的。</p><p id="ef15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我声明我的学习器，告诉 API 它将是一个表格学习器(例如，与卷积神经网络学习器相反)，并保留讲座中使用的参数:</p><p id="eeda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">learn = tabular_learner(data, layers=[200,100], metrics=accuracy)</code></p><p id="004e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我运行<code class="fe km kn ko kp b">learn.fit</code>，得到一个错误:</p><figure class="kq kr ks kt gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi li"><img src="../Images/86f404981806b4b52766c73dbe4acb59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8q14yGDm9qNwlXmPttq-jw.png"/></div></div></figure><p id="15b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看起来<code class="fe km kn ko kp b">accuracy</code>函数中的“参数#2”是<code class="fe km kn ko kp b">targs</code>，但是对我来说不清楚我需要如何修复它。我用谷歌搜索了这个错误，发现了一个关于它的<a class="ae kl" href="https://forums.fast.ai/t/error-pytorch-expected-object-of-scalar-type-long-but-got-scalar-type-float-for-argument-2-other/33778/3" rel="noopener ugc nofollow" target="_blank">帖子</a>。所以没错，<code class="fe km kn ko kp b">targs</code>是“参数#2”，我需要自己做<code class="fe km kn ko kp b">accuracy</code>函数。当我创建一个学习者时，调用了<code class="fe km kn ko kp b">accuracy</code>函数，所以我在其上创建了一个新的单元格，并定义了一个新的精度函数，称为<code class="fe km kn ko kp b">accuracy_long</code>，它与原来的<code class="fe km kn ko kp b">accuracy</code>函数相同，除了第四行的<code class="fe km kn ko kp b">.long()</code>之外:</p><pre class="kq kr ks kt gt ku kp kv kw aw kx bi"><span id="602f" class="ky kz iq kp b gy la lb l lc ld">def accuracy_1ong(input:Tensor, targs:Tensor)-&gt;Rank0Tensor:<br/>    n = targs.shape[0]<br/>    input = input.argmax(dim=-1).view(n,-1)<br/>    targs = targs.view(n,-1).long()<br/>    return (input==targs).float().mean()</span></pre><p id="a944" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">…并按顺序运行两个单元。如果我们没有得到另一个错误，那就没什么意思了，对吗？</p><figure class="kq kr ks kt gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ln"><img src="../Images/705de413b92f931b836e020f900888db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgQRfCrfTBFJtE5XBoGBAw.png"/></div></div></figure><p id="96d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我就像“我也定义了它！看到了吗，就在上面？”</p><p id="a78a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">*几个小时的谷歌搜索和思考，我甚至不能定义一个函数，以后肯定会放弃编码* </em>仔细看看我在上面输入的内容。<code class="fe km kn ko kp b">accuracy_long</code>中的“l”是一个“1”。酷，酷。</p><p id="3269" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我冷冷地盯着电脑看了很久，然后继续重新创建我的学习者并运行<code class="fe km kn ko kp b">learn.fit(1, 1e-2)</code>。看看我的准确率！这与我希望自己的准确率有很大关系，因为它们是完全相反的。🙄</p><figure class="kq kr ks kt gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi lp"><img src="../Images/4f8a05a646679593ee9d51e75d861b21.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*oUChJoXzjYGHF-jm9CplGg.png"/></div></div></figure><p id="fc84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于这个数据集是预先清理过的，上面有一颗樱桃，并且被设计用来准确预测我试图用它来预测的东西，看起来我的准确率应该很高，而不是非常糟糕。所以我在想，是不是不小心把某个地方的一些逻辑颠倒了，把代码梳理了一遍。不过，我什么也没找到。</p><p id="4a01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯。我觉得不可能是这个，但是我会尽量不把数据归一化？不，没有改善。</p><p id="386b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与第 2 课笔记本不同，第 4 课笔记本并不通过拟合几个时期的一个周期来开始学习，也不运行学习率查找器或混淆矩阵。我自己把这些放进去。</p><p id="222e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我创建并运行五个新单元:<code class="fe km kn ko kp b">learn.fit_one_cycle(4)</code>、<code class="fe km kn ko kp b">learn.save(‘stage-1’)</code>、<code class="fe km kn ko kp b">learn.unfreeze()</code>、<code class="fe km kn ko kp b">learn.lr_find()</code>和<code class="fe km kn ko kp b">learn.recorder.plot()</code>。这是学习率图表:</p><figure class="kq kr ks kt gt lf gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/7108622f4bd45f1370d850231852060a.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/format:webp/1*Pg9c_4j6ywlyIrJ29AiQGA.png"/></div></figure><p id="8cab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从图表来看，改变学习率似乎对我没有帮助。</p><p id="f6a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我已经没有主意了，所以我求助于<a class="ae kl" href="https://forums.fast.ai/t/lesson-4-tabular-dataset-with-0-accuracy/55822" rel="noopener ugc nofollow" target="_blank"> fast.ai 论坛</a>。一名成员建议尝试第 6 课中使用的 RMSE(均方根误差)技术，所以我现在暂停一下，在第 6 课结束后再试一次。</p><p id="e921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看<a class="ae kl" href="https://github.com/g0g0gadget/A-Waiter-s-Tips" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上的代码！</p><p id="7b13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于此主题的其他帖子:</p><p id="a81c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一课:<a class="ae kl" rel="noopener" target="_blank" href="/getting-started-with-fast-ai-350914ee65d2">fast . ai 入门</a></p><p id="6f2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二课:<a class="ae kl" rel="noopener" target="_blank" href="/classifying-pregnancy-test-results-99adda4bca4c">对孕检结果进行分类</a>！</p><p id="7cf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二课(续):<a class="ae kl" rel="noopener" target="_blank" href="/can-deep-learning-perform-better-than-pigeons-d37ef1581a2f">深度学习能比鸽子表现更好吗？</a></p><p id="aa86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第三课:<a class="ae kl" rel="noopener" target="_blank" href="/10-000-ways-that-wont-work-311925525cf0">一万种行不通的方法</a></p><p id="fe92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第五课:但是泡菜去哪里了？</p><p id="9999" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第六课:每个人都想成为一只猫</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="1550" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我是加州大学东湾分校的数学讲师，也是一名有抱负的数据科学家。在<a class="ae kl" href="https://linkedin.com/in/laura-langdon/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上和我联系，或者在<a class="ae kl" href="https://twitter.com/laura_e_langdon" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上和我打招呼。</p></div></div>    
</body>
</html>