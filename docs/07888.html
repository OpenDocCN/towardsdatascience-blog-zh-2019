<html>
<head>
<title>Coding in R: Pivot Painlessly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 R: Pivot 轻松编码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/coding-in-r-pivot-painlessly-32e40a0b6c3d?source=collection_archive---------14-----------------------#2019-10-31">https://towardsdatascience.com/coding-in-r-pivot-painlessly-32e40a0b6c3d?source=collection_archive---------14-----------------------#2019-10-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6f15" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">pivot _ longer 和 pivot _ wider 快速指南</h2></div><p id="4769" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我不能<code class="fe le lf lg lh b">gather</code>或者<code class="fe le lf lg lh b">spread</code>。我有某种精神障碍，记不清哪个是哪个。我几乎总是用错，以一些奇怪的笔记本结束，沮丧地关上我的笔记本电脑。所以，感谢 R 神们最近发布的<code class="fe le lf lg lh b">pivot_wider</code>和<code class="fe le lf lg lh b">pivot_longer</code>。我发现它们更加直观，现在可以轻松旋转。</p><h1 id="95d3" class="li lj it bd lk ll lm ln lo lp lq lr ls jz lt ka lu kc lv kd lw kf lx kg ly lz bi translated">转动一些松鼠</h1><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi ma"><img src="../Images/05cd14ee98c215a63aa547f99db90ab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fcRDr3upyClVa-Sq"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk">Photo by <a class="ae mq" href="https://unsplash.com/@cadop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mathew Schwartz</a> on <a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5a92" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了展示 tidyverse 的新枢纽功能，我使用了来自 R4DS 在线学习社区 2019 年 10 月 29 日#TidyTuesday 挑战赛的<a class="ae mq" href="https://www.thesquirrelcensus.com/" rel="noopener ugc nofollow" target="_blank"> 2019 年纽约松鼠普查</a>数据集。</p><pre class="mb mc md me gt mr lh ms mt aw mu bi"><span id="4fda" class="mv lj it lh b gy mw mx l my mz">library(tidyverse)<br/># Load NYC Squirrel Census data set<br/>squirrel &lt;- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-10-29/nyc_squirrels.csv")</span></pre><p id="6045" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我对松鼠的活动感兴趣，特别是哪种颜色的松鼠最友好。有用的变量有<code class="fe le lf lg lh b">approaches</code>、<code class="fe le lf lg lh b">indifferent</code>和<code class="fe le lf lg lh b">runs_from</code>。这些是逻辑的，所以把它们转换成数字。也让<code class="fe le lf lg lh b">primary_fur_color</code>成为一个因素。</p><pre class="mb mc md me gt mr lh ms mt aw mu bi"><span id="2ec1" class="mv lj it lh b gy mw mx l my mz">squirrel_tidy &lt;- squirrel %&gt;% <br/>  select(primary_fur_color, approaches, indifferent, runs_from) %&gt;% <br/>  mutate(primary_fur_color = fct_explicit_na(primary_fur_color, "Unknown")) %&gt;% <br/>  mutate_if(is_logical, ~as.numeric(.))</span></pre><p id="0bb4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了找出每种颜色的松鼠接近、冷漠或逃离松鼠观察者的百分比，我用<code class="fe le lf lg lh b">group_by</code>和<code class="fe le lf lg lh b">summarise_if</code>搭配<code class="fe le lf lg lh b">mean</code>。</p><pre class="mb mc md me gt mr lh ms mt aw mu bi"><span id="0587" class="mv lj it lh b gy mw mx l my mz">friendly &lt;- squirrel_tidy %&gt;% <br/>  group_by(primary_fur_color) %&gt;% <br/>  summarise_if(is.numeric, ~mean(.))</span><span id="800a" class="mv lj it lh b gy na mx l my mz">## # A tibble: 4 x 4<br/>##   primary_fur_color approaches indifferent runs_from<br/>##   &lt;fct&gt;                  &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;<br/>## 1 Black                 0.0583       0.427     0.311<br/>## 2 Cinnamon              0.112        0.462     0.222<br/>## 3 Gray                  0.0510       0.493     0.223<br/>## 4 Unknown               0.0364       0.182     0.145</span></pre><h1 id="3ea5" class="li lj it bd lk ll lm ln lo lp lq lr ls jz lt ka lu kc lv kd lw kf lx kg ly lz bi translated">将宽数据透视为长格式</h1><p id="97ec" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">现在数据是宽格式的，可以转换为长格式了。使用<code class="fe le lf lg lh b">pivot_longer</code>将活动列(<code class="fe le lf lg lh b">approaches</code>、<code class="fe le lf lg lh b">indifferent</code>和<code class="fe le lf lg lh b">runs_from</code>)移动到一列，称为<code class="fe le lf lg lh b">activity</code>。这些列中的值将被移动到一个名为<code class="fe le lf lg lh b">pct_activity</code>的列中。</p><pre class="mb mc md me gt mr lh ms mt aw mu bi"><span id="d296" class="mv lj it lh b gy mw mx l my mz">friendly_long &lt;- friendly %&gt;% <br/>  pivot_longer(cols = c("approaches", "indifferent", "runs_from"), <br/>               names_to = "activity", <br/>               values_to = "pct_activity")</span><span id="1130" class="mv lj it lh b gy na mx l my mz">## # A tibble: 5 x 3<br/>##   primary_fur_color activity    pct_activity<br/>##   &lt;fct&gt;             &lt;chr&gt;              &lt;dbl&gt;<br/>## 1 Black             approaches        0.0583<br/>## 2 Black             indifferent       0.427 <br/>## 3 Black             runs_from         0.311 <br/>## 4 Cinnamon          approaches        0.112 <br/>## 5 Cinnamon          indifferent       0.462</span></pre><p id="af45" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">瞧啊。整洁的数据，非常适合用<code class="fe le lf lg lh b">ggplot</code>绘图。</p><h1 id="2024" class="li lj it bd lk ll lm ln lo lp lq lr ls jz lt ka lu kc lv kd lw kf lx kg ly lz bi translated">逆转它</h1><p id="c156" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">要从长格式转换到宽格式，可能因为你要做一些建模，所以需要专栏中的特性，使用<code class="fe le lf lg lh b">pivot_wider</code>。</p><pre class="mb mc md me gt mr lh ms mt aw mu bi"><span id="9c8c" class="mv lj it lh b gy mw mx l my mz">friendly_wide &lt;- friendly_long %&gt;% <br/>  pivot_wider(names_from = "activity", <br/>              values_from = "pct_activity")</span><span id="a791" class="mv lj it lh b gy na mx l my mz">## # A tibble: 4 x 4<br/>##   primary_fur_color approaches indifferent runs_from<br/>##   &lt;fct&gt;                  &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;<br/>## 1 Black                 0.0583       0.427     0.311<br/>## 2 Cinnamon              0.112        0.462     0.222<br/>## 3 Gray                  0.0510       0.493     0.223<br/>## 4 Unknown               0.0364       0.182     0.145</span></pre><h1 id="1cfa" class="li lj it bd lk ll lm ln lo lp lq lr ls jz lt ka lu kc lv kd lw kf lx kg ly lz bi translated">但是哪种颜色的松鼠最友好呢？</h1><p id="f95d" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">由<code class="fe le lf lg lh b">activity</code>刻面的<code class="fe le lf lg lh b">pct_activity</code>对<code class="fe le lf lg lh b">primary_fur_color</code>的绘图显示，肉桂松鼠最有可能接近(滚动到底部查看代码)。</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi ng"><img src="../Images/4f621ab6d5bcd217c7975a0cd3d8392f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dlS8tY-TBXikifXaEvPu6Q.png"/></div></div></figure><h1 id="75a1" class="li lj it bd lk ll lm ln lo lp lq lr ls jz lt ka lu kc lv kd lw kf lx kg ly lz bi translated">TLDR；</h1><p id="5e19" class="pw-post-body-paragraph ki kj it kk b kl nb ju kn ko nc jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated"><code class="fe le lf lg lh b">pivot_longer</code>将多列转换成两列，创建一个整洁的数据格式。<code class="fe le lf lg lh b">pivot_wider</code>则相反。</p><p id="45ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">pivot_longer</code>需要四个输入:</p><ol class=""><li id="538a" class="nh ni it kk b kl km ko kp kr nj kv nk kz nl ld nm nn no np bi translated"><code class="fe le lf lg lh b">data</code>。</li><li id="bfe7" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated"><code class="fe le lf lg lh b">cols =</code>选中的列要变成两列。</li><li id="9066" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated"><code class="fe le lf lg lh b">names_to =</code>新创建的列的名称，其中观察值将是您选择的所有列的名称。</li><li id="9ffb" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated"><code class="fe le lf lg lh b">values_to =</code>包含所有值的新创建列的名称</li></ol><p id="ad1e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe le lf lg lh b">pivot_wider</code>需要三个输入:</p><ol class=""><li id="5656" class="nh ni it kk b kl km ko kp kr nj kv nk kz nl ld nm nn no np bi translated"><code class="fe le lf lg lh b">data</code>。</li><li id="01c0" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated"><code class="fe le lf lg lh b">names_from =</code>列名谁的观察值将成为新的列名。</li><li id="da27" class="nh ni it kk b kl nq ko nr kr ns kv nt kz nu ld nm nn no np bi translated"><code class="fe le lf lg lh b">values_from =</code>列名谁的观测值将成为新的列观测值。</li></ol><h1 id="0530" class="li lj it bd lk ll lm ln lo lp lq lr ls jz lt ka lu kc lv kd lw kf lx kg ly lz bi translated">绘图代码</h1><pre class="mb mc md me gt mr lh ms mt aw mu bi"><span id="eb93" class="mv lj it lh b gy mw mx l my mz">squirrel_plot_theme &lt;- theme_minimal() +<br/>  theme(axis.title.x = element_text(size = 10),<br/>        axis.title.y = element_text(size = 10),<br/>        plot.title = element_text(size = 14, face = "bold", family = "mono"),<br/>        plot.subtitle = element_text(size = 10, face = "bold", family = "mono"),<br/>        plot.caption = element_text(size = 10, face = "italic", hjust = 0))</span><span id="abbd" class="mv lj it lh b gy na mx l my mz"># Create caption to correctly source all plots<br/>squirrel_caption &lt;- "Data from Squirrel Census 2019"</span><span id="49c0" class="mv lj it lh b gy na mx l my mz"># Create colour palette<br/>squirrel_pal &lt;- wes_palette("IsleofDogs1", 6, type = "continuous")</span><span id="2184" class="mv lj it lh b gy na mx l my mz">friendly_plot &lt;- friendly_long %&gt;% <br/>  group_by(primary_fur_color) %&gt;% <br/>  ggplot()+<br/>  geom_col(aes(x = activity, y = pct_activity, fill = primary_fur_color)) +<br/>  facet_wrap(~primary_fur_color) +<br/>  squirrel_plot_theme +<br/>  scale_fill_manual(values = c(squirrel_pal[4], squirrel_pal[2], <br/>                                squirrel_pal[6], squirrel_pal[3]), name = "") +<br/>  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(-0.05, 0.5)) +<br/>  theme(axis.text.x = element_text(angle = 0), <br/>        panel.grid.minor = element_blank(),<br/>        legend.position = "none") +<br/>  labs(title = "Cinnamon squirrels are the friendliest",<br/>       subtitle = "Percentage of squirrels reported as approaching, being indifferent to or running from their squirrel spotter\n",<br/>       x = "",<br/>       y = "",<br/>       caption = squirrel_caption)</span></pre></div></div>    
</body>
</html>