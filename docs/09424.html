<html>
<head>
<title>Realtime Data in Apache Druid — Choosing the Right Strategy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Druid 中的实时数据—选择正确的策略</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/realtime-data-in-apache-druid-choosing-the-right-strategy-cd1594dc66e0?source=collection_archive---------14-----------------------#2019-12-12">https://towardsdatascience.com/realtime-data-in-apache-druid-choosing-the-right-strategy-cd1594dc66e0?source=collection_archive---------14-----------------------#2019-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4c5f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">为什么你应该使用卡夫卡索引而不是宁静</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6f5784e9f82266de85140e560e8e8b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VzOXKMpAVzm--Smx"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@lukechesser?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Luke Chesser</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="901f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在实时数据流中存储数据一直是一个挑战。解决方案取决于您的使用案例。如果你想为每日或每月的分析存储数据，你可以使用分布式文件系统，并在其上运行<a class="ae kv" href="https://hive.apache.org/" rel="noopener ugc nofollow" target="_blank"> Hive </a>或<a class="ae kv" href="https://prestodb.io/" rel="noopener ugc nofollow" target="_blank"> Presto </a>。如果你要运行一些简单的实时分析，你可以将最近的数据存储在<a class="ae kv" href="https://www.elastic.co/what-is/elasticsearch" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>中，并运行<a class="ae kv" href="https://www.elastic.co/products/kibana" rel="noopener ugc nofollow" target="_blank"> Kibana </a>来获取图表。</p><p id="881c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://druid.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Druid </a>是为了同时解决上述两种用例而设计的。它可以作为每日或每月分析的持久数据存储。它还可以作为快速可查询数据存储，允许您实时推送和检索数据。</p><p id="0a3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，早期版本的 Apache druid 的问题是从数据库的流中获取数据。让我们来看看开发人员早先面临的挑战。</p><h1 id="cba0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">平静</h1><p id="fb1a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><a class="ae kv" href="https://druid.apache.org/docs/latest/ingestion/tranquility.html" rel="noopener ugc nofollow" target="_blank">宁静</a>是 Apache Druid 提供的摄取实时数据的包。宁静并不完全等同于 JDBC 或卡珊德拉司机。它为您处理分区、复制、服务发现和模式翻转。用户需要关心他需要使用的数据和数据源。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/2ee1cbd8f362024d6fc0a3fd3a732086.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6PWpjK805LG0CrMqeM0cjQ.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Ingesting realtime data using Tranquility</figcaption></figure><p id="caae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">宁静解决了用户可能面临的许多问题。然而，它也伴随着自身的一系列挑战。</p><h2 id="56d1" class="mq lt iq bd lu mr ms dn ly mt mu dp mc lf mv mw me lj mx my mg ln mz na mi nb bi translated">不完全是一次</h2><p id="529f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在某些情况下，宁静会创建重复的记录。它不提供任何一次性的保证。在某些情况下，比如 POST 请求数据超时或者没有收到 ack，宁静会产生重复的记录。</p><p id="b5e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，用户需要承担消除重复数据的责任。如果您正在使用 Apache 超集，它甚至会导致其中的图形不正确。</p><h2 id="1351" class="mq lt iq bd lu mr ms dn ly mt mu dp mc lf mv mw me lj mx my mg ln mz na mi nb bi translated">数据丢失</h2><p id="3c8a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">宁静最关心的问题是数据丢失。有各种情况下，宁静故意或由于错误无法插入数据。<a class="ae kv" href="https://github.com/druid-io/tranquility/blob/master/docs/overview.md" rel="noopener ugc nofollow" target="_blank">官方文件</a>中列出的一些案例是—</p><ul class=""><li id="6d79" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated">时间戳超出您配置的<strong class="ky ir">窗口周期</strong>的事件将被丢弃。</li><li id="1463" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">如果您遇到的 Druid 中级管理器故障多于您配置的副本数，一些部分索引的数据可能会丢失。</li><li id="4e4a" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">如果有一个持续的问题阻止了与 Druid 索引服务的通信，并且重试策略在此期间用尽，或者此期间持续的时间超过了您的<strong class="ky ir"> windowPeriod </strong>，一些事件将被丢弃。</li><li id="ae22" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">如果有一个问题阻止了宁静从索引服务接收确认，它将重试批处理，这可能导致重复的事件。</li></ul><p id="2243" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最糟糕的是，在大多数情况下，直到查询时，您才知道您的数据已经被删除。</p><h2 id="bfd5" class="mq lt iq bd lu mr ms dn ly mt mu dp mc lf mv mw me lj mx my mg ln mz na mi nb bi translated">错误处理</h2><p id="cc9d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">因为宁静守护进程运行在 JVM 内部，所以处理超时之类的错误是应用程序的责任。对于像 Apache Flink 这样的应用程序，如果不能有效地管理其中一个错误，就会导致不必要的重启。</p><p id="79b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在所有这些问题之上，宁静是为德鲁伊 0.9.2 构建的。将它与当前的 druid 版本 0.16.0 一起使用会产生无法识别的问题。</p><h1 id="bb8e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">卡夫卡索引</h1><p id="6b6c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了解决上述所有问题，Apache druid 在 0.9.1 版本中添加了 Kafka Indexer。在版本 0.14 之前，索引器一直处于<strong class="ky ir">实验</strong>状态。</p><p id="6a93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka 索引服务首先根据您指定的配置启动一个管理程序。然后，管理员会定期启动新的索引任务，这些任务负责从 Kafka 消费数据，并将其发布到 Druid 中。</p><p id="42e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与宁静不同，Kafka 索引任务可以长期运行。在达到最小行数或字节数后，可以发布多个段，而无需启动新任务。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/705bc25fac43fca21cda2aa3373dc41e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ugY-KoYhAQjtKuusI1aocA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Kafka Indexer in Apache Druid</figcaption></figure><p id="ded9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">卡夫卡索引器旨在解决其前辈所面临的各种挑战。</p><h2 id="1410" class="mq lt iq bd lu mr ms dn ly mt mu dp mc lf mv mw me lj mx my mg ln mz na mi nb bi translated">恰好一次语义</h2><p id="5c53" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Kafka 索引器为用户提供了一次精确的保证。这种保证是可能的，因为 Kafka 0.11.x 提供了对这种语义的现成支持。</p><h2 id="01dc" class="mq lt iq bd lu mr ms dn ly mt mu dp mc lf mv mw me lj mx my mg ln mz na mi nb bi translated">发布延迟的数据</h2><p id="1c92" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Kafka 索引器旨在发布延迟的数据。它不受宁静窗口期的影响。这种能力让用户可以自由地将 Kafka 中特定偏移量的数据回填到 Druid 中。</p><h2 id="74ae" class="mq lt iq bd lu mr ms dn ly mt mu dp mc lf mv mw me lj mx my mg ln mz na mi nb bi translated">模式更新</h2><p id="1b50" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">尽管宁静也支持模式更新，但在 Kafka Indexer 中要容易得多。您只需要提交一个包含新模式的 POST 请求，主管将使用更新后的模式生成新任务。你不需要在生产者端做任何改变。<br/>如果您添加了新的列，旧的行将在这些列中显示空值，但是这些行仍然是可查询的。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="0532" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka 索引器服务解决了开发人员在使用宁静时面临的许多问题。如果你想开始使用 Kafka 索引服务，你可以参考官方 Druid 文档中的<a class="ae kv" href="https://druid.apache.org/docs/latest/development/extensions-core/kafka-ingestion.html" rel="noopener ugc nofollow" target="_blank"> Apache Kafka 摄取</a>。</p></div></div>    
</body>
</html>