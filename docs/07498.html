<html>
<head>
<title>User churn prediction using Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Spark 进行用户流失预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/user-churn-prediction-using-spark-22ff8dafb5c?source=collection_archive---------28-----------------------#2019-10-19">https://towardsdatascience.com/user-churn-prediction-using-spark-22ff8dafb5c?source=collection_archive---------28-----------------------#2019-10-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5ea2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Udacity 数据科学家纳米学位计划顶点项目</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d0bff288ae5c19ea062a5f3895b45f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXT286bKR39T7gzcsuCEkw.png"/></div></div></figure><p id="b83a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该项目是<a class="ae lq" href="https://eu.udacity.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> Udacity </strong> </a> <strong class="kw iu">数据科学家纳米学位项目:数据科学家顶点计划的最终项目。</strong>目标是预测用户是否会从虚拟的数字音乐服务中流失<strong class="kw iu"> Sparkify </strong></p><p id="909a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">流失预测是商业中最受欢迎的<strong class="kw iu">大数据</strong>用例之一。正如这篇<a class="ae lq" href="https://neilpatel.com/blog/improve-by-predicting-churn/" rel="noopener ugc nofollow" target="_blank">帖子</a>中更好地解释的那样，它的目标是确定客户是否会取消他的服务订阅</p><p id="eda1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们从使用<strong class="kw iu"> CRISP-DM 流程</strong>(数据挖掘的跨行业流程)开始:</p><ol class=""><li id="cf6c" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated"><strong class="kw iu">业务理解</strong></li><li id="d40c" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">数据理解</strong></li><li id="54d5" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">准备资料</strong></li><li id="1b0e" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">数据建模</strong></li><li id="83e1" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">评估结果</strong></li><li id="3a87" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><strong class="kw iu">展开</strong></li></ol><p id="3989" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">业务理解</strong></p><p id="9051" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Sparkify 是一项数字音乐服务，可以免费使用，方法是在歌曲之间收听一些广告，或者支付每月订阅费以获得无广告体验。在任何时候，用户都可以决定从高级降级到免费，从免费升级到高级或者取消服务。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/b3e4a03d1201cb8a921003385f2a5935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*40ChQDOytSMunZvKUIQnzA.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk"><a class="ae lq" href="https://www.udacity.com/course/data-scientist-nanodegree--nd025" rel="noopener ugc nofollow" target="_blank">https://www.udacity.com/course/data-scientist-nanodegree--nd025</a></figcaption></figure><p id="e4ff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">数据理解</strong></p><p id="05e9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所提供的数据集基本上由平台上每个用户操作的日志组成。每个动作都标有时间戳<strong class="kw iu"> ts </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/d94256b466506a8177e0e4db75f72bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:682/format:webp/1*poPjeLQw_i8gs7hfDta5qg.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Dataset attributes</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/53170e1f8a6122303d15e7f10262989e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lDzTczoW3Qg64u7TcrPxcA.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">First 5 records as example</figcaption></figure><p id="1206" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个小数据集中，我们有来自 225 个用户的 286500 条记录:</p><p id="08f8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">46%的女性和 54%的男性</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/a90c0670518063e8fa1bc8f57d2ffdde.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*oBGMNDEIzNQyUFTzy_bxJQ.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Gender distribution in the small dataset</figcaption></figure><p id="7333" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">54%的互动来自免费用户，46%来自高级用户</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/e067bb43780c9faa3f509853aed86f83.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/1*e-ZSzRf1wip2n72g0aqPKg.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Level distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/42d21c57f62aaa0602cfb577c69aa0f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bbMg_NrBu8SXisYeOTfNfw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Page distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/b3e76bb79016d34f5232833773a7060e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*5fYeMjNAouLqnlPBAbhT7g.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">% page distribution in the small dataset</figcaption></figure><p id="a818" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这些记录的时间跨度从 2018 年 10 月到 2018 年 12 月</p><p id="ed77" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">准备数据</strong></p><p id="b6a0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第一步是删除所有用户 Id 为空的记录。空字符串<strong class="kw iu"> userId </strong>很可能指的是尚未注册的用户，或者已经注销并即将登录的用户，因此我们可以删除这些记录。</p><p id="6289" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后我定义了一个新的<code class="fe mq mr ms mt b">Churn</code>列，它将被用作模型的标签。基本上，如果用户曾经访问过<code class="fe mq mr ms mt b">Cancellation Confirmation</code>页面，我们会将其标记为搅动。当然，这个事件对于付费和免费用户都可能发生。</p><p id="4591" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们获得了 23%的流失用户和 77 %的未流失用户，因此数据集非常不平衡。正如这篇精彩的<a class="ae lq" href="http://www.davidsbatista.net/blog/2018/08/19/NLP_Metrics/" rel="noopener ugc nofollow" target="_blank">帖子</a>中所解释的，当我们在<strong class="kw iu">评估结果</strong>部分讨论指标时，我们必须记住这一点</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/ee35ad10919255bcaa4bb180a3fcbbd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*6jkRTrSRRHK0K77aOHYd8w.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn distribution in the small dataset</figcaption></figure><p id="3a25" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我对一些特性进行了比较，同时也考虑了<code class="fe mq mr ms mt b">Churn</code>值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/863619e8fcfeb8fe1914d2d4de94c8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*K2rA47fK3RYyNNuRE1YlLA.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn Gender distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/2c891ccb546ec915c36ddf7e163604e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:794/format:webp/1*mF_wmFny27DGDAZjqzVD-A.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn Level distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/d5d87c82d72c1a17cb4e44634a56cf9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBym02VvKOpa9zJk6TTD8w.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn Page distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi my"><img src="../Images/5a2b3f5d071c436a0ea77e84907568c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*Mahj6rjKHvgvyyZ6aeP05g.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">% churn page distribution in the small dataset</figcaption></figure><p id="d3c3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">数据建模</strong></p><p id="18f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所有对我们的任务有用的分类特征都已经通过<strong class="kw iu">用户 Id </strong> : <br/> -性别<br/> -级别<br/> -页面进行了一次性编码和聚合</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/aa3ae8dd840147cbb2feff1f908436d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*ApCrrlSVd6AhPGuFxGdw1w.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Engineered dataset attributes</figcaption></figure><p id="7fed" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们通过提出以下问题添加了一些有趣的工程特性:<br/> -用户订阅该服务多久了？流失与此有关吗？<br/> -上个月的活动(对于不满意的用户，取消是取消前的最后一个月)以周为单位划分<br/> -一个用户听了多少艺术家的音乐？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/a25b0a4f2d712c9ffcd2f7c4f2457223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBiLairoBgMcFTHITwOcQw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn Registration days distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/f75b4b6b39e8ab87870ca094c081b251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pBxVBctbiiV4znKDd4S8iw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn Last week average activity distribution in the small dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/a833b91f18c0c5e15c6e5f401337c290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l9wROpWHbAIyJzmOnCiDwA.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Churn Artist distribution in the small dataset</figcaption></figure><p id="4871" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为 ML 准备的最终数据集如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/e8ffb3e2df5e8c07a1775a8e5e93c7f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*I86TOpz_THehjHYh3emb5w.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Engineered dataset attributes in input to the model</figcaption></figure><p id="0955" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">重要的是不要考虑像<code class="fe mq mr ms mt b">page_Cancellation_Confirmation</code>或<code class="fe mq mr ms mt b">page_Cancel</code>这样的属性，因为它们精确地映射了标签列，所以准确率总是 100%，因为我们基本上是在学习我们想要预测的值</p><p id="80de" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">评估结果</strong></p><p id="0cf9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">混淆矩阵</strong>是一个表格，通常用于描述一个分类模型对一组真实值已知的测试数据的性能。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/3e6f4fcbcf895a43b31b015d7b339a04.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*MIDMRk9qs2fe_vEDvJfYcQ.png"/></div></figure><p id="af35" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">准确性</strong>衡量分类器做出正确预测的频率。它是正确预测数与总预测数的比率:</p><p id="9390" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mq mr ms mt b">Accuracy = (True Positives + True Negative) / (True Positives + False Positives + True Negatives + False Negatives)</code></p><p id="3636" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">精度告诉我们正确的预测中有多少是正确的。它是真阳性与所有阳性的比率:</p><p id="c78a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mq mr ms mt b">Precision = True Positives / (True Positives + False Positives)</code></p><p id="b352" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">回忆(敏感度)告诉我们实际上正确预测中有多少被我们归类为正确的。它是真阳性与所有实际阳性预测的比率:</p><p id="390e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mq mr ms mt b">Recall = True Positives / (True Positives + False Negative)</code></p><p id="e420" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> F-beta 评分</strong>是一个同时考虑精确度和召回率的指标:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/4199dad8f00e50e0c4499a0066c01d34.png" data-original-src="https://miro.medium.com/v2/resize:fit:522/format:webp/1*S7EKQOEPDcAYMXEJYiHe3g.png"/></div></figure><p id="b723" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">生成<strong class="kw iu">朴素预测器</strong>的目的只是为了显示没有任何智能的基础模型是什么样子。如前所述，通过观察数据的分布，很明显大多数用户不会流失。因此，总是预测<code class="fe mq mr ms mt b">'0'</code>(即用户不访问页面<code class="fe mq mr ms mt b">Cancellation Confirmation</code>)的模型通常是正确的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/7c721fb88a61ff3af2892b6825b2be04.png" data-original-src="https://miro.medium.com/v2/resize:fit:478/format:webp/1*dqVjIpOvg00irbFfFmxFkg.png"/></div></figure><p id="e299" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将所有用户标记为流失= 0 的朴素模型在测试集上做得很好，准确率为 81.2%，F1 分数为 0.7284</p><p id="1e35" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">数据集不平衡的事实也意味着<strong class="kw iu">精确度</strong>没有太大帮助，因为即使我们获得高精确度，实际预测也不一定那么好。在这种情况下，通常建议使用<strong class="kw iu">精度</strong>和<strong class="kw iu">召回</strong></p><p id="2d4c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们比较 3 个模型的结果:</p><ul class=""><li id="19cd" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp nh lx ly lz bi translated"><strong class="kw iu">逻辑回归</strong></li><li id="ef04" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp nh lx ly lz bi translated"><strong class="kw iu">梯度提升树</strong></li><li id="9788" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp nh lx ly lz bi translated"><strong class="kw iu">支持向量机</strong></li></ul><p id="0233" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第一步是删除培训中不必要的列</p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="876a" class="nm nn it mt b gy no np l nq nr">colonne = df.columns[1:-1]<br/>colonne</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/24ea5715d2d17f081e7ae1b65d13a598.png" data-original-src="https://miro.medium.com/v2/resize:fit:368/format:webp/1*CcBckBuMVBkADLP3Oucxvw.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Features used for ML training</figcaption></figure><p id="27e3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后所有的特征都被矢量化(不需要转换，因为所有的特征都是数字)</p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="7277" class="nm nn it mt b gy no np l nq nr">assembler = VectorAssembler(inputCols = colonne, outputCol = ‘features’)</span><span id="170b" class="nm nn it mt b gy nt np l nq nr">data = assembler.transform(df)</span></pre><p id="f411" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mq mr ms mt b">StandarScaler()</code>用于缩放数据</p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="0f50" class="nm nn it mt b gy no np l nq nr">scaler = StandardScaler(inputCol = 'features', outputCol = 'scaled_features', withStd = True)</span><span id="4512" class="nm nn it mt b gy nt np l nq nr">scaler_model = scaler.fit(data)</span><span id="41c1" class="nm nn it mt b gy nt np l nq nr">data = scaler_model.transform(data)</span></pre><p id="cca2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我将数据分为训练、测试和验证数据集</p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="720b" class="nm nn it mt b gy no np l nq nr">train, rest = data.randomSplit([0.6, 0.4], seed = 42)</span><span id="c173" class="nm nn it mt b gy nt np l nq nr">validation, test = rest.randomSplit([0.5, 0.5], seed = 42)</span></pre><p id="e82b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于所有车型，我都使用了 F1 分数作为衡量标准</p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="ee43" class="nm nn it mt b gy no np l nq nr">f1_evaluator = MulticlassClassificationEvaluator(metricName = ‘f1’)</span></pre><p id="d5cc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以及<code class="fe mq mr ms mt b">ParamGridBuilder()</code>和 3 倍<code class="fe mq mr ms mt b">CrossValidator()</code>来确定考虑所有参数的模型的最佳超参数</p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="6ca8" class="nm nn it mt b gy no np l nq nr">param_grid = ParamGridBuilder().build()</span></pre><p id="318c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">逻辑回归</strong></p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="7483" class="nm nn it mt b gy no np l nq nr">logistic_regression = LogisticRegression(maxIter = 10)</span><span id="8f40" class="nm nn it mt b gy nt np l nq nr">crossvalidator_logistic_regression = CrossValidator(  <br/>estimator = logistic_regression,                                 evaluator = f1_evaluator,                                                    estimatorParamMaps = param_grid,                                                    numFolds = 3)</span><span id="9952" class="nm nn it mt b gy nt np l nq nr">cv_logistic_regression_model = crossvalidator_logistic_regression.fit(train)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/917605b92f9e6acfc825cebd327b01c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p75dkR8s3N-7VwtYFdIHlA.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Best parameters</figcaption></figure><p id="e22f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">梯度提升树</strong></p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="53fb" class="nm nn it mt b gy no np l nq nr">gradient_boosted_trees = GBTClassifier(maxIter = 10, seed = 42)</span><span id="8908" class="nm nn it mt b gy nt np l nq nr">crossvalidator_gradient_boosted_trees = CrossValidator(<br/>estimator = gradient_boosted_trees,                                                       evaluator = f1_evaluator,                                                       estimatorParamMaps = param_grid,                                                       numFolds = 3)</span><span id="f30f" class="nm nn it mt b gy nt np l nq nr">cv_gradient_boosted_trees_model = crossvalidator_gradient_boosted_trees.fit(train)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/a96c8c3255f7e8abd5d999368fac86e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*87CghKxHbvpXpp3B0bycOA.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Best parameters</figcaption></figure><p id="931d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">GBT 也允许看到特性的重要性:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/edcbf3929d8094f1cf7f11320660c6dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gD8-F2YTL0uvgSY-i5ASnQ.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Feature importances from GBT</figcaption></figure><p id="9c75" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以看到<code class="fe mq mr ms mt b">registration_days</code>和<code class="fe mq mr ms mt b">count_page_last_week</code>具有最高的重要性</p><p id="7000" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">支持向量机</strong></p><pre class="kj kk kl km gt ni mt nj nk aw nl bi"><span id="abd4" class="nm nn it mt b gy no np l nq nr">linear_svc = LinearSVC(maxIter = 10)</span><span id="827d" class="nm nn it mt b gy nt np l nq nr">crossvalidator_linear_svc = CrossValidator(<br/>estimator = linear_svc,                                           evaluator = f1_evaluator,                                           estimatorParamMaps = param_grid,                                           numFolds = 3)</span><span id="6624" class="nm nn it mt b gy nt np l nq nr">cv_linear_svc_model = crossvalidator_linear_svc.fit(train)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/47b175f5f675593686dfe15c92bcc702.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-JWMULqmlrAd_FOlq1EtDw.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Best parameters</figcaption></figure><p id="e094" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">总的来说，<strong class="kw iu">逻辑回归</strong>具有最好的结果，在测试数据集上<strong class="kw iu"> F-1 得分</strong>为 0.8218，在验证数据集上为 0.7546</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/f12348050650c0be4c29b0b716c3e7d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*zWEFLAiOG6NYKNfbfqV5iQ.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Results on test and validation datasets</figcaption></figure><p id="a179" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">细化</strong></p><p id="417f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我第一次尝试手动调整模型的一些参数，但是通过让<code class="fe mq mr ms mt b">ParamGridBuilder()</code>和<code class="fe mq mr ms mt b">CrossValidator()</code>搜索所有参数获得了最佳结果</p><p id="cea7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">部署</strong></p><p id="406c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根据 DSND 顶点项目的<strong class="kw iu">云部署说明的建议，我已经用<a class="ae lq" href="https://aws.amazon.com" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> AWS </strong> </a>创建了一个集群</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/019eee5a9b99ba6ad3e6eed70e4ce89c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QyzPx8bDTljCmbIifRflKw.jpeg"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">My cluster configuration</figcaption></figure><p id="34fa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如这里更好地解释的<a class="ae lq" href="https://aws.amazon.com/blogs/aws/aws-update-new-m3-features-reduced-ebs-prices-reduced-s3-prices/" rel="noopener ugc nofollow" target="_blank"/><strong class="kw iu">m3 . xlarge</strong>是第二代通用<strong class="kw iu"> EC2 </strong>实例，配备了高频<strong class="kw iu">英特尔至强 E5–2670</strong>和 2 个基于 40 GB 固态硬盘的实例存储</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/3c1079d44d129b25c6e44ba20eee7fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B3vVpD8jJCAbxkWOh2PtYw.jpeg"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">My cluster summary</figcaption></figure><p id="8b8b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后我创建了一个笔记本并复制粘贴了必要的代码</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/92f25c760bab48b37037a4b788aa75d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bt0ASMz8xP-ymyt_w7G8aA.jpeg"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">sparkify notebook summary</figcaption></figure><p id="8708" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在真实数据集上，我们有来自 22278 个用户的 26259199 条记录:</p><p id="a380" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">47%的女性和 53%的男性</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/a1ddd547adb17ea9f2392bfd87ca93f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:302/format:webp/1*tXAwwIyGawQlAwyFkQpgbw.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Gender distribution in the full dataset</figcaption></figure><p id="2a5c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">21%的互动来自免费用户，79%来自高级用户</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/4d3af7fe8b1b589e31876bf591263894.png" data-original-src="https://miro.medium.com/v2/resize:fit:268/format:webp/1*Ugh1CZ92mEi8uyK3xhHzmw.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Level distribution in the full dataset</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/04dfaac0b9aaa85f642fcdde7adbdb8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*WW-EkVU5VKNbjn4s9ao9sg.png"/></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">Page distribution in the full dataset</figcaption></figure><p id="2ce1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">22%的用户感到不适，78 %没有</p><p id="45d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个小数据集很好地代表了真实数据集，这意味着它似乎没有偏见</p><p id="f0e1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">结论</strong></p><p id="2962" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的目标是预测用户是否会取消服务，以使公司能够为他提供优惠或折扣，从而留住这些用户。在清理数据并将它们建模为准备用于 ML 训练的数据集之后，我们测试了三个不同模型的性能。所有产生的模型都成功地预测了用户是否会离开服务，比给出总是答案的<code class="fe mq mr ms mt b">'0'</code>(用户不会流失)的<strong class="kw iu">天真预测器</strong>好不了多少。考虑到<strong class="kw iu"> F-1 得分</strong>最好的模型是<strong class="kw iu">逻辑回归。</strong>尽管结果很好，但该模型可以通过精心设计更多的工程特征来捕捉一些可能与用户对服务的满意度相关的行为模式来改进:推荐引擎好吗？意思是推荐给用户的歌真的符合他们的口味。从<strong class="kw iu"> GBT </strong>的功能重要性来看，原始功能<code class="fe mq mr ms mt b">page_Thumbs_Up</code>和<code class="fe mq mr ms mt b">page_Thumbs_Down</code>相当重要，因此捕捉用户音乐品味的新功能确实可以改善模型</p><p id="6525" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个项目的代码可以在这个 github <a class="ae lq" href="https://github.com/simonerigoni/data_scientist_capstone" rel="noopener ugc nofollow" target="_blank">资源库</a>中找到，在我的博客上有一个意大利语的<a class="ae lq" href="https://simonerigoni01.blogspot.com/2023/01/previsione-dellabbandono-degli-utenti.html" rel="noopener ugc nofollow" target="_blank">帖子</a>。</p></div></div>    
</body>
</html>