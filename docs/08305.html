<html>
<head>
<title>Google vision API for image analysis with python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 python 进行图像分析的 Google vision API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/google-vision-api-for-image-analysis-with-python-d3a2e45913d4?source=collection_archive---------19-----------------------#2019-11-12">https://towardsdatascience.com/google-vision-api-for-image-analysis-with-python-d3a2e45913d4?source=collection_archive---------19-----------------------#2019-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ad04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谷歌视觉 API 使用预先训练的机器学习模型从图像中检测物体、人脸、印刷和手写文本。您可以将每个图像上传到该工具并获取其内容。但是，如果您的本地桌面上有大量图像，那么使用 python 向 API 发送请求是非常可行的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/0147f2a985f46da7e340541bded7bcb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rZeH9rmpv_D1JHaHTaikYw.png"/></div></div></figure><p id="02b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章讲述了如何使用 python 和 google cloud sdk 创建图像，将图像上传到 google bucket，对大型图像数据集执行标签检测。“gsutil”用于快速上传图片，并在 google bucket 上设置生命周期。所有图像都用批处理进行分析。</p><p id="e086" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第一步:创建一个项目</strong></p><p id="2777" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按照下面链接中的步骤创建一个新项目，并启用 google vision AI。将密钥存储在 JSON 文件中。</p><div class="kx ky gp gr kz la"><a href="https://cloud.google.com/vision/docs/before-you-begin" rel="noopener  ugc nofollow" target="_blank"><div class="lb ab fo"><div class="lc ab ld cl cj le"><h2 class="bd ir gy z fp lf fr fs lg fu fw ip bi translated">开始之前|云视觉 API 文档|谷歌云</h2><div class="lh l"><h3 class="bd b gy z fp lf fr fs lg fu fw dk translated">在您可以使用 Cloud Vision API 之前，您必须为您的项目启用它:登录您的 Google 帐户。如果你…</h3></div><div class="li l"><p class="bd b dl z fp lf fr fs lg fu fw dk translated">cloud.google.com</p></div></div></div></a></div><p id="7f8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第二步:下载 google cloud sdk 和 gsutil </strong></p><p id="7445" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Gsutil 工具有助于将大型图像数据集轻松上传到 google bucket。在命令提示符或终端中运行以下代码</p><p id="2201" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【https://sdk.cloud.google.com】<a class="ae lk" href="https://sdk.cloud.google.com" rel="noopener ugc nofollow" target="_blank"><em class="lj"/></a><em class="lj">|迎头痛击</em></p><p id="74ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外，您也可以从以下链接下载 sdk</p><p id="5b57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MAC OS:<a class="ae lk" href="https://cloud.google.com/sdk/docs/quickstart-macos" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sdk/docs/quickstart-macos</a>(将文件夹存放在主目录中)</p><p id="9023" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">windows<a class="ae lk" href="https://cloud.google.com/sdk/docs/quickstart-windows" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sdk/docs/quickstart-windows</a></p><p id="84ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第三步:设置配置:</strong></p><p id="b4fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要以下命令来连接到您在步骤 1 中创建的 google cloud 项目。在终端中键入以下内容</p><p id="03b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lj"> gcloud init </em></p><p id="e51f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择要使用的配置:选择“创建新配置”</p><p id="ce2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择一个帐户来执行操作:如果您没有看到您的 gmail 帐户，请选择“使用新帐户登录”并登录该帐户。</p><p id="3e08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择要使用的云项目:您应该看到您在步骤 1 中创建的项目并选择它</p><p id="3a22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第四步:上传图片到谷歌云存储</strong></p><p id="51af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建存储桶:<em class="lj">gsutil MB ' GS://bucket name '</em>(存储桶名称应该是唯一的)</p><p id="6309" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将图像文件夹从本地桌面上传到 google bucket:</p><p id="7ae8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lj">gsutil-m CP-R ' path/to/image folder ' ' GS://bucket name '</em></p><p id="e694" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第五步:在 google bucket 中获取图片标签</strong></p><p id="17da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你已经有了桶中的所有图像，使用' ImageAnnotatorClient '获取标签。如果你有很多图像，那么遍历桶中的每一个图像将会非常耗时。批处理可以加快这一过程，每批最多可处理 16 幅图像(<a class="ae lk" href="https://cloud.google.com/vision/quotas" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/vision/quotas</a>)。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="391f" class="lq lr iq lm b gy ls lt l lu lv">#install google cloud vision<br/>pip install google-cloud-vision</span><span id="b522" class="lq lr iq lm b gy lw lt l lu lv">#import dependencies<br/>from google.cloud import vision<br/>from google.cloud import storage<br/>from google.cloud.vision_v1 import enums<br/>from google.cloud.vision_v1 import ImageAnnotatorClient<br/>from google.cloud.vision_v1 import types<br/>import os<br/>import json</span><span id="6b2a" class="lq lr iq lm b gy lw lt l lu lv">os.environ["GOOGLE_APPLICATION_CREDENTIALS"]='project_key.json' <br/>#(created in step 1)</span><span id="1bae" class="lq lr iq lm b gy lw lt l lu lv"># Get GCS bucket<br/>storage_client = storage.Client()<br/>bucket = storage_client.bucket('bucket_name’)<br/>image_paths = []<br/>for blob in list(bucket.list_blobs()):<br/>    image_paths.append("gs:// bucket_name/"+blob.name)</span><span id="dfc2" class="lq lr iq lm b gy lw lt l lu lv"># We can send a maximum of 16 images per request.<br/>start = 0<br/>end = 16<br/>label_output = []</span><span id="8b5d" class="lq lr iq lm b gy lw lt l lu lv">for i in range(int(np.floor(len(image_paths)/16))+1):<br/>    requests = []<br/>    client = vision.ImageAnnotatorClient()<br/>    for image_path in image_paths[start:end]:<br/>        image = types.Image()<br/>        image.source.image_uri = image_path<br/>        requests.append({'image': image,'features': [{'type': vision_v1.Feature.Type.LABEL_DETECTION}]})<br/>        response = client.batch_annotate_images(requests)<br/>    for image_path, i in zip(image_paths[start:end], response.responses):<br/>        labels = [{label.description: label.score} for label in i.label_annotations]<br/>        labels = {k: v for d in labels for k, v in d.items()}<br/>        filename = os.path.basename(image_path)<br/>        l = {'filename': filename, 'labels': labels}<br/>        label_output.append(l)<br/>    start = start+16<br/>    end = end+16</span><span id="a765" class="lq lr iq lm b gy lw lt l lu lv">#export results to JSON file<br/>with open('image_results.json', 'w') as outputjson:<br/>json.dump(label_output, outputjson, ensure_ascii=False)</span></pre><p id="9c96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">标签检测的结果可以存储在 JSON 文件中。</p><p id="f86b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第六步:从 google bucket 中删除图片:</strong>你可能想在完成分析后删除图片，因为会有存储成本。删除循环中的每个图像需要时间。相反，为存储桶设置一个生命周期，这样您就可以一次删除整个存储桶。将以下代码粘贴到一个 JSON 文件中，并将其保存为 lifecycle.json，然后执行 gsutil 代码</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="2ee7" class="lq lr iq lm b gy ls lt l lu lv">#Age tells about how many days after bucket creation you want to delete it.</span><span id="510d" class="lq lr iq lm b gy lw lt l lu lv">{<br/> "rule":<br/> [<br/>  {<br/>   "action": {"type": "Delete"},<br/>   "condition": {"age": 2}<br/>  }<br/> ]<br/>}</span><span id="855b" class="lq lr iq lm b gy lw lt l lu lv">#This codes sets lifecycle for the bucket<br/>gsutil lifecycle set 'lifecycle.json' 'gs://bucket_name'</span></pre><p id="b6b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你还有一些问题或者想做文本/人脸检测，请查看<a class="ae lk" href="https://codelabs.developers.google.com/codelabs/cloud-vision-api-python/index.html?index=#0" rel="noopener ugc nofollow" target="_blank">https://code labs . developers . Google . com/code labs/cloud-vision-API-python/index . html？index=#0 </a></p><p id="3cab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望这篇文章有所帮助。快乐阅读！</p></div></div>    
</body>
</html>