<html>
<head>
<title>Scaling Apache Airflow for Machine Learning Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为机器学习工作流扩展 Apache 气流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/scaling-apache-airflow-for-machine-learning-workflows-f2446257e495?source=collection_archive---------8-----------------------#2019-11-26">https://towardsdatascience.com/scaling-apache-airflow-for-machine-learning-workflows-f2446257e495?source=collection_archive---------8-----------------------#2019-11-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6b38" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何在云上轻松执行 Airflow 任务，并获得每个机器学习任务的自动版本控制。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/57815632a4dcf232f9ec4c7a1cee5a35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDb6oiRtNngm_V7yDo5Z8Q.png"/></div></div></figure><p id="4b10" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Apache Airflow 是一个用 Python 创建、调度和监控工作流的流行平台。它在 Github 上有超过 15k 颗星，被 Twitter、Airbnb 和 Spotify 等公司的数据工程师使用。</p><p id="8a5e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您使用的是 Apache Airflow，那么您的架构可能已经根据任务的数量及其需求进行了改进。在 Skillup.co 工作时，我们首先有几百个 Dag 来执行我们所有的数据工程任务。然后我们开始做机器学习。</p><p id="11f6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们希望继续使用气流来编排机器学习管道，但我们很快意识到我们需要一种解决方案来远程执行机器学习任务。</p><p id="5bf1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我们将看到:</p><ul class=""><li id="4b84" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">在气流中扩展工作节点的不同策略。</li><li id="b324" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">机器学习任务与传统 ETL 管道的不同之处。</li><li id="d6f6" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">如何在云上轻松执行气流任务？</li><li id="9d67" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">如何获得每个机器学习任务的自动版本控制？</li></ul><h1 id="384e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">使用执行器扩展 Apache 气流</h1><p id="e581" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">Apache Airflow 具有基于调度器、工作节点、元数据数据库、web 服务器和队列服务的多节点架构。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/dc011610c53042533520f8f7af8a715f.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*lxNt_HSiaNdcD1qiTjbDIQ.jpeg"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Example Airflow architecture.</figcaption></figure><p id="6821" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用气流时的首选之一是执行器的类型。执行器与调度器通信，在任务排队时为每个任务分配资源。遗嘱执行人之间的区别在于他们拥有的资源。</p><h2 id="6370" class="ng mf it bd mg nh ni dn mk nj nk dp mo ld nl nm mq lh nn no ms ll np nq mu nr bi translated">顺序执行者</h2><p id="3dc3" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">默认的执行器使得在本地测试气流变得很容易。它在一台机器上顺序运行任务，并使用 SQLite 存储任务的元数据。</p><h2 id="52e0" class="ng mf it bd mg nh ni dn mk nj nk dp mo ld nl nm mq lh nn no ms ll np nq mu nr bi translated">本地执行者</h2><p id="50a7" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">本地执行器可以并行运行任务，并且需要像 PostgreSQL 这样支持并行性的数据库。虽然您可以在生产环境中运行本地执行器，但通常会迁移到 Celery executor 来提高可用性和可伸缩性。</p><h2 id="b3a6" class="ng mf it bd mg nh ni dn mk nj nk dp mo ld nl nm mq lh nn no ms ll np nq mu nr bi translated">芹菜执行者</h2><p id="7ae7" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">Celery executor 要求设置 Redis 或 RabbitMQ 来向工作人员分发消息。气流然后将任务分配给芹菜工人，他们可以在一台或多台机器上运行。这是我们在 Skillup.co 使用的执行器，能够运行多达 256 个并发数据工程任务。</p><h2 id="ce75" class="ng mf it bd mg nh ni dn mk nj nk dp mo ld nl nm mq lh nn no ms ll np nq mu nr bi translated">库伯内特遗嘱执行人</h2><p id="7683" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">Kubernetes 执行器为每个任务实例创建一个新的 pod。它允许您根据任务需求动态地伸缩。</p><h1 id="0117" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">与运营商一起扩展 Apache 气流</h1><p id="6c85" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">另一种扩展气流的方法是让操作员远程执行一些任务。2018 年，<a class="ae ns" href="https://medium.com/bluecore-engineering/were-all-using-airflow-wrong-and-how-to-fix-it-a56f14cb0753" rel="noopener">杰西卡·拉夫林认为我们都在错误地使用气流</a>，正确的方法是只使用 Kubernetes 算子。她认为应该有一个单一的无 bug 操作符来执行任意任务，而不是一个不断增长的特定功能操作符列表。</p><h2 id="1c9f" class="ng mf it bd mg nh ni dn mk nj nk dp mo ld nl nm mq lh nn no ms ll np nq mu nr bi translated">Kubernetes 算子</h2><p id="8682" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">Kubernetes 操作员将在一个新的 pod 中启动一个任务。当您有一组需要定期运行的任务时，我发现只对有特定需求的任务使用 Kubernetes 操作符是一个更好的主意。</p><p id="d39f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我认为 Kubernetes 操作符的主要问题是，您仍然需要理解 Kubernetes 配置系统并设置一个集群。例如，Dailymotion 在谷歌 Kubernetes 引擎上的一个集群中部署了 Airflow，并决定通过 KubernetesPodOperator  <em class="nt">来扩展 Airflow 用于机器学习任务。</em></p><p id="3e84" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们的案例中，我们是一个小型数据团队，几乎没有资源来建立一个 Kubernetes 集群。我们希望专注于构建机器学习模型，而不是管理基础设施。</p><h1 id="22c8" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">机器学习任务与 ETL 任务有何不同？</h1><p id="d2d0" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">在 Skillup.co，我们不得不作为一个小团队在一年内构建和部署几个数据产品。我们知道我们想要使用开源库来构建我们的模型，从经典的机器学习模型到深度学习。我们也在寻找一个机器学习平台来帮助我们<strong class="kw iu">扩展和版本控制我们所有的模型</strong>。</p><p id="47ff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Airflow 在跟踪元数据数据库中的每个任务细节方面做得很好，但机器学习任务与 ETL 任务有不同的要求。机器学习任务与<a class="ae ns" href="https://blog.valohai.com/how-to-track-machine-learning-experiments" rel="noopener ugc nofollow" target="_blank">数据、代码、环境、参数和指标</a>相关联。这些信息不是由气流收集和显示的。Kubernetes 只在基础设施方面帮助你。</p><p id="3cdc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在一个地方收集每次执行的所有相关信息有助于调试机器学习模型。在下表中，你可以看到我们跟踪的信息，以更快地迭代机器学习模型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/6992300230eed1d1e65ee1bfd423f393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TCSZsD2kV3o7Zr8T5C21Mw.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Important information for machine learning version control.</figcaption></figure><h1 id="4875" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">我们对扩展机器学习任务的选择</h1><p id="b03c" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">你已经可以找到几个像谷歌数据流，亚马逊 SageMaker 和 Databricks 这样的机器学习平台的气流运营商。这些操作符的问题在于，它们都有不同的规范，并且仅限于在这些平台上执行代码。</p><p id="3b1e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们开始在 Skillup.co 做任何机器学习之前，我们将 Airflow 用于所有数据工程，这些工程主要由 Airflow <em class="nt"> BashOperator </em>调用的 Python CLIs 组成。</p><p id="a0c5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后我们决定使用<a class="ae ns" href="https://valohai.com" rel="noopener ugc nofollow" target="_blank"> Valohai </a>，一个基于开放标准构建的机器学习平台，帮助我们远程启动机器学习任务，并获得自动版本控制。</p><p id="59d9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">拥有一个混合解决方案使我们能够将敏感数据保存在我们的 Airflow 装置中，并将机器学习委托给 Valohai。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/c2687df10e1eb1ac0ea3289395f07913.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b1nPOOL64ZNP8McX"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Machine learning workflow with an Airflow DAG. Blue tasks are executed remotely thanks to Valohai.</figcaption></figure><p id="0ca4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢<a class="ae ns" href="https://docs.valohai.com/valohai-api/index.html" rel="noopener ugc nofollow" target="_blank"> Valohai 的开放 API </a>，我们开发了开源的<a class="ae ns" href="https://github.com/skillupco/airflow-valohai-plugin" rel="noopener ugc nofollow" target="_blank"> airflow-valohai-plugin </a>来整合两个平台。去年，我们用它在生产中发布了四个机器学习模型。</p><h2 id="e9cd" class="ng mf it bd mg nh ni dn mk nj nk dp mo ld nl nm mq lh nn no ms ll np nq mu nr bi translated">瓦罗海算子</h2><p id="fa2f" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">Valohai 运算符背后的思想类似于 Kubernetes 运算符。好处是你不需要理解 Kubernetes，你也可以获得机器学习的自动版本控制。</p><p id="e1b8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Valohai 将根据您的需求、代码和数据启动和停止云实例。Valohai 操作符只是在 Docker 容器中执行一个命令，轮询它的完成情况并返回最终的状态代码。</p><p id="4956" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过提供 Docker 映像和您的代码库，您可以执行任何语言和库的代码。你还可以访问 AWS、Google 和 Azure 中的 50 多个云环境。</p><p id="ed2a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要创建一个关于 Airflow 的任务，您只需要指定要执行的 Valohai 项目和步骤。如果需要，您还可以覆盖默认的云环境、输入和参数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Sample code to submit an execution to Valohai from Airflow [<a class="ae ns" href="https://github.com/skillupco/airflow-valohai-plugin/blob/master/examples/dags/example_valohai_dag_pass_outputs.py" rel="noopener ugc nofollow" target="_blank">source</a>].</figcaption></figure><p id="f792" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">另一方面，您需要通过创建 valohai.yaml 在 Valohai 端进行一些简单的配置。<a class="ae ns" href="https://docs.valohai.com/valohai-yaml/index.html" rel="noopener ugc nofollow" target="_blank"> valohai.yaml </a>作为一个配置文件来设置默认值，并验证机器环境、docker 映像、要运行的命令、参数和每次执行的输入数据文件。</p><p id="cf4d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从一开始就拥有机器版本控制有助于我们调试数据、代码和参数，从而更快地进行预测和修复。就像你希望你的气流任务是幂等的，以避免重新启动它们时的副作用一样，你希望你的机器学习模型基于代码和数据的审计版本。如果您总是使用存储在数据湖中的文件来训练您的模型，这很容易做到。下面你可以在 Valohai UI 中看到一个执行的解析配置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/16599d7a076d5038d0c705076a6058cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I2f6_SOHuY63xhXTTTJdqA.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Valohai UI with execution details [<a class="ae ns" href="https://github.com/valohai/tensorflow-example" rel="noopener ugc nofollow" target="_blank">source code</a>].</figcaption></figure><p id="1d2a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Valohai 建立在两个明智的选择之上，这两个选择使得它可以很容易地与任何编程语言和库集成。</p><p id="619c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，选择一个对所有编程语言通用的 CLI 优先接口。CLI 是一个流行的接口，用来包装您的函数，以便在本地执行它们。CLI 也是 Bash、Kubernetes 和 Valohai 操作符的接口。</p><p id="b272" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第二，从标准输出中收集执行指标，而不是为每种语言安装一个定制的库。所有语言都有将 JSON 对象写入标准输出的工具。Valohai 将自动解析该对象，例如，帮助您比较每个模型的准确性。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/f7d11c0ace50fef447a3679560ec0853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*09MDod9FMPZsYV0T"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Valohai UI to compare execution’s parameters and accuracy.</figcaption></figure><p id="5dc1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您还可以在 Valohai UI 中手动启动执行，而不会有任何副作用。在 Airflow 中，清除一个任务的状态将触发下游任务。</p><p id="db85" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后但同样重要的是，新的 Valohai 操作符允许您轻松地将一次执行的输出作为下一次执行的输入。这帮助我们创建了管道，数据在 S3 上自动版本化。此外，每个新的执行都在与 S3 bucket 相同的云提供商和区域上运行，这使得 Valohai 可以快速地将它下载到 AWS EC2 实例上。</p><h1 id="0ce6" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="fc4c" class="pw-post-body-paragraph ku kv it kw b kx mw ju kz la mx jx lc ld my lf lg lh mz lj lk ll na ln lo lp im bi translated">Apache Airflow 是创建、调度和监控工作流的强大工具，但它是为 ETL 任务而构建的。机器学习任务需要特定的资源，并且它们的执行细节应该受到版本控制。</p><p id="6bf1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你有资源来维护一个 Kubernetes 集群，你可以用<em class="nt"> KubernetesPodOperator </em>来扩展机器学习任务。</p><p id="879b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你想专注于建立模型，你可以用<a class="ae ns" href="https://github.com/skillupco/airflow-valohai-plugin" rel="noopener ugc nofollow" target="_blank"><em class="nt">ValohaiSubmitExecutionOperator</em></a>来缩放用于机器学习任务的气流。通过这种方式，您还可以通过<a class="ae ns" href="https://valohai.com" rel="noopener ugc nofollow" target="_blank"> Valohai </a>获得每次执行的自动版本控制。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="0383" class="me mf it bd mg mh og mj mk ml oh mn mo jz oi ka mq kc oj kd ms kf ok kg mu mv bi translated">有用的资源</h1><ul class=""><li id="bd31" class="lq lr it kw b kx mw la mx ld ol lh om ll on lp lv lw lx ly bi translated"><a class="ae ns" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">阿帕奇气流文档</a></li><li id="10e4" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><a class="ae ns" href="https://docs.valohai.com/" rel="noopener ugc nofollow" target="_blank">瓦罗海文档</a></li><li id="e560" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><a class="ae ns" href="https://airflow.apache.org/kubernetes.html#kubernetes-operator" rel="noopener ugc nofollow" target="_blank"> KubernetesPodOperator 文档</a></li><li id="bf1e" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><a class="ae ns" href="https://github.com/skillupco/airflow-valohai-plugin" rel="noopener ugc nofollow" target="_blank">ValohaiSubmitExecutionOperator 文档</a></li></ul></div></div>    
</body>
</html>