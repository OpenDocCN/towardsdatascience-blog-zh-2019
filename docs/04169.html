<html>
<head>
<title>Log Book —Guide to Excel &amp; Outlook email Delivery Automation via Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">日志——通过 Python 实现 Excel 和 Outlook 电子邮件交付自动化指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/log-book-guide-to-excel-outlook-email-delivery-automation-via-python-ca905cbf3f89?source=collection_archive---------14-----------------------#2019-06-30">https://towardsdatascience.com/log-book-guide-to-excel-outlook-email-delivery-automation-via-python-ca905cbf3f89?source=collection_archive---------14-----------------------#2019-06-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="276f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">本文分为两个部分，第一部分处理从 excel 生成图像/PDF，下一部分将它附加到 outlook 电子邮件中并发送出去。它在宏和处理不同的邮箱方面也有额外的好处。</h2></div><p id="4d4c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated">在我们的日常活动中，我们经常会遇到发送大量邮件的任务，这个项目就是这种需求的产物。</p><p id="6193" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将记下这个自动化过程所需的步骤，然后尝试自动化其中的每个步骤。这种自动化所需的步骤如下:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="5441" class="lw lx it ls b gy ly lz l ma mb">1. Generate image/pdf from an excel.<br/>2. Create an email with the image/pdf as an attachment.<br/>3. Send out the emails from outlook.</span></pre><p id="7e92" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这看起来很简单，让我们开始吧。从现在开始，试着把重点放在代码上，我会在最后附上一个 GitHub 要点。</p><h2 id="b110" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">步骤 1 —图像/PDF 创建</h2><p id="5796" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">我们有一个 excel 包含了 GOT 所有战役的数据，还有一个简单的图表显示了各地区的战役数量。在这一步中，我们的目标是从 excel 中创建下图的 PDF/图像。你可以从<a class="ae my" href="https://drive.google.com/open?id=1Y5Z7K-p9Ybxztwp7v9DjMa3-gHY3xs2P" rel="noopener ugc nofollow" target="_blank">这里</a>下载 excel。</p><figure class="ln lo lp lq gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi mz"><img src="../Images/cb07858254ed8e8d27af9591c46a452a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*plRfZIrHyj0FZPwSl4u-oQ.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk">Graph which we will copy as image</figcaption></figure><p id="da11" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将连接到 Excel 应用程序并加载我们的工作表，Python 有许多选项来本地创建常见的 Microsoft Office 文件类型，包括 Excel、Word 和 PowerPoint。然而，在某些情况下，使用纯 python 方法来解决问题可能太困难了。幸运的是，python 拥有名为<a class="ae my" href="https://github.com/mhammond/pywin32" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> pywin32 </strong> </a>的“Python for Windows Extensions”包，可以让我们轻松访问 Window 的组件对象模型(COM)并通过 Python 控制微软应用。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="78fa" class="lw lx it ls b gy ly lz l ma mb">xlApp = win32.DispatchEx('Excel.Application')<br/>wb = xlApp.Workbooks.Open(file_location + filename)<br/>ws = wb.Worksheets('Graph') <strong class="ls iu"># name of the sheet in which graph is present.</strong></span></pre><p id="e318" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，我们将给出想要转换为图像的工作表部分的单元格引用。图像功能由<strong class="kk iu"> PIL </strong>包提供。以下代码将单元格引用作为图像复制到剪贴板并保存。您可以使用“质量”参数调整图像质量，请注意，图像质量仅适用于 JPEG 类型的文件。默认图像质量设置为 75，当您增加或减少该值时，图像的大小也会改变。具体可以参考 PIL 图书馆的<a class="ae my" href="https://pillow.readthedocs.io/en/5.1.x/handbook/image-file-formats.html#jpeg" rel="noopener ugc nofollow" target="_blank">官方文档。</a></p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="b32d" class="lw lx it ls b gy ly lz l ma mb">win32c = win32.constants<br/>ws.Range("B2:I16").CopyPicture(Format=win32c.xlBitmap) <strong class="ls iu"># give the cells for which you need the image</strong><br/>img = ImageGrab.grabclipboard()<br/>img.save(file_location + 'Graph.jpeg',quality=55) <strong class="ls iu"># image quality and file size is directly linked</strong></span></pre><p id="a9cc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">到目前为止，我们已经保存了我们的形象。现在，如果你想将图像转换成 pdf 格式，你可以使用<strong class="kk iu"> img2pdf </strong>库。下面的代码读取上面保存的图像，并将其保存为 PDF 格式。如果你需要的只是一张图片，你可以跳过这一步。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="fa1a" class="lw lx it ls b gy ly lz l ma mb"><strong class="ls iu">#storing pdf path</strong><br/> pdf_path = file_location + "Graph.pdf"</span><span id="169f" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu">#opening image</strong><br/> image = Image.open(image_path)</span><span id="8d46" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu">#converting into chunks using img2pdf</strong><br/> pdf_bytes = img2pdf.convert(image.filename)</span><span id="4aa0" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu">#opening or creating pdf file</strong><br/> file = open(pdf_path, "wb")</span><span id="d201" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu">#writing pdf files with chunks</strong><br/> file.write(pdf_bytes)</span><span id="43d5" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu">#closing image file</strong><br/> image.close()</span><span id="10a8" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu">#closing pdf file</strong><br/> file.close()</span></pre><p id="e14f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成这一步后，我们有一个图像和一个 PDF:</p><figure class="ln lo lp lq gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nm"><img src="../Images/0d69a9e26dbc1c3f76b22e6fe22a2366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fj4E9UoNeWmS5NAy43rM4Q.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk">Image &amp; PDF created</figcaption></figure><blockquote class="nn no np"><p id="20ce" class="ki kj nq kk b kl km ju kn ko kp jx kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated">我们理想地完成了第一步，但我想补充一点小奖励。通常，我们有一个基于宏的 excel，而不是常规的 excel，需要在拍摄图像之前运行宏来刷新数据，这也是可能的。您只需要知道要运行的宏的名称。下面的代码将打开 excel 运行指定的宏并保存 excel。</p></blockquote><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="3aa5" class="lw lx it ls b gy ly lz l ma mb">xlApp = win32.DispatchEx('Excel.Application')<br/>wb = xlApp.Workbooks.Open(file_location + filename)</span><span id="ea8e" class="lw lx it ls b gy nl lz l ma mb"><strong class="ls iu"># Give the proper macro name</strong><br/>xlApp.Application.Run("Module.Macroname")<br/>wb.Save()<br/>wb.Close()<br/>xlApp.Application.Quit()</span></pre><h2 id="0a53" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">步骤 2—创建电子邮件</h2><p id="3444" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">我们将使用与 excel 相同的<a class="ae my" href="https://github.com/mhammond/pywin32" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu"> pywin32 </strong> </a>包来连接 Outlook。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="16df" class="lw lx it ls b gy ly lz l ma mb">outlook = win32.Dispatch('outlook.application')</span></pre><blockquote class="nn no np"><p id="06b3" class="ki kj nq kk b kl km ju kn ko kp jx kq nr ks kt ku ns kw kx ky nt la lb lc ld im bi translated">T4:这是另一笔奖金。当配置了多个电子邮件 id 时，通常需要从特定的 outlook 邮箱发送邮件，我们将在下一步处理这个问题。如果您想从默认邮箱发送邮件，可以跳过这一步。以下代码将遍历您所有已配置的帐户，当它找到“abc@mail.com”时，将从那里发送邮件。但是请注意，如果它没有获得指定的邮件 id，它将只从默认 id 发送邮件。</p></blockquote><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="769a" class="lw lx it ls b gy ly lz l ma mb">sendfromAC = <em class="nq">None<br/>for </em>oacc <em class="nq">in </em>outlook.Session.Accounts:<br/><strong class="ls iu">#give the mail id from which you want to send</strong><br/>    <em class="nq">if </em>oacc.SmtpAddress == "abc@mail.com": <br/>        sendfromAC = oacc<br/>        <em class="nq">break<br/></em>##----------------------------------------------------------------<br/><br/>mail = outlook.CreateItem(0)<br/><br/><em class="nq">if </em>sendfromAC:<br/>    mail._oleobj_.Invoke(*(64209, 0, 8, 0, sendfromAC))<br/>##----------------------------------------------------------------</span></pre><p id="3450" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的 outlook 对象已经创建，现在我们将添加<strong class="kk iu">到/CC </strong> / <strong class="kk iu">主题</strong>和<strong class="kk iu">附件</strong>。对于附件部分，我将展示 2 件事情，<strong class="kk iu">将 PDF 文件</strong>作为文件附在邮件中，<strong class="kk iu">将图片</strong>嵌入邮件正文中。这应该涵盖 2 个用例。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="2389" class="lw lx it ls b gy ly lz l ma mb">mail.To = 'abc@mail.com'<br/>mail.Cc = 'abc@mail.com;bcd@mail.com'<br/>mail.Subject = 'Demo Outlook Automation mail'</span></pre><p id="1725" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">附上 PDF: </strong></p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="9654" class="lw lx it ls b gy ly lz l ma mb">mail.Attachments.Add(file_location + "Graph.pdf")</span></pre><p id="f6f0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">嵌入邮件正文:</strong></p><p id="0a71" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了在邮件正文中嵌入图像，我们首先需要将它作为普通附件附加，然后将其作为 HTML 邮件正文的一部分嵌入。以下部分处理附加图像和设置属性，以便 outlook 可以正确处理图像。我们很快会谈到嵌入部分。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="31cf" class="lw lx it ls b gy ly lz l ma mb">attachment1 = mail.Attachments.Add(file_location + 'Graph.jpeg')<br/>attachment1.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001F", "Graph")<br/><br/>mail.HTMLBody = "&lt;HTML lang='en' xmlns='http://www.w3.org/1999/xhtml' xmlns:o='urn:schemas-microsoft-com:office:office'&gt; " \<br/>                + "&lt;head&gt;" \<br/>                + "&lt;!--[if gte mso 9]&gt;&lt;xml&gt; \<br/>                        &lt;o:OfficeDocumentSettings&gt; \<br/>                        &lt;o:Allowjpeg/&gt; \<br/>                        &lt;o:PixelsPerInch&gt;96&lt;/o:PixelsPerInch&gt; \<br/>                        &lt;/o:OfficeDocumentSettings&gt; \<br/>                    &lt;/xml&gt; \<br/>                    &lt;![endif]--&gt;" \<br/>                + "&lt;/head&gt;" \<br/>                + "&lt;BODY&gt;"</span></pre><p id="bcbf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们必须创建电子邮件正文。您可以将邮件正文设置为<strong class="kk iu">普通文本格式</strong>或<strong class="kk iu"> HTML 格式</strong>。我个人更喜欢 HTML 正文格式，因为它给了我很多控制电子邮件应该如何显示，而不是让 Outlook 来判断。下面的代码非常明显，它将设置邮件正文，最后的<strong class="kk iu"> 'cid:Graph' </strong>部分将在邮件正文中嵌入附加的图像。</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="da0a" class="lw lx it ls b gy ly lz l ma mb">mail.HTMLBody = mail.HTMLBody + "&lt;BR&gt;Hello,&lt;b&gt; &lt;/b&gt;" \<br/>                + "&lt;BR&gt;&lt;BR&gt; Refer to the image below: &lt;/b&gt; ."\<br/>                + "&lt;html&gt;&lt;body&gt;&lt;img src='cid:Graph'&gt;&lt;/body&gt;&lt;/html&gt;"</span></pre><h2 id="3d03" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">步骤 3 —发送邮件</h2><p id="0895" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">现在我们已经准备好了邮件对象，剩下的就是发送邮件了。这将使用简单的命令来完成:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="3848" class="lw lx it ls b gy ly lz l ma mb">mail.Send()</span></pre><p id="d5db" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">万岁！！</p><figure class="ln lo lp lq gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nu"><img src="../Images/a772daa1a5b10b5681bd04eb2c2c52e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9V80MY21s-u9jmGeGSVKcw.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk">Sent Mail</figcaption></figure><p id="f167" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完整的 GitHub 要点补充如下:</p><figure class="ln lo lp lq gt na"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="4f6d" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">已知问题</h2><h2 id="b3ad" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">问题 1</h2><p id="c448" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">很少会出现脚本无法连接到 excel 的问题。错误是这样的:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="71bd" class="lw lx it ls b gy ly lz l ma mb">module 'win32com.gen_py.00020813-0000-0000-C000-000000000046x0x1x9' has no attribute 'CLSIDToClassMap'</span></pre><p id="357f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">解决方案是从这个<a class="ae my" href="https://stackoverflow.com/questions/52889704/python-win32com-excel-com-model-started-generating-errors" rel="noopener ugc nofollow" target="_blank">堆栈溢出 URL </a>中派生出来的</p><p id="2104" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些步骤是:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="e2e8" class="lw lx it ls b gy ly lz l ma mb">1. <strong class="ls iu">Delete the entire gen_py folder</strong>, in my case it was present in this path: C:\Users\'user_name'\AppData\Local\Temp\gen_py folder</span><span id="258a" class="lw lx it ls b gy nl lz l ma mb">2. <strong class="ls iu">Rerun the script</strong>, the above caches will be regenerated</span><span id="ff2c" class="lw lx it ls b gy nl lz l ma mb">Resolving step 2 often results in Issue 2, which has to be resolved in turn.</span></pre><h2 id="b030" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">问题 2</h2><p id="e09d" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">这个问题比问题 1 更常见，运行几天后，代码会抛出一个错误:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="71cf" class="lw lx it ls b gy ly lz l ma mb">File  "C:/Users/<!-- -->'user_name'<!-- -->/PycharmProjects/Mailer/mailDispatcher.py",  line 64, in MailDispatcher  ws.Range("A1:AF25").CopyPicture(Format=win32c.xlBitmap) File  </span><span id="52b4" class="lw lx it ls b gy nl lz l ma mb">"C:\Users\<!-- -->'user_name'<!-- -->\PycharmProjects\mail\venv\lib\site-packages\win32com\client\__init__.py",  line 178, in __getattr__ raise <strong class="ls iu">AttributeError(a)</strong><br/> <br/><strong class="ls iu">in the</strong> <em class="nq">xlApp = win32.DispatchEx('Excel.Application')</em><strong class="ls iu"> line.</strong></span></pre><p id="5004" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个解决方案是通过一种试凑法得出的。这些步骤是:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="abe0" class="lw lx it ls b gy ly lz l ma mb">1. Replace <strong class="ls iu">xlApp = win32.DispatchEx('Excel.Application')</strong> with <strong class="ls iu">xlApp = win32.gencache.EnsureDispatch('Excel.Application')</strong> <em class="nq">[This is already added in code.]</em></span><span id="56ec" class="lw lx it ls b gy nl lz l ma mb">2. Run the code for once, this will result <strong class="ls iu">in a mail with corrupted attachments.</strong></span><span id="9b02" class="lw lx it ls b gy nl lz l ma mb">3. <strong class="ls iu">Undo changes of Step 1.</strong></span><span id="b251" class="lw lx it ls b gy nl lz l ma mb">4. Run the code again, now everything should work.</span></pre><p id="03da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我真的不知道是什么导致了这些问题，广泛的谷歌搜索没有任何有价值的东西。看起来像是某种缓存损坏。</p><h2 id="bc59" class="lw lx it bd mc md me dn mf mg mh dp mi kr mj mk ml kv mm mn mo kz mp mq mr ms bi translated">参考资料:</h2><p id="edfb" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated"><a class="ae my" href="https://www.kaggle.com/mylesoneill/game-of-thrones#battles.csv" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/mylesoneill/game-of-thrones # battles . CSV</a></p><p id="48d1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">https://pbpython.com/windows-com.html<a class="ae my" href="https://pbpython.com/windows-com.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="74eb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">太多<a class="ae my" href="https://stackoverflow.com/" rel="noopener ugc nofollow" target="_blank">堆栈溢出</a>问题</p></div></div>    
</body>
</html>