<html>
<head>
<title>Custom Named Entity Recognition Using spaCy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用空间的自定义命名实体识别</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/custom-named-entity-recognition-using-spacy-7140ebbb3718?source=collection_archive---------0-----------------------#2019-04-18">https://towardsdatascience.com/custom-named-entity-recognition-using-spacy-7140ebbb3718?source=collection_archive---------0-----------------------#2019-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a3ee50418fc6cd06fea40cfd88b930b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HTtQseukwrBiREJf8MSVcA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 1: <a class="ae kc" href="https://www.google.com/url?sa=i&amp;source=images&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwiKo-uSzffgAhXJknAKHXH4CwYQjRx6BAgBEAU&amp;url=%2Furl%3Fsa%3Di%26source%3Dimages%26cd%3D%26ved%3D%26url%3Dhttps%253A%252F%252Fspacy.io%252Fusage%252Flinguistic-features%26psig%3DAOvVaw3H52fKKxtUkhEj4jVFkQxO%26ust%3D1552308120763958&amp;psig=AOvVaw3H52fKKxtUkhEj4jVFkQxO&amp;ust=1552308120763958" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><h1 id="f6e6" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">什么是命名实体识别(NER)？</h1><p id="1af1" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">命名实体识别(NER)是信息提取(IE)的一个子任务，在一个或多个文本主体中找出指定的<a class="ae kc" href="https://en.wikipedia.org/wiki/Named_entity" rel="noopener ugc nofollow" target="_blank">实体</a>并对其进行分类。NER 也简称为实体识别、实体分块和实体提取。NER 被用于人工智能的许多领域(<a class="ae kc" href="https://en.wikipedia.org/wiki/Artificial_intelligence" rel="noopener ugc nofollow" target="_blank"> AI </a>)，包括自然语言处理(<a class="ae kc" href="https://en.wikipedia.org/wiki/Natural_language_processing" rel="noopener ugc nofollow" target="_blank"> NLP </a>)和<a class="ae kc" href="https://en.wikipedia.org/wiki/Machine_learning" rel="noopener ugc nofollow" target="_blank">机器学习</a>。</p><h1 id="5ebc" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">NER 的空间</h1><p id="31eb" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">SpaCy 是 Python 中高级自然语言处理的开源库。它是专门为生产使用而设计的，有助于构建处理和“理解”大量文本的应用程序。它可以用于构建信息提取或自然语言理解系统，或者用于深度学习的文本预处理。spaCy 提供的一些功能包括标记化、词性(PoS)标记、文本分类和命名实体识别。</p><p id="6c92" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">SpaCy 为 python 中的 NER 提供了一个非常有效的统计系统，它可以将标签分配给连续的标记组。它提供了一个默认模型，可以识别广泛的命名或数字实体，包括<em class="me">个人、组织、语言、事件等。</em>除了这些默认实体之外，spaCy 还允许我们自由地向 NER 模型添加任意类别，方法是训练该模型，以便用更新的训练样本对其进行更新。</p><h1 id="c7e1" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">入门指南</h1><h2 id="6cc2" class="mf ke iq bd kf mg mh dn kj mi mj dp kn lm mk ml kr lq mm mn kv lu mo mp kz mq bi translated">装置</h2><p id="6d96" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">SpaCy 可以通过简单的<code class="fe mr ms mt mu b">pip</code>安装来安装。您还需要下载您希望使用 spaCy 的语言的语言模型。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="c221" class="mf ke iq mu b gy nd ne l nf ng">pip install -U spacy <br/>python -m spacy download en</span></pre><h1 id="537e" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">我们开始吧！</h1><h2 id="c770" class="mf ke iq bd kf mg mh dn kj mi mj dp kn lm mk ml kr lq mm mn kv lu mo mp kz mq bi translated"><em class="nh">数据集</em></h2><p id="d870" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我们将要处理的数据集可以从<a class="ae kc" href="https://www.kaggle.com/abhinavwalia95/entity-annotated-corpus" rel="noopener ugc nofollow" target="_blank">这里</a>下载。我们将使用<code class="fe mr ms mt mu b">ner_dataset.csv</code>文件，只训练 260 个句子。</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/a9c9f9babecb958f32d4085818c44369.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QXIMTMpUCUmS4CIjHQoM-Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 2: NER Dataset</figcaption></figure><p id="d049" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">数据集由以下标签组成-</p><ul class=""><li id="0efd" class="nj nk iq ld b le lz li ma lm nl lq nm lu nn ly no np nq nr bi translated">地理=地理实体</li><li id="c886" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">org =组织</li><li id="1acf" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">per =人</li><li id="cf43" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">地缘政治实体</li><li id="e43a" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">tim =时间指示器</li><li id="01c8" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">艺术=艺术品</li><li id="d10e" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">eve =事件</li><li id="30b3" class="nj nk iq ld b le ns li nt lm nu lq nv lu nw ly no np nq nr bi translated">自然现象</li></ul><p id="f6e2" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">数据集遵循<a class="ae kc" href="https://natural-language-understanding.fandom.com/wiki/Named_entity_recognition" rel="noopener ugc nofollow" target="_blank">生物</a>类型标记。</p><h2 id="0294" class="mf ke iq bd kf mg mh dn kj mi mj dp kn lm mk ml kr lq mm mn kv lu mo mp kz mq bi translated">数据预处理</h2><p id="725a" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">SpaCy 要求训练数据采用以下格式-</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/ed11bbe8750b526beb24811c43c37fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*TZWuuZjHDMWArQUCohXWGg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 3: spaCy Format Training Data (<a class="ae kc" href="https://spacy.io/usage/training#ner" rel="noopener ugc nofollow" target="_blank">Source</a>)</figcaption></figure><p id="c7a4" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">所以我们必须把我们的数据从<code class="fe mr ms mt mu b">.csv</code>格式转换成上面的格式。<em class="me">(spaCy 也接受其他形式的训练数据。更多细节请参考</em> <a class="ae kc" href="https://spacy.io/api/annotation#named-entities" rel="noopener ugc nofollow" target="_blank"> <em class="me">文档</em> </a> <em class="me">。)</em>我们首先删除列<code class="fe mr ms mt mu b">Sentence #</code>和<code class="fe mr ms mt mu b">POS</code>，因为我们不需要它们，然后将<code class="fe mr ms mt mu b">.csv</code>文件转换为<code class="fe mr ms mt mu b">.tsv</code>文件。接下来，我们必须运行下面的脚本来获取<code class="fe mr ms mt mu b">.json</code>格式的训练数据。</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="929e" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">现在数据应该是这样的，</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/c95f605e41368b74ea2b2c2a54cf43c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SyROr8n7L3Z45UiiRqGUPQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 4: Training Data in Json Format</figcaption></figure><p id="bff0" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">下一步是将上述数据转换成 spaCy 需要的格式。可以使用以下脚本来完成-</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="4f5e" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">现在我们已经为训练准备好了数据！让我们通过添加自定义实体来训练一个 NER 模型。</p><h2 id="e2b7" class="mf ke iq bd kf mg mh dn kj mi mj dp kn lm mk ml kr lq mm mn kv lu mo mp kz mq bi translated">使用自定义实体培训空间 NER</h2><p id="a2ca" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">SpaCy NER 已经支持像- <code class="fe mr ms mt mu b">PERSON</code>人这样的实体类型，包括虚构的。民族、宗教或政治团体。<code class="fe mr ms mt mu b">FAC</code>建筑、机场、公路、桥梁等。<code class="fe mr ms mt mu b">ORG</code>公司、机关、机构等。<code class="fe mr ms mt mu b">GPE</code>国家、城市、州等。</p><p id="0aa5" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">我们的目标是进一步训练这个模型，使其包含我们数据集中的自定义实体。要做到这一点，我们必须经历以下步骤-</p><ol class=""><li id="bbce" class="nj nk iq ld b le lz li ma lm nl lq nm lu nn ly ob np nq nr bi translated"><strong class="ld ir">加载模型</strong>，或使用带有所需语言 ID 的<code class="fe mr ms mt mu b"><a class="ae kc" href="https://spacy.io/api/top-level#spacy.blank" rel="noopener ugc nofollow" target="_blank">spacy.blank</a></code>创建一个<strong class="ld ir">空模型</strong>。如果正在使用空白模型，我们必须将实体识别器添加到<a class="ae kc" href="https://spacy.io/usage/processing-pipelines" rel="noopener ugc nofollow" target="_blank">管道</a>中。如果使用现有模型，我们必须在训练期间使用<code class="fe mr ms mt mu b"><a class="ae kc" href="https://spacy.io/api/language#disable_pipes" rel="noopener ugc nofollow" target="_blank">nlp.disable_pipes</a></code>禁用所有其他管道组件。这样，只有实体识别器得到训练。</li></ol><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="04a4" class="mf ke iq mu b gy nd ne l nf ng"># Setting up the pipeline and entity recognizer.</span><span id="757f" class="mf ke iq mu b gy oc ne l nf ng">if model is not None:<br/>    nlp = spacy.load(model)  # load existing spacy model<br/>    print("Loaded model '%s'" % model)<br/>else:<br/>    nlp = spacy.blank('en')  # create blank Language class<br/>    print("Created blank 'en' model")</span><span id="5104" class="mf ke iq mu b gy oc ne l nf ng">if 'ner' not in nlp.pipe_names:<br/>    ner = nlp.create_pipe('ner')<br/>    nlp.add_pipe(ner)<br/>else:<br/>    ner = nlp.get_pipe('ner')</span></pre><p id="f5c0" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">2.<strong class="ld ir">使用<code class="fe mr ms mt mu b"><a class="ae kc" href="https://spacy.io/api/entityrecognizer#add_label" rel="noopener ugc nofollow" target="_blank">add_label</a></code>方法将新的实体标签</strong>添加到实体识别器中。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="a362" class="mf ke iq mu b gy nd ne l nf ng"># Add new entity labels to entity recognizer</span><span id="ccfe" class="mf ke iq mu b gy oc ne l nf ng">for i in LABEL:<br/>    ner.add_label(i)</span><span id="aef0" class="mf ke iq mu b gy oc ne l nf ng"># Inititalizing optimizer</span><span id="4531" class="mf ke iq mu b gy oc ne l nf ng">if model is None:<br/>    optimizer = nlp.begin_training()<br/>else:<br/>    optimizer = nlp.entity.create_optimizer()</span></pre><p id="bce5" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">3.<strong class="ld ir">循环遍历</strong>示例，并调用<code class="fe mr ms mt mu b"><a class="ae kc" href="https://spacy.io/api/language#update" rel="noopener ugc nofollow" target="_blank">nlp.update</a></code>，逐步遍历输入的单词。在每一个单词上，它都会做出一个<strong class="ld ir">预测</strong>。然后，它查阅注释，看看它是否正确。如果它错了，它会调整它的权重，这样下次正确的动作会得到更高的分数。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="4573" class="mf ke iq mu b gy nd ne l nf ng"># Get names of other pipes to disable them during training to train # only NER and update the weights</span><span id="f844" class="mf ke iq mu b gy oc ne l nf ng">other_pipes = [pipe for pipe in nlp.pipe_names if pipe != 'ner']<br/>with nlp.disable_pipes(*other_pipes):  # only train NER<br/>    for itn in range(n_iter):<br/>        random.shuffle(TRAIN_DATA)<br/>        losses = {}<br/>        batches = minibatch(TRAIN_DATA, <br/>                            size=compounding(4., 32., 1.001))<br/>        for batch in batches:<br/>            texts, annotations = zip(*batch) <br/>            # Updating the weights<br/>            nlp.update(texts, annotations, sgd=optimizer, <br/>                       drop=0.35, losses=losses)<br/>        print('Losses', losses)</span><span id="4e32" class="mf ke iq mu b gy oc ne l nf ng">            nlp.update(texts, annotations, sgd=optimizer, <br/>                       drop=0.35, losses=losses)<br/>        print('Losses', losses)</span></pre><p id="0622" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">4.<strong class="ld ir">使用<code class="fe mr ms mt mu b"><a class="ae kc" href="https://spacy.io/api/language#to_disk" rel="noopener ugc nofollow" target="_blank">nlp.to_disk</a></code>保存</strong>训练好的模型。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="e10d" class="mf ke iq mu b gy nd ne l nf ng"># Save model <br/>if output_dir is not None:<br/>    output_dir = Path(output_dir)<br/>    if not output_dir.exists():<br/>        output_dir.mkdir()<br/>    nlp.meta['name'] = new_model_name  # rename model<br/>    nlp.to_disk(output_dir)<br/>    print("Saved model to", output_dir)</span></pre><p id="f5c7" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">5.<strong class="ld ir">测试</strong>模型，确保新实体被正确识别。</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="c771" class="mf ke iq mu b gy nd ne l nf ng"># Test the saved model<br/>print("Loading from", output_dir)<br/>nlp2 = spacy.load(output_dir)<br/>doc2 = nlp2(test_text)<br/>for ent in doc2.ents:<br/>    print(ent.label_, ent.text)</span></pre><p id="2717" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">使用此脚本来训练和测试模型-</p><figure class="mv mw mx my gt jr"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="db82" class="pw-post-body-paragraph lb lc iq ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">执行指令-</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="561c" class="mf ke iq mu b gy nd ne l nf ng">python spacy_ner_custom_entities.py \<br/>-m=en \ <br/>-o=path/to/output/directory \<br/>-n=1000</span></pre><h2 id="f5fc" class="mf ke iq bd kf mg mh dn kj mi mj dp kn lm mk ml kr lq mm mn kv lu mo mp kz mq bi translated">结果</h2><p id="c262" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当对查询- <code class="fe mr ms mt mu b">['John Lee is the chief of CBSE', 'Americans suffered from H5N1']</code>进行测试时，模型识别出以下实体-</p><pre class="mv mw mx my gt mz mu na nb aw nc bi"><span id="2c92" class="mf ke iq mu b gy nd ne l nf ng">John Lee is the chief of CBSE.</span><span id="0588" class="mf ke iq mu b gy oc ne l nf ng">B-per John</span><span id="83de" class="mf ke iq mu b gy oc ne l nf ng">I-per Lee</span><span id="31c5" class="mf ke iq mu b gy oc ne l nf ng">B-org CBSE</span><span id="de17" class="mf ke iq mu b gy oc ne l nf ng"><br/>Americans suffered from H5N1 virus in 2002.</span><span id="49e0" class="mf ke iq mu b gy oc ne l nf ng">B-gpe Americans</span><span id="2c69" class="mf ke iq mu b gy oc ne l nf ng">B-nat H5N1</span><span id="44af" class="mf ke iq mu b gy oc ne l nf ng">B-tim 2002</span></pre><h1 id="4fd6" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">结论</h1><p id="6d3e" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">我希望你现在已经明白了如何在斯帕西 NER 模型的基础上训练你自己的 NER 模型。感谢阅读！😊</p></div></div>    
</body>
</html>