<html>
<head>
<title>Test Time Augmentation (TTA) and how to perform it with Keras</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试时间增加(TTA)以及如何使用 Keras 进行测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/test-time-augmentation-tta-and-how-to-perform-it-with-keras-4ac19b67fb4d?source=collection_archive---------13-----------------------#2019-02-11">https://towardsdatascience.com/test-time-augmentation-tta-and-how-to-perform-it-with-keras-4ac19b67fb4d?source=collection_archive---------13-----------------------#2019-02-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ee4e441eb6a57876160fa428df9916aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lOhyHnqIlI7SmTPDDCp_KA.jpeg"/></div></div></figure><p id="220e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi kw translated">这里有很多方法可以通过改变我们<strong class="ka ir">训练</strong>神经网络的方式来改善它的结果。特别是，<em class="lf">数据扩充</em>是一种常见的做法，用于虚拟增加训练数据集的大小，也用作一种正则化技术，使模型对输入数据的微小变化更加稳健。</p><p id="433f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据扩充是对输入数据随机应用一些操作(旋转、缩放、移动、翻转等)的过程。通过这种方式，模型永远不会显示两次完全相同的示例，并且必须学习他必须识别的类的更多一般特征。</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/c3724e3a22f72fc7894a586763d96b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mjkg7ygVinP9SpOdr-P_AA.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Example of Data Augmentation on the CIFAR10 dataset</figcaption></figure><p id="850b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，也有一些方法可以通过改变我们<strong class="ka ir">测试</strong>它的方式来改善模型的结果，这就是<em class="lf">测试时间增加</em> (TTA)发挥作用的地方…</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h2 id="71fc" class="lw lx iq bd ly lz ma dn mb mc md dp me kj mf mg mh kn mi mj mk kr ml mm mn mo bi translated">什么是测试时间增加？</h2><p id="055e" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">类似于数据扩充对训练集所做的，测试时间扩充的目的是对测试图像执行随机修改。因此，我们将多次显示增强图像，而不是只向训练模型显示一次常规的“干净”图像。然后，我们将平均每个相应图像的预测，并把它作为我们的最终猜测。</p><p id="57c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是所有这些都将通过一个例子变得更加清晰。让我们以一个在 CIFAR10 上训练的神经网络为例，它呈现了以下测试图像:</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/9967bc7717e61eda7e4ed037c94d7599.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/format:webp/1*4xsO5L87o03UGbpCjGm7Cg.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">The test image (a boat)</figcaption></figure><p id="d5d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是模型的预测，表示为给定图像属于可能类别的置信度(最高分数对应于预测的标签):</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/12863fe3e08ac4d87156a1e654f6c4c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*y0BX3B_cKV_xNxwjhAHNcw.png"/></div></figure><p id="c803" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是这张图片的真实标签:</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/bed6b5b177d45037ec9311f3a26fceb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:538/format:webp/1*kueFyswOX8TSLsljIQm4Zg.png"/></div></figure><p id="f783" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到，模型在输出一个错误的答案，因为他最有信心图像属于第二类(对应汽车)，但正确答案是第九类(对应船)。</p><p id="428c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们增加测试时间，会发生什么？我们将呈现同一图像的 5 个稍微修改的版本，并要求网络预测它们中每一个的类别。</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/187ecee39702a507334467b38fe0bb31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XSMRcF7l5kGbBswnmiWKXw.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Modified version of the test image</figcaption></figure><p id="4854" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是相应的预测:</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/5794f16c07b50b8b687bd01e06c88ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*qY35vjQQts8RF5SUbM1CTw.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Prediction 1</figcaption></figure><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/f05c22607a0e70657809f9b7316d5de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*OL1cHSBWjoPVPz4Tf54D8w.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Prediction 2</figcaption></figure><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/0bdb222974c8652ee7022343014861d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*jBUOBHiNecoMwQ27YbMzbw.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Prediction 3</figcaption></figure><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/78ffccff1f4e2dc4d2ee73c3d181033a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*m_nEKAVT8MWPbjZyE5krnQ.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Prediction 4</figcaption></figure><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/58d27acd3d6b25322cc4abf7a228196f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*VsP6w0cn9GPrGkXQqR3LUQ.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Prediction 5</figcaption></figure><p id="5f6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如您所见，只有预测 1 和预测 4 是正确的，并具有合理的可信度。2 只在很小的范围内是正确的，而 3 和 5 是不正确的。如果我们取这 5 个结果的平均值，会发生什么？</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/105d6b8fe6aae69ea11e6c4201ac55cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*XiuS0kiHt5wn8GqyAwucsg.png"/></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Average of the 5 predictions</figcaption></figure><p id="cb13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以看到，均值给出了正确的答案，具有合理的置信度。因此，我们现在有了一个正确的<strong class="ka ir">答案，而不是有一个<strong class="ka ir">错误的</strong>答案，就像原始测试图像的情况一样。</strong></p><p id="4fd9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种方法有效的原因是，通过对随机修改的图像平均我们的预测，我们也平均了误差。在单个向量中，误差可能很大，导致错误的答案，但是平均起来，只有正确的答案会突出。</p><p id="f690" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">测试时间增加对于模型非常不确定的测试图像特别有用。即使这 5 张图片看起来与你非常相似，但从模型的预测来看，它们是非常不同的。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h2 id="5bbd" class="lw lx iq bd ly lz ma dn mb mc md dp me kj mf mg mh kn mi mj mk kr ml mm mn mo bi translated">如何搭配 Keras 使用？</h2><p id="5e61" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">测试时间增加可以很容易地与 Keras 一起使用，尽管在文档中没有明确提到。</p><p id="5608" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步是创建一个真正简单的卷积神经网络，我们将在 CIFAR10 上对其进行训练以进行演示:</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="df1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们可以通过使用<em class="lf"> ImageDataGenerator </em>类<em class="lf"> : </em>来定义我们想要在训练图像上执行的增强</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="90c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在可以为几个时期训练网络:</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="e117" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">验证图像上模型的最终精度为:</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/022f4964e9ded436fce23fe7481eea83.png" data-original-src="https://miro.medium.com/v2/resize:fit:112/format:webp/1*H82af9TN4BLH-6abYUAbZA.png"/></div></figure><p id="a80b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了增加测试时间，我们可以重用用于训练的同一<em class="lf">数据生成器</em>，并将其应用于验证图像。</p><p id="4222" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们可以向模型显示 10 次(例如)随机修改的图像，获得每次的预测，并取平均值:</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="0903" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们得到的精度是:</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/48a147a24d1846dfecfc2cbbb99921cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:106/format:webp/1*NOLm1WwYlhby2v-Kvpst4A.png"/></div></figure><p id="0343" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终精度提高了超过<strong class="ka ir"> 3% </strong>，没有对模型做任何改动！</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h2 id="79c2" class="lw lx iq bd ly lz ma dn mb mc md dp me kj mf mg mh kn mi mj mk kr ml mm mn mo bi translated">更多的数据扩充并不总是更好</h2><p id="925f" class="pw-post-body-paragraph jy jz iq ka b kb mp kd ke kf mq kh ki kj mr kl km kn ms kp kq kr mt kt ku kv ij bi translated">虽然数据扩充是获得更好结果的非常有效的技术，但是必须明智地使用它。如果使用不当，它会损害模型的准确性。我会告诉你为什么会这样:</p><figure class="lh li lj lk gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/c368636bbffe235d2ced46f2eb612ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OLwnYd-YhnZsAYWA2SFPtQ.png"/></div></div><figcaption class="ll lm gj gh gi ln lo bd b be z dk">Bad data augmentation on MNIST</figcaption></figure><blockquote class="nh ni nj"><p id="2d7c" class="jy jz lf ka b kb kc kd ke kf kg kh ki nk kk kl km nl ko kp kq nm ks kt ku kv ij bi translated">你能猜出每张图片中的数字吗？</p></blockquote><p id="a067" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">给你个提示，图中没有 6…</p><p id="d2c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你想做什么样的增强取决于你拥有的数据！在 MNIST 的例子中，你当然不希望进行随机翻转或太大的旋转，因为它们会完全改变图像的内容，6 可以翻转成 9，反之亦然，这使得你的模型很难学会区分这些类别。</p><p id="508a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，在像 CIFAR10 这样的数据库中，你完全想做水平翻转，因为它们不会改变图像，向右看或向左看的马仍然是马。但是在这里，垂直翻转也没有意义，因为您不太可能希望您的模型识别出一艘颠倒的船。</p><p id="e05e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在某些情况下，如卫星成像或作物栽培图像，颠倒的图像不会改变它们的含义，您可以使用大旋转和垂直翻转作为数据扩充。</p><p id="06b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">总之，只要你明智地使用，数据扩充既可以用于在<strong class="ka ir">训练</strong>时提升你的模型的结果，也可以用于<strong class="ka ir">测试</strong>时。</p><p id="a8d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">不要犹豫，试试 ImageDataGenerator 参数，看看它如何影响您的结果！</strong></p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h2 id="9551" class="lw lx iq bd ly lz ma dn mb mc md dp me kj mf mg mh kn mi mj mk kr ml mm mn mo bi translated">我希望这篇文章对新的深度学习实践者来说是清晰和有用的，并且它让你对什么是测试时间增加有了很好的了解！如果有不清楚的地方，请随时给我反馈或问我问题。</h2><blockquote class="nn"><p id="7572" class="no np iq bd nq nr ns nt nu nv nw kv dk translated">代码可从以下网址获得:</p></blockquote><div class="nx ny nz oa ob oc"><a href="https://github.com/nathanhubens/TTA-Keras" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">纳坦胡本斯/TTA-喀拉斯</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">在 GitHub 上创建一个帐户，为纳坦胡本斯/TTA-喀拉斯的发展做出贡献。</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">github.com</p></div></div><div class="ol l"><div class="om l on oo op ol oq jw oc"/></div></div></a></div></div></div>    
</body>
</html>