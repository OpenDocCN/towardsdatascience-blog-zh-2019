<html>
<head>
<title>Microbe Classification Using Deep Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用深度学习的微生物分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/microbe-classification-using-deep-learning-e84312046334?source=collection_archive---------16-----------------------#2019-08-23">https://towardsdatascience.com/microbe-classification-using-deep-learning-e84312046334?source=collection_archive---------16-----------------------#2019-08-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="62fd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用 fast.ai 文库对 12 种微生物进行分类</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/732607b9acf9c71c6ba38d044b2aee6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vPpRBLWNhic5SS-T"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@peter_mc_greats?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Pietro De Grandi</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="600e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">问题</strong>:使用光学显微镜进行微生物鉴定非常耗时，并且需要训练有素的微生物学家。深度学习算法能否成功区分 12 种不同类别的微生物？</p><p id="5204" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">数据</strong>:迪巴斯(<a class="ae ky" href="http://misztal.edu.pl/software/databases/dibas/" rel="noopener ugc nofollow" target="_blank">http://misztal.edu.pl/software/databases/dibas/</a>)</p><p id="a9c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">整个数据集包含 33 个不同属和物种的 660 幅图像。作为一个概念验证项目，我今天将只研究 12 个不同的类别:<em class="lv">鲍曼不动杆菌、以色列放线菌、脆弱拟杆菌、白色念珠菌、产气荚膜梭菌、粪肠球菌、大肠杆菌、单核细胞增生李斯特菌、淋病奈瑟菌、变形杆菌。、铜绿假单胞菌、金黄色葡萄球菌</em></p><p id="a3a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我选择了这 12 种微生物，因为它们是数据集中更具医学相关性的微生物。</p><p id="de98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个类别包括大约 20 幅图像，分辨率为 2048 x 1532 像素。样品进行革兰氏染色，并在油浸下使用 100 倍物镜进行评价。图像是用装有 SC30 照相机的 Olympus CX31 显微镜拍摄的。</p><p id="2fd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">设置</strong>:</p><ul class=""><li id="e43e" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">Jupyter 笔记本带 fasti.ai v1 库</li><li id="ed5c" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">ResNet-50 型号</li><li id="7a37" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">英伟达 RTX 2060 6GB</li></ul><p id="4701" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">结果</strong>:准确率 99.6%</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mk"><img src="../Images/b312a1d599a463b5f41f3d8235042b4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9uuZ-dmgvgHoSo9k"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@matyssik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ian Matyssik</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><p id="031f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第一部分:图像处理</strong></p><p id="ff1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我决定把图片分成更小的块，因为 2048 x 1532 的原始尺寸相当大。例如，看看下面的原始图像。微生物在物理上很小，如果我们将其大小调整为 224 x 224，边缘和集群等重要特征可能会丢失。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/a7c898afe8670178bb7746037783cc7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TteWkCbNlIB1kb0XaQauQg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Original 2048 x 1532 image</figcaption></figure><p id="8ae2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我编写了一个自定义函数来将图像分解成 224 x 224 的块。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="5a70" class="my mz it mu b gy na nb l nc nd">def process_image(im):<br/>    imarray = np.array(im)<br/>    im_h, im_w = imarray.shape[:2]<br/>    block_h, block_w = 224, 224<br/>    <br/>    for row in np.arange(im_h - block_h +1, step = block_h):<br/>        for col in np.arange(im_w - block_w +1, step = block_w):<br/>            im1 = imarray[row:row+block_h, col:col+block_w, :]<br/>            im1 = Image.fromarray(im1)<br/>            global i<br/>            global path<br/>            im1.save(path + "\img" + f"{i}" + ".png")<br/>            i+=1<br/>    print("completed")</span></pre><p id="f3b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我运行了每个类的代码，根据需要更改了文件夹名称。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="0b1c" class="my mz it mu b gy na nb l nc nd">from PIL import Image<br/>import numpy as np<br/>import os<br/>i=0<br/>path = r"C:\bacteria\<strong class="mu iu">Staphylococcus.aureus</strong>\edited"<br/>for file in os.listdir(r"C:\bacteria\<strong class="mu iu">Staphylococcus.aureus</strong>\raw"):<br/>    filename = r"C:\bacteria\<strong class="mu iu">Staphylococcus.aureus</strong>\raw" + f"\{file}"<br/>    im = Image.open(filename)<br/>    process_image(im)</span></pre><p id="17cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终产品看起来像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/5bc1cfd9e5ef09a5ae846ff03ee16a08.png" data-original-src="https://miro.medium.com/v2/resize:fit:448/format:webp/1*NyAdy_ZblGt_FE2819CCeA.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">224 x 224 image blocks</figcaption></figure><p id="e164" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于大多数原始图像，微生物均匀地分布在载玻片上。但是，某些类别(如念珠菌)的载玻片不太均匀，包含空白区域。为了解决这个问题，我仔细查看了最终产品，并手动删除了空白幻灯片。</p><p id="3145" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在已经为模型构建和培训做好了准备。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/7426e5925ff1e5ead8c83c8a6ff79567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y_-irqQSEobYy-i3"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@ro_ka?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Robert Katzki</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><p id="a293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第二部分:培训</strong></p><p id="0802" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们导入必要的模块。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="ee1b" class="my mz it mu b gy na nb l nc nd">from fastai.tabular import *<br/>from fastai.vision import *<br/>path = r"C:\bacteria\data"</span></pre><p id="f6d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的文件夹结构:父文件夹(C:\细菌\数据)→带有类名的子文件夹(C:\细菌\数据\念珠菌)→图片</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="f9f9" class="my mz it mu b gy na nb l nc nd">np.random.seed(42)<br/>data = ImageDataBunch.from_folder(path, valid_pct=0.2,<br/>        ds_tfms=get_transforms(), size=224, num_workers=4, bs=32).normalize(imagenet_stats)</span><span id="caf8" class="my mz it mu b gy ng nb l nc nd">data.classes, data.c, len(data.train_ds), len(data.valid_ds)</span></pre><p id="2878" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有 12 个不同的类，有 10，234 个训练图像和 2，558 个验证图像。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="929c" class="my mz it mu b gy na nb l nc nd">learn = cnn_learner(data, models.resnet50, metrics=accuracy).to_fp16()</span></pre><p id="6422" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Fasti.ai 支持混合精度训练，添加<strong class="lb iu">一样简单。to_fp16() </strong>构建学习器时。对于那些使用英伟达 RTX 显卡的人来说，混合精度大大加快了训练速度，并将内存需求减半。Eric 有一篇关于这方面的优秀文章，你可以在这里阅读:<a class="ae ky" rel="noopener" target="_blank" href="/rtx-2060-vs-gtx-1080ti-in-deep-learning-gpu-benchmarks-cheapest-rtx-vs-most-expensive-gtx-card-cd47cd9931d2">https://towardsdatascience . com/RTX-2060-vs-gtx-1080 ti-in-deep-learning-GPU-benchmarks-priest-RTX-vs-most-贵-gtx-card-cd47cd9931d2 </a></p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="a7b5" class="my mz it mu b gy na nb l nc nd">learn.fit_one_cycle(4)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/2dd4e10191875382eaee3cf71879d68c.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*kxjV9gaIWnR3k07sWVzBSQ.png"/></div></figure><p id="4a1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使没有训练最高层，结果看起来也相当不错。我们现在将解冻顶层，并找到一个合适的学习率。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="1b71" class="my mz it mu b gy na nb l nc nd">learn.unfreeze()<br/>learn.lr_find()<br/>learn.recorder.plot()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/5719b621877c2f662ec7484777d83b5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*8H8R5j09W0JM1nNRybnV4Q.png"/></div></figure><p id="ad62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我以降低的学习率进一步训练了整个模型。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="699e" class="my mz it mu b gy na nb l nc nd">learn.fit_one_cycle(10, max_lr=slice(7e-5, 9e-4))</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/af538c0e7c9cb1d1e52bbc967e3549ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/1*LaY2IaL5oYQ_bGBGdyb9IQ.png"/></div></figure><p id="5998" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 10 个周期结束时，我们达到了 99.6%的准确率<strong class="lb iu"/>。没有明显的过度拟合，因为训练和验证损失是相似的。让我们来看看混淆矩阵。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="887a" class="my mz it mu b gy na nb l nc nd">interp = ClassificationInterpretation.from_learner(learn)<br/>interp.plot_confusion_matrix(figsize=(10,10), dpi=100)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/b642f59cd1e589d3ed99115f42ecb15f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kAqvobL15rJVF0QBmHtKYw.png"/></div></div></figure><p id="ed57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主要错误似乎来自变形杆菌对假单胞菌和大肠杆菌对变形杆菌。这是可以理解的，因为所有 3 个物种都是革兰氏阴性杆菌，它们染色并且在光学显微镜下看起来相似。让我们来看看损失最大的图片。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="db6f" class="my mz it mu b gy na nb l nc nd">interp.plot_top_losses(6, figsize=(15,15))</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/c215bfa9847c1d9377afbc0d3ba1d985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x4YaiCjwtoPNaQkV_o2ZFQ.png"/></div></div></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><p id="8d15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总之，在这个相当困难的任务上，我们达到了令人钦佩的 99.6%的准确率。事实上，我对这种表现感到相当惊讶，因为很难在视觉上区分某些类。比如你能分辨出葡萄球菌吗？金黄色葡萄球菌和肠球菌。fecalis 分开？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a3a6db14dcf537886c6b778ceec71e5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AzVvNSlD7JstkL0kGhKv4A.png"/></div></div></figure><p id="dc5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也许这个模型正在学习我还没有认识到的特征，需要进一步的工作来提高这个模型的“可解释性”。</p><p id="c3bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/3ae581f7f6785d8859b5675e1ca0b239.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BQPUzGAfS4CXbNf1"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@ethandow?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Ethan Dow</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div>    
</body>
</html>