<html>
<head>
<title>Predicting Taxi fares in NYC using Google Cloud AI Platform (Billion + rows) Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用谷歌云人工智能平台预测纽约市的出租车价格(十亿多行)第 1 部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-taxi-fares-in-nyc-using-google-cloud-ai-platform-billion-rows-part-1-ac121832babf?source=collection_archive---------18-----------------------#2019-10-07">https://towardsdatascience.com/predicting-taxi-fares-in-nyc-using-google-cloud-ai-platform-billion-rows-part-1-ac121832babf?source=collection_archive---------18-----------------------#2019-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f7f94d2bc24922e54d3c9fad01612b7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C291SIqt9-QFSP6-WSfpvA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Taxis | Photo by Francesco Ungaro on pexels.com</figcaption></figure><p id="5b2e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">该项目旨在创建一个机器学习模型，使用 BigQuery 中托管的出租车乘坐数据集来估计纽约市的出租车费用。有超过 a <strong class="kh iu">十亿</strong>行的大小为 130 GB。你可以在这里找到<a class="ae ld" href="https://console.cloud.google.com/bigquery?project=bigquery-public-data&amp;p=nyc-tlc&amp;d=yellow&amp;t=trips&amp;page=table" rel="noopener ugc nofollow" target="_blank">。这篇文章是基于我在谷歌云平台</a><a class="ae ld" href="https://www.coursera.org/specializations/machine-learning-tensorflow-gcp" rel="noopener ugc nofollow" target="_blank">专业化</a>上使用 TensorFlow 进行机器学习的经验。</p><p id="2ea3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">首先，我们必须在 Google 云平台上建立一个项目，并启动一个笔记本实例。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi le"><img src="../Images/373fa08790fda9403772e7b3f4aced8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*qs4A57XyxWB3vi56lLhWRw.png"/></div></figure><p id="d896" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这个实例将花费我们大约每小时<strong class="kh iu">0.14 美元</strong>。我们还需要启用计算引擎 API 并创建一个存储桶。</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/7611778e49f10ab72b7f418ff86408d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*Dm_Dvmpic7fZrGfuAiajCQ.png"/></div></figure><h2 id="c9d1" class="lk ll it bd lm ln lo dn lp lq lr dp ls kq lt lu lv ku lw lx ly ky lz ma mb mc bi translated"><strong class="ak">数据准备</strong></h2><p id="c6d9" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated"><strong class="kh iu">安装 BigQuery 库并预览数据</strong></p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mi"><img src="../Images/7bfb75b519fe48a550d5b5be2916ed22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r10pyfatWemFeTmOD90kGA.png"/></div></div></figure><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mj"><img src="../Images/5e62229ab2db530b822a811f62bcf79c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DrihbG_ivcuorbIgdPVt7g.png"/></div></div></figure><p id="b9b9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们使用<strong class="kh iu"> RAND() </strong>函数从这个庞大的数据集中抽取一个<strong class="kh iu">小样本</strong>。</p><p id="f978" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">缺点是我们每次运行这个查询都会得到不同的样本。因此，我们将使用散列函数。</p><pre class="lf lg lh li gt mk ml mm mn aw mo bi"><span id="2e7c" class="lk ll it ml b gy mp mq l mr ms">MOD(ABS(FARM_FINGERPRINT(CAST(pickup_datetime AS STRING))), 5000)= 1</span></pre><p id="283b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">此功能使我们能够获得原始数据的<strong class="kh iu"> 0.02% </strong>的恒定样本。利用整个数据集进行探索需要巨大的计算能力。我计划将来使用整个数据集建立一个模型。</p><p id="0bfc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">将数据加载到熊猫数据框架中</strong></p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/eb9db2185bdf41fa37a0f8f04331cb77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*QYF8-Q2SybD9no3fsDFN4Q.png"/></div></figure><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mu"><img src="../Images/b3fe1e8675df7880b1d3f16960f57e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iuSrbrfWLQzyrIRORbYqmA.png"/></div></div></figure><p id="b0c6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们肯定需要清理我们的数据。比如经纬度值关(纬度应该在-90°到 90°之间；经度应该在-180 到 180 之间)。有些行程的票价为负数，有些行程的乘客数为零。</p><p id="bb08" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们画出<strong class="kh iu">行程 _ 距离</strong> vs <strong class="kh iu">车费 _ 金额</strong></p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/01428c8fe11d88c0eb107f2f0ba3a6f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*9SS0bKhw3QxsR8QEoVqivA.png"/></div></figure><p id="3b78" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一些坏数据被编码为零。此外，我们不打算在预测中包括小费，因为他们往往是不可预测的。我们的目标变量将是<strong class="kh iu">票价 _ 金额+通行费 _ 金额</strong></p><p id="761a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">我们的预测值是:</strong></p><blockquote class="mw"><p id="ab8f" class="mx my it bd mz na nb nc nd ne nf lc dk translated">拾取日期时间</p><p id="be28" class="mx my it bd mz na nb nc nd ne nf lc dk translated">收件人 _ 经度</p><p id="7ffb" class="mx my it bd mz na nb nc nd ne nf lc dk translated">皮卡 _ 纬度</p><p id="9c6e" class="mx my it bd mz na nb nc nd ne nf lc dk translated">经度下降</p><p id="3e85" class="mx my it bd mz na nb nc nd ne nf lc dk translated">下降纬度</p></blockquote><p id="8a65" class="pw-post-body-paragraph kf kg it kh b ki ng kk kl km nh ko kp kq ni ks kt ku nj kw kx ky nk la lb lc im bi translated">我们选择这些是因为它们最符合我们的目标。有人可能会争辩说,<strong class="kh iu"> trip_distance </strong>可以帮助我们确定费用，但是我们排除了它，因为它并不总是可以提前知道的。我们的项目可能会应用于打车行业，我们可以提前预测出行成本，为了准确起见，应该选择源/目的地的位置坐标而不是 trip_distance。</p><p id="4a3b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">数据清理</strong></p><p id="956d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们遵循以下原则来过滤不合理的数据:</p><ul class=""><li id="592c" class="nl nm it kh b ki kj km kn kq nn ku no ky np lc nq nr ns nt bi translated">票价金额应大于<strong class="kh iu"> $2.5 </strong></li><li id="4c16" class="nl nm it kh b ki nu km nv kq nw ku nx ky ny lc nq nr ns nt bi translated">出发地/目的地位置坐标应在纽约市限制范围内</li><li id="591b" class="nl nm it kh b ki nu km nv kq nw ku nx ky ny lc nq nr ns nt bi translated">乘客数量不能为零</li><li id="7486" class="nl nm it kh b ki nu km nv kq nw ku nx ky ny lc nq nr ns nt bi translated">行程距离不能为零</li></ul><pre class="lf lg lh li gt mk ml mm mn aw mo bi"><span id="c3c2" class="lk ll it ml b gy mp mq l mr ms">SELECT<br/>  (tolls_amount + fare_amount) AS fare_amount, -- label<br/>  pickup_datetime,<br/>  pickup_longitude, <br/>  pickup_latitude, <br/>  dropoff_longitude, <br/>  dropoff_latitude<br/>FROM<br/>  `nyc-tlc.yellow.trips`<br/>WHERE<br/>  -- Clean Data<br/>  trip_distance &gt; 0<br/>  AND passenger_count &gt; 0<br/>  AND fare_amount &gt;= 2.5<br/>  AND pickup_longitude &gt; -78<br/>  AND pickup_longitude &lt; -70<br/>  AND dropoff_longitude &gt; -78<br/>  AND dropoff_longitude &lt; -70<br/>  AND pickup_latitude &gt; 37<br/>  AND pickup_latitude &lt; 45<br/>  AND dropoff_latitude &gt; 37<br/>  AND dropoff_latitude &lt; 45<br/>  -- repeatable 1/5000th sample<br/>  AND MOD(ABS(FARM_FINGERPRINT(CAST(pickup_datetime AS STRING))),5000) = 1</span></pre><p id="9151" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们通过从<strong class="kh iu"> pickup _datetime </strong>中获取<strong class="kh iu"> dayofweek </strong>和<strong class="kh iu"> hourofday </strong>来创建一些分类特征</p><pre class="lf lg lh li gt mk ml mm mn aw mo bi"><span id="817f" class="lk ll it ml b gy mp mq l mr ms">SELECT<br/>  (tolls_amount + fare_amount) AS fare_amount, -- label<br/>  EXTRACT(DAYOFWEEK from pickup_datetime) AS dayofweek,<br/>  EXTRACT(HOUR from pickup_datetime) AS hourofday,<br/>  ------------------<br/>  ------------------</span></pre><p id="2516" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">将数据分为训练集、验证集和测试集</strong></p><p id="73f8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们将我们的<strong class="kh iu">1/5000</strong>样本<strong class="kh iu">分成 70–15–15</strong></p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/0bc7b0fc6da6651970736d9e1ce63e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0HYhT1k1tNawh3sikF9Few.png"/></div></div></figure><p id="7eb4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">将数据写入 CSV </strong></p><p id="62d1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在接下来的步骤中，我们将使用<strong class="kh iu"> TensorFlow </strong>创建一个机器学习模型，它直接从 BigQuery 读取文件很慢。因此，我们将数据写成<strong class="kh iu">。csv </strong>文件</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/baa15b57d8927c283ab45f401e91bcb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*5G0uFXMLXSpRK9tgmMZR4w.png"/></div></figure><p id="bd3c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">假设我们只使用了总数据的一个样本(0.02%)，我们还有 151k 行可以训练，这已经很不错了。</p><p id="8672" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们讨论模型创建的下一篇文章可以在<a class="ae ld" href="https://medium.com/@tejanirla4/predicting-taxi-fares-in-nyc-using-google-cloud-ai-platform-billion-rows-part-2-f0191a70dea8" rel="noopener">这里</a>找到。</p><p id="b099" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在<a class="ae ld" href="http://www.linkedin.com/in/tejan-irla" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上和我联系。你可以在这里找到完整的代码<a class="ae ld" href="https://github.com/tejanirla/cab_fare_prediction/blob/master/taxi_fare_data_preparation.ipynb" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="f9d1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">干杯！！</p></div></div>    
</body>
</html>