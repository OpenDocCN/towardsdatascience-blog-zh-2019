<html>
<head>
<title>Pneumonia detection from chest radiograph using deep learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于深度学习的胸片肺炎检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pneumonia-detection-from-chest-radiograph-cxr-d02c2fc11609?source=collection_archive---------23-----------------------#2019-11-25">https://towardsdatascience.com/pneumonia-detection-from-chest-radiograph-cxr-d02c2fc11609?source=collection_archive---------23-----------------------#2019-11-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b59afb70ae9be07c44cd401b8c4c19a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYl_E_UWRdLhtHzFYmAnfQ.png"/></div></div></figure><p id="dd34" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">肺炎占全球 5 岁以下儿童死亡总数的 15%以上。2015 年，有 92 万名 5 岁以下儿童死于该疾病。虽然肺炎很常见，但准确诊断却很困难。它需要由训练有素的专家审查胸片(CXR ),并通过临床病史、生命体征和实验室检查进行确认。</p><h1 id="0b8f" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">胸片基础知识</h1><p id="2cc7" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">在拍摄图像的过程中，<a class="ae mc" href="https://en.wikipedia.org/wiki/X-ray" rel="noopener ugc nofollow" target="_blank"> X 射线</a>穿过身体，到达另一侧的探测器。具有稀疏物质的组织，如充满空气的肺，不吸收 X 射线，在图像中显示为黑色。骨骼等致密组织吸收 X 射线，在图像中显示为白色。简而言之</p><p id="f6cd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">*黑色=空气</p><p id="9c3e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">*白色=骨头</p><p id="9636" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">*灰色=组织或液体</p><p id="66e4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">按照惯例，主体的左侧在屏幕的右侧。还可以看到右上角的小 L。我们在正常图像中看到的肺部是黑色的，但它们有不同的投影——主要是胸腔骨骼、主气道、血管和心脏。</p><p id="76fe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">胸部 x 光照片示例如下:</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi md"><img src="../Images/a028fdf6bc60776605340f5fe011fef2.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*74PoyiDWRlryCoMo34wlAQ.png"/></div></figure><p id="1a36" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">肺炎通常表现为 CXR 上一个或多个区域的肺部阴影增加。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/8a52c7e517851ae889ea012ca689c328.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*Xls4tkYJRUbQ7kWcQ3RPVA.png"/></div></figure><p id="befe" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，在 CXR 上肺炎的诊断是复杂的，因为肺部有许多其他情况，如液体超载(肺水肿)、出血、容量损失(肺不张或虚脱)、肺癌、或放疗后或手术后的变化。在肺外，胸膜腔内的液体(胸腔积液)在 CXR 上也表现为阴影增加。如果可以的话，比较患者在不同时间点的 CXRs 以及与临床症状和病史的相关性有助于做出诊断。</p><p id="5256" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，临床医生每次轮班都要阅读大量图像。疲劳或分心的临床医生可能会错过图像中的重要细节。在这里，自动图像分析工具可以提供帮助。例如，<strong class="kd iu">人们可以使用机器学习来自动进行潜在肺炎病例的初步检测(成像筛查)，以便优先考虑和加快他们的审查</strong>。因此，我们决定开发一种从胸片中检测肺炎的模型。</p><h1 id="c9db" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">资料组</h1><p id="260f" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们使用了来自 kaggle 的<a class="ae mc" href="https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/overview" rel="noopener ugc nofollow" target="_blank"> RSNA 肺炎检测挑战</a>的数据集。这是一个带有注释的胸部 x 光数据集，它显示了肺部的哪一部分有肺炎的症状。</p><h1 id="dd8b" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak">安装机器学习工具</strong></h1><p id="0400" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们将使用<a class="ae mc" href="https://www.intelec.ai" rel="noopener ugc nofollow" target="_blank"> Intelec AI </a>训练一个检测肺炎的模型。你可以从这里免费下载并安装<a class="ae mc" href="https://www.intelec.ai/install" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="4c92" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak">数据准备</strong></h1><p id="908e" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们从 kaggle 下载了训练图像(stage_2_train_images.zip)和注释(stage_2_train_labels.csv) <a class="ae mc" href="https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/data" rel="noopener ugc nofollow" target="_blank">。注释文件如下所示:</a></p><pre class="me mf mg mh gt mj mk ml mm aw mn bi"><span id="2788" class="mo la it mk b gy mp mq l mr ms">import pandas as pd</span><span id="a3f2" class="mo la it mk b gy mt mq l mr ms">ann = pd.read_csv('stage_2_train_labels.csv')<br/>ann.head()</span></pre><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/7a504639d7cc69df981875b2907a0533.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*BwXgsqEtv_kXcg4PBiyllA.png"/></div></figure><p id="1e00" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上图中的第一行对应于编号为“0004 CFA b-14fd-4e 49–80ba-63 a80 b 6 bddd 6”的患者。此行的“目标”列为 0。意味着这个病人没有肺炎。另一方面，最后一排的患者患有肺炎，因为相应的胸片上的区域(xmin = 264，ymin = 152，宽度= 213，高度= 379)具有不透明。</p><p id="0e4c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们决定用<strong class="kd iu"> SSD 物体探测器</strong>。Intelec AI 要求注释文件包含 image_name、xmin、ymin、xmax、ymax 和 class_name 列。因此，我们将数据转换成这种格式:</p><pre class="me mf mg mh gt mj mk ml mm aw mn bi"><span id="10f1" class="mo la it mk b gy mp mq l mr ms">ann['image_name'] = ann.patientId + '.dcm'<br/>ann = ann.rename(columns = {'x': 'xmin', 'y': 'ymin'})<br/>ann['xmax'] = ann.xmin + ann.width<br/>ann['ymax'] = ann.ymin + ann.height</span><span id="c784" class="mo la it mk b gy mt mq l mr ms">ann['class_name'] = np.NaN<br/>ann['class_name'][pd.notna(ann.xmin)] = 'pneumania'<br/>ann = ann[['image_name', 'xmin', 'ymin', 'xmax', 'ymax', 'class_name']]</span><span id="1aa9" class="mo la it mk b gy mt mq l mr ms">ann.head(10)</span></pre><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/4f3d9c021838d23e205dd998aa421404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*7P3V7XzgHPawQcTJpezBpg.png"/></div></figure><p id="7313" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上图中的前 4 幅图像(第 0-3 行)没有肺炎注释。另一方面，图像“00436515–870 c-4b 36-a041-de 91049 b 9 ab 4 . DCM”有两个注释(第 4 行和第 5 行)。我们将其保存在“annotations.csv”文件中。</p><p id="5379" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，我们创建一个“images”文件夹，并从 stage_2_train_images.zip 中提取所有图像。所有提供的图像都是 DICOM 格式。dcm)。</p><pre class="me mf mg mh gt mj mk ml mm aw mn bi"><span id="3481" class="mo la it mk b gy mp mq l mr ms">import os<br/>images = os.listdir('images')<br/>images[:5]</span></pre><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/745595473d9a8f6ce4c8f330b9006f33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qBqrzcgvKh4qtwMUBbswTw.png"/></div></div></figure><p id="87fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，我们的数据集看起来像这样:</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/f37c72e44d72e85e0e73f52603b43e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DSADRmNkgBN5AjLs3dVpkQ.png"/></div></div></figure><p id="fdea" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我们创建了一个训练来训练我们的 SSD 对象检测器。事情是这样简单明了的:</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi my"><img src="../Images/37c1eaee7d76b6f90cf9eb6c160d8c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*vzpBDksfPPfehvWHmBhfKg.png"/></div></figure><p id="6d87" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们开始训练，它跑了一天。当它不能再提高训练精度时，它就自动停止训练。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mz"><img src="../Images/f2448c11978418b3ffba703b68289c07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*not_vdIT6scUpa0ywwkiPg.png"/></div></div></figure><p id="c521" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">点击训练总结显示<strong class="kd iu">地图得分 0.2725 </strong>。我们部署它是为了检查它的性能。使用新的胸部 x 光照片测试展开的模型给出了以下结果:</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi na"><img src="../Images/6553aec573d9d6be3f5e3d85508ffb2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*CIPJeHB_VT3TeRMORjgF6Q.png"/></div></figure><p id="a7a7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">预测看起来不错。但是它有多好，我们真的不能说，因为我们的团队中没有任何临床医生。</p><h1 id="0462" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">改进建议</h1><p id="0f61" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">从图像中检测肺炎仍然是一项需要使用深度学习来解决的困难任务。我们获得的地图分数 0.2725 很低。对于大多数对象检测任务，它通常高于 0.5。问题是，对象检测器擅长检测具有预定义形状和外观的对象。另一方面，肺部阴影没有精确的形状。这使得这个问题变得如此困难。我们将对如何进一步提高精度给出一些想法。</p><h2 id="1e6e" class="mo la it bd lb nb nc dn lf nd ne dp lj km nf ng ln kq nh ni lr ku nj nk lv nl bi translated">招数一:检测前分类</h2><p id="10d2" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">我们观察到，我们的算法有很高的假阳性率，即它在图像中检测到肺炎，而它不应该检测到肺炎。因此，如果我们将给定的胸片分类为“有无肺炎”,并且仅在它有肺炎的情况下用目标检测器检测肺炎症状，这将大大提高检测准确性。</p><h2 id="1826" class="mo la it bd lb nb nc dn lf nd ne dp lj km nf ng ln kq nh ni lr ku nj nk lv nl bi translated">招数二:先检测肺部</h2><p id="a016" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">另一个问题是，在胸片中，不透明度(“白色像素”)也存在于肺的外部。但是我们总是检测肺部阴影，因为我们知道肺炎与肺部问题有关。我们可以让我们的对象检测器从训练数据中学习这一点，或者我们可以帮助它单独检测肺部，并在下一步检测肺部的肺炎。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/c80d958ef2e7712caa8d61ff10a60b9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*pjY4ifDKLzwP8HeIZU_uvQ.png"/></div></figure><h1 id="2dbb" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">参考</h1><p id="3960" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">Intel EC AI:https://www . Intel EC . AI</p><p id="6529" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">RSNA 肺炎检测挑战:<a class="ae mc" href="https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/c/rsna-Pneumonia-Detection-Challenge/</a></p><p id="526c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">什么是肺部阴影？https://www.kaggle.com/zahaviguy/what-are-lung-opacities<a class="ae mc" href="https://www.kaggle.com/zahaviguy/what-are-lung-opacities" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>