<html>
<head>
<title>Hey Model, Why Do You Say This Is Spam?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å˜¿ï¼Œæ¨¡ç‰¹ï¼Œä½ ä¸ºä»€ä¹ˆè¯´è¿™æ˜¯åƒåœ¾é‚®ä»¶ï¼Ÿ</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://towardsdatascience.com/hey-model-why-do-you-say-this-is-spam-7c945cc531f?source=collection_archive---------16-----------------------#2019-11-07">https://towardsdatascience.com/hey-model-why-do-you-say-this-is-spam-7c945cc531f?source=collection_archive---------16-----------------------#2019-11-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="353d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">å°†åŸå› é™„åŠ åˆ°æ¨¡å‹é¢„æµ‹</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d0ec9de42d94ed30b3c36ec0d5700a6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DHjQ2BNJElQ21biueQgXMQ.png"/></div></div></figure></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><p id="711e" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Shapley å€¼åœ¨æœºå™¨å­¦ä¹ ä¸­ç”¨äºè§£é‡Šå¤æ‚é¢„æµ‹æ¨¡å‹çš„é¢„æµ‹ï¼Œ<em class="lu">åˆå</em>â€œé»‘ç›’â€ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ Shapley å€¼æ¥ç¡®å®š YouTube è¯„è®ºçš„å…³é”®æœ¯è¯­ï¼Œè¿™äº›æœ¯è¯­è§£é‡Šäº†ä¸ºä»€ä¹ˆä¸€ä¸ªè¯„è®ºè¢«é¢„æµ‹æ¨¡å‹é¢„æµ‹ä¸ºåƒåœ¾æˆ–åˆæ³•ã€‚ç‰¹å®šå…³é”®æœ¯è¯­çš„â€œè”ç›Ÿâ€å¯ä»¥è¢«è®¤ä¸ºæ˜¯æ¨¡å‹è¿”å›ç»™å®šé¢„æµ‹çš„â€œåŸå› â€ã€‚æ­¤å¤–ï¼Œæˆ‘å°†ä½¿ç”¨èšç±»æ¥è¯†åˆ«åœ¨å¦‚ä½•ä½¿ç”¨è¿™äº›å…³é”®æœ¯è¯­æ–¹é¢æœ‰ç›¸ä¼¼ä¹‹å¤„çš„è¯„è®ºç»„ã€‚æœ€åï¼Œæˆ‘å°†è¿›ä¸€æ­¥æ¦‚æ‹¬é¢„æµ‹åŸå› ï¼Œä»¥ä¾¿ä½¿ç”¨ä»£è¡¨åŸå› ç±»åˆ«çš„æ›´å°‘å…³é”®æœ¯è¯­çš„å­—å…¸å¯¹è¯„è®ºç»„è¿›è¡Œåˆ†ç±»ã€‚</p><h2 id="6564" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">åºæ–‡</h2><p id="f13e" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">éµå¾ªè¿™ç¯‡æ–‡ç« ä¸­çš„ä»£ç ç‰‡æ®µéœ€è¦ Python å’Œ rã€‚åŒ…å«æ‰€æœ‰ä»£ç ç‰‡æ®µçš„å®Œæ•´ Jupyter ç¬”è®°æœ¬å¯ä»¥åœ¨<a class="ae mt" href="https://gist.github.com/alessiot/769ebe433adf79725b08687cf889f4cb" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚è¿è¡Œä»£ç æ‰€éœ€çš„ Python åº“å¦‚ä¸‹ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<em class="lu"> rpy2 </em>åº“åœ¨ Python ä¸­è¿è¡Œ R çš„å®ä¾‹ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="2ea1" class="lv lw iq mv b gy mz na l nb nc">import rpy2.ipython</span><span id="4070" class="lv lw iq mv b gy nd na l nb nc">from rpy2.robjects import pandas2ri</span><span id="8011" class="lv lw iq mv b gy nd na l nb nc">pandas2ri.activate()</span><span id="3ea6" class="lv lw iq mv b gy nd na l nb nc">%reload_ext rpy2.ipython</span><span id="ad50" class="lv lw iq mv b gy nd na l nb nc">from sklearn import model_selection, preprocessing, metrics, svm<br/>from sklearn.feature_extraction.text import CountVectorizer<br/>from sklearn import decomposition, ensemble</span><span id="4cc5" class="lv lw iq mv b gy nd na l nb nc">import pandas as pd<br/>import numpy as np</span><span id="f137" class="lv lw iq mv b gy nd na l nb nc">import string</span><span id="8338" class="lv lw iq mv b gy nd na l nb nc">import matplotlib.pyplot as plt<br/>import seaborn as sns<br/>%matplotlib inline</span><span id="2fc2" class="lv lw iq mv b gy nd na l nb nc">import xgboost</span><span id="3a0a" class="lv lw iq mv b gy nd na l nb nc">import shap, time</span></pre><h2 id="87a1" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated"><em class="ne">æ²™æ™®åˆ©æ³•</em></h2><p id="8bd6" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">æ²™æ™®åˆ©å€¼æ˜¯åœ¨åˆä½œåšå¼ˆç†è®ºä¸­è¿›è¡Œçš„ä¸€é¡¹ç ”ç©¶çš„ç»“æœã€‚ä»–ä»¬å‘Šè¯‰å¦‚ä½•åœ¨ç©å®¶ä¹‹é—´å…¬å¹³åˆ†é…â€œå¥–é‡‘â€ã€‚å½“ä½¿ç”¨å…ˆå‰è®­ç»ƒçš„æ¨¡å‹é¢„æµ‹æ•°æ®å®ä¾‹çš„æ ‡ç­¾æ—¶ï¼Œå¯ä»¥é€šè¿‡å‡è®¾æ•°æ®å®ä¾‹çš„æ¯ä¸ªç‰¹å¾å€¼æ˜¯æ¸¸æˆä¸­çš„ç©å®¶æ¥è§£é‡Šè¯¥é¢„æµ‹ï¼Œå…¶ä¸­è¯¥é¢„æµ‹æ˜¯æ”¯å‡ºã€‚Shapley å€¼æ˜¯æ‰€æœ‰å¯èƒ½çš„è¦ç´ ç»„åˆä¸­æŸä¸ªè¦ç´ å€¼çš„å¹³å‡è¾¹é™…è´¡çŒ®ã€‚Christoph Molnar çš„åœ¨çº¿ä¹¦ç±æä¾›äº†æ›´å¤šçš„ç»†èŠ‚ã€‚</p><p id="7e3a" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ä»‹ç» Shapley æ–¹æ³•:XOR è¡¨ã€‚æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­è¿›è¡Œæ›´è¯¦ç»†çš„è®¨è®ºã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="3b59" class="lv lw iq mv b gy mz na l nb nc">data = {'F1':[0,0,1,1], 'F2':[0,1,0,1], "Target":[0,1,1,0]} #XOR<br/>df = pd.DataFrame(data)</span><span id="d3ff" class="lv lw iq mv b gy nd na l nb nc">X = df[["F1","F2"]]<br/>y = df["Target"].values.tolist()</span><span id="322e" class="lv lw iq mv b gy nd na l nb nc">df</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/b57b06f7481358643412ee28449bfc45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LyC6SMcvQyz6lvbTmgzNeg.png"/></div></div></figure><p id="e865" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¸ºäº†è®¡ç®— Shapley å€¼ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è®­ç»ƒä¸€ä¸ªæ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å¾„å‘åŸºå‡½æ•°æ ¸çš„ SVMã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨ Python åº“<em class="lu"> shap </em>è®¡ç®— Shapley å€¼ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="67ff" class="lv lw iq mv b gy mz na l nb nc">clf = sklearn.svm.SVC(kernel='rbf', probability=False).fit(X, y) </span><span id="46ee" class="lv lw iq mv b gy nd na l nb nc">df["Prediction"] = clf.predict(X)</span><span id="f12e" class="lv lw iq mv b gy nd na l nb nc"># Explaining the probability prediction results<br/>explainer = shap.KernelExplainer(clf.predict, X)<br/>shap_values = explainer.shap_values(X)</span><span id="e4a0" class="lv lw iq mv b gy nd na l nb nc">pd.concat([df, pd.DataFrame(shap_values, <br/>           columns='shap_'+ X.columns.values)], axis=1)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/405ada786d1e1553268f57ca21e8ffaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMLvWD8KOm3sCIDaoRzr_w.png"/></div></div></figure><p id="37ab" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä»ä¸Šè¿°ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå½“æ¯ä¸ªæ•°æ®å®ä¾‹çš„ä¸¤ä¸ªç‰¹å¾çš„è®¡ç®—è´¡çŒ®(Shapley å€¼)éƒ½ä¸ºè´Ÿæ—¶ï¼Œé¢„æµ‹ä¸º 0ï¼Œå½“ Shapley å€¼éƒ½ä¸ºæ­£æ—¶ï¼Œé¢„æµ‹ä¸º 1ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªè´¡çŒ®åŠ èµ·æ¥å°±æ˜¯è¯¥å®ä¾‹<em class="lu">çš„é¢„æµ‹ä¸é¢„æœŸé¢„æµ‹ğ¸(ğ‘“ä¹‹é—´çš„åˆå§‹å·®å€¼ï¼Œå®ƒæ˜¯å®é™…ç›®æ ‡å€¼çš„å¹³å‡å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤º:</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/28c9ea688f3374a250b97fb1a9a5b8c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PHFrMnvTUQEbWS7H1t45zg.png"/></div></div></figure><h2 id="0e2c" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">YouTube åƒåœ¾è¯„è®º</h2><p id="650f" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªæ–‡æœ¬åˆ†ç±»æ•°æ®é›†ï¼Œä» 5 ä¸ªä¸åŒçš„ YouTube è§†é¢‘ä¸­æ”¶é›†<a class="ae mt" href="http://www.dt.fee.unicamp.br/~tiago//youtubespamcollection/" rel="noopener ugc nofollow" target="_blank"> 1956 æ¡è¯„è®ºã€‚è¿™äº›è¯„è®ºæ˜¯é€šè¿‡ YouTube API ä» 2015 å¹´ä¸ŠåŠå¹´ YouTube ä¸Šè§‚çœ‹æ¬¡æ•°æœ€å¤šçš„åä¸ªè§†é¢‘ä¸­çš„äº”ä¸ªæ”¶é›†çš„ã€‚æ•°æ®é›†åŒ…å«è¢«æ ‡è®°ä¸ºåˆæ³•é‚®ä»¶æˆ–åƒåœ¾é‚®ä»¶çš„éç¼–ç é‚®ä»¶ã€‚ç”±äºæˆ‘å°†åœ¨æœ¬æ–‡ç¨åå†æ¬¡ä½¿ç”¨ Rï¼Œæˆ‘å†³å®šä½¿ç”¨æˆ‘åœ¨æœç´¢æ•°æ®é›†æ—¶æ‰¾åˆ°çš„</a><a class="ae mt" href="https://github.com/christophM/interpretable-ml-book/blob/master/R/get-SpamTube-dataset.R" rel="noopener ugc nofollow" target="_blank"> R ç‰‡æ®µ</a>ä¸‹è½½æ•°æ®é›†ã€‚</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="5944" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¼šå°† csv æ ¼å¼çš„æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶å¤¹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<em class="lu">ç†ŠçŒ«</em>å›¾ä¹¦é¦†æ¥æ¢ç´¢å†…å®¹ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="0d82" class="lv lw iq mv b gy mz na l nb nc">youtube_data = pd.read_csv("youtube_data/TubeSpam.csv")<br/>youtube_data.head()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/d059b4b1043defddae225625cdefa1a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zdfvqsuu3lMVPwaWebrJdw.png"/></div></div></figure><p id="d786" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç¨åå°†ç”¨äºå»ºæ¨¡çš„åˆ—å†…å®¹å’Œç±»ï¼Œå¹¶åˆ é™¤ç¼ºå°‘å†…å®¹çš„è¡Œã€‚è¿è¡Œä¸‹é¢çš„ä»£ç ç‰‡æ®µå°†è¿”å› 1954 è¡Œï¼Œå¹¶æ˜¾ç¤ºæ ‡ç­¾ 0(åˆæ³•è¯„è®º)å’Œ 1(åƒåœ¾è¯„è®º)åœ¨åˆ é™¤é‡å¤è¡Œåå‡ºç°çš„æ¬¡æ•°å¤§è‡´ç›¸åŒã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="753e" class="lv lw iq mv b gy mz na l nb nc">youtube_df = pd.DataFrame()<br/>youtube_df['text'] = youtube_data['CONTENT']<br/>youtube_df['label'] = youtube_data['CLASS']<br/>youtube_df.dropna(inplace=True)</span><span id="ca91" class="lv lw iq mv b gy nd na l nb nc">youtube_df.groupby('label').describe()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/a508976d1b7d0862d960a04abfcf7dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xiAkKhxaqoNO25qDWslg9g.png"/></div></div></figure><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="c034" class="lv lw iq mv b gy mz na l nb nc">youtube_df.drop_duplicates(inplace=True)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/e4b3162f1a297dd8e6c88435a2231396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nsa_8A00kiaOL4wOX84apQ.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk">\</figcaption></figure><p id="a33e" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘ä»¬å¯ä»¥çœ‹çœ‹åˆæ³•è¯„è®ºå’Œåƒåœ¾è¯„è®ºåœ¨é•¿åº¦ä¸Šæ˜¯å¦æœ‰æ˜æ˜¾çš„åŒºåˆ«</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="ad36" class="lv lw iq mv b gy mz na l nb nc">youtube_df['length'] = youtube_df['text'].apply(len)<br/>youtube_df.hist(column='length', by ='label', bins=50, figsize = (10,4))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/5e39ca407dc4e94e8c767824f005334f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9Awi-j5rgT6Q9QHjx5bUg.png"/></div></div></figure><p id="4fb1" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æ˜¾ç„¶ï¼Œåƒåœ¾è¯„è®ºå¹³å‡æ¥è¯´è¦é•¿ä¸€äº›ã€‚æœ€é•¿çš„æ³¨é‡Šä¹‹ä¸€æ˜¯ï¼Œä¾‹å¦‚:</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="c66b" class="lv lw iq mv b gy mz na l nb nc">youtube_df[youtube_df['length'] == 1077]['text'].iloc[0]</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/9d1cdc4355e035772ebc024877bd1899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0MKglAB3nS_i69rXfKCxsQ.png"/></div></div></figure><h2 id="7fb0" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">é¢„å¤„ç†æ³¨é‡Š</h2><p id="a8a0" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">åœ¨ä½¿ç”¨æ–‡æœ¬æ•°æ®è¿›è¡Œå»ºæ¨¡ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€äº›æ ‡å‡†çš„è‡ªç„¶è¯­è¨€å¤„ç†(NLP)æŠ€æœ¯å¯¹å…¶è¿›è¡Œæ¸…ç†ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬å°†åˆ é™¤æ•°å­—ï¼Œæ ‡ç‚¹ç¬¦å·ï¼Œé¢å¤–çš„ç©ºæ ¼ï¼Œå°†æ‰€æœ‰å•è¯è½¬æ¢ä¸ºå°å†™ï¼Œåˆ é™¤åœç”¨è¯ï¼Œè¯å¹²å’Œè¯æ¡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Python åº“<em class="lu"> nltk </em>ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="f7d7" class="lv lw iq mv b gy mz na l nb nc">from nltk.tokenize import word_tokenize<br/>from nltk.corpus import stopwords # nltk.download('stopwords')<br/>from nltk.stem import PorterStemmer<br/>from nltk.stem import WordNetLemmatizer #nltk.download('wordnet')</span><span id="1cf1" class="lv lw iq mv b gy nd na l nb nc">import string, re</span><span id="ef37" class="lv lw iq mv b gy nd na l nb nc">stop_words = list(set(stopwords.words('english')))<br/>stemmer= PorterStemmer()<br/>lemmatizer=WordNetLemmatizer()</span><span id="e08a" class="lv lw iq mv b gy nd na l nb nc">translate_table = dict((ord(char), None) for char in string.punctuation)</span><span id="70ed" class="lv lw iq mv b gy nd na l nb nc">def nltk_text_preproc(text_in):<br/>    text_out = re.sub(r'\d+', '', text_in) # rm numbers<br/>    text_out = text_out.translate(translate_table) # rm punct<br/>    text_out = text_out.strip() # rm white spaces</span><span id="926c" class="lv lw iq mv b gy nd na l nb nc">    return text_out</span><span id="79bf" class="lv lw iq mv b gy nd na l nb nc">def nltk_token_processing(tokens):<br/>    tokens = [i.lower() for i in tokens]<br/>    tokens = [i for i in tokens if not i in stop_words]<br/>    tokens = [stemmer.stem(i) for i in tokens]<br/>    tokens = [lemmatizer.lemmatize(i) for i in tokens]<br/>    <br/>    return tokens</span></pre><p id="1d3f" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æ•°æ®é›†ä¸­çš„å‰ 10 æ¡è¯„è®º</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="e86d" class="lv lw iq mv b gy mz na l nb nc">pd.options.display.max_colwidth = 1000<br/>youtube_df['text'].head(10)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/7a3045e04320429e2781679deec2c803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3pu9f3TKNBlQqhr2haWgkA.png"/></div></div></figure><p id="b1bf" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¹‹åï¼Œä½¿ç”¨æˆ‘ä»¬çš„é¢„å¤„ç†æ­¥éª¤</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="6997" class="lv lw iq mv b gy mz na l nb nc">youtube_df['text'].head(10).map(lambda x: nltk_text_preproc(x)).map(lambda x: nltk_token_processing(word_tokenize(''.join(x)))).map(lambda x: ' '.join(x))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/6c265d382ca051ce0185f83055da05a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*__NrF3YH4Ua6cd_uh0lT4w.png"/></div></div></figure><p id="a395" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬ç°åœ¨å‡†å¤‡å¤„ç†æ•°æ®é›†ä¸­çš„æ‰€æœ‰æ–‡æœ¬ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="cad3" class="lv lw iq mv b gy mz na l nb nc">youtube_df['text'] = youtube_df['text'].map(lambda x: nltk_text_preproc(x))<br/>youtube_df['text'] = youtube_df['text'].map(lambda x: nltk_token_processing(word_tokenize(''.join(x))))<br/>youtube_df['text'] = youtube_df['text'].map(lambda x: ' '.join(x))</span></pre><p id="0d44" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æ–°æ•°æ®é›†åŒ…å« 1735 è¡Œã€‚</p><h2 id="8691" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">ä»æ–‡æœ¬åˆ›å»ºè¦ç´ </h2><p id="abe7" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œé¢„å¤„ç†çš„æ–‡æœ¬æ•°æ®å°†è¢«è½¬æ¢æˆç‰¹å¾å‘é‡ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<em class="lu"> nltk </em> Python åº“çš„<em class="lu">è®¡æ•°çŸ¢é‡å™¨</em>æ–¹æ³•ã€‚è¿™å°†æ–‡æœ¬è¡Œè½¬æ¢æˆä¸€ä¸ªçŸ©é˜µï¼Œå…¶ä¸­æ¯ä¸€åˆ—ä»£è¡¨æ‰€æœ‰æ–‡æœ¬ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ¯ä¸ªå•å…ƒæ ¼ä»£è¡¨ç‰¹å®šæœ¯è¯­åœ¨ç»™å®šè¡Œä¸­å‡ºç°çš„æ¬¡æ•°ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="b66e" class="lv lw iq mv b gy mz na l nb nc">count_vect = CountVectorizer(min_df=0.01, <br/>                             max_df=1.0, ngram_range=(1,3)) <br/>count_vect.fit(youtube_df['text'])<br/>youtube_df_text = count_vect.transform(youtube_df['text'])</span></pre><p id="3657" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">è¿™é‡Œï¼Œæˆ‘ä»¬è¯·æ±‚åˆ é™¤å‡ºç°åœ¨ä¸åˆ° 1%çš„è¯„è®ºæˆ–æ‰€æœ‰è¯„è®ºä¸­çš„æœ¯è¯­ï¼Œå¹¶è¦æ±‚ CountVectorizer è®¡ç®—æœ€å¤š 2 ä¸ªè¿ç»­æœ¯è¯­çš„ n å…ƒè¯­æ³•ã€‚</p><p id="1114" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¾‹å¦‚ï¼Œç¬¬äºŒä¸ªæ³¨é‡Š(è¡Œ)</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="ac25" class="lv lw iq mv b gy mz na l nb nc">text_example_orig = youtube_df['text'][1]<br/>print(text_example_orig)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/ab50f4f9faff2426eba6d7516b30117e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rb58Jy-YYtWc1hUa6eacDg.png"/></div></div></figure><p id="8a3b" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆä¸º</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="1da3" class="lv lw iq mv b gy mz na l nb nc">text_example = count_vect.transform([text_example])<br/>print(text_example)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/70ddba85ef0a5bd558f53e7792ad3cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MCtrjnXdM8s1_S-KkO7fjA.png"/></div></div></figure><p id="c507" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“å“ªäº›é¡¹å¯¹åº”äº CountVectorizer è¿”å›çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç </p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="c3a1" class="lv lw iq mv b gy mz na l nb nc">for row, col in zip(*text_example_transf.nonzero()):<br/>    val = text_example_transf[row, col]<br/>    #print((row, col), val)<br/>    print(count_vect.get_feature_names()[col])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/44224f3a98fea8acb8d65aad713efebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vOK6Besee6ek54pUEXHcpA.png"/></div></div></figure><p id="4883" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">è®¡æ•°çŸ©é˜µä¸æ˜¯æ ‡å‡†çŸ©é˜µï¼Œè€Œæ˜¯ç¨€ç–çŸ©é˜µ</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="f6ca" class="lv lw iq mv b gy mz na l nb nc">print ('Shape of Sparse Matrix: ', youtube_df_text.shape)<br/>print ('Amount of Non-Zero occurences: ', youtube_df_text.nnz)<br/>print ('sparsity: %.2f%%' % (100.0 * youtube_df_text.nnz /<br/>                             (youtube_df_text.shape[0] * youtube_df_text.shape[1])))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/97306e9c640afb7d8edd92328b101d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ia0xuEOddjZB8QJ5K1kvqg.png"/></div></div></figure><p id="b535" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ç¨€ç–çŸ©é˜µæ˜¯åŒ…å«æå°‘éé›¶å…ƒç´ çš„çŸ©é˜µçš„æœ€ä½³è¡¨ç¤ºã€‚äº‹å®ä¸Šï¼Œç”¨äºŒç»´æ•°ç»„è¡¨ç¤ºç¨€ç–çŸ©é˜µä¼šå¯¼è‡´å¤§é‡å†…å­˜æµªè´¹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæœ‰ 1ï¼Œ735 è¡Œ* 166 ä¸ªé¡¹ï¼Œè¿™å°†å¯¼è‡´å…·æœ‰ 288ï¼Œ010 ä¸ªå…ƒç´ çš„äºŒç»´çŸ©é˜µï¼Œä½†æ˜¯åªæœ‰ 7ï¼Œ774 ä¸ªå…·æœ‰éé›¶å‡ºç°(2.7%ç¨€ç–åº¦)ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰è¡Œéƒ½åŒ…å«æ‰€æœ‰é¡¹ã€‚</p><h2 id="3ac9" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">å»ºæ¨¡</h2><p id="ae80" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">æˆ‘ä»¬å°†æŠŠæ•°æ®é›†åˆ†æˆè®­ç»ƒé›†å’ŒéªŒè¯é›†ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="6697" class="lv lw iq mv b gy mz na l nb nc">train_x, valid_x, train_y, valid_y, index_train, index_val = model_selection.train_test_split(youtube_df_text, youtube_df['label'], range(len(youtube_df['label'])), stratify=youtube_df['label'], random_state=1, train_size=0.8)</span></pre><p id="08f8" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ç°åœ¨å±äºè®­ç»ƒé›†å’ŒéªŒè¯é›†çš„åˆæ³•è¯„è®ºå’Œåƒåœ¾è¯„è®ºçš„æ•°é‡æ˜¯</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="d18f" class="lv lw iq mv b gy mz na l nb nc">np.unique(train_y, return_counts=True)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/057212adf54a22dc728cbc7ff0579e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SCcRUU_zv3b-YmyJONqwvA.png"/></div></div></figure><p id="d6a1" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ç°åœ¨æ˜¯æ—¶å€™è®­ç»ƒæˆ‘ä»¬çš„æ¨¡å‹äº†</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="fb7f" class="lv lw iq mv b gy mz na l nb nc">def train_model(classifier, feature_vector_train, label, feature_vector_valid, valid_label):<br/>    # fit the training dataset on the classifier<br/>    classifier.fit(feature_vector_train, label)<br/>    <br/>    # predict the labels on validation dataset<br/>    predictions = classifier.predict(feature_vector_valid)<br/>    <br/>    return classifier, metrics.accuracy_score(predictions, valid_label), metrics.classification_report(predictions, valid_label)</span></pre><p id="52d8" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">çœ‹çœ‹å®ƒåœ¨éªŒè¯é›†ä¸Šçš„è¡¨ç°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ XGBoost åˆ†ç±»å™¨ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="2d71" class="lv lw iq mv b gy mz na l nb nc">classifier, accuracy, confusion_matrix = train_model(xgboost.XGBClassifier(), <br/>            train_x, train_y, valid_x, valid_y)<br/>print("Xgb, Accuracy: ", accuracy)<br/>print(confusion_matrix)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/66519f60805eeb3f840b08a178120e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5jUrK3j1iamAORrbCXNZMA.png"/></div></div></figure><p id="d115" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å¯¹äºè¿™ç¯‡æ–‡ç« æ¥è¯´ï¼Œä¸€ä¸ªé«˜æ€§èƒ½çš„æ¨¡å‹æ˜¯ä¸å¿…è¦çš„ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªå…³äºç‰¹æ€§å’Œæ ‡ç­¾å¦‚ä½•ç›¸äº’å…³è”çš„ä¸€èˆ¬æ€§æè¿°ã€‚äº‹å®ä¸Šï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªåƒæ ·çš„æ¨¡å‹ã€‚</p><h2 id="d06b" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">ç”¨ SHAP è®¡ç®—æ²™æ™®åˆ©å€¼</h2><p id="0aee" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">Python åº“<a class="ae mt" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank">SHAP</a>(SHapley Additive explaints)å¯ä»¥è§£é‡Šä»»ä½•æœºå™¨å­¦ä¹ æ¨¡å‹çš„è¾“å‡ºï¼Œç‰¹åˆ«æ˜¯å®ƒä¸º<a class="ae mt" href="https://arxiv.org/abs/1802.03888" rel="noopener ugc nofollow" target="_blank">æ ‘é›†æˆæ–¹æ³•</a>æä¾›äº†é«˜é€Ÿç²¾ç¡®ç®—æ³•ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„æ¨¡å‹æ˜¯ XGBoost æ¨¡å‹çš„åŸå› ä¹‹ä¸€ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè®¡ç®— SHAP å€¼åªéœ€è¦å‡ åˆ†ä¹‹ä¸€ç§’ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è®¡ç®—æ•´ä¸ªæ•°æ®é›†çš„ SHAP å€¼ã€‚è¯·æ³¨æ„ï¼Œå°† XGBoost ä¸é€»è¾‘ç›®æ ‡å‡½æ•°ç»“åˆä½¿ç”¨æ—¶ï¼ŒSHAP å€¼æ˜¯å¯¹æ•°ä¼˜åŠ¿ã€‚è¦å°†å¯¹æ•°ä¼˜åŠ¿å·®é¢è½¬æ¢ä¸ºæ¦‚ç‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¬å¼ odds = exp(å¯¹æ•°ä¼˜åŠ¿)ï¼Œå…¶ä¸­ p = odds/(1+odds)ã€‚åœ¨æœ¬èŠ‚çš„æœ€åï¼Œæˆ‘ä»¬å°†åšè¿™ä¸ªç»ƒä¹ ï¼Œä½†ç°åœ¨è®©æˆ‘ä»¬é¦–å…ˆè®¡ç®— SHAP å€¼å¹¶ç ”ç©¶å®ƒä»¬ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="c4f2" class="lv lw iq mv b gy mz na l nb nc">t0 = time.time()<br/>explainer = shap.TreeExplainer(classifier)<br/>shap_values_train = explainer.shap_values(youtube_df_text)<br/>t1 = time.time()<br/>timeit=t1-t0<br/>print('time to compute Shapley values (s):', timeit)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/07c25fc00ec013f323fbbe8eca4caa35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MgHqp4SLN9dIx6MVL_KaSQ.png"/></div></div></figure><p id="71f0" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å°†ç¨€ç–çŸ©é˜µè½¬æ¢æˆå¯†é›†çŸ©é˜µæ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="e373" class="lv lw iq mv b gy mz na l nb nc">txt_dense_df = pd.DataFrame(youtube_df_text.todense(), <br/>                            columns=count_vect.get_feature_names())<br/>shap_values_train_df = pd.DataFrame(shap_values_train, <br/>                                    columns=txt_dense_df.columns)</span></pre><p id="1304" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æœ‰äº†è¿™ä¸ªæ•°æ®æ¡†ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—æ•´ä½“è¦ç´ çš„é‡è¦æ€§</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="ebb9" class="lv lw iq mv b gy mz na l nb nc">shap_sum = np.abs(shap_values_train_df).mean(axis=0)<br/>importance_df = pd.DataFrame([txt_dense_df.columns.tolist(), <br/>                              shap_sum.tolist()]).T<br/>importance_df.columns = ['column_name', <br/>                         'shap_importance (log-odds)']<br/>importance_df = importance_df.sort_values('shap_importance (log-odds)', ascending=False)<br/>importance_df['shap_importance (%)'] = importance_df['shap_importance (log-odds)'].apply(lambda x: 100*x/np.sum(importance_df['shap_importance (log-odds)']))</span></pre><p id="00b7" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å¹¶ä¸”é€‰æ‹©ä¾‹å¦‚å‰ 20 ä¸ªç‰¹å¾</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="783d" class="lv lw iq mv b gy mz na l nb nc">topN = 20<br/>top20 = importance_df.iloc[0:topN]["column_name"]</span><span id="ff2e" class="lv lw iq mv b gy nd na l nb nc">print('Cumulative Importance', <br/>      np.sum(importance_df.iloc[0:topN]["shap_importance (%)"]))</span><span id="3373" class="lv lw iq mv b gy nd na l nb nc">shap_values_imp = shap_values_train_df[top20]</span><span id="5d04" class="lv lw iq mv b gy nd na l nb nc">shap.summary_plot(shap_values_train_df, <br/>                  txt_dense_df, plot_type="bar")</span><span id="3987" class="lv lw iq mv b gy nd na l nb nc">importance_df.iloc[0:topN]</span></pre><div class="kg kh ki kj gt ab cb"><figure class="nu kk nv nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/223eaf3160a9980d57694279d4cb3780.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*qIiJseWhfmoTV1zOa3_KTg.png"/></div></figure><figure class="nu kk oa nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/bf1a3682b7e4b8e4431e1cd9d4a13dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*Uq07naYrExVP18kbzTx6OQ.png"/></div></figure></div><p id="471f" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å…¶ç´¯è®¡â€œé‡è¦æ€§â€çº¦ä¸º 94%ã€‚ä¸Šé¢çš„æ¡å½¢å›¾æ˜¾ç¤ºäº†æ¯ä¸ªç‰¹å¾çš„ SHAP å€¼çš„å¹³å‡ç»å¯¹å€¼ã€‚</p><p id="9816" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´å¤šçš„å¯è§†åŒ–æ¥è§£é‡Šæ¨¡å‹ç»“æœã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="b0a3" class="lv lw iq mv b gy mz na l nb nc">j = 1<br/>youtube_df.iloc[j]</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/3f386efc0a95e86c7f3117d04511d139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q695X9kNoge_IvJALzqrAQ.png"/></div></div></figure><p id="188a" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æ˜¯å…¸å‹çš„åƒåœ¾è¯„è®ºã€‚æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºæœ‰åŠ©äºå°†æ¨¡å‹è¾“å‡ºä»åŸºç¡€å€¼(æˆ‘ä»¬ä½¿ç”¨çš„è®­ç»ƒæ•°æ®é›†çš„å¹³å‡æ¨¡å‹è¾“å‡º)æ¨è‡³æ¨¡å‹è¾“å‡ºçš„é¡¹ã€‚å°†é¢„æµ‹æ¨å‘æ›´é«˜çš„å¯¹æ•°ä¼˜åŠ¿å€¼çš„æœ¯è¯­æ˜¾ç¤ºä¸ºçº¢è‰²ï¼Œå°†é¢„æµ‹æ¨å‘æ›´ä½çš„å¯¹æ•°ä¼˜åŠ¿å€¼çš„æœ¯è¯­æ˜¾ç¤ºä¸ºè“è‰²ã€‚åœ¨è¿™ä¸ªç‰¹æ®Šçš„ä¾‹å­ä¸­ï¼Œæœ‰ä¸€ä¸ªå…¸å‹çš„åƒåœ¾è¯„è®ºçš„æ‰€æœ‰â€œæˆåˆ†â€ã€‚äº‹å®ä¸Šï¼Œæ‰€æœ‰æœ¯è¯­çš„ SHAP å€¼éƒ½å°†æ¨¡å‹è¾“å‡ºæ¨è‡³ä¸€ä¸ªæ¯”å¹³å‡è¾“å‡ºå€¼é«˜å¾—å¤šçš„å€¼ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="4ac4" class="lv lw iq mv b gy mz na l nb nc">shap.initjs()</span><span id="3ecf" class="lv lw iq mv b gy nd na l nb nc"># visualize the j-prediction's explanation (use matplotlib=True to avoid Javascript)<br/>shap.force_plot(explainer.expected_value, shap_values_imp.iloc[j].to_numpy(), <br/>                txt_dense_df.iloc[j][top20])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/253e126f7c3e3040eed875cd88b3b6bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L1ZyEKTByrXAjkl0P7L83A.png"/></div></div></figure><p id="fe71" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å¯¹äºåˆæ³•çš„è¯„è®ºï¼Œå¦‚</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/7d954dd18f963e2e9168ceab08f8c7a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z_3qGUHzwmDGV0346zqgbg.png"/></div></div></figure><p id="de71" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¸Šé¢ä½¿ç”¨çš„å¯è§†åŒ–å˜æˆäº†</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/efdd78f9757fe352f41b15f903a3f09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vviNyporVkAeiEP6KtCE-Q.png"/></div></div></figure><p id="9088" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">åœ¨æˆ‘çš„<a class="ae mt" href="https://gist.github.com/alessiot/769ebe433adf79725b08687cf889f4cb" rel="noopener ugc nofollow" target="_blank">ç¬”è®°æœ¬</a>ä¸­ï¼Œæˆ‘æ·»åŠ äº†æ›´å¤šçš„å¯è§†åŒ–å†…å®¹ï¼Œè¿™å¹¶ä¸æ˜¯è¿™ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„ã€‚</p><p id="0c48" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æœ€åï¼Œè®©æˆ‘ä»¬åšä¸€ä¸ªå°†å¯¹æ•°å‡ ç‡è½¬æ¢æˆæ¦‚ç‡çš„ç»ƒä¹ ï¼Œçœ‹çœ‹ SHAP å€¼ä¸å®ƒä»¬æœ‰ä»€ä¹ˆå…³ç³»ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="a41c" class="lv lw iq mv b gy mz na l nb nc">j = 1</span><span id="d857" class="lv lw iq mv b gy nd na l nb nc"># log odds margin to prob<br/># odds = exp(log odds), p = odds/(1+odds)</span><span id="2ed5" class="lv lw iq mv b gy nd na l nb nc">log_odds = np.sum(shap_values_train_df.iloc[j].to_numpy())<br/>avg_model_output = np.mean(youtube_df['label']) # prob<br/>log_odds_avg_model_output = np.log(avg_model_output/(1-avg_model_output))<br/>predicted_prob = classifier.predict_proba(youtube_df_text.tocsc())[j][1] #target=1<br/>predicted_log_odds = np.log(predicted_prob/(1-predicted_prob))</span><span id="312b" class="lv lw iq mv b gy nd na l nb nc">print("Sum of Shaphley values (log-odds)for j-instance:", log_odds, <br/>      'prob:', np.exp(log_odds)/(1.0+np.exp(log_odds)))<br/>print("Average model output:", avg_model_output)<br/>print("Predicted probability value for j-instance:", predicted_prob,<br/>      "Predicted value:", classifier.predict(youtube_df_text.tocsc())[j])</span><span id="330f" class="lv lw iq mv b gy nd na l nb nc">print('log_odds:', log_odds, 'is expected to be equal to pred-expected:', predicted_log_odds-log_odds_avg_model_output)<br/>print('pred-expected (prob):', predicted_prob-avg_model_output)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/7a2e01d1a89c0652e2b3512843eecd63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1uqMaqgWJ-Gw-blZ6Y6PXw.png"/></div></div></figure><p id="e50b" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å¯¹äºè¯„è®º j = 1ï¼Œæˆ‘ä»¬åŸºäºå¯¹æ•°-èµ”ç‡(SHAP å€¼)åˆ°æ¦‚ç‡çš„è½¬æ¢ï¼Œè®¡ç®—äº† SHAP å€¼(6.59)ï¼Œå¯¹åº”äºè¯¥è¯„è®ºæ˜¯åƒåœ¾é‚®ä»¶(æ ‡ç­¾= 1)çš„æ¦‚ç‡ä¸º 99.86%ã€‚ä»æ¨¡å‹é¢„æµ‹çš„æ¦‚ç‡æ˜¯ 99.85%ï¼Œç•¥æœ‰ä¸åŒï¼Œä½†è¶³å¤Ÿæ¥è¿‘ã€‚æ­£å¦‚æˆ‘åœ¨æœ¬æ–‡å¼€å¤´æ‰€è¯´çš„ï¼Œæˆ‘ä»¬æœŸæœ› SHAP å€¼(å¯¹æ•°ä¼˜åŠ¿)ç­‰äºé¢„æµ‹å€¼å‡å»é¢„æœŸæ¦‚ç‡ï¼Œè¿™æ˜¯æ‰€æœ‰å®é™…ç›®æ ‡çš„å¹³å‡å€¼(0.48)ã€‚</p><h2 id="5ac6" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">èšç±» SHAP å€¼</h2><p id="8e04" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">æœ¬æ–‡ä¹‹å‰é€‰å‡ºçš„å‰ 20 ä¸ªæœ¯è¯­å¯ä»¥ç”¨å­—å…¸æ€»ç»“æˆæ›´é€šç”¨çš„â€œä¸»é¢˜â€:</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="eb08" class="lv lw iq mv b gy mz na l nb nc">top20_dict = {'ACTION': ['check','subscrib','view','share','follow','help', 'visit'],<br/> 'REQUEST': ['plea','hey'],<br/> 'VALUE': ['money','free','billion', 'new', "good", 'best'],<br/> 'YOUTUBE': ['channel', 'song', 'onlin'],<br/> 'COMMENT': ['love', 'like comment']             <br/>}</span></pre><p id="8ed5" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">å› æ­¤ï¼Œå¯¹äºæ¯ä¸ªè¯„è®ºï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šè¿è¡Œä»¥ä¸‹ä»£ç ç‰‡æ®µçš„é¦–è¦åŸå› ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="2f30" class="lv lw iq mv b gy mz na l nb nc">from itertools import chain</span><span id="c581" class="lv lw iq mv b gy nd na l nb nc">ntopreason = 1 #change this to allow more reasons to be captured</span><span id="1287" class="lv lw iq mv b gy nd na l nb nc">top20_dict_values = list(top20_dict.values())<br/>top20_dict_keys = list(top20_dict.keys())</span><span id="b4c3" class="lv lw iq mv b gy nd na l nb nc">shap_values_imp_r = shap_values_imp.copy()<br/>target_values_r = pd.Series(predictions)</span><span id="4325" class="lv lw iq mv b gy nd na l nb nc"># Create summarizing labels<br/>top_reasons_all = []<br/>for i in range(shap_values_imp_r.shape[0]):<br/>    <br/>    shap_feat = shap_values_imp_r.iloc[i]<br/>    shap_feat = shap_feat.iloc[np.lexsort([shap_feat.index, shap_feat.values])]<br/>    <br/>    topN = shap_feat.index.to_list()[-1:] <br/>    topN_value = shap_feat.values[-1:]<br/>    <br/>    topN_idx = []<br/>    for topn in topN:<br/>        for idx in range(len(top20_dict_values)):<br/>            if topn in top20_dict_values[idx] and idx not in topN_idx:<br/>                topN_idx.append(idx)<br/>                <br/>    #topN_idx = [idx for idx in range(len(top20_dict_values)) for topn in topN if topn in top20_dict_values[idx]]<br/>    <br/>    #Ordered by increasing importance<br/>    top_reasons = [top20_dict_keys[x] for x in topN_idx]</span><span id="7c7a" class="lv lw iq mv b gy nd na l nb nc">#print(i, topN, topN_idx, top_reasons)</span><span id="9366" class="lv lw iq mv b gy nd na l nb nc">top_reasons_all.append(','.join(top_reasons))<br/>    <br/>shap_values_imp_r['target'] = target_values_r<br/>shap_values_imp_r['top_reasons'] = top_reasons_all</span></pre><p id="2b26" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">åœ¨ä¸€ä¸ªå•ç‹¬çš„ Jupyter å•å…ƒæ ¼ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ R æ¥é€‰æ‹©ç”¨äºå¯¹è¯„è®ºçš„ SHAP å€¼è¿›è¡Œåˆ†ç»„çš„æœ€ä½³èšç±»æ•°ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="7815" class="lv lw iq mv b gy mz na l nb nc">%%R -i shap_values_imp_r -w 800 -h 800</span><span id="c951" class="lv lw iq mv b gy nd na l nb nc">library(gplots)</span><span id="2f0e" class="lv lw iq mv b gy nd na l nb nc">d_shap &lt;- dist(shap_values_imp_r[1:(ncol(shap_values_imp_r)-2)]) <br/>hc &lt;- hclust(d_shap, method = "ward.D2")<br/>dend &lt;- as.dendrogram(hc)</span><span id="c086" class="lv lw iq mv b gy nd na l nb nc">library(dendextend)<br/>library(colorspace)</span><span id="2416" class="lv lw iq mv b gy nd na l nb nc">## Find optimal number of clusters<br/>clusters_test = list()<br/>for (ncl in 2:50){<br/>    clusters_test[[ncl]] &lt;- cutree(hc, k=ncl)<br/>}</span></pre><p id="8f5f" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨å±‚æ¬¡èšç±»ï¼Œèšç±»æ•°é‡åœ¨ 2 åˆ° 50 ä¹‹é—´ã€‚å›åˆ° Pythonï¼Œæˆ‘ä»¬è®¡ç®—æ¯ä¸ªèšç±»ç»“æœçš„<em class="lu">è½®å»“</em>åˆ†æ•°ã€‚é€šè¿‡æŸ¥çœ‹è½®å»“åˆ†æ•°å’Œèšç±»çš„å¯è§†åŒ–æ¥å†³å®šè¦ä½¿ç”¨çš„èšç±»æ•°é‡ã€‚åœ¨é€‰æ‹©é›†ç¾¤æ•°é‡æ—¶ï¼Œæ€»æ˜¯éœ€è¦åšå‡ºå†³å®šã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="b545" class="lv lw iq mv b gy mz na l nb nc">h_clusters = rpy2.robjects.r['clusters_test']</span><span id="5d7b" class="lv lw iq mv b gy nd na l nb nc">h_clusters_sil = []<br/>cl_id = 0<br/>for cl in h_clusters:<br/>    if cl is not rpy2.rinterface.NULL:<br/>        sil = metrics.silhouette_score(shap_values_imp_r.drop(shap_values_imp_r.columns[len(shap_values_imp_r.columns)-2:], axis=1, inplace=False), <br/>                                       cl, metric='euclidean')<br/>        h_clusters_sil.append(sil)<br/>        #print(cl_id, sil)<br/>        cl_id += 1<br/>    else:<br/>        cl_id += 1</span><span id="cea8" class="lv lw iq mv b gy nd na l nb nc">plt.plot(range(2, 51), h_clusters_sil)<br/>plt.title('Silhouette')<br/>plt.xlabel('Number of clusters')<br/>plt.ylabel('Silhouette Index') #within cluster sum of squares<br/>plt.show()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/b142c79a96c75bd6f8120feaf1a91ccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vzHgAUqAIq7HcB3Wi6tAvA.png"/></div></div></figure><p id="c9ea" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘ä»¬ä½¿ç”¨ Ward çš„æ–¹æ³•è¿›è¡Œèšç±»ï¼Œè¯¥æ–¹æ³•ä½¿æ€»çš„ç»„å†…æ–¹å·®æœ€å°åŒ–ã€‚åœ¨æ¯ä¸€æ­¥ï¼Œå…·æœ‰æœ€å°èšç±»é—´è·ç¦»çš„èšç±»å¯¹è¢«åˆå¹¶ã€‚åˆå¹¶çš„é«˜åº¦(è§ä¸‹å›¾)è¡¨ç¤ºä¸¤ä¸ªå®ä¾‹ä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚åˆå¹¶çš„é«˜åº¦è¶Šé«˜ï¼Œå®ä¾‹è¶Šä¸ç›¸ä¼¼ã€‚æ•°æ®çš„å¹³å‡<a class="ae mt" href="https://en.wikipedia.org/wiki/Determining_the_number_of_clusters_in_a_data_set#The_silhouette_method" rel="noopener ugc nofollow" target="_blank">è½®å»“</a>æ˜¯è¯„ä¼°æœ€ä½³èšç±»æ•°çš„æ ‡å‡†ã€‚æ•°æ®å®ä¾‹çš„è½®å»“æ˜¯ä¸€ç§åº¦é‡ï¼Œå®ƒä¸å®ƒçš„åˆ†ç±»ä¸­çš„æ•°æ®åŒ¹é…å¾—æœ‰å¤šç´§å¯†ï¼Œä¸ç›¸é‚»åˆ†ç±»çš„æ•°æ®åŒ¹é…å¾—æœ‰å¤šæ¾æ•£ã€‚å‰ªå½±å¾—åˆ†èŒƒå›´åœ¨-1 å’Œ 1 ä¹‹é—´ï¼Œæœ€å¥½ä¸º 1ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹© 30 ä¸ªèšç±»ï¼Œä»¥ä¾¿åœ¨è¯„è®ºç±»å‹ä¸­æœ‰è¶³å¤Ÿçš„ç²’åº¦ï¼Œå¹¶è·å¾—å¤§çº¦ 0.70 çš„è‰¯å¥½è½®å»“åˆ†æ•°ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="2f6f" class="lv lw iq mv b gy mz na l nb nc">%%R -i shap_values_imp_r -w 800 -h 800</span><span id="e17e" class="lv lw iq mv b gy nd na l nb nc">library(gplots)</span><span id="53e7" class="lv lw iq mv b gy nd na l nb nc">d_shap &lt;- dist(shap_values_imp_r[1:(ncol(shap_values_imp_r)-2)], 'euclidean') <br/>hc &lt;- hclust(d_shap, method = "ward.D2")<br/>dend &lt;- as.dendrogram(hc)</span><span id="fedf" class="lv lw iq mv b gy nd na l nb nc">library(dendextend)<br/>library(colorspace)</span><span id="fa24" class="lv lw iq mv b gy nd na l nb nc">n_clust &lt;- 30</span><span id="cf65" class="lv lw iq mv b gy nd na l nb nc">dend &lt;- color_branches(dend, k=n_clust) #, groupLabels=iris_species)</span><span id="daa1" class="lv lw iq mv b gy nd na l nb nc">clusters &lt;- cutree(hc, k=n_clust)<br/>#print(head(clusters))</span><span id="a25a" class="lv lw iq mv b gy nd na l nb nc">print(format(prop.table(table(clusters,shap_values_imp_r$top_reasons, shap_values_imp_r$target), margin=1), <br/>             digit=2, scientific = F))<br/>print(format(prop.table(table(clusters,shap_values_imp_r$top_reasons), margin=1), <br/>             digit=2, scientific = F))</span><span id="599f" class="lv lw iq mv b gy nd na l nb nc">heatmap.2(as.matrix(shap_values_imp_r[1:(ncol(shap_values_imp_r)-2)]), <br/>          dendrogram = "row",<br/>          Rowv = dend,<br/>          Colv = "NA", # this to make sure the columns are not ordered<br/>          key.xlab = "Predicted - Average log-odds",<br/>          #hclustfun=function(d) hclust(d, method="complete"), <br/>          srtCol=45,  adjCol = c(1,1))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/357d192d7b58d3d65e9095bb1006a8eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ms4mdz4564qRt-DOHyrPNQ.png"/></div></div></figure><p id="60c6" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">åœ¨ä¸Šé¢çš„çƒ­å›¾ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†å±‚èšç±»(å·¦ä¾§ y è½´)ä¸å‰ 20 ä¸ªæœ¯è¯­çš„é‡è¦æ€§(x è½´ï¼Œæ ¹æ®è¯„è®ºä¸­ç›¸åº”æœ¯è¯­å¯¹æ¨¡å‹é¢„æµ‹çš„å½±å“è€Œç€è‰²çš„å•å…ƒæ ¼)ç›¸ç»“åˆï¼Œå‰è€…æ˜¾ç¤ºäº†æ›´æ¥è¿‘çš„ç›¸ä¼¼è¯„è®º(å³ä¾§ y è½´ä¸Šçš„æ•°å­—æ˜¯è¯„è®ºè¡Œå·)ã€‚</p><p id="15d8" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘ä»¬å¯ä»¥é€šè¿‡æ±‡æ€»æ¯ä¸ªé›†ç¾¤ä¸­çš„è¯„è®ºæ¥è¿›ä¸€æ­¥æ€»ç»“ä¸Šé¢çš„çƒ­å›¾ã€‚ä¸ºäº†ä½¿è¿™ä¸€æ­¥æ›´é€šç”¨ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬çš„æ•°æ®é›†æ˜¯ä¸€ä¸ªæ ‡ç­¾æœªçŸ¥çš„æ–°æ•°æ®é›†ï¼Œå¹¶ä½¿ç”¨ k=1 çš„ k-æœ€è¿‘é‚»åˆ†ç±»å™¨åŸºäºèšç±»ç»“æœé¢„æµ‹æ ‡ç­¾ã€‚ç„¶åï¼Œåœ¨æŒ‰é¢„æµ‹æ ‡ç­¾åˆ†ç»„åï¼Œæˆ‘ä»¬å¯ä»¥èšåˆæ¯ä¸ªèšç±»ä¸­çš„ SHAP å€¼ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="e898" class="lv lw iq mv b gy mz na l nb nc">from sklearn.neighbors import KNeighborsClassifier</span><span id="0beb" class="lv lw iq mv b gy nd na l nb nc">cluster_model = KNeighborsClassifier(n_neighbors=1)<br/>cluster_model.fit(shap_values_imp,rpy2.robjects.r['clusters'])</span><span id="2963" class="lv lw iq mv b gy nd na l nb nc">predicted = cluster_model.predict(shap_values_imp_r[shap_values_imp_r.columns[:-2]]) </span><span id="ee00" class="lv lw iq mv b gy nd na l nb nc">grouped = pd.concat([shap_values_imp, pd.Series(youtube_df['label'].tolist(), name='avg_tgt')], axis=1).groupby(predicted)</span><span id="1bbb" class="lv lw iq mv b gy nd na l nb nc"># compute average impact to model prediction output. <br/>sums = grouped.apply(lambda x: np.mean(x))</span></pre><p id="6487" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¸‹é¢çš„çƒ­å›¾æ˜¾ç¤ºäº† 30 ä¸ªåˆ†ç±»(y è½´)ä¸­çš„æ¯ä¸ªåˆ†ç±»çš„å‰ 20 ä¸ªæœ¯è¯­å¯¹æ¨¡å‹é¢„æµ‹çš„å½±å“(z è½´ä¸Šæ˜¾ç¤ºçš„å¯¹æ•°ä¼˜åŠ¿)ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="7fa6" class="lv lw iq mv b gy mz na l nb nc">import plotly<br/>import plotly.graph_objs as go<br/>plotly.offline.init_notebook_mode()</span><span id="ee48" class="lv lw iq mv b gy nd na l nb nc">data = [go.Heatmap(z=sums[sums.columns[1:-1]].values.tolist(), <br/>                   y=sums.index,<br/>                   x=sums.columns[1:-1],<br/>                   colorscale='Blues')]</span><span id="f66e" class="lv lw iq mv b gy nd na l nb nc">plotly.offline.iplot(data, filename='pandas-heatmap')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/458e24d61559d7d7bcbdf4f5b39a9867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nX6EZaDXBAhCdNsTcBSptQ.png"/></div></div></figure><p id="06c6" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ä¾‹å¦‚ï¼Œä»çƒ­å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œèšç±» 30 ä¸»è¦æ˜¯â€œå–œæ¬¢çš„è¯„è®ºâ€2 å…ƒè¯­æ³•ï¼Œå¦‚æœæˆ‘ä»¬æŸ¥çœ‹å¹³å‡é¢„æµ‹æ ‡ç­¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ˜¯åˆæ³•è¯„è®ºçš„èšç±»(â€œæ€»å’Œâ€æ•°æ®å¸§çš„â€œavg_tgtâ€å€¼)ã€‚èšç±» 8 å¹³å‡æ¥è¯´æ˜¯åƒåœ¾é‚®ä»¶èšç±»ï¼Œå¹¶ä¸”ä»¥æœ¯è¯­â€œè§†å›¾â€ä¸ºä¸»ã€‚</p><p id="e112" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘ä»¬è¿˜å¯ä»¥èšé›†æ¯ä¸ªèšç±»ä¸­è¯„è®ºçš„ SHAP å€¼ï¼Œä»¥æ˜¾ç¤ºæ¯ä¸ªèšç±»ä¸­ä»€ä¹ˆâ€œä¸»é¢˜â€å ä¸»å¯¼åœ°ä½ã€‚</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="bc5e" class="lv lw iq mv b gy mz na l nb nc">agg_sums = pd.DataFrame({k: sums[v].mean(axis=1) for (k, v) in top20_dict.items()})</span><span id="d049" class="lv lw iq mv b gy nd na l nb nc">data = [go.Heatmap(z=agg_sums[agg_sums.columns].values.tolist(), <br/>                   y=agg_sums.index,<br/>                   x=agg_sums.columns,<br/>                   colorscale='Blues')]</span><span id="2f25" class="lv lw iq mv b gy nd na l nb nc">plotly.offline.iplot(data, filename='pandas-heatmap')</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/d032ff5906eb560fdd1c980925384cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*04a3H_MWCse1zFp9uipdOQ.png"/></div></div></figure><p id="f977" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ç¬¬ 30 ç»„çš„æ„è§æ˜¯</p><pre class="kg kh ki kj gt mu mv mw mx aw my bi"><span id="2995" class="lv lw iq mv b gy mz na l nb nc">pd.options.display.max_colwidth = 1000</span><span id="22ce" class="lv lw iq mv b gy nd na l nb nc">cluster_no = 30</span><span id="29b2" class="lv lw iq mv b gy nd na l nb nc">ex_2 = youtube_df.iloc[rpy2.robjects.r['clusters']==cluster_no]<br/>ex_2_pred = pd.Series(predictions[rpy2.robjects.r['clusters']==cluster_no])<br/>ex_2_top = shap_values_imp_r.iloc[rpy2.robjects.r['clusters']==cluster_no]['top_reasons']</span><span id="09e3" class="lv lw iq mv b gy nd na l nb nc">ex_2</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/bc42c2df2bb37232c559ec8c7ec1c745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZUSJ_O1X_BGG1kYk1PNQzw.png"/></div></div></figure><p id="e4e2" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">ç¬¬ 8 ç»„çš„æ„è§æ˜¯</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/960d03f75b5de9138b9c32dd87c7e1f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K7QKhKCxGT283OTQGjDEDw.png"/></div></div></figure><h2 id="a8a3" class="lv lw iq bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">ç»“è®º</h2><p id="af6d" class="pw-post-body-paragraph ky kz iq la b lb mo jr ld le mp ju lg lh mq lj lk ll mr ln lo lp ms lr ls lt ij bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Shapley å€¼å‘æ¨¡å‹åˆ†æ•°æ·»åŠ ä¿¡æ¯ï¼Œè¿™æ˜¯è·å¾—é¢„æµ‹æ ‡ç­¾çš„â€œåŸå› â€ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªæ¨¡å‹åˆ†æ•°åº”è¯¥æ€»æ˜¯è·Ÿéšç€å¯¹è¿™ä¸ªåˆ†æ•°çš„è§£é‡Šã€‚æ­¤å¤–ï¼Œèšç±» Shapley å€¼å¯ç”¨äºè¯†åˆ«æ•°æ®å®ä¾‹ç»„ï¼Œè¿™äº›æ•°æ®å®ä¾‹å¯ä»¥ç”¨ä»£è¡¨å¤šç§åŸå› çš„æ›´é€šç”¨çš„ä¸»é¢˜æ¥è§£é‡Šã€‚</p><p id="248d" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">æˆ‘è¦æ„Ÿè°¢<a class="ok ol ep" href="https://medium.com/u/b61b6673cdce?source=post_page-----7c945cc531f--------------------------------" rel="noopener" target="_blank"> Sundar Krishnan </a>å’Œ<a class="ok ol ep" href="https://medium.com/u/4d9e48e82766?source=post_page-----7c945cc531f--------------------------------" rel="noopener" target="_blank"> Praveen Thoranathula </a>çš„æœ‰ç›Šè®¨è®ºã€‚</p></div></div>    
</body>
</html>