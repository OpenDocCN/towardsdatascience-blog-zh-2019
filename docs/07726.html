<html>
<head>
<title>Decision Trees for Online Shopping Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于网上购物分析的决策树</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/decision-trees-for-online-shopping-analysis-9010e84f0bb2?source=collection_archive---------12-----------------------#2019-10-26">https://towardsdatascience.com/decision-trees-for-online-shopping-analysis-9010e84f0bb2?source=collection_archive---------12-----------------------#2019-10-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/30638150978ac625b2ead79dff04d770.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oa4sq7vC3gX-mSw0OdInPQ.jpeg"/></div></div></figure><p id="47ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如今有一种使用在线购物解决方案的趋势，如<a class="ae kz" href="https://www.amazon.com/" rel="noopener ugc nofollow" target="_blank">亚马逊</a>、<a class="ae kz" href="https://www.ebay.com/" rel="noopener ugc nofollow" target="_blank">易贝</a>、<a class="ae kz" href="https://www.googleadservices.com/pagead/aclk?sa=L&amp;ai=DChcSEwitqYzJiLXlAhXVko8KHWyRCsIYABAAGgJzYg&amp;ae=1&amp;ohost=www.google.com&amp;cid=CAESQeD2YnHSec5n21hXfeC6w9gzPL_eCjp8uTTi2gzS6_Bj3DWJhHunOms85vjm6-1m27g-JonyJAVrkKFfGDoj7wa1&amp;sig=AOD64_3tafIcM-6CpzEFbiUty2aOQumr0g&amp;q=&amp;ved=2ahUKEwiLzILJiLXlAhW0V3wKHdiHDKsQ0Qx6BAgOEAE&amp;adurl=https://www.aliexpress.com%3Fsrc%3Dgoogle%26albch%3Dfbrnd%26acnt%3D304-410-9721%26isdl%3Dy%26aff_short_key%3DUneMJZVf%26albcp%3D2046244024%26albag%3D71280339814%26slnk%3D%26trgt%3Dkwd-489206970953%26plac%3D%26crea%3D358297651412%26netw%3Dg%26device%3Dc%26mtctp%3De%26memo1%3D1t1%26albbt%3DGoogle_7_fbrnd%26aff_platform%3Dgoogle%26albagn%3D888888%26gclid%3DCj0KCQjwl8XtBRDAARIsAKfwtxDsRTJQSmryb5vDmq9GFaiaa4CEKxzpI6jAYfV2y_YY-5Uveo2IqH8aAhZnEALw_wcB" rel="noopener ugc nofollow" target="_blank">全球速卖通</a>。这些网站为卖家提供了一个向大量客户销售产品的平台。由于许多送货服务与这些在线购物平台相关联，因此来自不同国家的客户购买产品。与传统商店不同，每个卖家的评分和美誉度直接显示在购物平台上。因此，如果顾客不喜欢产品或产品有任何缺陷，卖家会让他们退货。如果顾客抱怨商品没有在承诺的期限内送达，一些卖家会全额退款。一些顾客滥用这些设施，欺骗销售者。因此，网络购物平台上的卖家遭受了巨大的利润损失。让我们讨论如何通过开发一个简单的机器学习模型来发现这些类型的客户；决策树。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><p id="c4f4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你不熟悉决策树，可以看看这篇<a class="ae kz" rel="noopener" target="_blank" href="/decision-trees-in-machine-learning-641b9c4e8052">中型文章。快速回顾一下，决策树是机器学习中的一个模型，它包括我们对数据进行分类的条件(用于标记问题)。举个例子，想一个简单的情况，一个男人很开心，因为天气晴朗或者他在度假。这个场景的模型如下。注意，在这个模型中，你可以用天气和假期状况来预测这个男人的快乐程度。</a></p><figure class="li lj lk ll gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lh"><img src="../Images/dc7c2469e1b4cfdd2eca8f8dd93947c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z0fhuFANGZEhJRX0Iavxnw.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">A simple Decision Tree model</figcaption></figure></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="fdea" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">网购商品退货问题</h1><p id="9933" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">当我参加 Datathon(数据黑客马拉松)比赛时，我从一家数据分析公司获得了一个包含在线购物平台详细信息的数据集。数据集经过编码，因此不会暴露客户和卖家的详细信息。然而，该数据集包括大量关于卖家、客户和产品的数据(以编码的方式)。上面提到的 datathon 的主要任务之一是发现项目返回模式。这包括经常返回的客户属性、一年中的月份、经常返回的商品详细信息和卖家详细信息。完整的数据集包括一年的完整数据。查看数据集架构以了解数据集。</p><figure class="li lj lk ll gt ju"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Dataset schema</figcaption></figure></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="7c51" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">数据集加载和预处理</h1><p id="9b94" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">数据集非常庞大。即使它包含一年的数据，大小也大约是 25GB。被写成 4 个<code class="fe mv mw mx my b">.csv</code>文件(一年每季度一个文件)。即使电脑有 16GB 内存和固态硬盘，文件也很难处理。因此，<a class="ae kz" href="https://pandas.pydata.org/pandas-docs/stable/index.html" rel="noopener ugc nofollow" target="_blank"> pandas </a> python 包被用来分块读取数据集。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="e623" class="nd lr it my b gy ne nf l ng nh">chunks = pd.read_csv('dataset/DataSet01.csv', chunksize=1000000)</span><span id="4629" class="nd lr it my b gy ni nf l ng nh">for chunk in chunks:<br/>    df = chunk<br/>    ## Perform task on dataframe; df</span></pre><p id="c58e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，<code class="fe mv mw mx my b">chunksize</code>参数表示仅来自给定的 1000000 条记录。csv 文件被读取。当预处理数据、训练机器学习模型(这里是决策树)和测试模型时，我们可以逐块执行这些任务。</p><p id="e665" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">至于预处理，缺少属性的记录被忽略，因为有数百万条记录具有必需的属性。通过观察与退货的相关性，给定属性的子集被选择用于项目退货分析。请看这个<a class="ae kz" href="https://github.com/chathuranga95/online-shopping-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>以获得更多关于相关性分析的细节和代码。最后，通过相关性分析和领域知识选择以下属性。</p><p id="05c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mv mw mx my b">selected_atributes = [‘ONLINE_STORE_CATEGORY’, ‘SIZE_CDE’, ‘CLOR_CDE’, ‘SELLING_PRICE’, ‘PRODUCT_CLASS_02’, ‘FMALE_IND’, ‘MRYD_IND’, ‘BRAND_CODE’, ‘EDUC_LVL_NBR’, ‘MRYD’, ‘AGE’, ‘2017_M7_PURCHASE_AMT’, ‘2017_M7_RETURNED_AMT’,’PRODUCT_CLASS_01', ‘PRODUCT_CLASS_02’]</code></p><p id="2773" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意:这些属性包括商品的类别、尺寸、颜色、性别、年龄和顾客的婚姻状况、过去几个月的购买和退货金额、教育水平等。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="bb90" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">构建决策树模型</h1><p id="7177" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">让我们使用 sklearn 的<a class="ae kz" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html" rel="noopener ugc nofollow" target="_blank">决策树分类器</a>来构建我们的决策树模型。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="2b72" class="nd lr it my b gy ne nf l ng nh">from sklearn.tree import DecisionTreeClassifier<br/>from sklearn.model_selection import train_test_split<br/>from sklearn import metrics</span><span id="e002" class="nd lr it my b gy ni nf l ng nh"># load selected attributes and return indication as X and y<br/>X = df[<!-- -->selected_atributes<!-- -->]<br/>y = df.RETURN_INDICATION</span><span id="1a58" class="nd lr it my b gy ni nf l ng nh">## Split dataset into training set and test set<br/>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=1) # 70% training and 30% test</span><span id="b712" class="nd lr it my b gy ni nf l ng nh">model = DecisionTreeClassifier()</span><span id="f1e0" class="nd lr it my b gy ni nf l ng nh"># train the model<br/>model= model.fit(X_train,y_train)</span><span id="b573" class="nd lr it my b gy ni nf l ng nh"># testing the model<br/>y_pred = model.predict(X_test)</span><span id="f06c" class="nd lr it my b gy ni nf l ng nh"># Accuracy calculation<br/>print("Accuracy:", metrics.accuracy_score(y_test, y_pred))</span></pre><p id="0680" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">保留所有的超参数默认值，我获得了 89%的准确率。您还可以通过更改官方<a class="ae kz" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html]" rel="noopener ugc nofollow" target="_blank">文档</a>中提到的参数来更改决策树的超参数。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="eb64" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">可视化模型</h1><p id="e7d9" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">现在，我们已经构建了决策树，我们希望看到客户记录被归类为退货或不退货的条件(决策)。决策树可视化是理解这些条件的好方法。让我们使用<code class="fe mv mw mx my b">sklern.tree</code>中的<code class="fe mv mw mx my b">plot_tree</code>选项来生成树。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="dd0d" class="nd lr it my b gy ne nf l ng nh">tree.plot_tree(model, max_depth=5, filled=True)</span></pre><p id="6739" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意<code class="fe mv mw mx my b">max_depth=5</code>表示可视化树的前 5 个深度级别。我们的树非常复杂。因此，绘制完整的树需要大量的时间和内存。</p><p id="6750" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以使用选项<code class="fe mv mw mx my b">sklearn.tree.export.export_text</code>以文本形式导出树。这样，可以很容易地生成完整的树。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="87e5" class="nd lr it my b gy ne nf l ng nh">from sklearn.tree.export import export_text<br/>r = export_text(model)<br/>print(r)</span></pre><p id="143a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">进入<a class="ae kz" href="https://github.com/chathuranga95/online-shopping-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>查看生成的情节和决策树的文本结构。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="d5f3" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">存储和重用模型</h1><p id="ff3f" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">你可以使用<code class="fe mv mw mx my b">pickle</code>来保存模型。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="3d23" class="nd lr it my b gy ne nf l ng nh">pickle.dump(clf, open('finalized_model.sav', 'wb'))</span></pre><p id="a1f8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以及从转储文件中加载模型。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="86fb" class="nd lr it my b gy ne nf l ng nh">loaded_model = pickle.load(open('finalized_model.sav', 'rb'))</span></pre></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="9168" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">使用模型进行预测(使用模型)</h1><p id="0652" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">要将给定的客户记录分类为退货或不退货，我们可以使用 sklearn 树模型中的<code class="fe mv mw mx my b">predict</code>方法。请注意，您首先必须按照与您在模型构建步骤中相同的顺序加载相同的属性。让我们预测测试数据，因为我们将数据集分为训练集和测试集。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="ae26" class="nd lr it my b gy ne nf l ng nh">y_pred_loaded = loaded_model.predict(X_test)</span></pre><p id="45ec" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将返回一个预测列表(商品退货指示)，可以将该列表与实际退货指示进行比较，以评估我们的模型。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="2027" class="nd lr it my b gy ne nf l ng nh">print(“Accuracy:”, metrics.accuracy_score(y_test, y_pred_loaded))<br/>&gt;&gt;&gt; 0.96</span></pre><p id="4671" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">更重要的是，我们可以用这个模型来预测一些看不见的数据。如<strong class="kd iu">网购商品退货问题</strong>小节所述，数据集有 4 个。csv 文件。我们已经使用第一个文件来训练我们的模型。让我们使用第四个文件来预测返回指示。请注意，我们使用 pandas 来分块加载数据。</p><pre class="li lj lk ll gt mz my na nb aw nc bi"><span id="597a" class="nd lr it my b gy ne nf l ng nh">selected_atributes<!-- -->= ['ONLINE_STORE_CATEGORY', 'SIZE_CDE', 'CLOR_CDE', 'SELLING_PRICE', 'PRODUCT_CLASS_02', 'FMALE_IND', 'MRYD_IND', 'BRAND_CODE', 'EDUC_LVL_NBR', 'MRYD', 'AGE', '2017_M7_PURCHASE_AMT', '2017_M7_RETURNED_AMT','PRODUCT_CLASS_01', 'PRODUCT_CLASS_02']<br/>chunks = pd.read_csv('dataset/DataSet04.csv',chunksize=1000000)</span><span id="b280" class="nd lr it my b gy ni nf l ng nh">i = 0<br/>for chunk in chunks:<br/>    i = i +1<br/>    if(i&gt;10):<br/>        break<br/>    df = chunk</span><span id="e87e" class="nd lr it my b gy ni nf l ng nh"># load features and target seperately<br/>    X_test = df[<!-- -->selected_atributes<!-- -->]<br/>    y_test = df.RETURN_INDICATION<br/>    <br/>    y_pred = loaded_model.predict(X_test)<br/>    <br/>    print("Accuracy for chunk ", i, metrics.accuracy_score(y_test, y_pred))</span><span id="3cf9" class="nd lr it my b gy ni nf l ng nh">&gt;&gt;&gt; Accuracy for chunk  1 0.865241<br/>&gt;&gt;&gt; Accuracy for chunk  2 0.860326<br/>&gt;&gt;&gt; Accuracy for chunk  3 0.859471<br/>&gt;&gt;&gt; Accuracy for chunk  4 0.853036<br/>&gt;&gt;&gt; Accuracy for chunk  5 0.852454<br/>&gt;&gt;&gt; Accuracy for chunk  6 0.859550<br/>&gt;&gt;&gt; Accuracy for chunk  7 0.869302<br/>&gt;&gt;&gt; Accuracy for chunk  8 0.866371<br/>&gt;&gt;&gt; Accuracy for chunk  9 0.867436<br/>&gt;&gt;&gt; Accuracy for chunk  10 0.89067</span></pre><p id="a6b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在测试步骤中，我们获得了 96%的准确率。然而，这将导致 80 年代中期的精度。这是因为该模型在一年的第一季度过度适应了季节变化。(回想一下，我们只使用第一个。4 个文件的 csv 文件)因此，它没有捕获一年最后一个季度的季节性变化。然而，在使用所有 4 个训练模型之后。csv 文件可以解决这个问题。您仍然可以从所有 4 个小块中加载数据。csv 文件并训练模型。</p><p id="0da1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这个<a class="ae kz" href="https://github.com/chathuranga95/online-shopping-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>查看代码。希望这篇文章对你有用。</p></div></div>    
</body>
</html>