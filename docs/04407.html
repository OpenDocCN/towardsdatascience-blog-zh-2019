<html>
<head>
<title>Geolocation with BigQuery: De-identify 76 million IP addresses in 20 seconds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 BigQuery 进行地理定位:在 20 秒内识别出 7600 万个 IP 地址</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geolocation-with-bigquery-de-identify-76-million-ip-addresses-in-20-seconds-e9e652480bd2?source=collection_archive---------32-----------------------#2019-07-08">https://towardsdatascience.com/geolocation-with-bigquery-de-identify-76-million-ip-addresses-in-20-seconds-e9e652480bd2?source=collection_archive---------32-----------------------#2019-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d761" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">四年前，我们发布了第一个去识别 IP 地址的方法- <a class="ae kf" href="https://cloudplatform.googleblog.com/2014/03/geoip-geolocation-with-google-bigquery.html" rel="noopener ugc nofollow" target="_blank">使用 Google BigQuery 的 GeoIP 地理定位- </a>，现在是时候进行更新了，包括最好和最新的 BigQuery 功能，如使用最新的 SQL 标准，处理嵌套数据，以及更快地处理连接。</h2></div><p id="a4ca" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="ki ir"> <em class="lc">重要更新</em> </strong> : <em class="lc">我在 2020 年离开了谷歌，加入了雪花——所以我无法保持更新我的旧帖子。如果你想尝尝雪花啤酒，加入我们吧——我在❄️.玩得很开心</em></p><p id="357a" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="lc">这篇较新的帖子将向您展示如何在 Snowflak </em>  <em class="lc"> e 中运行地理定位——没有这里描述的任何预处理——感谢 Snowflak 运行 Java UDFs 的能力。</em></p><div class="ld le gp gr lf lg"><a href="https://hoffa.medium.com/free-ip-address-geolocation-with-maxmind-and-snowflake-676e74ea80b8" rel="noopener follow" target="_blank"><div class="lh ab fo"><div class="li ab lj cl cj lk"><h2 class="bd ir gy z fp ll fr fs lm fu fw ip bi translated">MaxMind 和雪花的免费 IP 地址地理定位</h2><div class="ln l"><h3 class="bd b gy z fp ll fr fs lm fu fw dk translated">让我们在雪花中编写一个 Java UDF，使用 MaxMind 的 GeoLite2 免费地理定位数据对 IP 地址进行地理定位——</h3></div><div class="lo l"><p class="bd b dl z fp ll fr fs lm fu fw dk translated">hoffa.medium.com</p></div></div><div class="lp l"><div class="lq l lr ls lt lp lu lv lg"/></div></div></a></div><p id="154c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><a class="ae kf" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank"> BigQuery 是 Google Cloud 的</a>无服务器数据仓库，旨在实现可伸缩性和快速性能。使用它，您可以探索大型数据集，以找到新的和有意义的见解。为了遵守当前的政策和法规，在分析包含个人数据的数据集时，您可能需要取消用户的 IP 地址。例如，在<a class="ae kf" href="https://cloud.google.com/blog/topics/inside-google-cloud/google-cloud-ready-for-gdpr" rel="noopener ugc nofollow" target="_blank"> GDPR </a>下，一个 IP 地址可能被认为是<a class="ae kf" href="https://support.google.com/analytics/answer/7686480?hl=en" rel="noopener ugc nofollow" target="_blank"> PII 或者个人数据</a>。</p><p id="980d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">用一个粗略的位置替换收集到的 IP 地址是帮助降低风险的一种方法 BigQuery 已经准备好提供帮助。让我们看看怎么做。</p><h1 id="cd89" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">如何识别 IP 地址数据</h1><p id="3046" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">在这个如何轻松识别 IP 地址的示例中，我们使用:</p><ul class=""><li id="a320" class="mt mu iq ki b kj kk km kn kp mv kt mw kx mx lb my mz na nb bi translated">2001 年至 2010 年间，维基百科从匿名编辑那里收集了 7600 万个 IP 地址</li><li id="aad1" class="mt mu iq ki b kj nc km nd kp ne kt nf kx ng lb my mz na nb bi translated">MaxMind 的<a class="ae kf" href="https://dev.maxmind.com/geoip/geoip2/geolite2/" rel="noopener ugc nofollow" target="_blank"> Geolite2 免费地理定位数据库</a></li><li id="cea3" class="mt mu iq ki b kj nc km nd kp ne kt nf kx ng lb my mz na nb bi translated">BigQuery 改进的字节和联网功能<code class="fe nh ni nj nk b">NET.SAFE_IP_FROM_STRING(), NET.IP_NET_MASK()</code></li><li id="20ca" class="mt mu iq ki b kj nc km nd kp ne kt nf kx ng lb my mz na nb bi translated">BigQuery 的<a class="ae kf" href="https://cloud.google.com/bigquery/docs/nested-repeated" rel="noopener ugc nofollow" target="_blank">新超能力</a>处理嵌套数据，生成数组，并运行令人难以置信的快速连接</li><li id="38de" class="mt mu iq ki b kj nc km nd kp ne kt nf kx ng lb my mz na nb bi translated">新的<a class="ae kf" href="https://cloud.google.com/bigquery/docs/gis-visualize" rel="noopener ugc nofollow" target="_blank"> BigQuery Geo Viz 工具</a>使用谷歌地图 API 来绘制世界各地的地理点。</li></ul><p id="c419" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">让我们直接进入查询。使用下面的代码将 IP 地址替换为通用位置。</p><h2 id="39b3" class="nl lx iq bd ly nm nn dn mc no np dp mg kp nq nr mi kt ns nt mk kx nu nv mm nw bi translated">编辑维基百科的顶级国家</h2><p id="cf48" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">以下是用户编辑维基百科的国家列表，后面是要使用的查询:</p><figure class="ny nz oa ob gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi nx"><img src="../Images/e4528add1b9491af0fc268ee2a2a4997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*c2npLrwweEtCdjiS.png"/></div></div></figure><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="4a8f" class="nl lx iq nk b gy om on l oo op">#standardSQL</span><span id="50f0" class="nl lx iq nk b gy oq on l oo op"># replace with your source of IP addresses<br/># here I'm using the same Wikipedia set from the previous article<br/>WITH source_of_ip_addresses AS (<br/>  SELECT REGEXP_REPLACE(contributor_ip, 'xxx', '0')  ip, COUNT(*) c<br/>  FROM `publicdata.samples.wikipedia`<br/>  WHERE contributor_ip IS NOT null  <br/>  GROUP BY 1<br/>)</span><span id="299f" class="nl lx iq nk b gy oq on l oo op">SELECT country_name, SUM(c) c<br/>FROM (<br/>  SELECT ip, country_name, c<br/>  FROM (<br/>    SELECT *, NET.SAFE_IP_FROM_STRING(ip) &amp; NET.IP_NET_MASK(4, mask) network_bin<br/>    FROM source_of_ip_addresses, UNNEST(GENERATE_ARRAY(9,32)) mask<br/>    WHERE BYTE_LENGTH(NET.SAFE_IP_FROM_STRING(ip)) = 4<br/>  )<br/>  JOIN `fh-bigquery.geocode.201806_geolite2_city_ipv4_locs`  <br/>  USING (network_bin, mask)<br/>)<br/>GROUP BY 1<br/>ORDER BY 2 DESC</span><span id="3389" class="nl lx iq nk b gy oq on l oo op">Query complete (20.9 seconds elapsed, 1.14 GB processed)</span></pre><h2 id="dc11" class="nl lx iq bd ly nm nn dn mc no np dp mg kp nq nr mi kt ns nt mk kx nu nv mm nw bi translated">编辑维基百科的顶级城市</h2><p id="a51d" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">这些是从 2001 年到 2010 年收集的用户编辑维基百科的热门城市，然后是要使用的查询:</p><figure class="ny nz oa ob gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi nx"><img src="../Images/f9d642a9db67ba186eb47f5c7e752a88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*souyPHrA03TSYVTR.png"/></div></div></figure><figure class="ny nz oa ob gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi nx"><img src="../Images/df560ef662a5cfb083d1a9b0333625f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BQmqWuwe3nRUOhY1.png"/></div></div></figure><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="9262" class="nl lx iq nk b gy om on l oo op"># replace with your source of IP addresses<br/># here I'm using the same Wikipedia set from the previous article<br/>WITH source_of_ip_addresses AS (<br/>  SELECT REGEXP_REPLACE(contributor_ip, 'xxx', '0')  ip, COUNT(*) c<br/>  FROM `publicdata.samples.wikipedia`<br/>  WHERE contributor_ip IS NOT null  <br/>  GROUP BY 1<br/>)</span><span id="4314" class="nl lx iq nk b gy oq on l oo op">SELECT city_name, SUM(c) c, ST_GeogPoint(AVG(longitude), AVG(latitude)) point<br/>FROM (<br/>  SELECT ip, city_name, c, latitude, longitude, geoname_id<br/>  FROM (<br/>    SELECT *, NET.SAFE_IP_FROM_STRING(ip) &amp; NET.IP_NET_MASK(4, mask) network_bin<br/>    FROM source_of_ip_addresses, UNNEST(GENERATE_ARRAY(9,32)) mask<br/>    WHERE BYTE_LENGTH(NET.SAFE_IP_FROM_STRING(ip)) = 4<br/>  )<br/>  JOIN `fh-bigquery.geocode.201806_geolite2_city_ipv4_locs`  <br/>  USING (network_bin, mask)<br/>)<br/>WHERE city_name  IS NOT null<br/>GROUP BY city_name, geoname_id<br/>ORDER BY c DESC<br/>LIMIT 5000`</span></pre><h1 id="3c6c" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">探索一些新的 BigQuery 特性</h1><p id="ca78" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">这些新的查询符合最新的 SQL 标准，支持一些我们将在这里回顾的新技巧。</p><h2 id="7707" class="nl lx iq bd ly nm nn dn mc no np dp mg kp nq nr mi kt ns nt mk kx nu nv mm nw bi translated">新的 MaxMind 表:再见数学，你好 IP 掩码</h2><p id="3258" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated"><a class="ae kf" href="https://dev.maxmind.com/geoip/geoip2/geolite2/" rel="noopener ugc nofollow" target="_blank">可下载的 GeoLite2 表</a>不再基于范围。现在他们使用适当的 IP 网络，如“156.33.241.0/22”。</p><p id="71d1" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">使用 BigQuery，我们将这些解析成带有整数掩码的二进制 IP 地址。我们还对 GeoLite2 表进行了一些预处理，将网络和位置合并到一个表中，并添加了已解析的网络列，如下所示:</p><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="f0cd" class="nl lx iq nk b gy om on l oo op">#standardSQL<br/>SELECT *<br/>  , NET.IP_FROM_STRING(REGEXP_EXTRACT(network, r'(.*)/' )) network_bin<br/>  , CAST(REGEXP_EXTRACT(network, r'/(.*)' ) AS INT64) mask<br/>FROM `fh-bigquery.geocode.201806_geolite2_city_ipv4` <br/>JOIN `fh-bigquery.geocode.201806_geolite2_city_locations_en`<br/>USING(geoname_id)</span></pre><h2 id="cdc8" class="nl lx iq bd ly nm nn dn mc no np dp mg kp nq nr mi kt ns nt mk kx nu nv mm nw bi translated">地理定位百万分之一的 IP 地址</h2><p id="9d94" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">要在该表中找到一个 IP 地址，如“103.230.141.7”，可能需要这样做:</p><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="7178" class="nl lx iq nk b gy om on l oo op">SELECT country_name, city_name, mask<br/>FROM `fh-bigquery.geocode.201806_geolite2_city_ipv4_locs` <br/>WHERE network_bin = NET.IP_FROM_STRING('103.230.141.7')</span></pre><p id="b1c0" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">但那不管用。我们需要使用正确的面具:</p><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="0879" class="nl lx iq nk b gy om on l oo op">SELECT country_name, city_name, mask<br/>FROM `fh-bigquery.geocode.201806_geolite2_city_ipv4_locs` <br/>WHERE network_bin = NET.IP_FROM_STRING('103.230.141.7') &amp; NET.IP_NET_MASK(4, 24)</span></pre><p id="cb8b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这就得到了一个答案:这个 IP 地址似乎住在南极洲。</p><h1 id="7e28" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">按比例放大</h1><p id="4641" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">这看起来很容易，但我们还需要几个步骤来找出 GeoLite2 表(超过 300 万行)和大量 IP 地址源之间的正确掩码和连接。</p><p id="b279" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这就是主查询中的下一行所做的:</p><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="93cc" class="nl lx iq nk b gy om on l oo op">SELECT *<br/>     , NET.SAFE_IP_FROM_STRING(ip) <br/>       &amp; NET.IP_NET_MASK(4, mask) network_bin<br/>  FROM source_of_ip_addresses, UNNEST(GENERATE_ARRAY(9,32)) mask</span></pre><p id="98d4" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这基本上是使用所有可能的掩码(数字在 9 到 32 之间)应用交叉连接，并使用这些掩码来屏蔽源 IP 地址。接下来是真正精彩的部分:BigQuery 设法以极快的速度处理正确的连接:</p><pre class="ny nz oa ob gt oi nk oj ok aw ol bi"><span id="b4e9" class="nl lx iq nk b gy om on l oo op">USING (network_bin, mask)</span></pre><p id="82d4" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">BigQuery 在这里只选择一个被屏蔽的 IP——屏蔽的 IP 和带有给定掩码的网络相匹配的 IP。如果我们更深入地挖掘，我们会在 execution details 选项卡中发现 BigQuery 做了一个“内部 HASH JOIN EACH WITH EACH ON”，这需要大量的洗牌资源，但仍然不需要两个大型表之间的完全交叉连接。</p><figure class="ny nz oa ob gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi nx"><img src="../Images/59a3068f2624a77eefac11ebe8fd4cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NUj_uqFCmfPp3pyX.png"/></div></div></figure><figure class="ny nz oa ob gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi nx"><img src="../Images/e6cb07b41883fb127a35de4963b1ad71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*unTvg-isouBXGdIO.png"/></div></div></figure><h1 id="c511" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">进一步匿名化数据</h1><p id="aa2c" class="pw-post-body-paragraph kg kh iq ki b kj mo jr kl km mp ju ko kp mq kr ks kt mr kv kw kx ms kz la lb ij bi translated">这就是 BigQuery 如何帮助您用粗略的位置替换 IP 地址，并提供单个行的聚合。这只是可以帮助您降低处理数据风险的一种技术。GCP 提供了其他几个工具，包括<a class="ae kf" href="https://cloud.google.com/dlp/" rel="noopener ugc nofollow" target="_blank">云数据丢失防护</a> (DLP)，可以帮助你扫描和识别数据。您现在有几个选项来探索和使用数据集，让您遵守法规。你用什么有趣的方式使用去身份数据？<a class="ae kf" href="https://twitter.com/felipehoffa?lang=en" rel="noopener ugc nofollow" target="_blank">让我们知道。</a></p><p id="a45b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在 BigQuery 中找到最新的<a class="ae kf" href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&amp;d=geolite2&amp;page=dataset" rel="noopener ugc nofollow" target="_blank"> MaxMind GeoLite2 表，这要感谢我们的</a><a class="ae kf" href="https://cloud.google.com/public-datasets/" rel="noopener ugc nofollow" target="_blank">谷歌云公共数据集</a>。</p></div><div class="ab cl or os hu ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="ij ik il im in"><p id="4c67" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="lc">原发布于 2019 年 7 月 8 日</em><a class="ae kf" href="https://dev.to/felipehoffa/geolocation-with-bigquery-de-identify-76-million-ip-addresses-in-20-seconds-3dpc" rel="noopener ugc nofollow" target="_blank"><em class="lc">https://dev . to</em></a><em class="lc">。</em></p></div></div>    
</body>
</html>