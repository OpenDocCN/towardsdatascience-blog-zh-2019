<html>
<head>
<title>Tidy Anomaly Detection using R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 R 的整洁异常检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tidy-anomaly-detection-using-r-82a0c776d523?source=collection_archive---------6-----------------------#2019-04-06">https://towardsdatascience.com/tidy-anomaly-detection-using-r-82a0c776d523?source=collection_archive---------6-----------------------#2019-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3ab6a3c7c040f4a814dd170d3e7c054d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c_izoTJmD9hDDLI307xJ9g.png"/></div></div></figure><p id="b88d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">想象一下，你经营着一家像 Amazon.com 这样的在线企业，你想为下一年规划服务器资源——你必须知道你的负载什么时候会达到峰值(或者至少在回顾中是什么时候达到峰值的，以便相信它会再次出现),这就是你需要时间序列异常检测的地方。虽然有一些像 Twitter 的<a class="ae kw" href="https://github.com/twitter/AnomalyDetection" rel="noopener ugc nofollow" target="_blank">异常检测</a>这样的软件包已经在做这项工作，但还有另一个很好的候选软件——anomalize——它可以做一些其他异常检测软件包没有做的事情。这是很好的异常检测。</p><h1 id="50d8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><a class="ae kw" href="https://datacamp.pxf.io/c/2888696/1240322/13294?u=https%3A%2F%2Fpromo.datacamp.com" rel="noopener ugc nofollow" target="_blank">享受 78%的 DataCamp 折扣</a></h1><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lv"><img src="../Images/1f32ec33f0aa3fa27b7ece422b00c223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jGXfPSqZBqEx3Ma7.png"/></div></div></figure><p id="312c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ma">请注意，本文的目的是帮助您以简洁的方式执行异常检测，而不是向您传授异常检测或时间序列数据的原理和概念。</em></p><h1 id="93f8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用 R——整齐的方法进行异常检测意味着什么？</h1><p id="d8b8" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">抱歉这么说！众所周知，使用 R 的数据科学家会编写笨拙的代码——可读性不强的代码和效率不高的代码，但这种趋势一直在改变，因为<a class="ae kw" href="http://hadley.nz/" rel="noopener ugc nofollow" target="_blank"> Hadley Wickham </a>推广了<code class="fe mg mh mi mj b">tidy</code>原则，他应该不需要在 R 宇宙中做任何介绍，因为他的<code class="fe mg mh mi mj b">tidyverse</code>有助于许多 R 数据科学家的效率和工作。现在，这个由<a class="ae kw" href="http://www.business-science.io/" rel="noopener ugc nofollow" target="_blank">商业科学</a>开源的新包<code class="fe mg mh mi mj b">anomalize</code>进行时间序列异常检测，它与其他 Tidyverse 包(或支持整齐数据的包)内联——具有最常用的 Tidyverse 功能之一——与管道<code class="fe mg mh mi mj b">%&gt;%</code>操作符兼容，以编写可读和可再现的数据管道。</p><h1 id="9676" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">异常化—安装</h1><p id="495d" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">R package anomalize 的稳定版本可从起重机上的<a class="ae kw" href="https://cran.r-project.org/web/packages/anomalize/index.html" rel="noopener ugc nofollow" target="_blank">获得，其安装方式如下:</a></p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="f7b9" class="mo ky iq mj b gy mp mq l mr ms">install.packages('anomalize')</span></pre><p id="271d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">github 上有最新开发版本的 anomalize，安装方式如下:</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="8a16" class="mo ky iq mj b gy mp mq l mr ms">#install.packages('devtools') <br/>devtools::install_github("business-science/anomalize")</span></pre><p id="1d0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">考虑到开发版不需要编译工具，最好从 github 安装开发版，这样会更无 bug，而且有最新的功能。</p><h1 id="7390" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">案例—比特币价格异常检测</h1><p id="0b3a" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">通过实际操作并将其与我们的现状联系起来，学习一个新的概念或代码会更容易。所以，为了理解 R 中整齐的异常检测，我们将尝试检测 2017 年以来比特币价格的异常。</p><h1 id="005b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">加载所需的包</h1><p id="b77b" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">我们使用以下 3 个软件包来解决上述情况:</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="9b0f" class="mo ky iq mj b gy mp mq l mr ms">library(anomalize) #tidy anomaly detectiom<br/>library(tidyverse) #tidyverse packages like dplyr, ggplot, tidyr<br/>library(coindeskr) #bitcoin price extraction from coindesk</span></pre><h1 id="01e8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">数据析取</h1><p id="2383" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">我们使用来自<code class="fe mg mh mi mj b">coindeskr</code>的<code class="fe mg mh mi mj b">get_historic_price()</code>从 Coindesk 提取历史比特币价格。产生的数据帧存储在对象<code class="fe mg mh mi mj b">btc</code>中</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="bc84" class="mo ky iq mj b gy mp mq l mr ms">btc &lt;- get_historic_price(start = "2017-01-01")</span></pre><h1 id="685a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">数据预处理</h1><p id="f963" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">对于使用 anomalize 的异常检测，我们需要一个<code class="fe mg mh mi mj b">tibble</code>或<code class="fe mg mh mi mj b">tibbletime</code>对象。因此，我们必须将 dataframe <em class="ma"> btc </em>转换成遵循时间序列形状的 tibble 对象，并将其存储在<code class="fe mg mh mi mj b">btc_ts</code>中。</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="85fa" class="mo ky iq mj b gy mp mq l mr ms">btc_ts &lt;- btc %&gt;% rownames_to_column() %&gt;% as.tibble() %&gt;% <br/>  mutate(date = as.Date(rowname)) %&gt;% select(-one_of('rowname'))</span></pre><p id="d055" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只看 btc_ts 的头部看样本数据:</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="f283" class="mo ky iq mj b gy mp mq l mr ms">head(btc_ts)<br/><em class="ma"> Price date      <br/>1  998. 2017-01-01<br/>2 1018. 2017-01-02<br/>3 1031. 2017-01-03<br/>4 1130. 2017-01-04<br/>5 1006. 2017-01-05<br/>6  896. 2017-01-06</em></span></pre><h1 id="b7a6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">异常时间序列分解</h1><p id="8fdd" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在开始时间序列预测或建模之前，时间序列数据的一项重要工作是时间序列分解，即将时间序列数据分解为季节、趋势和余数部分。anomalize 有一个函数<code class="fe mg mh mi mj b">time_decompose()</code>来执行同样的功能。一旦组件被分解，<code class="fe mg mh mi mj b"> anomalize</code>可以检测和标记提醒组件的分解数据中的异常，然后可以用<code class="fe mg mh mi mj b"> plot_anomaly_decomposition() </code>可视化。</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="44ec" class="mo ky iq mj b gy mp mq l mr ms">btc_ts %&gt;% <br/>  time_decompose(Price, method = "stl", frequency = "auto", trend = "auto") %&gt;%<br/>  anomalize(remainder, method = "gesd", alpha = 0.05, max_anoms = 0.2) %&gt;%<br/>  plot_anomaly_decomposition()</span></pre><p id="9f24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">给出了这个图:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f349f7541a775ee609d2c284173676b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pwfU4XUr01CWdVE8.png"/></div></div></figure><p id="dbe3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从上面的代码中可以看出，分解是基于“stl”方法进行的，这是时间序列分解的常用方法，但是如果您一直在使用 Twitter 的 AnomalyDetection，那么同样可以通过将 time_decompose(method = "twitter ")与<code class="fe mg mh mi mj b">anomalize(method = "gesd")</code>结合起来在 anomalize 中实现。“stl”分解方法也可以与<code class="fe mg mh mi mj b">anomalize(method = "iqr")</code>结合，用于不同的基于 IQR 的异常检测。</p><h1 id="f1aa" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">异常检测</h1><p id="b971" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">异常检测和绘制检测到的异常几乎类似于我们在上面看到的时间序列分解。只是异常检测后分解的组件用<code class="fe mg mh mi mj b">time_recompose()</code>重新组合，用<code class="fe mg mh mi mj b"> plot_anomalies() </code>标绘。该软件包本身会自动处理许多参数设置，如指数、频率和趋势，使得在相同领域中使用较少的专业知识即可轻松运行异常检测。</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="4214" class="mo ky iq mj b gy mp mq l mr ms">btc_ts %&gt;% <br/>  time_decompose(Price) %&gt;%<br/>  anomalize(remainder) %&gt;%<br/>  time_recompose() %&gt;%<br/>  plot_anomalies(time_recomposed = TRUE, ncol = 3, alpha_dots = 0.5)</span></pre><p id="dfd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">给出了这个图:</p><figure class="lw lx ly lz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ae5b3475fc86467fb98d31cdafdd994f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ddfLqmS5bE_YHwnJ.png"/></div></div></figure><p id="0499" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从给定的图中可以很好地推断出异常检测在发现 2018 年初发生的比特币价格疯狂方面的准确性。</p><p id="1baf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您对提取异常的实际数据点感兴趣，可以使用以下代码:</p><pre class="lw lx ly lz gt mk mj ml mm aw mn bi"><span id="470e" class="mo ky iq mj b gy mp mq l mr ms">btc_ts %&gt;% <br/>  time_decompose(Price) %&gt;%<br/>  anomalize(remainder) %&gt;%<br/>  time_recompose() %&gt;%<br/>  filter(anomaly == 'Yes') <br/><em class="ma">Converting from tbl_df to tbl_time.<br/>Auto-index message: index = date<br/>frequency = 7 days<br/>trend = 90.5 days<br/># A time tibble: 58 x 10<br/># Index: date<br/>   date       observed   season trend remainder remainder_l1 remainder_l2 anomaly recomposed_l1<br/>                                                 <br/> 1 2017-11-12    5857.  36.0    7599.    -1778.       -1551.        1672. Yes             6085.<br/> 2 2017-12-04   11617.  11.2    9690.     1916.       -1551.        1672. Yes             8150.<br/> 3 2017-12-05   11696.  -2.01   9790.     1908.       -1551.        1672. Yes             8237.<br/> 4 2017-12-06   13709.  -9.11   9890.     3828.       -1551.        1672. Yes             8330.<br/> 5 2017-12-07   16858.   0.0509 9990.     6868.       -1551.        1672. Yes             8439.<br/> 6 2017-12-08   16057. -28.1    9971.     6114.       -1551.        1672. Yes             8393.<br/> 7 2017-12-09   14913.  -8.03   9953.     4969.       -1551.        1672. Yes             8394.<br/> 8 2017-12-10   15037.  36.0    9934.     5067.       -1551.        1672. Yes             8420.<br/> 9 2017-12-11   16700.  11.2    9916.     6773.       -1551.        1672. Yes             8376.<br/>10 2017-12-12   17178.  -2.01   9897.     7283.       -1551.        1672. Yes             8345.<br/># ... with 48 more rows, and 1 more variable: recomposed_l2</em></span></pre><p id="d2e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，anomalize 使得用更简洁的代码在 R 中执行异常检测变得更加容易，这些代码也可以用在使用 tidyverse 构建的任何数据管道中。这里使用的代码可以在我的 github 上找到。如果你想更多地了解 R 中的时间序列预测，请查看<a class="ae kw" href="https://www.datacamp.com/courses/forecasting-in-r?irclickid=V0FwRdyHGxyIW7HRYNWRwwwzUkG3P3TqCXti2k0&amp;irgwc=1&amp;utm_medium=affiliate&amp;utm_source=impact&amp;utm_campaign=2888696" rel="noopener ugc nofollow" target="_blank">Rob hynd man 教授在 Datacamp </a>上的课程。</p></div></div>    
</body>
</html>