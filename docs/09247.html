<html>
<head>
<title>Add this single word to make your Pandas Apply faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">添加这个单词，让你的熊猫申请更快</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/add-this-single-word-to-make-your-pandas-apply-faster-90ee2fffe9e8?source=collection_archive---------1-----------------------#2019-12-07">https://towardsdatascience.com/add-this-single-word-to-make-your-pandas-apply-faster-90ee2fffe9e8?source=collection_archive---------1-----------------------#2019-12-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/062044f6b035aace89d7bcabceecd459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NY85nQ4lLPS-M94fGAOFg.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Image by <a class="ae jg" href="https://pixabay.com/users/kaboompics-1013994/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=791149" rel="noopener ugc nofollow" target="_blank">Karolina Grabowska</a> from <a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=791149" rel="noopener ugc nofollow" target="_blank">Pixabay</a></figcaption></figure><div class=""/><div class=""><h2 id="e989" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated"><strong class="ak"> <em class="ky">易于实现并行化</em> </strong></h2></div><p id="9778" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为数据科学家，我们有四核、八核和睿频加速的笔记本电脑。我们使用具有更多内核和计算能力的服务器。</p><p id="7faa" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我们真的利用了我们手头的原始力量吗？T9】</p><p id="cec5" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有时，我们会受到我们所掌握的工具的限制。有时我们不愿意为了节省几分钟时间而编写所有无关的代码。后来才意识到时间优化从长远来看是有帮助的。</p><p id="74c4" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb jk"> <em class="lv">那么，我们能做得更好吗？</em>T13】</strong></p><p id="b994" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，很明显。</p><p id="9689" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以前，我曾经写过如何让你的<code class="fe lw lx ly lz b">apply</code>函数更快——使用<a class="ae jg" rel="noopener" target="_blank" href="/make-your-own-super-pandas-using-multiproc-1c04f41944a1">多重处理</a>，但是由于有了<a class="ae jg" href="https://github.com/jmcarpenter2/swifter" rel="noopener ugc nofollow" target="_blank"> swifter </a>库，它现在变得更加琐碎。</p><p id="c888" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb jk"> <em class="lv">这篇文章是关于使用我们手头的计算能力，并使用 Swifter 将其应用于熊猫数据帧。</em> </strong></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="cd08" class="mh mi jj bd mj mk ml mm mn mo mp mq mr kp ms kq mt ks mu kt mv kv mw kw mx my bi translated">问题陈述</h1><p id="2cb7" class="pw-post-body-paragraph kz la jj lb b lc mz kk le lf na kn lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我们有一个巨大的熊猫数据框，我们想对它应用一个复杂的函数，这需要很多时间。</p><p id="5609" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这篇文章，我将生成一些 25M 行 4 列的数据。</p><p id="0ab4" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb jk"> <em class="lv">可以轻松使用并行化来获得额外的代码性能吗？</em>T25】</strong></p><pre class="ne nf ng nh gt ni lz nj nk aw nl bi"><span id="5d2e" class="nm mi jj lz b gy nn no l np nq">import pandas as pd<br/>import numpy as np</span><span id="606a" class="nm mi jj lz b gy nr no l np nq">pdf = pd.DataFrame(np.random.randint(0,100,size=(25000000, 4)),columns=list('abcd'))</span></pre><p id="68b5" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据看起来像:</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ns"><img src="../Images/898133a8b4e34a78baf3df0a8c4db441.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*elXTZeIHsCUTl7uAqC2UcQ.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Data Sample</figcaption></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="7c83" class="mh mi jj bd mj mk ml mm mn mo mp mq mr kp ms kq mt ks mu kt mv kv mw kw mx my bi translated">仅使用一项变更的并行化</h1><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nt"><img src="../Images/ccec4c9adfc047333db93c249559d927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3smjpsAINGwjFchm.jpg"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk">Relax and Parallelize !!!</figcaption></figure><p id="e82e" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们做一个简单的实验。</p><p id="d4fe" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将尝试在数据框架中创建一个新列。我们可以简单地通过在熊猫身上使用 apply-lambda 来做到这一点。</p><pre class="ne nf ng nh gt ni lz nj nk aw nl bi"><span id="8934" class="nm mi jj lz b gy nn no l np nq">def func(a,b):<br/>    if a&gt;50:<br/>        return True<br/>    elif b&gt;75:<br/>        return True<br/>    else:<br/>        return False</span><span id="badb" class="nm mi jj lz b gy nr no l np nq">pdf['e'] = pdf.apply(lambda x : func(x['a'],x['b']),axis=1)</span></pre><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nu"><img src="../Images/693eee21025a8ec41173437ed67f6355.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dskqqJA2XG9hFTdlokzOfw.png"/></div></div></figure><p id="2161" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码运行大约需要 10 分钟。这里我们只是对两列进行简单的计算。</p><p id="e3e9" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们能做得更好吗？需要什么？</p><p id="5dce" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，我们可以做得更好，只要加上一个“神奇的词”——更快。 </p><p id="580c" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是首先，您需要安装 swifter，这很简单:</p><pre class="ne nf ng nh gt ni lz nj nk aw nl bi"><span id="6758" class="nm mi jj lz b gy nn no l np nq">conda install -c conda-forge swifter</span></pre><p id="717f" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以在<code class="fe lw lx ly lz b">apply</code>之前导入并附加 swifter 关键字来使用它。</p><pre class="ne nf ng nh gt ni lz nj nk aw nl bi"><span id="2c98" class="nm mi jj lz b gy nn no l np nq">import swifter<br/>pdf['e'] = pdf.<strong class="lz jk">swifter</strong>.apply(lambda x : func(x['a'],x['b']),axis=1)</span></pre><h2 id="cba1" class="nm mi jj bd mj nv nw dn mn nx ny dp mr li nz oa mt lm ob oc mv lq od oe mx of bi translated"><strong class="ak"> <em class="ky">那么，这行得通吗？</em> </strong></h2><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nu"><img src="../Images/11f3b430a685ef11e3725471745f3d23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TmFO4KBi97Q-LzrGQPJjog.png"/></div></div></figure><p id="e167" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的。确实如此。与直接使用该函数相比，我们的运行时间提高了 2 倍。</p><h2 id="e13a" class="nm mi jj bd mj nv nw dn mn nx ny dp mr li nz oa mt lm ob oc mv lq od oe mx of bi translated"><strong class="ak"> <em class="ky">那么这里到底发生了什么？</em> </strong></h2><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/febb8c8efa10b0a482db60e86f2a80e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zVUuP1yv06oBR5Lb.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk"><a class="ae jg" href="https://github.com/jmcarpenter2/swifter" rel="noopener ugc nofollow" target="_blank">Source</a>: How increasing data size effects performances for Dask, Pandas and Swifter?</figcaption></figure><p id="e7cc" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb jk"> <em class="lv"> Swifter 为您的函数选择实现</em> </strong> <code class="fe lw lx ly lz b"><strong class="lb jk"><em class="lv">apply</em></strong></code> <strong class="lb jk"> <em class="lv">的最佳方式，方法是对您的函数进行矢量化，或者在后端使用 Dask 来并行化您的函数，或者在数据集很小的情况下使用简单的 pandas apply。</em>T9】</strong></p><p id="a478" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个特例中，Swifter 使用 Dask 来并行化我们的应用函数，默认值为<code class="fe lw lx ly lz b">npartitions = cpu_count()*2</code>。</p><p id="7971" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于 MacBook，我使用的 CPU 数量是 6，超线程是 2。因此，CPU 计数为 12，这使得 npartitions=24。</p><p id="f17a" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb jk"> <em class="lv">我们也可以选择自己设置 n_partitions。虽然我观察到缺省值在大多数情况下工作得很好，但有时你也可以调整它来获得额外的加速。</em></strong></p><p id="cc97" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:下面我设置 n_partitions=12，我们再次获得了 2 倍的加速。这里，减少我们的分区数量会缩短运行时间，因为分区之间的数据移动成本很高。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oh"><img src="../Images/88e9b7378a915df60cc569c810410653.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTbM2XmwxGah5AUUiqdI_A.png"/></div></div></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="34bc" class="mh mi jj bd mj mk ml mm mn mo mp mq mr kp ms kq mt ks mu kt mv kv mw kw mx my bi translated">结论</h1><blockquote class="oi"><p id="f92b" class="oj ok jj bd ol om on oo op oq or lu dk translated"><strong class="ak">并行化不是银弹；这是铅弹。</strong></p></blockquote><p id="7c09" class="pw-post-body-paragraph kz la jj lb b lc os kk le lf ot kn lh li ou lk ll lm ov lo lp lq ow ls lt lu im bi translated">并行化不会解决您的所有问题，您仍然需要优化您的函数，但是它是您的武器库中的一个很好的工具。</p><p id="a27e" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">时间一去不复返，有时我们也缺少时间。在这些时候，我们需要用一个词来处理并行化。</p><p id="7074" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb jk"> <em class="lv">而那个字就是</em> </strong> <a class="ae jg" href="https://github.com/jmcarpenter2/swifter" rel="noopener ugc nofollow" target="_blank"> <strong class="lb jk"> <em class="lv">更快</em> </strong> </a> <strong class="lb jk"> <em class="lv">。</em>T29】</strong></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="d08e" class="mh mi jj bd mj mk ml mm mn mo mp mq mr kp ms kq mt ks mu kt mv kv mw kw mx my bi translated">继续学习</h1><p id="076a" class="pw-post-body-paragraph kz la jj lb b lc mz kk le lf na kn lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">另外，如果你想了解更多关于 Python 的知识，我想向密歇根大学推荐一门优秀的中级 Python 课程。一定要去看看。</p><p id="1322" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将来我也会写更多初学者友好的帖子。在<a class="ae jg" href="https://medium.com/@rahul_agarwal" rel="noopener"> <strong class="lb jk">媒体</strong> </a>关注我或者订阅我的<a class="ae jg" href="https://mlwhiz.ck.page/a9b8bda70c" rel="noopener ugc nofollow" target="_blank"> <strong class="lb jk">博客</strong> </a>了解他们。一如既往，我欢迎反馈和建设性的批评，可以通过 Twitter <a class="ae jg" href="https://twitter.com/MLWhiz" rel="noopener ugc nofollow" target="_blank"> @mlwhiz </a>联系到我。</p><p id="bfe3" class="pw-post-body-paragraph kz la jj lb b lc ld kk le lf lg kn lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，一个小小的免责声明——这篇文章中可能会有一些相关资源的附属链接，因为分享知识从来都不是一个坏主意。</p></div></div>    
</body>
</html>