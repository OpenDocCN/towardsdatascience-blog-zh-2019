<html>
<head>
<title>Using Python To Create a Slack Bot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 创建一个 Slack Bot</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-python-to-create-a-slack-bot-fdc2c335915d?source=collection_archive---------21-----------------------#2019-10-29">https://towardsdatascience.com/using-python-to-create-a-slack-bot-fdc2c335915d?source=collection_archive---------21-----------------------#2019-10-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/59bab0be776ac8697525c7d4882e6eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0piyFmAlw_uO4sxV"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@lenin33?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Lenin Estrada</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a518" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在一家初创公司工作时，我们需要自动处理消息，以便获得某些事件和触发的通知。例如，我工作的公司处理与某些商店的联系。如果连接中断，Python 将读取我们数据库中的信息。我们现在可以将该数据发送到一个 Slack 通道，专门用于重新连接该存储。</p><p id="3f5b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以为这个 Slack Bot 创造许多可能性，我的同事创造的另一个例子是将 Python 错误消息输出到通道。不仅创建通知，还创建持续的错误日志。</p><p id="285e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在可以做些简单的事情。对于这个项目，我们将构建一个 Slack Bot，如果它检测到脚本运行的日期是美国假日，它将输出一条消息。</p><p id="6ec4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">这个项目需要什么:</strong> <br/> <strong class="ki iu"> 1。<em class="le"> Python <br/> 2。松弛工作空间/帐户</em> </strong></p><p id="d114" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">所需 Python 模块:</strong> <br/> 1。<strong class="ki iu"> <em class="le"> datetime </em> </strong>(告知脚本运行的日期并标准化日期时间)<br/> 2。<strong class="ki iu"> <em class="le">熊猫</em> </strong>(主要用于将数据组织成 dataframe) <br/> 3 .<strong class="ki iu"> <em class="le">请求</em> </strong>(连接到我们从网站获取的数据，并将数据发送到 slack API) <br/> 4 .<strong class="ki iu"> <em class="le"> bs4 </em> </strong>(我们正在从网站获取的数据的数据解析)<br/> 5。<strong class="ki iu"> <em class="le"> json </em> </strong>(对数据进行编码，以便 slack API 可以使用)</p><p id="4e24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，让我们创建一个新的 Python 文件并导入所需的模块。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="27c4" class="lo lp it lk b gy lq lr l ls lt">from datetime import date, datetime, timedelta<br/>import pandas as pd<br/>import requestsfrom bs4 <br/>import BeautifulSoup<br/>import json</span></pre><p id="704e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以使用<code class="fe lu lv lw lk b">datetime</code>模块获取今天的日期时间，并将其存储为年-月-日这样的字符串格式。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="868c" class="lo lp it lk b gy lq lr l ls lt">today = datetime.now().strftime(‘%Y-%m-%d’)<br/>#today = '2019-10-29'</span></pre><p id="26af" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用模块<code class="fe lu lv lw lk b">requests</code>，我们现在可以连接到我们想要获取数据的网站。为此，我连接到这个<a class="ae kf" href="https://www.timeanddate.com/holidays/us/" rel="noopener ugc nofollow" target="_blank"> <em class="le">网站</em> </a>获取假期。当我们从一个网站获取数据时，它会发送我们在该页面上看到的所有内容。我们只想要这个数据中的假期。这就是<a class="ae kf" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/" rel="noopener ugc nofollow" target="_blank"> BeautifulSoup </a>发挥作用的地方，使用模块<code class="fe lu lv lw lk b">bs4</code>我们可以很容易地解析这些数据。我们现在可以把它放到一个数据框架中。</p><p id="c44d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这不是将数据传输到数据帧的最佳方式，但我们只需要完成这项工作。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="09bc" class="lo lp it lk b gy lq lr l ls lt">regionalHolidaysList = []<br/>for result in results:    <br/>     date = result.contents[0].text + ', ' + datetime.today().strftime('%Y')    <br/>     weekday = result.contents[1].text    <br/>     holidayName = result.contents[2].text    <br/>     observance = result.contents[3].text     <br/>     stateObserved = result.contents[4].text<br/>     regionalHolidaysList.append((date, weekday, holidayName, observance, stateObserved))</span><span id="91b2" class="lo lp it lk b gy lx lr l ls lt">regionalHolidayDf = pd.DataFrame(regionalHolidaysList, columns = ['date', 'weekday', 'holidayName', 'observance', 'stateObserved'])</span><span id="9c6e" class="lo lp it lk b gy lx lr l ls lt">regionalHolidayDf['date'] = regionalHolidayDf['date'].apply(lambda x: (datetime.strptime(x, '%b %d, %Y').strftime('%Y-%m-%d')))</span></pre><p id="b39e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在可以从这个数据帧创建一个日期时间列表</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="0c90" class="lo lp it lk b gy lq lr l ls lt">dateList = regionalHolidayDf['date'].tolist()</span></pre><p id="fb09" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果<code class="fe lu lv lw lk b">today</code>在这个<code class="fe lu lv lw lk b">dateList</code>中，我们可以告诉它打印到请求的空闲通道。为了让 Python 使用 Slack 发送东西，我们需要创建一个传入的 webhook。Slack 有一些关于如何做到这一点的文档，在 https://api.slack.com/messaging/webhooks<a class="ae kf" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="6f9d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果一切都做得正确，那么我们应该有这样的东西:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="8427" class="lo lp it lk b gy lq lr l ls lt">https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX</span></pre><p id="5ff4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后一部分变得有点复杂，所以我将在代码中用标签来发布我的评论。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="ae95" class="lo lp it lk b gy lq lr l ls lt">#So we get the date if it is in this list it will send a message in slack</span><span id="8f84" class="lo lp it lk b gy lx lr l ls lt">if today in dateList:<br/>     todayHoliday = regionalHolidayDf[regionalHolidayDf['date'] ==          today]    <br/>     info=[]    <br/>     for holiday in todayHoliday.itertuples():<br/>          info.append(':umbrella_on_ground:' +                       holiday.holidayName +  ' in ' +                      holiday.stateObserved.replace('*', ''))    <br/>     if len(info) &gt;1:        <br/>          infoFinal = '\n'.join(info)    <br/>     else:        <br/>       infoFinal = info[0]</span><span id="e127" class="lo lp it lk b gy lx lr l ls lt">#Here is where we can format the slack message, it will output any holiday with todays<br/>        <br/>     message = f'@here Fun fact! \n Today({today}) is: \n {infoFinal}'        <br/>     print('Sending message to the happyholiday channel...')<br/>     slackmsg = {'text': message}    </span><span id="ba1e" class="lo lp it lk b gy lx lr l ls lt">#Using the module json it formats it where the slack API can accept it<br/>#we can store the slack link into a variable called webhook</span><span id="db01" class="lo lp it lk b gy lx lr l ls lt">        webhook='<!-- -->https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX'<br/>response = requests.post(webhook,  data=json.dumps(slackmsg), headers={'Content-Type': 'application/json'})    <br/>     if response.status_code != 200:        <br/>          raise ValueError('Request to slack returned an error %s, the response is:\n%s'            % (response.status_code, response.text)        )    <br/>     print('Request completed!')<br/>else:    <br/>     print('No regional holiday today! See you next time!')</span></pre><p id="0769" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们终于可以运行这个脚本了，如果成功，它将根据脚本运行的日期输出一个假日。</p><p id="3bf4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了进一步自动化，我们可以将它放在 EC2 上，让它每天运行！但这需要更多的证书和设置，让我知道如果这是另一个话题，你们有兴趣！</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="49d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">访问我的代码<a class="ae kf" href="https://www.patreon.com/melvfnz" rel="noopener ugc nofollow" target="_blank">这里</a>！</p><p id="d52a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在这里也有家教和职业指导。</p><p id="8936" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你们有任何问题、评论或顾虑，请不要忘记通过 LinkedIn<a class="ae kf" href="https://www.linkedin.com/in/melvfernandez/" rel="noopener ugc nofollow" target="_blank">与我联系！</a></p></div></div>    
</body>
</html>