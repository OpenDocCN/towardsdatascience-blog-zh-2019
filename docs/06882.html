<html>
<head>
<title>Tricks for Postgres and Docker that will make your life easier</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让你的生活变得更轻松的 Postgres 和 Docker 技巧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tricks-for-postgres-and-docker-that-will-make-your-life-easier-fc7bfcba5082?source=collection_archive---------15-----------------------#2019-09-30">https://towardsdatascience.com/tricks-for-postgres-and-docker-that-will-make-your-life-easier-fc7bfcba5082?source=collection_archive---------15-----------------------#2019-09-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5a14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如今，每个人都试图在容器中运行一切，我不责怪他们，我也做同样的事情，因为在 Docker 容器中运行应用程序、数据库或其他工具是非常好的，我们都知道为什么(隔离、容易设置、安全……)。然而，有时调试、访问或通常与容器的交互会非常烦人。这包括访问、修改或查询数据库。因此，由于我广泛使用 PostgreSQL，并且已经在容器中运行了一段时间，随着时间的推移，我列出了一些命令，这些命令在对数据库服务器进行简单和不太简单的操作时会有很大帮助。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/8bb9754d4390fcb51e6e5448e5b97195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wg7pRIUc7uRO23ZcoY6U_w.jpeg"/></div></div></figure><h1 id="a997" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">登录 PSQL</h1><p id="55b3" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">如果您想与数据库服务器交互，您需要做的最基本的事情就是连接到数据库本身(使用<em class="md"> PSQL </em>):</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="eb80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，对于名为<code class="fe mg mh mi mj b">db</code>的 Docker 容器、默认用户<code class="fe mg mh mi mj b">postgres</code>和数据库名<code class="fe mg mh mi mj b">blog</code>，应该是</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><h1 id="c7f0" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">对数据库运行命令</h1><p id="cf5c" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">您可以登录然后执行您需要的任何命令，这很好，但是一次完成通常更方便，尤其是如果您只想运行一个命令或查询:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="f1ed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，如果我们想使用与上例相同的参数列出数据库中的所有表:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="377c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，<code class="fe mg mh mi mj b">\l</code>列出了当前数据库中的所有表格，如果您不熟悉<em class="md"> psql </em>“反斜杠”命令，那么我强烈推荐这张<a class="ae mk" href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546" rel="noopener ugc nofollow" target="_blank">备忘单</a>。</p><p id="cf92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了<code class="fe mg mh mi mj b">psql</code>命令之外，您可以运行任何 SQL 查询，如下所示:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><h1 id="2aa3" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">备份您的数据</h1><p id="8a65" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">有时，我需要备份数据或数据库的整个模式，有时只是作为一种<em class="md">“保险政策”</em>，有时我可以不顾一切地进行更改，然后恢复一切，所以下面是如何做的:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="dfaa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个例子中，我们使用了<code class="fe mg mh mi mj b">pg_dump</code>实用程序，它允许我们提取 PostgreSQL 数据库。我使用<code class="fe mg mh mi mj b">--column-inserts</code>和<code class="fe mg mh mi mj b">--data-only</code>标志只获取表行，但通常只需要模式，为此您可以使用<code class="fe mg mh mi mj b">-s</code>标志。</p><h1 id="41f1" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">执行整个 SQL 文件</h1><p id="f8d5" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">有时，您需要用足够的数据填充现有数据库进行测试(请不要对生产数据库这样做)，或者使用文件中的数据，然后将它们复制并粘贴到上面的命令中会更容易。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="46c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里我们首先需要将文件本身复制到运行容器中，然后使用<code class="fe mg mh mi mj b">-f</code>标志执行它。</p><h1 id="faa4" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">开始时预填充数据库</h1><p id="b761" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">如果您需要不时地执行它，前面的例子已经足够好了，但是如果您每次启动数据库时都必须这样做，那就变得很烦人了。因此，如果您决定最好在一开始就填充数据库，那么这里有一个解决方案。它只需要多做一点工作:</p><p id="36ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要以下文件:</p><ul class=""><li id="8e4c" class="ml mm it js b jt ju jx jy kb mn kf mo kj mp kn mq mr ms mt bi translated"><code class="fe mg mh mi mj b">Dockerfile</code> - <em class="md"> Dockerfile </em>为你的 Postgres 镜像</li><li id="51df" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated"><code class="fe mg mh mi mj b">create_db.sh</code> -创建数据库、模式并填充它的脚本。</li><li id="d823" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated"><code class="fe mg mh mi mj b">schema.sql</code> -包含数据库模式的 SQL 文件</li><li id="b733" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated"><code class="fe mg mh mi mj b">data.sql</code> -包含用于填充数据库的数据的 SQL 文件</li><li id="2a6c" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated"><code class="fe mg mh mi mj b">.env</code> -带环境变量的文件，让你的生活更轻松</li></ul><p id="5747" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一，<code class="fe mg mh mi mj b">Dockerfile</code>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="3859" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这非常简单<em class="md"> Dockerfile </em>，我们在这里需要做的就是将我们的脚本和模式/数据复制到映像中，以便它们可以在运行启动时使用。你可能会问，<em class="md">没有</em> <code class="fe mg mh mi mj b"><em class="md">ENTRYPOINT</em></code> <em class="md">或者</em> <code class="fe mg mh mi mj b"><em class="md">COMMAND</em></code> <em class="md">，我们如何在启动时运行它？</em> -答案是，基本的<code class="fe mg mh mi mj b">postgres</code>映像在<code class="fe mg mh mi mj b">docker-entrypoint-initdb.d</code>目录中的任何脚本上运行，所以我们需要做的就是将我们的脚本复制到这个目录，PostgreSQL 会处理它。</p><p id="2e5e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是剧本里有什么(<code class="fe mg mh mi mj b">create_db.sh</code>)？</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="523d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">启动脚本首先使用指定的用户名(<code class="fe mg mh mi mj b">POSTGRES_USER</code>)登录<code class="fe mg mh mi mj b">psql</code>，然后创建您的数据库(<code class="fe mg mh mi mj b">DB_NAME</code>)。接下来，它使用我们复制到映像中的文件创建数据库模式，最后用数据填充数据库。这里的所有变量都来自前面提到的<code class="fe mg mh mi mj b">.env</code>文件，这使得随时更改数据库名称或用户名变得非常容易，而无需修改脚本本身。</p><p id="b562" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更多完整的例子请见我的知识库<a class="ae mk" href="https://github.com/MartinHeinz/blog-backend/tree/master/postgres" rel="noopener ugc nofollow" target="_blank">这里</a></p><h1 id="86dd" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">那<code class="fe mg mh mi mj b">docker-compose</code>呢？</h1><p id="8a1b" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">根据我的经验，大部分时间我都是将数据库与使用它的应用程序一起运行，最简单的方法是<em class="md"> docker-compose </em>。通常我更喜欢通过服务名来引用<em class="md"> docker-compose </em>服务，而不是容器名，容器名可能是也可能不是同一个东西。如果不一样，您可以执行以下命令:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="b0c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里与前面的例子唯一不同的是<code class="fe mg mh mi mj b">docker-compose</code>部分，它查找指定服务的信息。<code class="fe mg mh mi mj b">-q</code>标志使得只显示容器 id，这正是我们所需要的。</p><h1 id="966f" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="ee3e" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">我希望这些小技巧中至少有一些能让您在处理 Docker 和 PostgreSQL 时更轻松，或者如果您只是因为在处理数据库时 Docker 可能有点烦人而避免使用它，那么我希望您在阅读完本文后会尝试一下。🙂</p><p id="20af" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="md">注:此文最初发布于</em><a class="ae mk" href="https://martinheinz.dev/blog/3" rel="noopener ugc nofollow" target="_blank"><em class="md">martinheinz . dev</em></a></p></div></div>    
</body>
</html>