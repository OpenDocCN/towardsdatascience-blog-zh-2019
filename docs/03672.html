<html>
<head>
<title>Here’s how you can get some free speed on your Python code with Numba</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">下面是你如何用 Numba 在你的 Python 代码上获得一些免费的速度</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/heres-how-you-can-get-some-free-speed-on-your-python-code-with-numba-89fdc8249ef3?source=collection_archive---------9-----------------------#2019-06-11">https://towardsdatascience.com/heres-how-you-can-get-some-free-speed-on-your-python-code-with-numba-89fdc8249ef3?source=collection_archive---------9-----------------------#2019-06-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="523a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">轻松将您的 Python 代码转换成快速机器码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ae424af08038c7deece21f87dece0d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4I2lvHPKDD_iCI-7g7Ac6A.jpeg"/></div></div></figure><blockquote class="ku kv kw"><p id="8c9b" class="kx ky kz la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想获得灵感？快来加入我的<a class="ae lu" href="https://www.superquotes.co/?utm_source=mediumtech&amp;utm_medium=web&amp;utm_campaign=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">超级行情快讯</strong> </a>。😎</p></blockquote><p id="681c" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">“我们不能用 Python，太慢了。”</p><p id="77d9" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">任何使用 Python 足够长时间的人可能都曾听过这样的说法。</p><p id="3d0b" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">说这话的人也没有错。相对于很多其他编程语言，Python <em class="kz">慢</em>。<a class="ae lu" href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/gpp-python3.html" rel="noopener ugc nofollow" target="_blank">基准游戏</a>有一些比较各种编程语言在不同任务上速度的坚实基准。</p><p id="6443" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">解决这个速度问题的一个常见方法是用 C++之类的更快的语言重新编写代码，然后在上面添加一个 Python 包装器。这将使您获得 C++的速度，同时保持在主应用程序中使用 Python 的简便性。</p><p id="54f5" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">当然，挑战在于你必须用 C++重写代码；这是一个相当耗时的过程。</p><p id="d242" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">Python 库<strong class="la iu"> Numba </strong>为我们提供了一种简单的方法来应对这一挑战——无需编写除 Python 之外的任何代码就可以免费加速！</p><h1 id="7223" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">介绍 Numba</h1><p id="30d2" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">Numba 是一个编译器库，可以将 Python 代码转换成优化的机器代码。通过这种转换，Numba 可以使用 Python 编写的数值算法接近 C 代码的速度。</p><p id="0001" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">你也不需要用你的 Python 代码做任何花哨的事情。只需在您想要优化的 Python 函数前添加一行代码，Numba 就会完成剩下的工作！</p><p id="8a80" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">我们可以使用 pip 安装 Numba:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="ccfe" class="na lz it mw b gy nb nc l nd ne">pip install numba</span></pre><p id="ace0" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">如果你的代码有很多数值运算，使用 Numpy 很多，和/或有很多循环，那么 Numba 应该给你一个很好的加速。</p><h1 id="6597" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">加速 Python 循环</h1><p id="63e9" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">Numba 最基本的用途是加速那些可怕的 Python for 循环。</p><p id="73cf" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">首先，如果你在你的 Python 代码中使用了一个循环，首先检查一下你是否能用一个<a class="ae lu" rel="noopener" target="_blank" href="/one-simple-trick-for-speeding-up-your-python-code-with-numpy-1afc846db418"> numpy 函数</a>来替换它总是一个好主意。当然也有 numpy 没有你想要的功能的情况。</p><p id="80cf" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">在我们的第一个例子中，我们将为 Python 中的插入排序算法编写一个函数。该函数将一个未排序的列表作为输入，并将排序后的列表作为输出返回。</p><p id="d6ec" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">下面的代码首先构造一个包含 100，000 个随机整数的列表。然后，我们连续 50 次对列表应用插入排序，并测量所有 50 次排序操作的平均速度。</p><p id="6bc1" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">100，000 个数字对于排序来说是相当多的数字，尤其是当我们的排序算法的平均复杂度为 O(n ) 时。在我的 i7-8700k 电脑上，对所有这些数字进行排序平均需要 3.0104 秒！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="d72d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">众所周知，Python 循环很慢。在我们的例子中，情况更糟，在 for 循环的中有一个 while 循环<em class="kz">。另外，由于我们的排序算法是 O(n ),当我们向列表中添加更多的条目时，我们的运行时间会以二次方增加！</em></p><p id="e7ea" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">让我们加快 numba 的速度。</p><p id="5764" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">当我们看到一个函数包含一个用纯 Python 编写的循环时，这通常是一个好迹象，表明 numba 可以提供帮助。查看下面的代码，看看它是如何工作的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="7b4d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">我们只在代码中增加了 2 行代码。第一个是导入语句，用于导入<strong class="la iu"> jit </strong>装饰器。第二个是我们在函数中使用 jit 装饰器。</p><p id="caec" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">将 jit decorator 应用到我们的函数向 numba 发出信号，表明我们希望将机器码转换应用到函数中。</p><p id="fb9f" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">nopython 参数指定我们是希望 Numba 使用纯机器码，还是在必要时填入一些 python 代码。这通常应该设置为 true 以获得最佳性能，除非您发现 Numba 抛出一个错误。</p><p id="6380" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">这就是全部了！只需在您的函数上方添加<strong class="la iu"> @jit(nopython=True) </strong>，Numba 会处理剩下的事情！</p><p id="510d" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">在我的电脑上，对所有这些数字进行排序平均需要 0.1424 秒，速度提高了 21 倍！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="9949" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">加速数字运算</h1><p id="a55a" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">Numba 的另一个亮点是加速 Numpy 的操作。这一次，我们将把 3 个相当大的数组加在一起，大约是一个典型图像的大小，然后使用<code class="fe nh ni nj mw b">numpy.square()</code>函数将它们平方。</p><p id="b0c0" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">查看下面的代码，看看这是如何在 Python 中用一点 Numpy 实现的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="4a04" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">请注意，每当我们在 Numpy 数组上进行基本的数组计算时，比如加法、乘法和平方，代码都会被 Numpy 自动进行内部矢量化。这就是为什么尽可能用 Numpy 替换纯 Python 代码通常性能会好得多。</p><p id="6d1e" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">上面的代码在我的 PC 上组合数组的平均运行时间为 0.002288 秒。</p><p id="3510" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">但是，即使 Numpy 代码也没有 Numba 使用的机器优化代码快。下面的代码将执行与之前完全相同的数组操作。这一次，我们在函数上方添加了<strong class="la iu">矢量化</strong>装饰器，通知 numba 应该对我们的函数执行机器码转换。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="a701" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">矢量化装饰器接受两个输入。</p><p id="e382" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">第一个指定您将操作的 numpy 数组的输入类型。这必须被指定，因为 Numba 使用它来将代码转换成它的最佳版本。通过事先了解输入类型，Numba 将能够准确地计算出如何最有效地存储和操作数组。</p><p id="7bc5" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">第二个输入称为“目标”。它指定了您希望如何运行您的功能:</p><ul class=""><li id="b78f" class="nk nl it la b lb lc le lf lv nm lw nn lx no lt np nq nr ns bi translated"><strong class="la iu"> cpu: </strong>用于运行在单个 cpu 线程上</li><li id="a559" class="nk nl it la b lb nt le nu lv nv lw nw lx nx lt np nq nr ns bi translated"><strong class="la iu">并行:</strong>用于在多核多线程 CPU 上运行</li><li id="4561" class="nk nl it la b lb nt le nu lv nv lw nw lx nx lt np nq nr ns bi translated"><strong class="la iu"> cuda: </strong>用于在 GPU 上运行</li></ul><p id="81c5" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">在几乎所有情况下，<em class="kz">并行</em>选项往往比<em class="kz"> cpu </em>选项快得多。<em class="kz"> cuda </em>选项主要适用于具有许多可并行操作的超大型阵列，因为在这种情况下，我们可以充分利用 GPU 上拥有如此多内核的优势。</p><p id="b22c" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">上面的代码在我的电脑上组合数组的平均运行时间为 0.001196 秒，这大约是 2 倍的加速。对于添加一行代码来说还不错！</p><h1 id="e920" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">总是超级快吗？</h1><p id="37a5" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">Numba 在应用于以下任何一个领域时都是最有效的:</p><ul class=""><li id="d40c" class="nk nl it la b lb lc le lf lv nm lw nn lx no lt np nq nr ns bi translated">Python 代码比 C 代码慢的地方(通常是循环)</li><li id="b214" class="nk nl it la b lb nt le nu lv nv lw nw lx nx lt np nq nr ns bi translated">对一个区域应用相同操作的地方(例如，对许多元素应用相同的操作)</li></ul><p id="20c4" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">在这些地区之外，Numba 可能不会给你太多的速度。因为在这种情况下，转换到低级代码所带来的优势就消失了。</p><p id="1615" class="pw-post-body-paragraph kx ky it la b lb lc ju ld le lf jx lg lv li lj lk lw lm ln lo lx lq lr ls lt im bi translated">总的来说，快速尝试一下总是值得的。在几个 Python 函数上添加一行代码是值得一试的，可以将代码速度提高 2 到 21 倍！</p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><h1 id="5404" class="ly lz it bd ma mb of md me mf og mh mi jz oh ka mk kc oi kd mm kf oj kg mo mp bi translated">喜欢学习？</h1><p id="437e" class="pw-post-body-paragraph kx ky it la b lb mq ju ld le mr jx lg lv ms lj lk lw mt ln lo lx mu lr ls lt im bi translated">在 twitter 上关注我，我会在这里发布所有最新最棒的人工智能、技术和科学！也在 LinkedIn 上与我联系！</p></div></div>    
</body>
</html>