<html>
<head>
<title>Python Web Scraping Refactored</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 网络抓取重构</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-web-scraping-refactored-5834dda39a65?source=collection_archive---------14-----------------------#2019-04-04">https://towardsdatascience.com/python-web-scraping-refactored-5834dda39a65?source=collection_archive---------14-----------------------#2019-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="56fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我在旧博客上的第一篇文章是关于一个网络抓取的例子。网络抓取是使用 API 之外的一种方式，例如<a class="ae ko" href="http://www.tweepy.org/" rel="noopener ugc nofollow" target="_blank"> tweepy </a>来为你的分析或你的机器学习模型获取信息。真实数据并不总是在一个方便的 CSV 文件中。你需要自己去拿。</p><p id="bcb2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我学到的例子来自凯文·马卡姆在 Youtube 上的<a class="ae ko" href="https://www.youtube.com/watch?v=r_xb0vF1uMc&amp;list=PL5-da3qGB5IDbOi0g5WFh1YPDNzXw4LNL" rel="noopener ugc nofollow" target="_blank">网络抓取演示视频(Twitter 标签:</a><a class="ae ko" href="https://twitter.com/justmarkham?lang=en" rel="noopener ugc nofollow" target="_blank"> @justmarkham </a>)。他的例子使用了一个循环来收集所有的信息。但是 Python 有一个比循环更有效、可读性更强的工具。那些是<a class="ae ko" href="https://docs.python.org/3/tutorial/datastructures.html" rel="noopener ugc nofollow" target="_blank">列表理解</a>。如果你不确定这些是什么，看看下面的帖子了解更多。一旦你完成了，请继续阅读，学习如何通过从这所<a class="ae ko" href="https://www.newvisions.org/ams2/pages/our-staff2" rel="noopener ugc nofollow" target="_blank">布朗克斯高中</a>的职员页面上搜集姓名、职位和电子邮件地址来有效地进行网络搜集。</p><div class="kp kq gp gr kr ks"><a href="https://medium.com/@erikgreenj/python-basics-list-comprehensions-30ef0df40fea" rel="noopener follow" target="_blank"><div class="kt ab fo"><div class="ku ab kv cl cj kw"><h2 class="bd iu gy z fp kx fr fs ky fu fw is bi translated">Python 基础-列表理解</h2><div class="kz l"><h3 class="bd b gy z fp kx fr fs ky fu fw dk translated">学习 python 几周后，我开始真正掌握了窍门。我喜欢有条件的心流，而且…</h3></div><div class="la l"><p class="bd b dl z fp kx fr fs ky fu fw dk translated">medium.com</p></div></div></div></a></div><p id="96e0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lb">*注。根据您阅读本文的时间，最终结果可能会有所不同，因为网页上的数据可能已经发生了变化。最终结果截至 2019 年 4 月 3 日** </em></p><h1 id="e4d7" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">酷！我们如何开始？</h1><p id="f92f" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">让我们从导入和获取网页开始。</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="9de7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们导入<code class="fe mm mn mo mp b">requests</code>来获得带有<code class="fe mm mn mo mp b">requests.get()</code>的 web_page。<code class="fe mm mn mo mp b">pandas</code>稍后将用于清理我们的报废数据。<code class="fe mm mn mo mp b">bs4</code>库中的<code class="fe mm mn mo mp b">BeautifulSoup</code>将用于解析我们的糊状 HTML，以帮助我们获得我们想要的信息。我们将在下面这样做。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mq"><img src="../Images/3e44a8760807963cc3b55dbde385a1a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*puI9ZDGL6EBNw5Y2"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Photo by <a class="ae ko" href="https://unsplash.com/@oelli?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Elli O.</a> on <a class="ae ko" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="2db1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们将研究来自<code class="fe mm mn mo mp b">web_page</code>的 HTML 代码，以找到我们需要的代码段。要查看网页的 HTML 代码，请转到该网页，右键单击并选择“查看页面源代码”。然后，您可以按 ctrl-f 找到一个职员的名字，以查看嵌入了他们的名字和信息的 HTML 代码。</p><p id="ecb4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您稍微滚动一下代码，您应该会注意到代码行中包含了一些信息，例如:</p><p id="8891" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mm mn mo mp b">&lt;title&gt;……&lt;/title&gt;</code></p><p id="d3a5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者</p><p id="f2ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe mm mn mo mp b">&lt;p&gt;…..&lt;/p&gt;</code></p><p id="80df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些在 HTML 代码中被称为标签。在这些标签之间隐藏着我们想要获取的信息。</p><p id="9a59" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于我们看到所需的信息在<code class="fe mm mn mo mp b">&lt;div&gt;</code>标签和<code class="fe mm mn mo mp b">class=’matrix-content’</code>标签之间，我们可以假设所有教师的信息都在该类的每个标签中。这就是为什么我们使用标签和类作为 soup 的<code class="fe mm mn mo mp b">find_all</code>属性的参数。</p><p id="d655" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要从第一个教师简介出现的索引开始，因为我们只收集教师信息。第一个出场的老师是“布罗根先生”。你可以使用 ctrl-f 在 HTML 代码中搜索他的名字。如果数的话(当然是从 0 开始)，布罗根先生的指数是 29。这就是为什么我们从指数 29 开始重新定义结果。对结果长度的检查和对被移除的员工的心算证实了我们可以进入下一步了！</p><h1 id="bfe7" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">现在获取所有教师数据！对吗？</h1><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nb"><img src="../Images/f661e1488fe16f5d66ef82c34c820806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JrNktWxfJ-3jjPOF"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Photo by <a class="ae ko" href="https://unsplash.com/@rxspawn?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Florian Olivo</a> on <a class="ae ko" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3681" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们会的。在此之前，我们应该先看看如何从一个老师那里获得我们想要的信息。然后我们将把它推广到我们的理解列表中。让我们来看一个教师简介的 HTML 代码。我们将再次检查布洛根先生的信息:</p><pre class="mf mg mh mi gt nc mp nd ne aw nf bi"><span id="5cd0" class="ng ld it mp b gy nh ni l nj nk">&lt;div class="matrix-content"&gt;<br/>        &lt;h5&gt;Mr. Brogan&lt;/h5&gt;                   <br/>        &lt;div class="matrix-copy"&gt;&lt;p&gt;<br/>    Special Education: Geometry, Particular Topics of Geometry&lt;/p&gt;<br/>&lt;p&gt;<br/>    &lt;em&gt;rbrogan31@charter.newvisions.org&lt;/em&gt;&lt;/p&gt;<br/>&lt;/div&gt;<br/>                                            &lt;/div&gt;</span></pre><p id="1d43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样，我们需要确定包含教师姓名、职位和电子邮件的标签。花点时间试着自己回答这个问题，然后继续读下去，看看你是否正确。这将为研究您需要在 python 抓取代码中指示 HTML 的哪些部分提供良好的实践。还记得我之前给你们看的例子吗？</p><p id="8983" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lb">教师姓名标签:</em>姓名在标记为<code class="fe mm mn mo mp b">&lt;h5&gt;</code>的标签之间。</p><p id="b6f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lb">位置标签</em>:位置位于类别标签<code class="fe mm mn mo mp b">&lt;div class=”matrix-copy”&gt;</code>后的<code class="fe mm mn mo mp b">&lt;p&gt;</code>标签之间。</p><p id="04ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lb">邮件标签</em>:邮件在标签<code class="fe mm mn mo mp b">&lt;p&gt;</code>和<code class="fe mm mn mo mp b">&lt;em&gt;</code>之间。由于<code class="fe mm mn mo mp b">&lt;em&gt;</code>标签直接封装了电子邮件，这就是我们将在抓取代码中指出的标签。</p><p id="c2c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">太好了！现在我们已经找到了需要指示的标签，让我们为我们的第一位老师编写代码，以确定我们将如何遍历老师条目来获取所有数据！</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="6496" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们将我们的第一位老师定义为<code class="fe mm mn mo mp b">test_result</code>。</p><p id="ea8b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lb">教师姓名:</em>通过在<code class="fe mm mn mo mp b">&lt;h5&gt;</code>标签上使用<code class="fe mm mn mo mp b">find</code>方法，我们得到了带有我们教师姓名的代码行。但这并不能给我们没有标签的名字。我们不希望代码中有标签。因此，为了提取姓名文本，我们将把<code class="fe mm mn mo mp b">.text</code>添加到<code class="fe mm mn mo mp b">find</code>方法中，以获得标签的文本属性。</p><p id="2a62" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lb"> Position(s) </em>:我们将使用与名称相同的<code class="fe mm mn mo mp b">find</code>方法，但是这次我们的参数将是标签<code class="fe mm mn mo mp b">&lt;p&gt;</code>。这样做可以得到我们的位置，但同样我们不希望附加标签。再次使用<code class="fe mm mn mo mp b">.text</code>返回以下内容…..</p><pre class="mf mg mh mi gt nc mp nd ne aw nf bi"><span id="4505" class="ng ld it mp b gy nh ni l nj nk">'\n\tSpecial Education: Geometry, Particular Topics of Geometry'</span></pre><p id="0ae8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这给了我们比我们想要的更多。具体来说，我们在开始时得到了新行(<code class="fe mm mn mo mp b">\n</code>)和制表符(<code class="fe mm mn mo mp b">\t</code>)的字符串代码。由于我们的信息是在一个字符串中，我们可以用我们的代码行删除不需要的部分，从字符串的任何地方删除这些字符。</p><p id="e89b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">电子邮件:获取这些信息要简单得多。再次使用带有标签<code class="fe mm mn mo mp b">&lt;em&gt;</code>的<code class="fe mm mn mo mp b">find</code>方法作为我们的参数。使用<code class="fe mm mn mo mp b">.get_text()</code>方法有助于我们做到这一点，因为一些电子邮件嵌入在多个<code class="fe mm mn mo mp b">&lt;em&gt;</code>标签中。</p><h1 id="1ca8" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">现在我们得到了我们想要的所有数据！</h1><p id="ef5e" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">没错！所以我们开门见山吧。</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="e933" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，我们初始化一个数据框对象。然后，我们使用列表理解结合来自<code class="fe mm mn mo mp b">test_result</code>的代码来获取所有教师的姓名和职位。我们还利用这些列表理解来创建数据帧<code class="fe mm mn mo mp b">df</code>的前两列。</p><p id="99b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我第一次运行电子邮件收集的代码时，我遇到了一个属性错误。这就是变量管理器方便的地方。检查网页或 HTML 代码会发现“Veninga 女士”在<code class="fe mm mn mo mp b">&lt;em&gt; </code>标签中没有电子邮件地址。它位于第二组<code class="fe mm mn mo mp b">&lt;p&gt;</code>标签之间。因为页面很小，你可以这样做，但是对于较大的信息集合，你最好在列表理解产生错误的地方打印。</p><p id="9b0f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了解决这个问题，我们将尝试创建一个<code class="fe mm mn mo mp b">get_email</code>函数，除了用<code class="fe mm mn mo mp b">&lt;p&gt;</code>上的<code class="fe mm mn mo mp b">find_all</code>方法设置第二组<code class="fe mm mn mo mp b">&lt;p&gt;</code>标签内的所有电子邮件，然后使用索引来获得我们想要的<code class="fe mm mn mo mp b">&lt;p&gt;</code>标签。我们还将删除多余的文本，就像获取职位信息一样。</p><p id="ee37" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">与此同时，其他人的电子邮件将照常被删除。再次运行代码使我们能够成功地获得所有条目。可以通过检查记录列表的长度来证明这一点(它应该返回 66)。您可以使用<code class="fe mm mn mo mp b">df.shape[0]</code>来检查您的数据中的行数(66 个教师的 66 行)。</p><h1 id="38bc" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">真快！我们去分析这些数据吧！</h1><p id="d5d8" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">我们可以…但是我们会发现我们收集的数据有错误。您可以检查的一件事是，如果您有重复的条目，并删除它们。有些教师可能会教授多个科目(如数学和英语)，因此他们的名字会出现多次。</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="be25" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过对<code class="fe mm mn mo mp b">df.duplicated</code>的所有布尔值求和，我们得到值 11。所以我们有 11 个老师的名字出现了不止一次。然后，我们使用<code class="fe mm mn mo mp b">df.drop_duplicates</code>保留教师姓名的第一个条目，并丢弃其余条目。最后，我们将数据帧导出到一个 CSV 文件中，用于将来的分析。</p><h1 id="6639" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">最后的想法</h1><p id="6d46" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">网络抓取给你一种神奇的感觉，因为一旦你找到你需要的标签，你就可以从任何网站获取信息。我希望这个演练对那些考虑学习如何用 Python web scrap 的人有所帮助。</p><p id="8289" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当然，可以做一些特征工程来帮助分析。我不打算包括这些细节，因为我想把重点放在网页抓取方面。</p><p id="799f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选项包括:</p><p id="268d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1.创建一个性别列，方法是在该时期按标题拆分姓名，然后使用 pandas 将标题映射到适当的性别。</p><p id="abc8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.将职位分开(因为大多数教师似乎教授不止一种类型的班级)。</p><p id="937e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于熊猫练习，你可以尝试自己做上面的。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nl"><img src="../Images/ba94754382a80f3249bc14c895a97855.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uYK1yoZ3zHMDUfIq"/></div></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Photo by <a class="ae ko" href="https://unsplash.com/@h4x0r3?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Thao Le Hoang</a> on <a class="ae ko" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="99b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我们可以转向 Tableau 或<code class="fe mm mn mo mp b">matplotlib</code>进行可视化和统计，以回答与教师人数和其他特许公立布朗克斯学校相比，这些数据的问题。</p><p id="7855" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">直到下一次，</p><p id="f0e0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">约翰·德杰苏斯</p></div></div>    
</body>
</html>