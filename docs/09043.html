<html>
<head>
<title>How to secure your Azure Data Factory pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何保护你的 Azure 数据工厂管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-secure-your-azure-data-factory-pipeline-e2450502cd43?source=collection_archive---------13-----------------------#2019-12-02">https://towardsdatascience.com/how-to-secure-your-azure-data-factory-pipeline-e2450502cd43?source=collection_archive---------13-----------------------#2019-12-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="2390" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">1.介绍</h1><p id="1fbc" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Azure Data Factory (ADFv2)是一个流行的工具，用于协调从内部到云的数据接收。在每个 ADFv2 管道中，安全性都是一个重要的主题。常见的安全方面如下:</p><ul class=""><li id="9342" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated">Azure Active Directory (AAD)对数据和端点的访问控制</li><li id="f96b" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">管理身份(MI)以防止关键管理流程</li><li id="3b8a" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">数据和端点的虚拟网络(VNET)隔离</li></ul><p id="5eb2" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">在本博客的剩余部分，将讨论如何使用 AAD、MI、VNETs 和防火墙规则来保护 ADFv2 管道。关于 Azure 功能安全性的更多细节，请参见<a class="ae mc" href="https://medium.com/@rebremer/how-to-secure-your-azure-function-data-processing-c9947bf724fb" rel="noopener">我的另一篇博客</a>。关于如何使用快照和增量备份来防止数据湖中的数据丢失的解决方案，请看这个<a class="ae mc" rel="noopener" target="_blank" href="/how-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa">博客</a>。</p><p id="431a" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated"><strong class="kn ir"> <em class="md">更新 2020–07–26:现在可以在一个</em> </strong> <a class="ae mc" href="https://docs.microsoft.com/en-us/azure/data-factory/managed-virtual-network-private-endpoint" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> <em class="md">托管的 VNET </em> </strong> </a> <strong class="kn ir"> <em class="md">中运行 ADFv2 Azure 托管集成运行时。这是在公共预览，这个博客还没有更新这个功能。</em> </strong></p><h1 id="aa76" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">2.Azure 数据工厂管道的架构</h1><p id="f930" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这个<a class="ae mc" href="https://github.com/rebremer/adfv2_cdm_metadata" rel="noopener ugc nofollow" target="_blank"> ADFv2 管道</a>中，数据从 SQLDB 中读取，使用 Azure 函数进行转换，并写入 ADLS gen2 帐户。该项目的架构可以在下面找到。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/fc6900a52124bdb49a177afbe9d48076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zUaJHmP2G7zFLQVgZHORWw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">2. Azure Data Factory pipeline architecture</figcaption></figure><p id="dcc4" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">Azure 服务及其在本项目中的使用描述如下:</p><ul class=""><li id="92c0" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated"><strong class="kn ir"> SQLDB </strong>被用作包含将被复制的表格数据的源系统。</li><li id="244e" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated"><strong class="kn ir"> Azure 数据工厂</strong> <strong class="kn ir"> v2 </strong> (ADFv2)被用作将数据从源复制到目的地的编排器。ADFv2 使用一个<strong class="kn ir">自托管集成运行时</strong> (SHIR)作为计算，它运行在 VNET 中的虚拟机上</li><li id="2e9e" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated"><strong class="kn ir">Python<strong class="kn ir"/>中的 Azure 函数</strong>用于解析数据。函数无法访问其他 Azure 资源</li><li id="1e8f" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated"><strong class="kn ir"> Azure 数据湖存储 gen2 </strong> (ADLS gen2)用于存储来自 10 个 SQLDB 表的数据和由 Azure 函数创建的元数据文件</li><li id="3265" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated"><strong class="kn ir">Azure Active Directory</strong>(AAD)是微软的身份和访问管理服务，用于对 Azure 资源进行认证和授权</li></ul><p id="934a" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">以下安全方面是该项目的一部分。</p><ul class=""><li id="2f26" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated"><strong class="kn ir"> AAD 访问控制</strong> : SQLDB、ADLS gen 2、Azure 函数只允许 ADFv2 的 MI 访问数据。这意味着不需要在 ADFv2 或密钥库中存储任何密钥。</li><li id="9c26" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated"><strong class="kn ir">防火墙规则</strong> : SQLDB、ADLS gen 2、Azure Function 都有防火墙规则，只允许 SHIR 的 VNET 作为入站网络</li></ul><p id="3269" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">在下一章中，将实现 ADFv2 流水线架构。</p><h1 id="0e99" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">3.创建和部署 ADFv2 管道</h1><p id="f6e7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在本章中，将执行以下步骤来创建和部署 ADFv2 管道。</p><ul class=""><li id="fb8e" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated">3a。安装准备工作和资源</li><li id="13be" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">3b。在 ADFv2 中创建自托管集成运行时</li><li id="1647" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">3c。保护 ADLS 第二代帐户</li><li id="1a8a" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">3d。安全 SQLDB 数据库</li><li id="ce13" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">3e。部署和保护 Azure 功能</li><li id="877b" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">3f。配置并运行 ADFv2 管道</li></ul><h2 id="6daf" class="mu jo iq bd jp mv mw dn jt mx my dp jx kw mz na kb la nb nc kf le nd ne kj nf bi translated">3a。安装准备工作和资源</h2><p id="cdcb" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在本教程中，资源的部署将尽可能使用代码来完成。需要安装以下资源:</p><ul class=""><li id="599b" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated">安装<a class="ae mc" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="6ad3" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">安装<a class="ae mc" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-3.1.0" rel="noopener ugc nofollow" target="_blank"> Azure PowerShell </a></li><li id="b39c" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">安装<a class="ae mc" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio 代码</a></li><li id="c538" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">在 Visual Studio 代码中安装<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-python" rel="noopener ugc nofollow" target="_blank"> Azure 函数 Python </a>库</li></ul><p id="cb59" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">安装好预备程序后，就可以安装基础资源了。打开 Visual Studio 代码，创建一个新的终端会话并执行下面的命令。</p><pre class="mf mg mh mi gt ng nh ni nj aw nk bi"><span id="2b9e" class="mu jo iq nh b gy nl nm l nn no"># Login with your AzureAD credentials<br/>az login</span><span id="271d" class="mu jo iq nh b gy np nm l nn no"># set parameters<br/>$rg = "&lt;&lt;Resource group&gt;&gt;"<br/>$loc = "&lt;&lt;Location, e.g. westeurope&gt;&gt;"<br/>$adfv2 = "&lt;&lt;Adfv2 name&gt;&gt;"<br/>$sqlserv = "&lt;&lt;Logical sql server&gt;&gt;"<br/>$sqldb = "&lt;&lt;SQLDB name&gt;&gt;"<br/>$sqluser = "&lt;&lt;SQLDB username&gt;&gt;"<br/>$pass = "&lt;&lt;SQLDB password, <a class="ae mc" href="https://passwordsgenerator.net/" rel="noopener ugc nofollow" target="_blank">use https://passwordsgenerator.net/</a>&gt;&gt;"<br/>$adls = "&lt;&lt;adls gen 2 account, only alphanumeric&gt;&gt;"<br/>$funname = "&lt;&lt;Azure Function name&gt;&gt;"<br/>$funstor = "&lt;&lt;Azure Function storage&gt;&gt;"<br/>$funplan = "&lt;&lt;Azure Function plan&gt;&gt;"<br/>$vnet = "&lt;&lt;Azure VNET name&gt;&gt;"</span><span id="31cc" class="mu jo iq nh b gy np nm l nn no"># create resource group<br/>az group create -n $rg -l $loc</span><span id="9a90" class="mu jo iq nh b gy np nm l nn no"># create Azure Data Factory instance<br/>az resource create --resource-group $rg --name $adfv2 --resource-type "Microsoft.DataFactory/factories" -p {}</span><span id="694c" class="mu jo iq nh b gy np nm l nn no"># create logical SQL server and SQLDB<br/>az sql server create -l $loc -g $rg -n $sqlserv -u sqluser -p $pass<br/>az sql db create -g $rg -s $sqlserver -n $sqldb --service-objective Basic --sample-name AdventureWorksLT</span><span id="2794" class="mu jo iq nh b gy np nm l nn no"># create ADLS gen 2 account and container<br/>az storage account create -n $adls -g $rg -l $loc --sku Standard_LRS --kind StorageV2 --hierarchical-namespace true<br/>az storage container create --account-name $adls -n "sqldbdata"</span><span id="9343" class="mu jo iq nh b gy np nm l nn no"># create Azure Function<br/>az storage account create -n $funstor -g $rg --sku Standard_LRS<br/>az appservice plan create -n $funplan -g $rg --sku B1 --is-linux<br/>az functionapp create -g $rg --os-type Linux --plan $funplan --runtime python --name $funname --storage-account $funstor</span><span id="4008" class="mu jo iq nh b gy np nm l nn no"># create VNET<br/>az network vnet create -g $rg -n $vnet -l $loc --address-prefix 10.100.0.0/16 --subnet-name shir --subnet-prefix 10.100.0.0/24</span></pre><h2 id="5572" class="mu jo iq bd jp mv mw dn jt mx my dp jx kw mz na kb la nb nc kf le nd ne kj nf bi translated">3b。在 ADFv2 中创建自托管集成运行时</h2><p id="65be" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这一部分中，将配置 ADFv2 中的自托管集成运行时。这将使用之前创建的 VNET 中运行的虚拟机来完成。执行下面的 Azure CLI 脚本。</p><pre class="mf mg mh mi gt ng nh ni nj aw nk bi"><span id="4325" class="mu jo iq nh b gy nl nm l nn no"># use the same parameters in step 3a, plus additional params below:</span><span id="333f" class="mu jo iq nh b gy np nm l nn no">$shir_rg="&lt;&lt;rg name&gt;&gt;"<br/>$shir_name="&lt;&lt;shir name&gt;&gt;"<br/>$shir_vm="&lt;&lt;name of VMs on which SHIR runs&gt;&gt;"<br/>$shir_admin="&lt;&lt;name of VMs on which SHIR runs&gt;&gt;"<br/>$shir_pass="&lt;&lt;VM password, <a class="ae mc" href="https://passwordsgenerator.net/" rel="noopener ugc nofollow" target="_blank">use https://passwordsgenerator.net/</a>&gt;&gt;"</span><span id="2f78" class="mu jo iq nh b gy np nm l nn no">az group deployment create -g $shir_rg --template-uri <a class="ae mc" href="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-vms-with-selfhost-integration-runtime/azuredeploy.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-vms-with-selfhost-integration-runtime/azuredeploy.json</a> --parameters existingDataFactoryName=$adfv2 existingDataFactoryResourceGroup=$rg existingDataFactoryVersion=V2 IntegrationRuntimeName=$shir_name NodeCount=2 adminUserName=$shir_admin adminPassword=$shir_pass existingVirtualNetworkName=$vnet existingVnetLocation=$loc existingVnetResourceGroupName=$rg existingSubnetInYourVnet="shir"</span></pre><p id="3139" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">脚本可能需要 15 分钟才能完成。运行脚本后，您可以在 ADFv2 实例中验证它是否已成功部署，另请参见下文。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nq"><img src="../Images/0b8068bb8391782bc1e47cd08d9c529f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c4nrLf-5qdJs-FONvVCJwA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">3b1. Self-hosted Integration Runtime successfully deployed</figcaption></figure><h2 id="ea25" class="mu jo iq bd jp mv mw dn jt mx my dp jx kw mz na kb la nb nc kf le nd ne kj nf bi translated">3c。保护 ADLS 第二代帐户</h2><p id="e6a8" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这一部分中，ADLS gen2 帐户将受到保护。这是按如下方式完成的:</p><ul class=""><li id="5b44" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated">添加 RBAC 规则，即只有 ADFv2 的 MI 可以访问 ADLS gen 2</li><li id="7ee0" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">添加防火墙规则，只有 SHIR 的 VNET 可以访问 ADLS gen 2 容器</li></ul><p id="7449" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">在这种情况下，Azure PowerShell 用于使用相同的变量配置规则</p><pre class="mf mg mh mi gt ng nh ni nj aw nk bi"><span id="c2fc" class="mu jo iq nh b gy nl nm l nn no"># Get params, PowerShell is used here, can be done in VSC terminal<br/>Set-AzDataFactoryV2 -ResourceGroupName $rg -Name $adfv2 -Location $l<br/>$adfv2_id = Get-AzDataFactoryV2 -ResourceGroupName $rg -Name $adfv2<br/>$sub_id = (Get-AzContext).Subscription.id</span><span id="61e8" class="mu jo iq nh b gy np nm l nn no"># Give ADFv2 MI RBAC role to ADLS gen 2 account<br/>New-AzRoleAssignment -ObjectId $adfv2_id.Identity.PrincipalId -RoleDefinitionName "Reader" -Scope  "/subscriptions/$sub_id/resourceGroups/$rg/providers/Microsoft.Storage/storageAccounts/$adls/blobServices/default"</span><span id="bf51" class="mu jo iq nh b gy np nm l nn no">New-AzRoleAssignment -ObjectId <!-- -->$adfv2_id.Identity.PrincipalId <!-- -->-RoleDefinitionName "Storage Blob Data Contributor" -Scope  "/subscriptions/<!-- -->$sub_id<!-- -->/resourceGroups/$rg/providers/Microsoft.Storage/storageAccounts/$adls/blobServices/default/containers/<!-- -->sqldbdata<!-- -->"</span><span id="7928" class="mu jo iq nh b gy np nm l nn no"># Turn on firewall<br/>Update-AzStorageAccountNetworkRuleSet -ResourceGroupName $rg -Name $adls -DefaultAction Deny</span><span id="64d8" class="mu jo iq nh b gy np nm l nn no"># Set service endpoints for storage and SQL to subnet<br/>Get-AzVirtualNetwork -ResourceGroupName $rg -Name $vnet | Set-AzVirtualNetworkSubnetConfig -Name "shir" -AddressPrefix "<!-- -->10.100.0.0/24<!-- -->" -ServiceEndpoint "Microsoft.Storage", "Microsoft.SQL" | Set-AzVirtualNetwork</span><span id="7608" class="mu jo iq nh b gy np nm l nn no"># Add firewall rules<br/>$subnet = Get-AzVirtualNetwork -ResourceGroupName $rg -Name $vnet | Get-AzVirtualNetworkSubnetConfig -Name "shir"<br/>Add-AzStorageAccountNetworkRule -ResourceGroupName $rg -Name $adls -VirtualNetworkResourceId $subnet.Id</span></pre><p id="51fb" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">在最后一步之后，从 Azure 门户访问您的存储帐户将被拒绝(因为它不是 VNET 的一部分)。要允许从门户访问，您需要将您的 IP 地址列入白名单。</p><h2 id="af2c" class="mu jo iq bd jp mv mw dn jt mx my dp jx kw mz na kb la nb nc kf le nd ne kj nf bi translated">3d。安全 SQLDB 数据库</h2><p id="1ca9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这一部分中，SQLDB 将受到保护。这是按如下方式完成的:</p><ul class=""><li id="0680" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated">添加数据库规则，只有 ADFv2 的 MI 可以访问 SQLDB</li><li id="0b78" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">添加防火墙规则，只有 SHIR 的 VNET 可以访问 SQLDB</li></ul><p id="3364" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">Azure PowerShell 用于配置规则。</p><pre class="mf mg mh mi gt ng nh ni nj aw nk bi"><span id="756c" class="mu jo iq nh b gy nl nm l nn no"># Configure AAD access to logical SQL server<br/>Connect-AzureAD<br/>$aaduser = "&lt;&lt;your aad user email address&gt;&gt;"<br/>Set-AzSqlServerActiveDirectoryAdministrator -ResourceGroupName $rg -ServerName $sqlserver -DisplayName $aaduser</span><span id="4bc4" class="mu jo iq nh b gy np nm l nn no"># log in SQL with AAD (e.g. via portal query editor, SSMS or VSC)<br/># Execute following SQL statement<br/>CREATE USER [&lt;&lt;your Data Factory name&gt;&gt;] FROM EXTERNAL PROVIDER;<br/>EXEC sp_addrolemember [<!-- -->db_datareader<!-- -->], [&lt;&lt;your Data Factory name&gt;&gt;];</span><span id="b23d" class="mu jo iq nh b gy np nm l nn no"># <!-- -->Add firewall rules<br/>$subnet = Get-AzVirtualNetwork -ResourceGroupName $rg -Name $vnet | Get-AzVirtualNetworkSubnetConfig -Name "shir"<br/>New-AzSqlServerVirtualNetworkRule -ResourceGroupName $rg -ServerName $sqlserver -VirtualNetworkRuleName "shirvnet" -VirtualNetworkSubnetId $subnet.Id</span></pre><p id="3537" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">要从计算机进行访问以进行测试，您需要清空您的 IP 地址。</p><h2 id="ab11" class="mu jo iq bd jp mv mw dn jt mx my dp jx kw mz na kb la nb nc kf le nd ne kj nf bi translated">3e。部署和保护 Azure 功能</h2><p id="7ef2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这一部分，将部署 Azure 功能。这是按如下方式完成的:</p><ul class=""><li id="ebd9" class="lj lk iq kn b ko ll ks lm kw ln la lo le lp li lq lr ls lt bi translated">将源部署到功能</li><li id="3240" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">添加防火墙规则，只有 SHIR 的 VNET 可以访问 Azure 功能</li><li id="ec1e" class="lj lk iq kn b ko lu ks lv kw lw la lx le ly li lq lr ls lt bi translated">添加只有 ADFv2 的 MI 才能访问 Azure 功能的 App 注册</li></ul><p id="3795" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">第一步是使用这个<a class="ae mc" href="https://github.com/MicrosoftDocs/azure-docs/blob/master/articles/azure-functions/functions-create-first-function-python.md" rel="noopener ugc nofollow" target="_blank">快速入门</a>在 python 中创建一个 Azure 函数。随后，更新 requirement.txt，__init__。py 并从<a class="ae mc" href="https://github.com/rebremer/adfv2_cdm_metadata/tree/master/modeljson/modeljsonwrite" rel="noopener ugc nofollow" target="_blank">这个 git 库</a>添加 cdmschema.py。然后将您的函数发布到步骤 3a 中创建的$funname。要增强安全性，请使用以下 Azure CLI 脚本添加防火墙规则:</p><pre class="mf mg mh mi gt ng nh ni nj aw nk bi"><span id="b4d5" class="mu jo iq nh b gy nl nm l nn no">az webapp config access-restriction add -g $rg -n $funname --rule-name "shirvnet" --action Allow --vnet-name $vnet --subnet "shir" --priority 300</span></pre><p id="15cd" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">最后，对 Azure 函数的 AAD 访问可以通过向 Azure 函数添加一个 app 注册来配置，并且只允许 ADFv2 的 MI 访问 Azure 函数。参考这个<a class="ae mc" href="https://github.com/rebremer/managed_identity_authentication" rel="noopener ugc nofollow" target="_blank">教程</a>和这个<a class="ae mc" href="https://github.com/rebremer/managed_identity_authentication/blob/master/AAD_auth_ADFv2_MI_to_Azure_Function.ps1" rel="noopener ugc nofollow" target="_blank"> PowerShell 脚本</a>如何做到这一点。</p><h2 id="ee36" class="mu jo iq bd jp mv mw dn jt mx my dp jx kw mz na kb la nb nc kf le nd ne kj nf bi translated">3f。配置并运行 ADFv2 管道</h2><p id="b6d5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这一部分中，将配置和运行 ADFv2 管道。转到您的 Azure Data Factory 实例，选择设置一个代码存储库并导入下面的 GitHub 存储库<strong class="kn ir"> rebremer </strong>和项目<strong class="kn ir"> adfv2_cdm_metadata </strong>，见下文。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nr"><img src="../Images/92fe070de0b934da6cdb65a7bf96dbc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4Qp-Fr76yKAkLWLd.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">3f1. Setup code repository in ADFv2</figcaption></figure><p id="47c5" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">只有管道<strong class="kn ir"> BlogADFv2sec </strong>与这个博客相关。为 ADLS gen2、Azure Function 和 SQLDB 定制此管道的相关链接服务，另请参见下文。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ns"><img src="../Images/2ed4335392776064ce798c25e60e858d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FdyaQo4-pKQpzGNDpSTA4w.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">3f2. Customize linked services in pipeline BlogADFv2sec</figcaption></figure><p id="4f0c" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">查看此<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-monitoring#add-to-an-existing-function-app" rel="noopener ugc nofollow" target="_blank">链接</a>如何使用 Applications Insights 登录 Azure 功能。下面是一个日志记录的例子。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/c0562bb74668887aa9ed6d3df2f9b2cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I2lA8HYd-n8vaU-L.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">3f3. Logging ADFv2 pipeline</figcaption></figure><p id="4b8e" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated">最后一步，管道可以在 ADFv2 中运行。转到您的管道并单击 debug。当一切顺利时，所有的绿色检查将出现在输出中，如下所示。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nu"><img src="../Images/72349bb9d7f50dd6619ca01ee88a2472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocrynfJAMZka3n8nZ6prCg.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">3f4. Successful run of pipeline</figcaption></figure><h1 id="faf1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">4.结论</h1><p id="6947" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这篇博客中，创建了一个部署安全 ADFv2 管道的架构，其中数据从 SQLDB 读取，使用 Azure 函数转换，并写入 ADLS gen2 帐户。其中，AAD 访问控制、托管身份、虚拟网络和防火墙规则用于保护管道，另请参见下面的架构。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/fc6900a52124bdb49a177afbe9d48076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zUaJHmP2G7zFLQVgZHORWw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">4. Azure Data Factory pipeline architecture</figcaption></figure><p id="4771" class="pw-post-body-paragraph kl km iq kn b ko ll kq kr ks lm ku kv kw lz ky kz la ma lc ld le mb lg lh li ij bi translated"><strong class="kn ir"> <em class="md">注来自《走向数据科学》的编辑:</em> </strong> <em class="md">虽然我们允许独立作者根据我们的</em> <a class="ae mc" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="md">规则和指导方针</em> </a> <em class="md">发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae mc" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="md">读者术语</em> </a> <em class="md">。</em></p></div></div>    
</body>
</html>