<html>
<head>
<title>Weekend Hack: Building an Image Recognition bot for Telegram using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">周末黑客:使用 Python 为 Telegram 构建一个图像识别机器人</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/weekend-hack-building-an-image-recognition-bot-for-telegram-using-python-958646b4c4e5?source=collection_archive---------11-----------------------#2019-08-24">https://towardsdatascience.com/weekend-hack-building-an-image-recognition-bot-for-telegram-using-python-958646b4c4e5?source=collection_archive---------11-----------------------#2019-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a69d2ff6a862af3f305d5fd0bd497f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MFkY1xG5nOgfOHGpZN2_kQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Object recognition with our bot. Original image by <a class="ae kf" href="https://unsplash.com/@zacharytnelson?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Zachary Nelson</a> on <a class="ae kf" href="https://unsplash.com/search/photos/people?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5b2d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章的目标是用 Python 构建一个电报机器人，它使用<strong class="ki iu">神经网络</strong>执行<strong class="ki iu">图像识别</strong>。本文分为三个主要部分:简介、技术选择和分步设置。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="3002" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这篇文章是<strong class="ki iu">周末黑客</strong>系列的第四个实例，这是一系列关于探索新概念的简短开发故事。聚焦于<strong class="ki iu">边做边学</strong>，提供了分步说明。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="4f1b" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">介绍</h1><p id="9248" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated"><strong class="ki iu">自动图像识别</strong>(例如。对象识别和图像分类)可以为商业提供巨大的价值。如果你运行一个论坛、约会应用或任何用户上传内容的平台，自动识别图像可能是至关重要的。好处是双重的:</p><p id="9c6f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一方面，它<strong class="ki iu">为最终用户</strong>提供价值，允许他们通过分类主题对图像进行搜索，同时避免繁琐的手动分类任务。一个实际的例子是 Unsplash 搜索功能，<a class="ae kf" href="https://unsplash.com/search/photos/flower" rel="noopener ugc nofollow" target="_blank">通过主题</a>搜索高质量的图像。</p><p id="f26e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一方面，自动图像识别<strong class="ki iu">也为系统所有者提供价值，</strong>因为它允许<a class="ae kf" href="https://algorithmia.com/algorithms/sfw/NudityDetectioni2v" rel="noopener ugc nofollow" target="_blank">过滤掉包含裸体的图像</a>。简而言之，它允许以自动化的方式提高所提供服务的质量。好吧？</p><p id="cfc1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如我们所见，应用程序是无止境的，好处是显而易见的。主要问题仍然是，为这项任务选择哪种解决方案？存在大量第三方解决方案，以及从开源或专有软件构建自己的图像识别管道的可能性。在下一部分，<strong class="ki iu">我们将探索不同的选择</strong>。</p><h1 id="bcfc" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated">技术选择</h1><p id="f6f9" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">如上所述，有无数的供应商使用 API 提供图像和视频识别:<a class="ae kf" href="https://cloud.google.com/vision/" rel="noopener ugc nofollow" target="_blank">谷歌视觉</a>、<a class="ae kf" href="https://aws.amazon.com/rekognition/" rel="noopener ugc nofollow" target="_blank">亚马逊识别</a>、<a class="ae kf" href="https://www.clarifai.com/" rel="noopener ugc nofollow" target="_blank">澄清</a> …一个主要问题是，我的数据会安全吗？正如谷歌在其<a class="ae kf" href="https://cloud.google.com/vision/docs/data-usage" rel="noopener ugc nofollow" target="_blank">数据使用常见问题</a>中所说:</p><blockquote class="mt mu mv"><p id="4468" class="kg kh mw ki b kj kk kl km kn ko kp kq mx ks kt ku my kw kx ky mz la lb lc ld im bi translated">当您将图像发送到 Cloud Vision API 时，我们必须将该图像存储一小段时间，以便执行分析并将结果返回给您。<strong class="ki iu">存储的图像通常会在几小时内被删除</strong>。Google 还会临时记录一些关于您的 Vision API 请求的元数据(例如收到请求的时间和请求的大小)，以改善我们的服务并打击滥用行为。</p></blockquote><blockquote class="na"><p id="0e6d" class="nb nc it bd nd ne nf ng nh ni nj ld dk translated">“秘密删除”…秘密是什么意思？</p></blockquote><p id="b29b" class="pw-post-body-paragraph kg kh it ki b kj nk kl km kn nl kp kq kr nm kt ku kv nn kx ky kz no lb lc ld im bi translated">如果您担心数据所有权和隐私，也可以选择利用现有技术构建自己的图像识别管道。开源中也有一堆替代方案:<a class="ae kf" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>、<a class="ae kf" href="https://pjreddie.com/darknet/" rel="noopener ugc nofollow" target="_blank"> Darknet </a>、<a class="ae kf" href="http://mlpack.org/" rel="noopener ugc nofollow" target="_blank"> MLpack </a>、<a class="ae kf" href="https://keras.io/" rel="noopener ugc nofollow" target="_blank">Keras</a>……这些方案可以让你更好地控制图像数据所有权的归属。</p><p id="ca56" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本教程中，我们将<strong class="ki iu">专注于使用<a class="ae kf" href="https://pjreddie.com/darknet/" rel="noopener ugc nofollow" target="_blank"> Darnet </a>构建我们自己的图像分类器和对象识别机器人</strong>。我们将在<a class="ae kf" href="https://glitch.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> Glitch </strong> </a>中设置一个用 Python 编写的电报机器人来与图像分类器接口。</p><p id="cbd8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用户流程将如下:选择一张图片，并将其发送到我们的电报机器人。它会对其进行分类和物体识别，并将结果发送给我们。简单对吗？</p><figure class="np nq nr ns gt ju"><div class="bz fp l di"><div class="nt nu l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Easier said than done…</figcaption></figure><h1 id="6931" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated">逐步设置</h1><p id="1a2e" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">好吧，让我们开始吧！</p><h2 id="a2a6" class="nv lm it bd ln nw nx dn lr ny nz dp lv kr oa ob lz kv oc od md kz oe of mh og bi translated">1.设置 Python bot 的 bot 框架</h2><p id="10e7" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">为了不重复我自己，我将建议你按照下面帖子中给出的一步一步的说明来做。按照前两个步骤，根据自己的喜好修改应用程序名称。不要太关注机器人句柄，因为我们稍后会添加一个特定的句柄来处理收到的图片。</p><div class="oh oi gp gr oj ok"><a href="https://medium.com/@alainperkaz_51714/weekend-hack-building-an-unsplash-bot-for-telegram-with-python-5d63d2d9620d" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">周末黑客:用 Python 为 Telegram 构建一个 Unsplash bot</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">使用 Python 和 Glitch 构建您的第一个电报机器人，它提供来自 Unsplash 的高分辨率图像！</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy jz ok"/></div></div></a></div><h2 id="85fb" class="nv lm it bd ln nw nx dn lr ny nz dp lv kr oa ob lz kv oc od md kz oe of mh og bi translated">2.添加暗网</h2><p id="e40f" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">为了分析发送给机器人的图像，首先我们需要安装和构建 Darknet。<strong class="ki iu">所有的安装命令都可以在<a class="ae kf" href="https://glitch.com/~telegram-image-classfication-bot" rel="noopener ugc nofollow" target="_blank">故障项目</a>的<code class="fe oz pa pb pc b">install.sh</code>文件</strong>中找到。</p><p id="8ea5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要输入命令，在我们的 Glitch 项目中选择<strong class="ki iu">工具&gt;全页控制台</strong>。</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pd"><img src="../Images/7e9c5c4fc4eb9059657267014f212e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hebf9nZVV_8s0TikpDGyQA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Select the Full Page Console to install Darknet</figcaption></figure><p id="3aae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要安装 Darknet，请导航至<strong class="ki iu">。Glitch 应用程序中的数据</strong>目录。这是至关重要的，因为当你的 Glitch 应用程序进入睡眠状态时，这个目录将被保留！</p><pre class="np nq nr ns gt pe pc pf pg aw ph bi"><span id="9fe0" class="nv lm it pc b gy pi pj l pk pl">cd .data<br/>git clone <a class="ae kf" href="https://github.com/pjreddie/darknet.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pjreddie/darknet.git</a><br/>cd darknet<br/>make</span></pre><p id="5f9d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">值得一提的是，虽然你可以训练你自己的模型(并且应该，<a class="ae kf" href="https://www.youtube.com/watch?v=X813AkGuPDE" rel="noopener ugc nofollow" target="_blank">取决于用例</a>，但是这通常是一个计算量非常大的操作。考虑到我们将在<strong class="ki iu">故障</strong>实例中运行我们的机器人，而<strong class="ki iu">的能量和空间</strong>非常有限(1 个 CPU、512 个 RAM、200 MB 存储空间)，训练模型是非常不可行的。</p><p id="d9ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于我们的情况，使用预先训练的模型权重是最好的解决方案。我们将使用以前训练中产生的现有重量，使我们能够快速达到速度。我们将下载两个权重文件，<strong class="ki iu"> darknet19.weights </strong>用于图像分类，而<strong class="ki iu"> yolov3-tiny.weights </strong>用于对象识别。</p><pre class="np nq nr ns gt pe pc pf pg aw ph bi"><span id="1f3b" class="nv lm it pc b gy pi pj l pk pl"># execute in the ./darkent directory<br/>wget <a class="ae kf" href="https://pjreddie.com/media/files/darknet19.weights" rel="noopener ugc nofollow" target="_blank">https://pjreddie.com/media/files/darknet19.weights</a><br/>wget <a class="ae kf" href="https://pjreddie.com/media/files/yolov3-tiny.weights" rel="noopener ugc nofollow" target="_blank">https://pjreddie.com/media/files/yolov3-tiny.weights</a></span></pre><p id="eec8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，由于目前 Glitch 中可用的空间和 CPU 能力的限制，我们选择了相当小的权重文件。如果您在另一个更强大的环境中运行，请随意尝试其他权重(<a class="ae kf" href="https://pjreddie.com/darknet/imagenet/" rel="noopener ugc nofollow" target="_blank">图像分类</a>、<a class="ae kf" href="https://pjreddie.com/darknet/yolo/" rel="noopener ugc nofollow" target="_blank">对象检测</a>)。你也会得到更好的结果！</p><h2 id="296c" class="nv lm it bd ln nw nx dn lr ny nz dp lv kr oa ob lz kv oc od md kz oe of mh og bi translated">3.装上电线</h2><p id="d994" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">太好了，现在我们已经准备好了我们的机器人框架，并且安装了暗网，我们可以把它连接起来了。我不会解释每一行代码，完整的注释代码可以查看<a class="ae kf" href="https://glitch.com/~telegram-image-classfication-bot" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">故障项目</strong> </a>。</p><p id="ab1c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是<strong class="ki iu">主处理程序</strong>的代码摘录(注意它使用了助手函数)。每当有新图片发送到机器人时，它就会被触发。</p><pre class="np nq nr ns gt pe pc pf pg aw ph bi"><span id="f6a9" class="nv lm it pc b gy pi pj l pk pl"><a class="ae kf" href="http://twitter.com/bot" rel="noopener ugc nofollow" target="_blank">@bot</a>.message_handler(content_types=['photo'])<br/>def handle(message):</span><span id="8f0d" class="nv lm it pc b gy pm pj l pk pl">  # extract the image name for further operations<br/>  image_name = save_image_from_message(message)<br/>  <br/>  # execute object recognition<br/>  object_recognition_image(image_name)</span><span id="21c4" class="nv lm it pc b gy pm pj l pk pl">  # send object recognition results<br/>  bot.send_photo(message.chat.id, open('.data/darknet/predictions.jpg','rb'), 'Identified objects')<br/>  <br/>  # execute image classification<br/>  classification_list_result = classify_image(image_name)<br/>  <br/>  # send classification results<br/>  output = 'The image classifies as:\n'<br/>  for result in classification_list_result:<br/>    output += result<br/>  output += '\n🚀 Gimme more pics! 🚀'<br/>    <br/>  bot.reply_to(message, output)<br/>  <br/>  # remove picture from server<br/>  cleanup_remove_image(image_name);</span></pre><p id="e1a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完整的源代码可从以下网址获得:</p><div class="oh oi gp gr oj ok"><a href="https://glitch.com/~telegram-image-classfication-bot" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">电报图像分类机器人</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">电报图像分类机器人🎏Glitch 是一个友好的社区，每个人都可以在这里发现和创建最好的应用程序…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">glitch.com</p></div></div></div></a></div><h2 id="2070" class="nv lm it bd ln nw nx dn lr ny nz dp lv kr oa ob lz kv oc od md kz oe of mh og bi translated">4.测试机器人</h2><p id="87e4" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">完美，现在我们准备好了，让我们做一些测试！</p><p id="4c9a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们 bot 的电报<strong class="ki iu"> ID </strong>是:<strong class="ki iu"><em class="mw">@ wh _ image _ classicator _ bot，</em> </strong>随便测试一下。分类和识别能力受到现有技术限制的限制，但结果令人鼓舞。</p><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pn"><img src="../Images/bcdc3f6d495f0b35caf8de46fe53fa9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0R4eKbqZb9VA_Vf66qQ8kA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Classification and object recognition on dog picture</figcaption></figure><figure class="np nq nr ns gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi pn"><img src="../Images/ca210ca6e2173fb5b566a3296dc1edf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*44_MGUoVd9W3zQzV8oGS2A.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Classification and object recognition on 4x4 picture</figcaption></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h2 id="54dd" class="nv lm it bd ln nw nx dn lr ny nz dp lv kr oa ob lz kv oc od md kz oe of mh og bi translated">摘要</h2><p id="9034" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">按需图像识别 API 提供了无与伦比的功能，但当隐私或离线处理至关重要时，自定义图像识别管道是一个很好的替代方案。</p><p id="a74b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，我们的示例只是触及了表面，使用其他训练集和方法可以实现更准确的图像识别。</p><h2 id="1561" class="nv lm it bd ln nw nx dn lr ny nz dp lv kr oa ob lz kv oc od md kz oe of mh og bi translated">资源</h2><ul class=""><li id="2f52" class="po pp it ki b kj mj kn mk kr pq kv pr kz ps ld pt pu pv pw bi translated">故障项目→<a class="ae kf" href="https://glitch.com/~telegram-image-classfication-bot" rel="noopener ugc nofollow" target="_blank">https://glitch.com/~telegram-image-classfication-bot</a></li><li id="c6fa" class="po pp it ki b kj px kn py kr pz kv qa kz qb ld pt pu pv pw bi translated">暗网文件→【https://pjreddie.com/darknet T2】/</li></ul></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="abf0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其他<strong class="ki iu">周末黑</strong>帖子:</p><div class="oh oi gp gr oj ok"><a href="https://medium.com/@alainperkaz_51714/weekend-hack-building-an-unsplash-bot-for-telegram-with-python-5d63d2d9620d" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd iu gy z fp op fr fs oq fu fw is bi translated">周末黑客:用 Python 为 Telegram 构建一个 Unsplash bot</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">使用 Python 和 Glitch 构建您的第一个电报机器人，它提供来自 Unsplash 的高分辨率图像！</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy jz ok"/></div></div></a></div></div></div>    
</body>
</html>