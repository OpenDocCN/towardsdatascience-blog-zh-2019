<html>
<head>
<title>Anomaly Detection with LSTM in Keras</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">喀拉斯 LSTM 异常探测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/anomaly-detection-with-lstm-in-keras-8d8d7e50ab1b?source=collection_archive---------2-----------------------#2019-06-15">https://towardsdatascience.com/anomaly-detection-with-lstm-in-keras-8d8d7e50ab1b?source=collection_archive---------2-----------------------#2019-06-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="df34" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用置信区间预测异常</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5957e6acf79e5099b54b8b72aff49861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aSbFf-yUc8NQ4cbI"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@scott_umstattd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Scott Umstattd</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1d90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在任何地方的各种竞赛中都读到过“异常”的定义。在这个混沌中，唯一的真理就是这个定义的可变性，即<strong class="lb iu">异常解释完全与兴趣域</strong>相关。</p><p id="6be3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对这种行为的检测在每个行业中都是有用的，检测这些观察的难度取决于应用领域。如果您正在处理一个涉及人类活动的异常检测问题(如销售或需求预测)，您可以利用人类行为的基本假设，规划一个更有效的解决方案。</p><p id="f546" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这正是我们在这篇文章中所做的。我们试图预测纽约市在一个关键时期的出租车需求。我们制定了关于人类行为的简单而重要的假设，这将允许我们发现预测异常的简单解决方案。所有的脏活都是由喀拉斯开发的忠诚 LSTM 完成的，它可以同时预测和检测异常情况！</p><h1 id="fe80" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据集</h1><p id="a316" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我从<a class="ae ky" href="https://numenta.org/" rel="noopener ugc nofollow" target="_blank"> Numenta </a>社区获取了用于我们分析的数据集。特别是，我选择了纽约出租车数据集。该数据集显示了纽约市从 2014 年 7 月 1 日到 2015 年 1 月 31 日的出租车需求，每半小时观察一次。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/3f2a48266383d09a482e67450c6fdba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*GbLjszXPApY1XVMbxLr1wg.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Example of Weekly NORMAL observations</figcaption></figure><p id="6154" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在此期间，就偏离正常行为而言，存在 5 种异常。它们分别发生在纽约马拉松、感恩节、圣诞节、新年和暴风雪期间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/4c2898732a9285ea2fcddd3eaafe4d8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gQG62TbsRCztSMfe_E8aNg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Example of Weekly ABNORMAL observations: NYC marathon — Christmas</figcaption></figure><p id="63b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">我们的目的是提前探测到这些异常的观测结果！</strong></p><p id="92a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从数据来看，我们注意到的第一个考虑因素是存在一个明显的每日模式(白天的需求高于夜间)。出租车需求似乎也受到每周趋势的驱动:在一周中的某些日子，出租车需求高于其他日子。我们简单地证明这个计算自相关。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="fccb" class="mz lw it mv b gy na nb l nc nd">timeLags = np.arange(1,10*48*7)<br/>autoCorr = [df.value.autocorr(lag=dt) for dt in timeLags]</span><span id="8ce2" class="mz lw it mv b gy ne nb l nc nd">plt.figure(figsize=(19,8))<br/>plt.plot(1.0/(48*7)*timeLags, autoCorr)<br/>plt.xlabel('time lag [weeks]')<br/>plt.ylabel('correlation coeff', fontsize=12)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/03ed74e215ff7f91b36311a225c80e60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HT6nhiJ9wlahrd_TQzpPVw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">AutoCorrelation 10 weeks depth</figcaption></figure><p id="e33c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在能做的是记下这些重要的行为，以便我们进一步分析。我每小时计算并存储一周中每一天的平均值。当我们将数据标准化以构建我们的模型时，这将是有用的，以便减少各种时间依赖性(<em class="ng">我计算将成为我们未来训练集</em>的前 5000 个观察值的平均值)。</p><h1 id="3336" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">模型</h1><p id="c1eb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们需要一种策略来提前检测异常值。为此，我们决定关注出租车需求预测。我们希望开发一种模型，能够在考虑不确定性的情况下预测需求。一种方法是发展分位数回归。我们关注极值的预测:下限(第 10 个分位数)，上限(第 90 个分位数)和经典的第 50 个分位数。计算第 90 个和第 10 个分位数，我们涵盖了现实中最有可能出现的值。这个范围的宽度可以很深；我们知道，当我们的模型对未来有把握时，它是小的，当我们的模型不能看到感兴趣领域的重要变化时，它可能是大的。我们利用了这种行为，并让我们的模型说明了出租车需求预测领域中的异常值检测。当我们的模型对未来有把握时，我们期望得到一个很小的区间(90-10 分位数范围),因为一切都在控制之中；另一方面，当间隔变大时，我们期望得到一个异常。这是可能的，因为我们的模型没有被训练来处理这种可能导致异常的场景。</p><p id="8762" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在 Keras 建立了一个简单的 LSTM 神经网络，让这一切成为现实。我们的模型将接收过去的观察结果作为输入。我们用每日窗口大小(48 次观察:每半小时一次观察)来调整数据大小，以便为 LSTM 提供数据。当我们生成数据时，正如我上面提到的，我们操作对数转换和标准化减去平均每日小时值，以便将观察值视为其每日平均小时值的对数变化。我们以同样的方式构建目标变量，每半小时转换一次(我们希望预测接下来三十分钟的需求值)。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="da96" class="mz lw it mv b gy na nb l nc nd">inputs = Input(shape=(X_train.shape[1], X_train.shape[2]))<br/>lstm = Bidirectional(LSTM(64, return_sequences=True, dropout=0.5))(inputs, training = True)<br/>lstm = Bidirectional(LSTM(16, return_sequences=False, dropout=0.5))(lstm, training = True)<br/>dense = Dense(50)(lstm)<br/>out10 = Dense(1)(dense)<br/>out50 = Dense(1)(dense)<br/>out90 = Dense(1)(dense)</span><span id="b2a3" class="mz lw it mv b gy ne nb l nc nd">model = Model(inputs, [out10,out50,out90])</span></pre><p id="333d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 Keras 中操作分位数回归非常简单(我从<a class="ae ky" rel="noopener" target="_blank" href="/deep-quantile-regression-c85481548b5a">这篇文章</a>中获得了灵感)。我们很容易定义自定义分位数损失函数，该函数基于分位数以及误差是正的(实际&gt;预测的)还是负的(实际&lt;预测的)来惩罚误差。我们的网络有 3 个输出和 3 个损失，分别对应于我们试图预测的每个分位数。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="c3a4" class="mz lw it mv b gy na nb l nc nd">def q_loss(q,y,f):<br/>    e = (y-f)<br/>    return K.mean(K.maximum(q*e, (q-1)*e), axis=-1)</span><span id="1af0" class="mz lw it mv b gy ne nb l nc nd">losses = [lambda y,f: q_loss(0.1,y,f), lambda y,f: q_loss(0.5,y,f), lambda y,f: q_loss(0.9,y,f)]</span><span id="0bd8" class="mz lw it mv b gy ne nb l nc nd">model.compile(loss=losses, optimizer='adam', loss_weights = [0.3,0.3,0.3])</span></pre><h1 id="8da4" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">交叉问题</h1><p id="8d93" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在处理 Keras 中的神经网络时，一个繁琐的问题是由于内部权值初始化导致的结果的不确定性。用它的提法，我们的问题似乎特别遭受这种问题；即计算分位数预测我们不能允许分位数重叠，这没有意义！为了避免这个陷阱，我在预测阶段使用自举:我重新激活我的网络的丢失(模型中的<em class="ng">trainible:true</em>)，迭代预测 100 次，存储它们并最终计算期望的分位数(我在<a class="ae ky" rel="noopener" target="_blank" href="/extreme-event-forecasting-with-lstm-autoencoders-297492485037">这篇文章</a>中也使用了这个聪明的技术)。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="1fad" class="mz lw it mv b gy na nb l nc nd">pred_10, pred_50, pred_90 = [], [], []<br/>NN = K.function([model.layers[0].input, K.learning_phase()], <br/>                [model.layers[-3].output,<br/>                 model.layers[-2].output,<br/>                 model.layers[-1].output])</span><span id="fd0c" class="mz lw it mv b gy ne nb l nc nd">for i in tqdm.tqdm(range(0,100)):<br/>    predd = NN([X_test, 0.5])<br/>    pred_10.append(predd[0])<br/>    pred_50.append(predd[1])<br/>    pred_90.append(predd[2])</span></pre><p id="cd9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个过程在下面用图表解释，重点放在预测的子集上。给定分位数引导，我们计算它们的汇总测量(红线)，避免交叉。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/09c7a0e1fdca064d554d6043cdc1d0ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*F_cAocQMSs-GXpdmSughVg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">q90 prediction bootstraps (cyan); q50 prediction bootstraps (blue); q10 prediction bootstraps (green)</figcaption></figure><h1 id="fc21" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结果</h1><p id="d5b1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">正如我前面提到的，我使用前 5000 个观察值进行训练，剩下的(大约 5000 个)用于测试。</p><p id="7651" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的模型用第 50 个分位数达到了很好的预测出租车需求的性能。大约 0.055 的均方对数误差是一个辉煌的结果！这意味着 LSTM 网络能够理解驱动出租车需求的潜在规则。因此，我们的异常检测方法听起来很棒…我们计算了第 90 个分位数预测和第 10 个分位数预测之间的差异，看看发生了什么。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/1afa838797d94a3784f4619ee41c76b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*diU0dN7bBs00fYRRvYYyKQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Real (red line); Quantile interval length (blue dots)</figcaption></figure><p id="72b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">分位数区间范围(蓝点)在不确定时期较高。在其他情况下，正如我们所预期的那样，该模型往往能够很好地概括。更深入地说，我们开始调查这些高度不确定的时期。我们注意到这些与我们最初的假设相吻合。下面标绘的橙色圆圈分别是:纽约马拉松、感恩节、圣诞节、元旦和暴风雪。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/1f227f5a822d5ec1d8edb0d9f3d25a52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1sKV3bIooSiqCOSvZ_woZA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Anomaly Detection</figcaption></figure><p id="4853" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以得出结论，我们达到了我们最初的目标:实现了强大的预测能力，并利用我们的模型的优势来识别不确定性。我们还利用这一点来说一些关于异常检测。</p><h1 id="fcdc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">摘要</h1><p id="53fc" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这篇文章中，我复制了一个异常检测和预测的好方法。我们利用 LSTM 网络来了解纽约市的出租车需求行为。我们利用学到的知识进行预测，同时估计不确定性。我们隐含地将异常定义为不可预测的观察结果——即具有很大的不确定性。这个简单的假设允许我们的 LSTM 为我们做所有的工作。</p></div><div class="ab cl nj nk hx nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="im in io ip iq"><p id="449f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/cerlymarco/MEDIUM_NoteBook" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">查看我的 GITHUB 回购</strong> </a></p><p id="7e0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保持联系:<a class="ae ky" href="https://www.linkedin.com/in/marco-cerliani-b0bba714b/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a></p></div></div>    
</body>
</html>