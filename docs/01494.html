<html>
<head>
<title>Using ANOVA for Hypothesis Testing: A Core Data Science Skill</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用方差分析进行假设检验:一项核心数据科学技能</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hypothesis-testing-in-the-northwind-dataset-using-anova-db3ab16b5eba?source=collection_archive---------14-----------------------#2019-03-09">https://towardsdatascience.com/hypothesis-testing-in-the-northwind-dataset-using-anova-db3ab16b5eba?source=collection_archive---------14-----------------------#2019-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7f33" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用假设检验确定最有利可图的客户的例子</h2></div><h1 id="d463" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">项目目标</h1><p id="1847" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">作为 Northwind 数据库项目的一部分，我需要对数据提出一些问题，以便为公司获得有价值的商业见解。Northwind 数据库是 Microsoft 为一家名为 Northwind Traders 的虚构公司提供的示例数据库，该公司从世界各地进口和出口消费品。该数据库包含公司活动的一系列信息，包括客户、客户订单、产品及其供应商。我感兴趣的是更好地了解他们的客户，并找出哪些客户群体对 Northwind 的利润贡献最大。所以我决定问的一个问题是:</p><blockquote class="lw"><p id="9221" class="lx ly it bd lz ma mb mc md me mf lv dk translated">不同地区的客户每份订单的平均收入是否不同？</p></blockquote><h1 id="e10f" class="ki kj it bd kk kl km kn ko kp kq kr ks jz mg ka ku kc mh kd kw kf mi kg ky kz bi translated">陈述假设</h1><p id="c568" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">为了回答这个问题，我首先创建了一个无效替代假设:</p><p id="8007" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">零假设:每个订单的平均花费金额在不同的客户区域之间是相同的</p><p id="ac76" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">另一个假设:在不同的客户区域，每个订单的平均消费金额是不同的(或高或低)</p><p id="f5ed" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">阿尔法水平(即，当假设为真时拒绝零假设的概率)设置为 0.05。</p><h1 id="2406" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">获取和清理数据</h1><p id="961b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">第一步是使用这个(只有轻微的标签错误)模式提取正确的数据:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mo"><img src="../Images/2b0c0cd1b98e809fc7f7251e71ba18d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I3bp6yGM27SyMZYv3kqIwA.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Northwind database schema</figcaption></figure><p id="12e4" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">为了回答正在调查的问题，我需要提取客户区域、订购的每种产品的总量、单价以及每份订单的折扣级别。为此，我使用 Order 表连接了 Customer 和 OrderDetail 表:</p><pre class="mp mq mr ms gt ne nf ng nh aw ni bi"><span id="38f6" class="nj kj it nf b gy nk nl l nm nn"># Importing the required libraries<br/>from sqlalchemy import create_engine<br/>from sqlalchemy.orm import Session, sessionmaker<br/>import pandas as pd<br/>import seaborn as sns<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import statsmodels.api as sm<br/>from statsmodels.formula.api import ols</span><span id="949e" class="nj kj it nf b gy no nl l nm nn"># Creating an engine and connecting to a database with SQLAlchemy<br/>engine = create_engine('sqlite:///Northwind_small.sqlite', echo=True)<br/>Session = sessionmaker(bind=engine)<br/>session = Session()<br/>con = engine.connect()</span><span id="2236" class="nj kj it nf b gy no nl l nm nn"># Extracting the data required as a pandas dataframe using a SQL query<br/>df3 = pd.read_sql_query('''<br/> SELECT c.Region, od.OrderId, od.Quantity, od.UnitPrice, od.Discount<br/> FROM Customer c<br/> JOIN [Order] o ON c.Id = o.CustomerId<br/> JOIN OrderDetail od ON od.OrderId = o.Id<br/> ''', engine)</span></pre><p id="f58b" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">产生的数据框架现在显示了每个订单中每个产品的订单 ID、数量、单价和折扣:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi np"><img src="../Images/12d7b20d064a9354cd050ba58ac65e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*46oJllklaSsY7s99LX0H8g.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">The first five rows of the dataset</figcaption></figure><p id="4718" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">但我真正想要的是每份订单的总收入。这是使用下面单元格中的代码计算的，该代码将折扣应用于单价和单位数量的乘积，然后对每个订单求和，并删除不再需要的列:</p><pre class="mp mq mr ms gt ne nf ng nh aw ni bi"><span id="3097" class="nj kj it nf b gy nk nl l nm nn"># Calculating the revenue per sub-order<br/>df3['price_per_order'] = df3.Quantity * df3.UnitPrice * (1 - df3.Discount)</span><span id="fdb7" class="nj kj it nf b gy no nl l nm nn"># Dropping the columns for quantity, unit price and discount now that we have the total revenue<br/>df3.drop(['Quantity', 'UnitPrice', 'Discount'], axis=1, inplace=True)</span><span id="a333" class="nj kj it nf b gy no nl l nm nn"># Grouping the data by order and summing the revenue for each order<br/>df3 = df3.groupby(['Region', 'OrderId'])['price_per_order'].sum().reset_index()</span><span id="afb7" class="nj kj it nf b gy no nl l nm nn"># Dropping the OrderId as we no longer need this<br/>df3.drop('OrderId', axis=1, inplace=True)</span></pre><p id="b242" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">这给我留下了一个只包含我需要的数据的数据框架:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/09e7d5ca2a9904d62a2d34691ea0b128.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/1*64PYMuE9Kh7GlDbS3K4nlA.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">The first five rows of the new dataset</figcaption></figure><p id="6f28" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">但是，对每个地区的订单数量进行快速统计后发现，一些地区的客户仅下了少量订单:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/9aeba0a14904e02e0f29170368ff4c06.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*FSC4DZwHdTln59lLWIj-ZA.png"/></div></figure><p id="5a03" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">因为方差分析将用于检验假设，所以最好确保相对相等的样本量，特别是满足方差相等的假设。因此，较小的群体与其他具有地理意义的群体结合在一起，并采用了 30 人的最小群体规模。</p><pre class="mp mq mr ms gt ne nf ng nh aw ni bi"><span id="f453" class="nj kj it nf b gy nk nl l nm nn"># Combining Eastern and Southern Europe<br/>df3.loc[(df3.Region == 'Eastern Europe') | (df3.Region == 'Southern Europe'),'Region'] = 'Southern and Eastern Europe'</span><span id="8120" class="nj kj it nf b gy no nl l nm nn"># Combining Scandinavia and Northern Europe<br/>df3.loc[(df3.Region == 'Scandinavia') | (df3.Region == 'Northern Europe'),'Region'] = 'Northern Europe and Scandinavia'</span><span id="9e67" class="nj kj it nf b gy no nl l nm nn"># Combining Central and South America<br/>df3.loc[(df3.Region == 'Central America') | (df3.Region == 'South America'),'Region'] = 'South and Central America'</span></pre><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/cac04ea66641f2f818dfa36a89750ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*UkCUbMFwVj6DF8i9n3nejA.png"/></div></figure><h1 id="eab1" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">探索数据</h1><p id="9061" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">既然数据已经有了正确的格式和分组，就可以开始研究它了。以下代码块生成了下图，该图绘制了每个地区的订单数、每份订单的总收入和每份订单的平均收入:</p><pre class="mp mq mr ms gt ne nf ng nh aw ni bi"><span id="cd74" class="nj kj it nf b gy nk nl l nm nn"># Plotting the number of orders, total revenue per order and average revenue per order for each region<br/>fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(8,8))<br/>df3.groupby(['Region'])['Region'].count().plot(kind='barh', ax=ax1)<br/>df3.groupby(['Region'])['price_per_order'].sum().plot(kind='barh', ax=ax2)<br/>df3.groupby(['Region'])['price_per_order'].mean().plot(kind='barh', ax=ax3)<br/>ax1.set_title('Total number of orders')<br/>ax1.set_ylabel('')<br/>ax2.set_title('Total revenue ($)')<br/>ax2.set_ylabel('')<br/>ax3.set_title('Average revenue per order ($)')<br/>ax3.set_ylabel('')<br/>fig.subplots_adjust(hspace=0.4);</span></pre><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nt"><img src="../Images/273b37c3d0db11d8ed14aea712624a3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GZWgYcsvcXb4fMrICsUEaQ.png"/></div></div></figure><p id="dfa8" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">图表显示，西欧是订单数量最多的地区，总收入也最高。然而，北美的平均订单最贵(其次是西欧)。南欧和东欧的订单数量最少，总收入最低，平均订单最便宜。第三张图支持了另一个假设，即各地区之间的平均订单收入存在显著差异。这通过使用统计假设检验被进一步研究。</p><h1 id="5691" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">假设检验和结果</h1><p id="a527" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">为了回答来自不同地区的顾客每份订单的平均花费是否不同的问题，使用了 ANOVA。这评估了多个样本之间的变化程度，在这种情况下，每个样本是不同的区域。</p><p id="cdb9" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">方差分析假设数据是正态分布的，样本具有相似的方差。分布图是使用 seaborn 绘制的，这表明数据非常严重地正偏，具有长尾。对数据进行对数变换会产生具有更相似分布的更正态分布的数据。对数转换数据的分布(如下所示)由以下代码生成:</p><pre class="mp mq mr ms gt ne nf ng nh aw ni bi"><span id="5517" class="nj kj it nf b gy nk nl l nm nn"># Copying the dataset and log-transforming price_per_order<br/>df3_log = df3.copy()<br/>df3_log['price_per_order'] = np.log(df3['price_per_order'])</span><span id="f7ad" class="nj kj it nf b gy no nl l nm nn"># Plotting the distributions for the log-transformed data<br/>plt.figure(figsize=(8,5))<br/>for region in set(df3_log.Region):<br/>    region_group = df3_log.loc[df3_log['Region'] == region]<br/>    sns.distplot(region_group['price_per_order'], hist_kws=dict(alpha=0.2), label=region)<br/>    plt.legend()<br/>    plt.xlabel('Revenue per order (log-transformed)')</span></pre><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/75eedddbe6cd80fc2cd6f21c03414ab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*Y3A3zy7ZU4i5WMu1TKr1ow.png"/></div></figure><p id="c924" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">数据现在更加正态分布，均值的方差也更加相似。现在可以进行方差分析测试了:</p><pre class="mp mq mr ms gt ne nf ng nh aw ni bi"><span id="1eb3" class="nj kj it nf b gy nk nl l nm nn"># Fitting a model of price_per_order on Region categories, and using statsmodels to compute an ANOVA table<br/>lm = ols('price_per_order ~ C(Region)', df3_log).fit()<br/>sm.stats.anova_lm(lm, typ=2)</span></pre><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/b3cbdec97847ed72bd4f1b160a066e6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/1*DpaeXquDjMTiUSO-VwUufw.png"/></div></figure><p id="01c9" class="pw-post-body-paragraph la lb it lc b ld mj ju lf lg mk jx li lj ml ll lm ln mm lp lq lr mn lt lu lv im bi translated">上面的 ANOVA 表显示 p 值低于 alpha 值 0.05。因此，我能够拒绝零假设，接受替代假设。不同地区之间的平均订单价值存在统计上的显著差异，即平均而言，来自世界不同地区的客户在订单上花费的金额不同。</p><h1 id="a2f4" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><h2 id="5e2f" class="nj kj it bd kk nw nx dn ko ny nz dp ks lj oa ob ku ln oc od kw lr oe of ky og bi translated">商业洞察:</h2><ul class=""><li id="b52b" class="oh oi it lc b ld le lg lh lj oj ln ok lr ol lv om on oo op bi translated">不同地区客户的平均每单收入存在显著的统计差异。</li><li id="1e21" class="oh oi it lc b ld oq lg or lj os ln ot lr ou lv om on oo op bi translated">西欧客户下的订单最多，是 Northwind 盈利的最大贡献者。然而，尽管北美客户的订单数量大约是西欧客户的一半，但他们平均每份订单的花费更多。</li><li id="37b5" class="oh oi it lc b ld oq lg or lj os ln ot lr ou lv om on oo op bi translated">订单平均最贵的地区(北美，1，945.93 美元)和订单最便宜的地区(南欧和东欧，686.73 美元)之间的差额为 1，259.20 美元，是北美订单的 2.8 倍。</li><li id="77fa" class="oh oi it lc b ld oq lg or lj os ln ot lr ou lv om on oo op bi translated">南欧和东欧的订单数量最少，总收入最低，每笔订单的平均收入也最低。</li><li id="cdf0" class="oh oi it lc b ld oq lg or lj os ln ot lr ou lv om on oo op bi translated">北美客户的订单数量与南美和中美客户相似，但他们每份订单的平均支出是南美和中美客户的 1.8 倍。</li></ul><h2 id="fdb4" class="nj kj it bd kk nw nx dn ko ny nz dp ks lj oa ob ku ln oc od kw lr oe of ky og bi translated"><strong class="ak">未来工作的潜在业务行动和方向:</strong></h2><ul class=""><li id="22f8" class="oh oi it lc b ld le lg lh lj oj ln ok lr ol lv om on oo op bi translated">如果 Northwind 希望专注于利润更高的客户，一个潜在的行动将是停止为南欧和东欧的客户提供服务，而更多地关注西欧和北美的客户。</li><li id="4b65" class="oh oi it lc b ld oq lg or lj os ln ot lr ou lv om on oo op bi translated">然而，还需要进一步的分析来证实这些发现。例如，一些更贵的产品可能只在某些地区有售。</li></ul></div></div>    
</body>
</html>