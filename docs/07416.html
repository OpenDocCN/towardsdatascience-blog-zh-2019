<html>
<head>
<title>How to use SQL to perform data analysis (House Property Sales Time Series)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 SQL 进行数据分析(房产销售时间序列)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-sql-to-perform-data-analysis-house-property-sales-time-series-bf36cd3c2528?source=collection_archive---------13-----------------------#2019-10-17">https://towardsdatascience.com/how-to-use-sql-to-perform-data-analysis-house-property-sales-time-series-bf36cd3c2528?source=collection_archive---------13-----------------------#2019-10-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="d18b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">欢迎阅读我的新文章。如果你想在求职过程中脱颖而出，数据分析永远是一项必要的技能。也许你知道怎么用 Python 或者 R 甚至 SAS/Matlab 来执行。但是了解 SQL 通常是您应该拥有的一项必要而重要的技能。许多公司仍然大量使用 SQL 进行数据提取和分析。简单但能够处理足够多的数据帮助 SQL 在多年后仍然很重要(我编写 SQL 已经超过七年了)。</p><p id="18b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我在这里演示一个使用 SQL 的数据分析。我做 SQL 用的平台是 MySQL Workbench。您可以从以下链接免费下载:</p><div class="ko kp gp gr kq kr"><a href="https://dev.mysql.com/downloads/workbench/" rel="noopener  ugc nofollow" target="_blank"><div class="ks ab fo"><div class="kt ab ku cl cj kv"><h2 class="bd iu gy z fp kw fr fs kx fu fw is bi translated">MySQL::下载 MySQL 工作台</h2><div class="ky l"><h3 class="bd b gy z fp kw fr fs kx fu fw dk translated">MySQL Workbench 为数据库管理员和开发人员提供了一个集成的工具环境，用于:数据库设计和建模</h3></div><div class="kz l"><p class="bd b dl z fp kw fr fs kx fu fw dk translated">dev.mysql.com</p></div></div><div class="la l"><div class="lb l lc ld le la lf lg kr"/></div></div></a></div><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/a37598541413961ec3ee98a0c833870b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*83n0mK5IKLhCStqvh4-6hQ.png"/></div></div></figure><p id="6fe8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而这个分析的数据集是来自 Kaggle 的“房产销售时间序列”。</p><div class="ko kp gp gr kq kr"><a href="https://www.kaggle.com/deltacrot/property-sales" rel="noopener  ugc nofollow" target="_blank"><div class="ks ab fo"><div class="kt ab ku cl cj kv"><h2 class="bd iu gy z fp kw fr fs kx fu fw is bi translated">房产销售时间序列</h2><div class="ky l"><h3 class="bd b gy z fp kw fr fs kx fu fw dk translated">下载数千个项目的开放数据集+在一个平台上共享项目。探索热门话题，如政府…</h3></div><div class="kz l"><p class="bd b dl z fp kw fr fs kx fu fw dk translated">www.kaggle.com</p></div></div></div></a></div><p id="3e3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关于如何使用 MySQL Workbench 超出了本文的范围。您可以从文档中获得更多信息。有一点要提的是，我是用 MySQL 编码 SQL 的。如果您使用 Oracle 或其他软件编码，可能会有一些不同。如果遇到错误，不必惊慌。只要变回你的语言应该有的样子。</p><div class="ko kp gp gr kq kr"><a href="https://dev.mysql.com/doc/workbench/en/" rel="noopener  ugc nofollow" target="_blank"><div class="ks ab fo"><div class="kt ab ku cl cj kv"><h2 class="bd iu gy z fp kw fr fs kx fu fw is bi translated">MySQL 工作台</h2><div class="ky l"><h3 class="bd b gy z fp kw fr fs kx fu fw dk translated">这是 MySQL 工作台参考手册。它记录了 MySQL Workbench 社区和 MySQL Workbench…</h3></div><div class="kz l"><p class="bd b dl z fp kw fr fs kx fu fw dk translated">dev.mysql.com</p></div></div></div></a></div><p id="6552" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该模式称为“数据集”，数据存储为一个名为“raw_sales”的表</p><p id="48e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一步总是打印数据集中的一些记录。</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="522a" class="lx ly it lt b gy lz ma l mb mc">SELECT * FROM dataset.raw_sales<br/>LIMIT 10</span></pre><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi md"><img src="../Images/f53c5ccaab84f89d83198e6a1cb1138e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*-VXL6i7Dvka20xlNLmvIxg.png"/></div></figure><p id="8d0b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，数据集中有五列，日期出售、邮政编码、价格、财产类型和卧室。</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="7d79" class="lx ly it lt b gy lz ma l mb mc">select min(datesold) as min_datesold, max(datesold) as max_datesold <br/>from dataset.raw_sales;</span><span id="1014" class="lx ly it lt b gy me ma l mb mc">select count(1) from dataset.raw_sales;</span></pre><p id="9a79" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该数据集涵盖了从 2007 年 2 月 7 日到 2019 年 7 月 27 日的 29580 条记录。</p><p id="74ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么哪个日期的销售最频繁呢？</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="8ff8" class="lx ly it lt b gy lz ma l mb mc">select datesold, count(1) as sales_count, sum(price) as price_sum<br/>from dataset.raw_sales<br/>group by datesold<br/>order by sales_count desc <br/>limit 10;</span></pre><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/a9c9603c10030f6321ce0cc4fc212f05.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*xW_oEq5KpV0JzX_JqdTNCA.png"/></div></figure><p id="aa93" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以一天的最大销售量是 50 件，总价是 4200 万英镑。</p><p id="7f4a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">哪个邮政编码的平均销售价格最高？</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="7bfc" class="lx ly it lt b gy lz ma l mb mc">select postcode,avg(price) as price_avg , count(1) as sales_count<br/>from dataset.raw_sales<br/>group by postcode<br/>order by price_avg desc<br/>limit 10;</span></pre><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi mg"><img src="../Images/4d369dab53963a63731b820bfcad99ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*at6xIVFWhaSB7o1r5bKDAg.png"/></div></div></figure><p id="6f64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">邮编 2618 的共 9 笔销售，均价 1.08M</p><p id="dbc2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而哪一年的销量最低？</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="ff6a" class="lx ly it lt b gy lz ma l mb mc">select year(datesold) as year , count(1) as sales_count, sum(price) as price_sum <br/>from dataset.raw_sales<br/>group by year <br/>order by sales_count<br/>limit 10;</span></pre><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/573ef89ad5bb2d52d4e68bfdb5731f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:578/format:webp/1*30QIgBEpJYen1KAUjM4keQ.png"/></div></figure><p id="9ed4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有没有可能知道每年价格排名前五的邮编？当然可以，但是要知道什么是窗函数。</p><p id="9c3c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一开始我不知道什么是窗口函数。但是后来我在面试中被一次又一次地问到。所以我查了一下，意识到我应该早点知道这个(至少帮我面试回答问题)。</p><p id="7028" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">基本上，window 函数可以基于分区执行聚合，并将结果返回给一行。如果您想了解更多关于窗口函数的语法和用法，我建议您阅读 Oracle 的文档，如下所示:</p><div class="ko kp gp gr kq kr"><a href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html" rel="noopener  ugc nofollow" target="_blank"><div class="ks ab fo"><div class="kt ab ku cl cj kv"><h2 class="bd iu gy z fp kw fr fs kx fu fw is bi translated">MySQL :: MySQL 8.0 参考手册::12.21.1 窗口函数描述</h2><div class="ky l"><h3 class="bd b gy z fp kw fr fs kx fu fw dk translated">在以下函数描述中，over_clause 表示 over 子句，如第 12.21.2 节“窗口…”所述</h3></div><div class="kz l"><p class="bd b dl z fp kw fr fs kx fu fw dk translated">dev.mysql.com</p></div></div></div></a></div><p id="8d48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以我首先按年份和邮编合计价格</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="f726" class="lx ly it lt b gy lz ma l mb mc">select year(datesold) as year ,postcode, sum(price) as price_sum <br/>from dataset.raw_sales<br/>group by year, postcode</span></pre><p id="a092" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后我使用窗口函数得到每年总价的排名。</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="4226" class="lx ly it lt b gy lz ma l mb mc">select year,postcode, price_sum, row_number() over (partition by year order by price_sum desc) as ranking<br/>from (<br/>select year(datesold) as year ,postcode, sum(price) as price_sum <br/>from dataset.raw_sales<br/>group by year, postcode<br/>)  a</span></pre><p id="1cb2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，选择所有排名小于或等于 5 的记录</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="e9bc" class="lx ly it lt b gy lz ma l mb mc">select * from<br/>(<br/>select year,postcode, price_sum, row_number() over (partition by year order by price_sum desc) as ranking<br/>from (<br/>select year(datesold) as year ,postcode, sum(price) as price_sum <br/>from dataset.raw_sales<br/>group by year, postcode<br/>)  a<br/>) b<br/>where ranking &lt;=5 <br/>order by year,ranking</span></pre><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/7972ad0f794ace12641447fab4e1128f.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*6Ab435YESze6fu6kf2Mj4w.png"/></div></figure><p id="ffcb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我将继续讨论 propertyType。有两种类型，房子和单位。</p><p id="222f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么每年有多少房子和单元的销售呢？</p><p id="b434" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最简单的方法是分组，然后数有多少条记录。但在这里，我通过使用 case when 提出了另一种方法。函数是根据标准进行聚合的另一个有用函数的情况。在这里，当我计算记录的数量时，我没有使用 count 函数，而是使用 sum 函数和 case when 函数。</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="8535" class="lx ly it lt b gy lz ma l mb mc">select year(datesold) as year, <br/>sum(case when propertyType = "house" then 1 else 0 end) as house_sales_count,<br/>sum(case when propertyType = "unit" then 1 else 0 end) as unit_sales_count <br/>from dataset.raw_sales<br/>group by year;</span></pre><p id="59f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，对于 house_sales_count，如果 propertyType 等于 house，则返回 1。否则，它返回 0。然后对所有记录求和。这将显示 propertyType 等于 house 的销售数量。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/917e09a3b3b01f805371ce7a57123e42.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*qYzHUR-8cSR4EJQLwpPFRQ.png"/></div></figure><p id="ccd8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一个优点是结果看起来像 Excel 数据透视表。可以直接做个对比。</p><p id="627d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以清楚地看到，每年的房屋销售量都比单位销售量多。那么后续的问题一定是关于房子和单位的平均差价。当然我们也可以用 case 当函数。但有一点需要谨慎的是，else 部分。</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="f75f" class="lx ly it lt b gy lz ma l mb mc">select year(datesold) as year,<br/>avg(case when propertyType = "house" then price else null end) as house_price_avg,<br/>avg(case when propertyType = "unit" then price else null end) as unit_price_avg<br/>from dataset.raw_sales<br/>group by year;</span></pre><p id="24ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有必要返回一个空值，而不是返回 0，这样在计算平均值时就不会包括该特定记录。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/47066b87544a04448e1084e2cffffa6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*HVTYM5vxHvWvCveWDiekZA.png"/></div></figure><p id="1ec0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">再说一次，房子的平均价格比单位价格更高。</p><p id="3430" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">进一步考虑卧室数量怎么样？</p><pre class="li lj lk ll gt ls lt lu lv aw lw bi"><span id="3e3b" class="lx ly it lt b gy lz ma l mb mc">select year(datesold) as year,<br/>avg(case when propertyType = "house" then price/bedrooms else null end) as house_price_bedroom_avg,<br/>avg(case when propertyType = "unit" then price/bedrooms else null end) as unit_price_bedroom_avg<br/>from dataset.raw_sales<br/>group by year;</span></pre><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/6a77d337003b5b8b32098b0c28c9892d.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/1*iAiZSUNJcL0wEXi-2V37hQ.png"/></div></figure><p id="117b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这次的情况有所不同。就卧室数量而言，该单元的平均价格高于房子。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><p id="8277" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个分析到此结束。我会说 SQL 已经削弱了它在数据分析中的重要性，尤其是许多公司仍然只将 SQL 用于数据挖掘和分析。知道如何掌握 SQL 绝对有助于你获得一个分析职位。希望你看完我的文章能有所收获。请随意给出你的评论或者下次你想让我介绍什么。希望你喜欢，下次再见。</p></div></div>    
</body>
</html>