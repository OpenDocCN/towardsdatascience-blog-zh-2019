<html>
<head>
<title>How to do that animated ‘race’ bar chart</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何制作动画“比赛”条形图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-that-animated-race-bar-chart-57f3a8ff27a8?source=collection_archive---------3-----------------------#2019-04-26">https://towardsdatascience.com/how-to-do-that-animated-race-bar-chart-57f3a8ff27a8?source=collection_archive---------3-----------------------#2019-04-26</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="e26a" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">探索英国足球有史以来最好的球队，并学习如何制作其中一个已经变得流行的比赛条形图</h2></div><p id="9c27" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在本文中，我们将分析英国足球队自 1888 年联赛开始以来的历史表现，并使用该数据创建一个动画条形图，每年循环显示历史上前十名球队的总积分。我们还将使用标题栏来讲述这项运动在英格兰 130 年间的变化。这是成品，所有代码都在<a class="ae lg" href="https://github.com/keithmcnulty/english_football_league" rel="noopener ugc nofollow" target="_blank"> Github </a>上:</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/86692f46cae4cd1724ce2787904a590b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*0jHsGmYGm-FrhJGRzv8PEA.gif"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk">The abbreviated history of English football</figcaption></figure><p id="c21d" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">开始之前，让我们明确我们的目标。这是我们想要做的:</p><ol class=""><li id="cad4" class="lx ly iv km b kn ko kq kr kt lz kx ma lb mb lf mc md me mf bi translated">生成一个动画，循环播放从 1888 年到 2017 年的每个足球赛季，并显示截至该年每支球队的累计总积分，显示排名前 10 的球队。我们将只考虑在英格兰足球顶级联赛(现在被称为<em class="mg">英超</em>)中获得的积分。</li><li id="497c" class="lx ly iv km b kn mh kq mi kt mj kx mk lb ml lf mc md me mf bi translated">偶尔在图表标题中加入仿真陈述，有助于讲述足球随时间的变化。</li></ol><p id="1765" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在这篇文章中，我不打算把重点放在样式和美观上，只讨论创建动画图形的基本功能。</p><h2 id="b23f" class="mm mn iv bd mo mp mq dn mr ms mt dp mu kt mv mw mx kx my mz na lb nb nc nd ne bi translated">准备数据</h2><p id="a9ef" class="pw-post-body-paragraph kk kl iv km b kn nf jw kp kq ng jz ks kt nh kv kw kx ni kz la lb nj ld le lf io bi translated">理想情况下，我们需要的是一个数据集，它能告诉我们通过历史获得的联赛积分，但我找不到那个数据集。相反，我发现了更详细、更棒的东西，这是自 1888 年以来每一场比赛的记录，以及结果和分数。我在这里<a class="ae lg" href="https://github.com/jalapic/engsoccerdata/blob/master/data/england.rda" rel="noopener ugc nofollow" target="_blank">发现它是以 R dataframe 对象的形式存在的——所以我们将在 R 中这样做。这是数据的快速快照。</a></p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi nk"><img src="../Images/1eb9de347fdbe4201a203d17ca53de43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pyUdrixU5L_ZXhUikIBB3A.png"/></div></div></figure><p id="ddd9" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">这个数据集相当大，自 1888 年以来，每一级都有近 200，000 场比赛。首先，我们需要将每场比赛转换为给定球队的积分分配。主队和客队之间的积分分配如下:</p><ul class=""><li id="8786" class="lx ly iv km b kn ko kq kr kt lz kx ma lb mb lf nl md me mf bi translated">1981 赛季前冠军得 2 分。从 1981 年赛季开始，为了鼓励更多的进攻，比赛规则发生了变化，获胜者可以获得 3 分。</li><li id="cc33" class="lx ly iv km b kn mh kq mi kt mj kx mk lb ml lf nl md me mf bi translated">败队得 0 分。</li><li id="e70b" class="lx ly iv km b kn mh kq mi kt mj kx mk lb ml lf nl md me mf bi translated">如果比赛以平局结束，每人得 1 分。</li></ul><p id="64a0" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">因此，让我们加载我们的数据，并加载我们的<code class="fe nm nn no np b">tidyverse</code>包进行标准的数据操作。我们将使用<code class="fe nm nn no np b">result</code>列分配主场和客场积分，通过使用<code class="fe nm nn no np b">dplyr::mutate()</code>创建两个新列，如下所示:</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="da72" class="mm mn iv np b gy nu nv l nw nx">library(tidyverse)</span><span id="85e9" class="mm mn iv np b gy ny nv l nw nx">load("data/england.rda")</span><span id="a02d" class="mm mn iv np b gy ny nv l nw nx"># assign points to results (2 pts for a win up to 1980-81 season then 3 pts for a win afterwards)</span><span id="c10b" class="mm mn iv np b gy ny nv l nw nx">england &lt;- england %&gt;% <br/>  dplyr::mutate(<br/>    homepts = dplyr::case_when(<br/>      Season &lt;= 1980 &amp; result == "H" ~ 2,<br/>      Season &gt; 1980 &amp; result == "H" ~ 3,<br/>      result == "D" ~ 1,<br/>      result == "A" ~ 0<br/>    ),<br/>    awaypts = dplyr::case_when(<br/>      Season &lt;= 1980 &amp; result == "A" ~ 2,<br/>      Season &gt; 1980 &amp; result == "A" ~ 3,<br/>      result == "D" ~ 1,<br/>      result == "H" ~ 0<br/>    )<br/>  )</span></pre><p id="701c" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在我们已经为每场比赛分配了积分，我们需要得到每支球队和每个赛季的主场和客场总积分，记住我们只对顶级比赛感兴趣:</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="27f3" class="mm mn iv np b gy nu nv l nw nx"># restrict to Tier 1 and assemble into total points per season</span><span id="9867" class="mm mn iv np b gy ny nv l nw nx">home_pts &lt;- england %&gt;%<br/>  dplyr::filter(tier == 1) %&gt;% <br/>  dplyr::group_by(Season, home) %&gt;% <br/>  dplyr::summarize(pts = sum(homepts))</span><span id="3923" class="mm mn iv np b gy ny nv l nw nx">away_pts &lt;- england %&gt;%<br/>  dplyr::filter(tier == 1) %&gt;% <br/>  dplyr::group_by(Season, visitor) %&gt;% <br/>  dplyr::summarize(pts = sum(awaypts))</span></pre><p id="7373" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在，我们可以将这两个数据框架绑定在一起，将主客场积分相加，得出每个赛季每个球队的总积分:</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="4239" class="mm mn iv np b gy nu nv l nw nx">total_pts &lt;- home_pts %&gt;% <br/>  dplyr::rename(Team = home) %&gt;% <br/>  dplyr::bind_rows(<br/>    away_pts %&gt;% <br/>      dplyr::rename(Team = visitor)<br/>  ) %&gt;% <br/>  dplyr::group_by(Season, Team) %&gt;% <br/>  dplyr::summarise(pts = sum(pts))</span></pre><p id="42f2" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在我们有了一个数据框架，显示了每支球队在每个赛季获得的积分。我们想操纵这一点，以便每个赛季显示我们所有积分的总和，包括该赛季。我们可以通过一个快速的<code class="fe nm nn no np b">for</code>循环来实现这一点:</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="a987" class="mm mn iv np b gy nu nv l nw nx"># create rolling sums</span><span id="7c96" class="mm mn iv np b gy ny nv l nw nx">table &lt;- total_pts %&gt;% <br/>  dplyr::filter(Season == 1888) %&gt;% <br/>  dplyr::select(Season, Team, Points = pts)</span><span id="4531" class="mm mn iv np b gy ny nv l nw nx">for (i in 1889:2017) {<br/>  table &lt;- total_pts %&gt;% <br/>    dplyr::filter(Season &lt;= i) %&gt;% <br/>    dplyr::group_by(Team) %&gt;% <br/>    dplyr::summarise(Points = sum(pts, na.rm = TRUE)) %&gt;% <br/>    dplyr::mutate(Season = i) %&gt;% <br/>    dplyr::bind_rows(table)<br/>}</span></pre><p id="599c" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">我们已经做了足够的工作来获得目标 1 所需的数据。对于目标 2，我将编辑<code class="fe nm nn no np b">Season</code>栏，加入一些关于英格兰足球联赛的重要史实。我会让每个事实显示大约三季，让它在动画中出现足够长的时间，让观众阅读。让我们称这个新编辑的专栏为<code class="fe nm nn no np b">SeasonLabel</code>。</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="7e53" class="mm mn iv np b gy nu nv l nw nx"># add some historic facts to seasons</span><span id="9e31" class="mm mn iv np b gy ny nv l nw nx">table &lt;- table %&gt;% <br/>  dplyr::mutate(<br/>    SeasonLabel = dplyr::case_when(<br/>      Season &lt;= 1891 ~ paste(Season, "Football League is formed with 12 teams in 1888", sep = " - "),<br/>      dplyr::between(Season, 1892, 1895) ~ paste(Season, "Second Division introduced in 1892", sep = " - "),<br/>      dplyr::between(Season, 1914, 1918) ~ paste(Season, "League suspended during World War I", sep = " - "),<br/>      dplyr::between(Season, 1920, 1924) ~ paste(Season, "Third Division North/South introduced in 1920/21", sep = " - "),<br/>      dplyr::between(Season, 1925, 1928) ~ paste(Season, "New Offside Law introduced in 1925", sep = " - "),<br/>      dplyr::between(Season, 1939, 1945) ~ paste(Season, "League suspended during World War II", sep = " - "),<br/>      dplyr::between(Season, 1958, 1961) ~ paste(Season, "Regional Third Divisions amalgamated in 1958 to form Nationwide Third and Fourth Divisions", sep = " - "),<br/>      dplyr::between(Season, 1965, 1968) ~ paste(Season, "Substitutes first allowed in 1965", sep = " - "),<br/>      dplyr::between(Season, 1974, 1977) ~ paste(Season, "First match played on a Sunday in 1974", sep = " - "),<br/>      dplyr::between(Season, 1981, 1984) ~ paste(Season, "Three points for a win introduced in 1981", sep = " - "),<br/>      dplyr::between(Season, 1986, 1989) ~ paste(Season, "Play-offs introduced to decide some promotions", sep = " - "),<br/>      dplyr::between(Season, 1992, 1995) ~ paste(Season, "Premier League formed in 1992, reducing Football League to three divisions", sep = " - "),<br/>      dplyr::between(Season, 2004, 2007) ~ paste(Season, "Football League renames divisions in 2004 to Championship, League One and League Two", sep = " - "),<br/>      dplyr::between(Season, 2013, 2016) ~ paste(Season, "Goal Line Technology introduced in Premier League in 2013", sep = " - "),<br/>      1L == 1L ~ as.character(Season)<br/>    )<br/>  )</span></pre><p id="f60d" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在让我们来看看我们的数据:</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi nz"><img src="../Images/5c7dc4601cf0701ac5e6c8896381d0e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*97k2Jv5Has9_nyDSlFkg1w.png"/></div></div></figure><p id="db7b" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在我们有了编码动画所需的一切。让我们使用<code class="fe nm nn no np b">save(table, 'data/table.RData')</code>保存我们的数据集，这样我们就可以在一个新文件中打开它，我们将使用它来创建动画。</p><h2 id="08c6" class="mm mn iv bd mo mp mq dn mr ms mt dp mu kt mv mw mx kx my mz na lb nb nc nd ne bi translated">创建动画</h2><p id="042d" class="pw-post-body-paragraph kk kl iv km b kn nf jw kp kq ng jz ks kt nh kv kw kx ni kz la lb nj ld le lf io bi translated">在<a class="ae lg" href="https://stackoverflow.com/questions/53162821/animated-sorted-bar-chart-with-bars-overtaking-each-other/53163549" rel="noopener ugc nofollow" target="_blank">这个 StackOverflow 讨论</a>的帮助下，我们将使用<code class="fe nm nn no np b">ggplot2</code>包为这些数据设计一个静态条形图，然后我们将使用 awesome 包<code class="fe nm nn no np b">gganimate</code>生成一个滚动动画，该动画通过每个<code class="fe nm nn no np b">SeasonLabel</code>进行过渡并更新条形图。</p><p id="715b" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">让我们加载数据和一些我们需要的包。然后，首先，我们需要对每个赛季的每个球队进行排名，因为排名将决定柱线在“比赛”图中出现的顺序。我们还为每个团队创建了一个相对于排名靠前的团队的相对值，因为这将有助于衡量标准。最后，我们创建一个标签来从<code class="fe nm nn no np b">Points</code>列中提取值。然后我们限制排名前 10 的队伍。</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="5f71" class="mm mn iv np b gy nu nv l nw nx">library(tidyverse)<br/>library(ggplot2)<br/>library(gganimate)<br/>library(gifski)<br/>ggplot2::theme_set(theme_classic())</span><span id="0734" class="mm mn iv np b gy ny nv l nw nx">load("data/table.Rdata")</span><span id="7dd8" class="mm mn iv np b gy ny nv l nw nx"># generate top n ranking by year group</span><span id="1a14" class="mm mn iv np b gy ny nv l nw nx">anim_table &lt;- table %&gt;%<br/>  dplyr::group_by(Season) %&gt;%<br/>  dplyr::mutate(<br/>    rank = min_rank(-Points) * 1,<br/>    Value_rel = Points / Points[rank == 1],<br/>    Value_lbl = paste0(" ", Points)<br/>  ) %&gt;%<br/>  dplyr::filter(rank &lt;= 10) %&gt;%<br/>  dplyr::ungroup()</span></pre><p id="38a4" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在我们已经拥有了绘制静态条形图所需的一切——这只需要一串相当基本的<code class="fe nm nn no np b">ggplot2</code>命令。我不会详细讨论这些，但是如果你需要重新熟悉这些，我推荐你从 tidyverse.org 开始。这里的要点是，我们使用<code class="fe nm nn no np b">rank</code>作为 x 美学，<code class="fe nm nn no np b">Points</code>作为 y 美学，然后我们分配<code class="fe nm nn no np b">Team</code>和<code class="fe nm nn no np b">Points</code>，然后我们翻转图表，使其水平而不是垂直。</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="a12b" class="mm mn iv np b gy nu nv l nw nx"># create static bar chart</span><span id="5a71" class="mm mn iv np b gy ny nv l nw nx">p &lt;- ggplot2::ggplot(anim_table, aes(rank)) +<br/>  ggplot2::geom_tile(aes(<br/>    y = Points / 2,<br/>    height = Points,<br/>    width = 0.9,<br/>    fill = "blue"<br/>  ), alpha = 0.8, color = NA) +<br/>  ggplot2::geom_text(aes(y = 0, label = paste(Team, " ")), size = 12, vjust = 0.2, hjust = 1) +<br/>  ggplot2::geom_text(aes(y = Points, label = Value_lbl, hjust = 0)) +<br/>  ggplot2::coord_flip(clip = "off", expand = FALSE) +<br/>  ggplot2::scale_y_continuous(labels = scales::comma) +<br/>  ggplot2::scale_x_reverse() +<br/>  ggplot2::guides(color = FALSE, fill = FALSE)</span></pre><p id="b07b" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">现在是动画的主要部分。我们给静态图的标题和轴加了标签，但其中一个标签是我们将用来给图加动画的标签——即<code class="fe nm nn no np b">SeasonLabel.</code>这被称为<em class="mg">过渡变量</em>。所以我们告诉<code class="fe nm nn no np b">ggplot2</code>我们希望标题打印当前的过渡状态——即<code class="fe nm nn no np b">SeasonLabel</code>在动画中旋转时作为标题。最后，我们使用<code class="fe nm nn no np b">ease_aes()</code>来定义值在转换过程中的变化方式——这里有许多您可以尝试的缓和函数，详情请参考帮助文件。</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="a052" class="mm mn iv np b gy nu nv l nw nx"># set SeasonLabel as transition state and set to animate</span><span id="9326" class="mm mn iv np b gy ny nv l nw nx">p &lt;- ggplot2::labs(p,<br/>    title = "{closest_state}", x = "", y = "Total Points",<br/>    caption = "Source:  Github(jalapic/engsoccerdata) | Top tier points only, does not include mandatory points deductions | Plot generated by <a class="ae lg" href="http://twitter.com/dr_keithmcnulty" rel="noopener ugc nofollow" target="_blank">@dr_keithmcnulty</a>"<br/>  ) +<br/>  ggplot2::theme(<br/>    plot.title = element_text(color = "darkblue", face = "bold", hjust = 0, size = 30),<br/>    axis.ticks.y = element_blank(),<br/>    axis.text.y = element_blank(),<br/>    plot.margin = margin(2, 2, 1, 16, "cm")<br/>  ) +<br/>  gganimate::transition_states(SeasonLabel, transition_length = 4, state_length = 1) +<br/>  gganimate::ease_aes("cubic-in-out")</span></pre><p id="e999" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">所以我们的动画情节现在作为对象<code class="fe nm nn no np b">p</code>保存在环境中。我们现在需要做的就是把它作为一个输出文件。有许多设备可用于以各种格式呈现输出，但最常用的有:</p><ul class=""><li id="7e7e" class="lx ly iv km b kn ko kq kr kt lz kx ma lb mb lf nl md me mf bi translated"><code class="fe nm nn no np b">gif</code>输出——产生一个动画图像文件。这需要安装<code class="fe nm nn no np b">gifski</code>包。</li><li id="f0f6" class="lx ly iv km b kn mh kq mi kt mj kx mk lb ml lf nl md me mf bi translated"><code class="fe nm nn no np b">mp4</code>视频输出——这需要在您的机器上安装<code class="fe nm nn no np b">ffmpeg</code>。</li></ul><p id="aed8" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">在我的例子中，我将按照之前显示的图像创建一个<code class="fe nm nn no np b">gif</code>。您可以通过使用<code class="fe nm nn no np b">duration</code>参数来调整 gif 的速度，也可以定制图像的大小和分辨率。</p><pre class="li lj lk ll gt nq np nr ns aw nt bi"><span id="166d" class="mm mn iv np b gy nu nv l nw nx"># save as preferred rendered format</span><span id="95c6" class="mm mn iv np b gy ny nv l nw nx">gganimate::animate(p, nframes = 200, fps = 5, duration = 100, width = 2000, height = 1200, renderer = gifski_renderer("anim.gif"))</span></pre><p id="0d01" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">根据您在<code class="fe nm nn no np b">animate()</code>函数中设置参数的方式，文件可能需要更长时间来渲染，但是您可以在控制台中查看进度。</p><h2 id="a7f2" class="mm mn iv bd mo mp mq dn mr ms mt dp mu kt mv mw mx kx my mz na lb nb nc nd ne bi translated">继续教育</h2><p id="c2f2" class="pw-post-body-paragraph kk kl iv km b kn nf jw kp kq ng jz ks kt nh kv kw kx ni kz la lb nj ld le lf io bi translated">这是一个简短的实际案例研究。它只涵盖了 r 中很小一部分动画的可能性。我鼓励你多读一些关于<code class="fe nm nn no np b">gganimate</code>的内容，然后尝试用它来制作一些你自己的数据动画。时间序列数据尤其适合制作好的动画。R 中的<code class="fe nm nn no np b">plotly</code>包也增加了动画功能，值得一看。</p><p id="d8fd" class="pw-post-body-paragraph kk kl iv km b kn ko jw kp kq kr jz ks kt ku kv kw kx ky kz la lb lc ld le lf io bi translated">最初我是一名纯粹的数学家，后来我成为了一名心理计量学家和数据科学家。我热衷于将所有这些学科的严谨性应用到复杂的人的问题上。我也是一个编码极客和日本 RPG 的超级粉丝。在<a class="ae lg" href="https://www.linkedin.com/in/keith-mcnulty/" rel="noopener ugc nofollow" target="_blank"><em class="mg">LinkedIn</em></a><em class="mg">或</em><a class="ae lg" href="https://twitter.com/dr_keithmcnulty" rel="noopener ugc nofollow" target="_blank"><em class="mg">Twitter</em></a><em class="mg">上找我。</em></p></div></div>    
</body>
</html>