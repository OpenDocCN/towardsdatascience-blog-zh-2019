<html>
<head>
<title>Convert Yelp Dataset to CSV</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 Yelp 数据集转换为 CSV</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/converting-yelp-dataset-to-csv-using-pandas-2a4c8f03bd88?source=collection_archive---------11-----------------------#2019-11-12">https://towardsdatascience.com/converting-yelp-dataset-to-csv-using-pandas-2a4c8f03bd88?source=collection_archive---------11-----------------------#2019-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/15bbfce88011f3a3e9f1a51ab9e62306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fGeFJt_t-P7lQPLyYI2YQQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Image source — Yelp</figcaption></figure><div class=""/><div class=""><h2 id="ee14" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">如何使用熊猫在 Jupyter 笔记本中加载大容量文件</h2></div><p id="0c5c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">第 13 轮<a class="ae lq" href="https://www.yelp.com/dataset/challenge" rel="noopener ugc nofollow" target="_blank"> Yelp 数据集挑战赛</a>于 2019 年 1 月开始，为学生提供赢得奖项和进行学术用途分析或研究的机会。</p><p id="8eb8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这篇文章一步一步地展示了如何加载 Yelp 数据集的巨大文件，特别是 5.2 千兆字节的 review.json 文件到一个更易于管理的 CSV 文件。review.json 文件中有超过 600 万条评论，在 Jupyter 笔记本中加载可能会很麻烦。</p><blockquote class="lr ls lt"><p id="4c9d" class="ku kv lu kw b kx ky kg kz la lb kj lc lv le lf lg lw li lj lk lx lm ln lo lp ij bi translated"><strong class="kw jg"> 1。下载 Yelp 数据集</strong> <br/> <em class="jf">(来源</em><strong class="kw jg"><em class="jf">:</em></strong><em class="jf">Yelp 数据集挑战</em><a class="ae lq" href="https://www.yelp.com/dataset/challenge" rel="noopener ugc nofollow" target="_blank"><em class="jf">https://www.yelp.com/dataset/challenge</em></a><em class="jf">)</em></p></blockquote><p id="d37a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这个数据集包括 Yelp 获得的关于企业、评论、用户、签到、提示和照片的信息。文件为 8.69 未压缩的 json 格式(6 个 json 文件包括 business.json、review.json、user.json、checkin.json、tip.json 和 photo.json)。</p><p id="d686" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">解压<code class="fe ly lz ma mb b">yelp_dateset</code>文件后，会出现另一个文件，在新文件的末尾加上<code class="fe ly lz ma mb b">.tar</code>再次解压。这 6 个 json 文件应该与 Yelp 的数据集协议和第 13 轮描述的 2 个 pdf 文件一起出现。</p><blockquote class="lr ls lt"><p id="3d0d" class="ku kv lu kw b kx ky kg kz la lb kj lc lv le lf lg lw li lj lk lx lm ln lo lp ij bi translated"><strong class="kw jg"> 2。在 Jupyter 笔记本中加载 Yelp 数据集</strong></p></blockquote><p id="ddd1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">因为 review.json 不包含业务的详细信息，所以如果我们想要了解每个评论是针对哪种业务的详细信息，我们需要将评论文件与业务文件合并。</p><h2 id="e54b" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">加载 business.json 文件</h2><p id="86f8" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">设置 business.json 环境路径以使用 Pandas 加载</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="36c9" class="mc md jf mb b gy ni nj l nk nl">import pandas as pd</span><span id="ba3c" class="mc md jf mb b gy nm nj l nk nl">business_json_path = 'data/business.json'<br/>df_b = pd.read_json(business_json_path, lines=True)</span></pre><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/2ec46a3b4f3db87e9b4a8ed8c2a83257.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aTXSn3lbvknEIbUQd00KKQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">business.json</figcaption></figure><h1 id="037f" class="no md jf bd me np nq nr mh ns nt nu mk kl nv km mn ko nw kp mq kr nx ks mt ny bi translated">清理 business.json 文件</h1><p id="772d" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">仅保留数据集中仍在营业的企业</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="4be5" class="mc md jf mb b gy ni nj l nk nl"># 1 = open, 0 = closed<br/>df_b = df_b[df_b['is_open']==1]</span></pre><p id="1c3c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">删除任何不相关的栏目(必须保留<code class="fe ly lz ma mb b">business_id</code>，以便与评论合并)</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="c186" class="mc md jf mb b gy ni nj l nk nl">drop_columns = ['hours','is_open','review_count']<br/>df_b = df_b.drop(drop_columns, axis=1)</span></pre><h2 id="a9a7" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">按类别划分业务</h2><p id="e07d" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">我们可以先使用类别查询相关业务，然后找到我们想要的相关评论。</p><p id="34b0" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于这个例子，我们只对房车相关的业务感兴趣。</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="0d6a" class="mc md jf mb b gy ni nj l nk nl">business_RV = df_b[df_b['categories'].str.contains(<br/>              'RV Repair|RV Dealers|RV Rental|RV Parks|Campgrounds',<br/>              case=False, na=False)]</span></pre><h2 id="54aa" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">查找相关类别</h2><p id="b1bc" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">因为一个企业可以有多个类别，所以很难计算出有多少不同的类别(<em class="lu">提示:1290 个不同的类别！</em>)。我们可以使用熊猫 v0.25 中的<code class="fe ly lz ma mb b">explode</code>功能来拆分类别。</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="4bf2" class="mc md jf mb b gy ni nj l nk nl"># Make sure the Pandas version is above 0.25<br/># If not, upgrade Pandas version<br/># !pip3 install --upgrade pandas<br/>pd.__version__</span></pre><p id="090b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一旦我们确认我们有更新的熊猫版本，让我们开始变魔术吧。</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="d3b8" class="mc md jf mb b gy ni nj l nk nl">df_explode = df_b.assign(categories = df_b.categories<br/>                         .str.split(', ')).explode('categories')</span></pre><p id="a867" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然后我们可以列出所有单独的类别</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="f27e" class="mc md jf mb b gy ni nj l nk nl">df_explode.categories.value_counts()</span></pre><p id="2339" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">找到包含<code class="fe ly lz ma mb b">RV</code>的类别</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="8e59" class="mc md jf mb b gy ni nj l nk nl">df_explode[df_explode.categories.str.contains('RV',<br/>                      case=True,na=False)].categories.value_counts()</span></pre><figure class="na nb nc nd gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nz"><img src="../Images/281aea747af8437c1742896ba84eedb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*taaEwJtup0hjK6YH7RPeBw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Yelp Dataset — Pandas Explode to find RV related categories</figcaption></figure><h1 id="5820" class="no md jf bd me np nq nr mh ns nt nu mk kl nv km mn ko nw kp mq kr nx ks mt ny bi translated">在 Pandas 中加载大量文件</h1><p id="cfa8" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">对于 Yelp 数据集这样的大文件，一次加载所有数据很可能会导致计算机内存崩溃。幸运的是，熊猫可以通过将文件分割成小块来加载大数据。</p><h2 id="9ac3" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">清理和加载 review.json 文件</h2><p id="c454" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">设置 review.json 环境路径以使用 Pandas 加载。</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="304c" class="mc md jf mb b gy ni nj l nk nl">review_json_path = 'data/review.json'</span></pre><p id="d956" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">识别每一列的数据类型可以减少内存使用。<br/>幸运的是，Yelp 为他们的数据集提供了<a class="ae lq" href="https://www.yelp.com/dataset/documentation/main" rel="noopener ugc nofollow" target="_blank">文档</a>，因此我们可以设置每一列的数据类型。</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="1242" class="mc md jf mb b gy ni nj l nk nl">size = 1000000<br/>review = pd.read_json(review_json_path, lines=True,<br/>                      dtype={'review_id':str,'user_id':str,<br/>                             'business_id':str,'stars':int,<br/>                             'date':str,'text':str,'useful':int,<br/>                             'funny':int,'cool':int},<br/>                      chunksize=size)</span></pre><p id="b0e7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这里，1，000，000 的块大小意味着熊猫每次将读取 1，000，000 行。在 review.json 的这个数据集中，有超过 600 万条评论(行)。减小块的大小可能更容易加载并更快地检查结果。</p><h1 id="b3d1" class="no md jf bd me np nq nr mh ns nt nu mk kl nv km mn ko nw kp mq kr nx ks mt ny bi translated">合并 Review.json 和 Business.json 文件</h1><p id="db73" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">通过仅将相关企业合并到评论文件，最终数据集将仅包含来自这些企业的评论。</p><figure class="na nb nc nd gt is"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="ae6d" class="no md jf bd me np nq nr mh ns nt nu mk kl nv km mn ko nw kp mq kr nx ks mt ny bi translated">将新数据框转换为 CSV 文件</h1><p id="4d40" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">可以更容易地加载和共享更简洁的数据集。</p><pre class="na nb nc nd gt ne mb nf ng aw nh bi"><span id="bfcf" class="mc md jf mb b gy ni nj l nk nl">csv_name = "yelp_reviews_RV_categories.csv"<br/>df.to_csv(csv_name, index=False)</span></pre><h1 id="4e6d" class="no md jf bd me np nq nr mh ns nt nu mk kl nv km mn ko nw kp mq kr nx ks mt ny bi translated">结论</h1><p id="7b28" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">这篇文章展示了我们如何轻松地将 Jupyter Notebook 中的 JSON 文件加载到 CSV 文件中，而不需要外部转换器。只有当我们知道如何正确阅读和使用数据时，数据才是有用的。彻底清理和处理数据将决定我们分析的质量。</p><h2 id="90ff" class="mc md jf bd me mf mg dn mh mi mj dp mk ld ml mm mn lh mo mp mq ll mr ms mt mu bi translated">接下来:使用散点文本可视化分析 Yelp 数据集</h2><p id="56d5" class="pw-post-body-paragraph ku kv jf kw b kx mv kg kz la mw kj lc ld mx lf lg lh my lj lk ll mz ln lo lp ij bi translated">现在我们已经有了 CSV 文件，我们可以开始分析数据了！在我的下一篇文章中，我将展示如何用散点图空间可视化数据。</p><p id="d3c6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">感谢阅读！我很乐意听到你的想法，在这里评论或给我发消息。用于此的代码位于我的<a class="ae lq" href="https://github.com/gyhou/yelp_dataset" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>中。</p></div></div>    
</body>
</html>