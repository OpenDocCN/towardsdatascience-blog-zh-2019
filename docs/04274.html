<html>
<head>
<title>Speed Up Your Python Code with Cython</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Cython 加速您的 Python 代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/speed-up-your-python-code-with-cython-8879105f2b6f?source=collection_archive---------13-----------------------#2019-07-03">https://towardsdatascience.com/speed-up-your-python-code-with-cython-8879105f2b6f?source=collection_archive---------13-----------------------#2019-07-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8312" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">花更少的时间在屏幕前等待</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/db99bd35aca2da825ec20b868d9e9c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Dg4YjN0Tugc11bHCy-hDA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Picture from <a class="ae kv" href="https://unsplash.com/photos/fxAo3DiMICI" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="ff03" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">简介</strong></h1><p id="5738" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果你曾经用 Python 编写过代码，你可能会花更多的时间等待某些代码块执行，而这是你所不希望的。虽然有一些方法可以让你的代码更有效率，但很可能还是比 C 代码慢。这主要归结于一个事实，即 Python 是一种动态编程语言，它将 C 在编译过程中负责的许多事情移到了运行时。</p><p id="dd5f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然而，如果你和我一样，喜欢用 Python 编程，并且仍然想加速你的代码，你可以考虑使用<strong class="lq ir"> Cython </strong>。虽然 Cython 本身是一种独立的编程语言，但它非常容易集成到您的 Jupyter 笔记本工作流程中。在执行时，Cython 会将您的 Python 代码翻译成 C 语言，通常会显著提高速度。</p><h1 id="de4a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">安装 Cython </strong></h1><p id="d8be" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了能够使用 Cython，你需要一个 C 编译器。因此，根据您当前的操作系统，安装过程会有所不同。对于 Linux，GNU C 编译器(gncc)通常是存在的。对于 Mac OS，你可以<a class="ae kv" href="https://developer.apple.com/" rel="noopener ugc nofollow" target="_blank">下载 Xcode </a>来获得 gncc。如果您应该使用 Windows，安装过程会稍微复杂一些。关于 Cython 的 GitHub 的更多信息<a class="ae kv" href="https://github.com/cython/cython/wiki/InstallingOnWindows" rel="noopener ugc nofollow" target="_blank">请点击这里</a>。</p><p id="8d66" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦你有了 C 编译器，你需要在你的终端上运行的是:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="f037" class="mu kx iq mq b gy mv mw l mx my">pip install Cython</span></pre><h1 id="1992" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">如何使用 Cython </strong></h1><p id="0025" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">展示 Cython 功能的最简单方式是通过 Jupyter 笔记本电脑。为了在我们的笔记本中使用 Cython，我们将使用 IPython magic 命令。神奇的命令以百分号开始，并提供了一些额外的功能，旨在增强您的工作流程。一般来说，有两种类型的魔法命令:</p><ol class=""><li id="6332" class="mz na iq lq b lr mk lu ml lx nb mb nc mf nd mj ne nf ng nh bi translated">线魔法由单个“%”表示，并且只对一行输入进行操作</li><li id="59da" class="mz na iq lq b lr ni lu nj lx nk mb nl mf nm mj ne nf ng nh bi translated">单元格魔术由两个“%”表示，对多行输入进行操作。</li></ol><p id="8918" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们开始吧:</p><p id="0ace" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先，为了能够使用 Cython，我们必须运行:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="33e1" class="mu kx iq mq b gy mv mw l mx my">%load_ext Cython</span></pre><p id="9cad" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，每当我们想在一个代码单元中运行 Cython 时，我们必须首先将以下神奇的命令放入该单元:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="6fb0" class="mu kx iq mq b gy mv mw l mx my">%%cython</span></pre><p id="391c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦你这样做了，你就可以开始用 Cython 编码了。</p><h1 id="5704" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">cy thon 快了多少？</strong></h1><p id="3511" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">与普通的 Python 代码相比，Cython 的速度快多少实际上取决于代码本身。例如，如果你要运行计算量很大的包含许多变量的循环，Cython 将会大大优于普通的 Python 代码。递归函数也将使 Cython 比 Python 快得多。</p><p id="84e7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们用斐波那契数列来证明这一点。这个算法，简单来说，就是把前两个数加起来，找到下一个数。这在 Python 中可能是这样的:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="093c" class="mu kx iq mq b gy mv mw l mx my">def fibonacci(n):</span><span id="513a" class="mu kx iq mq b gy nn mw l mx my">    if n &lt; 0:<br/>        print("1st fibonacci number = 0")</span><span id="ea90" class="mu kx iq mq b gy nn mw l mx my">    elif n == 1:<br/>        return 0</span><span id="e59e" class="mu kx iq mq b gy nn mw l mx my">    elif n == 2:<br/>        return 1</span><span id="fcec" class="mu kx iq mq b gy nn mw l mx my">    else:<br/>        return fibonacci(n-1) + fibonacci(n-2)</span></pre><p id="79e9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们让 Python 发挥作用:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/b45832365ba0491ab96449040c9858ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TGY6A_dJdN5uBxvUeMf6ag.png"/></div></div></figure><p id="9eef" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如您所见，找到序列中的第 39 个数字需要 13.3 秒的计算时间。这里的 Wall time 指的是从开始到结束调用函数所用的总时间。</p><p id="dc68" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们在 Cython 中定义相同的函数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/434a0f16de856e8d9a01219ca0a499c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pkx94SUVeVK0xAgOJoCz3g.png"/></div></div></figure><p id="509f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是怎么回事？如你所见，我们在顶部使用了一些细胞魔法，允许我们在这个细胞中使用 Cython。我将很快解释“-a”选项的作用。然后，我们基本上采用与上面相同的代码，除了现在我们能够利用静态类型声明并将 n 定义为 integer 类型。</p><p id="1fec" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">正如您所看到的，通过在 magic 命令后添加“-a”，我们收到了注释，向我们显示了您的代码中有多少 Python 交互。这里的目标是去掉所有的黄线，取而代之的是白色背景。在这种情况下，将没有 Python 交互，所有代码都将在 C 中运行。您还可以单击每行旁边的“+”号来查看 Python 代码的 C 翻译。</p><p id="3d84" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">那段代码快了多少？让我们来看看:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/e646d2b40faef6961034a26465e37214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RALWxZUuNUQ1OdIoSPe5Pg.png"/></div></div></figure><p id="d153" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这种情况下，Cython 比 Python 快 6.75 倍左右。这清楚地展示了利用 Cython 节省时间的能力，与常规 Python 代码相比，它提供了最大的改进。</p><h1 id="19c2" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">附加选项</strong></h1><p id="e84d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果你已经知道 C，Cython 也允许访问 C 代码，而 Cython 的制造商还没有为这些代码添加现成的声明。例如，使用下面的代码，您可以为 C 函数生成一个 Python 包装器，并将其添加到模块 dict 中。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="4c9f" class="mu kx iq mq b gy mv mw l mx my">%%cython</span><span id="47f2" class="mu kx iq mq b gy nn mw l mx my">cdef extern from "math.h":<br/>    cpdef double sin(double x)</span></pre><p id="f98f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Cython 证明了许多额外的能力，例如并行性，这些都在它的文档中有非常清晰的描述，你可以在这里找到<a class="ae kv" href="http://docs.cython.org/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="1efe" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">结论</strong></h1><p id="ba08" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果您有时会遇到 Python 代码执行时间过长的问题，Cython 提供了一种真正集成的高效方法来加速您的代码。最重要的是，如果你对 c 语言稍微熟悉一点，它提供了许多进一步优化你的代码的能力。如果你有任何建议或意见，请随时联系我。</p></div></div>    
</body>
</html>