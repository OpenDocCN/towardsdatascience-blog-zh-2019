# 有人脸识别的那个。

> 原文：<https://towardsdatascience.com/s01e01-3eb397d458d?source=collection_archive---------5----------------------->

## 全面互动的人脸识别入门指南。跟随并创建一个自定义的人脸识别程序，它能够检测和识别视频或直播网络摄像头流中的人脸。

这是一个繁忙的市场场景；七月刺目的阳光照耀着头顶。酷热并没有阻止顾客的到来。人们不知道的是，在他们中间隐藏着一个怀有恶意的人。他伪装成一副正常人的样子，步行去实现他邪恶的目的。在一个角落里，一个监控摄像头定期扫描这个区域，这时它瞥见了这个家伙。它看到的每一张脸都会立刻被认出来，而且碰巧这家伙是个通缉犯。在几毫秒的时间里，他附近的警察得到了警报，他们开始着手消除这一威胁。这个故事曾经出现在科幻小说中，但现在情况大不相同了。事实上，中国使用人工智能驱动的监控工具来监视其公民。智能手机制造商也在积极利用人脸识别来验证手机用户的身份。人脸识别有许多不同的应用，不管你想用它做什么，在这篇文章中，我将指导你创建一个自定义的人脸识别程序。您将构建一个小程序，该程序将在视频剪辑或网络摄像头流中识别您选择的人脸。

![](img/a1bd17798a1330f8e42013600609b32b.png)

Like what you see? This is what we will get.

在本文中，我们将构建一个自定义的人脸识别程序。这篇文章很容易理解，也阐明了这个机器学习项目的理论方面。如果你愿意，请使用目录来确定重要的部分并浏览文章。

## 目录

*专业提示*:如果你想快速完成工作，请随意跳过理论部分，直接进入第二部分。

1.  **Facenet**
    一、什么事？
    二。Facenet 是如何工作的？
    三。三重损失
2.  **让我们开始建造吧！**
    一、前提条件
    二。数据变脏
    三。下载 Facenet
    四。对齐
    v .获取预训练模型
    vi。根据我们的数据训练模型
    vii。在视频上测试我们的模型
3.  **弊端**
4.  **结论**
5.  **参考文献**

# Facenet

在这个项目中，我们将采用一个名为 Facenet 的系统来为我们进行人脸识别。

## 这是什么？

Facenet[1]是由 Florian Schroff、Dmitry Kalenichenko、James Philbin。他们也写了一篇关于它的论文。它直接学习从人脸图像到紧致欧几里得空间的映射，其中距离直接对应于人脸相似性的度量。一旦创建了这些嵌入，就可以利用这些嵌入作为特征来完成像人脸识别和验证这样的过程。

## Facenet 是如何工作的？

Facenet 使用卷积层直接从面部的像素学习表示。这个网络是在一个大数据集上训练的，以实现对光照、姿态和其他可变条件的不变性。该系统在野生的 (LFW)数据集中的[标记的人脸上进行训练。该数据集包含从网络上收集的 13，000 多张不同人脸的图像，每张人脸都有一个名称(标签)。](http://vis-www.cs.umass.edu/lfw/)

Facenet 从图像中创建 128 维嵌入并将它们插入到特征空间中，以这种方式，不管成像条件如何，相同身份的所有人脸之间的平方距离很小，而来自不同人物的一对人脸图像之间的平方距离很大。下图描述了模型架构:

![](img/d8ba814c20d6ee7871b7cc14d7257a39.png)

**Model Structure:** The model contains a batch input layer, followed by a Deep CNN architecture, and an L2 layer. This results in the creation of facial embeddings.

## 三重损失

该系统采用一种称为三重态损耗的特殊损耗函数。三元组损失最小化相同身份的图像之间的 L2 距离，最大化不同人物的面部图像之间的 L2 距离。

> 该系统采用三重损失，因为它更适合于面部验证。使用三重损失背后的动机是，它鼓励一个身份的所有图像被投影到嵌入空间中的单个点。

![](img/5092182e9c5dd4494369ce581f997a63.png)

**Triplet loss:** Before and after the learning process.

创作者设计了一种有效的三重选择机制，每次智能地选择三幅图像。这些图像有以下三种类型:

*1。* ***主播*** *:一个随机出现的人的形象。
2。* ***正面*** ***形象*** *:同一个人的另一个形象。
3。* ***负面*** ***形象*** *:一个不同的人的形象。*

测量两个欧几里德距离:一个是锚和正图像之间的距离，我们称之为 A。另一个是锚和负图像之间的距离，我们称之为 B。训练过程旨在减小 A 并最大化 B，使得相似的图像彼此靠近，而不同的图像位于嵌入空间的远处。

# 好了，Facenet 很酷，现在怎么办？

最好的部分是前方的路。我们可以使用 Facenet 为我们自己选择的人脸创建嵌入，然后训练 SVM(支持向量机)使用这些嵌入进行分类。让我们开始构建一个自定义的人脸识别程序吧！

你可以看看这个项目的 [Github 库](https://github.com/AssiduousArchitect/face-recognition)，因为它包含一个自定义数据集和脚本来检测视频中的人脸。

## 先决条件

在我们开始之前，请确保您的系统上安装了以下库:

1.  张量流==1.7
2.  scipy
3.  sci kit-学习
4.  opencv-python
5.  h5py
6.  matplotlib
7.  枕头
8.  要求
9.  psutil

## 被数据弄脏

在这个项目中，我们将创建一个人脸识别程序，它将能够识别 90 年代情景喜剧《老友记》中的核心人物。如果你想建立这个来识别一组不同的面孔，那么就用你的图像来代替。只要确保你遵循类似的目录结构——为你想要被识别的每个身份创建一个文件夹，并将这些文件夹存储在名为*‘raw’*的文件夹中。

![](img/7684badabe5f2f797056eadc795d13f9.png)

**Dataset Directory:** Note how each character has a folder of its own.

用这些人的脸的照片填满每个文件夹。请注意，每张图片只有一张清晰可见的脸。我为每个角色添加了 20 张图片，尽管更少的图片就足够了。每个文件夹都有相同数量的图片。你可以在这里下载我从[创建的朋友的数据集。哦，对了，这是*【钱德勒】*文件夹的样子:](https://github.com/AssiduousArchitect/face-recognition)

![](img/22c1689892fb6ce7928cb572f96076ba.png)

*Could it be any more fuller?*

## 下载 Facenet

既然收集数据已经结束。请继续下载 [Facenet repo](https://github.com/davidsandberg/facenet) 。下载它，提取它，并将*‘Dataset’*文件夹放入其中。

## 远离对齐

关于该模型的一个问题是，它可能会错过一些面部标志，为了解决这个问题，我们必须对齐数据集中的所有图像，以使眼睛和嘴唇出现在所有照片的相同位置。我们将使用 M.T.C.N.N .(多任务 C.N.N .)来做同样的事情，并将所有对齐的图像存储在一个名为 processed 的文件夹中。

打开终端/命令提示符并导航到 Facenet 目录。然后运行 *align_dataset_mtcnn.py* 以及以下参数。

```
python src/align_dataset_mtcnn.py \
./Dataset/Friends/raw \
./Dataset/Friends/processed \
--image_size 160 \
--margin 32 \
--random_order \ 
--gpu_memory_fraction 0.25
```

运行此命令将对齐所有图像，并将它们存储在各自的文件夹中，然后将所有内容存储在'*已处理'*文件夹中。下图将让您了解对齐是如何工作的:

![](img/f8fb2a762e7e6f95a5851bee81abfec3.png)

All images are cropped and aligned to a standard 160x160 pixel image.

## 获取预先训练的模型

现在，为了在您自己的图像上训练模型，您需要下载预训练的模型。请从[这里](https://drive.google.com/file/d/1EXPBSXwTaqrSC0OhUdXNmKSh9qJUQ55-/view)下载。

在 Facenet 根目录下创建一个名为“Models”的文件夹。下载完成后，将 zip 文件的内容解压到名为*‘facenet’*的目录中，并将该文件夹放在*‘Models’*文件夹中。

![](img/7b8f15f3761c2f866eeff21b7696b142.png)

Here you go, another direcTREE image. Get it?

这个模型是在 LFW 数据集上训练的，因此所有的面部嵌入都存储在这些文件中。这让我们有机会冻结图表，并根据我们自己的图像对其进行训练。这样做将把我们提供的所有面嵌入到维度空间中。

## 根据我们的数据训练模型

我们已经万事俱备了！我们有一个预先训练好的模型，我们的自定义数据集已经对齐并准备就绪。现在，该训练模型了！

```
python src/classifier.py TRAIN \
./Dataset/Friends/processed \
./Models/facenet/20180402-114759.pb \
./Models/Friends/Friends.pkl \
--batch_size 1000
```

执行上述命令将加载预训练模型并开始训练过程。一旦训练结束，嵌入新图像的图像将被导出到*模型/朋友/* 中。

由于我们使用预先训练的模型和相对较少数量的图像，训练过程很快就结束了。

## 在视频上测试我们的模型

为了测试我们的模型，我使用了朋友们的摘录。你可以使用自己的视频，甚至使用网络摄像头。在这一节中，我们将编写脚本来促进视频提要中的人脸识别。您可以继续学习以更好地理解这个脚本，或者从这里下载这个脚本。

导航到*‘src’*文件夹，创建一个新的 python 脚本。我将其命名为 faceRec.py。接下来，我们导入所有需要的库。

这个脚本将只接受一个参数，那就是视频文件的路径。如果没有提到路径，那么我们将通过网络摄像头传输视频。因此，该参数的默认值为 0。

我们将初始化一些变量。确保根据文件夹结构改变路径。

加载自定义分类器。

设置一个张量流图，然后加载面网模型。使用 GPU 将加快检测和识别过程。

设置输入和输出张量。

pnet、rnet 和 onet 是 M.T.C.N.N .的组成部分，将用于检测和对齐人脸。

接下来，我们将创建一个集合和一个集合来跟踪检测到的每个身份。

设置视频捕获对象。

因此，如果在运行程序时没有将 VIDEO_PATH 作为参数传递，它将采用默认值 0。如果发生这种情况，视频捕获对象将从网络摄像头传输视频。

然后，视频被逐帧捕获，并且通过 *detect_face* 模块在这些帧中检测人脸。找到的面数存储在 *faces_found* 变量中。

如果找到了面，那么我们将迭代每个面，并将边界框的坐标保存在变量 *bb* 中。

然后这些脸被提取、裁剪、缩放、整形并输入字典。

我们将使用该模型来预测人脸的身份。我们提取最佳类别概率或置信度。它是我们的模型在多大程度上确定预测的身份属于给定的脸的度量。

最后，我们将在脸部周围画一个边界框，并在边界框旁边写下预测的身份以及置信度。如果置信度低于某个阈值，我们会将该名称填充为未知。

务必放置 except 语句。这将确保任何抛出的错误被成功忽略。确保放置 except 语句。这样做有助于我们忽略错误。

```
except: pass
```

过程结束后，显示视频并关闭视频显示窗口。由于每一帧都要经过大量处理，视频回放可能会很慢。

恭喜你，你的耐心有了回报！我们已经完成了剧本，准备隆隆作响！快速启动 cmd 并执行以下命令来启动人脸识别程序。确保将待测试视频的路径作为参数传递，或者留空以从网络摄像头传输视频。

```
python src/faceRec.py --path ./Dataset/Friends/friends.mp
```

维奥拉。

![](img/bdf21c403edaea03158d87f7d7d985c0.png)

My reaction when I saw this program work.

这个系统并不完美，也有一些缺点。

# 缺点

1.  该系统总是试图将每张脸放入一个给定的身份中。如果一个新面孔出现在屏幕上，系统会给它分配一个身份。这个问题可以通过仔细选择阈值来解决。
2.  身份之间的混淆。在上面的 gif 中，你可以观察到乔伊和钱德勒之间的预测是如何波动的。而且，置信度得分很低。用更多图像训练模型将解决这个问题。
3.  在一定距离内无法识别人脸，即如果人脸看起来很小。

让我们结束这一切。

# 结论

不管是无形地照顾你的员工还是在野外寻找违法者。人脸识别技术可以证明是一个真正的宝石。这个项目包括创建一个人脸识别程序，它可以识别你选择的人脸。您创建了一个自定义数据集，训练了模型，并编写了在视频剪辑上运行人脸识别系统的脚本。然而，有一些缺点，但我们的系统运行良好。

祝你愉快。

# 参考文献

[1] Florian Schroff、Dmitry Kalenichenko 和 James Philbin， [FaceNet:人脸识别和聚类的统一嵌入](https://arxiv.org/abs/1503.03832) (2015)，arxiv.org