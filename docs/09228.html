<html>
<head>
<title>How to Supercharge your Pandas Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何增强你的熊猫工作流程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-supercharge-your-pandas-workflows-ae642b03ba52?source=collection_archive---------16-----------------------#2019-12-06">https://towardsdatascience.com/how-to-supercharge-your-pandas-workflows-ae642b03ba52?source=collection_archive---------16-----------------------#2019-12-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/571fd1577abb0abef8387843b72e0e90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j0r7JC713GGDRfzT"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@billjelen?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Bill Jelen</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b732" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我处理结构化数据时，Pandas 是我的首选工具。我认为这并不奇怪，因为 Pandas 是最流行的用于数据操作、探索和分析的 Python 库。它提供了很多现成的功能。此外，还存在各种其他模块来进一步增强和扩展 Pandas 核心。在这篇文章中，我想和你分享我用来增强我的熊猫工作流程的工具和技术。</p><h1 id="3686" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">增压步骤</h1><h2 id="42df" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">准备</h2><p id="69d7" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">为了跟随例子，你需要 Python 3.7+和<a class="ae kf" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">熊猫</a>、<a class="ae kf" href="https://funcy.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> funcy </a>和<a class="ae kf" href="https://seaborn.pydata.org/" rel="noopener ugc nofollow" target="_blank"> seaborn </a>。你可以在我的<a class="ae kf" href="https://github.com/Shawe82/awesome-pandas" rel="noopener ugc nofollow" target="_blank"><strong class="ki iu"><em class="mt">GitHub repo</em></strong></a>上找到所有的例子。</p><p id="c5ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一如既往，我推荐使用<a class="ae kf" href="https://poetry.eustace.io/" rel="noopener ugc nofollow" target="_blank">poem</a>来管理您的 Python 包和环境。你可以查看<a class="ae kf" rel="noopener" target="_blank" href="/how-to-setup-an-awesome-python-environment-for-data-science-or-anything-else-35d358cc95d5">这篇文章</a>了解如何设置它。作为一种快捷方式，我建议使用 pip 或 pipx 将其安装在您的机器上。</p><p id="c7c4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，让我们快速创建一个名为<em class="mt"> awesome-pandas </em>的诗歌项目，在这里我们实现示例并添加必要的包</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="5327" class="mc lf it mz b gy nd ne l nf ng">poetry new awesome-pandas<br/>cd awesome-pandas<br/>poetry add pandas seaborn funcy</span></pre><p id="bf74" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们有了一个独立的 Python 环境，安装了我们需要启动的所有东西。太好了，我们可以开始增压我们的熊猫工作流程了！</p><h2 id="7ff8" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">探索性数据分析</h2><p id="2f45" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">不管你有什么样的数据集，你首先要做的可能是对其中发生的事情有一个想法和理解。这个过程被称为探索性数据分析，EDA。</p><p id="9b0c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">数据集中有多少要素和样本？那些特征是什么？它们有哪些数据类型？是否有任何缺失值？它们是如何分布的？有什么关联吗？这些只是人们在查看新数据集时通常会遇到的许多问题中的一部分。</p><p id="ee05" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于熊猫来说，获取这些信息的通常嫌疑人是函数<em class="mt"> head </em>、<em class="mt"> info </em>、<em class="mt">description</em>和<em class="mt"> corr、</em>等等。因此，对于您的 EDA，您可以从一个接一个地调用这些函数开始。接下来，您可以从控制台或 Jupyter 笔记本上读取结果，并将结果关联起来。这个过程对我来说听起来很乏味。此外，它不包括任何可以很容易解释的视觉效果。创建它们需要额外的步骤和代码。以结构化和整合的方式获取所有这些信息不是很好吗？理想情况下只调用一个函数？</p><blockquote class="nh ni nj"><p id="9cb0" class="kg kh mt ki b kj kk kl km kn ko kp kq nk ks kt ku nl kw kx ky nm la lb lc ld im bi translated">这里是熊猫的光辉之地！</p></blockquote><p id="e906" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://pandas-profiling.github.io/pandas-profiling/docs/" rel="noopener ugc nofollow" target="_blank"><strong class="ki iu">Pandas-profiling</strong></a>是一个扩展 Pandas DataFrame API 的库。它将常见的第一个 EDA 步骤合并到一个函数调用中。这些包括<strong class="ki iu"> <em class="mt">数据类型、</em> </strong> <strong class="ki iu"> <em class="mt">缺失值、相关性、分位数和描述性统计以及直方图</em> </strong>等。所有这些信息被组合成一个单一的输出。<em class="mt">您可以通过一个配置文件</em>  <em class="mt">来配置</em> <a class="ae kf" href="https://github.com/pandas-profiling/pandas-profiling/blob/master/pandas_profiling/config_default.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="mt">分析什么以及结果如何呈现。听起来很棒，不是吗？让我们简单看一下。</em></a></p><p id="ad68" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我认为将它添加到我们的示例环境中是有意义的</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="919e" class="mc lf it mz b gy nd ne l nf ng">poetry add pandas-profling</span></pre><p id="e11e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您所要做的就是导入 pandas-profiling 并在 DataFrame 对象上调用 profile_report。如果你用的是 Jupyter Notebook，这个足以看到输出。当使用 IDE 或编辑器时，您必须将报告保存为 HTML 文件，并在浏览器中打开它。我不是一个笔记本电脑爱好者，所以我必须做更多的工作</p><p id="20e7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是为什么我想出了下面的函数。它使我能够检查只调用单个函数的报告，就像 Jupyter 人一样。</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="a895" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们拥有和 Jupyter 人几乎一样的舒适。</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="np no l"/></div></figure><p id="0acc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是，我希望<em class="mt">和</em>一样舒适，并使用一个<strong class="ki iu"> <em class="mt">专用数据框架 API </em> </strong> <em class="mt"> </em>来创建和打开我的报告。</p><h2 id="2c7f" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">扩展熊猫 API</h2><p id="548a" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">Pandas 已经提供了一套丰富的现成方法。但是，您可能希望根据需要扩展和自定义索引、系列或数据框架对象。幸运的是，从 0.23 版本开始，Pandas 允许你通过自定义的<strong class="ki iu"> <em class="mt">访问器</em> </strong>来实现。如果你想在 Pandas &lt; 0.23 中添加一个自定义的访问器，你可以使用<a class="ae kf" href="https://zsailer.github.io/software/pandas-flavor/" rel="noopener ugc nofollow" target="_blank"> Pandas-flavor </a>。</p><p id="21c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">编写自定义访问器相当简单。让我们用上一节中的例子来看看它；<em class="mt">在浏览器中为数据帧创建并打开 pandas-profiling 报告。</em></p><p id="48ed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们从一个 Python 类<em class="mt">报告</em>开始，我们必须用<code class="fe nq nr ns mz b">@pandas.api.extensions.register_dataframe_accessor("report")</code>来修饰它。class' <code class="fe nq nr ns mz b">__init__</code>'方法必须将 DataFrame 作为其唯一的参数。您将该对象存储在一个实例变量中，并使用它来应用您自定义方法。自定义方法是您的类的实例方法。</p><p id="e37a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一个例子，我们将一个方法<em class="mt"> show_in_browser </em>添加到类<em class="mt">报告中。我们可以通过<code class="fe nq nr ns mz b">df.report.show_in_browser()</code>在数据帧<em class="mt"> df </em>上调用它，为此，我们只需导入包含类报告的模块。</em></p><p id="fdf7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以使用传递给装饰器的名称来访问您的自定义方法。举个例子，如果我们用“<em class="mt"> wicked </em>”交换“<em class="mt"> report </em>”，而不改变其他任何东西，我们必须调用<code class="fe nq nr ns mz b">df.wicked.show_in_browser()</code>在浏览器中打开我们的报表。</p><p id="7591" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">说够了，下面是代码，它给我们带来了和 Jupyter 人一样的舒适</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="nt no l"/></div></figure><p id="e461" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，我通过添加<code class="fe nq nr ns mz b">__call__</code>使类 a 成为可调用的。为什么这很有用？因为现在你可以调用<code class="fe nq nr ns mz b">df.report()</code>来执行一个函数，就是在这里获取报告。如果你只想给你的对象添加一个函数，并且不想调用<code class="fe nq nr ns mz b">df.report.report().</code>之类的函数，这就非常方便了</p><p id="ff55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">关于自定义访问器的最后一件有用的事情是，ide 可以识别它们并启用自动完成功能。这增强了整体开发体验。</p><p id="e8a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们知道了我们的数据是什么样子，以及如何扩展 Pandas 对象。所以，让我们继续有趣的事情，看看如何改善处理体验。</p><h2 id="17d4" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">跟踪应用调用的进度</h2><p id="9562" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">假设您想对数据帧应用一个函数。根据数据帧的大小或函数的复杂程度，执行<code class="fe nq nr ns mz b">df.apply(func)</code>可能需要很长时间。所以你可能会坐在电脑前等待它结束。不幸的是，你没有得到任何反馈，不知道你要等多久，也不知道它到底有没有用。你可能只听到一个响亮的风扇和你的电脑正在升温。如果你像我一样，你会在那一点上变得紧张和不耐烦。得到有事情发生的反馈不是更好吗？或者更好的是，得到一个关于事情完成需要多长时间的预测？</p><blockquote class="nh ni nj"><p id="f57c" class="kg kh mt ki b kj kk kl km kn ko kp kq nk ks kt ku nl kw kx ky nm la lb lc ld im bi translated">Tqdm 是你的朋友！</p></blockquote><p id="bad2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://tqdm.github.io/" rel="noopener ugc nofollow" target="_blank"> Tqdm </a>是一个 Python 模块，它让你<em class="mt">用很少的代码和很小的执行开销就能给你的循环添加智能进度条</em>。除此之外，它还提供了剩余执行时间的预测。而且，对本文来说最重要的是，它附带了一个熊猫集成。让我们看看那是什么样子。</p><p id="a995" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和往常一样，我们首先将模块添加到我们的示例环境中</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="53c5" class="mc lf it mz b gy nd ne l nf ng">poetry add tqdm</span></pre><p id="7d51" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在你要做的就是<em class="mt">导入 tqdm </em>和<em class="mt"> </em>调用<em class="mt"> tqdm.pandas </em>向熊猫注册。现在您可以在 DataFrame 对象上调用<em class="mt"> progress_apply </em>而不是<em class="mt"> apply </em>。下面是使用一些无意义的示例数据的完整代码</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="e287" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的电脑上，产生的进度条看起来像</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="ecaa" class="mc lf it mz b gy nd ne l nf ng">Hello Medium: 42%|████▏ | 4177/10000 [00:01&lt;00:02, 2232.11it/s]</span></pre><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="nu no l"/></div></figure><p id="5561" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你现在知道你在这个过程中的位置，并且估计你还剩多少时间来喝完你的咖啡。</p><h2 id="f88d" class="mc lf it bd lg md me dn lk mf mg dp lo kr mh mi ls kv mj mk lw kz ml mm ma mn bi translated">增加申请电话</h2><p id="1e9b" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在上一节中，我们已经看到了如何获得关于执行长时间运行的应用函数的反馈。这让我们可以在继续工作之前估计我们可以喝多少咖啡。然而，有些人说你不应该喝太多咖啡，因为它不健康。因为我们都想保持健康，所以减少等待时间，从而减少我们喝咖啡的数量是一件好事。即使你不喝咖啡，更少的等待时间意味着更多的生产时间。我们都想拥有它。</p><blockquote class="nh ni nj"><p id="75f7" class="kg kh mt ki b kj kk kl km kn ko kp kq nk ks kt ku nl kw kx ky nm la lb lc ld im bi translated">Swifter 提升您的数据框架应用调用。</p></blockquote><p id="aaab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://github.com/jmcarpenter2/swifter" rel="noopener ugc nofollow" target="_blank">更快</a>使<em class="mt">更容易</em>以<strong class="ki iu"> <em class="mt">最快</em> </strong> <em class="mt"> </em> <strong class="ki iu"> <em class="mt">可用</em> </strong>方式将任何功能应用到您的熊猫系列或数据帧。它首先尝试以矢量化的方式运行函数。如果失败，swifter 会决定是执行 Dask 并行处理更快还是使用标准 Pandas apply 更快。所有这些都是通过一个函数调用自动完成的。这是一个很好的抽象层次！</p><p id="59c8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们快速看一下代码。首先，我们将 swifter 添加到我们的示例环境中(我想这会变得很无聊，但我想保持这种结构)</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="ba50" class="mc lf it mz b gy nd ne l nf ng">poetry add swifter</span></pre><p id="e853" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们现在只需要导入得更快，并且可以在我们的数据帧或系列对象上调用<code class="fe nq nr ns mz b">df.swifter.apply(func)</code>。搞定了。Swifter 还带有 tqdm 进度条实现。要调用它，您需要调用<code class="fe nq nr ns mz b">df.swifter.progressbar(True,”Hello Medium").apply(func) </code> Sweat！</p><p id="0c5e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当你看到你必须做什么来使用 swifter 时，你能猜出它是如何注册到熊猫对象的吗？如果你的答案是“它使用熊猫扩展 API”，那你就对了。哦，这一切是如此完美地结合在一起:)</p><p id="8690" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，让我们比较一下 swifter apply 和 Pandas apply 对上述虚拟数据的执行时间</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="50c9" class="mc lf it mz b gy nd ne l nf ng">df = pd.DataFrame(np.random.rand(10000, 10))<br/>%timeit df.swifter.apply(lambda s:s**1/2, axis=1)<br/><strong class="mz iu">29.1 ms</strong> ± 118 µs per loop<br/>%timeit df.apply(lambda s:s**1/2, axis=1)<br/><strong class="mz iu">2.96 s</strong> ± 6.39 ms per loop</span></pre><p id="4e2f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用 swifter 的 29.1 毫秒比使用正常应用的 2.96 秒少得多。具体来说，大约快 100 倍。</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="nv no l"/></div></figure><p id="1fc6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我相信您也可以手动实现这种性能，但 swifter 可以为您实现。</p><h1 id="0a02" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">包裹</h1><p id="42e7" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在这篇文章中，我向你展示了如何增压你的熊猫工作流程和经验。总之，对你来说最重要的三点是</p><ul class=""><li id="6126" class="nw nx it ki b kj kk kn ko kr ny kv nz kz oa ld ob oc od oe bi translated"><strong class="ki iu"> <em class="mt">使用 pandas-profiling 对 pandas 数据帧执行 EDA。</em> </strong></li><li id="e8c9" class="nw nx it ki b kj of kn og kr oh kv oi kz oj ld ob oc od oe bi translated">利用 Pandas 扩展 API 根据您的需要定制 Pandas 对象。T9】</li><li id="5ff7" class="nw nx it ki b kj of kn og kr oh kv oi kz oj ld ob oc od oe bi translated"><strong class="ki iu"> <em class="mt">使用 tqdm 和 swifter 来增强和加速对熊猫对象应用函数。</em>T13】</strong></li></ul><p id="850a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您关注这篇文章。一如既往，如有任何问题、意见或建议，请随时联系我。</p></div></div>    
</body>
</html>