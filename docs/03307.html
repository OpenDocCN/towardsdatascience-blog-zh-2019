<html>
<head>
<title>Deploy ML models at scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大规模部署 ML 模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-ml-models-at-scale-151204549f41?source=collection_archive---------6-----------------------#2019-05-27">https://towardsdatascience.com/deploy-ml-models-at-scale-151204549f41?source=collection_archive---------6-----------------------#2019-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3f03" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第 1 部分:ML 模型的 API 服务</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aeb5f556186b072748fb9a9696fe9aac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gYiavISjtd-ihsAF.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">ML Model Deployment (<a class="ae kv" href="https://www.toptal.com/python/python-machine-learning-flask-example" rel="noopener ugc nofollow" target="_blank">Source</a>)</figcaption></figure><p id="c403" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们假设您已经构建了一个 ML 模型，并且您对它的性能感到满意。然后下一步是将模型部署到生产中。在这个博客系列中，我将介绍如何使用 AWS 和 docker 容器服务在可扩展的基础设施中部署大规模消费模型。</p><p id="287f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇博客中，我将从构建 ML 模型的 API 框架的第一步开始，并在您的本地机器上运行它。出于这篇博客的目的，让我们考虑在这里建立<a class="ae kv" rel="noopener" target="_blank" href="/sentiment-analysis-for-text-with-deep-learning-2f0a0c6472b5">的情感分类模型。为了部署该模型，我们将遵循以下步骤:</a></p><ol class=""><li id="2a2c" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">将模型转换成<strong class="ky ir"> <em class="mb"> .hdf5 </em> </strong>文件或<strong class="ky ir"> <em class="mb">。pkl </em> </strong>文件</li><li id="3135" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">实现 Flask API</li><li id="2e67" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">运行 API</li></ol><h2 id="22ee" class="mh mi iq bd mj mk ml dn mm mn mo dp mp lf mq mr ms lj mt mu mv ln mw mx my mz bi translated">将模型转换成"<strong class="ak"> <em class="na"> .hdf5" </em> </strong>文件或'。“pkl”文件</h2><p id="cadf" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">如果模型是基于 sklearn 构建的，最好将其保存为。“pkl”文件。或者，如果它是深度学习模型，那么建议将模型保存为“HDF”文件。'之间的主要区别。pkl '和'。“hdf”是，pickle 需要大量的内存来保存数据结构到磁盘，而 HDF 是为了有效地存储大型数据集而设计的。</p><p id="b88c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">将模型保存在泡菜中(。pkl): </strong></p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="e312" class="mh mi iq nh b gy nl nm l nn no">from sklearn.externals import joblib  <em class="mb"># Save to file</em></span><span id="6fa5" class="mh mi iq nh b gy np nm l nn no"># Fit the model (example of a model in sklearn)<br/>model = LogisticRegression()<br/>model.fit(X_train, Y_train)</span><span id="87de" class="mh mi iq nh b gy np nm l nn no">#<em class="mb">working directory<br/></em>joblib_file = "best_model.pkl"   <br/>joblib.dump(model, joblib_file)</span></pre><p id="d5f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">在 HDF 保存模型(. hdf5): </strong></p><p id="1ad5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦在 keras 或 tensorflow 中训练了深度学习模型，就可以使用. hdf5 文件系统保存模型架构及其权重。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="e035" class="mh mi iq nh b gy nl nm l nn no"># save the best model and early stopping</span><span id="6115" class="mh mi iq nh b gy np nm l nn no">saveBestModel = keras.callbacks.ModelCheckpoint('/best_model.hdf5', monitor='val_acc', verbose=0, save_best_only=True, save_weights_only=False, mode='auto', period=1)</span></pre><h2 id="0745" class="mh mi iq bd mj mk ml dn mm mn mo dp mp lf mq mr ms lj mt mu mv ln mw mx my mz bi translated">实现 Flask API</h2><p id="a190" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated"><strong class="ky ir">步骤 1: </strong>根据文件类型，通过以下方法之一加载保存的模型(根据上一节)，即“hdf5”或“pkl”。</p><p id="d0e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> HDF5: </strong></p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="514a" class="mh mi iq nh b gy nl nm l nn no">from keras.models import load_model<br/>import h5py<br/>prd_model = load_model('best_model.hdf5')</span></pre><p id="1104" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">PKL: </p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="1c18" class="mh mi iq nh b gy nl nm l nn no">from sklearn.externals import joblib<br/>loaded_model = joblib.load('best_model.pkl')</span></pre><p id="a1eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步:</strong>导入 flask，创建 flask 应用对象，如下图所示:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="f967" class="mh mi iq nh b gy nl nm l nn no">from flask import Flask, url_for, request</span><span id="b94a" class="mh mi iq nh b gy np nm l nn no">app = Flask(__name__)</span></pre><p id="ac63" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">步骤 3: </strong>下一步是构建一个测试 API 函数，它返回“<em class="mb"> API working”字符串。</em>这可以用来确保 API 在生产中部署时的健康。这里我们使用' @app.route '，这是一个 python 装饰器(<em class="mb">装饰器是一个函数，它接受另一个函数并扩展后一个函数的行为，而不显式修改它)</em></p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="e064" class="mh mi iq nh b gy nl nm l nn no"><a class="ae kv" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route(‘/apitest')<br/>def apitest():<br/>    return ‘API working’</span></pre><p id="e896" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">步骤 4: </strong>下一步是构建一个“POST”请求 api，用于处理对我们的情感模型的请求。我们使用的是路径名“/情绪”。该函数读取 json 输入并将其转换为 pandas 数据帧。它从 json 中提取相关字段，并调用“get _ opinion _ DL”函数进行处理。“get _ opinion _ DL”函数包含已通过“hdf5”文件加载的训练模型。它最终将以 json result 的形式返回模型的结果。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="a2ff" class="mh mi iq nh b gy nl nm l nn no"># main API code<br/><a class="ae kv" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route(‘/sentiment’, methods=[‘POST’])<br/>def sentiment():<br/>   if request.method == ‘POST’:<br/>   text_data = pd.DataFrame(request.json)<br/>   text_out = get_sentiment_DL(prd_model, text_data, word_idx)<br/> <br/>   text_out = text_out[[‘ref’,’Sentiment_Score’]]</span><span id="465f" class="mh mi iq nh b gy np nm l nn no">   #Convert df to dict and then to Json<br/>   text_out_dict = text_out.to_dict(orient=’records’)<br/>   text_out_json = json.dumps(text_out_dict, ensure_ascii=False)</span><span id="ed4b" class="mh mi iq nh b gy np nm l nn no">   return text_out_json</span></pre><p id="b69a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第五步</strong>:详细的模型处理步骤将由“get _ sensation _ DL”函数执行。在我们的深度学习情感模型中，我们通过了:</p><ol class=""><li id="31da" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">best_model:加载的模型</li></ol><p id="58ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.text_data:用于情感分类的输入文本</p><p id="f604" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.word_idx:手套文件中的 word 索引(型号详情<a class="ae kv" rel="noopener" target="_blank" href="/sentiment-analysis-for-text-with-deep-learning-2f0a0c6472b5">此处</a>)。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="91a9" class="mh mi iq nh b gy nl nm l nn no">def get_sentiment_DL(best_model, text_data, word_idx):</span><span id="e422" class="mh mi iq nh b gy np nm l nn no">'''Modle Processing'''</span><span id="991d" class="mh mi iq nh b gy np nm l nn no"> return sentiment_score</span></pre><p id="ec7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第 6 步:</strong>添加下面的部分来运行应用程序。这里<strong class="ky ir">主机</strong>被设置为“0.0.0.0 ”,因为我们在本地服务器上托管。但是，您可以根据您的网络设置对其进行配置。<strong class="ky ir">调试</strong>可以在构建 API 功能时设置为真。<strong class="ky ir">端口</strong>设置为 5005，但是这可以根据您的要求进行配置。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="03a0" class="mh mi iq nh b gy nl nm l nn no">if __name__ == “__main__”:<br/>  app.run(host=”0.0.0.0", debug=False, port=5005)</span></pre><h2 id="e013" class="mh mi iq bd mj mk ml dn mm mn mo dp mp lf mq mr ms lj mt mu mv ln mw mx my mz bi translated">运行 API</h2><p id="3a71" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">要运行 API，请打开命令行窗口并转到存储代码的目录。通过运行下面的命令<em class="mb">来运行 python 脚本(“情绪. py”是上面的 API 实现的文件名)。</em></p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="84ab" class="mh mi iq nh b gy nl nm l nn no">python sentiment.py</span></pre><p id="3f2a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行上述命令时，您将能够在命令行窗口中看到以下结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/c8f16d8707795811b2c3a1f8785d05ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*HDRS4dLpC0gUU2imN5cm2g.png"/></div></figure><p id="a659" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API 运行后，您可以在浏览器中输入“0.0.0.0:5005/apitest”来测试 API。你将会在你的浏览器中得到下面的结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/b26819743773500a993ef74ea7bac352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*3RV4pbnY9LNeMcBVwxXLvQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Browser — API Test</figcaption></figure><p id="5695" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您可以使用 python 将任何数据传递给 API，如下所示。我们这里的地址是“<a class="ae kv" href="https://www.seelabs.app/face_rec_train'" rel="noopener ugc nofollow" target="_blank">http://0 . 0 . 0 . 0:5005/情操</a>”。模型的结果将被返回并存储在“响应”字段中。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="6ce8" class="mh mi iq nh b gy nl nm l nn no">import requests<br/>import json<br/>import urllib.parse</span><span id="8970" class="mh mi iq nh b gy np nm l nn no">data_json = '''{"ref":[1], "text":["I am well"]}'''</span><span id="61fc" class="mh mi iq nh b gy np nm l nn no">head= {“Content-type”: “application/json”}</span><span id="18ab" class="mh mi iq nh b gy np nm l nn no">response = requests.post(‘<a class="ae kv" href="https://www.seelabs.app/face_rec_train'" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:5005/sentiment'</a>, json = data_json, headers = head)</span><span id="8714" class="mh mi iq nh b gy np nm l nn no">result = response.content.decode(‘utf8’)</span></pre><h2 id="b469" class="mh mi iq bd mj mk ml dn mm mn mo dp mp lf mq mr ms lj mt mu mv ln mw mx my mz bi translated">结论</h2><p id="c5b7" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">总之，我们已经介绍了将模型部署到本地计算机的 api 服务中的步骤。</p><p id="aaa7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一步是将它作为微服务部署在云服务器中。在接下来的博客中，我将介绍 docker 等容器服务的使用，并在 AWS 中部署它。</p></div></div>    
</body>
</html>