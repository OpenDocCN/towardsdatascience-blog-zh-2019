<html>
<head>
<title>How to analyze A/B Testing result with python?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 python 分析 A/B 测试结果？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-analyze-a-b-testing-result-with-python-600eea37530d?source=collection_archive---------17-----------------------#2019-07-02">https://towardsdatascience.com/how-to-analyze-a-b-testing-result-with-python-600eea37530d?source=collection_archive---------17-----------------------#2019-07-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="03a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">这是书中的一个数据挑战案例:</em> <a class="ae kp" href="https://datamasked.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ko">《数据科学带回家的挑战集锦》。</em> </a> <em class="ko">数据集可以在上面的网站购买，本文只讲解决方案和 python 技巧。所有代码都在我的</em> <a class="ae kp" href="https://github.com/vertigo-yl/DS-take-home-Challenge/blob/master/02.AB_Testing.ipynb" rel="noopener ugc nofollow" target="_blank"> <em class="ko"> Github 上。</em>T11】</a></p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/6d8870967ef5d764878d93c5b9ccc17c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GsFrVpIeWqm2QDkv2dqdbA.png"/></div></div></figure><h1 id="5806" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">1.实验概述</h1><p id="4977" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">XYZ 公司是一个全球性的电子商务网站，提供网站的本地化版本。XYZ 的一位数据科学家注意到，西班牙用户的转化率比任何其他西班牙语国家都高。</p><p id="e38e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">他们认为一个原因可能是翻译。所有说西班牙语的国家都有一个西班牙人写的网站的相同翻译。他们同意尝试一个测试，每个国家都有一个由本地人写的翻译。</p><p id="3da9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，在他们进行测试后，他们真的很惊讶，因为测试是阴性的。也就是说，似乎非本地化翻译做得更好！</p><p id="f3b2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">试验性变更:非本地化到本地化翻译</strong></p><h1 id="32ff" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">2.数据分析</h1><p id="b741" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">看看这个数据框。</p><p id="4b6b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们有 12 列，分别是“用户标识”、“日期”、“来源”、“设备”、“浏览器语言”、“广告频道”、“浏览器”、“转换”、“测试”、“性别”、“年龄”、“国家”。</p><p id="c617" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所有来自西班牙的数据都在对照组。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi mf"><img src="../Images/2eba8abe894959d54345da78df8cb139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*soHPee3lg5sLlharGWgfkw@2x.png"/></div></div><figcaption class="mg mh gj gh gi mi mj bd b be z dk">data overview</figcaption></figure><h2 id="db2e" class="mk ld it bd le ml mm dn li mn mo dp lm kb mp mq lq kf mr ms lu kj mt mu ly mv bi translated">1)确认测试实际上是阴性的。</h2><p id="7617" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">首先，我们需要证明，在对照组中，西班牙在变革前的表现优于其他国家。</p><pre class="kr ks kt ku gt mw mx my mz aw na bi"><span id="3e98" class="mk ld it mx b gy nb nc l nd ne">groupby_country = data[data['test'] == 0][['conversion', 'country']].groupby('country').mean()<br/>groupby_country = groupby_country.reset_index()<br/>groupby_country = groupby_country.sort_values('conversion', ascending = <strong class="mx iu">False</strong> )<br/><br/><em class="ko"># Visualization</em><br/>fig, ax = plt.subplots(figsize=(18, 6))<br/>sns.barplot(x='country', y='conversion', data=groupby_country, ax=ax)<br/>plt.show()</span></pre><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nf"><img src="../Images/718caa21a0a974041291a9a9c6448e27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y_6J2zykxGj8h1rND9F3Eg.png"/></div></div></figure><p id="5c87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，我们需要确认非本地化翻译表现更好的实验结果，或者可以说，在除西班牙以外的国家，控制组比测试组做得更好</p><pre class="kr ks kt ku gt mw mx my mz aw na bi"><span id="cfba" class="mk ld it mx b gy nb nc l nd ne"><em class="ko"># Visualization <br/></em>fig, ax = plt.subplots(figsize=(18, 6))<br/>sns.barplot(x=’country’, y=’conversion’, hue=’test’, data=data, ax=ax)<br/>plt.show()</span></pre><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nf"><img src="../Images/ceda6c2144fb9ab0da0a64955c3607ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gnbw_RC3vX-wb9Egs4aFeg.png"/></div></div></figure><p id="6898" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并用统计学方法来证明。</p><pre class="kr ks kt ku gt mw mx my mz aw na bi"><span id="9404" class="mk ld it mx b gy nb nc l nd ne"><em class="ko"># A/B test</em><br/>test_data = data[data['country'] != 'Spain']<br/>test_val = test_data[test_data['test'] == 1]['conversion'].values<br/>cont_val = test_data[test_data['test'] == 0]['conversion'].values</span><span id="6412" class="mk ld it mx b gy ng nc l nd ne"><em class="ko"># Welch Two Sample t-test</em><br/>print(ttest_ind(test_val, cont_val, equal_var=<strong class="mx iu">False</strong>))</span></pre><p id="b172" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">ttest _ indResult(statistic =-7.3939374121344，pvalue=1.42829947540 e-13)</p><p id="c9c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">绝对正确。</p><p id="0921" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然而，我们可以看到，测试组的平均转化率为 0.0434，对照组为 0.0483，下降 10%，如果这是真的，那将是惊人的。所以我们需要深入研究。</p><h2 id="8a6c" class="mk ld it bd le ml mm dn li mn mo dp lm kb mp mq lq kf mr ms lu kj mt mu ly mv bi translated">2)解释为什么会发生这种情况。本地化的翻译真的很差吗？</h2><p id="426a" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">很可能，由于某种原因，一些用户更有可能进入测试或控制阶段，这部分用户的转化率明显高于/低于测试或控制阶段，这影响了整体结果。</p><p id="7f18" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只看西班牙以外国家的数据:(<em class="ko">Github 上更多图表)</em></p><ul class=""><li id="19d6" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">日期</li></ul><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nq"><img src="../Images/fa7e0384487fffe37a49e94eda143ed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RhXfxa2fhWspkBvngYwYFw.png"/></div></div></figure><ul class=""><li id="674c" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">sourse</li></ul><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nr"><img src="../Images/c37af3a291dcc5978e785edbd33294bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxTWPNMSoGbfPNulSpfhIw.png"/></div></div></figure><ul class=""><li id="c4a9" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">设备</li></ul><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nr"><img src="../Images/8f193ffee6d4dc5033948ee0c0f609cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QIx3m6Nnit5TM00OxmNy_A.png"/></div></div></figure><ul class=""><li id="28fb" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">语言</li></ul><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nr"><img src="../Images/25554e2c9bb4787750a06250ccc631df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zvTUpzuPdUb2ogm5frFFag.png"/></div></div></figure><ul class=""><li id="8b0f" class="nh ni it js b jt ju jx jy kb nj kf nk kj nl kn nm nn no np bi translated">国家</li></ul><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi ns"><img src="../Images/2e86a24e1f5b4cd3a6f80349f82f94d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*crlBVbdd-RywTn3OJKNE2Q.png"/></div></div></figure><p id="d3d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以看到，除了国家，所有测试组在其他细分领域的表现都比较差。所以仔细看看这个国家。</p><p id="5a2a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在理想的情况下，每个部分的测试和控制人员的分布应该是相同的。因此，我们可以使用<strong class="js iu">决策树</strong>来测试随机化是否有效，其中变量是用户维度，结果变量是用户是在测试中还是在控制中。</p><pre class="kr ks kt ku gt mw mx my mz aw na bi"><span id="a469" class="mk ld it mx b gy nb nc l nd ne"><strong class="mx iu">import</strong> <strong class="mx iu">h2o</strong><br/><strong class="mx iu">from</strong> <strong class="mx iu">h2o.frame</strong> <strong class="mx iu">import</strong> H2OFrame<br/><strong class="mx iu">from</strong> <strong class="mx iu">h2o.estimators</strong> <strong class="mx iu">import</strong> H2OGradientBoostingEstimator</span><span id="543a" class="mk ld it mx b gy ng nc l nd ne">h2o.init()<br/>h2o.remove_all()<br/><br/>h2o_df = H2OFrame(data)<br/>h2o_df['test'] = h2o_df['test'].asfactor()<br/>h2o_df['ads_channel'] = h2o_df['ads_channel'].asfactor()<br/>h2o_df.summary()</span><span id="7767" class="mk ld it mx b gy ng nc l nd ne">feature = ['user_id', 'date', 'source', 'device', 'browser_language',<br/>       'ads_channel', 'browser', 'sex', 'age',<br/>       'country']<br/>target = 'test'</span><span id="a183" class="mk ld it mx b gy ng nc l nd ne"><em class="ko"># Build random forest model</em><br/>model = H2OGradientBoostingEstimator(ntrees = 2, max_depth = 2)<br/>model.train(x=feature, y=target, training_frame=h2o_df)</span><span id="c77a" class="mk ld it mx b gy ng nc l nd ne">print(model)</span></pre><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nt"><img src="../Images/8b46adbd79dab9797d6bebc78d2f1370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D3UUnu4C5QCHOqzJNGDPAw@2x.png"/></div></div></figure><pre class="kr ks kt ku gt mw mx my mz aw na bi"><span id="dd55" class="mk ld it mx b gy nb nc l nd ne">data.groupby(['country','test']).size()</span><span id="94e1" class="mk ld it mx b gy ng nc l nd ne">=====================================</span><span id="16af" class="mk ld it mx b gy ng nc l nd ne">country      test<br/>Argentina    0        9356<br/>             1       37377<br/>Bolivia      0        5550<br/>             1        5574<br/>Chile        0        9853<br/>             1        9884<br/>Colombia     0       27088<br/>             1       26972<br/>Costa Rica   0        2660<br/>             1        2649<br/>Ecuador      0        8036<br/>             1        7859<br/>El Salvador  0        4108<br/>             1        4067<br/>Guatemala    0        7622<br/>             1        7503<br/>Honduras     0        4361<br/>             1        4207<br/>Mexico       0       64209<br/>             1       64275<br/>Nicaragua    0        3419<br/>             1        3304<br/>Panama       0        1966<br/>             1        1985<br/>Paraguay     0        3650<br/>             1        3697<br/>Peru         0       16869<br/>             1       16797<br/>Uruguay      0         415<br/>             1        3719<br/>Venezuela    0       16149<br/>             1       15905<br/>missing      0         245<br/>             1         209<br/>dtype: int64</span></pre><p id="cd3f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">阿根廷和乌拉圭加起来有 80%的测试和 20%的控制！随机化在这两个国家并不成功。</p><p id="2516" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们在控制国家之后检查测试结果。</p><pre class="kr ks kt ku gt mw mx my mz aw na bi"><span id="4765" class="mk ld it mx b gy nb nc l nd ne">countries = [name <strong class="mx iu">for</strong> name <strong class="mx iu">in</strong> data['country'].unique() <strong class="mx iu">if</strong> name <strong class="mx iu">is</strong> <strong class="mx iu">not</strong> np.nan]<br/><br/><strong class="mx iu">for</strong> country <strong class="mx iu">in</strong> countries:<br/>    test_val = data[(data['country'] == country) &amp; (data['test'] == 1)]['conversion'].values<br/>    cont_val = data[(data['country'] == country) &amp; (data['test'] == 0)]['conversion'].values<br/>    <br/>    test_mean = test_val.mean()<br/>    cont_mean = cont_val.mean()<br/>    p_val = ttest_ind(test_val, cont_val, equal_var=<strong class="mx iu">False</strong>).pvalue<br/>    <br/>    print('<strong class="mx iu">{0:15s}</strong> <strong class="mx iu">{1:15.5f}</strong> <strong class="mx iu">{2:15.5f}</strong> <strong class="mx iu">{3:10f}</strong>'.format(country, test_mean, cont_mean, p_val))</span></pre><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nu"><img src="../Images/560aae5159bf92b711c7e67fa8630c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7nmJyd6uJoRdlYtJmB2U8g@2x.png"/></div></div></figure><p id="b266" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我们对国家进行控制后，检验显然显得不显著。考虑到目标是提高转化率，这并不是一个很大的成功，但至少我们知道本地化的翻译没有让事情变得更糟！</p></div></div>    
</body>
</html>