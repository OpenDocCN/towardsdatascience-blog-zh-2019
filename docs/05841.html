<html>
<head>
<title>How to create a production-ready Recommender System</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建一个生产就绪的推荐系统</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-create-a-production-ready-recommender-system-3c932752f8ea?source=collection_archive---------2-----------------------#2019-08-26">https://towardsdatascience.com/how-to-create-a-production-ready-recommender-system-3c932752f8ea?source=collection_archive---------2-----------------------#2019-08-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="15ec" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我们每天在网上看到很多东西。但是你知道有多少其他的东西我们还没有看到吗？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/08aff2b65483103adaac044d845df75e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fz6RaSCxHGPzktRo"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@syinq?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Susan Yin</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="58cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能每天都会看到电子商务网站。或者阅读大量博客、新闻和媒体出版物上的文章。</p><p id="f34a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从你作为用户或读者的角度来看，看所有这些东西时，常见的痛点是什么？</p><p id="17a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个简单的答案:</p><p id="3d2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有很多东西可以看，当你试图发现一些东西的时候，你经常会迷失方向。</p><p id="a0b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，这些网站上有大量的东西或文章，用户需要一个解决方案来简化他们的发现之旅。</p><p id="88c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你是运营电商网站或者博客的，也许你想问。何必呢？</p><p id="3e14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，你听说过<strong class="lb iu">漏斗</strong>吗？</p><p id="37a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用户在尝试做某件事的时候漏斗越少，转化就越大。这是用户体验的基本规则。那么，<strong class="lb iu">如果减少步骤数量可以增加你的网站页面浏览量甚至收入，为什么不呢？</strong></p><p id="96e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想阅读更多关于推荐系统或深度学习的一般内容，可以在这里<a class="ae ky" href="https://www.verifysuper.com/filelockers/?id=23f9913377e0ced1b7b1f7664df6bb86" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">下载免费书籍</strong> </a>。</p><h1 id="012e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">推荐系统能有什么帮助？</h1><p id="859e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">简单来说，<strong class="lb iu">推荐系统就是一个发现系统</strong>。系统从数据中学习并向用户提供建议。无需用户专门搜索该项目，该项目由系统自动带来。</p><p id="a3a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">听起来很神奇。</p><p id="4851" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">亚马逊和网飞从几十年前就开始使用这种魔法。</p><p id="0971" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你打开 Spotify 时，它已经给了你一个听歌曲的列表(发现周刊，我惊讶于它如何能挑选我从未听过的歌曲，我喜欢它)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/bc9921f923058c0a748059d9a4b7a8ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FWD9HM3HD-FABSKk"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@samuelzeller?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Samuel Zeller</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="6bb1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">关于推荐系统的深入探讨</h1><p id="8a96" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">一般来说，有两种推荐系统被我们人类所知。嗯，不全是人类。</p><h2 id="a209" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">1.基于内容的过滤</h2><p id="8274" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这种推荐系统很容易被我们的大脑所消化。没有短路或爆炸的迹象。</p><p id="d89a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，你是一个狂热的小说读者。你喜欢阿加莎·克里斯蒂的《然后就没有了》。你从网上书店买的。</p><p id="dba3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果下次你打开网站，书店会给你看“美国广播公司谋杀案”，这是有道理的。</p><p id="59ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么？</p><p id="80cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为它们都是阿加莎·克里斯蒂写的。</p><p id="4ee9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，基于内容的过滤模型会向您推荐该标题。</p><p id="e650" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">哇，这么容易！让我们利用这一点！</strong></p><p id="9401" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">等等…</p><p id="e28f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然基于内容的过滤很容易被我们的大脑消化，而且看起来很简单，但它无法猜测用户的真实行为。</p><p id="a5e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我不喜欢赫丘里·波罗，但我喜欢她小说中的其他侦探。在这种情况下，“ABC 谋杀案”不应该推荐给我。</p><h2 id="e6c4" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">2.协同过滤</h2><p id="703a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这种类型将克服前面的问题。本质上，该系统记录了用户在网站上的所有先前的交互。并在此基础上提供建议。</p><p id="4491" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它是如何工作的？</p><p id="33eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看一下这个场景。</p><p id="011c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">有两个用户 A 和 b。</strong></p><p id="f8c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">购买的项目 1</p><p id="8f0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">购买的项目 2</p><p id="277c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">购买的项目 3</p><p id="9444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">b 购买的项目 1</p><p id="4330" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">b 购买的项目 3</p><p id="4c26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">协同过滤<strong class="lb iu">将推荐 B 项目 2 </strong>，因为有另一个购买了项目 1 和 3 的用户也购买了项目 2。</p><p id="bb33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能会说，哇，它们可能是偶然凑巧一起买的。</p><p id="8ed8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，如果，有 100 个用户和用户 A 有同样的行为呢？</p><p id="1541" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是所谓的<strong class="lb iu">，群体的力量</strong>。</p><p id="ec5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，为什么要等呢？让我们开始在您的生产环境中创建协作过滤系统吧！</p><p id="d890" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">别冲动，伙计！</p><p id="b8f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然它的性能非常好。它有几个严重的问题。更重要的是，当您试图创建一个生产就绪的系统时。</p><h1 id="1c0c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">协同过滤的缺点</h1><ol class=""><li id="65ac" class="nf ng it lb b lc mn lf mo li nh lm ni lq nj lu nk nl nm nn bi translated">它不知道上下文。与推荐相似项目的基于内容的过滤相比，协同过滤不会基于相似性进行推荐。如果这是您关心的问题，那么解决方案就是混合动力。结合两种方法。</li><li id="d317" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">它需要大量的硬件资源，因为你需要存储一个用户条目矩阵。想象一下，如果你打开你的电子商务网站，它有 10 万用户。同时，你提供 10K 产品。在这种情况下，您将需要 10K x 100K 矩阵，其中每个元素包含 4 个字节的整数。是的，你需要 4GB 的内存来存储矩阵。甚至不做其他事情。</li><li id="ecd1" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">冷启动。一个新用户不会从系统中得到任何好处，因为你不了解他。</li><li id="6ee9" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">不可改变的。如果你没有在网站上做任何事情，推荐系统的结果将保持不变。用户会认为网站上没有什么新东西。他们会离开。</li></ol><p id="3a0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然第一个问题很容易通过混合动力解决，但其他问题仍然令人头疼。</p><p id="3b28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，解决数字 2，3，4 是这篇文章的原因。</p><p id="2f36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="21e3" class="lv lw it bd lx ly oa ma mb mc ob me mf jz oc ka mh kc od kd mj kf oe kg ml mm bi translated">让您的推荐系统投入生产的明确指南</h1><p id="5ff8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我可能和你在同一个地方。我真的不知道如何让这件事成为可能。由于机器的限制，当然还有常识，我不能仅仅为了这个微小的需求就部署一个庞大的服务。</p><p id="3f24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，我偶然发现了这本书</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/ff37fb90a5119525722d3b6ef6bba017.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*SJ1CQjRZiIQDOXjmjd-yWA.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk"><a class="ae ky" href="https://mapr.com/practical-machine-learning/" rel="noopener ugc nofollow" target="_blank">Practical Machine Learning by Ted Dunning &amp; Ellen Friedman</a></figcaption></figure><p id="0435" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">他们告诉我，对于一个生产就绪的系统，您可能不希望它的性能达到最佳精度。</p><p id="0f58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个有些不准确但可接受的在现实世界中最常见的用例。</p><p id="59d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于如何做到这一点，最有趣的部分是，</p><ol class=""><li id="86ed" class="nf ng it lb b lc ld lf lg li og lm oh lq oi lu nk nl nm nn bi translated">一般推荐指标的批量计算。</li><li id="9f3f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">实时查询，不使用用户-项目矩阵，而是取用户最近的几次交互，查询到系统。</li></ol><p id="0b1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们建立系统的时候让我解释。</p><h1 id="b37f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">基于 Python 的推荐系统</h1><p id="fe73" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为什么是 python？嗯，python 是最容易学的语言之一。你只需要花几个小时就能理解语法。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="3ab6" class="mt lw it ok b gy oo op l oq or">for item in the_bag:<br/>    print(item)</span></pre><p id="12a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以打印包里的所有东西。</p><p id="6ba5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这么简单。</p><p id="7721" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">去<a class="ae ky" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank"> Python 网站</a>根据你的操作系统下载安装。</p><p id="555d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于本教程，您需要几个包</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="8476" class="mt lw it ok b gy oo op l oq or">pip install numpy<br/>pip install scipy<br/>pip install pandas<br/>pip install jupyter<br/>pip install requests</span></pre><p id="3cda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Numpy 和 Scipy 是处理数学计算的 python 包，你将需要它们用于矩阵。熊猫是用于你的数据。请求用于 http 调用。Jupyter 是一个交互式运行 python 代码的 web 应用程序。</p><p id="b237" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">键入<strong class="lb iu"> jupyter 笔记本</strong>，你会看到这样的内容</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/5b1f6e815b1163330c083e6a4d7b7506.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1MJ6rej7x1kl1VOYZlP6iQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Jupyter Notebook</figcaption></figure><p id="b5e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在提供的单元格上编写代码，代码将交互式运行。</p><p id="4067" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，你需要几个工具。</p><ol class=""><li id="bb3e" class="nf ng it lb b lc ld lf lg li og lm oh lq oi lu nk nl nm nn bi translated">弹性搜索。这是一个<a class="ae ky" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank">开源</a>搜索引擎，可以让你快速搜索你的文档。您将需要这个工具来保存您计算的指标，以便您可以实时查询。</li><li id="89ca" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a>。一个 API 开发工具。您将需要它来模拟对 elasticsearch 的查询。因为 elasticsearch 可以通过 http 访问。</li></ol><p id="bdbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下载并安装这两个软件，你就可以开始了。</p><h1 id="95e6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据</h1><p id="0e32" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">对于本教程，我们来看看 Kaggle 中的一个数据集。<a class="ae ky" href="https://www.kaggle.com/retailrocket/ecommerce-dataset" rel="noopener ugc nofollow" target="_blank"> Retailrocket 推荐系统数据集</a>。下载并提取 Jupyter 笔记本目录中的数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/3735aa1f2a094cfa644042b2677f34ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*HrrI88cytgjZGWUVbvZMpA.jpeg"/></div></figure><p id="492c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应该是那样的。</p><p id="7c4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这些文件中，对于本教程，您只需要 events.csv。</p><p id="98f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该文件由用户对电子商务网站上的商品的数百万次操作组成。</p><h2 id="9cdb" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">让我们来探索数据！</h2><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="f457" class="mt lw it ok b gy oo op l oq or">import pandas as pd<br/>import numpy as np</span></pre><p id="d56b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 Jupyter 笔记本上写下那些进口货。你已经准备好了。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="42c0" class="mt lw it ok b gy oo op l oq or">df = pd.read_csv('events.csv')<br/>df.shape</span></pre><p id="7c13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它会打印你(2756101，5)。这意味着你有 270 万行 5 列。</p><p id="a0ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们去看看。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="0938" class="mt lw it ok b gy oo op l oq or">df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/b945741f69d24afd16f8cb5c7ed2b04a.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*vUodt7K0BZay7U8WWq9dag.jpeg"/></div></figure><p id="58eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它有五列。</p><ol class=""><li id="a728" class="nf ng it lb b lc ld lf lg li og lm oh lq oi lu nk nl nm nn bi translated">时间戳，事件的时间戳。</li><li id="0cd3" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">Visitorid，用户的 id</li><li id="a6f2" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">Itemid，项目的 id</li><li id="6b30" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">事件，事件</li><li id="9413" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">Transactionid，如果事件是事务，则为事务的 id</li></ol><p id="6bd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们查一下，有什么样的活动</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="01a4" class="mt lw it ok b gy oo op l oq or">df.event.unique()</span></pre><p id="c7d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将得到三个事件，<em class="ov">视图</em>、<em class="ov">添加到图表</em>和<em class="ov">事务</em></p><p id="b2e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，您可能不想玩所有的事件。对于本教程，您将只玩事务。</p><p id="4ee0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，让我们只过滤事务。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="e4f2" class="mt lw it ok b gy oo op l oq or">trans = df[df['event'] == 'transaction']<br/>trans.shape</span></pre><p id="7769" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将返回(22457，5)</p><p id="e656" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你将有 22K 的交易可以玩。我认为对于我们这样的新手来说已经足够好了。</p><p id="d134" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们进一步看看这些数据</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="7d15" class="mt lw it ok b gy oo op l oq or">visitors = trans['visitorid'].unique()<br/>items = trans['itemid'].unique()</span><span id="6c48" class="mt lw it ok b gy ow op l oq or">print(visitors.shape)<br/>print(items.shape)</span></pre><p id="b2ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将获得 11，719 个独特的访问者和 12，025 个独特的项目。</p><p id="575b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建简单而有效的推荐系统的经验法则是在不损失质量的情况下对数据进行下采样。这意味着，你可以为每个用户只取 50 个最新的交易，你仍然可以得到你想要的质量，因为行为会随着时间的推移而改变。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="27b5" class="mt lw it ok b gy oo op l oq or">trans2 = trans.groupby(['visitorid']).head(50)<br/>trans2.shape</span></pre><p id="7b31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你只有 19939 笔交易。意味着大约有 2K 个事务被废弃。</p><p id="613f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为访问者 id 和项目 id 是巨大的数字，你将很难记住每一个 id。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="3ae1" class="mt lw it ok b gy oo op l oq or">trans2['visitors'] = trans2['visitorid'].apply(lambda x : np.argwhere(visitors == x)[0][0])<br/>trans2['items'] = trans2['itemid'].apply(lambda x : np.argwhere(items == x)[0][0])</span><span id="25ba" class="mt lw it ok b gy ow op l oq or">trans2</span></pre><p id="9edf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要其他基于 0 的索引列。你会看到这样的东西。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/5207957e7d36f8d5177e89fcfd53de95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*JXMBivkNpTDoAQ0AoDgwVg.jpeg"/></div></figure><p id="36cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更干净。现在，在接下来的所有步骤中，您可以只使用访问者和项目列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/cbb29971f4efc29163f1c154a1d9bf2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WwSyt7O32WPMHJxE"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@andreilazarev?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Andrei Lazarev</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="75c4" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">下一步:创建用户-项目矩阵</h2><p id="0377" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">噩梦来了…</p><p id="e29b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你有 11，719 个独立访问者和 12，025 个条目，所以你需要大约 500MB 的内存来存储这个矩阵。</p><p id="33c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">稀疏矩阵来拯救。</p><p id="1885" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">稀疏矩阵是大部分元素为零的矩阵。这是有意义的，因为不是所有的用户都购买所有的商品。连接的批次将为零。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="f7b4" class="mt lw it ok b gy oo op l oq or">from scipy.sparse import csr_matrix</span></pre><p id="a6c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">西皮有这个东西。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="dd8d" class="mt lw it ok b gy oo op l oq or">occurences = csr_matrix((visitors.shape[0], items.shape[0]), dtype='int8')</span><span id="bc5e" class="mt lw it ok b gy ow op l oq or">def set_occurences(visitor, item):<br/>    occurences[visitor, item] += 1</span><span id="3648" class="mt lw it ok b gy ow op l oq or">trans2.apply(lambda row: set_occurences(row['visitors'], row['items']), axis=1)</span><span id="f6d7" class="mt lw it ok b gy ow op l oq or">occurences</span></pre><p id="f37a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对数据中的每一行应用 set _ occurences 函数。</p><p id="a180" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它会打印出这样的内容</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="f18b" class="mt lw it ok b gy oo op l oq or">&lt;11719x12025 sparse matrix of type '&lt;class 'numpy.int8'&gt;'<br/>	with 18905 stored elements in Compressed Sparse Row format&gt;</span></pre><p id="6968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在矩阵中的 1.4 亿个单元中，只有 18905 个填充了非零值。</p><p id="d32b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以基本上你只需要把这 18，905 个值存储到内存中。效率提高了 99.99%。</p><p id="2ed2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">稀疏矩阵的缺点是，当试图实时检索数据时，它的计算量较高。所以，你不应该在这一步结束。</p><h2 id="55b0" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">同现是一个更好的现象</h2><p id="745e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我们构建一个商品-商品矩阵，其中每个元素表示用户一起购买这两种商品的次数。称之为共生矩阵。</p><p id="e808" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要创建一个共生矩阵，你需要将共生矩阵的转置矩阵和它本身进行点积。</p><p id="075e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我试过没有稀疏矩阵，我的电脑突然停止工作。所以，我们不要这样做。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="d796" class="mt lw it ok b gy oo op l oq or">cooc = occurences.transpose().dot(occurences)<br/>cooc.setdiag(0)</span></pre><p id="a95a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它立即完成了一个稀疏矩阵。我很开心。</p><p id="9224" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">setdiag 函数将对角线设置为 0，这意味着您不想计算项目 1 的值，因为项目 1 是同一个项目，所以它们会放在一起。</p><h2 id="51a1" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">反常行为更好</h2><p id="4fc5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">同现矩阵将由两个项目一起购买的次数组成。</p><p id="e396" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是有可能有一件物品。不管用户的行为如何，该商品都会被购买。可能是闪购之类的。</p><p id="94f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际上，你可能想要真正捕捉用户的行为，从类似闪购的东西中清理出来。因为这不是你所期望的行为。</p><p id="a23a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了去除那些受影响的东西，你需要在同现矩阵上扣分。</p><p id="7006" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">泰德·邓宁斯在之前的书里有一个算法叫做，<strong class="lb iu">对数似然比或 LLR。</strong></p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="71a0" class="mt lw it ok b gy oo op l oq or">def xLogX(x):<br/>    return x * np.log(x) if x != 0 else 0.0</span><span id="9fb7" class="mt lw it ok b gy ow op l oq or">def entropy(x1, x2=0, x3=0, x4=0):<br/>    return xLogX(x1 + x2 + x3 + x4) - xLogX(x1) - xLogX(x2) - xLogX(x3) - xLogX(x4)</span><span id="438c" class="mt lw it ok b gy ow op l oq or">def LLR(k11, k12, k21, k22):<br/>    rowEntropy = entropy(k11 + k12, k21 + k22)<br/>    columnEntropy = entropy(k11 + k21, k12 + k22)<br/>    matrixEntropy = entropy(k11, k12, k21, k22)<br/>    if rowEntropy + columnEntropy &lt; matrixEntropy:<br/>        return 0.0<br/>    return 2.0 * (rowEntropy + columnEntropy - matrixEntropy)</span><span id="50ea" class="mt lw it ok b gy ow op l oq or">def rootLLR(k11, k12, k21, k22):<br/>    llr = LLR(k11, k12, k21, k22)<br/>    sqrt = np.sqrt(llr)<br/>    if k11 * 1.0 / (k11 + k12) &lt; k21 * 1.0 / (k21 + k22):<br/>        sqrt = -sqrt<br/>    return sqrt</span></pre><p id="8190" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">LLR 函数计算两个事件 A 和 B 同时出现的可能性。</p><p id="eb35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些参数是，</p><ol class=""><li id="6425" class="nf ng it lb b lc ld lf lg li og lm oh lq oi lu nk nl nm nn bi translated">k11，两个事件同时出现的次数</li><li id="6cd3" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">k12，数 B 出现而无 A</li><li id="a990" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">k21，A 出现的次数没有 B 多</li><li id="3603" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">k22，其他一些东西出现的时候没有他们两个</li></ol><p id="27ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在计算 LLR 函数并保存到 pp_score 矩阵中。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="60f5" class="mt lw it ok b gy oo op l oq or">row_sum = np.sum(cooc, axis=0).A.flatten()<br/>column_sum = np.sum(cooc, axis=1).A.flatten()<br/>total = np.sum(row_sum, axis=0)</span><span id="7d8f" class="mt lw it ok b gy ow op l oq or">pp_score = csr_matrix((cooc.shape[0], cooc.shape[1]), dtype='double')<br/>cx = cooc.tocoo()<br/>for i,j,v in zip(cx.row, cx.col, cx.data):<br/>    if v != 0:<br/>        k11 = v<br/>        k12 = row_sum[i] - k11<br/>        k21 = column_sum[j] - k11<br/>        k22 = total - k11 - k12 - k21<br/>        pp_score[i,j] = rootLLR(k11, k12, k21, k22)</span></pre><p id="da93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对结果进行排序，使每个项目的最高 LLR 分数出现在每行的第一列。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="0878" class="mt lw it ok b gy oo op l oq or">result = np.flip(np.sort(pp_score.A, axis=1), axis=1)<br/>result_indices = np.flip(np.argsort(pp_score.A, axis=1), axis=1)</span></pre><h2 id="b10e" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">指标，如何推荐</h2><p id="dd93" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">结果矩阵上的第一个项目，如果足够高，可以被认为是该项目的指示器。</p><p id="af91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看其中的一个结果</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="b4ec" class="mt lw it ok b gy oo op l oq or">result[8456]</span></pre><p id="7428" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会得到</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="b6ec" class="mt lw it ok b gy oo op l oq or">array([15.33511076, 14.60017668,  3.62091635, ...,  0.        ,<br/>        0.        ,  0.        ])</span></pre><p id="9400" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看看这些指数</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="3a4b" class="mt lw it ok b gy oo op l oq or">result_indices[8456]</span></pre><p id="79e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">会抓到你</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="7a42" class="mt lw it ok b gy oo op l oq or">array([8682,  380, 8501, ..., 8010, 8009,    0], dtype=int64)</span></pre><p id="27d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以有把握地回答，对于高数量 LLR 分数，项目 8682 和 380 可以是项目 8456 的指示符。而项目 8501 由于分数没有那么大，可能不是项目 8456 的指示符。</p><p id="6632" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">意思是，如果有人买了 8682 和 380，你可以推荐他 8456。</p><p id="9245" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">容易。</strong></p><p id="5741" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，根据经验法则，您可能希望对 LLR 分数进行一些限制，这样无关紧要的指标将被删除。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="b8dd" class="mt lw it ok b gy oo op l oq or">minLLR = 5<br/>indicators = result[:, :50]<br/>indicators[indicators &lt; minLLR] = 0.0</span><span id="89e5" class="mt lw it ok b gy ow op l oq or">indicators_indices = result_indices[:, :50]</span><span id="7306" class="mt lw it ok b gy ow op l oq or">max_indicator_indices = (indicators==0).argmax(axis=1)<br/>max = max_indicator_indices.max()</span><span id="6cf1" class="mt lw it ok b gy ow op l oq or">indicators = indicators[:, :max+1]<br/>indicators_indices = indicators_indices[:, :max+1]</span></pre><p id="7e0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你已经准备好把它们放在一起进行 elasticsearch 了。所以可以实时查询推荐。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="ea68" class="mt lw it ok b gy oo op l oq or">import requests<br/>import json</span></pre><p id="5199" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，现在你准备好把东西放进你之前准备好的 elasticsearch 里面了。</p><p id="effd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，要小心。如果你试图使用/_create/ <id> API 一个一个地添加数据，那将花费你很长时间。当然，你可以，但是你可能需要半个小时到一个小时才能将我们的 12，025 个项目移动到 elasticsearch 中。</id></p><p id="0017" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我做过一次，所以请不要重复我的错误。</p><p id="e81d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么解决办法是什么呢？</p><h2 id="621e" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">批量更新</h2><p id="47ed" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">幸运的是，elasticsearch 有 bulk API，可以很容易地一次发送多个文档。</p><p id="fbd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，创建一个新的索引(items2，我在前面的错误中使用了 items ),让我们尝试一下</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="abc9" class="mt lw it ok b gy oo op l oq or">actions = []<br/>for i in range(indicators.shape[0]):<br/>    length = indicators[i].nonzero()[0].shape[0]<br/>    real_indicators = items[indicators_indices[i, :length]].astype("int").tolist()<br/>    id = items[i]<br/>    <br/>    action = { "index" : { "_index" : "items2", "_id" : str(id) } }<br/>    <br/>    data = {<br/>        "id": int(id),<br/>        "indicators": real_indicators<br/>    }<br/>    <br/>    actions.append(json.dumps(action))<br/>    actions.append(json.dumps(data))<br/>    <br/>    if len(actions) == 200:<br/>        actions_string = "\n".join(actions) + "\n"<br/>        actions = []<br/>        <br/>        url = "<a class="ae ky" href="http://127.0.0.1:9200/_bulk/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:9200/_bulk/</a>"<br/>        headers = {<br/>            "Content-Type" : "application/x-ndjson"<br/>        }<br/>        requests.post(url, headers=headers, data=actions_string)</span><span id="5afe" class="mt lw it ok b gy ow op l oq or">if len(actions) &gt; 0:<br/>    actions_string = "\n".join(actions) + "\n"<br/>    actions = []</span><span id="1073" class="mt lw it ok b gy ow op l oq or">    url = "<a class="ae ky" href="http://127.0.0.1:9200/_bulk/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:9200/_bulk/</a>"<br/>    headers = {<br/>        "Content-Type" : "application/x-ndjson"<br/>    }<br/>    requests.post(url, headers=headers, data=actions_string)</span></pre><p id="fabc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧，它将在几秒钟内完成。</p><p id="2515" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在邮递员中点击这个 API</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="1059" class="mt lw it ok b gy oo op l oq or">127.0.0.1:9200/items2/_count</span></pre><p id="a3a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您已经存储了您的数据</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="c0ab" class="mt lw it ok b gy oo op l oq or">{<br/>    "count": 12025,<br/>    "_shards": {<br/>        "total": 1,<br/>        "successful": 1,<br/>        "skipped": 0,<br/>        "failed": 0<br/>    }<br/>}</span></pre><p id="adc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用/items2/240708 检查你的项目数据</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="5ca8" class="mt lw it ok b gy oo op l oq or">{<br/>    "id": 240708,<br/>    "indicators": [<br/>        305675,<br/>        346067,<br/>        312728<br/>    ]<br/>}</span></pre><p id="79e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Id 是项目的 id。而指标是成为推荐该项目的指标的其他项目。</p><h2 id="7d89" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">实时查询</h2><p id="62cd" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们创造的最好的部分是实时查询，</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="8354" class="mt lw it ok b gy oo op l oq or">{<br/>  "query": {<br/>    "bool": {<br/>     "should": [<br/>      { "terms": {"indicators" : [240708], "boost": 2}}<br/>     ]<br/>    }<br/>  }<br/>}</span></pre><p id="7ac8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将请求发送到<em class="ov">127 . 0 . 0 . 1:9200/items 2/_ search</em></p><p id="e972" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会得到三个结果。312728、305675 和 346067。与 240708 号物品一起购买的三件物品。</p><p id="55fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！所以，需要大量资源的问题现在已经不是问题了。那么，另外两个问题呢？</p><p id="ad53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在那之前，让你的眼睛休息一会儿。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/bbffbae46a195d443013f2137abc01c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fX8TzZR53YH2S7b-"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@seantookthese?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sean O.</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="09a5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">冷启动问题:我不认识你</h1><p id="d321" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">构建推荐系统时最常见的问题是冷启动问题。每个新用户都不会在系统中记录他们的任何行为。</p><p id="f37b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，系统应该给他们推荐什么呢？</p><p id="caba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看我们最近建立的推荐系统。你认为结果有什么奇怪的吗？</p><p id="da19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，结果只返回 3 个推荐的项目。就三个。您计划如何向客户展示？</p><p id="7d80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们在列表末尾显示另一个不推荐的项目。只是为了用户体验好。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="4724" class="mt lw it ok b gy oo op l oq or">{<br/>  "query": {<br/>    "bool": {<br/>     "should": [<br/>      { "terms": {"indicators" : [240708]}},<br/>      { "constant_score": {"filter" : {"match_all": {}}, "boost" : 0.000001}}<br/>     ]<br/>    }<br/>  }<br/>}</span></pre><p id="0f3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用常数分数来返回所有其他项目。</p><p id="6080" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，对于所有不推荐的项目，您需要对它们进行排序，以便用户可能会喜欢的东西，即使没有在他们的行为中捕捉到。</p><p id="d7cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很多情况下，<strong class="lb iu">热门单品</strong>确实很好用。</p><p id="0897" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你如何计算一个受欢迎的项目？</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="9713" class="mt lw it ok b gy oo op l oq or">popular = np.zeros(items.shape[0])</span><span id="040d" class="mt lw it ok b gy ow op l oq or">def inc_popular(index):<br/>    popular[index] += 1</span><span id="8c36" class="mt lw it ok b gy ow op l oq or">trans2.apply(lambda row: inc_popular(row['items']), axis=1)</span></pre><p id="8ffc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单，一件一件数物品外观。所以人气值最高的就是最受欢迎的。</p><p id="d906" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建另一个名为 items3 的索引。和批量插入</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="90c2" class="mt lw it ok b gy oo op l oq or">actions = []<br/>for i in range(indicators.shape[0]):<br/>    length = indicators[i].nonzero()[0].shape[0]<br/>    real_indicators = items[indicators_indices[i, :length]].astype("int").tolist()<br/>    id = items[i]<br/>    <br/>    action = { "index" : { "_index" : "items3", "_id" : str(id) } }<br/>    <br/>#     url = "<a class="ae ky" href="http://127.0.0.1:9200/items/_create/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:9200/items/_create/</a>" + str(id)<br/>    data = {<br/>        "id": int(id),<br/>        "indicators": real_indicators,<br/>        "popular": popular[i]<br/>    }<br/>    <br/>    actions.append(json.dumps(action))<br/>    actions.append(json.dumps(data))<br/>    <br/>    if len(actions) == 200:<br/>        actions_string = "\n".join(actions) + "\n"<br/>        actions = []<br/>        <br/>        url = "<a class="ae ky" href="http://127.0.0.1:9200/_bulk/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:9200/_bulk/</a>"<br/>        headers = {<br/>            "Content-Type" : "application/x-ndjson"<br/>        }<br/>        requests.post(url, headers=headers, data=actions_string)</span><span id="59dc" class="mt lw it ok b gy ow op l oq or">if len(actions) &gt; 0:<br/>    actions_string = "\n".join(actions) + "\n"<br/>    actions = []</span><span id="221f" class="mt lw it ok b gy ow op l oq or">url = "<a class="ae ky" href="http://127.0.0.1:9200/_bulk/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:9200/_bulk/</a>"<br/>    headers = {<br/>        "Content-Type" : "application/x-ndjson"<br/>    }<br/>    requests.post(url, headers=headers, data=actions_string)</span></pre><p id="984e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个索引阶段，您包括热门领域。所以，你的数据会像这样</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="ad8c" class="mt lw it ok b gy oo op l oq or">{<br/>    "id": 240708,<br/>    "indicators": [<br/>        305675,<br/>        346067,<br/>        312728<br/>    ],<br/>    "popular": 3.0<br/>}</span></pre><p id="90e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将有三个字段。Id 和指标像上一个，热门领域。用户购买商品的数量。</p><p id="fa95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们将 popular 添加到前面的查询中。</p><h2 id="8ff0" class="mt lw it bd lx mu mv dn mb mw mx dp mf li my mz mh lm na nb mj lq nc nd ml ne bi translated">函数分数，组合分数的方式</h2><p id="7ec3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">那么，你现在有多个分数来源，即指标匹配和热门，如何组合分数？</p><p id="98ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch 具有与此相关的功能评分。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="9ce2" class="mt lw it ok b gy oo op l oq or">{<br/>  "query": {<br/>    "function_score":{<br/>     "query": {<br/>      "bool": {<br/>       "should": [<br/>        { "terms": {"indicators" : [240708], "boost": 2}},<br/>        { "constant_score": {"filter" : {"match_all": {}}, "boost" : 0.000001}}<br/>       ]<br/>      }<br/>    },<br/>     "functions":[<br/>      {<br/>       "filter": {"range": {"popular": {"gt": 0}}},<br/>       "script_score" : {<br/>                 "script" : {<br/>                   "source": "doc['popular'].value * 0.1"<br/>                 }<br/>             }<br/>      }<br/>     ],<br/>     "score_mode": "sum",<br/>     "min_score" : 0<br/>    }<br/>  }<br/>}</span></pre><p id="dd69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">重做您的查询，并添加一个函数分数，将上面的常量分数稍微增加 0.1 倍。您不必坚持使用 0.1，您可以使用其他函数，甚至是自然对数。像这样，</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="844f" class="mt lw it ok b gy oo op l oq or">Math.log(doc['popular'].value)</span></pre><p id="c019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您将看到您最受欢迎的项目 461686 位于第四位，就在推荐项目的下方。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/4f5c3cc26ab37000ae34b3d407e8233b.png" data-original-src="https://miro.medium.com/v2/resize:fit:438/format:webp/1*tyqOWlAPRY-rs-Xa0XBaew.jpeg"/></div></figure><p id="d229" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面还有其他受欢迎的项目。</p><h1 id="eae2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">不变的静态推荐</h1><p id="5639" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如您所见，每次运行实时查询时，我们的结果都保持不变。这可能是好的，因为我们的技术是可重复的，但同时，用户可能会不高兴。</p><p id="988c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">书中的泰德·邓宁斯说，<strong class="lb iu">推荐的点击率，在第 20 个结果之后会下降得很低。</strong>这意味着我们在此之后推荐的任何项目都不会被用户知道。</p><p id="0336" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个怎么解决？</p><p id="48cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一种技术叫做抖动。当查询显示最不推荐的项目，但仍然将强烈推荐的项目放在顶部时，这是在制造随机噪音。</p><pre class="kj kk kl km gt oj ok ol om aw on bi"><span id="3a93" class="mt lw it ok b gy oo op l oq or">{<br/>  "query": {<br/>    "function_score":{<br/>     "query": {<br/>      "bool": {<br/>       "should": [<br/>        { "terms": {"indicators" : [240708], "boost": 2}},<br/>        { "constant_score": {"filter" : {"match_all": {}}, "boost" : 0.000001}}<br/>       ]<br/>      }<br/>    },<br/>     "functions":[<br/>      {<br/>       "filter": {"range": {"popular": {"gt": 1}}},<br/>       "script_score" : {<br/>                 "script" : {<br/>                   "source": "0.1 * Math.log(doc['popular'].value)"<br/>                 }<br/>             }<br/>      },<br/>      {<br/>       "filter": {"match_all": {}},<br/>       "random_score": {}<br/>      }<br/>     ],<br/>     "score_mode": "sum",<br/>     "min_score" : 0<br/>    }<br/>  }<br/>}</span></pre><p id="3fa1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随机评分，<strong class="lb iu">它会给你所有的物品均匀分布随机噪音</strong>。分数会很小，所以最高推荐不会下降。</p><p id="b325" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击查询，并查看结果。你可以看到</p><p id="0bfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">积极的一面是。您的用户将不必滚动到第二或第三页。他或她只需要点击浏览器上的刷新按钮，就会有新的内容提供给他或她。</p><p id="077b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就像魔法一样。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/50ffca22d233d8e642dd088c4b413236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1-kNj3gI355kwsdH"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@marvelous?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Marvin Meyer</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="20b1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="ca3d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">构建一个生产就绪的推荐系统并不难。目前的技术允许我们这样做。</p><p id="dcf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用您的数据创建系统，并准备将其部署到生产环境中。</p><p id="c26a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，你可以从这个<a class="ae ky" href="https://thedatamage.com/best-course-for-ai-2019-updated/" rel="noopener ugc nofollow" target="_blank">人工智能的最佳课程</a>中学习人工智能</p><p id="b2af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">干杯！</p></div></div>    
</body>
</html>