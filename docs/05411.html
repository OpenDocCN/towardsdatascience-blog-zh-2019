<html>
<head>
<title>Finding top programming language with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 BigQuery 寻找顶级编程语言</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/finding-top-programming-language-with-bigquery-dbe96d463d99?source=collection_archive---------19-----------------------#2019-08-10">https://towardsdatascience.com/finding-top-programming-language-with-bigquery-dbe96d463d99?source=collection_archive---------19-----------------------#2019-08-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/6d1b12587dbe88e10db4d35fa6017e4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yy0E7AlNR-bNHPMMU7re5Q.png"/></div></div></figure><p id="3417" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你一直关注谷歌的云平台，你对 BigQuery 并不陌生。在我看来，BigQuery 是谷歌武库中最具差异化的工具。凭借 Pb 级的仓储能力、数百个开源数据集和熟悉的 SQL 接口，开发人员的准入门槛非常低。</p><p id="ee60" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">上周，我在浏览 BigQuery 中的公开数据集时，碰巧发现了 Github 的数据集。它有提交数据、编程语言数据、存储库内容数据和许多其他酷表。</p><p id="ac3a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在浏览了整个数据集之后，我可以想到很多分析查询，我可以在数据集上运行这些查询来获得一些天才的见解。例如，我可以使用存储库内容数据集来找出最流行的 Java 包，使用提交数据集我可以找出哪个作者提交了最多的提交，或者我可以使用语言数据集来根据存储库计数找出顶级编程语言(这恰好是本文的主题)。</p><p id="7829" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在回答这个有名无实的问题时，我们将学习 BigQuery 中的三个概念。</p><ol class=""><li id="88e3" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">UNNEST()和重复数据类型</li><li id="3287" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">窗口和 Rank()函数</li><li id="3f8e" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">命名子查询</li></ol><h1 id="2fa2" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">设置</h1><p id="25de" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">首先让我们将数据集添加到我们的 BigQuery 控制台。在 GCP web 控制台中导航到 BigQuery。</p><p id="ccb4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在左侧面板上点击<em class="mr">添加数据&gt;锁定项目。</em></p><p id="48cd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">输入项目名称<strong class="kd iu"> bigquery-public-data </strong>。点击<em class="mr"> pin </em>，你应该会看到项目被固定在窗格中。</p><p id="18c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您也可以转到数据集页面<a class="ae kz" href="https://console.cloud.google.com/marketplace/details/github/github-repos?filter=solution-type:dataset&amp;q=github&amp;id=46ee22ab-2ca4-4750-81a7-3ee0f0150dcb" rel="noopener ugc nofollow" target="_blank">这里</a>并点击查看数据集，这也应该会将项目添加到您的 BigQuery 仪表板。</p><p id="7de8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该项目包含 BigQuery 托管的所有公共数据集，您需要导航到<strong class="kd iu"> <em class="mr"> github_repos </em> </strong>数据集。在里面你会看到 9 张桌子。</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/d3658bf64006eec91822abd502f41e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*2nKkvInX2cwoa_g8zdGyLQ.png"/></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Public Github data set in BigQUery</figcaption></figure><p id="f240" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">出于本帖的目的，我们将使用<strong class="kd iu"> <em class="mr">语言</em> </strong>表，该表具有以下模式。</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/d18015a401033f12bc14e8f47f8621a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*SteKFFZRbCX9RUjhCSfdhg.png"/></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Schema for languages table</figcaption></figure><p id="cdca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们通过查询记录来了解数据。</p><pre class="mt mu mv mw gt nc nd ne nf aw ng bi"><span id="e502" class="nh lp it nd b gy ni nj l nk nl">SELECT * FROM `bigquery-public-data.github_repos.languages` LIMIT 1000</span></pre><p id="913f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您会注意到表中的<strong class="kd iu"> language </strong>字段是记录类型(也称为 STRUCT)的嵌套重复列，这是正确的，因为一个存储库可以有用多种语言编写的代码。你可以在这里读到更多关于他们的信息。</p><p id="09c4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这使我们想到了使用重复(数组)类型的第一个概念。</p><h1 id="46de" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">UNNEST()和重复数据类型</h1><p id="0390" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">为了使用<strong class="kd iu"> language </strong>字段，我们首先需要展平该列，这样我们可以在单独的行中获得每个值，而不是在一行中获得该字段的所有值。我们将使用 UNNEST()函数，正如它的名字一样，它将嵌套的记录解嵌套到单独的行中。</p><pre class="mt mu mv mw gt nc nd ne nf aw ng bi"><span id="4b78" class="nh lp it nd b gy ni nj l nk nl">SELECT<br/>  repo_name,<br/>  arr.name AS LANGUAGE,<br/>  arr.bytes AS language_bytes<br/>FROM<br/>  `bigquery-public-data.github_repos.languages`,<br/>  UNNEST(LANGUAGE) arr<br/>LIMIT<br/>  10</span></pre><p id="9237" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每种语言记录都有语言名称和语言字节，其中存储了库中有多少字节的代码是用任何特定的语言编写的。在这篇文章中，我们将用代码中最大字节数的语言标记一个存储库，这将我们带到窗口和排名的下一个概念。</p><h1 id="928b" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">窗口和 Rank()函数</h1><p id="5fa5" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">对于每个存储库，我们想找出哪种语言拥有最大的字节数，我们将通过对每个存储库中的语言进行排序来实现这一点。我们将使用前面的查询作为子查询来构建我们的查询。</p><pre class="mt mu mv mw gt nc nd ne nf aw ng bi"><span id="a913" class="nh lp it nd b gy ni nj l nk nl">SELECT<br/>  repo_name,<br/>  LANGUAGE,<br/>  RANK() OVER (PARTITION BY t1.repo_name ORDER BY t1.language_bytes DESC) AS rank<br/>FROM (<br/>  SELECT<br/>    repo_name,<br/>    arr.name AS LANGUAGE,<br/>    arr.bytes AS language_bytes<br/>  FROM<br/>    `bigquery-public-data.github_repos.languages`,<br/>    UNNEST(LANGUAGE) arr ) AS t1<br/>LIMIT<br/>  10</span></pre><p id="0043" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将向我们的结果添加一个<strong class="kd iu">等级</strong>列，我们需要选择<strong class="kd iu">等级=1 </strong>的行，因为这些行代表每个存储库的顶级语言。</p><pre class="mt mu mv mw gt nc nd ne nf aw ng bi"><span id="2f24" class="nh lp it nd b gy ni nj l nk nl">SELECT<br/>  t2.repo_name,<br/>  t2.LANGUAGE<br/>FROM (<br/>  SELECT<br/>    repo_name,<br/>    LANGUAGE,<br/>    RANK() OVER (PARTITION BY t1.repo_name ORDER BY t1.language_bytes DESC) AS rank<br/>  FROM (<br/>    SELECT<br/>      repo_name,<br/>      arr.name AS LANGUAGE,<br/>      arr.bytes AS language_bytes<br/>    FROM<br/>      `bigquery-public-data.github_repos.languages`,<br/>      UNNEST(LANGUAGE) arr ) AS t1 ) AS t2<br/>WHERE<br/>  rank = 1<br/>LIMIT<br/>  10</span></pre><p id="4daf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们的数据集已经准备好了，可以根据存储库的数量找到最常用的语言。我们将创建一个命名查询，它可以在后续查询和子查询中使用，以获得更好的可读性。</p><h1 id="6ca4" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">命名子查询</h1><p id="b218" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">BigQuery 支持 WITH 关键字来创建命名查询，这有助于您从中进行选择。命名查询没有具体化，每次引用时都会计算整个查询。你可以在官方文档<a class="ae kz" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#with-clause" rel="noopener ugc nofollow" target="_blank">这里</a>阅读更多关于 WITH keyword 的内容。</p><pre class="mt mu mv mw gt nc nd ne nf aw ng bi"><span id="214b" class="nh lp it nd b gy ni nj l nk nl">WITH<br/>  repositories AS (<br/>  SELECT<br/>    t2.repo_name,<br/>    t2.LANGUAGE<br/>  FROM (<br/>    SELECT<br/>      repo_name,<br/>      LANGUAGE,<br/>      RANK() OVER (PARTITION BY t1.repo_name ORDER BY t1.language_bytes DESC) AS rank<br/>    FROM (<br/>      SELECT<br/>        repo_name,<br/>        arr.name AS LANGUAGE,<br/>        arr.bytes AS language_bytes<br/>      FROM<br/>        `bigquery-public-data.github_repos.languages`,<br/>        UNNEST(LANGUAGE) arr ) AS t1 ) AS t2<br/>  WHERE<br/>    rank = 1)</span></pre><p id="8c3e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您复制粘贴这个查询，您将得到一个<strong class="kd iu">语法错误，</strong>，因为如果不在任何后续的 SELECT 语句或表达式中使用它，您就不能拥有一个命名的子查询。</p><p id="e55d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该查询将返回两列存储库名称(repo_name)及其语言。</p><p id="6d2c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从这里开始，通过计数找到顶级存储库应该是小菜一碟。</p><figure class="mt mu mv mw gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="3e31" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该查询应该产生以下结果集。</p><figure class="mt mu mv mw gt ju gh gi paragraph-image"><div class="gh gi no"><img src="../Images/49eb58bc5225cddaafe7fef717c0c622.png" data-original-src="https://miro.medium.com/v2/resize:fit:492/format:webp/1*rdkhrWXC8cicGTz5L9vopQ.png"/></div><figcaption class="mx my gj gh gi mz na bd b be z dk">Top 10 programming languages by repository counts on Github</figcaption></figure><p id="74af" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个查询的结果并不令人震惊，随着 web 应用程序和 SPAs 的出现，JavaScript 在图表中名列前茅。</p><p id="2826" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在你知道了。按存储库数量排名的前 10 种编程语言。</p><p id="ca61" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你在代码中发现任何错误或者有任何问题，请在下面留下你的评论。</p><p id="2298" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">直到那时快乐编码。</p></div></div>    
</body>
</html>