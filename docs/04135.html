<html>
<head>
<title>Automated Data Quality Testing at Scale using Apache Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Apache Spark 进行大规模自动化数据质量测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automated-data-quality-testing-at-scale-using-apache-spark-93bb1e2c5cd0?source=collection_archive---------2-----------------------#2019-06-29">https://towardsdatascience.com/automated-data-quality-testing-at-scale-using-apache-spark-93bb1e2c5cd0?source=collection_archive---------2-----------------------#2019-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5d87" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">亚马逊的开源库——dee qu</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/37e592b75bb80d8cfe17fabd61ec728d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cc8exApLG6iB4ftp_l_qBQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@srd844?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Stephen Dawson</a> on <a class="ae ky" href="https://unsplash.com/search/photos/data?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="12eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我一直是一名技术架构师，主要负责数据湖/中心/平台类的项目。每天，我们都会从 100 多个业务系统中获取数据，以便分析和 BI 团队可以在项目中使用这些数据。</p><h2 id="7469" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">问题陈述</h2><p id="d2f9" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在接收数据时，我们避免任何转换。数据从源位置复制。源可以是 MySQL、SQL Server、Oracle、DB2 等类型。目标系统可以是 Hadoop/Hive 或 Big Query。尽管没有对数据进行转换，因为源系统和目标系统是不同的，但有时这些简单的数据接收可能会导致数据质量问题。源系统和目标系统可以有不同的数据类型，这可能会导致更多的问题。数据中的特殊字符可能会导致行/列移位。</p><h2 id="653b" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">可能的解决方案</h2><p id="e168" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了解决这个问题，大多数开发人员在构建数据管道后，使用手工方法进行数据质量测试。这可以通过运行一些简单的测试来完成，比如</p><ul class=""><li id="3b5a" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">源和目标之间的样本数据比较</li><li id="29dd" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">主键列上的空检查</li><li id="bfe7" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">日期列上的空检查</li><li id="77d2" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">分类列的计数比较</li><li id="3698" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">等等。</li></ul><p id="76f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法有时效果很好，但是很耗时并且容易出错。因此，我开始寻找一些自动化的选项。</p><h1 id="074e" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">亚马逊的 Deequ</h1><p id="48aa" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我对开源数据质量测试框架的搜索止步于来自<strong class="lb iu">亚马逊</strong>的<strong class="lb iu"> Deequ </strong>库。<a class="ae ky" href="https://github.com/awslabs/deequ" rel="noopener ugc nofollow" target="_blank"> Deequ </a>在亚马逊被用于验证许多大型生产数据集的质量。系统会定期计算数据质量指标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/09ed007c7868d05a381c3dae94ee6c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5zr8vHRb_Tg5HEV4.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Source — <a class="ae ky" href="https://aws.amazon.com/blogs/big-data/test-data-quality-at-scale-with-deequ/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/blogs/big-data/test-data-quality-at-scale-with-deequ/</a></figcaption></figure><p id="1142" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Deequ 建立在 Apache Spark<strong class="lb iu">之上，因此它可以自然地扩展到海量数据。最棒的是，你不需要详细了解 Spark 就可以使用这个库。<strong class="lb iu"> Deequ </strong>提供如下功能</strong></p><ul class=""><li id="a88f" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><strong class="lb iu">约束建议</strong> —测试什么。有时可能很难找到在特定对象中测试什么。Deequ 提供了内置的功能来识别要测试的约束。</li><li id="9bbd" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><strong class="lb iu">度量计算</strong> —一旦我们知道要测试什么，我们就可以使用库给出的建议并运行测试来计算度量。</li><li id="de0a" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><strong class="lb iu">约束验证</strong>——使用 Deequ，我们还可以放置测试用例，并获得用于报告的结果。</li></ul><h1 id="3508" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">让我们开始行动吧</h1><p id="6013" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了运行 Deequ，我们需要首先准备好我们的工作站。您可以在一台简单的 Windows/Linux/Mac 机器上尝试一下。</p><h2 id="e2a9" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">先决条件</h2><ul class=""><li id="5c99" class="mt mu it lb b lc mo lf mp li nt lm nu lq nv lu my mz na nb bi translated"><strong class="lb iu">安装 Scala</strong>——你可以从——<a class="ae ky" href="https://www.scala-lang.org/" rel="noopener ugc nofollow" target="_blank">https://www.scala-lang.org/</a>下载安装 Scala</li><li id="8550" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><strong class="lb iu">安装 Apache Spark</strong>——你可以从——<a class="ae ky" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank">https://spark.apache.org/</a>下载安装 Spark</li><li id="f000" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><strong class="lb iu">下载 Deequ 库</strong> —您可以下载 Deequ JAR，如下所示—</li></ul><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="3238" class="lv lw it nx b gy ob oc l od oe">wget http://repo1.maven.org/maven2/com/amazon/deequ/deequ/1.0.1/deequ-1.0.1.jar</span></pre><ul class=""><li id="5af6" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><strong class="lb iu">准备好要测试的数据</strong> —如果你没有要测试的数据，你可以准备一个。对于本教程，我安装了一个 MySQL 实例，并从 http://www.mysqltutorial.org/mysql-sample-database.aspx<a class="ae ky" href="http://www.mysqltutorial.org/mysql-sample-database.aspx" rel="noopener ugc nofollow" target="_blank">加载了一些样本数据</a></li><li id="4f6c" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><strong class="lb iu">下载 JDBC Jars </strong> —对于您想要运行这些测试的任何类型的数据库，请确保在<code class="fe of og oh nx b">$SPARK_HOME/jars</code>中添加 JDBC Jars。因为我要在 MySQL &amp; Hive 上运行我的测试，所以我添加了各自的 JDBC jar。</li></ul><h2 id="cc05" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">在交互模式下启动 Spark</h2><p id="be95" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了运行测试，我们将使用上一步下载的库在交互模式下启动 Spark，如下所示</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="bb58" class="lv lw it nx b gy ob oc l od oe">PS D:\work\DataTesting&gt; spark-shell --conf spark.jars=deequ-1.0.1.jar<br/>Spark context Web UI available at <a class="ae ky" href="http://SLB-CR3K882.DIR.slb.com:4040" rel="noopener ugc nofollow" target="_blank">http://localhost:4040</a><br/>Spark context available as 'sc' (master = local[*], app id = local-1561783362821).<br/>Spark session available as 'spark'.<br/>Welcome to<br/>      ____              __<br/>     / __/__  ___ _____/ /__<br/>    _\ \/ _ \/ _ `/ __/  '_/<br/>   /___/ .__/\_,_/_/ /_/\_\   version 2.4.3<br/>      /_/</span><span id="31e3" class="lv lw it nx b gy oi oc l od oe">Using Scala version 2.11.12 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_171)<br/>Type in expressions to have them evaluated.<br/>Type :help for more information.</span><span id="e926" class="lv lw it nx b gy oi oc l od oe">scala&gt;</span></pre><h2 id="84e8" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">约束建议</h2><p id="4a7a" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我计划在前面步骤中加载的<code class="fe of og oh nx b">customer</code>表上运行测试。您可以使用 MySQL Workbench/CLI 来验证数据是否正确加载。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/7212ad422e29d28ad3f26e748fa12f0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xrn_32bl8vCK53UcrLMQA.png"/></div></div></figure><p id="bd02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了运行约束建议，我们需要首先使用 Spark 连接到 DB。</p><blockquote class="ok"><p id="f20a" class="ol om it bd on oo op oq or os ot lu dk translated">请注意，使用这种方法，我们将查询下推到底层数据库。所以直接在生产系统上运行时请小心。</p></blockquote><pre class="ou ov ow ox oy nw nx ny nz aw oa bi"><span id="f009" class="lv lw it nx b gy ob oc l od oe">import org.apache.spark.sql.SQLContext</span><span id="7520" class="lv lw it nx b gy oi oc l od oe">val sqlcontext = new org.apache.spark.sql.SQLContext(sc)</span><span id="e4f4" class="lv lw it nx b gy oi oc l od oe">val datasource = sqlcontext.read.format("jdbc").option("url", "jdbc:mysql://&lt;IP&gt;:3306/classicmodels").option("driver", "com.mysql.jdbc.Driver").option("dbtable", "customers").option("user", "&lt;username&gt;").option("password", "&lt;password&gt;").option("useSSL", "false").load()</span></pre><p id="17c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在有效的连接上，您可以检查表的模式—</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="fbad" class="lv lw it nx b gy ob oc l od oe">scala&gt; datasource.printSchema()<br/>root<br/> |-- customerNumber: integer (nullable = true)<br/> |-- customerName: string (nullable = true)<br/> |-- contactLastName: string (nullable = true)<br/> |-- contactFirstName: string (nullable = true)<br/> |-- phone: string (nullable = true)<br/> |-- addressLine1: string (nullable = true)<br/> |-- addressLine2: string (nullable = true)<br/> |-- city: string (nullable = true)<br/> |-- state: string (nullable = true)<br/> |-- postalCode: string (nullable = true)<br/> |-- country: string (nullable = true)<br/> |-- salesRepEmployeeNumber: integer (nullable = true)<br/> |-- creditLimit: decimal(10,2) (nullable = true)</span><span id="5ba0" class="lv lw it nx b gy oi oc l od oe">scala&gt;</span></pre><p id="b514" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们运行约束建议—</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="1c02" class="lv lw it nx b gy ob oc l od oe">import com.amazon.deequ.suggestions.{ConstraintSuggestionRunner, Rules}<br/>import spark.implicits._ // for toDS method</span><span id="5757" class="lv lw it nx b gy oi oc l od oe">// We ask deequ to compute constraint suggestions for us on the data<br/>val suggestionResult = { ConstraintSuggestionRunner()<br/>  // data to suggest constraints for<br/>  .onData(datasource)<br/>  // default set of rules for constraint suggestion<br/>  .addConstraintRules(Rules.DEFAULT)<br/>  // run data profiling and constraint suggestion<br/>  .run()<br/>}</span><span id="eb4f" class="lv lw it nx b gy oi oc l od oe">// We can now investigate the constraints that Deequ suggested. <br/>val suggestionDataFrame = suggestionResult.constraintSuggestions.flatMap { <br/>  case (column, suggestions) =&gt; <br/>    suggestions.map { constraint =&gt;<br/>      (column, constraint.description, constraint.codeForConstraint)<br/>    } <br/>}.toSeq.toDS()</span></pre><p id="0593" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦执行完成，您可以打印如下所示的建议—</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="b6c3" class="lv lw it nx b gy ob oc l od oe">scala&gt; suggestionDataFrame.toJSON.collect.foreach(println)</span><span id="7f62" class="lv lw it nx b gy oi oc l od oe">{"_1":"addressLine1","_2":"'addressLine1' is not null","_3":".isComplete(\"addressLine1\")"}<br/>{"_1":"city","_2":"'city' is not null","_3":".isComplete(\"city\")"}<br/>{"_1":"contactFirstName","_2":"'contactFirstName' is not null","_3":".isComplete(\"contactFirstName\")"}<br/>{"_1":"state","_2":"'state' has less than 69% missing values","_3":".hasCompleteness(\"state\", _ &gt;= 0.31, Some(\"It sho<br/>uld be above 0.31!\"))"}<br/>{"_1":"salesRepEmployeeNumber","_2":"'salesRepEmployeeNumber' has less than 25% missing values","_3":".hasCompleteness(\<br/>"salesRepEmployeeNumber\", _ &gt;= 0.75, Some(\"It should be above 0.75!\"))"}<br/>{"_1":"salesRepEmployeeNumber","_2":"'salesRepEmployeeNumber' has no negative values","_3":".isNonNegative(\"salesRepEmp<br/>loyeeNumber\")"}<br/>{"_1":"customerName","_2":"'customerName' is not null","_3":".isComplete(\"customerName\")"}<br/>{"_1":"creditLimit","_2":"'creditLimit' is not null","_3":".isComplete(\"creditLimit\")"}<br/>{"_1":"creditLimit","_2":"'creditLimit' has no negative values","_3":".isNonNegative(\"creditLimit\")"}<br/>{"_1":"country","_2":"'country' is not null","_3":".isComplete(\"country\")"}<br/>{"_1":"country","_2":"'country' has value range 'USA', 'Germany', 'France', 'Spain', 'UK', 'Australia', 'Italy', 'New Ze<br/>aland', 'Switzerland', 'Singapore', 'Finland', 'Canada', 'Portugal', 'Ireland', 'Norway  ', 'Austria', 'Sweden', 'Belgiu<br/>m' for at least 84.0% of values","_3":".isContainedIn(\"country\", Array(\"USA\", \"Germany\", \"France\", \"Spain\", \"<br/>UK\", \"Australia\", \"Italy\", \"New Zealand\", \"Switzerland\", \"Singapore\", \"Finland\", \"Canada\", \"Portugal\",<br/>\"Ireland\", \"Norway  \", \"Austria\", \"Sweden\", \"Belgium\"), _ &gt;= 0.84, Some(\"It should be above 0.84!\"))"}<br/>{"_1":"postalCode","_2":"'postalCode' has less than 9% missing values","_3":".hasCompleteness(\"postalCode\", _ &gt;= 0.9,<br/>Some(\"It should be above 0.9!\"))"}<br/>{"_1":"customerNumber","_2":"'customerNumber' is not null","_3":".isComplete(\"customerNumber\")"}<br/>{"_1":"customerNumber","_2":"'customerNumber' has no negative values","_3":".isNonNegative(\"customerNumber\")"}<br/>{"_1":"contactLastName","_2":"'contactLastName' is not null","_3":".isComplete(\"contactLastName\")"}<br/>{"_1":"phone","_2":"'phone' is not null","_3":".isComplete(\"phone\")"}</span></pre><p id="0d8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着你的测试用例已经准备好了。现在让我们运行指标计算。</p><h2 id="fb81" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">度量计算</h2><p id="c731" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">查看列和建议，现在我想运行指标计算。你可以这样做—</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="63e1" class="lv lw it nx b gy ob oc l od oe">import com.amazon.deequ.analyzers.runners.{AnalysisRunner, AnalyzerContext}<br/>import com.amazon.deequ.analyzers.runners.AnalyzerContext.successMetricsAsDataFrame<br/>import com.amazon.deequ.analyzers.{Compliance, Correlation, Size, Completeness, Mean, ApproxCountDistinct, Maximum, Minimum, Entropy, GroupingAnalyzer}</span><span id="9b8b" class="lv lw it nx b gy oi oc l od oe">val analysisResult: AnalyzerContext = { AnalysisRunner<br/>  // data to run the analysis on<br/>  .onData(datasource)<br/>  // define analyzers that compute metrics<br/>  .addAnalyzer(Size())<br/>  .addAnalyzer(Completeness("customerNumber"))<br/>  .addAnalyzer(ApproxCountDistinct("customerNumber"))<br/>  .addAnalyzer(Minimum("creditLimit"))<br/>  .addAnalyzer(Mean("creditLimit"))<br/>  .addAnalyzer(Maximum("creditLimit"))<br/>  .addAnalyzer(Entropy("creditLimit"))<br/>  .run()<br/>}</span></pre><p id="ee3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果运行成功，您可以看到结果</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="8fa3" class="lv lw it nx b gy ob oc l od oe">// retrieve successfully computed metrics as a Spark data frame<br/>val metrics = successMetricsAsDataFrame(spark, analysisResult)</span><span id="c721" class="lv lw it nx b gy oi oc l od oe">metrics.show()</span><span id="7ca9" class="lv lw it nx b gy oi oc l od oe">scala&gt; metrics.show()<br/>+-------+--------------+-------------------+-----------------+<br/>| entity|      instance|               name|            value|<br/>+-------+--------------+-------------------+-----------------+<br/>| Column|   creditLimit|            Entropy|4.106362796873961|<br/>| Column|customerNumber|       Completeness|              1.0|<br/>| Column|customerNumber|ApproxCountDistinct|            119.0|<br/>| Column|   creditLimit|            Minimum|              0.0|<br/>| Column|   creditLimit|               Mean|67659.01639344262|<br/>| Column|   creditLimit|            Maximum|         227600.0|<br/>|Dataset|             *|               Size|            122.0|<br/>+-------+--------------+-------------------+-----------------+</span></pre><p id="3f10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以存储这些数字以供进一步验证，甚至显示趋势。在本例中，我们运行的是使用<a class="ae ky" href="https://en.wikipedia.org/wiki/HyperLogLog" rel="noopener ugc nofollow" target="_blank">超对数</a>算法计算的<code class="fe of og oh nx b">ApproxCountDistinct,</code>。这通过近似非重复计数来减少源系统的负担。</p><p id="2dc5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可用分析器的完整列表可在以下位置找到—<a class="ae ky" href="https://github.com/awslabs/deequ/tree/master/src/main/scala/com/amazon/deequ/analyzers" rel="noopener ugc nofollow" target="_blank">https://github . com/aw slabs/de equ/tree/master/src/main/Scala/com/Amazon/de equ/analyzer</a></p><h2 id="4888" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">约束验证</h2><p id="c103" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">现在让我们使用验证套件运行测试用例。</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="35a1" class="lv lw it nx b gy ob oc l od oe">import com.amazon.deequ.{VerificationSuite, VerificationResult}<br/>import com.amazon.deequ.VerificationResult.checkResultsAsDataFrame<br/>import com.amazon.deequ.checks.{Check, CheckLevel}</span><span id="72bb" class="lv lw it nx b gy oi oc l od oe">val verificationResult: VerificationResult = { VerificationSuite()<br/>  // data to run the verification on<br/>  .onData(datasource)<br/>  // define a data quality check<br/>  .addCheck(<br/>    Check(CheckLevel.Error, "Data Validation Check") <br/>      .hasSize(_ == 122 ) <br/>      .isComplete("customerNumber") // should never be NULL<br/>      .isUnique("customerNumber") // should not contain duplicates<br/>      .isNonNegative("creditLimit")) // should not contain negative values<br/>  // compute metrics and verify check conditions<br/>  .run()<br/>}</span></pre><p id="dd2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行完成后，您可以查看结果</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="f1f8" class="lv lw it nx b gy ob oc l od oe">// convert check results to a Spark data frame<br/>val resultDataFrame = checkResultsAsDataFrame(spark, verificationResult)</span><span id="4620" class="lv lw it nx b gy oi oc l od oe">resultDataFrame.show()</span><span id="8b25" class="lv lw it nx b gy oi oc l od oe">scala&gt; resultDataFrame.show()<br/>+-------------------+-----------+------------+--------------------+-----------------+------------------+<br/>|              check|check_level|check_status|          constraint|constraint_status|constraint_message|<br/>+-------------------+-----------+------------+--------------------+-----------------+------------------+<br/>|Data Validate Check|      Error|     Success|SizeConstraint(Si...|          Success|                  |<br/>|Data Validate Check|      Error|     Success|CompletenessConst...|          Success|                  |<br/>|Data Validate Check|      Error|     Success|UniquenessConstra...|          Success|                  |<br/>|Data Validate Check|      Error|     Success|ComplianceConstra...|          Success|                  |<br/>+-------------------+-----------+------------+--------------------+-----------------+------------------+</span></pre><p id="5ad3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果某个特定的案例失败了，您可以查看如下所示的详细信息</p><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="64e1" class="lv lw it nx b gy ob oc l od oe">resultDataFrame.filter(resultDataFrame("constraint_status")==="Failure").toJSON.collect.foreach(println)</span></pre><h2 id="a202" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">增量数据的数据验证</h2><p id="382f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Deequ 还提供了一种验证增量数据加载的方法。你可以在<a class="ae ky" href="https://github.com/awslabs/deequ/blob/master/src/main/scala/com/amazon/deequ/examples/algebraic_states_example.md" rel="noopener ugc nofollow" target="_blank">https://github . com/aw slats/dee qu/blob/master/src/main/Scala/com/Amazon/dee qu/examples/algebraic _ States _ example . MD</a>了解更多关于这种方法的信息</p><h2 id="c54d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">异常检测</h2><p id="0de4" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Deequ 还提供了一种检测异常的方法。GitHub 页面列出了一些方法和策略。详情可以在这里找到——<a class="ae ky" href="https://github.com/awslabs/deequ/tree/master/src/main/scala/com/amazon/deequ/anomalydetection" rel="noopener ugc nofollow" target="_blank">https://github . com/aw slabs/dee qu/tree/master/src/main/Scala/com/Amazon/dee qu/anomaly detection</a></p><h1 id="a6f2" class="nh lw it bd lx ni nj nk ma nl nm nn md jz no ka mg kc np kd mj kf nq kg mm nr bi translated">结论</h1><p id="0d16" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">总的来说，我认为 Deequ 是一个很好的工具，可以用于数据湖/中心/数据仓库类用例中的数据验证和质量测试。亚马逊甚至发表了一篇关于这种方法的研究论文。这可以在 http://www.vldb.org/pvldb/vol11/p1781-schelter.pdf 观看</p><p id="0afe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你尝试这个，一定要让我知道你的经历。如果你有一些有趣的想法，请不要忘记在评论中提及。</p></div><div class="ab cl oz pa hx pb" role="separator"><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe pf"/><span class="pc bw bk pd pe"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt nw nx ny nz aw oa bi"><span id="d628" class="lv lw it nx b gy ob oc l od oe">Hey, if you enjoyed this story, check out <a class="ae ky" href="https://deshpandetanmay.medium.com/membership" rel="noopener">Medium Membership</a>! Just $5/month!</span><span id="f0ce" class="lv lw it nx b gy oi oc l od oe"><em class="pg">Your membership fee directly supports me and other writers you read. You’ll also get full access to every story on Medium.</em></span></pre></div></div>    
</body>
</html>