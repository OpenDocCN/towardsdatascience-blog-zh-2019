<html>
<head>
<title>Flag Colours Visualisation — From Geopandas to Leaflet and back</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">旗帜颜色可视化——从地理标志到传单，再到背面</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/flag-colours-visualisation-from-geopandas-to-leaflet-and-back-28f6400980f2?source=collection_archive---------27-----------------------#2019-07-03">https://towardsdatascience.com/flag-colours-visualisation-from-geopandas-to-leaflet-and-back-28f6400980f2?source=collection_archive---------27-----------------------#2019-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="22d5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在不影响质量的情况下，创建一个具有多种颜色的多边形。</h2></div><p id="2711" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我一直对数据可视化很感兴趣，并且我是一个长期潜伏者。2019 年 7 月 1 日，<a class="ae le" href="https://www.reddit.com/r/dataisbeautiful/comments/c7lpmw/frequency_of_flag_colors_by_continent_imaginary/" rel="noopener ugc nofollow" target="_blank">一个关于各大洲国旗颜色频率的帖子</a>引起了很多人的兴趣。正是从那篇文章中，我有了做这种观想的想法。</p><p id="4dc0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个想法很简单(执行起来并不简单)，计算每面国旗的颜色比例，并用这些颜色在地图上标出每个国家。我有一个<a class="ae le" href="https://github.com/HackeSta/atom-icons" rel="noopener ugc nofollow" target="_blank">以前的项目，使用国旗颜色比例来制作原子图标</a>，所以我知道我应该能够做到这一点。不幸的是，我错了，我花了三次尝试去正确地观想它。</p><p id="5a02" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在深入每个尝试的细节之前，这里是我使用的数据来源。</p><ul class=""><li id="2619" class="lf lg it kk b kl km ko kp kr lh kv li kz lj ld lk ll lm ln bi translated">地图来源:<a class="ae le" href="https://naturalearthdata.com/downloads/" rel="noopener ugc nofollow" target="_blank">https://naturalearthdata.com/downloads/</a></li><li id="4659" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated">旗帜:<a class="ae le" href="https://github.com/hjnilsson/country-flags" rel="noopener ugc nofollow" target="_blank">https://github.com/hjnilsson/country-flags</a></li></ul><h1 id="d3a2" class="lt lu it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">尝试 1 (Python + Geopandas):</h1><p id="072e" class="pw-post-body-paragraph ki kj it kk b kl ml ju kn ko mm jx kq kr mn kt ku kv mo kx ky kz mp lb lc ld im bi translated">在我以前的可视化(简单的 choropleth 地图)中，我一直使用 Geopandas。它可以非常容易地输出高质量的图像。</p><p id="cf9a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我做的第一件事是计算地图上每个国家的颜色比例。我修改了下面<a class="ae le" href="https://stackoverflow.com/a/52879133/4698800" rel="noopener ugc nofollow" target="_blank"> StackOverflow 帖子</a>中的代码，以满足我的需要。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="5bd9" class="mz lu it mv b gy na nb l nc nd">for index,row in map.iterrows(): # map is the GeoPandas variable<br/>        country_code = map.loc[index,'ISO_A2'].lower()<br/>        country_data=[]<br/>        try:<br/>            flag_image = Image.open(FLAGS_DIR+country_code+".png")<br/>        except FileNotFoundError:<br/>            continue<br/>        flag_image = flag_image.convert("RGB")<br/>        pixels = flag_image.getcolors(flag_image.width * flag_image.height)<br/>        sorted_pixels = sorted(pixels, key=lambda t: t[0])<br/>        dominant_pixels = []<br/>        for pixel in pixels:<br/>            if pixel[0]*100/(flag_image.width * flag_image.height) &gt; 5: #Top 5 colours only<br/>                dominant_pixels.append(pixel)</span><span id="d1e3" class="mz lu it mv b gy ne nb l nc nd">        for pixel in dominant_pixels:<br/>            percentage = pixel[0]*100/(flag_image.width * flag_image.height)<br/>            color = "#%02x%02x%02x" % pixel[1]  # HEX Conversion<br/>            country_data.append({"color":color,"percentage":percentage})<br/>        data[country_code] = country_data</span></pre><p id="7172" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当试图给这些国家上色时，这个尝试出现了问题。Geopandas 不能使用多种颜色填充多边形。有一段时间，我想过妥协，只用最主要的颜色填充。实现这一点也很困难，我找到的最接近的可能解决方案是这个<a class="ae le" href="https://github.com/geopandas/geopandas/issues/387" rel="noopener ugc nofollow" target="_blank"> Github 问题</a>。</p><p id="9aac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我无法填充最主要的颜色，所以我放弃了使用 Geopandas。</p><p id="5937" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上面坐了一会儿后，我想起 LeafletJS 使用 CSS 来设置地图的样式。因此，在将国旗颜色数据保存到 JSON 文件后，我开始了第二次可视化的尝试，现在是用活页 JS。</p><h1 id="4819" class="lt lu it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">尝试 2:小册子</h1><p id="3ac6" class="pw-post-body-paragraph ki kj it kk b kl ml ju kn ko mm jx kq kr mn kt ku kv mo kx ky kz mp lb lc ld im bi translated">我对 LeafletJS 寄予厚望，在某种程度上，它是成功的。关于使用 CSS 支持渐变的传单，我几乎是正确的。</p><p id="b9dd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">传单使 SVG 元素不支持 CSS 渐变，但他们自己的渐变元素。</p><p id="8880" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我很容易就能涂上最主要的颜色，但是要做渐变却很难。</p><p id="eeaa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我必须为每个渐变创建元素，并将其链接到每个 SVG 路径。</p><p id="1fac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我使用下面的代码向每个路径添加了国家代码</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="892a" class="mz lu it mv b gy na nb l nc nd">onEachFeature(feature,layer){<br/>                layer.options.className = "country " + feature.properties.ISO_A2.toLowerCase()<br/>            },</span></pre><p id="7e39" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后在传单地图的<code class="fe nf ng nh mv b">add\</code>事件上，添加了以下代码</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="1d1b" class="mz lu it mv b gy na nb l nc nd">.on("add",function(){<br/>            for(let pathElm of $(".country")){<br/>                classes = Array.from(pathElm.classList);<br/>                country = classes[classes.indexOf("country") + 1];<br/>                flag = flagData[country]<br/>                console.log(flag)<br/>                $("body").append(`&lt;svg viewBox="0 0 10 10" <br/>                xmlns:xlink="http://www.w3.org/1999/xlink"&gt;<br/>                &lt;defs&gt;<br/>                &lt;linearGradient id="${country}" gradientTransform="rotate(90)"&gt;<br/>                ${flag.map((entry,index) =&gt;{<br/>                    return `&lt;stop offset="${flag.slice(0,index+1).reduce((a,b)=&gt;{return {percentage: a.percentage + b.percentage}}).percentage}%" stop-color="${entry.color}" /&gt;`<br/>                })}<br/>                &lt;/linearGradient&gt;<br/>                &lt;/defs&gt;<br/>                &lt;/svg&gt;`);<br/>                $(pathElm)f.attr('fill',`url(#${country})`);<br/>            }</span></pre><p id="7fde" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这能够产生我想要的渐变地图，但是在添加属性后，我在<a class="ae le" href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/10m-admin-0-countries/" rel="noopener ugc nofollow" target="_blank">自然地球数据网站</a>上看到了下面的免责声明</p><blockquote class="ni nj nk"><p id="d625" class="ki kj nl kk b kl km ju kn ko kp jx kq nm ks kt ku nn kw kx ky no la lb lc ld im bi translated"><em class="it">免责声明</em></p><p id="865c" class="ki kj nl kk b kl km ju kn ko kp jx kq nm ks kt ku nn kw kx ky no la lb lc ld im bi translated"><em class="it">自然地球矢量根据事实上的状态来绘制国家的边界。我们展示了谁实际控制了地面局势。请随意混搭我们的争议地区主题，以符合您特定的政治观点。</em></p></blockquote><p id="0004" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了避免以后的问题，我决定添加争议地区的地图，并用白色填充。</p><p id="faf2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这需要一点重构，但是我可以用下面的代码轻松地合并这两个地图。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="a2c7" class="mz lu it mv b gy na nb l nc nd">L.map('mapid',{<br/>        center: [39.73, -104.99],<br/>        zoom: 5,<br/>        layers: [mapLayer,disLayer]<br/>    });</span></pre><p id="2d0e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我以为我完成了，但是将地图导出到一个好的图像被证明是不可能的。我尝试了许多插件，但没有一个产生足够好的图像。一个想法出现在我的脑海中，关于从开发者工具中复制 SVG 并使用 Inkscape 产生一个好的图像，但传单为不同的缩放级别呈现不同的路径。当地图完全缩小并变得详细，但只有放大的部分被渲染时，路径不太详细。</p><p id="2a47" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这次尝试也失败了，但给了我另一个想法。将 Geopandas 数据帧转换为 SVG。</p><h1 id="9176" class="lt lu it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">尝试 3: Python + GeoPandas(导出到 SVG)</h1><p id="c066" class="pw-post-body-paragraph ki kj it kk b kl ml ju kn ko mm jx kq kr mn kt ku kv mo kx ky kz mp lb lc ld im bi translated">在使用 LeafletJS 失败后，我带着另一个想法回到了 GeoPandas。将 GeoPandas 导出为 SVG，然后对其应用渐变。我最初的想法是从传单生成的地图添加梯度，但并不需要。</p><p id="c52a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="http://kuanbutts.com/2018/08/30/geodataframe-to-svg/" rel="noopener ugc nofollow" target="_blank">这篇博文在这次尝试中给了我很大的帮助</a></p><p id="6ef4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将博客中的代码添加到我的第一次尝试的代码中，并修改它以满足我的需要。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="84e8" class="mz lu it mv b gy na nb l nc nd"># SOURCE: http://kuanbutts.com/2018/08/30/geodataframe-to-svg/<br/>def process_to_svg_group(row,dis=False):<br/>    orig_svg = row.geometry.svg()<br/>    doc = minidom.parseString(orig_svg)<br/>    paths = doc.getElementsByTagName('path')<br/>    pathssvg = []<br/>    country_code = row['ISO_A2'].lower()<br/>    if row['NAME'] == 'France':<br/>        country_code = 'fr'<br/>    if row['NAME'] == 'Norway':<br/>        country_code = 'no'<br/>    for path in paths:<br/>        path.setAttribute('fill', 'url(#%s)'%(country_code))<br/>        path.setAttribute('stroke-width','0.1')<br/>        path.setAttribute('stroke','#000000')<br/>        path.setAttribute('opacity','1')<br/>        path.setAttribute('transform','scale(10,-10)')<br/>        pathssvg.append(path.toxml())<br/>    return ''.join(pathssvg)<br/><br/><br/>processed_rows = []<br/>def_rows = []<br/><br/>res_symdiff = gpd.overlay(gismap, dismap, how='difference')<br/><br/>for index,row in res_symdiff.iterrows():<br/>    country_data=[]<br/>    dominant_pixels = []<br/>    stops = []    <br/>    country_code = row['ISO_A2'].lower()<br/>    if row['NAME'] == 'France':<br/>        country_code = 'fr'<br/>    if row['NAME'] == 'Norway':<br/>        country_code = 'no' <br/>    try:<br/>        flag_image = Image.open(FLAGS_DIR+country_code+".png")<br/>    except FileNotFoundError:<br/>        continue<br/><br/>    flag_image = flag_image.convert("RGB")<br/>    # SOURCE: https://stackoverflow.com/a/52879133/4698800<br/>    pixels = flag_image.getcolors(flag_image.width * flag_image.height)<br/>    sorted_pixels = sorted(pixels, key=lambda t: t[0])<br/><br/>    for pixel in sorted_pixels:<br/>        if pixel[0]*100/(flag_image.width * flag_image.height) &gt; 1:<br/>            dominant_pixels.append(pixel)<br/>    print(dominant_pixels)<br/>    sum = 0<br/>    for x in dominant_pixels:<br/>        sum += x[0]<br/>    print(sum)<br/>    for pixel in dominant_pixels:<br/>        percentage = pixel[0]*100/sum<br/>        print(percentage)<br/>        color = "#%02x%02x%02x" % pixel[1]<br/>        perc = 0<br/>        if len(country_data) &gt; 0:<br/>            for x in country_data:<br/>                perc += x['percentage']<br/><br/>        stops.append('&lt;stop offset="%s%%" stop-color="%s" stop-opacity="1"/&gt;&lt;stop offset="%s%%" stop-color="%s" stop-opacity="1"/&gt;'%(perc,color,perc+percentage,color))<br/>        country_data.append({"color":color,"percentage":percentage})<br/>    grad = '''&lt;defs&gt;<br/>            &lt;linearGradient x1="0" x2="0" y1="1" y2="0" id="%s"&gt;<br/>                %s           <br/>            &lt;/linearGradient&gt;<br/>            &lt;/defs&gt;<br/>            '''%(country_code,''.join(stops))<br/>    def_rows.append(grad)<br/><br/>    p = process_to_svg_group(row)<br/>    processed_rows.append(p)<br/><br/><br/>props = {<br/>    'version': '1.1',<br/>    'baseProfile': 'full',<br/>    'width': '100%',<br/>    'height': '100%',<br/>    'viewBox': '{}'.format(','.join(map(str, gismap.total_bounds))),<br/>    'xmlns': 'http://www.w3.org/2000/svg',<br/>    'xmlns:ev': 'http://www.w3.org/2001/xml-events',<br/>    'xmlns:xlink': 'http://www.w3.org/1999/xlink'<br/>}<br/>template = '{key:s}="{val:s}"'<br/>attrs = ' '.join([template.format(key=key, val=props[key]) for key in props])<br/><br/>raw_svg_str = textwrap.dedent(r'''<br/>    &lt;?xml version="1.0" encoding="utf-8" ?&gt;<br/>    &lt;svg {attrs:s}&gt;<br/>    &lt;g&gt;{data:s}&lt;/g&gt;<br/>    {grads:s}<br/>    &lt;/svg&gt;<br/>''').format(attrs=attrs, data=''.join(processed_rows),grads=''.join(def_rows)).strip()<br/>with open('out/map.svg', 'w') as f:<br/>    f.write(raw_svg_str)</span></pre><p id="602b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这能够产生地图</p><figure class="mq mr ms mt gt nq gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi np"><img src="../Images/7d19c914eda8f0ab8076225cf5bb8b02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gqlG0YpWDRVKq0SrtjFiQ.png"/></div></div></figure><p id="ef26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">高质量地图<br/><a class="ae le" href="https://i.imgur.com/2RD4s6k.png" rel="noopener ugc nofollow" target="_blank">https://i.imgur.com/2RD4s6k.png</a></p><p id="5471" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nl">我用 Inkscape 添加了文本和背景</em></p><h2 id="52fb" class="mz lu it bd lv nx ny dn lz nz oa dp md kr ob oc mf kv od oe mh kz of og mj oh bi translated">法国和挪威的奇特案例</h2><p id="5250" class="pw-post-body-paragraph ki kj it kk b kl ml ju kn ko mm jx kq kr mn kt ku kv mo kx ky kz mp lb lc ld im bi translated">在各种网站上分享地图后，许多人询问失踪的法国。我不擅长地理，但我相信我的代码不会漏掉一个国家。所以我做了一些调试和研究，发现我使用的 shapefile 没有存储法国和挪威的 ISOA2 数据。我的代码使用 ISO A2 数据将旗帜文件与地图进行匹配，因此缺少的数据会导致缺少的国家。我硬编码了几个 if 语句来包含国家，上面的代码为此进行了更新。</p><h2 id="e730" class="mz lu it bd lv nx ny dn lz nz oa dp md kr ob oc mf kv od oe mh kz of og mj oh bi translated">相关材料</h2><ul class=""><li id="1119" class="lf lg it kk b kl ml ko mm kr oi kv oj kz ok ld lk ll lm ln bi translated"><a class="ae le" href="http://geopandas.org/" rel="noopener ugc nofollow" target="_blank">地质公园</a></li><li id="e0a0" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><a class="ae le" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank">小叶</a></li><li id="0ab4" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><a class="ae le" href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/linearGradient" rel="noopener ugc nofollow" target="_blank">线性梯度</a></li></ul><p id="2822" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://github.com/haideralipunjabi/country-flag-visualisation" rel="noopener ugc nofollow" target="_blank"> Github 库</a></p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="70da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae le" href="https://blog.haideralipunjabi.com/posts/country-flag-visualisation/" rel="noopener ugc nofollow" target="_blank">在我的博客上阅读</a> <br/> <a class="ae le" href="https://dev.to/haideralipunjabi/flag-colours-visualisation-from-geopandas-to-leaflet-and-back-4ohk" rel="noopener ugc nofollow" target="_blank">在 Dev 上阅读</a></p><p id="e30d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打招呼:<a class="ae le" href="https://instagram.com/haideralipunjabi" rel="noopener ugc nofollow" target="_blank"><strong class="kk iu">insta gram</strong></a>|<a class="ae le" href="https://github.com/haideralipunjabi" rel="noopener ugc nofollow" target="_blank">|<strong class="kk iu">Github</strong>|</a>|<a class="ae le" href="https://facebook.com/haiderali176" rel="noopener ugc nofollow" target="_blank">|<strong class="kk iu">脸书</strong></a>|<a class="ae le" href="https://twitter.com/HAliPunjabi" rel="noopener ugc nofollow" target="_blank">|<strong class="kk iu">推特</strong> </a> | <a class="ae le" href="https://haideralipunjabi.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu">网站</strong>|</a><a class="ae le" href="https://blog.haideralipunjabi.com/" rel="noopener ugc nofollow" target="_blank">|<strong class="kk iu">博客</strong> </a></p></div></div>    
</body>
</html>