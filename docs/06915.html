<html>
<head>
<title>Apache Hive Hooks and Metastore Listeners: A tale of your metadata</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Hive 挂钩和 Metastore 监听器:元数据的故事</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-hive-hooks-and-metastore-listeners-a-tale-of-your-metadata-903b751ee99f?source=collection_archive---------7-----------------------#2019-10-01">https://towardsdatascience.com/apache-hive-hooks-and-metastore-listeners-a-tale-of-your-metadata-903b751ee99f?source=collection_archive---------7-----------------------#2019-10-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="67f6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">元数据介绍，什么是 hive 挂钩和 metastore 侦听器，何时使用它们，以及使用它们的一些探索</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/eb37b4409173fcb54c8397f6013f2f79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQ193PZXzpEGZfxHQ_0Xpw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@dekubaum" rel="noopener ugc nofollow" target="_blank">Dennis Kummer</a> on <a class="ae kv" href="https://unsplash.com/photos/52gEprMkp7M" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="e853" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">开始前的假设</h1><p id="b13b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">本文的目标读者应该对 Hive 和 Hadoop 生态系统特性有基本的了解。本文着重于比较和展示编写一个 Hive 钩子和一个 Metastore 侦听器需要什么，使您能够自动化元数据管理。</p><p id="365a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">本帖涵盖的主题将是:</p><ul class=""><li id="7010" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><strong class="lq ir">元数据管理的需求</strong></li><li id="6630" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">元数据</strong></li><li id="6213" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">元数据管理</strong></li><li id="1eb1" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">为什么是阿帕奇蜂房？</strong></li><li id="41f1" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">配置单元挂钩和 Metastore 监听器</strong></li><li id="c680" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">蜂巢挂钩概要</strong></li><li id="b840" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">Metastore 侦听器摘要</strong></li><li id="2aa5" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">开始使用 Hive 环境</strong></li><li id="c72a" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">探索钩子</strong></li><li id="6f70" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">探索听者</strong></li></ul></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="374a" class="kw kx iq bd ky kz nk lb lc ld nl lf lg jw nm jx li jz nn ka lk kc no kd lm ln bi translated">元数据管理的需求</h1><p id="e669" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">据 Gartner " <em class="np">称，到 2020 年，大多数数据和分析用例</em> <strong class="lq ir"> <em class="np">将需要连接到分布式数据源</em> </strong> <em class="np">，这将导致企业在元数据管理方面的投资翻倍。</em>”</p><p id="13c1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">读完这句话后，您可能想知道:元数据到底代表什么？为什么它需要管理？</p><p id="2d17" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我可以告诉你，这是几个月前我想到的第一个问题…</p><h1 id="00ed" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">[计]元数据</h1><p id="1dec" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们可以将元数据分类为:</p><ul class=""><li id="9c8f" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><strong class="lq ir">技术元数据</strong>:关于资产的详细信息，比如它的名称、类型、创建者的名字、对象的大小，或者最后一次更新的时间。</li><li id="b9a7" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">业务元数据</strong>:提供关于资产的附加业务上下文，例如，它是否包含 PII(个人身份信息)、它应该被删除的日期以及许多其他信息。</li><li id="f69f" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">运营元数据</strong> : <strong class="lq ir"> </strong>通常是关于资产使用情况的信息，如查询日志、数据采样和数据分析。</li></ul><p id="f8de" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您还可以考虑关于资产的物理和逻辑信息，让我通过查看 Hive 和 Hadoop 生态系统来澄清这一点…</p><p id="2ccc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您的数据可以物理地存储在 hdfs 位置，并且在 Hive 上有许多不同的逻辑表指向它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/40fc1807238ad21fc5c9dc305823135e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FWPWNzotuE3eRdDRnxi8iA.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@spdumb2025" rel="noopener ugc nofollow" target="_blank">Amy Chen</a> on <a class="ae kv" href="https://unsplash.com/photos/xIzBdHcFodE" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8d21" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是一个很大的过程，但它会变得更加清晰…</p><h1 id="e110" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">元数据管理</h1><p id="c8d5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">元数据管理解决方案有助于回答与您的数据资产相关的问题，例如:</p><ul class=""><li id="9435" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">我的数据资产安全吗？</li><li id="e193" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">我是否符合所有这些新的数据保护法规？如<a class="ae kv" href="https://www.caprivacy.org" rel="noopener ugc nofollow" target="_blank"> CCPA </a>、<a class="ae kv" href="https://gdpr-info.eu/" rel="noopener ugc nofollow" target="_blank"> GDPR </a>、<a class="ae kv" href="https://www.hhs.gov/hipaa/index.html" rel="noopener ugc nofollow" target="_blank"> HIPAA </a></li><li id="b192" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">谁具有可见性，谁可以对这些资产进行更改？</li></ul><p id="890b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">管理的本质通常始于维基、电子表格和各种文档，但当我们开始进入大数据世界时，它们很容易失去同步，我们变得无法回答这些问题。</p><p id="ddd1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你还记得关于脸书用户数据隐私的 50 亿美元罚款吗？你不想被放在一个无法回答这些问题的地方。</p><p id="a01a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们需要开始自动化我们的元数据管理！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/cd494ec463151c55d6c4bbb65af05778.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rBvUZMDjYBhv9ejHRaWpVQ.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">A Data Dashboard. Photo by <a class="ae kv" href="https://unsplash.com/@kmuza" rel="noopener ugc nofollow" target="_blank">Carlos Muza</a> on <a class="ae kv" href="https://unsplash.com/photos/hpjSkU2UYSU" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="df1e" class="kw kx iq bd ky kz nk lb lc ld nl lf lg jw nm jx li jz nn ka lk kc no kd lm ln bi translated">为什么是阿帕奇蜂房？</h1><p id="b2ae" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">正如 Gartner 所言:“<em class="np">大多数数据和分析用例都需要连接到分布式数据源”。</em>虽然<em class="np"> </em> Hive 只是其中之一，但它是一个开源项目，仍然被许多组织使用。</p><p id="aaf5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">通过深入研究配置单元挂钩和 Metastore 侦听器，我们将了解如何在这种环境中连接到数据源，并收集有关其元数据更改的信息。值得一提的是，对于更复杂的元数据场景，像<a class="ae kv" href="https://atlas.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Atlas </a>这样的健壮数据治理和元数据框架可以在这个过程中为您提供帮助。</p><p id="f743" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，我们将在本文中展示的是非常简单的实现，可以帮助您入门。</p><h1 id="f07c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">配置单元挂钩和 Metastore 侦听器</h1><p id="d0d5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了节省您的时间，让我简单地说一下，从概念上讲，它们基本上是相同的。重点是如何将每一个注册到 Hive 中，以及为他们提供什么信息。</p><p id="2685" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">本质上，我们创建了一个扩展接口或抽象类的类，带有我们的自定义逻辑，它将被钩子或监听器事件调用。</p><p id="6231" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">根据事件的不同，我们将获得不同的工作对象，让我们看一些例子:</p><ul class=""><li id="1230" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">蜂巢挂钩:</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Hive Hooks: Properties and Classes</figcaption></figure><ul class=""><li id="ec05" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">Metastore 侦听器:</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Metastore Listeners: Properties and Classes</figcaption></figure><p id="cd9d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于它们中的每一个，你都有一对<strong class="lq ir">属性</strong>和<strong class="lq ir">类</strong>。</p><p id="b7e7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">属性是触发事件的地方，而类是您必须扩展的，所以配置单元运行器知道如何调用它。</p><p id="78c7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了演示如何以及何时使用它们，我们将探索<code class="fe nu nv nw nx b"><strong class="lq ir">hive.exec.post.hook</strong></code>和<code class="fe nu nv nw nx b"><strong class="lq ir">hive.metastore.event.listener</strong></code>属性。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="1aac" class="kw kx iq bd ky kz nk lb lc ld nl lf lg jw nm jx li jz nn ka lk kc no kd lm ln bi translated">蜂巢挂钩概述</h1><p id="3c1a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们来看看使用 Hive 钩子的优缺点:</p><p id="c676" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">优点</strong></p><ul class=""><li id="3c87" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">在查询处理的各个步骤中，可以更加灵活地运行/注入一些代码。</li><li id="6f4a" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">可用于更新您的资产元数据，如表的访问时间，例如<a class="ae kv" href="https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/hooks/UpdateInputAccessTimeHook.java" rel="noopener ugc nofollow" target="_blank">UpdateInputAccessTimeHook</a></li></ul><p id="13b5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">缺点</strong></p><ul class=""><li id="cc53" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">关于您的资产的元数据可能很难理解，您可能必须解析它，因为您正在处理钩子对象。</li><li id="1467" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">您可以更改挂钩对象并影响配置单元查询处理。</li></ul><p id="5906" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于 hive hook 方法，我们将使用<code class="fe nu nv nw nx b"><strong class="lq ir">hive.exec.post.hook</strong></code> <strong class="lq ir"> </strong>属性，这个属性在查询执行之后和结果返回给用户之前运行，一旦我们看到它运行，它将变得更加清晰。</p><h1 id="4adb" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">Metastore 侦听器摘要</h1><p id="e836" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们来看看使用 Metastore 侦听器的一些优点和缺点:</p><p id="3bea" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">优点</strong></p><ul class=""><li id="c4e3" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">关于您的资产的元数据已经被解析，更容易处理。</li><li id="197d" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">不能影响查询处理，它是只读的。</li></ul><p id="08a7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">缺点</strong></p><ul class=""><li id="2107" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">灵活性较差，您只能访问属于您的事件的对象。</li></ul><p id="562f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于 metastore 监听器方法，我们将使用<code class="fe nu nv nw nx b"><strong class="lq ir">hive.metastore.event.listener</strong></code>属性<strong class="lq ir">。</strong></p><p id="aa26" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在该属性中，我们能够从<code class="fe nu nv nw nx b"><strong class="lq ir">MetaStoreEventListener</strong></code>抽象类的事件列表中进行选择。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Methods from the MetaStoreEventListener with their Parameters</figcaption></figure><p id="a277" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了使用它，我们覆盖我们想要的方法，当事件发生时，我们将接收参数对。为了展示这一点，我们将覆盖两个方法:<code class="fe nu nv nw nx b"><strong class="lq ir">onCreateTable</strong></code>和<code class="fe nu nv nw nx b"><strong class="lq ir">onAlterTable</strong></code>。</p><blockquote class="ny"><p id="ba66" class="nz oa iq bd ob oc od oe of og oh mj dk translated">是时候动手了，让我们探索这两种策略。</p></blockquote></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="e345" class="kw kx iq bd ky kz nk lb lc ld nl lf lg jw nm jx li jz nn ka lk kc no kd lm ln bi translated">开始使用 Hive 环境</h1><p id="0afa" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将使用通常推荐的生产配置单元环境，在该环境中，我们为配置单元服务器、metastore 和底层 RDBMS(代表配置单元存储元数据)提供了单独的进程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/82524a04e0ff76afa84b72f1212193a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DQeeo_LbLyUhAp1NhPXGpQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Hive Environment showcasing Hook and Listener usage</figcaption></figure><p id="e1f1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">需要指出的是，钩子和监听器连接到不同的进程，正如你在上面的图片中看到的。</p><p id="e869" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你想建立一个如图所示的环境，有一个很好的 repo: <a class="ae kv" href="https://github.com/big-data-europe/docker-hive" rel="noopener ugc nofollow" target="_blank"> docker-hive </a>，可以帮助你开始。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="6726" class="kw kx iq bd ky kz nk lb lc ld nl lf lg jw nm jx li jz nn ka lk kc no kd lm ln bi translated">探索钩子</h1><p id="9f4a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们来看看我们的定制钩子代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="64b9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在 hook 上下文中，我们可以访问执行的查询、执行的操作以及查询执行的输入和输出。在这种情况下，我们只是过滤资产中的修改操作，并记录输入和输出值，这样我们就可以看到它们的结果。</p><p id="f6f6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">出于测试目的，让我们在一个连接到我们的 Hive 服务器的直线终端中注册这个钩子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/68da825981c648aa60268ede76094987.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*oQmbAsZLdWkxoKt2Eua62g.png"/></div></figure><p id="f0b4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在让我们运行一些命令来查看它们的结果:</p><ul class=""><li id="59c1" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><code class="fe nu nv nw nx b">show tables</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/98f7a83525fd79c76f6631281e5df9e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fb_7mpUkih4SNe3w0HPsmw.png"/></div></div></figure><p id="5e54" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我们的钩子中这是一个不受监控的操作，所以在这种情况下没有关于对象的日志，但是您能发现<strong class="lq ir">操作元数据</strong>吗？</p><blockquote class="ol om on"><p id="2b1b" class="lo lp np lq b lr mk jr lt lu ml ju lw oo mm lz ma op mn md me oq mo mh mi mj ij bi translated">我们正在记录执行的查询:)</p></blockquote><ul class=""><li id="c8f4" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><code class="fe nu nv nw nx b">CREATE TABLE post (code INT, text STRING);</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/aae6eb7eb461563768c7aec65fb4b78a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60TUf3Ffr0AsHhMQbfW8Bw.png"/></div></div></figure><p id="1b4d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们看看 JSON 日志对象:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/4228c92d9612ae28a5d23edcdac79a1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w4vfqJ1u5Q2ikHqUGfhDDA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Full JSON file <a class="ae kv" href="https://gist.github.com/mesmacosta/16d34ba5460122c86be06882f7c0b58e" rel="noopener ugc nofollow" target="_blank">here</a></figcaption></figure><p id="2065" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你能在这个 JSON 对象中找到所有的技术元数据吗？！看看所有这些字段和布尔标志，并开始思考我们可以监控的一切！</p><p id="81e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您注意到 JSON 中没有关于列名(<code class="fe nu nv nw nx b">code</code>和<code class="fe nu nv nw nx b">text</code>)的信息，那么在<code class="fe nu nv nw nx b">CREATETABLE</code>事件中，如果我们需要这些信息，我们将需要额外的工作。</p><ul class=""><li id="42bb" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><code class="fe nu nv nw nx b">ALTER TABLE post ADD COLUMNS (release_date string COMMENT ‘Release date for this post’);</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/580caa63e5715ae88c4cc8c5948d8fe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a1KR7m7kIyv7OdMfnTP9Og.png"/></div></div></figure><p id="d9dd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们看看 JSON 日志对象:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Some fields were suppressed to keep it short</figcaption></figure><p id="a29a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">与 Create Table 语句相比，我们有两个<code class="fe nu nv nw nx b">output</code>对象，一个代表数据库，另一个代表表。<br/>现在，对于 Alter Table 语句，我们有一个<code class="fe nu nv nw nx b">input</code>对象和一个<code class="fe nu nv nw nx b">output</code>对象，两者都表示表。</p><p id="abf0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这里有一个问题，<code class="fe nu nv nw nx b">output</code>对象不包含新列<code class="fe nu nv nw nx b">release_date</code>，它表示应用更改之前的目标对象。</p><p id="3f4b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们使用侦听器运行相同的操作进行比较。</p><blockquote class="ol om on"><p id="b696" class="lo lp np lq b lr mk jr lt lu ml ju lw oo mm lz ma op mn md me oq mo mh mi mj ij bi translated">你可以在这个 git <a class="ae kv" href="https://github.com/mesmacosta/hive-custom-hook" rel="noopener ugc nofollow" target="_blank"> repo </a>上找到完整的实现。关于注册钩子需要改变什么文件的更多细节，请查看<code class="fe nu nv nw nx b">README.md</code>文件。</p></blockquote></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="c365" class="kw kx iq bd ky kz nk lb lc ld nl lf lg jw nm jx li jz nn ka lk kc no kd lm ln bi translated">探索听者</h1><p id="f588" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们看一下我们的定制监听器代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="eeba" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这里我们订阅了两个事件:<code class="fe nu nv nw nx b"><strong class="lq ir">onCreateTable</strong></code>和<code class="fe nu nv nw nx b"><strong class="lq ir">onAlterTable</strong></code>。如您所见，我们访问的对象与它们的事件相关联，对于<code class="fe nu nv nw nx b"><strong class="lq ir">onCreateTable</strong></code> <strong class="lq ir"> </strong>我们获得事件表元数据，对于<code class="fe nu nv nw nx b"><strong class="lq ir">onAlterTable</strong></code> <strong class="lq ir"> </strong>我们获得新旧表元数据。</p><p id="a262" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当使用监听器时，我们不能像使用自定义钩子那样注册它，因为它运行在 Metastore 进程上。如果你想看到你需要修改的配置文件，请查看本主题底部的<code class="fe nu nv nw nx b">README.md</code>。</p><p id="9cf5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在让我们运行一些命令来查看它们的结果:</p><blockquote class="ol om on"><p id="a55f" class="lo lp np lq b lr mk jr lt lu ml ju lw oo mm lz ma op mn md me oq mo mh mi mj ij bi translated">在运行命令之前，我清除了配置单元环境，以便我们能够使用相同的表名。</p></blockquote><ul class=""><li id="60ed" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><code class="fe nu nv nw nx b">CREATE TABLE post (code INT, text STRING);</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/a7e1f7764a1cb948bf0d1de6d4d8d2e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yV4RYNpM9YQCSIRtpu4zKQ.png"/></div></div></figure><p id="480f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们看看 JSON 日志对象:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/3663b9edb05305bd1f728dbb4e0b046e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kyitDw0XsQUg8fVT3j8RhQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Full JSON file <a class="ae kv" href="https://gist.github.com/mesmacosta/58a51499cfd348802de4bf6018eec968" rel="noopener ugc nofollow" target="_blank">here</a></figcaption></figure><ul class=""><li id="aa44" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><code class="fe nu nv nw nx b">ALTER TABLE post ADD COLUMNS (release_date string COMMENT ‘Release date for this post’);</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/702437bb264d79bf1aace3cbec7d7f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lqfco61vUjvYGtsKQKfRHg.png"/></div></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Some fields were suppressed to keep it short</figcaption></figure><p id="4a77" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这里我们可以看到新的表元数据包含了添加的列<code class="fe nu nv nw nx b">release_date</code>，因此使用已经解析的对象有其优势。</p><blockquote class="ol om on"><p id="168c" class="lo lp np lq b lr mk jr lt lu ml ju lw oo mm lz ma op mn md me oq mo mh mi mj ij bi translated">你可以在这个 git <a class="ae kv" href="https://github.com/mesmacosta/hive-custom-metastore-listener" rel="noopener ugc nofollow" target="_blank"> repo </a>上找到完整的实现。有关注册监听器需要更改哪些文件的更多详细信息，请查看<code class="fe nu nv nw nx b">README.md</code> <strong class="lq ir"> </strong>文件。</p></blockquote><h1 id="66ef" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结束语</h1><p id="de38" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在本文中，我们介绍了如何在 Hive 环境中连接来自资产的元数据，使您能够自动化元数据管理。我们演示了一个简单的实现，只是记录了操作性的元数据，但是正如我们在本文开头看到的，我们可能会处理许多分布式数据源。下一步是扩展代码，将元数据事件发布到消息系统，如 Kafka、Pub/Sub 或 SQS，并更新您的元数据管理工具。这样做将使我们能够将<strong class="lq ir">业务</strong>元数据添加到我们的资产中，所以敬请关注！</p><p id="82d3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">希望你觉得有用！如果你喜欢这篇文章并想看更多，一定要关注我的简介。</p><h1 id="2e01" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">参考</h1><ul class=""><li id="59c4" class="mp mq iq lq b lr ls lu lv lx ox mb oy mf oz mj mu mv mw mx bi translated"><strong class="lq ir">蜂巢钩</strong>:【http://dharmeshkakadia.github.io/hive-hook/ T2】</li><li id="c3f9" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">码头工人蜂巢环境</strong>:<a class="ae kv" href="https://github.com/big-data-europe/docker-hive" rel="noopener ugc nofollow" target="_blank">https://github.com/big-data-europe/docker-hive</a></li><li id="420a" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">蜂巢挂钩的 Git repo</strong>:<a class="ae kv" href="https://github.com/mesmacosta/hive-custom-hook" rel="noopener ugc nofollow" target="_blank">https://github.com/mesmacosta/hive-custom-hook</a></li><li id="a2c0" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><strong class="lq ir">metastore 侦听器的 Git repo:</strong><a class="ae kv" href="https://github.com/mesmacosta/hive-custom-metastore-listener" rel="noopener ugc nofollow" target="_blank">https://github . com/mes macosta/hive-custom-metastore-listener</a></li></ul></div></div>    
</body>
</html>