<html>
<head>
<title>End to End solution of detecting kin-relationship from Faces.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从人脸中检测亲缘关系的端到端解决方案。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/end-to-end-solution-of-detecting-kin-relationship-from-faces-c70b9e9ecda6?source=collection_archive---------24-----------------------#2019-11-04">https://towardsdatascience.com/end-to-end-solution-of-detecting-kin-relationship-from-faces-c70b9e9ecda6?source=collection_archive---------24-----------------------#2019-11-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c083" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇博客将一步一步地指导你如何用 Keras 构建一个<em class="ko">深度神经网络模型，从无到有，最后用 Flask 将其部署到网络上。这个问题是由 Kaggle 主办的一个比赛，可以在这里找到<a class="ae kp" href="https://www.kaggle.com/c/recognizing-faces-in-the-wild/overview" rel="noopener ugc nofollow" target="_blank"/>。</em></p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/9ee3b94893be2de032b6c67cb933be52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8bN9fUUctBcymW-e"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Photo by <a class="ae kp" href="https://unsplash.com/@priscilladupreez?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Priscilla Du Preez</a> on <a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="23cf" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">目录:</h1><p id="8eab" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">1-定义我们的目标</p><p id="3d04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2-数据及其描述</p><p id="4b29" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3-建筑模型</p><p id="5188" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4-评估</p><p id="477d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">5-生产模型</p><p id="2677" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">6-视频</p><p id="c2ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">7 项待办任务</p><p id="9eb9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">8-参考文献</p><h1 id="f11e" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">定义我们的目标:</strong></h1><p id="a25e" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">你的鼻子长在你身上了吗？</p><p id="b969" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">血亲往往有共同的面部特征。现在，东北大学的研究人员希望改进他们的面部图像分类算法，以弥合研究与 DNA 结果等其他家族标记之间的差距。</p><p id="08ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于以下几个原因，这项技术在实践中仍然鲜为人知:</p><p id="7264" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1.用于亲属关系识别任务的现有图像数据库不够大，不足以捕捉和反映世界上家庭的真实数据分布。</p><p id="a355" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2.许多隐藏因素会影响家族面部关系，因此需要一个比最常用于更高级别分类(例如面部识别或对象分类)的计算机视觉算法更具判别力的模型。</p><p id="a8e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，我们将建立一个复杂的模型，通过仅仅基于他们的面部图像来确定两个人是否有血缘关系。</p><h1 id="be59" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">数据:</h1><p id="a323" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">我们将使用<a class="ae kp" href="https://web.northeastern.edu/smilelab/fiw/" rel="noopener ugc nofollow" target="_blank"> Families In the Wild (FIW) </a>提供的数据，这是最大、最全面的自动亲属识别图像数据库。</p><p id="310d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">FIW 的数据集是从名人的公开图片中获取的。有关他们贴标过程的更多信息，请访问他们的<a class="ae kp" href="https://web.northeastern.edu/smilelab/fiw/database.html" rel="noopener ugc nofollow" target="_blank">数据库页面</a>。</p><h2 id="7999" class="mj lh it bd li mk ml dn lm mm mn dp lq kb mo mp lu kf mq mr ly kj ms mt mc mu bi translated">文件描述:</h2><p id="eb7d" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">文件夹“train”由名为(<code class="fe mv mw mx my b">F0123</code>)的族的子文件夹组成，这些族文件夹包含个人的子文件夹(<code class="fe mv mw mx my b">MIDx</code>)。同一个<code class="fe mv mw mx my b">MIDx</code>文件夹中的图片属于同一个人。同一<code class="fe mv mw mx my b">F0123</code>文件夹中的图像属于同一家族。</p><p id="1094" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">列车文件夹如下所示:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi mz"><img src="../Images/be675c9260f5b134bd9d3e922e91acb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jBzlbiHPtv0NzBhJdihNig.jpeg"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Train Folder</figcaption></figure><p id="a4c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“train”的每个子文件夹如下所示:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi na"><img src="../Images/8764bf3219b6e21b2e901661f32ee8df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3OpkZCUehDeE2pPEIVKQYw.jpeg"/></div></div></figure><p id="e650" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每个个人文件夹都包含此人的面孔:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nb"><img src="../Images/dea65972c1506ea5ba1d6e32bc32b454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wBvBuR-6WIgdjQ8b9FqFAQ.jpeg"/></div></div></figure><p id="cdf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">文件夹“test”包含需要与另一个随机图像测试是否有血缘关系的人脸图像。</p><p id="ae7e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面显示的文件“train_relationships.csv”包含训练标签。记住，不是每个家庭成员都有亲属关系。例如，父母和他们的孩子是亲戚，但彼此不是。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/e8ad3e75e3916a31d58d7032cd05b29f.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*RZlhLBqTcvv5nWLIEPPRdQ.jpeg"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">train_relationships.csv</figcaption></figure><h2 id="b67f" class="mj lh it bd li mk ml dn lm mm mn dp lq kb mo mp lu kf mq mr ly kj ms mt mc mu bi translated">设置所需的库以便在需要时使用:</h2><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><blockquote class="nf ng nh"><p id="dce3" class="jq jr ko js b jt ju jv jw jx jy jz ka ni kc kd ke nj kg kh ki nk kk kl km kn im bi translated">注意:如果您的系统中不存在库“keras_vggface ”,导入时可能会出错。要下载它，您可以参考/运行/使用以下代码:</p></blockquote><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="5942" class="mj lh it my b gy np nq l nr ns">!pip install git+https://github.com/rcmalli/keras-vggface.git</span></pre><p id="2e51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">深入数据文件夹并分析<em class="ko"> train_relationship.csv </em>文件，我发现了一些问题。例如:在<em class="ko"> train_relationship.csv </em>文件中有一个‘f 0039/mid 1’和‘f 0039/mid 3’的关系，但是在 train 文件夹中没有‘f 0039/mid 3’的文件夹。</p><p id="8d51" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我能看到一些类似的问题是因为缺少了下面的文件夹<br/>f 0039/mid 4<br/>f 0041/mid 5<br/>f 0041/mid 7<br/>f 0051/mid 5<br/>…等等。</p><p id="f69f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">解决上述问题的一个简单方法是忽略这些空目录，只考虑那些对我们可用的目录。</p><p id="97a4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">加载数据并将其分成训练和验证集。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="1802" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“val_images”包含文件夹名称以“F09”开头的系列文件夹，而“train_images”包含所有其他系列文件夹。</p><p id="20ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，这两个文件夹也包含空目录，这是我们上面讨论过的问题。是时候忽略它们了:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="96f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们有“train”和“val ”,它们分别包含用于培训和验证过程的系列文件夹。</p><p id="d622" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在定义了这个问题的目标之后，我们探索并理解了我们所拥有的数据的本质，我们也克服了我们所面临的一个简单的问题。现在是做一些建模的时候了。回想一下我们一开始为自己设定的目标:</p><blockquote class="nt"><p id="036a" class="nu nv it bd nw nx ny nz oa ob oc kn dk translated">"预测，给定两张脸是否有血缘关系."</p></blockquote><p id="24b7" class="pw-post-body-paragraph jq jr it js b jt od jv jw jx oe jz ka kb of kd ke kf og kh ki kj oh kl km kn im bi translated">所以基本上我们手头有一个分类问题需要解决。</p><h1 id="c61b" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">深度学习模型:</h1><p id="0da9" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">与以前的经典方法相比，使用深度学习架构，人脸识别的任务显示出高度提高的准确性。当用巨大的数据集训练时，最先进的模型现在甚至可以胜过人类。</p><p id="c3d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于我们的问题，我们将使用两种不同的架构，在一系列人脸识别基准数据集上取得了最先进的结果。这两个系统都可以用来从人脸中提取高质量的特征，称为人脸嵌入，然后可以用来比较两张相似或不相似的人脸。</p><p id="b0bd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1- <em class="ko"> Facenet </em>:是谷歌的研究人员在 2015 年开发的人脸识别系统。它以图像为输入，预测 128 维向量或人脸嵌入。所以简单来说，这个矢量/人脸嵌入现在用数字来表示输入的人脸。</p><p id="3c5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2- <em class="ko"> VGGFace </em>:它是由牛津大学视觉几何组(Visual Geometry Group)的研究人员开发的，该组是图像处理领域最著名的小组之一。它将图像作为输入，并预测 2048 维向量或人脸嵌入。</p><p id="9b6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这两个模型将作为我们的基础模型，也就是说，我们将把我们的输入图像对传递给这两个模型，并获得代表输入人脸的人脸嵌入。一旦我们建立了下面的实际模型，就很清楚了。</p><h2 id="733b" class="mj lh it bd li mk ml dn lm mm mn dp lq kb mo mp lu kf mq mr ly kj ms mt mc mu bi translated">输入:</h2><p id="1326" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">我们有两个人脸图像，图像 1 和图像 2，我们的两个基本模型将采取这些图像中的每一个。Facenet 会把 image_1 和 image_2 作为 input_1 和 input_2。VGGFace 会把 image_1 和 image_2 作为 input_3 和 input_4。</p><blockquote class="nf ng nh"><p id="f077" class="jq jr ko js b jt ju jv jw jx jy jz ka ni kc kd ke nj kg kh ki nk kk kl km kn im bi translated">注:不同型号的图像输入尺寸不同。</p></blockquote><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="4acd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在将输入图像通过两个基本模型后，我们将得到两个图像的人脸嵌入。我们有</p><p id="ca1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">来自 Facenet 模型的图像 1 的 x1-面部嵌入</p><p id="8bff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">来自面网模型的图像 2 的 x2 面嵌入</p><p id="f124" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">来自 VGGFace 模型的图像 1 的 x3-人脸嵌入</p><p id="0807" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">来自 VGGFace 模型的图像 2 的 x4-人脸嵌入</p><p id="3e41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以将这些嵌入直接用于我们的分类任务，方法是将它们通过密集的 FC 层，但不是这样做，而是将这些嵌入组合或合并以获得更好的结果，这将是一个很好的特征工程技巧。</p><p id="c79d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如:对向量 x1 求平方可以给出关于 image_1 的更多信息。</p><p id="6b7c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像这样，我们可以使用许多不同的组合，如加法(x1，x2)乘法(x3，x4)等。这方面的代码如下所示:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="2011" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们已经准备好了模型架构。下一步是开始用一些损耗和优化器来训练它。在训练模型之前，我们需要定义一些帮助函数，它们将在训练和推理步骤中帮助我们。</p><p id="7b6b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">read_img_fn '将采用输入图像的路径，并返回具有预定义大小的相同图像。请记住，我们对不同的基本模型使用不同的图像输入尺寸。与此类似，另一个函数‘read _ img _ vgg’将为 VGGFace 模型做同样的事情。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7d20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个特殊的辅助函数“生成”用于生成具有某个固定 bath_size 的成批图像对。对于每一批，它将返回四个图像的组合(每一对用于两个模型的输入)和标签。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><h1 id="7813" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">损失函数和模型配置:</h1><p id="9f61" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">正如我们在开始时讨论的，这是一个二元分类问题。我们将使用二元交叉熵或对数损失作为这个问题的损失函数。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/cb2b6488016343c4b8f26ecf0675c9f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/0*2m6jXyz8afxwmz5r.png"/></div></figure><p id="37e8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了配置模型，我们将使用准确性作为工具来跟踪性能，而训练和优化器将是学习率= 1e-5 的 Adam。</p><h1 id="dea7" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">训练:</strong></h1><p id="a50b" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">最后，我们准备好训练上面定义的模型。使用回调在各个点存储和使用训练好的模型，训练的最终代码看起来是这样的。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="a004" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以看到，我们正在使用“生成”辅助函数来生成批量大小为 16 的图像。在几个时期的训练之后，模型收敛，并且精度没有从那里提高。</p><p id="7df3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，用文件名'<strong class="js iu"> <em class="ko"> facenet_vgg.h5 '保存训练好的模型。</em> </strong></p><h1 id="959d" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">评估:</h1><p id="a1fb" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">现在，我们可以使用这个训练好的模型来预测给定两个输入图像的概率。为此，我们将使用 Kaggle 提供的“sample_submission.csv”文件。该文件包含成对的图像，模型需要预测亲属关系的概率。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="1105" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后将这个文件“face_vgg.csv”提交给 Kaggle 来检查分数。我们的模型表现良好，在私有 lb 上给出的 AUC 分数为“0.887”，在公共 lb 上给出的 AUC 分数为“0.881”。</p><blockquote class="nt"><p id="0135" class="nu nv it bd nw nx ny nz oa ob oc kn dk translated">由此，我们可以说，我们复杂的深度学习模型在这项任务中表现良好，并准备投入生产。</p></blockquote><h1 id="6990" class="lg lh it bd li lj lk ll lm ln lo lp lq lr oj lt lu lv ok lx ly lz ol mb mc md bi translated">生产途径:</h1><p id="1ced" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">我们将使用基于 Python 的微型 web 框架 Flask 在本地主机上制作一个简单的 web 服务器，它将充当 API，并帮助最终用户与我们训练过的模型进行通信。所以现在任何人都可以访问我们的模型。</p><p id="7bbf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，让我们使用 Flask 构建一个简单的 web API 来演示事情是如何工作的。</p><p id="3b04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要制作两个不同的文件。</p><p id="c648" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">1- app.py —后端的 Flask 脚本</p><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="0c5a" class="mj lh it my b gy np nq l nr ns">from flask import Flask, request, render_template<br/>app = Flask(__name__)</span><span id="86a4" class="mj lh it my b gy om nq l nr ns"><a class="ae kp" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/')<br/>def hello_world():<br/>    return render_template('index.html')</span></pre><p id="51a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面的代码将导入必要的文件并启动 Flask 实例。函数 hello_world()将把我们的主页呈现给用户。</p><p id="7790" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2-index.html-用户将在前端看到的主页 html 文件。</p><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="dbd0" class="mj lh it my b gy np nq l nr ns">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;Flask&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;p&gt;Hello world&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="a8c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们有了我们需要的两个文件。运行 app.py 文件后，用户将能够看到“Hello world”页面。</p><p id="5a3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在构建之前，让我们首先想象一下事物如何工作的整体结构。用户将看到一个网页，要求他/她上传两个图像文件，他/她需要看看他们是否有血缘关系。在后端，我们的 Flask 脚本将访问这两个图像，并在其上运行所需的操作。它将获取图像，执行预处理，然后将它们传递给我们训练好的模型。最后，该模型将预测概率，并在前端投射给用户。</p><p id="a72a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们将开始构建我们的亲属预测 API。</p><p id="9a27" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我们项目布局的样子——</p><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="7c27" class="mj lh it my b gy np nq l nr ns"><strong class="my iu">/Kin-Prediction<br/>   ├── templates<br/>       └── index.html<br/>       └── end.html</strong></span><span id="eb3c" class="mj lh it my b gy om nq l nr ns"><strong class="my iu">   ├── static<br/>       └── Image1<br/>       └── Image2<br/>   ├── venv/<br/>   ├── app.py<br/>   ├── facenet_vgg.h5   </strong></span></pre><p id="d262" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">项目文件夹包含我们的烧瓶需要的所有文件。</p><p id="415c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">文件夹模板将包含前端的 HTML 文件，Flask 将在需要时使用这些文件进行渲染。</p><p id="2493" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">静态文件夹将包含用户将上传用于预测的图像。</p><p id="a0b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“facenet_vgg.h5”是我们训练好的模型，需要保存在目录中，以便 Flask 可以直接使用它。</p><p id="4850" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">app.py 文件是将运行并执行所有后端操作的主 Flask 脚本。</p><p id="1abe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">app.py 中的以下函数将为用户呈现主页。</p><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="1126" class="mj lh it my b gy np nq l nr ns">@app.route('/')<br/>@app.route('/home')<br/>def upload_image():<br/>    return flask.render_template('index.html')</span></pre><p id="ea08" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">index.html 的文件如下所示:</p><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="a9eb" class="mj lh it my b gy np nq l nr ns">&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;title&gt;Kin Relationship&lt;/title&gt;<br/>&lt;/head&gt;<br/>   &lt;body  style="background-color:gray;"  &gt;<br/>      &lt;form action = "http://localhost:5000/upload" method = "POST"<br/>         enctype = "multipart/form-data"  align="center"&gt;<br/>         First Image:&lt;label&gt;<br/>         &lt;input type = "file" name = "file1" /&gt;&lt;/label&gt;<br/>         Second Image&lt;label&gt;<br/>         &lt;input type = "file" name = "file2" /&gt;&lt;/label&gt;<br/><br/>         &lt;label&gt;<br/>         &lt;input type = "submit" value="Predict"/&gt; &lt;/label&gt;<br/><br/>      &lt;/form&gt;<br/>   &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="c85a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该页面将如下所示:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi on"><img src="../Images/c191b740ec8aa64933815ba4c581d5e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FNYOtHuz0lg33cbCr5pvHg.jpeg"/></div></div></figure><p id="35fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">选择图像并点击预测按钮后，这两幅图像都将被上传并保存到我们的本地目录文件夹中，该文件夹是“静态”的。Flask 将从那里访问图像并执行所需的操作，最后预测概率。</p><p id="7cac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">app.py 文件中的代码如下所示:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="0515" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，flask 将使用图像和预测来呈现模板“end.html”。</p><pre class="kr ks kt ku gt nl my nm nn aw no bi"><span id="524e" class="mj lh it my b gy np nq l nr ns">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;title&gt;Prediction&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body style="background-color:powderblue;"&gt;<br/>&lt;div&gt;<br/>{% for i in image_name %}<br/><br/>&lt;img src=" {{url_for('static', filename=i) }} " style="width:250px;height:300px;"  hspace="200"&gt;<br/><br/>{% endfor %}<br/><br/>&lt;/div&gt;<br/><br/>&lt;h1 style="font-family:verdana;"&gt; Probablity of two persons having kin relation is {{pred}} &lt;/h1&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="2d6c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就是这样。我们的模型已经准备好并正在本地主机上运行。你可以在这里下载并参考完整代码<a class="ae kp" href="https://github.com/Utkarshupd/Kin_Relation_Prediction" rel="noopener ugc nofollow" target="_blank">。</a></p><blockquote class="nt"><p id="78ca" class="nu nv it bd nw nx ny nz oa ob oc kn dk translated">我试着这样做，首先用我和我爸爸的照片，然后用妈妈和爸爸的照片。在这两种情况下，模型都工作得非常好，并分别预测高概率(血缘相关)和低概率(血缘不相关)。</p></blockquote><h1 id="956f" class="lg lh it bd li lj lk ll lm ln lo lp lq lr oj lt lu lv ok lx ly lz ol mb mc md bi translated">视频:</h1><p id="d930" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">这是展示上述实验的视频。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="oo ne l"/></div></figure><h1 id="fbdd" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">待办任务:</h1><p id="d2fb" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">1-我们可以将它部署在基于云的 web 服务上，而不仅仅是在本地服务器上运行，比如 Heroku，这样任何地方的任何人都可以访问你的模型。</p><p id="3d00" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2-目前，我们的模型只拍摄人脸图像，因为它只在人脸上进行训练。如果给定一个人的完整图像，它将不起作用。我们可以构建一个不同的解决方案来处理这个问题。</p><p id="8a7d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3-使用先进的 CSS 和 javascript，我们可以设计我们的前端看起来不错。</p></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><p id="a857" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">谢谢你在这个博客中走了这么远。希望你喜欢。有什么建议可以通过<a class="ae kp" href="https://www.linkedin.com/in/iutkarshdixit/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>联系我。</p><h1 id="2bff" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">参考资料:</h1><p id="fb8d" class="pw-post-body-paragraph jq jr it js b jt me jv jw jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn im bi translated">1-<a class="ae kp" href="https://www.kaggle.com/c/recognizing-faces-in-the-wild/overview" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/c/recogniting-faces-in-the-wild/overview</a></p><p id="b836" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">2-<a class="ae kp" href="https://blog.keras.io/building-a-simple-keras-deep-learning-rest-api.html" rel="noopener ugc nofollow" target="_blank">https://blog . keras . io/building-a-simple-keras-deep-learning-rest-API . html</a></p><p id="8343" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3-<a class="ae kp" href="https://heartbeat.fritz.ai/brilliant-beginners-guide-to-model-deployment-133e158f6717" rel="noopener ugc nofollow" target="_blank">https://heart beat . fritz . ai/brilliant-初学者-模型部署指南-133e158f6717 </a></p><p id="3dd1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">4-<a class="ae kp" href="https://www.curiousily.com/posts/deploy-keras-deep-learning-project-to-production-with-flask/?fbclid=IwAR1t8EFUOZsh0s5tTN9b-EvBnWP1nwR89WAyzdg5e_TwaPwK1bGgvQZrC2U#build-rest-api" rel="noopener ugc nofollow" target="_blank">https://www . curious ly . com/posts/deploy-keras-deep-learning-project-to-production-with-flask/？FB clid = iwar 1t 8 efuozsh 0s 5t TN 9 b-evbnwp 1 nwr 89 wayzdg 5 e _ twa pwk 1 bggvqzrc 2u # build-rest-API</a></p></div></div>    
</body>
</html>