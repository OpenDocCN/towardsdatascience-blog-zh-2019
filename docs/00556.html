<html>
<head>
<title>How to do Bayesian hyper-parameter tuning on a blackbox model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在黑盒模型上进行贝叶斯超参数调整</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-bayesian-hyper-parameter-tuning-on-a-blackbox-model-882009552c6d?source=collection_archive---------16-----------------------#2019-01-25">https://towardsdatascience.com/how-to-do-bayesian-hyper-parameter-tuning-on-a-blackbox-model-882009552c6d?source=collection_archive---------16-----------------------#2019-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1432" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">云 ML 引擎上任意函数的优化</h2></div><p id="9a88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">谷歌云 ML 引擎提供了一个使用贝叶斯方法的超参数调整服务。它不限于 TensorFlow 或 scikit-learn。事实上，它甚至不仅限于机器学习。您可以使用贝叶斯方法来调整几乎任何黑盒模型。</p><p id="adf6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了进行演示，我将调整一个流量模型，以找到能使给定流的延迟最小的流量配置。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/fd89118f25ace8b11588e890593fc0f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bJAfxV4qB-R6ajA8GdSKQA.jpeg"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk">I’ll demonstrate the hyper-parameter tuning on a traffic model. Photo by <a class="ae lr" href="https://unsplash.com/photos/7nrsVjvALnA?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Denys Nevozhai</a> on <a class="ae lr" href="https://unsplash.com/search/photos/traffic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="75a9" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">1.调用要优化的黑盒函数</h2><p id="b548" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">为了简单起见，我将在 Python 本身中实现“黑盒函数”(它改编自几个<a class="ae lr" href="http://www.math.wpi.edu/saspdf/iml/chap11.pdf" rel="noopener ugc nofollow" target="_blank">数值软件包</a>中使用的一个例子)。在现实生活中，您可以调用任何可执行文件，因此您不局限于 Python。只要确保得到一个与您想要最小化或最大化的东西(在这个例子中是延迟)相对应的浮点值。</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="48da" class="ls lt iq mr b gy mv mw l mx my">def compute_delay(flow, x12, x32):<br/>    # traffic on other roads, assuming all traffic that arrives<br/>    # at an intersection has to leave it<br/>    x13 = flow - x12<br/>    x24 = x12 + x32<br/>    x34 = x13 - x32</span><span id="0a8d" class="ls lt iq mr b gy mz mw l mx my">    # travel time on each road segment<br/>    t12 = 5 + .1 * x12 / (1. - x12 / 10.);<br/>    t13 = x13 / (1. - x13 / 30.);<br/>    t32 = 1. + x32 / (1. - x32 / 10.);<br/>    t24 = x24 / (1. - x24 / 30.);<br/>    t34 = 5 + .1 * x34 / (1. - x34 / 10.);<br/>  <br/>    # total delay<br/>    f = t12*x12 + t13*x13 + t32*x32 + t24*x24 + t34*x34;<br/>    return(f);</span></pre><p id="6c73" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">给定节点间的交通流量和我们期望的车辆/小时总流量，上面的模型计算道路网络中的总交通延迟。</p><p id="f18e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要为某个流量值找到 x12 和 x32 的最佳值。</p><h2 id="9829" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">2.创建命令行参数</h2><p id="6cfa" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">确保每个可优化的参数都是命令行参数:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="057e" class="ls lt iq mr b gy mv mw l mx my">    parser = argparse.ArgumentParser()<br/>    parser.add_argument('--x12', type=float, required=True)<br/>    <strong class="mr ir">parser.add_argument('--x32', type=float, required=True)</strong></span></pre><h2 id="d1ae" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">3.调用 hypertune 软件包</h2><p id="54e3" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">然后，写出我们希望使用 hypertune 软件包优化的指标:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="aaac" class="ls lt iq mr b gy mv mw l mx my">    hpt = hypertune.HyperTune()<br/>    <strong class="mr ir">hpt.report_hyperparameter_tuning_metric</strong>(<br/>       <strong class="mr ir">hyperparameter_metric_tag='delay'</strong>,<br/>       metric_value=delay,<br/>       global_step=1)</span></pre><h2 id="9a75" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">4.编写 hyperparam.yaml 文件</h2><p id="8869" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">编写一个配置文件。该文件应该包含要在其上运行代码的机器的类型、要优化的指标的名称以及要优化的每个参数的约束条件:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="2a23" class="ls lt iq mr b gy mv mw l mx my">trainingInput:<br/>  scaleTier: CUSTOM<br/>  <strong class="mr ir">masterType: standard  # machine-type</strong><br/>  hyperparameters:<br/>    goal: MINIMIZE<br/>    maxTrials: 10<br/>    maxParallelTrials: 2<br/>    <strong class="mr ir">hyperparameterMetricTag: delay</strong><br/>    params:<br/>    - parameterName: x12<br/>      type: DOUBLE<br/>      minValue: 0<br/>      maxValue: 10<br/>      scaleType: UNIT_LINEAR_SCALE<br/>    <strong class="mr ir">- parameterName: x32<br/>      type: DOUBLE<br/>      minValue: 0<br/>      maxValue: 10<br/>      scaleType: UNIT_LINEAR_SCALE</strong></span></pre><h2 id="bdde" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">5.将超参数调整作业提交给 ML 引擎</h2><p id="07b2" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">您可以使用 REST API 或 Python，但最简单的方法是从命令行使用 gcloud:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="1187" class="ls lt iq mr b gy mv mw l mx my">#!/bin/bash<br/>BUCKET=&lt;yourbuckethere&gt;<br/>JOBNAME=hparam_$(date -u +%y%m%d_%H%M%S)<br/>REGION=us-central1<br/>gcloud ml-engine jobs <strong class="mr ir">submit training</strong> $JOBNAME \<br/>  --region=$REGION \<br/>  --module-name=<strong class="mr ir">trainer.flow</strong> \<br/>  --package-path=$(pwd)/trainer \<br/>  --job-dir=gs://$BUCKET/hparam/ \<br/>  <strong class="mr ir">--config=hyperparam.yaml</strong> \<br/>  -- \<br/>  --flow=5</span></pre><h2 id="23f2" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">6.在 GCP 控制台上查看结果</h2><p id="fac7" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">等待作业完成，并在<a class="ae lr" href="https://console.cloud.google.com/mlengine" rel="noopener ugc nofollow" target="_blank"> GCP 控制台</a>上查看结果。我有:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="bf90" class="ls lt iq mr b gy mv mw l mx my">  {<br/>      "trialId": "8",<br/>      "hyperparameters": {<br/>        <strong class="mr ir">"x12": "0.70135653339854276",<br/>        "x32": "0.018214831148084532"</strong><br/>      },<br/>      "finalMetric": {<br/>        "trainingStep": "1",<br/>        <strong class="mr ir">"objectiveValue": 50.2831830645</strong><br/>      }<br/>    },</span></pre><p id="1e60" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种道路配置的实际最佳值是 40.3 的延迟；即使搜索空间很大并且问题是非线性的，我们在 10 次尝试中还是得到了相对接近的结果。</p><h2 id="06aa" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">后续步骤:</h2><ol class=""><li id="bbb4" class="na nb iq kh b ki ml kl mm ko nc ks nd kw ne la nf ng nh ni bi translated">试试看。<a class="ae lr" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/hparam" rel="noopener ugc nofollow" target="_blank">的完整代码在 GitHub </a>上。</li><li id="231f" class="na nb iq kh b ki nj kl nk ko nl ks nm kw nn la nf ng nh ni bi translated">阅读关于超参数调整的 ML 引擎<a class="ae lr" href="https://cloud.google.com/ml-engine/docs/tensorflow/hyperparameter-tuning-overview" rel="noopener ugc nofollow" target="_blank">文档。</a></li><li id="8d21" class="na nb iq kh b ki nj kl nk ko nl ks nm kw nn la nf ng nh ni bi translated">阅读可用的<a class="ae lr" href="https://cloud.google.com/ml-engine/docs/tensorflow/machine-types" rel="noopener ugc nofollow" target="_blank">机器类型</a>的 ML 引擎文件。</li></ol></div></div>    
</body>
</html>