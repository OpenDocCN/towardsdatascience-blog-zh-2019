<html>
<head>
<title>How to bring your Data Science Project in production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将您的数据科学项目投入生产</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-bring-your-data-science-project-in-production-b36ae4c02b46?source=collection_archive---------7-----------------------#2019-01-20">https://towardsdatascience.com/how-to-bring-your-data-science-project-in-production-b36ae4c02b46?source=collection_archive---------7-----------------------#2019-01-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0e58" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将 Azure 数据块与 Spark、Azure ML 和 Azure DevOps 一起使用</h2></div><h1 id="2bdc" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">1.介绍</h1><p id="5a6e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">许多公司努力将他们的数据科学项目投入生产。一个常见的问题是，模型越接近生产，就越难回答以下问题:</p><ul class=""><li id="487e" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">为什么模型会预测到这一点？</li></ul><p id="e236" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">拥有数据科学项目的构建/发布管道有助于回答这个问题。它使您能够追溯:</p><ul class=""><li id="feac" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">模型 M 由人 P 用算法 A 在数据集 D 上训练</li><li id="7c74" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">型号 M 在 R 版中于时间 T 投入生产</li></ul><p id="8f6e" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">这种审计跟踪对于生产中运行的每个模型都是必不可少的，并且在许多行业中都是必需的，例如金融业。</p><p id="31d6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated"><strong class="lc iu"> <em class="mp">博客/git 回购最后更新:2021 年 7 月 21 日。感谢</em></strong><a class="ae mq" href="https://www.linkedin.com/in/pardeepsingla87" rel="noopener ugc nofollow" target="_blank"><strong class="lc iu"><em class="mp">Pardeep Singla</em></strong></a><strong class="lc iu"><em class="mp">修复了 Azure ML 中一些突破性的改动。</em>T13】</strong></p><p id="8c21" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated"><strong class="lc iu"> <em class="mp">我了解到这个博客/回购经常用在演示、教程等中。如果你也这样做，请不要犹豫联系我，我很想知道。</em> </strong></p><h1 id="1bf5" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">2.目标</h1><p id="c7f5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本教程中，机器学习项目的构建/发布管道创建如下:</p><ul class=""><li id="8029" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">创建一个 HTTP 端点，使用年龄、每周工作时间、教育程度等特征来预测一个人的年收入是高于还是低于 50k。</li><li id="e2b8" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">Azure Databricks 与 Spark、Azure ML 和 Azure DevOps 一起用于创建模型和端点。Azure Kubernetes 服务(AKS)同时用作测试和生产环境。</li></ul><p id="d11c" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">该项目可以在以下高级概述中进行描述:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/7c8ff155553f30ffd687008209da91ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBabtx4amJ9bEmO15gBYFg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">2. High level overview</figcaption></figure><p id="9777" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在本博客的剩余部分，将执行以下步骤:</p><ul class=""><li id="f107" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">3.先决条件</li><li id="a0e0" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">4.在 Azure Databricks 中创建机器学习模型</li><li id="8745" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">5.Azure 机器学习服务中的管理模型</li><li id="6dda" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">6,7.在 Azure DevOps 中构建和发布模型</li><li id="c8f6" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">8.结论</li></ul><p id="8d86" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">博客的后续可以在<a class="ae mq" rel="noopener" target="_blank" href="/how-to-embed-security-in-your-azure-data-science-project-55ef3f2ab47">这里</a>找到，其中安全性被嵌入到构建/发布管道中。此外，审计跟踪的细节将在的博客<a class="ae mq" rel="noopener" target="_blank" href="/how-to-troubleshoot-your-azure-data-science-project-in-production-5382b66cbaf9">中讨论。最后，如果你对如何在 Azure Data Factory 中使用 Azure Databricks 感兴趣，请参考这个</a><a class="ae mq" href="https://cloudarchitected.com/2019/04/devops-in-azure-with-databricks-and-data-factory/" rel="noopener ugc nofollow" target="_blank">博客</a>。</p><h1 id="d1c1" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">3.先决条件</h1><p id="43bb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">本教程需要以下资源:</p><ul class=""><li id="83a6" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated"><a class="ae mq" href="https://docs.azuredatabricks.net/getting-started/try-databricks.html#step-2-create-a-databricks-workspace" rel="noopener ugc nofollow" target="_blank"> Azure 数据块</a></li><li id="3761" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated"><a class="ae mq" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/quickstart-get-started#create-a-workspace" rel="noopener ugc nofollow" target="_blank"> Azure 机器学习服务</a></li><li id="47cb" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated"><a class="ae mq" href="https://visualstudio.microsoft.com/team-services/" rel="noopener ugc nofollow" target="_blank">蔚蓝 DevOps </a></li></ul><h1 id="1346" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated"><strong class="ak"> 4。在 Azure Databricks 中创建机器学习模型</strong></h1><p id="82b3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Azure Databricks 是一个基于 Apache Spark 的分析平台，针对 Azure 进行了优化。它可以用于许多分析工作负载，其中包括机器学习和<a class="ae mq" rel="noopener" target="_blank" href="/how-to-create-your-own-deep-learning-project-in-azure-509660d8297">深度学习</a>。在此步骤中，将完成以下工作:</p><ul class=""><li id="2d1d" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">4a。创建新集群</li><li id="4eaf" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">4b。导入笔记本</li><li id="a443" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">4c。运行笔记本</li></ul><h2 id="8a0e" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated"><strong class="ak"> <em class="nt"> 4a。创建新的集群</em> </strong></h2><p id="df21" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">启动 Azure Databricks 工作区并转到群集。使用以下设置创建新集群(2020 年 9 月编辑:在 devOps pipeline 中，Databricks Runtime 6.6。被使用，建议在数据块中也使用这个运行时版本进行交互式分析):</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nu"><img src="../Images/6976e6157c8c74e39a495a49b902ba44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EjtRhCH6SUA6Wuus-j-pDA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">4a1. Create cluster</figcaption></figure><h2 id="7629" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated"><strong class="ak"> <em class="nt"> 4b。导入笔记本</em> </strong></h2><p id="ada3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的 Azure Databricks 工作区，右键单击，然后选择导入。在单选按钮中，选择使用 URL 导入以下笔记本:</p><pre class="ms mt mu mv gt nv nw nx ny aw nz bi"><span id="bae4" class="nh kj it nw b gy oa ob l oc od"><a class="ae mq" href="https://raw.githubusercontent.com/rebremer/devopsai_databricks/master/project/modelling/1_IncomeNotebookExploration.py" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/rebremer/devopsai_databricks/master/project/modelling/1_IncomeNotebookExploration.py</a></span></pre><p id="4d24" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">另请参见下图:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oe"><img src="../Images/0df07fccbc090bc305313069b0d64f21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P-jdfwh_MxqeMz9oaN6yBA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">4b1. Import notebook</figcaption></figure><h2 id="912e" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated"><strong class="ak"> <em class="nt"> 4c。运行笔记本</em> </strong></h2><p id="e5c1" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">选择您在 4b 中导入的笔记本，并将该笔记本连接到您在 4a 中创建的集群。确保集群正在运行，否则启动它。阅读笔记本中的步骤，其中研究了数据，并尝试了几种设置和算法，以创建一个预测一个人收入阶层的模型。使用快捷键 SHIFT+ENTER 逐个单元格地浏览笔记本。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi of"><img src="../Images/f9403abaa5e7518af7c4057ee5bd5be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9lC44iMXrszFpqjCijujcw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">4c1. Steps in notebook</figcaption></figure><h1 id="3f3b" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">5.Azure 机器学习服务中的管理模型</h1><p id="e3df" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Azure 机器学习服务(Azure ML)是一种云服务，您可以使用它来训练、部署、自动化和管理机器学习模型。在这个上下文中，上一步中创建的模型将被添加到您的 Azuere ML 实例中。将执行以下步骤</p><ul class=""><li id="4b40" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">5a。将库添加到数据块群集中</li><li id="c8af" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">5b。使用 Azure ML 将笔记本导入到 Azure Databricks</li><li id="732f" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">5c。在 Azure ML 中查看结果</li></ul><h2 id="b2dc" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">5a。将库添加到数据块群集中</h2><p id="7cca" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">右键单击您的工作区并选择“创建库”</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi og"><img src="../Images/5da6e724122a0e815cf112cee14670f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A533qMaDiahG4GTCBv0GeQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5a1. Create library</figcaption></figure><p id="4d71" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">选择 PyPi，然后填写:azureml-sdk[databricks]</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oh"><img src="../Images/5f8a1bbb1de3d025033d10842ef27b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lhso-BG6MNRwDBCZ3AZj6Q.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5a2. Add PyPi library with azureml-sdk[databricks]</figcaption></figure><p id="7536" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">最后，将库连接到群集。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oi"><img src="../Images/b728ddd7b40d4c19044cd9a1e9fca008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgSm8jIvgHkOV8CcTYXABQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5a3. Attach library to cluster</figcaption></figure><h2 id="6640" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">5b。使用 Azure ML 将笔记本导入到 Azure Databricks</h2><p id="c69b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本教程的上一部分，我们在 Azure Databricks 中创建了一个模型。在这一部分中，您将把创建的模型添加到 Azure 机器学习服务中。</p><p id="75bf" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">再次转到您的 Databricks 服务，右键单击，选择导入，并使用以下 URL 导入笔记本:</p><pre class="ms mt mu mv gt nv nw nx ny aw nz bi"><span id="766c" class="nh kj it nw b gy oa ob l oc od"><a class="ae mq" href="https://raw.githubusercontent.com/rebremer/devopsai_databricks/master/project/modelling/2_IncomeNotebookAMLS.py" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/rebremer/devopsai_databricks/master/project/modelling/2_IncomeNotebookAMLS.py</a></span></pre><p id="44c6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">同样，确保它已连接到群集，并且群集正在运行</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oj"><img src="../Images/fa207ce4ed65b1fbfa4c8a76ea6517b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-7SFIOTVmmrp_SvmtLwCw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5b1. Import Azure ML notebook</figcaption></figure><p id="fc00" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">随后，为 workspace、subscription_id 和 resource_grp 填入正确的值。所有值都可以在 Azure 门户的 Azure 机器学习服务工作区的 overview 选项卡中找到。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ok"><img src="../Images/87b5a204b4d75de195e9fffa86c65d66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SJrElsxy_J6y5X3LNbWHVQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5b2. Add variables notebook</figcaption></figure><p id="82cb" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">现在，使用快捷键 SHIFT+ENTER 逐个单元格地运行笔记本单元格。</p><p id="0823" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在 cell 6 中，您需要向笔记本中的 Azure 机器学习服务进行身份验证。按照笔记本中的说明打开 URL，并输入生成的代码进行身份验证。</p><h2 id="ffd9" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">5c。在 Azure ML 中查看结果</h2><p id="ddfe" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在步骤 5b 中，运行一个笔记本，其中的结果被写入 Azure 机器学习服务。在这方面，完成了以下工作:</p><ul class=""><li id="9575" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">在 you Azure ML 中创建了一个新的实验</li><li id="bd2a" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">在这个实验中，具有 6 个子运行的根运行可以找到不同的尝试。</li><li id="f586" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">子运行包含模型的描述(例如正则化为 0 的逻辑回归)和尝试的最重要记录(例如准确性、假阳性的数量)</li><li id="32ef" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">模型人工制品(。mml)也是子运行的一部分。最佳子运行的工件可以投入生产。</li></ul><p id="09eb" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">转到您的 Azure ML 实例。选择笔记本中使用的实验名称(例如，experiment_model_int)。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ol"><img src="../Images/b0e37a0a5d8966acac9ac059519b2ac7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mdCmBc4gPhcAUAJgzxi6kQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5c1. Find experiment in Azure Machine Learning Service</figcaption></figure><p id="c8a7" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">现在单击实验，单击您想要查看指标的运行和子运行。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/958c91e96869112b0857e68f5dbb9dbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GLsqsS9Ni2SYAchwsukWQA.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5c2. Find metrics of a childrun in Azure Machine Learning Service</figcaption></figure><p id="bef7" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">你去输出的时候会发现模型神器，也可以下载。在本教程的下一部分中，最佳运行的模型工件将被用作使用 Azure DevOps 部署的容器的基础。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi om"><img src="../Images/9d9b2ac6f15138d63d899e70caffe662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ym8jDv-TrLXxi7Qdifcndg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">5c3. Model artifact</figcaption></figure><h1 id="8424" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">6.创建和准备 Azure DevOps 项目</h1><p id="f169" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Azure DevOps 是一个工具，可以持续地构建、测试和部署你的代码到任何平台和云。在第 6 章中，将创建并准备一个 Azure DevOps。该项目将采用以下步骤进行准备:</p><ul class=""><li id="da86" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">6a。在数据块中创建个人访问令牌</li><li id="e36e" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">6b。创建 AKS 集群</li><li id="03ed" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">6c。创建 Azure DevOps 项目和服务连接</li><li id="3f62" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">6d。向代码中添加变量</li></ul><p id="cf3c" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在第 7 章中，实际的构建-发布管道将被创建并运行以创建模型的一个端点。</p><h2 id="4189" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">6a。在数据块中创建个人访问令牌</h2><p id="a1b8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">要在 Azure DevOps(使用 REST APIs)触发的 Azure Databricks 中运行笔记本，需要 Databrics 访问令牌(PAT)进行身份验证。</p><p id="b323" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">进入 Azure Databricks，点击右上角的人物图标。选择用户设置，然后生成新令牌。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi on"><img src="../Images/b4aa56663694c670cedcacee205aa32a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y10JWCMzrJ-JiizDb5dSAg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">6a1. Generate Databricks Access Token</figcaption></figure><p id="19a5" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">请确保现在复制令牌。你再也看不到它了。稍后从 Azure DevOps 构建管道访问数据块需要令牌</p><h2 id="350c" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">6b。创建 AKS 集群</h2><p id="0100" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一步中，在 Azure Kubernetes Services (AKS)中创建了一个测试和生产环境。通常，这是两个独立的 AKS 环境，但是，为了简化和节约成本，只创建了一个环境。首先，转到您的 Azure ML 服务工作区并选择 Compute。取计算机名<strong class="lc iu"> blog-devai-aks </strong>并选择 Kubernetes 服务作为计算机类型，也见下文。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oo"><img src="../Images/ce51e7c9a538ca328f09a7e3c3a0d1d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JhnfDh0qyFgUcAPFNIsBDQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">6b1. Add AKS compute to Azure ML Service</figcaption></figure><p id="b758" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">创建 AKS 集群大约需要 10 分钟。继续下一步。</p><h2 id="a07a" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">6c。创建带有服务连接的 Azure DevOps 项目</h2><p id="409b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">按照<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/organizations/projects/create-project?view=azure-devops&amp;tabs=new-nav&amp;viewFallbackFrom=vsts" rel="noopener ugc nofollow" target="_blank">这个</a>教程，在 Azure DevOps 中创建新项目。创建新项目后，单击存储库文件夹并选择导入以下存储库:</p><pre class="ms mt mu mv gt nv nw nx ny aw nz bi"><span id="4e29" class="nh kj it nw b gy oa ob l oc od"><a class="ae mq" href="https://github.com/rebremer/devopsai_databricks.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/devopsai_databricks.git</a></span></pre><p id="5180" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">另请参见下图:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi op"><img src="../Images/91d73733c09e8878fd277c041efa83cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sXkun_OAUKavIpnSg8j0Uw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">6c1. Add repository to your Azure DevOps project</figcaption></figure><p id="2618" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">从 Azure DevOps 访问资源组中的资源需要服务连接。转到项目设置、服务连接，然后选择 Azure 资源管理器。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oq"><img src="../Images/2e29b1b409a10628ee826358d6d54d35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mdpNiigFyDQxrmw6.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">6c2. Go to Service Connection</figcaption></figure><p id="7e03" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">选择服务主体身份验证，并将范围限制在部署了机器学习工作区服务的资源组中。确保将连接命名为如下所示:<strong class="lc iu">devopsaisec _ service _ connection。</strong></p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi or"><img src="../Images/366b47cb175fb4c7d9c7d804247a742b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B6b8mUHFbkkHw-i-.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">6c3. Create Azure Resource Manager service connection</figcaption></figure><h2 id="45b3" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">6d。向代码中添加变量</h2><p id="b8c3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在您在上一步中创建的 Repos 中，应更改以下文件:</p><ul class=""><li id="0ae8" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">\ project \ config code _ build _ release . yml</li></ul><p id="e04f" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">对于工作空间、subscription_id 和 resource，使用与步骤 5b 中的机器学习服务工作空间的值相同的变量。此外，填写您在步骤 6a 中生成的 Databricks 个人访问令牌。</p><pre class="ms mt mu mv gt nv nw nx ny aw nz bi"><span id="8eb7" class="nh kj it nw b gy oa ob l oc od">variables:<br/>  # change 5 variables below with your own settings, make sure that <br/>  # : with a space is kept and not replaced with =<br/>  workspace: '&lt;&lt;Name of your workspace&gt;&gt;'<br/>  subscription_id: '&lt;&lt;Subscription id&gt;&gt;'<br/>  resource_grp: '&lt;&lt;Name of your resource group with aml service&gt;&gt;'<br/>  domain: 'westeurope.azuredatabricks.net' # change loc.when needed<br/>  dbr_pat_token_raw: '&lt;&lt;your Databricks Personal Access Token&gt;&gt;'</span></pre><p id="e4e6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在 Azure DevOps 中，可以通过在 Repos 中查找文件，点击“编辑”，更改变量，然后“提交”文件来更改文件。您还可以克隆项目并从那里开始工作。请注意，在生产环境中，绝不能将键添加到代码中。相反，Azure DevOps 管道中的<a class="ae mq" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&amp;tabs=yaml%2Cbatch#secret-variables" rel="noopener ugc nofollow" target="_blank">秘密变量</a>将被使用，并在后续的<a class="ae mq" rel="noopener" target="_blank" href="/how-to-embed-security-in-your-azure-data-science-project-55ef3f2ab47">教程</a>中处理。</p><p id="3edf" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在本章中，创建并准备了一个 Azure DevOps 项目。现在模型已经准备好在 Azure DevOps 项目中构建和发布了。</p><h1 id="7907" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">7.在 Azure DevOps 中构建和发布模型</h1><p id="c755" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一部分中，使用以下步骤在 Azure DevOps 中构建和发布模型:</p><ul class=""><li id="7d61" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">7a。创建构建-发布管道</li><li id="c66d" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">7b。运行构建-发布管道</li><li id="de39" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">7c。使用邮递员消费 HTTP 端点</li></ul><h2 id="c0d5" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">7a。创建构建-发布管道</h2><p id="2c06" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一步中，您将创建一个构建-发布管道。转到您在 6c 中创建的 Azure DevOps 项目，然后单击 Pipelines。将显示一个向导，您可以在其中选择 Azure Repos Git，另请参见下文。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi os"><img src="../Images/0db8984526e8c7ce4603710bc9209db1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hWc9ssEcXmVMI4Y0Mo17Sw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">7a1. Create Pipeline</figcaption></figure><p id="0c87" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">随后，选择附加到这个项目的 Git repo，然后选择“现有的 Azure Pipelines YAML 文件”。然后浏览目录\ project \ config code _ build _ release _ ACI _ only . yml 或\ project \ config code _ build _ release . yml(如果在步骤 6b 中创建了 AKS 集群，另请参见下文)。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ot"><img src="../Images/e9de74b8408aa9b791ace278dd722cdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*STDgfhFFSatI6CNe9SMgKw.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">7a2. Select build-release YAML file</figcaption></figure><p id="1db9" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">最后，检查您的管道并保存您的管道，另见下文。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ou"><img src="../Images/cf0606d641909e5c100cb8890ca9aba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QzYw6DCnRzSWu3TG_-7KqQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">7a3. Save pipeline</figcaption></figure><p id="7d6a" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在本章中，配置了管道。在此管道中，将执行以下步骤:</p><p id="2603" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">构建:</p><ul class=""><li id="18fe" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">选择 Python 3.6 并安装依赖项</li><li id="3b8a" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">将笔记本上传到数据块</li><li id="8b60" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">通过运行 notebook 使用 Azure Databricks 创建模型。向 Azure 机器学习服务添加模型</li><li id="9ecb" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">创建构建工件作为发布 deployTest 和 deployProd 的输入</li></ul><p id="ea30" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">发布部署测试:</p><ul class=""><li id="298f" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">检索在构建步骤中创建的模型</li><li id="a862" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">将模型作为 docker 映像部署到作为测试端点的 AKS</li><li id="f5f6" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">测试 AKS 中的“测试端点”</li></ul><p id="1bcd" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">释放部署杆:</p><ul class=""><li id="7852" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">检索在构建步骤中创建的模型</li><li id="63f1" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">将模型作为 docker 映像部署到作为 prd 端点的 AKS</li><li id="6ec7" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">在 AKS 中测试“生产端点”</li></ul><p id="3c8f" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">在下一部分中，将运行管道。</p><h2 id="d83a" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">7b。运行构建-发布管道</h2><p id="b41e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一步中，构建-发布管道将在 Azure DevOps 中运行。转到上一步中部署的管道，选择管道，然后选择队列，另请参见下文。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ou"><img src="../Images/dfc62cb48f08fbe599256b56ba154107.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ikydS7zU1NmLKAbZvhkxQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">7b1. Run build-release pipeline</figcaption></figure><p id="3512" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">当管道启动时，会在构建步骤中使用 Azure Databricks 和 Azure ML 创建一个包含 ML 模型的 docker 映像。随后，docker 映像在 ACI 和 AKS 中部署/发布。下面可以看到一次成功的运行。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ov"><img src="../Images/813618c405f71a422b9d69182e79b27c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xXffEFNIepSULR8LDBR2ww.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">7b2. Successful run of build-release pipeline</figcaption></figure><p id="b1b4" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">请注意，如果您决定不在 AKS 中部署 docker 映像，前面的步骤仍将执行，AKS 步骤将失败。要获得详细的日志记录，您可以单击各个步骤。</p><h2 id="6666" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">7c。使用邮递员消费 HTTP 端点</h2><p id="bb76" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">当你进入 Azure ML 工作区时，你可以找到你在 7b 中部署的模型的端点。这些端点现在将被<a class="ae mq" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a>用来创建预测。可以在项目中的项目/services/50_testEndpoint.py 中找到一个示例负载。在本例中，预测了三个人的收入等级。</p><ul class=""><li id="f727" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">对第一个人的预测是收入高于 50k，</li><li id="a52f" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">对于另外两个人，预测值低于 50k。</li></ul><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ow"><img src="../Images/71d66b018908b1dce84531b413f2615e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iBPaTogyUgonV-2kf3xHeg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">7c2. Use HTTP endpoint to create predictions</figcaption></figure><h1 id="7911" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">8.结论</h1><p id="c18b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本教程中，创建了一个机器学习项目的端到端管道。在此:</p><ul class=""><li id="8ae2" class="lw lx it lc b ld ly lg lz lj ma ln mb lr mc lv md me mf mg bi translated">Azure Databricks with Spark 用于探索数据和创建机器学习模型。</li><li id="dd4d" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">Azure 机器学习服务用于跟踪模型及其度量。</li><li id="823b" class="lw lx it lc b ld mk lg ml lj mm ln mn lr mo lv md me mf mg bi translated">Azure Devops 用于构建最佳模型的映像，并将其作为端点发布。</li></ul><p id="4fe6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">通过这种方式，您可以协调和监控从构思到模型投入生产的整个过程。这使您能够回答问题:<em class="mp">为什么模型会预测到这一点？</em></p><p id="d3bf" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj mh ll lm ln mi lp lq lr mj lt lu lv im bi translated">可以在下面找到架构概述。在<a class="ae mq" rel="noopener" target="_blank" href="/how-to-embed-security-in-your-azure-data-science-project-55ef3f2ab47">这个</a>后续教程中，管道的安全性得到了加强。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/7c8ff155553f30ffd687008209da91ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBabtx4amJ9bEmO15gBYFg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">8. High level overview</figcaption></figure></div></div>    
</body>
</html>