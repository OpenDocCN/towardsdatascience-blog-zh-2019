<html>
<head>
<title>TensorFlow.JS — Using JavaScript Web Worker to Run ML Predict Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">张量流。JS —使用 JavaScript Web Worker 运行 ML 预测函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tensorflow-js-using-javascript-web-worker-to-run-ml-predict-function-c280e966bcab?source=collection_archive---------18-----------------------#2019-09-06">https://towardsdatascience.com/tensorflow-js-using-javascript-web-worker-to-run-ml-predict-function-c280e966bcab?source=collection_archive---------18-----------------------#2019-09-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f9eb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这篇文章是关于客户端的机器学习。我将解释如何在 JavaScript Web Worker 中运行 ML 模型。该模型在 TensorFlow/Keras(使用 Python)中训练，以检测酒店评论的情绪。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/531120d9d21b093d0f2622eb848fb7c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*guASlqTk5o1W2s3a6OTyYA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Source: Pixabay</figcaption></figure><p id="6290" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我是 JavaScript 开发人员，当机器学习模型在客户端(在浏览器中)运行时，我感觉棒极了。如果你决定在浏览器中运行 ML 模型，我将在这篇文章中讨论几个主题，我相信你会发现它们很有用:</p><ul class=""><li id="a4ad" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">如何用 Python 训练 ML 模型</li><li id="929f" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">ML 模型如何转换为与 TensorFlow.js 兼容</li><li id="92e2" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">运行 TensorFlow.js 预测函数的 JavaScript Web Worker</li></ul><p id="d603" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我在用 ML 模型为一篇酒店评论预测情绪。我在 Kaggle 上发现了这个优秀的数据集— <a class="ae mi" href="https://www.kaggle.com/jiashenliu/515k-hotel-reviews-data-in-europe" rel="noopener ugc nofollow" target="_blank">欧洲 515K 酒店点评数据</a>。它提供了来自 Booking.com<a class="ae mi" href="http://www.booking.com" rel="noopener ugc nofollow" target="_blank"/>的 51.5 万条酒店评论记录。使用这个数据集，我训练了 Keras 模型，将其转换为与 TensorFlow.js 兼容，然后包含到客户端 js 应用程序中。你可以亲自检查它是如何工作的，这个应用程序部署在 Heroku—【https://sentiment-tfjs-node.herokuapp.com/ T4】:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://sentiment-tfjs-node.herokuapp.com/"><div class="gh gi mj"><img src="../Images/139a593c97f28d6c1d520f079fb3aa4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nnxzh6pR9NsPky57v6_mFQ.png"/></div></a><figcaption class="ku kv gj gh gi kw kx bd b be z dk">JS app with TensorFlow.js</figcaption></figure><p id="80dc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">试着输入<em class="mk">Bed comfort</em>，你会得到非常低的否定分数:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/39fe1cc4637c54e7adb3631ec44cfe7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wh-zcuCmqoKQ8OwvwVpsZg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">JS app with TensorFlow.js</figcaption></figure><p id="fd59" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后加上— V <em class="mk">外面很吵</em>，负面评分会增加到中性情绪:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mm"><img src="../Images/02cb69066b38fc45d451b54823d46094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tyJy6ZzYkH_fcA4SIyKWRg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">JS app with TensorFlow.js</figcaption></figure><p id="ec66" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">如何用 Python 训练 ML 模型</strong></p><p id="c1e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用 Zaid Alyafeai 帖子<a class="ae mi" href="https://medium.com/@alyafey22/sentiment-classification-from-keras-to-the-browser-7eda0d87cdc6" rel="noopener">中解释的方法实现文本情感分类——从 Keras 到浏览器的情感分类</a>。关于如何建立文本情感分类我就不深入解释了，你可以在 Zaid post 里看。</p><p id="6ad5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了能够训练模型，我处理了酒店评论数据集，并从所有属性中提取了酒店评论文本和情感(0-正面，1-负面)。我使用数据子集来训练模型，以减少训练时间。我使用了前 10 万条评论:</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="1fb4" class="ms mt it mo b gy mu mv l mw mx">df = pd.read_csv('hotel-reviews.csv', nrows=100000)<br/>df['REVIEW_TEXT'] = df['REVIEW_TEXT'].astype(str)<br/>print('Number of rows ', df.shape[0])</span></pre><p id="029a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用批量= 128(批量越大，训练越快)，在 5 个时期中训练该模型。验证集被分配了 20%的训练数据:</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="cdc4" class="ms mt it mo b gy mu mv l mw mx">model.fit(np.array(X_train_tokens), np.array(Y_train),<br/>          validation_split=0.2, epochs=5, batch_size=128)</span></pre><p id="6236" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">模型训练成功，验证准确率高达 94%；</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/5127b499be358c8568519820c72e07ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CNHmtSdrFbZ_ue42OwaPzg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Model training results</figcaption></figure><p id="ac3a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当模型被训练时，还有两件事要做。创建一个字典文件，它将用于编码用户语句，以供客户端预测功能处理。使用优化器保存模型，以便能够将其转换为 TensorFlow.js 友好表示。</p><p id="740b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">确保在保存模型时，训练过程只进行了一次(在保存之前，您没有多次运行训练，或者关闭 Python notebook 并从头开始进行新的训练)，否则保存的文件中的模型会过载，并且 TensorFlow.js 无法重用模型。</p><p id="0820" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">ML 模型如何转换为与 TensorFlow.js 兼容</strong></p><p id="cf29" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">保存模型后，将其转换为 TensorFlow.js 格式，这样将创建两个新文件(模型 bin 文件和包含元数据的 JSON 文件):</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="7f80" class="ms mt it mo b gy mu mv l mw mx">tensorflowjs_converter --input_format keras hotel-reviews-model.h5 tensorflowjs/</span></pre><p id="4f37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在此阅读更多信息— <a class="ae mi" href="https://www.tensorflow.org/js/tutorials/conversion/import_keras" rel="noopener ugc nofollow" target="_blank">将 Keras 模型导入 TensorFlow.js </a>了解如何将现有 Keras 模型转换为 TensorFlow.js，然后将其加载到 TensorFlow.js</p><p id="1e82" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> JavaScript Web Worker 运行 TensorFlow.js 预测函数</strong></p><p id="e8f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">TensorFlow.js <em class="mk"> predict </em>函数调用为什么需要使用 Web Worker？预测函数调用不是异步的，这意味着它阻塞主 JavaScript 线程，用户屏幕将被冻结，直到预测完成。情感分析预测需要几秒钟的时间，用户界面冻结会让用户烦恼。Web Worker 允许将长时间运行的任务委托给单独的 JavaScript 线程，而不会阻塞主线程。</p><p id="1481" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">JavaScript 应用基于<a class="ae mi" href="https://www.oracle.com/webfolder/technetwork/jet/globalGetStarted.html" rel="noopener ugc nofollow" target="_blank"> Oracle JET </a> toolkit(开源库集合— knockout.js、require.js 等。).要在您的计算机上运行示例应用程序，请执行以下命令:</p><ol class=""><li id="f3a0" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt mz ma mb mc bi translated">npm install -g @oracle/ojet-cli</li><li id="b98d" class="lu lv it la b lb md le me lh mf ll mg lp mh lt mz ma mb mc bi translated">从应用程序根文件夹运行:ojet 恢复</li><li id="9cb4" class="lu lv it la b lb md le me lh mf ll mg lp mh lt mz ma mb mc bi translated">从应用程序根文件夹运行:ojet serve</li></ol><p id="0434" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">appController.js 中有一个函数，每次当用户停止输入文本时都会被调用——调用预测情绪。此函数创建 Web Worker(如果不存在)并将用户输入发送到 Web Worker(输入被编码并准备好用于张量创建):</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="d98c" class="ms mt it mo b gy mu mv l mw mx">if (!worker) {<br/>  worker = new Worker("js/worker.js");<br/>}</span><span id="c3fa" class="ms mt it mo b gy na mv l mw mx">worker.postMessage(seq);<br/>worker.onmessage = function (event) {<br/>  console.log('prediction: ' + event.data);<br/>  self.negativityScore(event.data);<br/>  self.sentiment(convertToSentiment(event.data));<br/>};</span></pre><p id="c2d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">事件侦听器被注册来处理返回消息(预测)—它通过剔除可观察变量被推送到 UI。</p><p id="f285" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Web Worker 在 worker.js 文件中实现。这个文件在它自己的上下文中运行，您应该在这里隐式引用 TensorFlow.js 库。确保设置 CPU 后端，Web Worker 中的 TensorFlow.js 仅适用于 CPU 后端:</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="d761" class="ms mt it mo b gy mu mv l mw mx">importScripts('https://cdn.jsdelivr.net/npm/setimmediate@1.0.5/setImmediate.min.js');</span><span id="60e5" class="ms mt it mo b gy na mv l mw mx">importScripts('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2.7/dist/tf.min.js');</span><span id="6a89" class="ms mt it mo b gy na mv l mw mx">tf.setBackend('cpu');</span></pre><p id="4566" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是主代码(Web Worker 中的消息监听器)—调用 TensorFlow.js predict 函数(将用户输入转换为张量)的地方，结果通过消息返回到主线程:</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="207c" class="ms mt it mo b gy mu mv l mw mx">onmessage = async function (event) {<br/>  console.log('executing worker');<br/>  seq = event.data;<br/>  if (!model) {<br/>    model = await createModel();<br/>  }<br/>  input = tf.tensor(seq);<br/>  input = input.expandDims(0);<br/>  predictOut = model.predict(input);<br/>  score = predictOut.dataSync()[0];<br/>  postMessage(score);<br/>  predictOut.dispose();<br/>};</span><span id="e344" class="ms mt it mo b gy na mv l mw mx">async function createModel() {<br/>  const model = await tf.loadLayersModel('ml/model.json')<br/>  return model<br/>}</span></pre><p id="e39f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">资源:</p><ul class=""><li id="7014" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">源代码— <a class="ae mi" href="https://github.com/abaranovskis-redsamurai/automation-repo/tree/master/tfjs-sentiment" rel="noopener ugc nofollow" target="_blank"> GitHub </a></li><li id="3ab1" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">示例应用程序 live—<a class="ae mi" href="https://sentiment-tfjs-node.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://sentiment-tfjs-node.herokuapp.com/</a></li></ul></div></div>    
</body>
</html>