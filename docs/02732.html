<html>
<head>
<title>Sina_plot recreation with ggplot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">新浪 _ 剧情娱乐与 ggplot</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sina-plot-recreation-afcfdef028ac?source=collection_archive---------23-----------------------#2019-05-03">https://towardsdatascience.com/sina-plot-recreation-afcfdef028ac?source=collection_archive---------23-----------------------#2019-05-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4abe" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我最近被要求重新创建一个 ggplot 图表。</h2></div><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="95ae" class="kr ks it kn b gy kt ku l kv kw">knitr::include_graphics("images/image002.jpg")</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/2f0636d58e50fc4d4fd2bc75613e30d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*SvBv3zFTa8OvB9l-a09dVQ.jpeg"/></div></figure><p id="b86c" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">通过查看它，我能够确定一些虚拟数据，让自己开始…</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="7d9f" class="kr ks it kn b gy kt ku l kv kw"><em class="lx"># dummy data</em><br/><br/>small_group_size &lt;- 20<br/>large_group_size &lt;- 2000<br/><br/><br/>set.seed(123)<br/><br/>small_sample_1 &lt;- <br/>  tibble(value1 = rnorm(small_group_size, 70, 20), <br/>         value2 = rnorm(small_group_size, 150, 20),<br/>         group = "Group A") <br/><br/>small_sample_2 &lt;- <br/>  tibble(value1 = rnorm(small_group_size, 30, 20),<br/>         value2 = rnorm(small_group_size, 180, 20),<br/>         group = "Group B")<br/><br/>control &lt;- <br/>  tibble(value1 = rnorm(large_group_size, 50, 20), <br/>         value2 = rnorm(large_group_size, 220, 20),<br/>         group = "Group C")<br/><br/><br/><em class="lx"># let's put it all together and add a gender column, as well</em><br/><br/>data_collected &lt;- bind_rows(<br/>  small_sample_1, <br/>  small_sample_2,<br/>  control) %&gt;% <br/>  mutate(person_id_number = row_number()) %&gt;% <br/>  mutate_at(c("value1", "value2"), round, 2) %&gt;% <br/>  mutate(gender = sample(c("M", "F"), n(), replace = T)) %&gt;% <br/>  mutate(group = factor(group, levels = c("Group A", "Group B", "Group C")))<br/><br/><br/><em class="lx"># and tidy things up (if you want... object nuking, everying but)</em><br/>rm(list = setdiff(ls(), "data_collected"))</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi ly"><img src="../Images/5ba379b50ce1ad2785064f75f6ea50dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t9ApiPqhxVHa8t8vyKXZWg.png"/></div></div></figure><p id="7a49" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我发现在 ggforce 包里也有类似的东西，叫做 sina_plot。相似但不完全…来看看开箱的新浪 _ 剧情吧</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="d64c" class="kr ks it kn b gy kt ku l kv kw">data_collected %&gt;% <br/>  ggplot() +<br/>  aes(x = group, y = value1) +<br/>  ggforce::geom_sina()</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi md"><img src="../Images/550bdbd6ba61e82af75cd13c2ce06a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-0D6o0wKwXbkbqf861WYg.png"/></div></div></figure><p id="288f" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我看到的图表中有一些有趣的特征，是直线 sina_plot 没有给我的。首先，y 轴值被分类，刻度是某种形式的对数。加上 x 轴抖动是一个不规则的。让我们看看我们能否实现这一点…</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="eb00" class="kr ks it kn b gy kt ku l kv kw">given_levels &lt;- data_collected %&gt;% <br/>  mutate(value_measured = value1,<br/>         level_group = (value1 %/% 5) * 5,<br/>         level_group = pmax(level_group, 0)) %&gt;% <br/>  group_by(group, level_group) %&gt;% <br/>  mutate(count_of_entries = n(),<br/>         is_group_count_even = count_of_entries %% 2 == 0)</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div class="gh gi me"><img src="../Images/b8a3086762f94a1d407a75bed93cd039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*2-rXkqrt8fu2ZFRpxSBkog.png"/></div></figure><p id="0a54" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在，让我们用颜色来看看。</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="dfba" class="kr ks it kn b gy kt ku l kv kw">given_levels %&gt;% <br/>  ggplot() +<br/>  aes(x = group, y = level_group) +<br/>  ggforce::geom_sina()</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi md"><img src="../Images/14aef1e4930d23518163f6960e6d5ba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D1O7L-xN2Xdpi88Nu3_cBg.png"/></div></div></figure><p id="afa7" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">因此，看起来我必须确定数据准备中的 x 轴和 y 轴位置，并为不同的组使用一个面…并使用 geom_point 图表…稍后再担心颜色。</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="de65" class="kr ks it kn b gy kt ku l kv kw">given_levels_and_width_values &lt;- given_levels %&gt;% <br/>    mutate(count_of_entries = n(),<br/>         width_of_group = count_of_entries %/% 2,<br/>         width_position = row_number() - width_of_group - 1) %&gt;% <br/>  mutate(width_position = if_else(is_group_count_even &amp; width_position == 0, width_of_group, width_position)) %&gt;% <em class="lx"># this is tricky... Basically, if there's an even number, we want to relocate that x=0 point somehow...by putting it at the end... this is actually going to cause us problems later :-)</em><br/>  mutate(width_position = case_when(is_group_count_even &amp; width_position &gt; 0 ~ width_position - 0.5,<br/>                                    is_group_count_even &amp; width_position &lt; 0 ~ width_position + 0.5,<br/>                                    TRUE ~ width_position))</span></pre><p id="1500" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">让我们现在画出来</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="db9b" class="kr ks it kn b gy kt ku l kv kw">given_levels_and_width_values %&gt;% <br/>  ggplot() +<br/>  aes(width_position, level_group) +<br/>  geom_point() +<br/>  facet_grid(. ~ group,<br/>             scales = "free_x")</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi md"><img src="../Images/4d3bff12e9cc5335ab50dd9103febfd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*it2g5rvjI3dBnY3CXxBQLw.png"/></div></div></figure><p id="e618" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">太棒了。稍微整理一下…</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="b588" class="kr ks it kn b gy kt ku l kv kw">distance &lt;- 5<br/><br/>unique_grouping_levels &lt;- unique(given_levels_and_width_values$group)<br/>  <br/>dummy_data &lt;- tibble(column_to_group = rep(unique_grouping_levels, 2),<br/>                       width_position = c(rep(-distance, length(unique_grouping_levels)), <br/>                                          rep(distance, length(unique_grouping_levels))),<br/>                       level_group = rep(NA_integer_, length(unique_grouping_levels)*2))<br/><br/>  <br/><br/>median_lines &lt;- given_levels_and_width_values %&gt;%<br/>  group_by(group) %&gt;%<br/>  summarise(level_group = median(value_measured, na.rm = T),<br/>            to = max(width_of_group, na.rm = T) + distance/2,<br/>            from = -to) %&gt;%<br/>  gather(key, width_position, -1, -2) %&gt;%<br/>  select(-key)<br/><br/><br/>break_steps &lt;- seq(min(given_levels_and_width_values$level_group, na.rm = T), max(given_levels_and_width_values$level_group, na.rm = T), 25)                                         <br/>  <br/><br/>nearly_finished_plot &lt;- given_levels_and_width_values %&gt;% <br/>    ggplot() + <br/>    aes(x = width_position, y = level_group) +<br/>    geom_point(shape = 1) +<br/>    geom_blank(data = dummy_data) +<br/>    labs(x = NULL,<br/>         y = NULL) +<br/>    scale_y_continuous(breaks = break_steps) +<br/>    facet_grid(. ~ group, <br/>               scales = "free_x",<br/>               <strong class="kn iu">switch</strong> = "both") +<br/>  theme(axis.text.x =  element_blank(),<br/>        axis.ticks.x = element_blank(),<br/>        panel.background = element_blank(),<br/>        axis.line = element_line(colour = "black"),<br/>        strip.background = element_rect(fill = "white"),<br/>        strip.placement = "outside",<br/>        panel.spacing.x = unit(0, "lines")) +<br/>  geom_line(data = median_lines, colour = "red", size = 1)  <br/><br/><br/>nearly_finished_plot</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi md"><img src="../Images/7f4d8ba58ff8b4211747e13ec662819e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PnAzc7HaV7mHzvY8Gwl96w.png"/></div></div></figure><p id="e2c1" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">我们可能还想看到由另一列着色的点…</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="e838" class="kr ks it kn b gy kt ku l kv kw">only_colour_points &lt;- given_levels_and_width_values %&gt;% <br/>  filter(!is.na(gender)) %&gt;% <br/>  arrange(gender) %&gt;% <br/>  mutate(count_of_entries = n(),<br/>         width_of_group = count_of_entries %/% 2,<br/>         width_position = row_number() - width_of_group - 1) %&gt;% <br/>  mutate(width_position = if_else(is_group_count_even &amp; width_position == 0, width_of_group, width_position)) %&gt;% <em class="lx"># this is tricky... Basically, if there's an even number, we want to relocate that x=0 point somehow...by putting it at the end... this is actually going to cause us problems later :-)</em><br/>  mutate(width_position = case_when(is_group_count_even &amp; width_position &gt; 0 ~ width_position - 0.5,<br/>                                    is_group_count_even &amp; width_position &lt; 0 ~ width_position + 0.5,<br/>                                    TRUE ~ width_position))<br/><br/><br/>nearly_finished_plot +<br/>  geom_point(data = only_colour_points, aes(colour = gender)) <em class="lx"># these colour points are actually being overlayed over the original points, and loaded in from the left... this is beneficial because it allows you to see proportions (roughly) of each group (and even NA values, if there are any)</em></span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi md"><img src="../Images/e7538ad75156f8a762bf8b546ef11c7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gmxaZIHci2QSadUeeSlFfw.png"/></div></div></figure><p id="9b8a" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">好吧，这一切都很好。我们已经制定了数据准备步骤和所有的小 ggplot 添加…从这里，让我们把这些步骤变成函数。(1)分配宽度组(箱)(2)分配宽度位置(3)如果适用，通过颜色变量分配宽度位置(4)绘制！</p><p id="ee45" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在，让我们尽可能的动态化…这样 y 轴和 faceting(分组)变量可以在函数调用中指定。</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="5365" class="kr ks it kn b gy kt ku l kv kw">assign_width_groups &lt;- <strong class="kn iu">function</strong>(data, column_to_group, column_to_bin, min_value_to_plot, bin_size) {<br/>  <br/>  column_to_bin &lt;- rlang::enquo(column_to_bin)<br/>  column_to_group &lt;- rlang::enquo(column_to_group)<br/>  <br/>data %&gt;% <br/>  mutate(value_measured = !! column_to_bin,<br/>         column_to_group = !! column_to_group,<br/>         level_group = ((!! column_to_bin) %/% bin_size) * bin_size,<br/>         level_group = pmax(level_group, min_value_to_plot)) %&gt;% <br/>  group_by(column_to_group, level_group) %&gt;% <br/>  mutate(count_of_entries = n(),<br/>         is_group_count_even = count_of_entries %% 2 == 0)<br/>}</span><span id="aeb9" class="kr ks it kn b gy mf ku l kv kw">assign_width_positions &lt;- <strong class="kn iu">function</strong>(data) {<br/><br/>  data %&gt;% <br/>  mutate(count_of_entries = n(),<br/>         width_of_group = count_of_entries %/% 2,<br/>         width_position = row_number() - width_of_group - 1) %&gt;% <br/>  mutate(width_position = if_else(is_group_count_even &amp; width_position == 0, width_of_group, width_position)) %&gt;% <br/>  mutate(width_position = case_when(is_group_count_even &amp; width_position &gt; 0 ~ width_position - 0.5,<br/>                                    is_group_count_even &amp; width_position &lt; 0 ~ width_position + 0.5,<br/>                                    TRUE ~ width_position))<br/>}</span><span id="4166" class="kr ks it kn b gy mf ku l kv kw">plotting_function &lt;- <strong class="kn iu">function</strong>(data, distance = 5, colour_selection = NULL) {<br/>  <br/>  colour_selection &lt;- rlang::enquo(colour_selection)<br/>  <br/>  unique_grouping_levels &lt;- unique(data$column_to_group)<br/>  <br/>  dummy_data &lt;- tibble(column_to_group = rep(unique_grouping_levels, 2),<br/>                       width_position = c(rep(-distance, length(unique_grouping_levels)), <br/>                                          rep(distance, length(unique_grouping_levels))),<br/>                       level_group = rep(NA_integer_, length(unique_grouping_levels)*2))<br/>  <br/>  <br/>  median_lines &lt;- data %&gt;%<br/>    group_by(column_to_group) %&gt;%<br/>    summarise(level_group = median(value_measured, na.rm = T),<br/>              to = max(width_of_group, na.rm = T) + distance/2,<br/>              from = -to) %&gt;%<br/>    gather(key, width_position, -1, -2) %&gt;%<br/>    select(-key)<br/>  <br/>  <br/>  break_steps &lt;- seq(min(data$level_group, na.rm = T), max(data$level_group, na.rm = T), 25)<br/>  <br/>  <br/>  plot &lt;- data %&gt;%<br/>    ggplot() +<br/>    aes(x = width_position, y = level_group) +<br/>    geom_point(shape = 1) +<br/>    geom_blank(data = dummy_data) +<br/>    labs(x = NULL,<br/>         y = NULL) +<br/>    scale_y_continuous(breaks = break_steps) +<br/>    facet_grid(. ~ column_to_group,<br/>               scales = "free_x",<br/>               <strong class="kn iu">switch</strong> = "both") +<br/>    theme(axis.text.x =  element_blank(),<br/>          axis.ticks.x = element_blank(),<br/>          panel.background = element_blank(),<br/>          axis.line = element_line(colour = "black"),<br/>          strip.background = element_rect(fill = "white"),<br/>          strip.placement = "outside",<br/>          panel.spacing.x = unit(0, "lines")) +<br/>    geom_line(data = median_lines, colour = "red", size = 1)<br/>  <br/>  <br/>  <em class="lx"># we also need to add a final step for when a colour component is selected, as well.</em><br/>  <br/>  <strong class="kn iu">if</strong> (!is.null(colour_selection)) {<br/>    <br/>    only_colour_points &lt;- data %&gt;% <em class="lx"># this is the data after both steps of the data-prep...</em><br/>      mutate(colour_column = !! colour_selection) %&gt;% <br/>            filter(!is.na(colour_column)) %&gt;%<br/>      arrange(colour_column) %&gt;%<br/>      assign_width_positions()<br/>    <br/>    <br/>    plot &lt;- plot +<br/>      geom_point(data = only_colour_points, aes(colour = colour_column))<br/>  <br/>    }<br/>  <br/>  <br/>  plot<br/>  <br/>}</span></pre><p id="08f8" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">现在，只需几行代码就可以将它们组合在一起</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="b1b5" class="kr ks it kn b gy kt ku l kv kw">data_collected %&gt;% <br/>  assign_width_groups(gender, value1, 0, 5) %&gt;% <br/>  assign_width_positions() %&gt;% <br/>  plotting_function(colour_selection = group)</span></pre><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi md"><img src="../Images/ec6bca740eea5b33420cee98581d1b8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZSPpuy12tXJ3Z_TlKtFQ9w.png"/></div></div></figure><p id="bcff" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">中线也很棘手。首先，它落在彩色点的后面(这很容易修复)，其次，它是从实际值而不是入库值计算出来的(这就是为什么它不完全在某个显示点上或之间)。</p><p id="d547" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">还有一个小问题，但我认为它不会被注意到，直到我能费心去解决它(这不是对数刻度…我认为没有它看起来更好)。</p><p id="10c5" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated">不管怎样，所有这些功能都准备好了，我们现在可以把它们放入一个漂亮的小 flexdashboard 中…</p><p id="6ebc" class="pw-post-body-paragraph lb lc it ld b le lf ju lg lh li jx lj lk ll lm ln lo lp lq lr ls lt lu lv lw im bi translated"><a class="ae mg" href="https://juliantagell.shinyapps.io/sina_plot_flexdashboard/" rel="noopener ugc nofollow" target="_blank">看看吧</a></p><figure class="ki kj kk kl gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mh"><img src="../Images/fcfd64c4415a3903f96bc1ae71e97f6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOhqBjDPP0gLA63OptMKzA.png"/></div></div></figure><h1 id="647c" class="mi ks it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">结论</h1><p id="975b" class="pw-post-body-paragraph lb lc it ld b le mz ju lg lh na jx lj lk nb lm ln lo nc lq lr ls nd lu lv lw im bi translated">天啊，这花了很长时间才解决。与 Tableau 相比，在 ggplot / R 中定制的(和可定制的)图表会花费很长时间…但是现在我知道怎么做了..小心世界:-)实现下一次将是一个 sinch。</p></div></div>    
</body>
</html>