<html>
<head>
<title>Graphing data from MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从 MongoDB 绘制数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/graphing-data-from-mongodb-99c3722650da?source=collection_archive---------12-----------------------#2019-09-09">https://towardsdatascience.com/graphing-data-from-mongodb-99c3722650da?source=collection_archive---------12-----------------------#2019-09-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/1723b3ec019f508bd928db3399e86654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ySUS6PGMRaEkcQcU4jZd0w.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="1d14" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">本指南将带您了解如何从 Jupyter 笔记本连接到您自己的 MongoDB 实例，获取您的数据并绘制它，所有这些都是用 python 完成的。</h2></div><h1 id="b2e8" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">介绍</h1><p id="7cc6" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">灵活的 NoSQL 数据库可以处理大量的非结构化数据，并且可以灵活地增加或减少存储容量而不造成损失，它将逐渐取代关系数据库。</p><p id="d536" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">MongoDB 是 NoSQL 数据库中的佼佼者之一，能够满足在多个开发阶段快速灵活地访问数据的业务需求，尤其是在实时数据占主导地位的情况下。</p><p id="589d" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">注意，我不打算介绍 MongoDB 的安装和数据库的设置，因为已经有大量的文档介绍了这方面的内容。</p><h2 id="a2df" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">设置全局变量</h2><p id="1770" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">如上所述，假设您已经在 Atlas 上运行了一个 MongoDB 数据库。在 MongoDB 上的<em class="mv">集群</em>下，点击相关数据库上的<em class="mv">连接</em>。有 3 种不同的方法连接到数据库。如果您还没有，那么您需要将您自己的 IP 地址加入白名单，并为这个特定项目创建一个 MongoDB 用户。</p><p id="f7d0" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">选择第二个选项— <em class="mv">连接您的应用程序</em>。选择 Python 作为你的驱动，选择<em class="mv"> 3.6 或更高版本</em>作为你的版本。将连接字符串复制到剪贴板。</p><p id="e306" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">在首选编辑器中打开 bash 概要文件，并输入以下内容:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="373c" class="mj kr jb nb b gy nf ng l nh ni">export 'MONGO_URI' = "YOUR_CONNECTION_STRING"</span></pre><p id="72b0" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">用刚才复制的连接字符串替换“YOUR_CONNECTION_STRING”。在连接字符串中，您还必须替换为当前用户的登录密码。</p><p id="ad45" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">从命令行运行:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="2c24" class="mj kr jb nb b gy nf ng l nh ni">source ~/.bash_profile</span></pre><h2 id="c6ab" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">安装 Anaconda</h2><p id="7003" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">现在，为了使本指南可移植并可在任何机器上运行，我首先需要创建一个虚拟环境。查看我们之前关于安装 Anaconda 发行版的指南:</p><p id="ced0" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><a class="ae nj" href="https://docs.kyso.io/guides/jupyter-with-anaconda" rel="noopener ugc nofollow" target="_blank">用 Anaconda 安装 Jupyter】</a></p><p id="0108" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><a class="ae nj" href="https://docs.kyso.io/guides/jupyter-with-anaconda" rel="noopener ugc nofollow" target="_blank">/guides/巨蟒/巨蟒</a></p><h2 id="c097" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">创建虚拟环境</h2><p id="6720" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">我们将运行以下命令来创建 python3.7 环境。创建我们的虚拟环境:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="b312" class="mj kr jb nb b gy nf ng l nh ni">conda create -n mongodb-playground python=3.7 -y</span></pre><p id="0495" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">并启动它:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="cca5" class="mj kr jb nb b gy nf ng l nh ni">conda activate mongodb-playground</span></pre><p id="a521" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">我们还需要以下库来连接到 Mongo 4.0:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="ac93" class="mj kr jb nb b gy nf ng l nh ni">conda install pymongo==3.8 dnspython ipykernel -y</span></pre><p id="6617" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">下一个命令确保我们的 Jupyterlab 实例连接到这个虚拟环境:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="5aea" class="mj kr jb nb b gy nf ng l nh ni">python -m ipykernel install --user</span></pre><h2 id="2556" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">附加安装</h2><p id="54c2" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">稍后，一旦我们获取了数据，我们将需要绘制图表。鉴于其相对简单的语法和交互性，我们通常建议在 python 中使用 plotly。</p><p id="56ba" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">为了在 jupyterlab 中使用，我们需要安装 JupyterLab 和 ipywidgets 包:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="cf2c" class="mj kr jb nb b gy nf ng l nh ni">conda install -c conda-forge jupyterlab-plotly-extension -y</span></pre><p id="2174" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">Plotly 有一个名为<em class="mv">袖扣</em>的熊猫包装器(数据处理库)，目前它与 plotly 的最新版本存在兼容性问题。目前解决这个问题的方法是降级 plotly 并使用以下命令安装袖扣。一旦你看到用袖扣生成图形是多么容易，你就会明白为什么我们要经历这种麻烦。袖扣团队已经为修复工作努力了一段时间，但还没有结果。</p><p id="74b8" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">从 2019 年 9 月起，这将帮助您启动并运行:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="45cb" class="mj kr jb nb b gy nf ng l nh ni">conda install -c conda-forge plotly=2.7.0 -y<br/>conda install -c conda-forge cufflinks-py -y</span></pre><p id="c847" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">现在我们可以用以下方法旋转 Jupyterlab:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="248b" class="mj kr jb nb b gy nf ng l nh ni">jupyter lab</span></pre><p id="1ea8" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">在启动时，您可能会得到一个推荐构建的提示——我们上面运行的 jupyterlab-plotly-extension 安装。点击<em class="mv">构建</em>，等待完成。</p><h1 id="b678" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">在朱庇特</h1><h2 id="602a" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">正在连接到 MongoDB</h2><p id="6bbc" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">让我们首先导入我们需要的库:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="84f6" class="mj kr jb nb b gy nf ng l nh ni">import os # to create an interface with our operating system</span><span id="b964" class="mj kr jb nb b gy nk ng l nh ni">import sys # information on how our code is interacting with the host system</span><span id="09d0" class="mj kr jb nb b gy nk ng l nh ni">import pymongo # for working with the MongoDB API</span></pre><p id="a4ab" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">然后，我们连接到我们的 MongoDB 客户端:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="5b52" class="mj kr jb nb b gy nf ng l nh ni">client = pymongo.MongoClient(os.environ['MONGO_URI'])</span></pre><p id="4f2f" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">注意，我们可以调用<code class="fe nl nm nn nb b">'MONGO_URI'</code>，因为我们已经在<code class="fe nl nm nn nb b">~/.bash_profile</code>中将连接字符串设置为环境变量。</p><h2 id="70fb" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">访问我们的数据</h2><p id="318b" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">现在让我们访问一个数据库，在本例中是<em class="mv"> sample supplies。</em></p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="3a87" class="mj kr jb nb b gy nf ng l nh ni">db = client.sample_supplies</span></pre><p id="6c40" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">一个<a class="ae nj" href="http://www.mongodb.org/display/DOCS/Collections" rel="noopener ugc nofollow" target="_blank">集合</a>是存储在 MongoDB 数据库中的一组文档，大致相当于关系数据库中的一个表。获取一个集合的工作方式与我们上面访问数据库的方式相同。在这种情况下，我们的集合称为<em class="mv">销售</em>。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="777e" class="mj kr jb nb b gy nf ng l nh ni">collection = db.sales</span></pre><p id="aade" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">让我们通过获取单个文档来测试我们是否成功。下面的方法返回与我们的查询匹配的单个文档。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="c5e8" class="mj kr jb nb b gy nf ng l nh ni">test = collection.find_one()</span></pre><h2 id="ed9c" class="mj kr jb bd ks mk ml dn kw mm mn dp la lr mo mp lc lv mq mr le lz ms mt lg mu bi translated">将我们的数据载入熊猫</h2><p id="ed54" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><a class="ae nj" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Pandas </a>提供了快速、灵活、富于表现力的数据结构，旨在使处理“关系”或“标签”数据变得既简单又直观，可以说是最强大、最灵活的开源数据分析/操作工具。</p><p id="d458" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">我们可以用一个简单的命令将我们收集的全部数据转换成熊猫数据帧:</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="6ca3" class="mj kr jb nb b gy nf ng l nh ni">data = pd.DataFrame(list(db.sales.find()))</span></pre><p id="63cc" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">DataFrame 中的一些列仍然被格式化为字典或 PyMongo 方法。出于本指南的目的，让我们看一下<em class="mv">客户</em>列——这是一个字典，包含针对每个客户的年龄和性别的 2 个键值对。</p><p id="cad2" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">我们需要拆分该列，使<em class="mv">年龄</em>和<em class="mv">性别</em>成为它们自己的列。为此，我们可以使用<code class="fe nl nm nn nb b">.apply(pd.Series)</code>方法将字典转换成它自己的数据帧，并将其连接到我们现有的数据帧，所有这些都在一行中完成。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="e808" class="mj kr jb nb b gy nf ng l nh ni">df = pd.concat([data.drop(['customer'], axis=1), data['customer'].apply(pd.Series)], axis=1)</span></pre><p id="0f6e" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">例如，我们可以对<em class="mv">项目</em>列做类似的事情，但是这超出了本指南的范围。</p><h1 id="801a" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">绘制我们的数据</h1><p id="8ea9" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">好了，让我们开始绘制数据来回答一些基本问题。首先，我们将导入我们的绘图库。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="535d" class="mj kr jb nb b gy nf ng l nh ni">import plotly.plotly as py<br/>import plotly.graph_objs as go<br/>import plotly<br/>from plotly.offline import download_plotlyjs, init_notebook_mode, plot, iplot<br/>import cufflinks as cf<br/>cf.set_config_file(offline=True)</span></pre><p id="8465" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">下面是链接到<a class="ae nj" href="https://plot.ly/python/" rel="noopener ugc nofollow" target="_blank"><em class="mv"/></a><em class="mv"/>和<a class="ae nj" href="https://plot.ly/ipython-notebooks/cufflinks/" rel="noopener ugc nofollow" target="_blank"> <em class="mv">袖扣</em> </a> <em class="mv"> </em>的文档。</p><p id="3808" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated"><strong class="lk jc">定义您的业务问题</strong></p><p id="dd6d" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">你想回答什么商业问题？我们为样本数据列出了一些示例问题:</p><ol class=""><li id="1f88" class="no np jb lk b ll me lo mf lr nq lv nr lz ns md nt nu nv nw bi translated">商店的平均顾客满意度是多少——这是否会受到购买方式的影响，是通过电话、店内还是网上购买？</li></ol><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="cb06" class="mj kr jb nb b gy nf ng l nh ni">df.groupby(['storeLocation', 'purchaseMethod'], as_index=True)['satisfaction'].mean().unstack().iplot(kind='bar', mode='group', title='Average Customer Satisfaction by Store')</span></pre><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nx"><img src="../Images/29629d15cd2ddb6fc460a70ac78c88bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CRYZ9Yqqw-ky_fTv"/></div></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">Average satisfaction ratings across all our stores.</figcaption></figure><p id="8c2e" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">2.按性别分类，收到的采购订单数量如何——有什么重大差异吗？</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="9e4e" class="mj kr jb nb b gy nf ng l nh ni">df.groupby(['gender', 'purchaseMethod'], as_index=True)['_id'].count().unstack().iplot(kind='bar', mode='group', title='Purchase Orders by Gender')</span></pre><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oc"><img src="../Images/36da24c18db41ed8c89b51c708f234b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JAK5_-o0cF7B1dQT"/></div></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">Men make more purchases over the phone, women in-store.</figcaption></figure><p id="d422" class="pw-post-body-paragraph li lj jb lk b ll me kc ln lo mf kf lq lr mg lt lu lv mh lx ly lz mi mb mc md ij bi translated">3.我们所有顾客的年龄分布是怎样的？</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="e243" class="mj kr jb nb b gy nf ng l nh ni">df['age'].iplot(kind='hist', color='rgb(12, 128, 128)', opacity=0.75, bargap = 0.20,title="Age Distribution of our Customers", xTitle='Age', yTitle='Count')</span></pre><figure class="mw mx my mz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/3cc89b9ed1de09397819b89db8593d8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kWAqv5m6EBR-gO5c"/></div></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">The largest group falls within the 35–42 age range.</figcaption></figure><h1 id="718c" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">过帐到 Kyso</h1><p id="d46c" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">好了，我们已经回答了一些关于业务指标的基本问题。是时候将我们的分析发布到我们团队的 Kyso 工作区了，这样每个人都可以从我们的见解中学习并将其应用到各自的角色中。</p><ul class=""><li id="c15d" class="no np jb lk b ll me lo mf lr nq lv nr lz ns md oe nu nv nw bi translated">我们可以从本地机器推送到我们组织的 Github 存储库，并与 Kyso 同步:<a class="ae nj" href="https://docs.kyso.io/posting-to-kyso/connect-a-github-repo-to-kyso" rel="noopener ugc nofollow" target="_blank">将 Github repo 连接到 Kyso </a></li><li id="bf07" class="no np jb lk b ll of lo og lr oh lv oi lz oj md oe nu nv nw bi translated">由于我们已经在 Jupyterlab 中，我们可以安装 Kyso 的发布扩展，并从这里直接将我们的笔记本发布到 Kyso:<a class="ae nj" href="https://docs.kyso.io/posting-to-kyso/kysos-jupyterlab-extension" rel="noopener ugc nofollow" target="_blank">使用 Kyso 的 Jupyterlab 扩展</a></li><li id="5e9a" class="no np jb lk b ll of lo og lr oh lv oi lz oj md oe nu nv nw bi translated">如果这是一次性分析，而不是定期运行，我们也可以在<a class="ae nj" href="https://kyso.io/" rel="noopener ugc nofollow" target="_blank"> Kyso </a>应用程序中手动上传笔记本。</li></ul></div></div>    
</body>
</html>