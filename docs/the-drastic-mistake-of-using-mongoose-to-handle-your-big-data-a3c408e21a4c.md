# 使用 Mongoose 处理大数据的严重错误

> 原文：<https://towardsdatascience.com/the-drastic-mistake-of-using-mongoose-to-handle-your-big-data-a3c408e21a4c?source=collection_archive---------10----------------------->

![](img/477afa36f66299e0cbe9b0a6e16d85e9.png)

# 介绍

在 NPM 宇宙中，mongose 是一个非常受欢迎且做得非常好的库。基于其模型-模式结构，它被许多优秀的程序员广泛使用。事实上，在 Google 中粗略地查看许多使用包含 MongoDB 的数据模型创建任何类型的堆栈的示例，您会发现作者在他们的开发结构中大多包含 Mongoose。这是一个受人尊敬、保存良好、非常受欢迎的图书馆。以上所述都是事实，作者的高超技巧和对社区需求的理解值得称赞。

以上不是免责声明，也不是愤世嫉俗的说法。事实上，我已经推迟了这篇文章的发布很长时间，因为我认为它可能不会被 MongoDB 社区很好地接受。**然而，Mongoose 的本质，它迫使人们对数据做什么，以及它如何迫使程序员思考，才是本文的重点。** *我充分意识到，在这里写的东西可能会在当前的 NodeJS — NPM 社区中非常不受欢迎*。然而，根据我自己职业生涯中最近发生的事件，是时候解释为什么在几乎所有真正的大数据场景中都应该避免使用 Mongoose 了。让我把这个说法说得更严厉些。这也是我真正鄙视在 NodeJS 中使用 Typescript 的原因。这也迫使变量在进入系统之前被输入。

# NoSQL 数据库背后的想法

对 NoSQL 应该做什么的任何简单理解是，它是以这样一种方式构造的，即获取少量或大量数据并将它们存储在集合或数据存储中。无论您希望如何称呼您的数据库，事实仍然是数据本身在存储时就是“数据”。现在还没有，将来也不应该在数据存储中局限于这样的想法，即数据的每个方面都必须符合预定义的结构。当然，对许多人来说，当存储诸如名称之类的东西时，确保名称是一个“字符串”似乎是完全有意义的。或者，当我存储一个数量时，确保该数量存储为“数字”是完全有意义的。

然而，大数据系统不仅仅是存储姓名、地址和选择。它们是关于获取一个人可能获得的关于手边物品的每一条信息，并且能够以你希望的任何方式储存这些信息以备后用。的确，在这里需要注意的是，获取数据的整个理念已经发生了变化。没有任何模式或一致性过滤的数据本身不再是目标。我们的目标是获取数据并应用于您正在使用的任何引擎或代码库，以这样一种方式对其进行过滤，使其可行，并可能成为您公司感知财富中最重要的武器库之一。

NoSQL 从传统的 SQL 数据库发展而来，以避免对触发器、传统关系甚至主键的需求。它之所以发展，是因为数据变得如此庞大，而且在传统格式中没有定义，以至于人们需要一种不同的方法来将数据视为一个整体，并将各种数据连接起来。

简而言之，NoSQL 是非线性思维的一种形式，注入和取出数据。**NoSQL 的要点是，在信息进入数据库之前，你不应该“键入”信息。**当你拿出它来获取信息时，你就可以输入信息了。这是通过智能聚合、算法、理论构造来实现的，所有这些都基于你所寻找的模式和信息。

# 线性思维

为了保护 Mongoose 用户，他们通常在 SQL 世界中接受训练，在 SQL 世界中，每一项都有一个特定的结构，一个系统是相关的(关系数据库)，基于主键、关系和触发器。这是典型的线性思维。它对诸如姓名地址之类的小事情非常有用。数据库、博客帖子、书评等。我相信这里可以举出数百万个例子。我自己，使用 MySQL 和 PHP 已经很多很多年了。它过去是，现在仍然是一个优秀的系统。事实上，您将在任何搜索中找到的大多数示例，甚至是 NodeJS & MongoDB 的完整系统都会利用这样的场景，包括 Mongoose。

然而，它迫使人们以线性方式思考。它强制线性规划。它从步骤 1 到步骤 2 到步骤 3 等等。当然，在 MySQL 系统中有 blob 或巨大的文本字段，但是这些需要大量的编码和准备工作，以便提取准确的所需信息。如今，传统的 MySQL 系统不是为大量实时数据需求而构建的。

MySQL 的本质就是反对使用大量“非类型化”数据。

毫无疑问，今天它提供了允许非结构化数据的能力，但是表、触发器和关系的本质是建立在结构之上的。

更有甚者，MySQL 结构会变得异常复杂。表 A 转到表 B，然后触发表 C 中的关系，然后从表 D 中获取信息，然后表 D 必须对表 E 进行排序以检索信息。这个链条实际上可以有 20-30 张桌子。它不仅混乱，而且对于不经常在结构顶部的任何人(DBA)来说，保持它的正确性几乎是不可能的。

然而，即使在这种情况下，主要原因是它们根本不是为这些天来出现的非结构化数据而构建的。

# 猫鼬结构

因此，这是有道理的，人们会被 Mongoose 所吸引，以便对正在收集的数据应用某种结构。更重要的是，因为 Mongoose 作为一个中间件与 Express、Passport 等配合得非常好。并且它以正常的方式提供了到 MongoDB 所需的连接，在没有清楚地考虑整个系统应该做什么的情况下，人们自然不应该忽略它。在模式模型系统中，人们可以传递几乎任何类型的函数来实现真正的 CRUD。它还允许回调、承诺和 ES6。以上都很棒。

然而，有一个警告。按照 Mongoose 的工作方式，您必须以典型的 JSON 格式定义(键入)信息的性质。在实际情况下，尤其是对于大量数据，任何有经验的数据分析师都会告诉你，这样的模型不仅对数据本身非常不利，而且几乎不可能实现。

# 在数据进入数据库之前输入数据

在数据最终进入您的集合之前对其应用类型的本质，意味着您确切地知道什么类型的数据正在进入，什么类型的数据正在进入。无论是任何类型的字符串、数字或任何状态。同样，这也适用于小型系统的简单解决方案，在这些解决方案中，您专注于您 100%确定将获得的特定数据。但是在实时实例中或者在接收 JSON 包中的数据时，有时信息不在那里或者突然出现一个额外的键值，会发生什么呢？或者，当您在处理医疗或保险信息时，必须从不同类型的数据中提取大量不同的数据，会发生什么情况呢？

当然，您可以争辩说，您可以返回并更改该集合的模式模型以包含这些更改。这使得一切都很好地包装在模型中，当然也很容易阅读。然而，它并不反映真实世界的场景，一个真正的大数据系统的模式模型将会非常复杂，同样，不仅需要 MongoDB 及其所有可能性的知识，而且可能还需要一个 DBA 来处理 Mongoose 设置。

# 再次出于错误的目的扩展中间件

任何 NodeJS 程序员都会告诉你，如果被问到中间件，Express 通常会在栈顶。路由，JWT，护照，头盔和许多其他人将继续堆栈。无论你设计得多好，都很容易迷失在这样的堆栈中。我见过 package.json 文件，其中使用的 NPM 模块数量之多令人震惊。也许所有这些都是需要的，老实说，我是一个真正的 NPM 信徒。但是，栈就是栈。中间件没有被正确引入，或者引入的顺序不对，会严重降低系统的运行速度，或者使系统无法运行。除了在数据上强制输入类型之外，您正在处理的系统可能反应更快，延迟更少，最重要的是对非格式化数据的拒绝更少。

# 结论

我想重申，猫鼬的创造者们做了一件令人难以置信的工作。他们还允许 SQL 程序员加入 NoSQL 的世界，而不需要对他们思考数据的方法进行重大改变。此外，对于小型系统，Mongoose 可能是个不错的选择。

然而，如果您真正在处理复杂的大数据场景，或者来自各地的实时数据包，其中值、类型和信息可能会随着数据包的不同而变化，那么 Mongoose 应该被排除在您的等式之外。您必须掌握 MongoDB 的所有细微差别，包括 MapReduce、aggregation 等。CRUD 不再仅仅是 CRUD。在大数据系统中，它远远超出了典型的 SQL CRUD 类型的操作。这需要对大数据的真正本质有更多的了解，而不仅仅是旧的名称-地址-电话；登录并接受某种类型的书面数据。当您超出这个范围进行开发时，我的建议是将 Mongoose 放在一边，使用 MongoDB 原生构造创建一个函数库。避免使用 Mongoose 的中间件，不管你对它有多了解。最终，这样的系统 Mongoose 会拒绝没有输入的信息，你会丢失它。这在大数据场景中可能是灾难性的。

选择权在你，显然这是一篇观点文章。如果您正在开发真正的大数据系统，我简单的拙见是，不要考虑 Mongoose。**不要“键入”(阅读:预定义)你的信息。不要对进入你系统的东西设限。获取您可能获得的所有数据，然后通过正确的算法和对原生 MongoDB 命令的操作，您将能够实现不仅收集数据而且通过任何可能的方式找到模式和连接的目标。这允许灵活性和非线性思维过程。这就是 NoSQL 被创造出来的原因。**

_________________________________________________________________

关于作者:Ted Gross 担任 CTO 多年，擅长数据库技术、NodeJS、MongoDB、加密、PHP 和 OOP。他擅长虚拟世界技术和增强现实。他还发表了许多关于技术主题的文章，特别是关于大数据和混沌理论的文章(在专业期刊和在线@ Medium & LinkedIn 上)。他也是文学小说、儿童书籍和各种非小说文章的作者 。他的短篇小说集 [*【古代故事、现代传说】*](http://www.amazon.com/Ancient-Tales-Modern-Legends-Collection/dp/1469901714) 获得了极好的评价。

可以通过电子邮件联系到泰德:tedwgross@gmail.com；[推特](https://twitter.com/tedwgross)(@ tedw gross)；[LinkedIn](http://il.linkedin.com/in/tedwgross)；[中等](https://medium.com/@tedwgross)