<html>
<head>
<title>More Data, More Sheets API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更多数据，更多工作表 API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/more-data-more-sheets-api-b1e3ddfa0d1?source=collection_archive---------38-----------------------#2019-08-12">https://towardsdatascience.com/more-data-more-sheets-api-b1e3ddfa0d1?source=collection_archive---------38-----------------------#2019-08-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/7032fd2aaba7a9392e69364cd6f8938d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_xxSzPNdY_uF8OiulV8Agg.png"/></div></div></figure><div class=""/><div class=""><h2 id="3367" class="pw-subtitle-paragraph kb jd je bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks dk translated">Google Sheets API 如何使用魔法(和代码)用可视数据填充您的表单。</h2></div><p id="6077" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">作为马友友的超级粉丝，我一直在用谷歌视觉应用编程接口(API)处理大提琴的图像。获得 API 的<a class="ae lp" href="https://cloud.google.com/vision/docs/detecting-labels" rel="noopener ugc nofollow" target="_blank">标签检测</a>结果后，当屏幕上输出“弦乐器”这样的字眼时，我欣喜若狂。计算机能像我一样识别和欣赏大提琴的图像，这多棒啊。</p><p id="bfa6" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">然而，通过 Vision API 发送图像的<em class="lq">点</em>到底是什么？我已经可以看到里面有什么了，那么为什么我还需要一台电脑来重申我已经知道的东西呢？</p><p id="7ee2" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">就像大多数生活中的问题一样，答案是 Google Sheets。</p><p id="eee4" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">电子表格是组织和可视化数据的好工具。)机器学习是获取这类数据的绝佳方式。当机器学习返回的数据被收集、组织并通过表格可视化呈现时，机器学习(特别是 Vision API)变得非常有用。</p><h2 id="f8a6" class="lr ls je bd lt lu lv dn lw lx ly dp lz lc ma mb mc lg md me mf lk mg mh mi mj bi translated">"但是使用床单既费时又令人困惑！"</h2><p id="5cf9" class="pw-post-body-paragraph kt ku je kv b kw mk kf ky kz ml ki lb lc mm le lf lg mn li lj lk mo lm ln lo im bi translated">你是对的，它肯定是可以的，这就是为什么我一直在使用<a class="ae lp" href="https://developers.google.com/sheets/api/" rel="noopener ugc nofollow" target="_blank"> Google Sheets API </a>和<a class="ae lp" href="https://cloud.google.com/functions/?utm_source=google&amp;utm_medium=cpc&amp;utm_campaign=na-CA-all-en-dr-bkws-all-all-trial-p-dr-1007179&amp;utm_content=text-ad-none-any-DEV_c-CRE_339544383307-ADGP_Hybrid%20%7C%20AW%20SEM%20%7C%20BKWS%20%7C%20RLSA%20%7C%20CA%20%7C%20en%20%7C%20PHR%20~%20Compute%20~%20Functions%20~%20google%20cloud%20functions-KWID_43700042239777659-aud-664745643345:kwd-298528048746&amp;utm_term=KW_google%20cloud%20functions-ST_google%20cloud%20functions&amp;gclid=CPyEv4bYy-MCFQ6mswodgCkAqA" rel="noopener ugc nofollow" target="_blank">云函数</a>来为我做所有的脏活累活。</p><h1 id="df5c" class="mp ls je bd lt mq mr ms lw mt mu mv lz kk mw kl mc kn mx ko mf kq my kr mi mz bi translated">获取数据。</h1><p id="e11f" class="pw-post-body-paragraph kt ku je kv b kw mk kf ky kz ml ki lb lc mm le lf lg mn li lj lk mo lm ln lo im bi translated">调用 Google Vision API 就像几行代码一样简单。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="a69f" class="lr ls je nf b gy nj nk l nl nm">const client = new vision.ImageAnnotatorClient();<br/>const [result] = await client.labelDetection({image: <br/>    {content: fileBytes}<br/>  });</span></pre><p id="5ca2" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">具体来说，我正在对一个图像执行标签检测，<a class="ae lp" href="https://cloud.google.com/vision/docs/detecting-labels" rel="noopener ugc nofollow" target="_blank">由 Vision API 定义为一种“检测和提取图像中实体的信息，跨越一个广泛的类别组”的方式因为我的大提琴图像是本地的，所以我通过 API 将它的图像字节作为一个</a><a class="ae lp" href="https://cloud.google.com/vision/docs/base64" rel="noopener ugc nofollow" target="_blank"> base64 编码的</a>字符串发送。</p><p id="2562" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">你可以仔细看看标签检测返回的<a class="ae lp" href="https://cloud.google.com/vision/docs/reference/rest/v1/AnnotateImageResponse" rel="noopener ugc nofollow" target="_blank">响应</a>，但是在这里，我只对标签的描述和它的分数感兴趣。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="4683" class="lr ls je nf b gy nj nk l nl nm">var labelsResult = result.labelAnnotations;<br/>var labels = labelsResult.map(label =&gt; label.description);<br/>var labelScores = labelsResult.map(label =&gt; label.score);</span></pre><p id="38f1" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">在这两个变量<strong class="kv jf">标签</strong>和<strong class="kv jf">标签分数</strong>中，我保存了 Vision API 返回的每个标签及其对应的分数。然而，光有这些惊人的数据是不够的。事实上，如果你不知道如何处理数据，或者不知道如何理解数据，那么数据实际上毫无用处。</p><p id="6861" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">如果你不确定如何继续，这里有一个可行的选择:把它全部发送到工作表。</p><h2 id="8858" class="lr ls je bd lt lu lv dn lw lx ly dp lz lc ma mb mc lg md me mf lk mg mh mi mj bi translated">准备我们的数据。</h2><p id="53c3" class="pw-post-body-paragraph kt ku je kv b kw mk kf ky kz ml ki lb lc mm le lf lg mn li lj lk mo lm ln lo im bi translated">标签检测规范解释了我们的<strong class="kv jf">标签</strong>和<strong class="kv jf">标签核心</strong>变量将只是<a class="ae lp" href="https://cloud.google.com/vision/docs/detecting-labels#label_detection_response" rel="noopener ugc nofollow" target="_blank"> JSON 映射</a>。如果在我的工作表中，我希望每一行都包含一个标签及其相应的分数，该怎么办？这里最好的选择是将这个 JSON 映射分割成一个 2D 数组，它反映了我们希望数据在工作表中的显示方式。</p><p id="f3e5" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">首先，我们使用 JSON.stringify 将我们的 JSON 数据转换成一个大字符串。接下来，我们删除任何不需要的字符，最后，我们通过在每次到达逗号时指示一个新的索引，将这个大字符串转换成一个数组。(这是因为<a class="ae lp" href="https://cloud.google.com/vision/docs/detecting-labels#label_detection_response" rel="noopener ugc nofollow" target="_blank">我们返回的 JSON 映射</a>中的标签都用逗号隔开)。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="d216" class="lr ls je nf b gy nj nk l nl nm">var labelData = JSON.stringify(labels, null, 2);<br/>labelData = labelData.replace(/[\[\]'\"]+/g,'');<br/>labelData = labelData.split(',');</span></pre><p id="dd5e" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">我可以对我的<strong class="kv jf"> labelScores </strong> JSON 响应执行这些完全相同的代码行，以获得包含所有分数的另一个数组。我选择将这个数组命名为<strong class="kv jf"> scoreData </strong>。</p><h2 id="e302" class="lr ls je bd lt lu lv dn lw lx ly dp lz lc ma mb mc lg md me mf lk mg mh mi mj bi translated">写在纸上。</h2><p id="5919" class="pw-post-body-paragraph kt ku je kv b kw mk kf ky kz ml ki lb lc mm le lf lg mn li lj lk mo lm ln lo im bi translated">为了将我的两个数组发送到一个表中，我需要确保它们遵守表 API 的调用参数。如前所述，我希望发送到工作表的值数组需要反映我希望在工作表中格式化数据的方式。</p><p id="0d90" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">我知道我的两个数组有相同的长度，因为每个标签都有相应的分数，反之亦然。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="0fb5" class="lr ls je nf b gy nj nk l nl nm">var dataLength = labelData.length;</span></pre><p id="1cf5" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">我还知道，对于每一行，我希望在列 A 中有一个标签，在列 b 中有相应的分数。因此，这正是我的<strong class="kv jf">值</strong>数组需要的样子。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="6dc6" class="lr ls je nf b gy nj nk l nl nm">var values = []<br/>  for (var i = 0; i &lt; dataLength; i++) {<br/>    var dataToPush = [labelData[i], scoreData[i]];<br/>    values.push(dataToPush);<br/>  }</span></pre><p id="c23b" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">为了将这些<strong class="kv jf">值</strong>推送到我的工作表中，我需要调用的方法是…</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="9982" class="lr ls je nf b gy nj nk l nl nm">sheet.spreadsheets.values.update(request, {</span></pre><p id="9869" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">…其中我的<strong class="kv jf">请求</strong>变量如下:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="ef4d" class="lr ls je nf b gy nj nk l nl nm">var body = {<br/> values: values<br/>}</span><span id="caea" class="lr ls je nf b gy nn nk l nl nm">var request = {<br/>    spreadsheetId: 'YOUR_SHEET_ID',<br/>    valueInputOption: 'USER_ENTERED',<br/>    range: 'A1:B',<br/>    resource: body,<br/>    auth: // YOUR OAUTH CLIENT<br/>};</span></pre><p id="5b43" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">无论何时进行 Sheets API 调用，指定<code class="fe no np nq nf b">spreadsheetId</code>都是至关重要的，这是为了确保您所更改的正是您想要的工作表。以下是你如何找到自己的。</p><p id="35e6" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">撇开凭证和数据不谈，也许这个请求变量中最重要的值是<strong class="kv jf"> valueInputOption </strong>，在这里您可以指定<em class="lq">如何将值输入到工作表中。<code class="fe no np nq nf b">'USER_ENTERED’</code>是您的最佳选择，确保数据会出现在您的工作表<em class="lq">中，就像您自己花时间输入数据一样</em>。</em></p><p id="32cb" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">此外，<strong class="kv jf">范围</strong>值(在<a class="ae lp" href="https://developers.google.com/sheets/api/guides/concepts#a1_notation" rel="noopener ugc nofollow" target="_blank"> A1 符号</a>中给出)对于确保您的数据按照指定格式编排到您的工作表中至关重要。A1 符号“A1:B”表示<em class="lq">从单元格 A1 </em>开始写入，<em class="lq">移动到 B 列</em>，然后<em class="lq">继续向下移动行并从 A 列切换到 B 列，直到所有数据都被写入</em>。因此，即使你已经将你的<strong class="kv jf">值</strong>数组设置为你希望数据显示的方式<em class="lq"/>，你也需要正确地将<strong class="kv jf">范围</strong>变量设置为<em class="lq">你希望它显示的位置</em>。</p><figure class="na nb nc nd gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nr"><img src="../Images/7a99be04c1f3569c20b9755b6b336783.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2nvZSo-8QTNYYgRseuRxAg.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk">Fragment of what your inputted labels and label scores should look like in your Sheet. I hope you like cellos!</figcaption></figure><h2 id="6b98" class="lr ls je bd lt lu lv dn lw lx ly dp lz lc ma mb mc lg md me mf lk mg mh mi mj bi translated">生成可视数据。</h2><p id="d796" class="pw-post-body-paragraph kt ku je kv b kw mk kf ky kz ml ki lb lc mm le lf lg mn li lj lk mo lm ln lo im bi translated">如果您现在查看一下您的电子表格，您将看到从 Vision API 的标签检测中获得的所有数据。还是那句话——如果你不知道如何理解数据，那数据是什么？</p><p id="0c19" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">你的下一步是记住每个人都喜欢图表！我们用 GCF 做一个吧。</p><p id="f07e" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">从现有数据创建柱形图的 Sheets API 调用是一个<a class="ae lp" href="https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values/batchUpdate" rel="noopener ugc nofollow" target="_blank"> batchUpdate </a>请求，它非常类似于我们之前进行的 values.update 调用。这里的关键区别是我们发送给 batchUpdate 的<a class="ae lp" href="https://developers.google.com/sheets/api/samples/charts#add_a_column_chart" rel="noopener ugc nofollow" target="_blank">请求</a>参数:一个冗长的 JSON 主体，其中指定了域、系列、轴标题和位置。</p><p id="b8d0" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">让我们来看看 JSON 主体的一些细节，我们将把它存储在一个名为<strong class="kv jf"> chartRequest </strong>的变量中:</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="e923" class="lr ls je nf b gy nj nk l nl nm">    chartType: "COLUMN",<br/>              legendPosition: "BOTTOM_LEGEND",<br/>              axis: [<br/>                {<br/>                  position: "BOTTOM_AXIS",<br/>                  title: "Vision Labels"<br/>                },<br/>                {<br/>                  position: "LEFT_AXIS",<br/>                  title: "Score" <br/>                }<br/>              ],</span></pre><p id="d140" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">上面的内容对于我们所拥有的数据来说是不言自明的:我们将创建一个柱形图，其中每一列都是一个标签，其高度由分数决定。同样，这只是我们的<strong class="kv jf"> chartRequest </strong>需要的一小部分，但是理解请求体的这些细节将允许您为将来可能有的任何数据布局创建一个图表。</p><p id="db36" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">撇开长长的 JSON 正文不谈，batchUpdate 请求本身相当简单…</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="924c" class="lr ls je nf b gy nj nk l nl nm">sheet.spreadsheets.batchUpdate({<br/>      spreadsheetId,<br/>      resource: chartRequest,<br/>});</span></pre><p id="236c" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">这就是你所需要的:你的电子表格的 ID(在哪里找到数据)和你的 chartRequest(如何从数据创建图表)。看到了吗？Sheets API 就像魔术一样。</p><figure class="na nb nc nd gt iv gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/99574ea2b3d169bf5a20ebf0f6f1def7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*uXCwavdmCUZlAH3OMAkPLQ.png"/></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk">The column chart you just generated from the Vision API data. Personally, I like to set all my columns to #ffe3ee.</figcaption></figure><h2 id="1bf9" class="lr ls je bd lt lu lv dn lw lx ly dp lz lc ma mb mc lg md me mf lk mg mh mi mj bi translated"><strong class="ak">化解生存危机。</strong></h2><p id="cde6" class="pw-post-body-paragraph kt ku je kv b kw mk kf ky kz ml ki lb lc mm le lf lg mn li lj lk mo lm ln lo im bi translated">好了，我们明白了，您可以使用 Sheets API 对数据和图表做一些很酷的事情——但是这有什么意义呢？</p><p id="48e0" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">问得好。<em class="lq">要点</em>是我们生活在大数据时代，这意味着计算机和软件允许我们访问比以往任何时候都多的数据。你好更好的消费者分析，销售报告和市场研究！然而，技术的快速和持续进步使得公司很难跟上<a class="ae lp" href="https://www.forbes.com/sites/bernardmarr/2016/06/16/spreadsheet-reporting-5-reasons-why-it-is-bad-for-business/#7c6e00f065e3" rel="noopener ugc nofollow" target="_blank">,数据经常以丢失、被误解或未被分析而告终。</a></p><p id="b6b5" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">通过这些简单的 Sheets API 调用，数据可以很容易地被存储、分析和可视化，而不必实际浏览 Google Sheet 本身。通过在后端处理这些实现，生成数据可视化不再令人困惑、乏味或耗时。此外，Google Sheets 使您的数据易于访问和分享。</p><p id="88c6" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">大数据，小问题。</p></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="2be1" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated"><strong class="kv jf">你可以在我的</strong><a class="ae lp" href="https://github.com/madamCS/DataToSheets" rel="noopener ugc nofollow" target="_blank"><strong class="kv jf">GitHub</strong></a><strong class="kv jf">上找到我完整的 GCF 代码。</strong></p><p id="bb4e" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">特别感谢我的实习主持人 Anu。</p><p id="aa1a" class="pw-post-body-paragraph kt ku je kv b kw kx kf ky kz la ki lb lc ld le lf lg lh li lj lk ll lm ln lo im bi translated">让我知道你是如何使用 GCF 和 Sheets API 来处理数据的，我很想听听你的意见！</p></div></div>    
</body>
</html>