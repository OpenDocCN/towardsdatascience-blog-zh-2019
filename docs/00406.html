<html>
<head>
<title>Complex SQL on Excel Spreadsheets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Excel 电子表格上的复杂 SQL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/complex-sql-on-excel-spreadsheets-274bc93ade89?source=collection_archive---------5-----------------------#2019-01-18">https://towardsdatascience.com/complex-sql-on-excel-spreadsheets-274bc93ade89?source=collection_archive---------5-----------------------#2019-01-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="708b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">研究联邦佩尔助学金数据的趋势</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/916c3e98cf42c1275abb1a03f2eae7f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UF7GKC0cIDVrTeU7GXDmCA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Spreadsheets to answers, using SQL.</figcaption></figure><p id="2b49" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">2016 年，印第安纳州的佩尔助学金减少了 2 亿美元。为什么？答案就在教育部的电子表格数据中。我们可以用 SQL 提取出来。</p><p id="6319" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">世界上的大量数据同样被锁在电子表格中。像 Excel 这样的工具被广泛使用，并且非常适合查看数据。然而，随着现代数据变得越来越大，越来越相互关联，执行复杂的分析可能会变得很困难——难以理解的长公式，与数据框架的争论，甚至清理崇高文本中的 CSV(我曾经遇到过…)。</p><p id="3c92" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一定有更好的办法。在本帖中，我们将展示如何使用一个比 Excel 更古老的工具来应对这一挑战:SQL。</p><h1 id="8aed" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">这些问题</h1><p id="b1d9" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">美国大学的可负担性(或不可负担性)是今日新闻中的<a class="ae mo" href="https://www.bloomberg.com/news/articles/2019-01-16/high-student-debt-is-driving-low-millennial-homeownership-rates" rel="noopener ugc nofollow" target="_blank">热点话题。学生经济资助的最大来源之一是</a><a class="ae mo" href="https://www2.ed.gov/programs/fpg/index.html" rel="noopener ugc nofollow" target="_blank">联邦佩尔助学金计划</a>，所以我们寻找量化该计划影响的数据。</p><p id="3480" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设我们想回答以下问题:</p><ul class=""><li id="9d00" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">2016-2017 年，纽约哪个机构的学生获得的佩尔奖金最多？</li><li id="32a3" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">对于每个州，从 2015-2016 年到 2016-2017 年，获得佩尔奖的学生人数的百分比变化是多少？</li><li id="1ff3" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">一个机构的平均资助规模与它是全男性还是全女性有什么关系？</li></ul><p id="d217" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">快速搜索显示，按机构列出的佩尔助学金发放数据可以在教育部网站上公开获得。XLSX 文件(Excel 电子表格)。这将是我们调查的起点。</p><h1 id="d178" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">加载数据</h1><p id="1fde" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">让我们将支出数据转移到<a class="ae mo" href="https://rockset.com/" rel="noopener ugc nofollow" target="_blank"> Rockset </a>中，这是一个可以解析和运行半结构化数据 SQL 查询的服务，包括我们案例中的 Excel 文件。在 Rockset 控制台中，我们创建一个新的空集合，并将其命名为<code class="fe nd ne nf ng b">pell_disbursements</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/89f35d1e423568ed91f62f1afd3bb30b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2DqbdDsrq30inkRp5jb1Ag.png"/></div></div></figure><p id="fb5c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们从 DoE 下载 Excel 文件，并将其直接上传到 Rockset 控制台。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/795c9d0109f0967aca6c58fd89fb629b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HPK9oWd9VMUKtHm43H9H0A.png"/></div></div></figure><p id="619c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Rockset 将对文件内容进行索引，以便随时可以查询。</p><h1 id="ba83" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">寻找数据点</h1><p id="632f" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">让我们从了解数据的形状开始。我们使用<code class="fe nd ne nf ng b">DESCRIBE</code>命令列出集合中的可用字段:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/9c471adb5ac2a25d819b9726ba3977ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3RFg_uwX9wfGINkHSupSOg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">We will run all our queries in the browser in the Rockset console.</figcaption></figure><p id="beef" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们看到 Rockset 已经解析了电子表格中从 B 到 H 的列，以及有用的元数据，包括:</p><ul class=""><li id="4bbe" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated"><code class="fe nd ne nf ng b">rownum</code> -原始电子表格中的行</li><li id="9c32" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><code class="fe nd ne nf ng b">_meta.file_upload.file</code> -原始文件的名称</li></ul><p id="5edc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Rockset 中的每个文档都对应于电子表格中的一行，所以让我们查询前几行来辨别每一列的含义:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="dea3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们看到第五行中的每一列都有标题，原始数据从第六行开始。使用一个<code class="fe nd ne nf ng b">WITH</code>子句，让我们构造一个名为<code class="fe nd ne nf ng b">pd</code>的子查询，它只返回我们关心的数据:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="19f1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这很令人兴奋——我们可以使用 SQL 的全部功能来梳理这些数据！让我们编写一个查询来找到我们第一个问题的答案，纽约获奖最多的机构:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="1ded" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们看到，排名第一的机构是曼哈顿区社区学院，该学院获得佩尔奖学金约 7600 万美元，明显高于排名第二的机构。</p><h1 id="7f25" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">计算聚合统计数据</h1><p id="b72c" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">让我们引入 2015-2016 年的数据。我们下载那一年的数据并上传。XLSX 文件放入同一个<code class="fe nd ne nf ng b">pell_disbursements</code>收藏中。<br/> <br/>我们使用与上面相同的步骤，这次按文件名过滤，为 2015-2016 年的数据构造另一个子查询。注意，第二个文件的格式略有不同(行偏移量、列标题和 OPE ID 列中的数据类型)，因此我们必须适当地调整我们的查询。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="b7f6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们可以将每个机构两年的数据进行匹配，以计算 Pell 接受者人数的逐年变化。我们按照州和从少到多的顺序进行汇总:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="2abe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以看到，除了三个州之外，所有其他州接受佩尔助学金的人数实际上都减少了(尽管其中的两个州，华盛顿特区和马绍尔群岛，从技术上讲不是州)。正如 CollegeBoard 在图<a class="ae mo" href="https://trends.collegeboard.org/student-aid/figures-tables/undergraduate-enrollment-and-percentage-receiving-pell-grants-over-time" rel="noopener ugc nofollow" target="_blank">中指出的，这是一个更大趋势的一部分。到目前为止，印第安纳州是个例外，接收人数下降了 27.7%。<br/> <br/>让我们在地图上看看这个数据。我们可以使用来自 amCharts 的</a><a class="ae mo" href="https://www.amcharts.com/demos/us-heat-map" rel="noopener ugc nofollow" target="_blank">这个</a>现成的美国热图演示。为了匹配 amCharts 期望的数据格式，我们重命名列，然后将结果导出为 JSON:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/d52b47367eb09cf05a8e36de456e2a22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gxBLBiZ6YtqDJjNhJODNA.png"/></div></div></figure><p id="98d1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们将 JSON 直接粘贴到演示代码中，并立即生成一个交互式热图！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn nl l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Run this pen to see the heat map.</figcaption></figure><p id="0904" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们直观地观察了犹他州附近和南部腹地的一些州，它们保留了佩尔学生人数，并再次看到印第安纳州确实是佩尔学生流失的异常值。<br/> <br/>当年印第安纳发生了什么？为什么会有如此巨大的变化？让我们开始吃吧。我们列出了印第安纳州各机构报告的接受佩尔助学金的学生人数的变化:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="6123" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这就是症结所在！ITT 技术学院贡献了近 40，000 名学生，快速搜索就会发现其背景故事。2016 年 8 月，在一系列欺诈和误导学生的指控后，教育部<a class="ae mo" href="https://www.ibj.com/articles/60122-update-feds-ban-itt-educational-from-enrolling-students-on-federal-aid" rel="noopener ugc nofollow" target="_blank">禁止 ITT 理工大学</a>用联邦资助招收新生。次月，ITT 理工大学<a class="ae mo" href="https://www.nytimes.com/2016/09/18/business/itt-educational-services-files-for-bankruptcy-after-aid-crackdown.html" rel="noopener ugc nofollow" target="_blank">宣布破产</a>。</p><h1 id="a0ca" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">使用附加数据增强</h1><p id="bc2f" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">让我们扩大调查范围，把一个机构其他方面的数据也包括进来。具体来说，我们可能会想，资助规模与一个机构是否被归类为全男性/全女性之间是否有任何关联。<br/> <br/>教育部管理的<a class="ae mo" href="https://collegescorecard.ed.gov/data/" rel="noopener ugc nofollow" target="_blank">大学记分卡</a>是一个可以帮助我们的极好的数据集。我们下载 2016–2017 年的数据作为 CSV 文件，并上传到新的 Rockset 集合:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/50b5dffffa42c2107274a33a177c7ba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qB9AfEbktO9Vis1iUK99kQ.png"/></div></div></figure><p id="b713" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了与佩尔助学金数据相一致，我们使用机构的 OPE IDs(美国教育部指定的中学后教育鉴定办公室)。我们注意到大学记分卡有两个 OPE ID 列，一个用于 6 位 ID，一个用于 8 位 ID:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="2697" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">与此同时，佩尔·格兰特的数据有点混乱。原始 Excel 文件将 ID 存储为数字(因此去掉了其前导 0 ),并为每个 ID 附加两个额外的数字:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="a044" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以在 Rockset 查询中解决所有这些问题。我们使用 SQL 函数来处理 ID，然后使用一个 JOIN 来比较机构名称并检查它们是否一致。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="2a43" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">看起来不错！使用连接，我们不需要任何预先的数据准备来组合数据集-我们可以自由地探索，而不需要预先定义我们可以使用的数据的边界。<br/> <br/>大学记分卡记录了每个机构的各种属性，点击<a class="ae mo" href="https://collegescorecard.ed.gov/data/documentation/" rel="noopener ugc nofollow" target="_blank">查看</a>。在我们的调查中，我们计算了全男性/全女性机构相对于其他机构的平均资助规模:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="9140" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们就此打住，但你可以想象无尽的角度去探索:</p><ul class=""><li id="b209" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">佩尔拨款偏向于任何特定的研究领域吗？</li><li id="6efc" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">是更难被大学录取，还是一旦入学就更难获得佩尔助学金？</li><li id="0d15" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">教职员工的工资与学校从佩尔助学金中获得的收入有什么关系？</li></ul><p id="0dc4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您想用这些数据运行自己的查询，那就尽情发挥吧！只要联系 hello@rockset.com 就能获得访问权限。(完全披露:我在 Rockset 工作。)</p><h1 id="3621" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">摘要</h1><p id="ff9e" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">SQL 通常用于查询传统数据库中的数据，但在这里我们看到了它如何也可以用于该上下文之外的数据。SQL 的灵活性和复杂性允许动态地处理数据，以任意方式聚合数据，并与其他地方的数据有效地结合。随着我们找到查询半结构化数据的新方法，我认为 SQL 有潜力将世界上越来越多的数据用于积极的用途。</p><h2 id="626b" class="np ls iq bd lt nq nr dn lx ns nt dp mb le nu nv md li nw nx mf lm ny nz mh oa bi translated">使用的数据:</h2><ul class=""><li id="4185" class="mp mq iq kx b ky mj lb mk le ob li oc lm od lq mu mv mw mx bi translated">2016-2017 年联邦佩尔资助项目资金按机构分布<a class="ae mo" href="https://www2.ed.gov/finaid/prof/resources/data/pell-institution.html" rel="noopener ugc nofollow" target="_blank"> (Excel 电子表格)</a></li><li id="7568" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">2015-2016 年联邦佩尔资助项目资金按机构分布情况(<a class="ae mo" href="https://www2.ed.gov/finaid/prof/resources/data/pell-institution.html" rel="noopener ugc nofollow" target="_blank"> Excel 电子表格</a></li><li id="f47c" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">2016–2017 年高校记分卡数据(<a class="ae mo" href="https://collegescorecard.ed.gov/data/" rel="noopener ugc nofollow" target="_blank"> CSV 文件</a>)</li></ul><h2 id="339a" class="np ls iq bd lt nq nr dn lx ns nt dp mb le nu nv md li nw nx mf lm ny nz mh oa bi translated">使用的服务:</h2><ul class=""><li id="63c1" class="mp mq iq kx b ky mj lb mk le ob li oc lm od lq mu mv mw mx bi translated"><a class="ae mo" href="https://rockset.com/" rel="noopener ugc nofollow" target="_blank"> Rockset </a> —摄取和查询。XLSX 文件</li><li id="df94" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><a class="ae mo" href="https://www.amcharts.com/" rel="noopener ugc nofollow" target="_blank"> amCharts </a> —在美国热图上可视化查询结果</li><li id="a2b6" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><a class="ae mo" href="https://gist.github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub Gist </a>和<a class="ae mo" href="https://codepen.io/" rel="noopener ugc nofollow" target="_blank">code pen</a>——分享本帖代码</li></ul></div></div>    
</body>
</html>