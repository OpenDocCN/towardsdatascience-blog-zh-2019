<html>
<head>
<title>An End-to-End Tutorial Running Convolution Neural Network on MCU with uTensor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 uTensor 在 MCU 上运行卷积神经网络的端到端教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/simple-cnn-on-mcu-with-utensor-372265ecc5b4?source=collection_archive---------14-----------------------#2019-04-05">https://towardsdatascience.com/simple-cnn-on-mcu-with-utensor-372265ecc5b4?source=collection_archive---------14-----------------------#2019-04-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="e98b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我试图在 uTensor 上展示 CNN，但在 2018 年的台湾 COSCUP 上没有成功。问题是，我不小心给所有的输入类输入了相同的图像，这和随机猜测一样好。在 CIFAR10 上，这产生了大约 10%准确度。尽管事实上分类器确实在工作！</p><p id="4c5d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是 CNN 关于 uTensor 的背景故事。</p><p id="3b28" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇文章中，我将指导你如何用 uTensor 构建一个 CNN。我们将使用<code class="fe ko kp kq kr b">utensor-cli</code>将 Tensorflow 中训练的简单 CNN 无缝转换为等效的 uTensor 实现，在 MCU(具体来说是 STM32F767)上编译和运行。</p><p id="1777" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你是 uTensor 的新手，在继续之前，你可能想读一读由 uTensor 核心开发者之一，<a class="kt ku ep" href="https://medium.com/u/4477866e81dd?source=post_page-----372265ecc5b4--------------------------------" rel="noopener" target="_blank"> Neil Tan </a>撰写的这篇<a class="ae ks" href="https://blog.hackster.io/simple-neural-network-on-mcus-a7cbd3dc108c" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">伟大的 MLP 教程</strong> </a>。</p><p id="572f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好了，我们开始吧！</p></div><div class="ab cl kv kw hx kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="im in io ip iq"><h1 id="8e6f" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">获取演示代码</h1><p id="1eba" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">首先，克隆回购:</p><pre class="mf mg mh mi gt mj kr mk ml aw mm bi"><span id="6b66" class="mn ld it kr b gy mo mp l mq mr">% git clone <a class="ae ks" href="https://github.com/uTensor/simple_cnn_tutorial.git" rel="noopener ugc nofollow" target="_blank">https://github.com/uTensor/simple_cnn_tutorial.git</a><br/>% cd simple_cnn_tutorial</span></pre><p id="fa64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，通过运行以下命令来设置环境:</p><pre class="mf mg mh mi gt mj kr mk ml aw mm bi"><span id="f780" class="mn ld it kr b gy mo mp l mq mr"># setup a python virtual environment and activate it<br/>% python2.7 -m virtualenv .venv<br/>% source .venv/bin/activate</span><span id="fa1c" class="mn ld it kr b gy ms mp l mq mr"># install mbed-cli and setup libraries<br/>% pip install mbed-cli<br/>% mbed deploy</span><span id="6e5b" class="mn ld it kr b gy ms mp l mq mr"># install uTensor cli *after* setting up the libraries<br/>% pip install utensor_cgen==0.3.3.dev2</span></pre><p id="d8fc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装完成后，如果没有其他错误，就可以开始了。</p><p id="7cc9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在回购中，有几个 python 脚本您可能想研究一下:</p><ul class=""><li id="fece" class="mt mu it js b jt ju jx jy kb mv kf mw kj mx kn my mz na nb bi translated"><code class="fe ko kp kq kr b">model.py</code>是构建 CNN 图表的脚本。</li><li id="ad1c" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn my mz na nb bi translated"><code class="fe ko kp kq kr b">train.py</code>是训练脚本。如果你想自己训练一个，你可以运行<code class="fe ko kp kq kr b">python train.py --help</code>来查看所有可用的超参数。在本教程中，我们将使用一个预先训练好的 protobuf 文件，<code class="fe ko kp kq kr b">cifar10_cnn.pb</code>。</li><li id="0e4d" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn my mz na nb bi translated"><code class="fe ko kp kq kr b">cifar10_cnn.pb</code>是我们将在本教程中使用的预训练模型。</li><li id="e429" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn my mz na nb bi translated"><code class="fe ko kp kq kr b">prepare_test_data.py</code>是一个 python 脚本，它将为您生成<code class="fe ko kp kq kr b">img_data.h </code>，这是在 MCU 上运行测试的数据。</li></ul><p id="7f8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想立即看到结果，您可以连接开发板并运行<code class="fe ko kp kq kr b">make compile</code>。它应该编译和闪存图像到您的开发板。然后按照<a class="kt ku ep" href="https://medium.com/u/4477866e81dd?source=post_page-----372265ecc5b4--------------------------------" rel="noopener" target="_blank"> Neil Tan </a>的<a class="ae ks" href="https://blog.hackster.io/simple-neural-network-on-mcus-a7cbd3dc108c" rel="noopener ugc nofollow" target="_blank">教程</a>中“获取输出”部分的说明进行操作。</p><h1 id="f87a" class="lc ld it bd le lf nh lh li lj ni ll lm ln nj lp lq lr nk lt lu lv nl lx ly lz bi translated">从 Tensorflow 到 uTensor</h1><p id="8fc3" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">用<code class="fe ko kp kq kr b">utensor-cli</code>激活虚拟环境。我们将首先识别输出节点，然后从模型中生成 C++文件。</p><p id="3e40" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">检查图形并找到输出节点:<code class="fe ko kp kq kr b">utensor-cli show &lt;model.pb&gt;</code></p><p id="fd46" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该命令显示给定模型文件中的所有操作/节点。例如，如果您运行<code class="fe ko kp kq kr b">utensor-cli show cifar10_cnn.pb --oneline</code>，您将在终端上看到以下内容:</p><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nm"><img src="../Images/5da7a1eb70dac9d0108b2ab6dc611166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NUyE3ORlzNklmIIkNAdH1g.png"/></div></div></figure><p id="544d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如您所见，该命令打印出给定<code class="fe ko kp kq kr b">cifar10_cnn.pb</code>中的所有图节点。</p><p id="d32c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当我们想将 protobuf 文件转换成 uTensor C++文件时，需要提供一个带有<code class="fe ko kp kq kr b">--output-nodes</code>选项的输出节点列表。与其他工具如<code class="fe ko kp kq kr b">tensorboard</code>相比，<code class="fe ko kp kq kr b">show</code>命令对于探索模型是有用的和轻量级的。</p><p id="6145" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe ko kp kq kr b">cifar10_cnn.pb</code>中，<code class="fe ko kp kq kr b">fully_connect_2/logits</code>就是我们要找的。它是这个模型中的输出节点。</p><p id="e8c6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，使用<code class="fe ko kp kq kr b">convert</code>命令将文件转换成 C++文件:</p><pre class="mf mg mh mi gt mj kr mk ml aw mm bi"><span id="39bd" class="mn ld it kr b gy mo mp l mq mr">% utensor-cli convert cifar10_cnn.pb --output-nodes \<br/>fully_connect_2/logits</span></pre><p id="65e5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将在控制台上看到:</p><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nu"><img src="../Images/45207e35335daa99d65f3ffe00ccda95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vjkyreA6V_qPFGTcKoZTbg.png"/></div></div></figure><p id="6fef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此时，您应该在<code class="fe ko kp kq kr b">models</code>目录中找到您的模型的 uTensor 实现，它是由<code class="fe ko kp kq kr b">utensor-cli</code>生成的。</p><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/e1b4ff45a9123f5b2b66da9e41c589c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*9_oRtQ4pMhEeqHBrScF3XQ.png"/></div></figure><p id="49bd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，通过运行以下命令生成一批测试图像:</p><pre class="mf mg mh mi gt mj kr mk ml aw mm bi"><span id="a2e2" class="mn ld it kr b gy mo mp l mq mr">% python prepare_test_data.py # generate testing image batch</span></pre><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nw"><img src="../Images/2d8c77da0b38f92431d2a3aa860130ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9ZkIqdAeRc22hDshrooEA.png"/></div></div></figure><p id="e5a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它只需下载 cifar10 数据集，并随机生成一批图像进行测试。您可以在<code class="fe ko kp kq kr b">img_data.h</code>中看到像素值(标准化为[0，1])。</p><h1 id="1dd6" class="lc ld it bd le lf nh lh li lj ni ll lm ln nj lp lq lr nk lt lu lv nl lx ly lz bi translated">看，美国有线电视新闻网在 MCU 上</h1><p id="7bdd" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated">在<code class="fe ko kp kq kr b">main.cpp</code>中，您可以看到如何使用 cli 生成的模型文件。简要总结:</p><ol class=""><li id="e455" class="mt mu it js b jt ju jx jy kb mv kf mw kj mx kn nx mz na nb bi translated">创建一个<code class="fe ko kp kq kr b">Context</code>对象</li><li id="baed" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn nx mz na nb bi translated">在本教程中，使用 cli 生成的助手函数构建神经网络。</li><li id="ca12" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn nx mz na nb bi translated">获取您想要用于推理的张量。</li><li id="7bf4" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn nx mz na nb bi translated">评估神经网络。</li></ol><p id="202f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">注意<code class="fe ko kp kq kr b">uTensor</code>将在评估后清除参考计数为 0 的张量。如果你在神经网络评估后得到张量<strong class="js iu">，你会得到一个错误或悬空指针问题。</strong></p><p id="250c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好了，编码的东西够多了。有趣的部分来了，我们准备在 MCU 上编译和运行 CNN。</p><p id="5cb4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，将开发板连接到计算机上:</p><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi ny"><img src="../Images/a33a346f9dd3cb0fe88bbc8004f27df0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cWchDoo3cXevj5fPPr4d2Q.jpeg"/></div></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk">My NUCLEO-F767ZI</figcaption></figure><p id="a9e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，运行:</p><pre class="mf mg mh mi gt mj kr mk ml aw mm bi"><span id="9170" class="mn ld it kr b gy mo mp l mq mr">% mbed compile -m auto -t GCC_ARM --profile \<br/>uTensor/build_profile/release.json -f</span></pre><ul class=""><li id="dd26" class="mt mu it js b jt ju jx jy kb mv kf mw kj mx kn my mz na nb bi translated"><code class="fe ko kp kq kr b">mbed</code>将自动检测您的开发板型号，带有<code class="fe ko kp kq kr b">-m auto</code>标志。</li><li id="d4f3" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn my mz na nb bi translated">使用概要文件构建二进制文件，在本教程中为<code class="fe ko kp kq kr b">release.json</code>。</li><li id="ca54" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn my mz na nb bi translated">并将二进制映像闪存到您的主板，并启用<code class="fe ko kp kq kr b">-f</code>标志。</li></ul><p id="8ad6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一切顺利，您应该会看到:</p><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi od"><img src="../Images/ca92ff1ad61d015fdfc7907ae419d4ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dIP2q-kUJDCb95hsMJjhEA.png"/></div></div></figure><p id="86d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">可能需要一段时间才能完成，耐心一点就好；)</p><p id="1957" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了看到我的 NUCLEO-F767ZI 的串行输出，我使用了 CoolTerm(你可以从<a class="ae ks" href="http://freeware.the-meiers.org/" rel="noopener ugc nofollow" target="_blank">这里</a>下载)。按照<a class="kt ku ep" href="https://medium.com/u/4477866e81dd?source=post_page-----372265ecc5b4--------------------------------" rel="noopener" target="_blank">尼尔·谭</a>的<a class="ae ks" href="https://blog.hackster.io/simple-neural-network-on-mcus-a7cbd3dc108c" rel="noopener ugc nofollow" target="_blank">教程</a>中所述设置 CoolTerm，并按下重置按钮，您应该会看到:</p><figure class="mf mg mh mi gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oe"><img src="../Images/e73a036cf353f8bff35f6114ae88cdde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lknjrQbmt67tR2lfnjg1eA.png"/></div></div></figure><p id="ab3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">精确度可能因您使用<code class="fe ko kp kq kr b">prepare_test_data.py</code>生成的随机图像批次而异。如果你这一批运气不好，就试试另一批:P</p><p id="fd8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">恭喜你。我们的 CNN 在 MCU 上直播。</p><h1 id="2ac1" class="lc ld it bd le lf nh lh li lj ni ll lm ln nj lp lq lr nk lt lu lv nl lx ly lz bi translated">下一步是什么</h1><p id="5855" class="pw-post-body-paragraph jq jr it js b jt ma jv jw jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn im bi translated"><a class="ae ks" href="https://github.com/orgs/uTensor/people" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">助理团队</strong> </a>非常活跃，试图将数据科学带入边缘计算领域。</p><p id="b386" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本教程中，我们提供了一个展示案例，您可以使用 uTensor 和其他神经网络框架(如 Tensorflow)进行端到端应用。</p><p id="5cc9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你是 PyTorch 的忠实粉丝，想知道 PyTorch 是否在 uTensor 的路线图上，不要担心。我也是 PyTorch 的粉丝，我们的团队正在努力让 PyTorch 与 Tensor 集成，就像我们与 Tensorflow 集成一样。我们正在取得进展，但欢迎你加入。</p><p id="bf5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以在<a class="ae ks" href="https://github.com/uTensor" rel="noopener ugc nofollow" target="_blank">https://github.com/uTensor</a>找到代码，有两个回购你应该先通过:</p><ul class=""><li id="f288" class="mt mu it js b jt ju jx jy kb mv kf mw kj mx kn my mz na nb bi translated"><a class="ae ks" href="https://github.com/uTensor/uTensor" rel="noopener ugc nofollow" target="_blank">助手</a>:c++运行时</li><li id="4afb" class="mt mu it js b jt nc jx nd kb ne kf nf kj ng kn my mz na nb bi translated">❤用 python 写的 uTensor CLI</li></ul><p id="061e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，特别感谢<a class="kt ku ep" href="https://medium.com/u/4477866e81dd?source=post_page-----372265ecc5b4--------------------------------" rel="noopener" target="_blank">尼尔·谭</a>和<a class="ae ks" href="https://www.linkedin.com/in/tsung-yu-hsieh-017b1466/" rel="noopener ugc nofollow" target="_blank"> </a> <a class="kt ku ep" href="https://medium.com/u/263e69d858c1?source=post_page-----372265ecc5b4--------------------------------" rel="noopener" target="_blank">卡扎米</a>给我的有用建议和帮助我调试本教程。</p></div></div>    
</body>
</html>