# 如何以正确的方式使用熊猫来加速你的代码

> 原文：<https://towardsdatascience.com/how-to-use-pandas-the-right-way-to-speed-up-your-code-4a19bd89926d?source=collection_archive---------9----------------------->

![](img/1b02e6d9da5fdba48e8adca90d3151eb.png)

Just a Panda, chillin'

> 想获得灵感？快来加入我的 [**超级行情快讯**](https://www.superquotes.co/?utm_source=mediumtech&utm_medium=web&utm_campaign=sharing) 。😎

熊猫图书馆对数据科学界来说是一份天赐的礼物。问任何一个数据科学家他们喜欢如何用 Python 处理他们的数据集，他们无疑会谈论熊猫。

Pandas 是一个优秀编程库的缩影:简单、直观、功能广泛。

然而，在熊猫数据帧上进行数千甚至数百万次计算，这是数据科学家的常规任务，仍然是一个挑战。你不能只是把你的数据扔进去，写一个 Python for-loop，然后期望你的数据在合理的时间内得到处理。

Pandas 是为一次处理整行或整列的矢量化操作而设计的——遍历每个单元格、行或列根本不是该库的设计用途。因此，当使用 Pandas 时，你应该从高度并行化的*矩阵* *运算*的角度考虑问题。

本指南将教你如何使用熊猫的设计方式，并根据矩阵运算进行思考。在这个过程中，我将向您展示一些实用的节省时间的技巧和诀窍，它们将使您的熊猫代码运行得比那些可怕的 Python for-loops 快得多！

# 我们的设置

在整个教程中，我们将使用经典的鸢尾花数据集。让我们开始用 seaborn 加载数据集，并打印出前 5 行。

厉害！

现在让我们建立一个基线，用 Python for-loop 来测量我们的速度。我们将通过循环遍历每一行来设置要在数据集上执行的计算，然后测量整个操作的速度。这将为我们提供一个基线，看看我们的新优化对我们有多大帮助。

在上面的代码中，我们创建了一个基本函数，使用 If-Else 语句根据花瓣长度选择花的类别。我们编写了一个 for 循环，通过遍历数据帧将函数应用于每一行，然后测量循环的总运行时间。

在我的 i7–8700k 的机器上，在 5 次运行中，循环平均花费了 0.01345 秒。

# 循环使用。iterrows()

我们可以马上做的最简单但非常值得的加速是使用 Pandas 内置的`.iterrows()`功能。

当我们在前一节中编写 for 循环时，我们使用了`range()`函数。然而，当我们在 Python 中循环大量的值时，生成器往往要快得多。你可以在本文[这里](/5-advanced-features-of-python-and-how-to-use-them-73bffa373c84)阅读更多关于发电机如何工作并使事情变得更快的信息。

Pandas 的`.iterrows()`函数在内部实现了一个生成器函数，它将在每次迭代中`yield`一行数据帧。更准确地说，`.iterrows()`为数据帧中的每一行生成(index，`Series`)对(元组)。这实际上与在原始 Python 中使用类似于`enumerate()`的东西是一样的，但是运行起来要快得多

下面我们修改了代码，使用`.iterrows()`代替常规的 for 循环。在我在上一节中用于测试的同一台机器上，平均运行时间是 0.005892 秒——加速了 2.28 倍！

# 完全丢弃循环。应用()

这个`.iterrows()`函数让我们的速度有了很大的提升，但是我们还远远没有完成。永远记住，当使用一个为向量运算设计的库时，可能有一种完全不用 for 循环就能最有效地做事的方法。

为我们提供这种能力的 Pandas 函数是`.apply()`函数。我们的函数`.apply()`将另一个函数作为其输入，并沿着数据帧(行、列等)的轴应用它。在我们传递函数的情况下，lambda 通常可以方便地将所有东西打包在一起。

在下面的代码中，我们用`.apply()`和一个 lambda 函数完全替换了我们的 for 循环，以打包我们想要的计算。在我的机器上，这段代码的平均运行时间是 0.0020897 秒，比我们原来的 for 循环快了 6.44 倍。

`.apply()`快得多的原因是它在内部试图循环遍历 [Cython](https://en.wikipedia.org/wiki/Cython) 迭代器。如果你的函数恰好针对 Cython 进行了优化，`.apply()`将会给你带来更大的速度提升。额外的好处是，使用内置函数会产生更干净、更易读的代码

# 最终剪辑

之前我提到过，如果你正在使用一个为矢量化运算设计的库，你应该总是寻找一种不使用 for 循环的方法来进行任何计算。

类似地，许多以这种方式设计的库，包括 Pandas，将有方便的内置函数来执行你正在寻找的精确计算——但要快得多。

Pandas 的`.cut()`函数将一组定义 If-Else 的每个范围的`bins`和一组定义每个范围返回哪个值的`labels`作为输入。然后，它执行与我们用`compute_class()`函数手动编写的完全相同的操作。

查看下面的代码，看看`.cut()`是如何工作的。我们再次得到了更干净、更易读的代码的好处。最终，`.cut()`函数平均运行时间为 0.001423 秒——比原来的 for-loop 快了 9.39 倍！

# 喜欢学习？

在推特[上关注我，我会在这里发布所有最新最棒的人工智能、技术和科学！也请在 LinkedIn](https://twitter.com/GeorgeSeif94)[上与我联系！](https://www.linkedin.com/in/georgeseif/)